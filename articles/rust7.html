<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Rust Standard Library on Apache NuttX RTOS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Rust Standard Library on Apache NuttX RTOS" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/rust7-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.org/articles/rust7.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Rust Standard Library on Apache NuttX RTOS</h1>
    <nav id="rustdoc"><ul>
<li><a href="#compile-our-rust-hello-app" title="Compile our Rust Hello App">1 Compile our Rust Hello App</a><ul></ul></li>
<li><a href="#json-with-serde" title="JSON with Serde">2 JSON with Serde</a><ul></ul></li>
<li><a href="#async-functions-with-tokio" title="Async Functions with Tokio">3 Async Functions with Tokio</a><ul></ul></li>
<li><a href="#appendix-tokio-async-threading" title="Appendix: Tokio Async Threading">4 Appendix: Tokio Async Threading</a><ul></ul></li>
<li><a href="#led-blinky-with-nix" title="LED Blinky with Nix">5 LED Blinky with Nix</a><ul></ul></li>
<li><a href="#owned-file-descriptors" title="Owned File Descriptors">6 Owned File Descriptors</a><ul></ul></li>
<li><a href="#nix-vs-rustix" title="Nix vs Rustix">7 Nix vs Rustix</a><ul></ul></li>
<li><a href="#appendix-porting-nix-to-nuttx" title="Appendix: Porting Nix to NuttX">8 Appendix: Porting Nix to NuttX</a><ul></ul></li>
<li><a href="#todo" title="TODO">9 TODO</a><ul></ul></li>
<li><a href="#todo-1" title="TODO">10 TODO</a><ul></ul></li>
<li><a href="#whats-next" title="What‚Äôs Next">11 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>30 Jan 2025</em></p>
<p><img src="https://lupyuen.github.io/images/rust7-title.jpg" alt="TODO" /></p>
<p><strong>Freshly Baked:</strong> Here‚Äôs how we <a href="TODO"><strong>Blink the LED</strong></a> with <strong>Rust Standard Library</strong> on <a href="TODO"><strong>Apache NuttX RTOS</strong></a>‚Ä¶</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// Open the LED Device for NuttX
</span><span class="kw">let </span>fd = open(      <span class="comment">// Equivalent to NuttX open()
  </span><span class="string">"/dev/userleds"</span>,  <span class="comment">// LED Device
  </span>OFlag::O_WRONLY,  <span class="comment">// Write Only
  </span>Mode::empty()     <span class="comment">// No Modes
</span>).unwrap();         <span class="comment">// Halt on Error

// Define the ioctl() function for Flipping LEDs
</span><span class="kw">const </span>ULEDIOC_SETALL: i32 = <span class="number">0x1d03</span>;  <span class="comment">// ioctl() Command
</span><span class="macro">ioctl_write_int_bad!</span>(  <span class="comment">// ioctl() will write One Int Value (LED Bit State)
  </span>led_set_all,         <span class="comment">// Name of our New Function
  </span>ULEDIOC_SETALL       <span class="comment">// ioctl() Command to send
</span>);

<span class="comment">// Flip LED 1 to On
</span><span class="kw">unsafe </span>{             <span class="comment">// Be careful of ioctl()
  </span>led_set_all(       <span class="comment">// Set the LEDs for...
    </span>fd.as_raw_fd(),  <span class="comment">// LED Device
    </span><span class="number">1                </span><span class="comment">// LED 1 (Bit 0) turns On
  </span>).unwrap();        <span class="comment">// Halt on Error
</span>}  <span class="comment">// Equivalent to ioctl(fd, ULEDIOC_SETALL, 1)

// Flip LED 1 to Off: ioctl(fd, ULEDIOC_SETALL, 0)
</span><span class="kw">unsafe </span>{ led_set_all(fd.as_raw_fd(), <span class="number">0</span>).unwrap(); }</code></pre></div>
<p>Which requires the <strong><code>nix</code> Rust Crate</strong> / Library‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Add the `nix` Rust Crate
## To our NuttX Rust App
$ cd apps/examples/rust/hello
$ cargo add nix --features fs,ioctl

Updating crates.io index
Adding nix v0.29.0 to dependencies
Features: + fs + ioctl</code></pre></div>
<p><em>(OK it‚Äôs more complicated. Stay tuned!)</em></p>
<p>All this is now possible thanks to the awesome work by <a href="https://github.com/apache/nuttx-apps/pull/2487"><strong>Huang Qi</strong></a>! üéâ</p>
<h1 id="compile-our-rust-hello-app"><a class="doc-anchor" href="#compile-our-rust-hello-app">¬ß</a>1 Compile our Rust Hello App</h1>
<p>TODO</p>
<p>Some bits are a little wonky</p>
<h1 id="json-with-serde"><a class="doc-anchor" href="#json-with-serde">¬ß</a>2 JSON with Serde</h1>
<p><em>What‚Äôs this Serde?</em></p>
<p>Think <em>‚ÄúSerialise-Deserialise‚Äù</em>.</p>
<p><a href="https://crates.io/crates/serde"><strong>Serde</strong></a> is a framework for serializing and deserializing Rust data structures efficiently and generically.</p>
<p>TODO</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attr">#[derive(Serialize, Deserialize)]
</span><span class="kw">struct </span>Person {
  name: String,
  age: u8,
}

<span class="attr">#[no_mangle]
</span><span class="kw">pub extern </span><span class="string">"C" </span><span class="kw">fn </span>hello_rust_cargo_main() {
  <span class="comment">// Print hello world to stdout

  </span><span class="kw">let </span>john = Person {
    name: <span class="string">"John"</span>.to_string(),
    age: <span class="number">30</span>,
  };

  <span class="kw">let </span>json_str = serde_json::to_string(<span class="kw-2">&amp;</span>john).unwrap();
  <span class="macro">println!</span>(<span class="string">"{}"</span>, json_str);

  <span class="kw">let </span>jane = Person {
    name: <span class="string">"Jane"</span>.to_string(),
    age: <span class="number">25</span>,
  };

  <span class="kw">let </span>json_str_jane = serde_json::to_string(<span class="kw-2">&amp;</span>jane).unwrap();
  <span class="macro">println!</span>(<span class="string">"{}"</span>, json_str_jane);

  <span class="kw">let </span>json_data = <span class="string">r#"
    {
      "name": "Alice",
      "age": 28
    }"#</span>;

  <span class="kw">let </span>alice: Person = serde_json::from_str(json_data).unwrap();
  <span class="macro">println!</span>(<span class="string">"Deserialized: {} is {} years old"</span>, alice.name, alice.age);

  <span class="kw">let </span>pretty_json_str = serde_json::to_string_pretty(<span class="kw-2">&amp;</span>alice).unwrap();
  <span class="macro">println!</span>(<span class="string">"Pretty JSON:\n{}"</span>, pretty_json_str);
}</code></pre></div>
<h1 id="async-functions-with-tokio"><a class="doc-anchor" href="#async-functions-with-tokio">¬ß</a>3 Async Functions with Tokio</h1>
<p><em>What‚Äôs this Tokio? Sounds like a city?</em></p>
<p>Indeed! ‚ÄúTokio‚Äù is inspired by Tokyo (and <a href="https://crates.io/crates/mio"><strong>Metal I/O</strong></a>)</p>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/Tokio_(software)"><strong>Tokio</strong></a> ‚Ä¶ provides a runtime and functions that enable the use of Asynchronous I/O, allowing for Concurrency in regards to Task Completion</p>
</blockquote>
<p>Inside our <strong>Rust Hello App</strong>, this is how we we run <strong>Async Functions</strong> with Tokio: TODO</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// Use One Single Thread (Current NuttX Thread)
// To schedule Async Functions
</span>tokio::runtime::Builder
  ::new_current_thread()  <span class="comment">// Current Thread is the Single-Threaded Scheduler
  </span>.enable_all()  <span class="comment">// Enable the I/O and Time Functions
  </span>.build()       <span class="comment">// Create the Single-Threaded Scheduler
  </span>.unwrap()      <span class="comment">// Halt on Error
  </span>.block_on(     <span class="comment">// Start the Scheduler
    </span><span class="kw">async </span>{      <span class="comment">// With this Async Function
      </span><span class="macro">println!</span>(<span class="string">"Hello world from tokio!"</span>);
  });

<span class="comment">// Is it really async? Let's block and find out!
</span><span class="macro">println!</span>(<span class="string">"Looping Forever..."</span>);
<span class="kw">loop </span>{}</code></pre></div>
<p><a href="https://tokio.rs/tokio/topics/bridging">(Derived from <strong><code>#[tokio::main]</code></strong>)</a></p>
<p>Which prints‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>nsh&gt; hello_rust_cargo
Hello world from tokio!
Looping Forever...</code></pre></div>
<p><em>Yawn. Tokio looks underwhelming?</em></p>
<p>Ah we haven‚Äôt seen the full power of <strong>Tokio Multi-Threaded Async Functions</strong> on NuttX!</p>
<div class="example-wrap"><pre class="language-bash"><code>nsh&gt; hello_rust_cargo
pthread_create
nx_pthread_create
Task 0 sleeping for 1000 ms
Task 1 sleeping for  950 ms
Task 2 sleeping for  900 ms
Task 3 sleeping for  850 ms
Finished time-consuming task
Task 3 stopping
Task 2 stopping
Task 1 stopping
Task 0 stopping</code></pre></div>
<p>Check the Appendix for a more impressive <strong>Tokio Async Demo</strong>. That works beautifully on NuttX!</p>
<ul>
<li>TODO: test_async</li>
</ul>
<p><em>But NuttX has POSIX Threads. Why use Async Functions?</em></p>
<p>TODO: Threads vs Tasks vs Processes</p>
<p>TODO: NodeJS</p>
<p>(OK we‚Äôre trying not to call it Async Task, because a Task in NuttX is more like a NuttX Process)</p>
<p><em>How would we use Tokio?</em></p>
<p>TODO: Good for Network Programming, waiting for tasks</p>
<p>TODO</p>
<div class="example-wrap"><pre class="language-bash"><code>## Erase the Rust Build
pushd ../apps/examples/rust/hello
cargo clean
popd</code></pre></div><h1 id="appendix-tokio-async-threading"><a class="doc-anchor" href="#appendix-tokio-async-threading">¬ß</a>4 Appendix: Tokio Async Threading</h1>
<p>Earlier we saw Tokio‚Äôs <strong>Single-Threaded Scheduler</strong>, running on the <strong>Current NuttX Thread</strong>‚Ä¶</p>
<ul>
<li>TODO</li>
</ul>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// Use One Single Thread (Current NuttX Thread)
// To schedule Async Functions
</span>tokio::runtime::Builder
  ::new_current_thread()  <span class="comment">// Current Thread is the Single-Threaded Scheduler
  </span>.enable_all()  <span class="comment">// Enable the I/O and Time Functions
  </span>.build()       <span class="comment">// Create the Single-Threaded Scheduler
  </span>.unwrap()      <span class="comment">// Halt on Error
  </span>.block_on(     <span class="comment">// Start the Scheduler
    </span><span class="kw">async </span>{      <span class="comment">// With this Async Function
      </span><span class="macro">println!</span>(<span class="string">"Hello world from tokio!"</span>);
  });

<span class="comment">// Is it really async? Let's block and find out!
</span><span class="macro">println!</span>(<span class="string">"Looping Forever..."</span>);
<span class="kw">loop </span>{}</code></pre></div>
<p>Which isn‚Äôt terribly exciting‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>nsh&gt; hello_rust_cargo
Hello world from tokio!
Looping Forever...</code></pre></div>
<p>Now we try Tokio‚Äôs <strong>Multi-Threaded Scheduler</strong>. And we create <strong>One New NuttX Thread</strong> for the Scheduler: TODO</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// Run 4 Async Functions in the Background
// By creating One New NuttX Thread
// Based on https://tokio.rs/tokio/topics/bridging
</span><span class="kw">fn </span>test_async() {

  <span class="comment">// Create a Multi-Threaded Scheduler
  // Containing One New NuttX Thread
  </span><span class="kw">let </span>runtime = tokio::runtime::Builder
    ::new_multi_thread() <span class="comment">// Multi-Threaded Scheduler
    </span>.worker_threads(<span class="number">1</span>)   <span class="comment">// With One New NuttX Thread for our Scheduler
    </span>.enable_all()  <span class="comment">// Enable the I/O and Time Functions
    </span>.build()       <span class="comment">// Create the Single-Threaded Scheduler
    </span>.unwrap();     <span class="comment">// Halt on Error

  // Create 4 Async Functions
  // Remember their Async Handles
  </span><span class="kw">let </span><span class="kw-2">mut </span>handles = Vec::with_capacity(<span class="number">4</span>);
  <span class="kw">for </span>i <span class="kw">in </span><span class="number">0</span>..<span class="number">4 </span>{
    handles.push(         <span class="comment">// Remember the Async Handles
      </span>runtime.spawn(      <span class="comment">// Start in the Background
        </span>my_bg_task(i)));  <span class="comment">// Our Async Function
  </span>}

  <span class="comment">// Pretend to be busy while Async Functions execute (in the background)
  // We wait 750 milliseconds
  </span>std::thread::sleep(
    tokio::time::Duration::from_millis(<span class="number">750</span>));
  <span class="macro">println!</span>(<span class="string">"Finished time-consuming task."</span>);

  <span class="comment">// Wait for All Async Functions to complete
  </span><span class="kw">for </span>handle <span class="kw">in </span>handles {
    runtime
      .block_on(handle)  <span class="comment">// Wait for One Async Function to complete
      </span>.unwrap();
  }
}

<span class="comment">// Our Async Function that runs in the background...
// If i=0: Sleep for 1000 ms
// If i=1: Sleep for  950 ms
// If i=2: Sleep for  900 ms
// If i=3: Sleep for  850 ms
</span><span class="kw">async fn </span>my_bg_task(i: u64) {
  <span class="kw">let </span>millis = <span class="number">1000 </span>- <span class="number">50 </span>* i;
  <span class="macro">println!</span>(<span class="string">"Task {} sleeping for {} ms."</span>, i, millis);
  tokio::time::sleep(
    tokio::time::Duration::from_millis(millis)
  ).<span class="kw">await</span>;  <span class="comment">// Wait for sleep to complete
  </span><span class="macro">println!</span>(<span class="string">"Task {} stopping."</span>, i);
}

<span class="comment">// Needed by Tokio Multi-Threaded Scheduler
</span><span class="attr">#[no_mangle]
</span><span class="kw">pub extern </span><span class="string">"C" </span><span class="kw">fn </span>pthread_set_name_np() {}</code></pre></div>
<p>Which shows</p>
<div class="example-wrap"><pre class="language-bash"><code>nsh&gt; hello_rust_cargo
pthread_create
nx_pthread_create
Task 0 sleeping for 1000 ms
Task 1 sleeping for  950 ms
Task 2 sleeping for  900 ms
Task 3 sleeping for  850 ms
Finished time-consuming task
Task 3 stopping
Task 2 stopping
Task 1 stopping
Task 0 stopping</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/46db6d1baee0e589774cc43dd690da07">(See the <strong>Complete Log</strong>)</a></p>
<p>TODO: <a href="https://tokio.rs/tokio/topics/bridging">Bridging with sync code</a></p>
<p>TODO</p>
<div class="example-wrap"><pre class="language-text"><code>        .worker_threads(2)

pthread_create: pthread_entry=0x80048f10, arg=0x800873e8
nx_pthread_create: entry=0x80048f10, arg=0x800873e8
pthread_create: pthread_entry=0x80048f10, arg=0x80287830
nx_pthread_create: entry=0x80048f10, arg=0x80287830
Task 0 sleeping for 1000 ms.
Task 1 sleeping for 950 ms.
Task 2 sleeping for 900 ms.
Task 3 sleeping for 850 ms.
Finished time-consuming task.
Task 3 stopping.
Task 2 stopping.
Task 1 stopping.
Task 0 stopping.
nsh&gt; </code></pre></div>
<p>TODO: pthread_create</p>
<div class="example-wrap"><pre class="language-text"><code>https://github.com/lupyuen2/wip-nuttx/blob/master/fs/vfs/fs_ioctl.c#L263-L264

https://github.com/lupyuen2/wip-nuttx/blob/master/libs/libc/pthread/pthread_create.c#L93

https://github.com/lupyuen2/wip-nuttx/blob/master/sched/pthread/pthread_create.c#L34

int pthread_create(FAR pthread_t *thread, FAR const pthread_attr_t *attr,
                   pthread_startroutine_t pthread_entry, pthread_addr_t arg)
{
  _info(&quot;pthread_entry=%p, arg=%p&quot;, pthread_entry, arg);////

    tokio::runtime::Builder::new_multi_thread()
        .enable_all()
        .build()
        .unwrap()
        .block_on(async {
            println!(&quot;Hello world from tokio!&quot;);
        });

    println!(&quot;Looping Forever...&quot;);
    loop {
        // Do nothing
    }
}

#[no_mangle]
pub extern &quot;C&quot; fn pthread_set_name_np() {}

NuttShell (NSH) NuttX-12.7.0
nsh&gt; hello_rust_cargo
board_userled: LED 1 set to 1
board_userled: LED 2 set to 0
board_userled: LED 3 set to 0
board_userled: LED 1 set to 0
board_userled: LED 2 set to 0
board_userled: LED 3 set to 0
{&quot;name&quot;:&quot;John&quot;,&quot;age&quot;:30}
{&quot;name&quot;:&quot;Jane&quot;,&quot;age&quot;:25}
Deserialized: Alice is 28 years old
Pretty JSON:
{
  &quot;name&quot;: &quot;Alice&quot;,
  &quot;age&quot;: 28
}
pthread_create: pthread_entry=0x80047938, arg=0x8007ff18
nx_pthread_create: entry=0x80047938, arg=0x8007ff18
Hello world from tokio!
Looping Forever...</code></pre></div><h1 id="led-blinky-with-nix"><a class="doc-anchor" href="#led-blinky-with-nix">¬ß</a>5 LED Blinky with Nix</h1>
<p>TODO: Not NixOS</p>
<h1 id="owned-file-descriptors"><a class="doc-anchor" href="#owned-file-descriptors">¬ß</a>6 Owned File Descriptors</h1>
<p><strong>Safety Quiz:</strong> Why will this work‚Ä¶</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">let </span>owned_fd = open(<span class="string">"/dev/userleds"</span>, OFlag::O_WRONLY, Mode::empty())
  .unwrap();  <span class="comment">// Returns an Owned File Descriptor
</span>...
led_set_all(
  owned_fd.as_raw_fd(),  <span class="comment">// Borrow the Raw File Descriptor
  </span><span class="number">1
</span>).unwrap();  <span class="comment">// Yep runs OK</span></code></pre></div>
<p>But not this?</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">let </span>raw_fd = open(<span class="string">"/dev/userleds"</span>, OFlag::O_WRONLY, Mode::empty())
  .unwrap()      <span class="comment">// Returns an Owned File Descriptor
  </span>.as_raw_fd();  <span class="comment">// Which turns into a Raw File Descriptor
</span>...
led_set_all(
  raw_fd,    <span class="comment">// Use the Raw File Descriptor
  </span><span class="number">1
</span>).unwrap();  <span class="comment">// Oops will fail!</span></code></pre></div>
<p>The second snippet will fail with this error‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>NuttShell (NSH) NuttX-12.7.0
nsh&gt; hello_rust_cargo
thread &#39;&lt;unnamed&gt;&#39; panicked at src/lib.rs:32:33:
called `Result::unwrap()` on an `Err` value: EBADF
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace</code></pre></div><h1 id="nix-vs-rustix"><a class="doc-anchor" href="#nix-vs-rustix">¬ß</a>7 Nix vs Rustix</h1>
<p>TODO: Are Nix ioctl safe?</p>
<h1 id="appendix-porting-nix-to-nuttx"><a class="doc-anchor" href="#appendix-porting-nix-to-nuttx">¬ß</a>8 Appendix: Porting Nix to NuttX</h1>
<p>TODO: Redox, BSD not Linux, PR</p>
<h1 id="todo"><a class="doc-anchor" href="#todo">¬ß</a>9 TODO</h1><div class="example-wrap"><pre class="language-text"><code>https://github.com/apache/nuttx-apps/blob/master/examples/rust/hello/src/lib.rs

examples: New app to build Rust with Cargo
https://github.com/apache/nuttx-apps/pull/2487

Add NuttX based targets for RISC-V and ARM
https://github.com/rust-lang/rust/pull/127755

The serde with no_std
https://bitboom.github.io/2020-10-22/serde-no-std

Hal?
demo app
why tokio for json
disassemble
Loop print something 
Strings
Patch 
Which platforms 
How to test
Build Farm? Docker?
How to bisect
Blinky
How to add crate
RISC-V SBC? No knsh64 yet</code></pre></div><h1 id="todo-1"><a class="doc-anchor" href="#todo-1">¬ß</a>10 TODO</h1><div class="example-wrap"><pre class="language-text"><code>Rust in NuttX
https://nuttx.apache.org/docs/latest/guides/rust.html

examples: New app to build Rust with Cargo
https://github.com/apache/nuttx-apps/pull/2487

rust/hello: Optimize the build flags #2955
https://github.com/apache/nuttx-apps/pull/2955

https://github.com/apache/nuttx-apps/pull/2487#pullrequestreview-2538724037
Tested OK with make and rv-virt:nsh. Thank you so much! :-)
https://gist.github.com/lupyuen/37a28cc3ae0443aa29800d252e4345cf

hello_rust_cargo on Apache NuttX RTOS rv-virt:leds64
https://gist.github.com/lupyuen/6985933271f140db0dc6172ebba9bff5

hello_rust_cargo on macOS
https://gist.github.com/lupyuen/a2b91b5cc15824a31c287fbb6cda5fa2

hello_rust_cargo on Apache NuttX RTOS rv-virt:leds
https://gist.github.com/lupyuen/ccfae733657b864f2f9a24ce41808144

rm -rf .cargo .rustup rust rust2
https://rustup.rs/
curl --proto &#39;=https&#39; --tlsv1.2 -sSf https://sh.rustup.rs | sh
Standard Installation 
. &quot;$HOME/.cargo/env&quot;

## error: the `-Z` flag is only accepted on the nightly channel of Cargo, but this is the `stable` channel
rustup update
rustup toolchain install nightly
rustup default nightly
rustc --version

## error: &quot;/home/luppy/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/Cargo.lock&quot; does not exist, unable to build with the standard library, try: rustup component add rust-src --toolchain nightly-x86_64-unknown-linux-gnu
rustup component add rust-src --toolchain nightly-x86_64-unknown-linux-gnu

mkdir rust
cd rust
git clone https://github.com/apache/nuttx
git clone https://github.com/apache/nuttx-apps apps
cd nuttx

git status &amp;&amp; hash1=`git rev-parse HEAD`
pushd ../apps
git status &amp;&amp; hash2=`git rev-parse HEAD`
popd
echo NuttX Source: https://github.com/apache/nuttx/tree/$hash1 &gt;nuttx.hash
echo NuttX Apps: https://github.com/apache/nuttx-apps/tree/$hash2 &gt;&gt;nuttx.hash
cat nuttx.hash

make distclean
## tools/configure.sh rv-virt:nsh64
## tools/configure.sh rv-virt:knsh64
## tools/configure.sh rv-virt:leds
tools/configure.sh rv-virt:leds64

grep STACK .config

## error: Error loading target specification: Could not find specification for target &quot;riscv64imafdc-unknown-nuttx-elf&quot;. Run `rustc --print target-list` for a list of built-in targets
## Disable CONFIG_ARCH_FPU
kconfig-tweak --disable CONFIG_ARCH_FPU

## Enable CONFIG_SYSTEM_TIME64 / CONFIG_FS_LARGEFILE / CONFIG_DEV_URANDOM / CONFIG_TLS_NELEM = 16
kconfig-tweak --enable CONFIG_SYSTEM_TIME64
kconfig-tweak --enable CONFIG_FS_LARGEFILE
kconfig-tweak --enable CONFIG_DEV_URANDOM
kconfig-tweak --set-val CONFIG_TLS_NELEM 16

## Enable Hello Rust Cargo App
kconfig-tweak --enable CONFIG_EXAMPLES_HELLO_RUST_CARGO

## For knsh64
kconfig-tweak --set-val CONFIG_EXAMPLES_HELLO_RUST_CARGO_STACKSIZE 16384

## Update the Kconfig Dependencies
make olddefconfig

grep STACK .config

dump_tasks:    PID GROUP PRI POLICY   TYPE    NPX STATE   EVENT      SIGMASK          STACKBASE  STACKSIZE      USED   FILLED    COMMAND
dump_tasks:   ----   --- --- -------- ------- --- ------- ---------- ---------------- 0x8006bbc0      2048      1016    49.6%    irq
dump_task:       0     0   0 FIFO     Kthread -   Ready              0000000000000000 0x8006e7f0      1904       888    46.6%    Idle_Task
dump_task:       1     1 100 RR       Task    -   Waiting Semaphore  0000000000000000 0x8006fd38      2888      1944    67.3%    nsh_main
dump_task:       3     3 100 RR       Task    -   Running            0000000000000000 0x80071420      1856      1856   100.0%!   hello_rust_cargo
QEMU: Terminated

   Compiling std v0.0.0 (/home/luppy/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std)
error[E0308]: mismatched types
    --&gt; /home/luppy/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/pal/unix/fs.rs:1037:33
     |
1037 |         unsafe { CStr::from_ptr(self.entry.d_name.as_ptr()) }
     |                  -------------- ^^^^^^^^^^^^^^^^^^^^^^^^^^ expected `*const u8`, found `*const i8`
     |                  |
     |                  arguments to this function are incorrect
     |
     = note: expected raw pointer `*const u8`
                found raw pointer `*const i8`
note: associated function defined here
    --&gt; /home/luppy/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ffi/c_str.rs:264:25
     |
264  |     pub const unsafe fn from_ptr&lt;&#39;a&gt;(ptr: *const c_char) -&gt; &amp;&#39;a CStr {
     |                         ^^^^^^^^

macOS:
error[E0308]: mismatched types
    --&gt; /Users/luppy/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/src/rust/library/std/src/sys/pal/unix/fs.rs:1037:33
     |
1037 |         unsafe { CStr::from_ptr(self.entry.d_name.as_ptr()) }
     |                  -------------- ^^^^^^^^^^^^^^^^^^^^^^^^^^ expected `*const u8`, found `*const i8`
     |                  |
     |                  arguments to this function are incorrect
     |
     = note: expected raw pointer `*const u8`
                found raw pointer `*const i8`

## Remember to patch fs.rs
vi $HOME/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/pal/unix/fs.rs
head -n 1049 $HOME/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/pal/unix/fs.rs | tail -n 17

    #[cfg(not(any(
        target_os = &quot;android&quot;,
        target_os = &quot;linux&quot;,
        target_os = &quot;solaris&quot;,
        target_os = &quot;illumos&quot;,
        target_os = &quot;fuchsia&quot;,
        target_os = &quot;redox&quot;,
        target_os = &quot;aix&quot;,
        target_os = &quot;nto&quot;,
        target_os = &quot;vita&quot;,
        target_os = &quot;hurd&quot;,
    )))]
    fn name_cstr(&amp;self) -&gt; &amp;CStr {
        // Previously: unsafe { CStr::from_ptr(self.entry.d_name.as_ptr()) }
        unsafe { CStr::from_ptr(self.entry.d_name.as_ptr() as *const u8) }
    }

make -j

qemu-system-riscv64 \
  -semihosting \
  -M virt,aclint=on \
  -cpu rv64 \
  -bios none \
  -kernel nuttx \
  -nographic

uname -a
hello
hello_rust_cargo

## Dump the disassembly to nuttx.S
riscv-none-elf-objdump \
  --syms --source --reloc --demangle --line-numbers --wide \
  --debugging \
  nuttx \
  &gt;nuttx.S \
  2&gt;&amp;1

/Users/luppy/riscv/leds64-nuttx.S</code></pre></div>
<p>TODO make V=1</p>
<div class="example-wrap"><pre class="language-text"><code>`make V=1` for `rv-virt:leds64`
https://gist.github.com/lupyuen/b8f051c25e872fb8a444559c3dbf6374

 1018  make distclean
 1019  tools/configure.sh rv-virt:leds64
 1020  ## Disable CONFIG_ARCH_FPU
 1021  kconfig-tweak --disable CONFIG_ARCH_FPU
 1022  ## Enable CONFIG_SYSTEM_TIME64 / CONFIG_FS_LARGEFILE / CONFIG_DEV_URANDOM / CONFIG_TLS_NELEM = 16
 1023  kconfig-tweak --enable CONFIG_SYSTEM_TIME64
 1024  kconfig-tweak --enable CONFIG_FS_LARGEFILE
 1025  kconfig-tweak --enable CONFIG_DEV_URANDOM
 1026  kconfig-tweak --set-val CONFIG_TLS_NELEM 16
 1027  ## Enable Hello Rust Cargo App
 1028  kconfig-tweak --enable CONFIG_EXAMPLES_HELLO_RUST_CARGO
 1029  ## For knsh64
 1030  kconfig-tweak --set-val CONFIG_EXAMPLES_HELLO_RUST_CARGO_STACKSIZE 16384
 1031  ## Update the Kconfig Dependencies
 1032  make olddefconfig
 1033  make V=1</code></pre></div>
<p>TODO dump disassembly</p>
<div class="example-wrap"><pre class="language-text"><code>cd /home/luppy/rust/apps/examples/rust/hello
cargo build --release -Zbuild-std=std,panic_abort --manifest-path /home/luppy/rust/apps/examples/rust/hello/Cargo.toml --target riscv64imac-unknown-nuttx-elf

riscv-none-elf-gcc -E -P -x c -isystem /home/luppy/rust/nuttx/include -D__NuttX__ -DNDEBUG -D__KERNEL__  -I /home/luppy/rust/nuttx/arch/risc-v/src/chip -I /home/luppy/rust/nuttx/arch/risc-v/src/common -I /home/luppy/rust/nuttx/sched   /home/luppy/rust/nuttx/boards/risc-v/qemu-rv/rv-virt/scripts/ld.script -o  /home/luppy/rust/nuttx/boards/risc-v/qemu-rv/rv-virt/scripts/ld.script.tmp

riscv-none-elf-ld --entry=__start -melf64lriscv --gc-sections -nostdlib --cref -Map=/home/luppy/rust/nuttx/nuttx.map --print-memory-usage -T/home/luppy/rust/nuttx/boards/risc-v/qemu-rv/rv-virt/scripts/ld.script.tmp  -L /home/luppy/rust/nuttx/staging -L /home/luppy/rust/nuttx/arch/risc-v/src/board  \
        -o /home/luppy/rust/nuttx/nuttx   \
        --start-group -lsched -ldrivers -lboards -lc -lmm -larch -lm -lapps -lfs -lbinfmt -lboard /home/luppy/xpack-riscv-none-elf-gcc-13.2.0-2/bin/../lib/gcc/riscv-none-elf/13.2.0/rv64imac/lp64/libgcc.a /home/luppy/rust/apps/examples/rust/hello/target/riscv64imac-unknown-nuttx-elf/release/libhello.a --end-group

Remove release, change to debug
pushd ../apps/examples/rust/hello
cargo build -Zbuild-std=std,panic_abort --manifest-path /home/luppy/rust/apps/examples/rust/hello/Cargo.toml --target riscv64imac-unknown-nuttx-elf
popd

riscv-none-elf-gcc -E -P -x c -isystem /home/luppy/rust/nuttx/include -D__NuttX__ -DNDEBUG -D__KERNEL__  -I /home/luppy/rust/nuttx/arch/risc-v/src/chip -I /home/luppy/rust/nuttx/arch/risc-v/src/common -I /home/luppy/rust/nuttx/sched   /home/luppy/rust/nuttx/boards/risc-v/qemu-rv/rv-virt/scripts/ld.script -o  /home/luppy/rust/nuttx/boards/risc-v/qemu-rv/rv-virt/scripts/ld.script.tmp

riscv-none-elf-ld --entry=__start -melf64lriscv --gc-sections -nostdlib --cref -Map=/home/luppy/rust/nuttx/nuttx.map --print-memory-usage -T/home/luppy/rust/nuttx/boards/risc-v/qemu-rv/rv-virt/scripts/ld.script.tmp  -L /home/luppy/rust/nuttx/staging -L /home/luppy/rust/nuttx/arch/risc-v/src/board  \
        -o /home/luppy/rust/nuttx/nuttx   \
        --start-group -lsched -ldrivers -lboards -lc -lmm -larch -lm -lapps -lfs -lbinfmt -lboard /home/luppy/xpack-riscv-none-elf-gcc-13.2.0-2/bin/../lib/gcc/riscv-none-elf/13.2.0/rv64imac/lp64/libgcc.a /home/luppy/rust/apps/examples/rust/hello/target/riscv64imac-unknown-nuttx-elf/debug/libhello.a --end-group

## Dump the disassembly to nuttx.S
riscv-none-elf-objdump \
  --syms --source --reloc --demangle --line-numbers --wide \
  --debugging \
  nuttx \
  &gt;nuttx.S \
  2&gt;&amp;1

Cargo build debug
https://gist.github.com/lupyuen/7b52d54725aaa831cb3dddc0b68bb41f
/Users/luppy/riscv/leds64-debug-nuttx.S</code></pre></div>
<p>TODO dump libhello</p>
<div class="example-wrap"><pre class="language-text"><code>## Dump the libhello.a disassembly to libhello.S
riscv-none-elf-objdump \
  --syms --source --reloc --demangle --line-numbers --wide \
  --debugging \
  /home/luppy/rust/apps/examples/rust/hello/target/riscv64imac-unknown-nuttx-elf/debug/libhello.a \
  &gt;libhello.S \
  2&gt;&amp;1

/Users/luppy/riscv/libhello.S</code></pre></div>
<p>Search for pthread_create</p>
<div class="example-wrap"><pre class="language-text"><code>/home/luppy/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/pal/unix/thread.rs:85
                    assert_eq!(libc::pthread_attr_setstacksize(&amp;mut attr, stack_size), 0);
                }
            };
        }

        let ret = libc::pthread_create(&amp;mut native, &amp;attr, thread_start, p as *mut _);
 122:	00000517          	auipc	a0,0x0	122: R_RISCV_PCREL_HI20	std::sys::pal::unix::thread::Thread::new::thread_start
 126:	00050613          	mv	a2,a0	126: R_RISCV_PCREL_LO12_I	.Lpcrel_hi254
 12a:	0148                	add	a0,sp,132
 12c:	012c                	add	a1,sp,136
 12e:	f82e                	sd	a1,48(sp)
 130:	00000097          	auipc	ra,0x0	130: R_RISCV_CALL_PLT	pthread_create
 134:	000080e7          	jalr	ra # 130 &lt;.Lpcrel_hi254+0xe&gt;
 138:	85aa                	mv	a1,a0
 13a:	7542                	ld	a0,48(sp)
 13c:	862e                	mv	a2,a1
 13e:	fc32                	sd	a2,56(sp)
 140:	1eb12e23          	sw	a1,508(sp)

https://doc.rust-lang.org/src/std/sys/pal/unix/thread.rs.html#84

https://github.com/rust-lang/rust/blob/master/library/std/src/thread/mod.rs#L502
    unsafe fn spawn_unchecked_&lt;&#39;scope, F, T&gt;(
        let my_thread = Thread::new(id, name);

Disassembly of section .text._ZN4core3ptr164drop_in_place$LT$std..thread..Builder..spawn_unchecked_..MaybeDangling$LT$tokio..runtime..blocking..pool..Spawner..spawn_thread..$u7b$$u7b$closure$u7d$$u7d$$GT$$GT$17hdb2d2ae6bc31ecdfE:

0000000000000000 &lt;core::ptr::drop_in_place&lt;std::thread::Builder::spawn_unchecked_::MaybeDangling&lt;tokio::runtime::blocking::pool::Spawner::spawn_thread::{{closure}}&gt;&gt;&gt;:
core::ptr::drop_in_place&lt;std::thread::Builder::spawn_unchecked_::MaybeDangling&lt;tokio::runtime::blocking::pool::Spawner::spawn_thread::{{closure}}&gt;&gt;:
/home/luppy/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:523
   0:	1141                	add	sp,sp,-16
   2:	e406                	sd	ra,8(sp)
   4:	e02a                	sd	a0,0(sp)
   6:	00000097          	auipc	ra,0x0	6: R_RISCV_CALL_PLT	&lt;std::thread::Builder::spawn_unchecked_::MaybeDangling&lt;T&gt; as core::ops::drop::Drop&gt;::drop
   a:	000080e7          	jalr	ra # 6 &lt;core::ptr::drop_in_place&lt;std::thread::Builder::spawn_unchecked_::MaybeDangling&lt;tokio::runtime::blocking::pool::Spawner::spawn_thread::{{closure}}&gt;&gt;+0x6&gt;
   e:	60a2                	ld	ra,8(sp)
  10:	0141                	add	sp,sp,16
  12:	8082                	ret</code></pre></div>
<p>TODO NuttX Thread not Task</p>
<div class="example-wrap"><pre class="language-text"><code>hello_rust_cargo &amp;
https://gist.github.com/lupyuen/0377d9e015fee1d6a833c22e1b118961
nsh&gt; hello_rust_cargo &amp;
hello_rust_cargo [4:100]
nsh&gt; {&quot;name&quot;:&quot;John&quot;,&quot;age&quot;:30}
{&quot;name&quot;:&quot;Jane&quot;,&quot;age&quot;:25}
Deserialized: Alice is 28 years old
Pretty JSON:
{
  &quot;name&quot;: &quot;Alice&quot;,
  &quot;age&quot;: 28
}
Hello world from tokio!

nsh&gt; ps
  PID GROUP PRI POLICY   TYPE    NPX STATE    EVENT     SIGMASK            STACK    USED FILLED COMMAND
    0     0   0 FIFO     Kthread   - Ready              0000000000000000 0001904 0000712  37.3%  Idle_Task
    2     2 100 RR       Task      - Running            0000000000000000 0002888 0002472  85.5%! nsh_main
    4     4 100 RR       Task      - Ready              0000000000000000 0007992 0006904  86.3%! hello_rust_cargo</code></pre></div>
<p>Override nightly</p>
<div class="example-wrap"><pre class="language-bash"><code>## Set Rust to nightly
pushd ..
rustup override list
rustup override set nightly
rustup override list
popd</code></pre></div>
<p>TODO: nix</p>
<div class="example-wrap"><pre class="language-text"><code>https://crates.io/crates/nix
https://docs.rs/nix/0.29.0/nix/

‚ûú  hello git:(master) ‚úó $ cargo add nix --no-default-features
    Updating crates.io index
      Adding nix v0.29.0 to dependencies
             Features:
             35 deactivated features

‚ûú  hello git:(master) ‚úó $ cargo add nix --features fs,ioctl
    Updating crates.io index
      Adding nix v0.29.0 to dependencies
             Features:
             + fs
             + ioctl
             33 deactivated features

‚ûú  hello git:(rust-std) ‚úó $ cargo add nix --features fs,ioctl --git https://github.com/lupyuen/nix.git --branch nuttx
    Updating git repository `https://github.com/lupyuen/nix.git`
      Adding nix (git) to dependencies
             Features:
             + fs
             + ioctl
             34 deactivated features
    Updating git repository `https://github.com/lupyuen/nix.git`
     Locking 1 package to latest compatible version
      Adding nix v0.29.0 (https://github.com/lupyuen/nix.git?branch=nuttx#bcbcb50f)

‚ûú  hello git:(master) ‚úó $ pwd
/Users/luppy/riscv/apps/examples/rust/hello

   Compiling tokio v1.43.0
error[E0432]: unresolved import `self::consts`
  --&gt; /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/errno.rs:19:15
   |
19 | pub use self::consts::*;
   |               ^^^^^^ could not find `consts` in `self`

error[E0432]: unresolved import `self::Errno`
   --&gt; /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/errno.rs:198:15
    |
198 |     use self::Errno::*;
    |               ^^^^^ could not find `Errno` in `self`

error[E0432]: unresolved import `crate::errno::Errno`
 --&gt; /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/fcntl.rs:2:5
  |
2 | use crate::errno::Errno;
  |     ^^^^^^^^^^^^^^-----
  |     |             |
  |     |             help: a similar name exists in the module: `errno`
  |     no `Errno` in `errno`

error[E0432]: unresolved import `crate::errno::Errno`
 --&gt; /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/sys/signal.rs:6:5
  |
6 | use crate::errno::Errno;
  |     ^^^^^^^^^^^^^^-----
  |     |             |
  |     |             help: a similar name exists in the module: `errno`
  |     no `Errno` in `errno`

error[E0432]: unresolved import `crate::errno::Errno`
 --&gt; /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/unistd.rs:3:5
  |
3 | use crate::errno::Errno;
  |     ^^^^^^^^^^^^^^-----
  |     |             |
  |     |             help: a similar name exists in the module: `errno`
  |     no `Errno` in `errno`

error[E0432]: unresolved import `errno::Errno`
   --&gt; /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/lib.rs:194:5
    |
194 | use errno::Errno;
    |     ^^^^^^^-----
    |     |      |
    |     |      help: a similar name exists in the module: `errno`
    |     no `Errno` in `errno`</code></pre></div>
<p>TODO: Fix nix</p>
<div class="example-wrap"><pre class="language-text"><code>/Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/errno.rs
Copy #[cfg(target_os = &quot;freebsd&quot;)]
to #[cfg(target_os = &quot;nuttx&quot;)]

/Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/sys/time.rs
    /// Leave the timestamp unchanged.
    #[cfg(not(any(target_os = &quot;redox&quot;, target_os=&quot;nuttx&quot;)))]////
    // At the time of writing this PR, redox does not support this feature
    pub const UTIME_OMIT: TimeSpec =
        TimeSpec::new(0, libc::UTIME_OMIT as timespec_tv_nsec_t);
    /// Update the timestamp to `Now`
    // At the time of writing this PR, redox does not support this feature
    #[cfg(not(any(target_os = &quot;redox&quot;, target_os = &quot;nuttx&quot;)))]////
    pub const UTIME_NOW: TimeSpec =
        TimeSpec::new(0, libc::UTIME_NOW as timespec_tv_nsec_t);

cp \
  /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/errno.rs \
  /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/sys/time.rs \
  /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/fcntl.rs \
  /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/unistd.rs \
  /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/sys/stat.rs \
  /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/sys/statvfs.rs \
  /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/sys/ioctl/mod.rs \
  /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/sys/mod.rs \
  /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0/src/sys/ioctl/bsd.rs \
  .
cp -r \
  /Users/luppy/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/nix-0.29.0 \
  .</code></pre></div>
<p>TODO: panic</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-12.7.0
nsh&gt; hello_rust_cargo
fd=3
{&quot;name&quot;:&quot;John&quot;,&quot;age&quot;:30}
{&quot;name&quot;:&quot;Jane&quot;,&quot;age&quot;:25}
Deserialized: Alice is 28 years old
Pretty JSON:
{
  &quot;name&quot;: &quot;Alice&quot;,
  &quot;age&quot;: 28
}
Hello world from tokio!

NuttShell (NSH) NuttX-12.7.0
nsh&gt; hello_rust_cargo

thread &#39;&lt;unnamed&gt;&#39; panicked at src/lib.rs:18:71:
called `Result::unwrap()` on an `Err` value: ENOENT
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
nsh&gt; </code></pre></div>
<p>TODO: ioctl</p>
<div class="example-wrap"><pre class="language-text"><code>https://docs.rs/nix/latest/nix/sys/ioctl/

/Users/luppy/riscv/nuttx/fs/vfs/fs_ioctl.c
int ioctl(int fd, int req, ...) {
  _info(&quot;fd=0x%x, req=0x%x&quot;, fd, req);////

    const ULEDIOC_SETALL: i32 = 0x1d03;
    ioctl_none!(led_on, ULEDIOC_SETALL, 1);
    unsafe { led_on(fd).unwrap(); }

NuttShell (NSH) NuttX-12.7.0
nsh&gt; ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102

ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102
nsh&gt; ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102
hello_rust_cargo
ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102
ioctl: fd=0x1, req=0x118
fd=3
ioctl: fd=0x3, req=0x201d0301

thread &#39;&lt;unnamed&gt;&#39; panicked at src/lib.rs:31:25:
called `Result::unwrap()` on an `Err` value: ENOTTY
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
nsh&gt; ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102

    const ULEDIOC_SETALL: i32 = 0x1d03;
    // ioctl_none!(led_on, ULEDIOC_SETALL, 1);
    ioctl_write_int!(led_on, ULEDIOC_SETALL, 1);
    unsafe { led_on(fd, 1).unwrap(); }
    unsafe { led_on(fd, 0).unwrap(); }

NuttShell (NSH) NuttX-12.7.0
nsh&gt; ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102

ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102
nsh&gt; ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102
hello_rust_cargo
ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102
ioctl: fd=0x1, req=0x118
fd=3
ioctl: fd=0x3, req=0x801d0301

thread &#39;&lt;unnamed&gt;&#39; panicked at src/lib.rs:30:28:
called `Result::unwrap()` on an `Err` value: ENOTTY
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
nsh&gt; ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102</code></pre></div>
<p>ioctl OK yay!</p>
<div class="example-wrap"><pre class="language-text"><code>    const ULEDIOC_SETALL: i32 = 0x1d03;
    ioctl_write_int_bad!(led_set_all, ULEDIOC_SETALL);

    // Equivalent to ioctl(fd, ULEDIOC_SETALL, 1)
    unsafe { led_set_all(fd, 1).unwrap(); }

    // Equivalent to ioctl(fd, ULEDIOC_SETALL, 0)
    unsafe { led_set_all(fd, 0).unwrap(); }

NuttShell (NSH) NuttX-12.7.0
nsh&gt; ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102
hello_rust_cargo
ioctl: fd=0x0, req=0x101
ioctl: fd=0x0, req=0x102
ioctl: fd=0x1, req=0x118
fd=3
ioctl: fd=0x3, req=0x1d03
board_userled: LED 1 set to 1
board_userled: LED 2 set to 0
board_userled: LED 3 set to 0
ioctl: fd=0x3, req=0x1d03
board_userled: LED 1 set to 0
board_userled: LED 2 set to 0
board_userled: LED 3 set to 0
{&quot;name&quot;:&quot;John&quot;,&quot;age&quot;:30}
{&quot;name&quot;:&quot;Jane&quot;,&quot;age&quot;:25}
Deserialized: Alice is 28 years old
Pretty JSON:
{
  &quot;name&quot;: &quot;Alice&quot;,
  &quot;age&quot;: 28
}
Hello world from tokio!</code></pre></div>
<p>Updated nix</p>
<div class="example-wrap"><pre class="language-text"><code>Add support for NuttX #1
https://github.com/lupyuen/nix/pull/1/files

Implement I/O Safety #1750
https://github.com/nix-rust/nix/issues/1750

Feature Name: io_safety
https://github.com/rust-lang/rfcs/blob/master/text/3128-io-safety.md</code></pre></div>
<p><a href="https://docs.rs/rustix/latest/rustix/ioctl/index.html">Rustix Ioctl</a></p>
<p>NOTUSED</p>
<div class="example-wrap"><pre class="language-text"><code>## Build Apps Filesystem
make -j export
pushd ../apps
./tools/mkimport.sh -z -x ../nuttx/nuttx-export-*.tar.gz
make -j import
./tools/mkromfsimg.sh ../nuttx/arch/risc-v/src/board/romfs_boot.c
popd
make -j

qemu-system-riscv64 \
  -semihosting \
  -M virt,aclint=on \
  -cpu rv64 \
  -kernel nuttx \
  -nographic

qemu-system-riscv32 \
  -semihosting \
  -M virt,aclint=on \
  -cpu rv32 \
  -smp 8 \
  -bios nuttx \
  -nographic

$ qemu-system-riscv32 -semihosting -M virt,aclint=on -cpu rv32 -smp 8 -bios nuttx -nographic
ABC
NuttShell (NSH) NuttX-10.0.1
nsh&gt; uname -a
NuttX 10.0.1 8205548707 Jan  9 2025 12:25:16 risc-v rv-virt

nsh&gt; hello_rust_cargo
{&quot;name&quot;:&quot;John&quot;,&quot;age&quot;:30}
{&quot;name&quot;:&quot;Jane&quot;,&quot;age&quot;:25}
Deserialized: Alice is 28 years old
Pretty JSON:
{
  &quot;name&quot;: &quot;Alice&quot;,
  &quot;age&quot;: 28
}
Hello world from tokio!</code></pre></div><h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>11 What‚Äôs Next</h1>
<p>Next Article: Why <strong>Sync-Build-Ingest</strong> is super important for NuttX Continuous Integration. And how we monitor it with our <strong>Magic Disco Light</strong>.</p>
<p>After That: Since we can <strong>Rewind NuttX Builds</strong> and automatically <strong>Git Bisect</strong>‚Ä¶ Can we create a Bot that will fetch the <strong>Failed Builds from NuttX Dashboard</strong>, identify the Breaking PR, and escalate to the right folks?</p>
<p>Many Thanks to the awesome <strong>NuttX Admins</strong> and <strong>NuttX Devs</strong>! And <a href="https://lupyuen.org/articles/sponsor"><strong>My Sponsors</strong></a>, for sticking with me all these years.</p>
<ul>
<li>
<p><a href="https://lupyuen.org/articles/sponsor"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/nuttx-sg2000"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Sophgo SG2000‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/nuttx-ox64"><strong>My Other Project: ‚ÄúNuttX for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/nuttx-star64"><strong>Older Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/pinephone-nuttx"><strong>Olderer Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.org"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.org/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://codeberg.org/lupyuen/lupyuen.org/src/branch/master/src/rust7.md"><strong>lupyuen.org/src/rust7.md</strong></a></p>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>