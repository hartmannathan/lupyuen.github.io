<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Daily Automated Testing for Milk-V Duo S RISC-V SBC (IKEA TRETAKT / Apache NuttX RTOS)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Daily Automated Testing for Milk-V Duo S RISC-V SBC (IKEA TRETAKT / Apache NuttX RTOS)" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/sg2000a-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.codeberg.page/articles/sg2000a.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Daily Automated Testing for Milk-V Duo S RISC-V SBC (IKEA TRETAKT / Apache NuttX RTOS)</h1>
    <nav id="TOC"><ul>
<li><a href="#control-our-sbc-with-an-ikea-smart-power-plug-and-home-assistant">1 Control our SBC with an IKEA Smart Power Plug and Home Assistant</a><ul></ul></li>
<li><a href="#automated-testing-of-apache-nuttx-rtos-on-sophgo-sg2000-soc--milk-v-duo-s-sbc">2 Automated Testing of Apache NuttX RTOS on Sophgo SG2000 SoC / Milk-V Duo S SBC</a><ul></ul></li>
<li><a href="#whats-next">3 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>29 Jun 2024</em></p>
<p><img src="https://lupyuen.github.io/images/sg2000a-title.jpg" alt="TODO" /></p>
<p>Last week we upstreamed Milk-V Duo S SBC to Apache NuttX RTOS.</p>
<p>(Based on Sophgo SG2000 RISC-V SoC)</p>
<p>But NuttX Mainline <a href="https://github.com/apache/nuttx/commits/master/"><strong>changes every day</strong></a>.</p>
<p>Can we be sure that Milk-V Duo S won‚Äôt suffer <strong>‚ÄúSoftware Bit Rot‚Äù</strong>? And fail to boot NuttX someday?</p>
<p>Let‚Äôs do <strong>Daily Automated Testing</strong> for NuttX on a Milk-V Duo S. Yep on the Actual Physical SBC!</p>
<p>TODO: Pic of SBC</p>
<h1 id="control-our-sbc-with-an-ikea-smart-power-plug-and-home-assistant"><a class="doc-anchor" href="#control-our-sbc-with-an-ikea-smart-power-plug-and-home-assistant">¬ß</a>1 Control our SBC with an IKEA Smart Power Plug and Home Assistant</h1>
<p>Toughest Thing about our Daily Exercise: <strong>Automagically Powering Up</strong> our SBC.</p>
<p>We hike to our neighbourhood IKEA Store and buy‚Ä¶</p>
<ul>
<li>
<p><a href="https://www.ikea.com/gb/en/p/tretakt-plug-with-remote-control-smart-30569726/"><strong>IKEA TRETAKT Smart Power Plug</strong></a></p>
<p>(Which talks Zigbee, not WiFi)</p>
</li>
<li>
<p><a href="https://www.ikea.com/gb/en/p/dirigera-hub-for-smart-products-white-smart-50503409/"><strong>IKEA DIRIGERA Zigbee Hub</strong></a></p>
<p>(Which talks Ethernet, not WiFi!)</p>
</li>
</ul>
<p>We add the Smart Power Plug to the <a href="https://www.ikea.com/sg/en/customer-service/product-support/smart-home-dirigera-hub/"><strong>IKEA Home Smart App</strong></a>. And we name it <strong>‚ÄúSG2000 Power‚Äù</strong>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/sg2000a-ikea.jpg" alt="IKEA Smart Power Plug in IKEA Home Smart App" /></p>
<p><em>But IKEA doesn‚Äôt provide a Public API for their gadgets!</em></p>
<p>Yeah our script can‚Äôt directly control the power plug sigh. That‚Äôs why we‚Ä¶</p>
<ol>
<li>
<p>Add the IKEA Smart Power Plug to <a href="https://www.ikea.com/nl/en/customer-service/knowledge/articles/c916g4b0-c602-4g65-9c4e-b40f801g43dc.html"><strong>Google Assistant</strong></a></p>
<p>(On our Android Phone)</p>
</li>
<li>
<p>Eventually control the IKEA Smart Power Plug via the <a href="https://gist.github.com/lupyuen/01cff0d4ca225984ca8fd0d999d7c76d"><strong>Google Assistant SDK</strong></a></p>
<p>(Which sounds kinda tedious)</p>
</li>
<li>
<p>So instead we connect <a href="https://gist.github.com/lupyuen/01cff0d4ca225984ca8fd0d999d7c76d"><strong>Home Assistant</strong></a> to Google Assistant SDK</p>
<p>(Just point and click yay!)</p>
</li>
<li>
<p><strong>For macOS:</strong> We run Home Assistant in a <a href="https://gist.github.com/lupyuen/03a7cc8702085c70893e157d8c3ca3f8"><strong>Docker Container</strong></a></p>
<p><a href="https://gist.github.com/lupyuen/03a7cc8702085c70893e157d8c3ca3f8"><strong>(Rancher Desktop)</strong></a></p>
</li>
</ol>
<p><em>How will Home Assistant control Google Assistant to control our Smart Power Plug?</em></p>
<p>Assume we have added the Smart Power Plug to Google Assistant, and named the Smart Power Plug as ‚ÄúSG2000 Power‚Äù. We create an Automation in Home Assistant‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/sg2000a-ha1.jpg" alt="Create an Automation in Home Assistant" /></p>
<p>Inside our Automation: Add an Action‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/sg2000a-ha2.jpg" alt="Create an Automation in Home Assistant" /></p>
<p>Select the Google Assistant SDK. Enter the command: ‚ÄúSG2000 Power On‚Äù‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/sg2000a-ha3.jpg" alt="Create an Automation in Home Assistant" /></p>
<p>Save it as an Automation named ‚ÄúSG2000 Power On‚Äù‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/sg2000a-ha4.png" alt="Create an Automation in Home Assistant" /></p>
<p><em>But how do we Power On our SBC from our Automated Test Script?</em></p>
<p>We call the <a href="https://developers.home-assistant.io/docs/api/rest/">Home Assistant REST API</a> with a Home Assistant Long-Lived Token: <a href="https://github.com/lupyuen2/autotest-nuttx-sg2000/blob/main/scripts/test.sh#L54-L80">test.sh</a></p>
<div class="example-wrap"><pre class="language-bash"><code>## Get the Home Assistant Token, copied from http://localhost:8123/profile/security
## token=xxxx
. $HOME/home-assistant-token.sh

echo &quot;----- Power Off the SBC&quot;
curl \
  -X POST \
  -H &quot;Authorization: Bearer $token&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d &#39;{&quot;entity_id&quot;: &quot;automation.sg2000_power_off&quot;}&#39; \
  http://localhost:8123/api/services/automation/trigger

echo &quot;----- Power On the SBC&quot;
curl \
  -X POST \
  -H &quot;Authorization: Bearer $token&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d &#39;{&quot;entity_id&quot;: &quot;automation.sg2000_power_on&quot;}&#39; \
  http://localhost:8123/api/services/automation/trigger
</code></pre></div>
<p><em>Doesn‚Äôt the USB UART Adapter supply a tiny bit of power to our SBC?</em></p>
<p>Yeah enough power to light up the SBC, but not enough to power up the SBC totally.</p>
<p>Thus our SBC will glow at night, even though the power is off. (I drape a hand towel so it won‚Äôt bother my sleep)</p>
<p><img src="https://lupyuen.github.io/images/sg2000a-title.jpg" alt="Power On our SBC from our Automated Test Script" /></p>
<h1 id="automated-testing-of-apache-nuttx-rtos-on-sophgo-sg2000-soc--milk-v-duo-s-sbc"><a class="doc-anchor" href="#automated-testing-of-apache-nuttx-rtos-on-sophgo-sg2000-soc--milk-v-duo-s-sbc">¬ß</a>2 Automated Testing of Apache NuttX RTOS on Sophgo SG2000 SoC / Milk-V Duo S SBC</h1>
<p>TODO</p>
<p>We are now running Daily Automated Testing of <a href="https://github.com/lupyuen/nuttx-sg2000">Apache NuttX RTOS</a> on a Real Milk-V Duo S SBC (Sophgo SG2000 SoC)‚Ä¶</p>
<ol>
<li>
<p>Download the <a href="https://github.com/lupyuen/nuttx-sg2000#nuttx-automated-daily-build-for-sg2000">Automated Daily Build</a> to TFTP Server</p>
</li>
<li>
<p>Power on our SBC with an <a href="https://github.com/lupyuen2/autotest-nuttx-sg2000#control-our-sbc-with-an-ikea-smart-power-plug-and-home-assistant">IKEA Smart Power Plug via Home Assistant</a></p>
</li>
<li>
<p>Our SBC boots the Daily Build over TFTP</p>
</li>
<li>
<p>Capture the Automated Testing Log and write to the Release Notes</p>
</li>
</ol>
<p>Like this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Run the Daily Automated Testing
script /tmp/release.log scripts/test.sh

## Upload the Test Log to GitHub Release Notes
scripts/upload.sh

## OR: Do this to run the Automated Test automatically whenever there&#39;s a Daily Build
scripts/task.sh
</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx-sg2000/releases">(See the Automated Test Logs)</a></p>
<p>Here are the Automated Testing Scripts‚Ä¶</p>
<ul>
<li>Automated Task: <a href="scripts/task.sh">task.sh</a></li>
<li>Test NuttX on SBC: <a href="scripts/test.sh">test.sh</a></li>
<li>Upload Test Log: <a href="scripts/upload.sh">upload.sh</a></li>
<li>Expect Script: <a href="scripts/nuttx.exp">nuttx.exp</a></li>
</ul>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>3 What‚Äôs Next</h1>
<p>TODO</p>
<p><em>Why not run the Daily Automated Test on a Software Emulator? (Instead of Real Hardware)</em></p>
<p>Oh yes we‚Äôre doing that too! Please join me in the next article on <strong>SG2000 Emulator</strong>.</p>
<p>TODO</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> (and the awesome NuttX Community) for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-ox64"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-star64"><strong>My Other Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>Older Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/sg2000a.md"><strong>lupyuen.github.io/src/sg2000a.md</strong></a></p>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>