<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>NuttX RTOS for PinePhone: Exploring USB</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="NuttX RTOS for PinePhone: Exploring USB" 
    data-rh="true">
<meta property="og:description" 
    content="What's inside the USB Controller of Pine64 PinePhone... And how we'll create a USB Driver for Apache NuttX RTOS"
    data-rh="true">
<meta name="description" 
    content="What's inside the USB Controller of Pine64 PinePhone... And how we'll create a USB Driver for Apache NuttX RTOS">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/usb2-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">NuttX RTOS for PinePhone: Exploring USB</h1>
    <nav id="TOC"><ul>
<li><a href="#pinephone--nuttx--feature-phone">1 PinePhone + NuttX = Feature Phone</a><ul></ul></li>
<li><a href="#quectel-eg25-g-lte-modem">2 Quectel EG25-G LTE Modem</a><ul></ul></li>
<li><a href="#lte-modem-talks-usb">3 LTE Modem talks USB</a><ul></ul></li>
<li><a href="#document-the-usb-controller">4 Document the USB Controller</a><ul></ul></li>
<li><a href="#search-for-usb-driver">5 Search for USB Driver</a><ul></ul></li>
<li><a href="#freebsd-usb-driver">6 FreeBSD USB Driver</a><ul></ul></li>
<li><a href="#understand-the-freebsd-driver">7 Understand the FreeBSD Driver</a><ul></ul></li>
<li><a href="#usb-drivers-in-nuttx">8 USB Drivers in NuttX</a><ul></ul></li>
<li><a href="#stm32-usb-driver-for-nuttx">9 STM32 USB Driver for NuttX</a><ul></ul></li>
<li><a href="#whats-next">10 What‚Äôs Next</a><ul></ul></li>
<li><a href="#appendix-lora-communicator-for-pinephone-on-nuttx">11 Appendix: LoRa Communicator for PinePhone on NuttX</a><ul></ul></li></ul></nav><p>üìù <em>20 Feb 2023</em></p>
<p><img src="https://lupyuen.github.io/images/usb2-title.jpg" alt="PinePhone talks to LTE Modem over USB" /></p>
<p><em>PinePhone talks to LTE Modem over USB</em></p>
<p>Over the past <a href="https://github.com/lupyuen/pinephone-nuttx"><strong>17 articles</strong></a> we talked about porting to <a href="https://wiki.pine64.org/index.php/PinePhone"><strong>Pine64 PinePhone</strong></a> a Real-Time Operating System: <a href="https://lupyuen.github.io/articles/what"><strong>Apache NuttX RTOS</strong></a>.</p>
<p>Today NuttX can run <a href="https://lupyuen.github.io/articles/terminal"><strong>Touchscreen Apps</strong></a> on PinePhone‚Ä¶ But it ain‚Äôt done yet till we can make <strong>Phone Calls</strong> and send <strong>Text Messages</strong>!</p>
<p>In this article we‚Äôll dive into PinePhone‚Äôs <strong>USB Controller</strong>‚Ä¶</p>
<ul>
<li>
<p>Why PinePhone needs USB for <strong>Voice Calls and SMS</strong></p>
</li>
<li>
<p>What‚Äôs inside PinePhone‚Äôs Allwinner A64 <strong>USB Controller</strong></p>
</li>
<li>
<p>Which is actually a <strong>Mentor Graphics Inventra</strong> USB Controller</p>
</li>
<li>
<p>We‚Äôll study the <strong>FreeBSD Driver</strong> for the USB Controller</p>
</li>
<li>
<p>And how we might port the USB Driver to <strong>NuttX RTOS</strong></p>
</li>
<li>
<p>By comparing with the <strong>STM32 USB Driver</strong> for NuttX</p>
</li>
</ul>
<p>Our journey down the PinePhone USB Rabbit Hole begins with a curious comment‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/wayland-sd.jpg" alt="Quectel EG25-G LTE Modem inside PinePhone" /></p>
<p><em>Quectel EG25-G LTE Modem inside PinePhone</em></p>
<h1 id="pinephone--nuttx--feature-phone"><a href="#pinephone--nuttx--feature-phone">1 PinePhone + NuttX = Feature Phone</a></h1>
<p><em>Now that NuttX can run Touchscreen Apps on PinePhone‚Ä¶ What next?</em></p>
<p>We might turn PinePhone on NuttX into a <strong>Feature Phone</strong>, thanks to an inspiring comment on YouTube‚Ä¶</p>
<blockquote>
<p><em>‚ÄúI‚Äôd like to use or build a ‚Äòfeature-phone‚Äô-style UI for the PinePhone someday‚Äù</em></p>
</blockquote>
<blockquote>
<p><em>‚ÄúIs there USB support (In NuttX, and your port)? I think that would be the first step in getting the modem to work‚Äù</em></p>
</blockquote>
<blockquote>
<p><a href="https://youtu.be/WdiXaMK8cNw">(Source)</a></p>
</blockquote>
<p>Excellent Idea! We‚Äôll turn NuttX on PinePhone into a <strong>Feature Phone</strong>‚Ä¶</p>
<p>Just <strong>Voice Calls and SMS</strong>, using PinePhone‚Äôs LTE Modem.</p>
<p>(<strong>LTE Modem</strong> is the hardware inside PinePhone that handles 4G Voice Calls, SMS and Mobile Data)</p>
<p><em>Why is this useful?</em></p>
<p>Maybe we can pop a microSD Card (and SIM) into any PinePhone‚Ä¶</p>
<p>And turn it instantly into an <strong>Emergency Phone</strong> with NuttX?</p>
<p><em>What if there‚Äôs no LTE Network Coverage? Like in a Natural Disaster?</em></p>
<p>The Long-Range, Low-Power <a href="https://makezine.com/article/technology/go-long-with-lora-radio/"><strong>LoRa Network</strong></a> might be good for search and rescue communications.</p>
<p>We could attach the <a href="https://lupyuen.github.io/articles/usb2#appendix-lora-communicator-for-pinephone-on-nuttx"><strong>PineDio LoRa Add-On Case</strong></a> to turn PinePhone into a <strong>LoRa Communicator</strong>.</p>
<p><a href="https://lupyuen.github.io/articles/usb2#appendix-lora-communicator-for-pinephone-on-nuttx">(More about this)</a></p>
<p><em>Will PinePhone on NuttX become a fully-functional smartphone?</em></p>
<p>Maybe someday? We‚Äôre still lacking plenty of drivers: WiFi, Bluetooth LE, GPS, Audio, ‚Ä¶</p>
<p>Probably better to start as a Feature Phone (or LoRa Communication) and build up.</p>
<p>Let‚Äôs talk about PinePhone‚Äôs LTE Modem‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/usb2-modem.jpg" alt="Quectel EG25-G LTE Modem" /></p>
<p><a href="https://wiki.pine64.org/wiki/File:Quectel_EG25-G_LTE_Standard_Specification_V1.3.pdf"><em>Quectel EG25-G LTE Modem</em></a></p>
<h1 id="quectel-eg25-g-lte-modem"><a href="#quectel-eg25-g-lte-modem">2 Quectel EG25-G LTE Modem</a></h1>
<p><em>What‚Äôs this LTE Modem?</em></p>
<p>Inside PinePhone is the <a href="https://wiki.pine64.org/index.php/PinePhone#Modem"><strong>Quectel EG25-G LTE Modem</strong></a> for 4G Voice Calls, SMS, Mobile Data and GPS (pic above)‚Ä¶</p>
<ul>
<li>
<p><a href="https://wiki.pine64.org/wiki/File:Quectel_EG25-G_LTE_Standard_Specification_V1.3.pdf"><strong>Quectel EG25-G Datasheet</strong></a></p>
</li>
<li>
<p><a href="https://wiki.pine64.org/wiki/File:Quectel_EG25-G_Hardware_Design_V1.4.pdf"><strong>EG25-G Hardware Design</strong></a></p>
</li>
</ul>
<p>To control the LTE Modem, we send <strong>AT Commands</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://wiki.pine64.org/wiki/File:Quectel_EC2x%26EG9x%26EG2x-G%26EM05_Series_AT_Commands_Manual_V2.0.pdf"><strong>EG25-G AT Commands</strong></a></p>
</li>
<li>
<p><a href="https://wiki.pine64.org/wiki/File:Quectel_EC2x%26EG9x%26EG2x-G%26EM05_Series_GNSS_Application_Note_V1.3.pdf"><strong>EG25-G GNSS</strong></a></p>
</li>
</ul>
<p>So to dial the number <strong><code>1711</code></strong>, we send this AT Command‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>ATD1711;
</code></pre></div>
<p><a href="https://xnux.eu/devices/feature/modem-pp.html#toc-modem-on-pinephone">(EG25-G runs on <strong>Qualcomm MDM 9607</strong> with a Cortex-A7 CPU inside)</a></p>
<p><em>We send the AT Commands over UART?</em></p>
<p>Sadly we can‚Äôt send AT Commands to PinePhone‚Äôs LTE Modem over the UART Port.</p>
<p><a href="https://lupyuen.github.io/articles/get-started-with-nb-iot-and-quectel-modules">(Unlike other LTE Modems)</a></p>
<p>Instead, we talk to the LTE Modem over USB‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/usb2-title.jpg" alt="Quectel EG25-G LTE Modem in PinePhone Schematic (Page 15)" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>Quectel EG25-G LTE Modem in PinePhone Schematic (Page 15)</em></a></p>
<h1 id="lte-modem-talks-usb"><a href="#lte-modem-talks-usb">3 LTE Modem talks USB</a></h1>
<p><em>How is the LTE Modem connected to PinePhone?</em></p>
<p>According to the <a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><strong>PinePhone Schematic</strong></a> (Page 15), the Quectel EG25 LTE Modem connects to the <strong>Allwinner A64 SoC</strong> on the USB Pins‚Ä¶</p>
<ul>
<li>
<p><strong>USB1-DP</strong></p>
</li>
<li>
<p><strong>USB1-DM</strong></p>
</li>
</ul>
<p>Which is <strong>Port USB1</strong> of the Allwinner A64 SoC. (Pic above)</p>
<p><em>Only 2 pins?</em></p>
<p>That‚Äôs because <a href="https://en.wikipedia.org/wiki/USB_hardware#Pinouts"><strong>USB 2.0</strong></a> runs on 2 data wires and 2 power wires‚Ä¶</p>
<ul>
<li>
<p><strong>Data+</strong> (USB1-DP)</p>
</li>
<li>
<p><strong>Data-</strong> (USB1-DM)</p>
</li>
<li>
<p><strong>5V</strong> and <strong>GND</strong></p>
</li>
</ul>
<p><a href="https://en.wikipedia.org/wiki/Differential_signalling">(Due to <strong>Differential Signalling</strong>)</a> </p>
<p><em>What about USB0-DP and USB0-DM?</em></p>
<p><strong>Port USB0</strong> of the Allwinner A64 SoC is exposed as the <strong>External USB Port</strong> on PinePhone.</p>
<p><em>So PinePhone talks to the LTE Modem on USB Serial?</em></p>
<p>Correct! Here are the <strong>USB Endpoints</strong> exposed by the LTE Modem (which we‚Äôll decipher later)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ sudo lsusb -v

Bus 002 Device 002: ID 2c7c:0125 Quectel Wireless Solutions Co., Ltd. EC25 LTE modem
Device Descriptor:
  idVendor           0x2c7c Quectel Wireless Solutions Co., Ltd.
  idProduct          0x0125 EC25 LTE modem
  iManufacturer           1 Quectel
  iProduct                2 EG25-G

  Configuration Descriptor:
    bNumInterfaces          5
    Interface Descriptor:
      bInterfaceNumber        0
        bEndpointAddress     0x81  EP 1 IN
        bEndpointAddress     0x01  EP 1 OUT

    Interface Descriptor:
      bInterfaceNumber        1
        bEndpointAddress     0x83  EP 3 IN
        bEndpointAddress     0x82  EP 2 IN
        bEndpointAddress     0x02  EP 2 OUT

    Interface Descriptor:
      bInterfaceNumber        2
        bEndpointAddress     0x85  EP 5 IN
        bEndpointAddress     0x84  EP 4 IN
        bEndpointAddress     0x03  EP 3 OUT

    Interface Descriptor:
      bInterfaceNumber        3
        bEndpointAddress     0x87  EP 7 IN
        bEndpointAddress     0x86  EP 6 IN
        bEndpointAddress     0x04  EP 4 OUT

    Interface Descriptor:
      bInterfaceNumber        4
        bEndpointAddress     0x89  EP 9 IN
        bEndpointAddress     0x88  EP 8 IN
        bEndpointAddress     0x05  EP 5 OUT
</code></pre></div>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#usb-devices-on-pinephone">(Source)</a></p>
<p>But first we need to build the PinePhone USB Driver for NuttX‚Ä¶</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/usb2-meme.jpg" alt="Sorry Elmo‚Ä¶ Allwinner A64‚Äôs USB Controller isn‚Äôt documented" /></p>
</blockquote>
<blockquote>
<p><em>Sorry Elmo‚Ä¶ Allwinner A64‚Äôs USB Controller isn‚Äôt documented</em></p>
</blockquote>
<h1 id="document-the-usb-controller"><a href="#document-the-usb-controller">4 Document the USB Controller</a></h1>
<p><em>To turn PinePhone into a Feature Phone (Voice Calls and SMS only)‚Ä¶</em></p>
<p><em>What NuttX Drivers would we need?</em></p>
<p>We need a NuttX Driver for the PinePhone‚Äôs <a href="https://lupyuen.github.io/articles/usb2#quectel-eg25-g-lte-modem"><strong>Quectel LTE Modem</strong></a>‚Ä¶ Which talks over <a href="https://lupyuen.github.io/articles/usb2#lte-modem-talks-usb"><strong>USB Serial</strong></a>.</p>
<p>Thus we also need a NuttX Driver for PinePhone‚Äôs <strong>Allwinner A64 USB Controller</strong>.</p>
<p><em>So we check the USB Controller docs?</em></p>
<p>Allwinner A64‚Äôs USB Controller is officially documented in‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf"><strong>Allwinner A64 User Manual</strong></a></p>
<p>See <strong>Section 7.5 ‚ÄúUSB‚Äù</strong> (Page 583)</p>
</li>
</ul>
<p>Which doesn‚Äôt say much about the USB Controller!</p>
<p><em>Allwinner A64‚Äôs Official Docs are horrigibly lacking‚Ä¶</em></p>
<p>But thanks to the <a href="https://linux-sunxi.org/USB_OTG_Controller_Register_Guide"><strong>Sunxi Community</strong></a> we have a valuable tip on the USB Controller‚Ä¶</p>
<blockquote>
<p><em>‚ÄúAll Allwinner A-series SoCs come with one USB OTG controller‚Äù</em></p>
</blockquote>
<blockquote>
<p><em>‚ÄúThe controller has been identified as a <strong>Mentor Graphics Inventra HDRC</strong> (High-speed Dual Role Controller), which is supported by the musb driver‚Äù</em></p>
</blockquote>
<blockquote>
<p><em>‚ÄúHowever, the register addresses are scrambled‚Äù</em></p>
</blockquote>
<blockquote>
<p><a href="https://linux-sunxi.org/USB_OTG_Controller_Register_Guide">(Source)</a></p>
</blockquote>
<p>Aha! Allwinner A64‚Äôs USB Controller is actually a <strong>Mentor Graphics USB Controller</strong>!</p>
<ul>
<li><a href="https://linux-sunxi.org/images/7/73/Musbmhdrc.pdf"><strong>Mentor Graphics MUSBMHDRC USB 2.0 Multi-Point Dual-Role Controller</strong></a></li>
</ul>
<p>The Sunxi Community has helpfully documented the <strong>Scrambled USB Registers</strong>‚Ä¶</p>
<ul>
<li><a href="https://linux-sunxi.org/USB_OTG_Controller_Register_Guide"><strong>Allwinner USB OTG Controller Register Guide</strong></a></li>
</ul>
<p><strong>OTG</strong> refers to <a href="https://en.wikipedia.org/wiki/USB_On-The-Go"><strong>USB On-The-Go</strong></a>, which supports both USB Host Mode and USB Device Mode.</p>
<p>Let‚Äôs find a Reference Driver for the Mentor Graphics USB Controller‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/usb2-devicetree.png" alt="USB Controller in PinePhone Device Tree" /></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/sun50i-a64-pinephone-1.2.dts#L647-L721"><em>USB Controller in PinePhone Device Tree</em></a></p>
<h1 id="search-for-usb-driver"><a href="#search-for-usb-driver">5 Search for USB Driver</a></h1>
<p>TODO</p>
<p><em>How to find a driver for Allwinner A64‚Äôs USB Controller?</em></p>
<p>The <strong>Device Tree</strong> for PinePhone describes the Hardware Configuration of PinePhone.</p>
<p>PinePhone‚Äôs Device Tree says that the USB Drivers are‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>usb@1c19000 {
  compatible = &quot;allwinner,sun8i-a33-musb&quot;;
  ...
phy@1c19400 {
  compatible = &quot;allwinner,sun50i-a64-usb-phy&quot;;
</code></pre></div>
<p>(<strong>MUSB</strong> refers to the <a href="https://lupyuen.github.io/articles/usb2#document-the-usb-controller"><strong>Mentor Graphics</strong></a> USB Controller)</p>
<p>So we searched for ‚Äú<strong>allwinner,sun8i-a33-musb</strong>‚Äù and ‚Äú<strong>allwinner,sun50i-a64-usb-phy</strong>‚Äù.</p>
<p>Here‚Äôs the PinePhone USB Device Tree: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/sun50i-a64-pinephone-1.2.dts#L647-L721">sun50i-a64-pinephone-1.2.dts</a></p>
<p>Searching for ‚Äú<strong>allwinner,sun8i-a33-musb</strong>‚Äù on <a href="https://github.com/search?q=%22allwinner%2Csun8i-a33-musb%22+language%3AC&amp;type=code&amp;l=C"><strong>GitHub Code Search</strong></a> uncovers the Allwinner A64 USB Driver that we seek: FreeBSD, NetBSD and Linux‚Ä¶</p>
<h1 id="freebsd-usb-driver"><a href="#freebsd-usb-driver">6 FreeBSD USB Driver</a></h1>
<p><a href="https://github.com/search?q=%22allwinner%2Csun8i-a33-musb%22+language%3AC&amp;type=code&amp;l=C"><strong>GitHub Code Search</strong></a> says that the Allwinner A64 USB Driver for FreeBSD is‚Ä¶</p>
<ul>
<li><a href="https://github.com/freebsd/freebsd-src/blob/main/sys/dev/usb/controller/musb_otg_allwinner.c#L95"><strong>usb/controller/musb_otg_allwinner.c</strong></a></li>
</ul>
<p><strong>MUSB</strong> refers to the <a href="https://lupyuen.github.io/articles/usb2#document-the-usb-controller"><strong>Mentor Graphics</strong></a> USB Controller.</p>
<p><strong>OTG</strong> refers to <a href="https://en.wikipedia.org/wiki/USB_On-The-Go"><strong>USB On-The-Go</strong></a>, which supports both USB Host Mode and USB Device Mode.</p>
<p>(We‚Äôll stick to <strong>USB Host Mode</strong> for today)</p>
<p><em>But where‚Äôs the actual code for the USB Driver?</em></p>
<p>The <strong>Mentor Graphics USB Driver</strong> is mostly implemented here‚Ä¶</p>
<ul>
<li><a href="https://github.com/freebsd/freebsd-src/blob/main/sys/dev/usb/controller/musb_otg.c"><strong>usb/controller/musb_otg.c</strong></a></li>
</ul>
<p>Remember that the Allwinner A64 USB Controller is identical to the Mentor Graphics one‚Ä¶ Except that the <a href="https://lupyuen.github.io/articles/usb2#document-the-usb-controller"><strong>USB Registers are scrambled</strong></a>?</p>
<p>That‚Äôs why we need <a href="https://github.com/freebsd/freebsd-src/blob/main/sys/dev/usb/controller/musb_otg_allwinner.c#L140-L214"><strong>musb_otg_allwinner.c</strong></a> to unscramble the USB Registers, specifically for Allwinner A64.</p>
<p><a href="https://github.com/freebsd/freebsd-src/blob/main/sys/dev/usb/controller/musb_otg_allwinner.c#L140-L214">(Like this)</a></p>
<p>The <strong>USB Physical Layer</strong> for Allwinner A64 is implemented here, but we won‚Äôt touch it today‚Ä¶</p>
<ul>
<li><a href="https://github.com/freebsd/freebsd-src/blob/main/sys/arm/allwinner/aw_usbphy.c#L135"><strong>arm/allwinner/aw_usbphy.c</strong></a></li>
</ul>
<p><em>OK we‚Äôve seen the FreeBSD Drivers‚Ä¶ What about other operating systems?</em></p>
<p><a href="https://github.com/search?q=%22allwinner%2Csun8i-a33-musb%22+language%3AC&amp;type=code&amp;l=C"><strong>GitHub Code Search</strong></a> also uncovers the <strong>NetBSD Drivers</strong> for Allwinner A64 USB‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/NetBSD/src/blob/trunk/sys/arch/arm/sunxi/sunxi_musb.c#L67"><strong>USB Controller Driver: sunxi_musb.c</strong></a></p>
</li>
<li>
<p><a href="https://github.com/NetBSD/src/blob/trunk/sys/arch/arm/sunxi/sunxi_usbphy.c#L95"><strong>USB Physical Layer Driver: sunxi_usbphy.c</strong></a></p>
<p><a href="https://github.com/torvalds/linux/blob/master/drivers/usb/musb/sunxi.c">(And Linux too)</a></p>
</li>
</ul>
<p>But today we‚Äôll study the FreeBSD Driver because it‚Äôs easier to read.</p>
<p><img src="https://lupyuen.github.io/images/usb2-mentor.png" alt="Transmit Control Data as Host in Mentor Graphics USB Controller (Page 126)" /></p>
<p><a href="https://linux-sunxi.org/images/7/73/Musbmhdrc.pdf"><em>Transmit Control Data as Host in Mentor Graphics USB Controller (Page 126)</em></a></p>
<h1 id="understand-the-freebsd-driver"><a href="#understand-the-freebsd-driver">7 Understand the FreeBSD Driver</a></h1>
<p><em>Do we copy the FreeBSD Driver into NuttX?</em></p>
<p>Sorry that sounds mighty irresponsible‚Ä¶ If we don‚Äôt understand the code! (Just like ChatGPT)</p>
<p>Remember that the Allwinner A64 USB Controller is based on the <strong>design by Mentor Graphics</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/usb2#document-the-usb-controller"><strong>‚ÄúDocument the USB Controller‚Äù</strong></a></li>
</ul>
<p>Hence to understand the driver internals, we shall <strong>match the FreeBSD Driver Code</strong> with the <strong>Mentor Graphics Doc</strong>.</p>
<p><a href="https://en.wikipedia.org/wiki/Rosetta_Stone#Reading_the_Rosetta_Stone">(Kinda like <strong>Rosetta Stone</strong>)</a></p>
<p><em>Where do we start?</em></p>
<p>The Mentor Graphics Doc describes <strong>Transmitting Control Data</strong> (as a Host)‚Ä¶</p>
<ul>
<li><a href="https://linux-sunxi.org/images/7/73/Musbmhdrc.pdf"><strong>Mentor Graphics MUSBMHDRC</strong></a></li>
</ul>
<p>See <strong>Section 21.2.3</strong> ‚ÄúControl Transactions as a Host - Out Data Phase as a Host‚Äù. (Page 126, pic above)</p>
<p>This seems to match the FreeBSD Driver Code for <a href="https://github.com/freebsd/freebsd-src/blob/main/sys/dev/usb/controller/musb_otg.c#L1067-L1239"><strong>musbotg_host_ctrl_data_tx</strong></a> in <a href="https://github.com/freebsd/freebsd-src/blob/main/sys/dev/usb/controller/musb_otg.c#L1067-L1239"><strong>musb_otg.c</strong></a>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/usb2-freebsd.png" alt="musbotg_host_ctrl_data_tx in musb_otg.c" /></p>
<p><a href="https://github.com/freebsd/freebsd-src/blob/main/sys/dev/usb/controller/musb_otg.c#L1067-L1239">(Source)</a></p>
<p>So we compare the two side-by-side to figure out how it works‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/usb2-freebsd2.png" alt="Matching the Mentor Graphics Doc with the FreeBSD Driver Code" /></p>
<p>Matching the Mentor Graphics Doc with the FreeBSD Driver Code will be an interesting exercise.</p>
<p>Which we‚Äôll cover in the next article!</p>
<h1 id="usb-drivers-in-nuttx"><a href="#usb-drivers-in-nuttx">8 USB Drivers in NuttX</a></h1>
<p>TODO</p>
<p><em>We found the FreeBSD Driver for Allwinner A64 USB‚Ä¶</em></p>
<p><em>How will we adapt it for NuttX RTOS?</em></p>
<p>TODO</p>
<p><em>How do USB Drivers work in NuttX?</em></p>
<p>Check out this NuttX Doc on USB Drivers‚Ä¶</p>
<ul>
<li><a href="https://nuttx.apache.org/docs/latest/components/drivers/special/usbhost.html"><strong>‚ÄúUSB Host-Side Drivers‚Äù</strong></a></li>
</ul>
<h1 id="stm32-usb-driver-for-nuttx"><a href="#stm32-usb-driver-for-nuttx">9 STM32 USB Driver for NuttX</a></h1>
<p>TODO</p>
<p>NuttX USB Driver for STM32‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/arm/src/stm32/stm32_otgfshost.c">stm32_otgfshost.c</a></p>
</li>
<li>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/arm/src/stm32/stm32_otgfsdev.c">stm32_otgfsdev.c</a></p>
</li>
<li>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/arm/src/stm32/stm32_usbfs.c">stm32_usbfs.c</a></p>
</li>
<li>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/arm/src/stm32/stm32_usbhost.c">stm32_usbhost.c</a></p>
</li>
</ul>
<p>(USB OTG FS: Able to act as a device/host/OTG peripheral, at full speed 12Mbps)</p>
<p>(USB OTG HS: Able to act as a device/host/OTG peripheral, at full speed 12Mbps or high speed 480Mbps)</p>
<h1 id="whats-next"><a href="#whats-next">10 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Meanwhile please check out the other articles on NuttX for PinePhone‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>My Current Project: ‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>My Other Project: ‚ÄúThe RISC-V BL602 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/usb2.md"><strong>lupyuen.github.io/src/usb2.md</strong></a></p>
<p><img src="https://lupyuen.github.io/images/lorawan2-pine64.jpg" alt="Pine64 PineDio LoRa Gateway (left) with PineDio LoRa Add-On Case (right)" /></p>
<p><a href="https://pine64.com/product/pinephone-pinephone-pro-pindio-lora-add-on-case/"><em>Pine64 PineDio LoRa Gateway (left) with PineDio LoRa Add-On Case (right)</em></a></p>
<h1 id="appendix-lora-communicator-for-pinephone-on-nuttx"><a href="#appendix-lora-communicator-for-pinephone-on-nuttx">11 Appendix: LoRa Communicator for PinePhone on NuttX</a></h1>
<p>Earlier we talked about turning PinePhone on NuttX into a Feature Phone for <strong>Emergency Use</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/usb2#pinephone--nuttx--feature-phone"><strong>‚ÄúPinePhone + NuttX = Feature Phone‚Äù</strong></a></li>
</ul>
<p><em>What if there‚Äôs no LTE Network Coverage? Like in a Natural Disaster?</em></p>
<p>The Long-Range, Low-Power <a href="https://makezine.com/article/technology/go-long-with-lora-radio/"><strong>LoRa Network</strong></a> might be good for search and rescue communications.</p>
<p>(Short Text Messages only plus GPS Geolocation, non-guaranteed message delivery)</p>
<p>To turn PinePhone into a <strong>LoRa Communicator</strong>, just attach the LoRa Add-On Case to PinePhone (pic above)‚Ä¶</p>
<ul>
<li>
<p><a href="https://pine64.com/product/pinephone-pinephone-pro-pindio-lora-add-on-case/"><strong>Pine64 PineDio LoRa Add-On Case</strong></a></p>
<p>(Still in stock!)</p>
</li>
</ul>
<p>We might use JF‚Äôs LoRa Driver (which handles the <strong>I2C-to-SPI Bridge</strong>)‚Ä¶</p>
<ul>
<li><a href="https://codeberg.org/JF002/pinedio-lora-driver"><strong>JF002/pinedio-lora-driver</strong></a></li>
</ul>
<p>Or the LoRa Driver that we‚Äôve ported to NuttX‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/sx1262"><strong>‚ÄúLoRa SX1262 on Apache NuttX RTOS‚Äù</strong></a></li>
</ul>
<p>Or maybe <strong>Meshtastic</strong>, since it has a complete <strong>LoRa Mesh Messaging App</strong>‚Ä¶</p>
<ul>
<li><a href="https://meshtastic.org/"><strong>Meshtastic LoRa Mesh Network</strong></a></li>
</ul>
<p>Meshtastic was built with Arduino (C++). To compile it on NuttX we could use the <strong>Portduino Library</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/geeksville/framework-portduino"><strong>Portduino Arduino Adapter for Linux</strong></a></li>
</ul>

    
</body>
</html>