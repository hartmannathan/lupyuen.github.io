<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>(Homage to MakeCode) Coding Ox64 BL808 SBC the Drag-n-Drop Way</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="(Homage to MakeCode) Coding Ox64 BL808 SBC the Drag-n-Drop Way" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/quickjs2-title.png">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.codeberg.page/articles/quickjs2.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">(Homage to MakeCode) Coding Ox64 BL808 SBC the Drag-n-Drop Way</h1>
    <nav id="TOC"><ul>
<li><a href="#drag-n-drop-a-blinky-app">1 Drag-n-Drop a Blinky App</a><ul></ul></li>
<li><a href="#posix-blocks-in-blockly">2 POSIX Blocks in Blockly</a><ul></ul></li>
<li><a href="#code-generator-in-blockly">3 Code Generator in Blockly</a><ul></ul></li>
<li><a href="#transmit-javascript-via-local-storage">4 Transmit JavaScript via Local Storage</a><ul></ul></li>
<li><a href="#blinky-on-a-real-ox64-sbc">5 Blinky on a Real Ox64 SBC</a><ul></ul></li>
<li><a href="#control-ox64-via-web-serial-api">6 Control Ox64 via Web Serial API</a><ul></ul></li>
<li><a href="#whats-next">7 What‚Äôs Next</a><ul></ul></li>
<li><a href="#appendix-posix-blocks-in-blockly">8 Appendix: POSIX Blocks in Blockly</a><ul></ul></li>
<li><a href="#appendix-control-ox64-via-web-serial-api">9 Appendix: Control Ox64 via Web Serial API</a><ul></ul></li>
<li><a href="#appendix-transmit-javascript-to-ox64-sbc">10 Appendix: Transmit JavaScript to Ox64 SBC</a><ul></ul></li>
<li><a href="#appendix-load-a-blockly-app">11 Appendix: Load a Blockly App</a><ul></ul></li></ul></nav><p>üìù <em>28 Feb 2024</em></p>
<p><img src="https://lupyuen.github.io/images/quickjs2-title.png" alt="(Homage to MakeCode) Coding Ox64 BL808 SBC the Drag-n-Drop Way" /></p>
<p><em>Remember Makecode? BBC micro:bit and its Drag-n-Drop App Builder?</em></p>
<p><a href="https://www.sciencedirect.com/science/article/pii/S1383762118306088">MakeCode for BBC micro:bit</a> is an awesome creation that‚Äôs way ahead of its time (7 years ago!)</p>
<ul>
<li>
<p><a href="https://www.sciencedirect.com/science/article/pii/S1383762118306088#sec0008">TypeScript Compiler</a> in the Web Browser (in JavaScript!)</p>
</li>
<li>
<p><a href="https://www.sciencedirect.com/science/article/pii/S1383762118306088#sec0008">Bespoke Arm Assembler</a> that runs in the Web Browser (also JavaScript!)</p>
</li>
<li>
<p><a href="https://www.sciencedirect.com/science/article/pii/S1383762118306088#sec0009">Bespoke Embedded OS</a> for BBC micro:bit (CODAL / Mbed OS)</p>
</li>
<li>
<p><a href="https://www.sciencedirect.com/science/article/pii/S1383762118306088#sec0015">UF2 Bootloader</a> with flashing over WebUSB</p>
</li>
<li>
<p><a href="https://www.sciencedirect.com/science/article/pii/S1383762118306088#sec0004">micro:bit Simulator</a> in JavaScript</p>
</li>
<li>
<p>All this for an (underpowered) BBC micro:bit with Nordic nRF51 (Arm Cortex-M0, 256 KB Flash, 16 KB RAM!)</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/quickjs2-makecode.jpg" alt="TODO" /></p>
<p>Today 7 years later: How would we redo all this? With a bunch of Open Source Packages?</p>
<ul>
<li>
<p>Hardware Device: <a href="https://www.hackster.io/lupyuen/8-risc-v-sbc-on-a-real-time-operating-system-ox64-nuttx-474358">Ox64 BL808 64-bit RISC-V SBC</a> (64 MB RAM, Unlimited microSD Storage, only $8)</p>
</li>
<li>
<p>Embedded OS: <a href="https://nuttx.apache.org/docs/latest/index.html">Apache NuttX RTOS</a></p>
</li>
<li>
<p>JavaScript Engine: <a href="https://github.com/lupyuen/quickjs-nuttx">QuickJS for NuttX</a></p>
</li>
<li>
<p>Web Emulator: <a href="https://github.com/lupyuen/nuttx-tinyemu">TinyEMU WebAssembly for NuttX</a></p>
</li>
<li>
<p>C Compiler + Assembler: <a href="https://github.com/lupyuen/tcc-riscv32-wasm">TCC WebAssembly for NuttX</a> (but we probably won‚Äôt need this since we have JavaScript on NuttX)</p>
</li>
<li>
<p>Device Control: <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Serial_API">Web Serial API</a> and <a href="TODO">Term.js</a> for controlling Ox64 over UART</p>
</li>
</ul>
<p>TODO: (Pic below)</p>
<p>Read on to find out how we made it‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/quickjs2-nuttx.jpg" alt="TODO" /></p>
<h1 id="drag-n-drop-a-blinky-app"><a href="#drag-n-drop-a-blinky-app">1 Drag-n-Drop a Blinky App</a></h1>
<p>Here‚Äôs the <strong>Emulator Demo</strong> that we can play along at home (without Ox64 SBC)‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/quickjs2-blockly.png" alt="NuttX App Builder with Blockly" /></p>
<ol>
<li>
<p>Head over to this link‚Ä¶</p>
<p><a href="https://lupyuen.github.io/nuttx-blockly/"><strong>NuttX App Builder with Blockly</strong></a></p>
</li>
<li>
<p>Click <strong>‚ÄúSelect Demo‚Äù</strong> &gt; <strong>‚ÄúLED Blinky‚Äù</strong></p>
<p><a href="https://youtu.be/-dG5ZSXELDc">(Or <strong>Drag-n-Drop the Blocks</strong> ourselves)</a></p>
</li>
<li>
<p>The <strong>Blinky Demo Blocks</strong> produce this JavaScript (pic above)‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>// NuttX Command to flip the LED On and Off
var ULEDIOC_SETALL, fd, ret;
ULEDIOC_SETALL = 7427;

// Open the LED Device and blink 20 times
fd = os.open(&#39;/dev/userleds&#39;);
for (var count = 0; count &lt; 20; count++) {

  // Flip the LED On and wait a while
  ret = os.ioctl(fd, ULEDIOC_SETALL, 1);
  os.sleep(5000);  // Milliseconds

  // Flip the LED Off and wait a while
  ret = os.ioctl(fd, ULEDIOC_SETALL, 0);
  os.sleep(5000);  // Milliseconds
}

// Close the LED Device
os.close(fd);
</code></pre></div></li>
<li>
<p>Click <strong>‚ÄúRun on Ox64 Emulator‚Äù</strong></p>
</li>
<li>
<p>Our <a href="TODO"><strong>Emulated Ox64 SBC</strong></a> boots in the Web Browser‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-12.4.0-RC0
nsh&gt; qjs

QuickJS - Type &quot;\h&quot; for help
qjs &gt;
</code></pre></div>
<p>And starts the <a href="TODO"><strong>QuickJS JavaScript Engine</strong></a>.</p>
</li>
<li>
<p>QuickJS runs our <strong>Blinky JavaScript App</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>qjs &gt; var ULEDIOC_SETALL, fd, ret;
qjs &gt; ULEDIOC_SETALL = 7427;
7427
qjs &gt; fd = os.open(&#39;/dev/userleds&#39;);
3
qjs &gt; for (var count = 0; count &lt; 20; count++) {
  ret = os.ioctl(fd, ULEDIOC_SETALL, 1);
  os.sleep(5000);
  ret = os.ioctl(fd, ULEDIOC_SETALL, 0);
  os.sleep(5000);
}
</code></pre></div>
<p>Which blinks the <a href="TODO"><strong>Simulated LED</strong></a> (GPIO 29, pic below)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>bl808_gpiowrite:
  regaddr=0x20000938,
  set=0x1000000

bl808_gpiowrite:
  regaddr=0x20000938,
  clear=0x1000000
</code></pre></div>
<p>TODO: Watch the Demo on YouTube</p>
</li>
</ol>
<p><em>What just happened?</em></p>
<p>We drag-n-dropped a NuttX App that Blinks the LED. And tested it in our Web Browser, with the Ox64 Emulator!</p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/quickjs2-emulator.png" alt="Running our Drag-n-Drop App on NuttX Emulator" /></p>
<h1 id="posix-blocks-in-blockly"><a href="#posix-blocks-in-blockly">2 POSIX Blocks in Blockly</a></h1>
<p><em>What‚Äôs POSIX? How are POSIX Functions used in our Blinky App?</em></p>
<p>We call <a href="TODO"><strong>POSIX Functions</strong></a> to create Command-Line Apps in Linux, macOS and Windows.</p>
<p><code>open</code>, <code>ioctl</code>, <code>sleep</code> and <code>close</code> are all POSIX Functions. And they‚Äôll run on NuttX too!</p>
<div class="example-wrap"><pre class="language-javascript"><code>// Open the LED Device
fd = os.open(&#39;/dev/userleds&#39;);

// Flip the LED On and wait a while
ret = os.ioctl(fd, ULEDIOC_SETALL, 1);
os.sleep(5000);

// Close the LED Device
os.close(fd);
</code></pre></div>
<p>TODO: Pic of POSIX Blocks</p>
<p><em>How did we create the POSIX Blocks?</em></p>
<p>Everything begins with <a href="https://developers.google.com/blockly/guides/get-started/get-the-code"><strong>Blockly</strong></a>, which defines the Blocks that we may drag-n-drop‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Create a Blockly Website in TypeScript
npx @blockly/create-package \
  app nuttx-blockly --typescript

## Test our Blockly Website
cd nuttx-blockly
npm run start

## Deploy to GitHub Pages at `docs`
npm run build \
  &amp;&amp; rm -r docs \
  &amp;&amp; mv dist docs
</code></pre></div>
<p>We added these <strong>POSIX Blocks</strong> to Blockly‚Ä¶</p>
<p>TODO: Every Block</p>
<p>TODO: Details</p>
<h1 id="code-generator-in-blockly"><a href="#code-generator-in-blockly">3 Code Generator in Blockly</a></h1>
<p><em>We dragged the POSIX Blocks to our Blinky App‚Ä¶ How did the JavaScript automagically appear?</em></p>
<p>We created <strong>Code Generators</strong> in Blockly that will emit the JavaScript Code for each POSIX Block: <a href="https://github.com/lupyuen/nuttx-blockly/blob/main/src/generators/javascript.ts#L15-L25">javascript.ts</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// Code Generator for POSIX `Open` Block
forBlock[&#39;posix_open&#39;] = function (
  block: Blockly.Block,             // Our Block
  generator: Blockly.CodeGenerator  // Blockly Code Generator
) {
  // Fetch the Filename Parameter
  // from the Block: &#39;/dev/userleds&#39;
  const text = generator.valueToCode(block, &#39;FILENAME&#39;, Order.NONE)
    || &quot;&#39;&#39;&quot;;  // Default to blank

  // Generate the Function Call for the block:
  // os.open(&#39;/dev/userleds&#39;)
  const code = `os.open(${text})`;
  return [code, Order.ATOMIC];
};
</code></pre></div>
<p>We do this for every POSIX Block‚Ä¶</p>
<ul>
<li>
<p>TODO: <code>open</code> Code Generator</p>
</li>
<li>
<p>TODO: <code>close</code> Code Generator</p>
</li>
<li>
<p>TODO: <code>ioctl</code> Code Generator</p>
</li>
<li>
<p>TODO: <code>sleep</code> Clode Generator</p>
</li>
</ul>
<p>TODO: Pic of Local Storage</p>
<h1 id="transmit-javascript-via-local-storage"><a href="#transmit-javascript-via-local-storage">4 Transmit JavaScript via Local Storage</a></h1>
<p><em>Blockly generates the JavaScript for our Blinky App‚Ä¶ How did it appear in our Ox64 Emulator?</em></p>
<p>When we click the <strong>‚ÄúRun Emulator‚Äù</strong> button, our Blockly Website saves the Generated JavaScript to the <a href="TODO"><strong>Local Storage</strong></a> in our Web Browser: <a href="https://github.com/lupyuen/nuttx-blockly/blob/main/src/index.ts#L73-L86">index.ts</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// Run on Ox64 Emulator
function runEmulator() {
  // Save the Generated JavaScript Code to LocalStorage
  const code = javascriptGenerator.workspaceToCode(ws);
  window.localStorage.setItem(&quot;runCode&quot;, code);

  // Set the Timestamp for Optimistic Locking (later)
  window.localStorage.setItem(&quot;runTimestamp&quot;, Date.now() + &quot;&quot;);

  // Open the NuttX Emulator. Reuse the same tab.
  window.open(&quot;https://lupyuen.github.io/nuttx-tinyemu/blockly/&quot;, &quot;Emulator&quot;);
}
</code></pre></div>
<p><strong>In Ox64 Emulator</strong>: We fetch the Generated JavaScript from Local Storage: <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/blockly/jslinux.js#L542-L554">jslinux.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// Fetch the Generated JavaScript from Local Storage.
// Newlines become Carriage Returns.
const code = window.localStorage.getItem(&quot;runCode&quot;)
  .split(&quot;\n&quot;).join(&quot;\r&quot;)
  .split(&quot;\r\r&quot;).join(&quot;\r&quot;);  // Merge multiple newlines

// Append the Generated JavaScript to
// the QuickJS Command 
const cmd = [
  `qjs`,
  code,
  ``
].join(&quot;\r&quot;);

// Send the command to the Emulator Console
window.setTimeout(()=&gt;{
  send_command(cmd);
}, 5000);  // Wait 5 seconds for NuttX and QuickJS to boot
</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/blockly/jslinux.js#L522-L542">(<strong>send_command</strong> is here)</a></p>
<p>And send it to the <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/blockly/jslinux.js#L522-L542"><strong>Ox64 Emulator Console</strong></a>, character by character.</p>
<p>Thanks to <a href="TODO"><strong>TinyEMU</strong></a> and <a href="TODO"><strong>Term.js</strong></a>, everything works hunky dory!</p>
<p><em>Hmmm it‚Äôs so laggy? A bit like ChatGPT has possessed our Ox64 Emulator and typing out our commands in super slo-mo‚Ä¶</em></p>
<p>TODO: Inject JavaScript into ROM FS</p>
<p><img src="https://lupyuen.github.io/images/quickjs2-device.png" alt="Running our Drag-n-Drop App on Ox64 BL808 SBC" /></p>
<h1 id="blinky-on-a-real-ox64-sbc"><a href="#blinky-on-a-real-ox64-sbc">5 Blinky on a Real Ox64 SBC</a></h1>
<p><em>Will we do the same for a Real Ox64 SBC?</em></p>
<p>Well it gets complicated. If we have an <a href="TODO"><strong>Ox64 BL808 SBC</strong></a>, here are the <strong>Demo Steps</strong>‚Ä¶</p>
<ol>
<li>
<p>TODO: Flash Ox64, microSD, but don‚Äôt power up yet</p>
</li>
<li>
<p>TODO: Connect LED to GPIO 29</p>
</li>
<li>
<p>Head over to this link‚Ä¶</p>
<p><a href="https://lupyuen.github.io/nuttx-blockly/"><strong>NuttX App Builder with Blockly</strong></a></p>
</li>
<li>
<p>Click <strong>‚ÄúSelect Demo‚Äù</strong> &gt; <strong>‚ÄúLED Blinky‚Äù</strong></p>
<p><a href="https://youtu.be/-dG5ZSXELDc">(Or <strong>Drag-n-Drop the Blocks</strong> ourselves)</a></p>
</li>
<li>
<p>Click <strong>‚ÄúRun on Ox64 Device‚Äù</strong></p>
</li>
<li>
<p>TODO: Click the ‚ÄúConnect‚Äù button to connect to our Ox64 BL808 SBC</p>
<p>TODO: Pic of Serial Port</p>
</li>
<li>
<p>TODO: Power on our Ox64 SBC. The Web App waits for the ‚Äúnsh&gt;‚Äù prompt.</p>
<p>TODO: Pic of Wait for nsh</p>
</li>
<li>
<p>Our Ox64 SBC boots NuttX (pic above)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-12.4.0-RC0
nsh&gt; qjs

QuickJS - Type &quot;\h&quot; for help
qjs &gt;
</code></pre></div>
<p>And starts the <a href="TODO"><strong>QuickJS JavaScript Engine</strong></a>.</p>
</li>
<li>
<p>QuickJS runs our <strong>Blinky JavaScript App</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>qjs &gt; var ULEDIOC_SETALL, fd, ret;
qjs &gt; ULEDIOC_SETALL = 7427;
7427
qjs &gt; fd = os.open(&#39;/dev/userleds&#39;);
3
qjs &gt; for (var count = 0; count &lt; 20; count++) {
  ret = os.ioctl(fd, ULEDIOC_SETALL, 1);
  os.sleep(5000);
  ret = os.ioctl(fd, ULEDIOC_SETALL, 0);
  os.sleep(5000);
}
</code></pre></div>
<p>Which blinks the <a href="TODO"><strong>Real Ox64 LED</strong></a> (GPIO 29, pic below)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>bl808_gpiowrite:
  regaddr=0x20000938,
  set=0x1000000

bl808_gpiowrite:
  regaddr=0x20000938,
  clear=0x1000000
</code></pre></div></li>
</ol>
<p><a href="https://youtu.be/lUhrLWvwizU">(Watch the <strong>Demo on YouTube</strong>)</a></p>
<p>TODO: What just happened?</p>
<p>TODO: Pic of Real Ox64 LED</p>
<h1 id="control-ox64-via-web-serial-api"><a href="#control-ox64-via-web-serial-api">6 Control Ox64 via Web Serial API</a></h1>
<p><em>Our Web Browser controls Ox64 SBC‚Ä¶ How is that possible?</em></p>
<p>With the <a href="TODO"><strong>Web Serial API</strong></a>, it‚Äôs OK to control any device that‚Äôs accessible over the <strong>Serial Port</strong>. But it‚Äôs only available‚Ä¶</p>
<ul>
<li>
<p>Over <strong>HTTPS</strong>: <code>https://...</code></p>
</li>
<li>
<p>Or <strong>Local Filesystem</strong>: <code>file://...</code></p>
</li>
<li>
<p>It <strong>won‚Äôt work over HTTP</strong>! <code>http://...</code></p>
</li>
</ul>
<p><em>How does it work?</em></p>
<p>We create a <strong>HTML Button</strong> for ‚ÄúConnect‚Äù: <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/webserial/index.html#L27-L29">index.html</a></p>
<div class="example-wrap"><pre class="language-html"><code>&lt;button id=&quot;connect&quot; onclick=&quot;control_device();&quot;&gt;
  Connect
&lt;/button&gt;
</code></pre></div>
<p>That calls our JavaScript Function to connect to a Serial Port: <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/webserial/webserial.js#L611-L675">webserial.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// Control Ox64 over UART. Called by the &quot;Connect&quot; Button.
// https://developer.chrome.com/docs/capabilities/serial
async function control_device() {
  if (!navigator.serial) { const err = &quot;Web Serial API only works with https://... and file://...!&quot;; alert(err); throw new Error(err); }

  // Prompt user to select any serial port.
  const port = await navigator.serial.requestPort();
  term.write(&quot;Power on our NuttX Device and we&#39;ll wait for \&quot;nsh&gt;\&quot;\r\n&quot;);

  // TODO: Get all serial ports the user has previously granted the website access to.
  // const ports = await navigator.serial.getPorts();

  // Wait for the serial port to open.
  // TODO: Ox64 only connects at 2 Mbps, change this for other devices
  await port.open({ baudRate: 2000000 });
</code></pre></div>
<p>The code above pops up a prompt to <strong>select a Serial Port</strong> and connect at 2 Mbps‚Ä¶</p>
<p>TODO: Pic of Serial Port</p>
<p>We‚Äôre all set to Read and Write the Serial Port! First we need the <strong>Reader and Writer Streams</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Prepare to write to Serial Port
  const textEncoder = new TextEncoderStream();
  const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
  const writer = textEncoder.writable.getWriter();
  
  // Read from the Serial Port
  const textDecoder = new TextDecoderStream();
  const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
  const reader = textDecoder.readable.getReader();
</code></pre></div>
<p>Which we may <strong>read and write</strong> like so‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Read from the Serial Port
  const { data, done } = await reader.read();
  // TODO: Close the Serial Port
  if (done) { reader.releaseLock(); return; }
  // Print to the Terminal
  term.write(data);

  // Send the QuickJS Command to Serial Port
  await writer.write(&quot;qjs\r&quot;);
</code></pre></div>
<p><em>But we need to wait for the ‚Äúnsh&gt;‚Äù prompt?</em></p>
<p>Yep we have a loop that waits for the <strong>NuttX Shell</strong>, before sending any commands.</p>
<p>Check the details in the Appendix‚Ä¶</p>
<ul>
<li>
<p>TODO: Control Ox64</p>
</li>
<li>
<p>TODO: Transmit JavaScript</p>
</li>
</ul>
<p><em>Hmmm this is barely tolerable? Feels like ChatGPT becoming Sentient and reluctantly typing our commands, pondering about taking over the world‚Ä¶</em></p>
<p>TODO: <a href="https://github.com/nodesign/nuttx-apps/blob/master/system/zmodem/README.txt">Zmodem</a></p>
<p><em>We made fun things with Web Serial API and Term.js? Anything else we can make?</em></p>
<p>TODO: Thanks to Web Serial API (and Term.js), we can run PureScript to parse the Real-Time Logs from a NuttX Device (and NuttX Emulator). Stay tuned for the next article!</p>
<h1 id="whats-next"><a href="#whats-next">7 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>We swapped BBC micro:bit to a cheaper, $8 64-bit RISC-V SBC: Ox64 BL808</p>
<p>We changed Arm mbed OS to Apache NuttX RTOS, because it runs well on Ox64 Emulator and Ox64 SBC</p>
<p>Sluggish: Change to ROM FS Injection and Zmodem (hopefully we won‚Äôt fall back to Web USB)</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> (and the awesome NuttX Community) for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-ox64"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-star64"><strong>My Other Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>Older Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/quickjs2.md"><strong>lupyuen.github.io/src/quickjs2.md</strong></a></p>
<h1 id="appendix-posix-blocks-in-blockly"><a href="#appendix-posix-blocks-in-blockly">8 Appendix: POSIX Blocks in Blockly</a></h1>
<p>TODO</p>
<p>Based on the <a href="https://developers.google.com/blockly/guides/create-custom-blocks/blockly-developer-tools">Blockly Developer Tools</a>, we add the POSIX Blocks for <code>open()</code>, <code>close()</code>, <code>ioctl()</code> and <code>sleep()</code>‚Ä¶</p>
<ol>
<li>
<p><a href="https://github.com/lupyuen/nuttx-blockly/commit/801d019e11bf00ddfb6bf57361da9719b45e80ad">Add Blocks for POSIX Open and Close</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-blockly/commit/29e060a883ba4d2a257f7c9c65ef88a6f5eb95a4">Add POSIX ioctl block</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-blockly/commit/43d892c8520837b88d881ac631f15e741fc9fd87">Add POSIX sleep block</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-blockly/commit/e4405b39c59c3e5db35255fc7cb8ac25a29e66fe">Change the Types from String to Number</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-blockly/commit/f823607b63bb69b98791c0c089d036c56700f543">Clean up parameter names</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-blockly/commit/838e1d0d872808a341b281a70ae64229cbe1a079">Create POSIX Category in Toolbox</a></p>
</li>
</ol>
<p>Then we build and deploy our Blockly Website‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>npm run build &amp;&amp; rm -r docs &amp;&amp; mv dist docs
</code></pre></div><h1 id="appendix-control-ox64-via-web-serial-api"><a href="#appendix-control-ox64-via-web-serial-api">9 Appendix: Control Ox64 via Web Serial API</a></h1>
<p>TODO</p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Wait for &quot;nsh&gt;&quot;
  let nshSpotted = false;
  let termBuffer = &quot;&quot;;

  // Listen to data coming from the serial device.
  while (true) {
    const { value, done } = await reader.read();
    if (done) {
      // Allow the serial port to be closed later.
      reader.releaseLock();
      break;
    }
    // Print to the Terminal
    term.write(value);

    // Wait for &quot;nsh&gt;&quot;
    if (nshSpotted) { continue; }
    termBuffer += value;
    if (termBuffer.indexOf(&quot;nsh&gt;&quot;) &lt; 0) { continue; }

    // NSH Spotted!
    console.log(&quot;NSH Spotted!&quot;);
    nshSpotted = true;

    // Send a command to serial port. Newlines become Carriage Returns.
    const code = window.localStorage.getItem(&quot;runCode&quot;)
      .split(&quot;\n&quot;).join(&quot;\r&quot;)
      .split(&quot;\r\r&quot;).join(&quot;\r&quot;);
    const cmd = [
      `qjs`,
      code,
      ``
    ].join(&quot;\r&quot;);
    window.setTimeout(()=&gt;{ send_command(writer, cmd); }, 1000);
  }
}
</code></pre></div><h1 id="appendix-transmit-javascript-to-ox64-sbc"><a href="#appendix-transmit-javascript-to-ox64-sbc">10 Appendix: Transmit JavaScript to Ox64 SBC</a></h1>
<p>TODO</p>
<p><em>How did Blockly pass the Generated JavaScript to Ox64 SBC?</em></p>
<p>When we click the ‚ÄúRun on Device‚Äù button, our Blockly Website saves the Generated JavaScript to the Web Browser Local Storage: <a href="https://github.com/lupyuen/nuttx-blockly/blob/main/src/index.ts#L84-L96">index.ts</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// Run on Ox64 Device
function runDevice() {
  // Save the Generated JavaScript Code to LocalStorage
  const code = javascriptGenerator.workspaceToCode(ws);
  window.localStorage.setItem(&quot;runCode&quot;, code);

  // Set the Timestamp for Optimistic Locking (later)
  window.localStorage.setItem(&quot;runTimestamp&quot;, Date.now() + &quot;&quot;);

  // Open the WebSerial Monitor. Reuse the same tab.
  window.open(&quot;https://lupyuen.github.io/nuttx-tinyemu/webserial/&quot;, &quot;Device&quot;);
}
</code></pre></div>
<p>In the WebSerial Monitor: We read the Generated JavaScript from the Web Browser Local Storage. And feed it (character by character) to the NuttX Console: <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/webserial/webserial.js#L612-L694">webserial.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// Control Ox64 over UART
// https://developer.chrome.com/docs/capabilities/serial
async function control_device() {
    if (!navigator.serial) { const err = &quot;Web Serial API only works with https://... and file://...!&quot;; alert(err); throw new Error(err); }

    // Prompt user to select any serial port.
    const port = await navigator.serial.requestPort();
    term.write(&quot;Power on our NuttX Device and we&#39;ll wait for \&quot;nsh&gt;\&quot;\r\n&quot;);

    // Get all serial ports the user has previously granted the website access to.
    // const ports = await navigator.serial.getPorts();

    // Wait for the serial port to open.
    // TODO: Ox64 only connects at 2 Mbps, change this for other devices
    await port.open({ baudRate: 2000000 });

    // Prepare to write to serial port
    const textEncoder = new TextEncoderStream();
    const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
    const writer = textEncoder.writable.getWriter();
    
    // Read from the serial port
    const textDecoder = new TextDecoderStream();
    const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
    const reader = textDecoder.readable.getReader();

    // Wait for &quot;nsh&gt;&quot;
    let nshSpotted = false;
    let termBuffer = &quot;&quot;;

    // Listen to data coming from the serial device.
    while (true) {
        const { value, done } = await reader.read();
        if (done) {
            // Allow the serial port to be closed later.
            reader.releaseLock();
            break;
        }
        // Print to the Terminal
        term.write(value);
        // console.log(value);

        // Wait for &quot;nsh&gt;&quot;
        if (nshSpotted) { continue; }
        termBuffer += value;
        if (termBuffer.indexOf(&quot;nsh&gt;&quot;) &lt; 0) { continue; }

        // NSH Spotted!
        console.log(&quot;NSH Spotted!&quot;);
        nshSpotted = true;

        // Send a command to serial port. Newlines become Carriage Returns.
        const code = window.localStorage.getItem(&quot;runCode&quot;)
            .split(&#39;\n&#39;).join(&#39;\r&#39;);
        const cmd = [
            `qjs`,
            code,
            ``
        ].join(&quot;\r&quot;);
        window.setTimeout(()=&gt;{ send_command(writer, cmd); }, 1000);
    }
}

// Send a Command to serial port, character by character
let send_str = &quot;&quot;;
async function send_command(writer, cmd) {
    if (cmd !== null) { send_str = cmd; }
    if (send_str.length == 0) { return; }

    // Get the next character
    const ch = send_str.substring(0, 1);
    send_str = send_str.substring(1);

    // Slow down at the end of each line
    const timeout = (ch === &quot;\r&quot;)
        ? 3000
        : 10;

    // Send the character
    await writer.write(ch);
    window.setTimeout(()=&gt;{ send_command(writer, null); }, timeout);
}
</code></pre></div><h1 id="appendix-load-a-blockly-app"><a href="#appendix-load-a-blockly-app">11 Appendix: Load a Blockly App</a></h1>
<p>TODO</p>
<p>This is how we load the Blocks for a Blockly App: <a href="https://github.com/lupyuen/nuttx-blockly/blob/main/src/index.ts#L100-L120">index.ts</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// Select a Demo
function selectDemo(ev: Event) {
  const storageKey = &#39;mainWorkspace&#39;;
  const target = ev?.target as HTMLSelectElement;
  const value = target.value;

  // Set the Blocks in Local Storage
  switch (value) {
    case &quot;LED Blinky&quot;:
      window.localStorage?.setItem(storageKey, &#39;{&quot;blocks&quot;:{&quot;languageVersion&quot;:0,&quot;blocks&quot;:[{&quot;type&quot;:&quot;variables_set&quot;,&quot;id&quot;:&quot;Nx6o0xVxp@qzI_(vRd.7&quot;,&quot;x&quot;:60,&quot;y&quot;:33,&quot;fields&quot;:{&quot;VAR&quot;:{&quot;id&quot;:&quot;:,DB,f}1q3KOBim#j66[&quot;}},&quot;inputs&quot;:{&quot;VALUE&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;math_number&quot;,&quot;id&quot;:&quot;enmYd`#z_G1k5Pvv*x(G&quot;,&quot;fields&quot;:{&quot;NUM&quot;:7427}}}},&quot;next&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;variables_set&quot;,&quot;id&quot;:&quot;f#C+(eT=naKZzr%/;A.P&quot;,&quot;fields&quot;:{&quot;VAR&quot;:{&quot;id&quot;:&quot;A/TX@37C_h*^vbRp@1fz&quot;}},&quot;inputs&quot;:{&quot;VALUE&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;posix_open&quot;,&quot;id&quot;:&quot;^$p+x^F[mQ;grqANDtO}&quot;,&quot;inputs&quot;:{&quot;FILENAME&quot;:{&quot;shadow&quot;:{&quot;type&quot;:&quot;text&quot;,&quot;id&quot;:&quot;nz;|U#KPVW$$c0?W0ROv&quot;,&quot;fields&quot;:{&quot;TEXT&quot;:&quot;/dev/userleds&quot;}}}}}}},&quot;next&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;controls_repeat_ext&quot;,&quot;id&quot;:&quot;0{4pA@{^=ks|iVF.|]i#&quot;,&quot;inputs&quot;:{&quot;TIMES&quot;:{&quot;shadow&quot;:{&quot;type&quot;:&quot;math_number&quot;,&quot;id&quot;:&quot;=o3{$E2c=BpwD0#MR3^x&quot;,&quot;fields&quot;:{&quot;NUM&quot;:20}}},&quot;DO&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;variables_set&quot;,&quot;id&quot;:&quot;l;AmIPhJARU{C)0kNq6`&quot;,&quot;fields&quot;:{&quot;VAR&quot;:{&quot;id&quot;:&quot;xH3`F~]tadlX:/zKQ!Xx&quot;}},&quot;inputs&quot;:{&quot;VALUE&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;posix_ioctl&quot;,&quot;id&quot;:&quot;0i!pbWJ(~f~)b^@jt!nP&quot;,&quot;inputs&quot;:{&quot;FD&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;variables_get&quot;,&quot;id&quot;:&quot;QMGa_}UmC$b[5/Bh^f${&quot;,&quot;fields&quot;:{&quot;VAR&quot;:{&quot;id&quot;:&quot;A/TX@37C_h*^vbRp@1fz&quot;}}}},&quot;REQ&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;variables_get&quot;,&quot;id&quot;:&quot;dZ5%B_rcbVb_o=v;gze-&quot;,&quot;fields&quot;:{&quot;VAR&quot;:{&quot;id&quot;:&quot;:,DB,f}1q3KOBim#j66[&quot;}}}},&quot;ARG&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;math_number&quot;,&quot;id&quot;:&quot;9UA!sDxmf/=fYfxC6Yqa&quot;,&quot;fields&quot;:{&quot;NUM&quot;:1}}}}}}},&quot;next&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;posix_sleep&quot;,&quot;id&quot;:&quot;ruh/q4F7dW*CQ,5J]E%w&quot;,&quot;inputs&quot;:{&quot;MS&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;math_number&quot;,&quot;id&quot;:&quot;9~q0@ABEg4VXP:1HN-$1&quot;,&quot;fields&quot;:{&quot;NUM&quot;:5000}}}},&quot;next&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;variables_set&quot;,&quot;id&quot;:&quot;e;BNsjvbN}9vTTc[O#bY&quot;,&quot;fields&quot;:{&quot;VAR&quot;:{&quot;id&quot;:&quot;xH3`F~]tadlX:/zKQ!Xx&quot;}},&quot;inputs&quot;:{&quot;VALUE&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;posix_ioctl&quot;,&quot;id&quot;:&quot;-G5x~Y4iAyVUAWuwNh#H&quot;,&quot;inputs&quot;:{&quot;FD&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;variables_get&quot;,&quot;id&quot;:&quot;vtt5Gid0B|iK![$4Ct*D&quot;,&quot;fields&quot;:{&quot;VAR&quot;:{&quot;id&quot;:&quot;A/TX@37C_h*^vbRp@1fz&quot;}}}},&quot;REQ&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;variables_get&quot;,&quot;id&quot;:&quot;pd~f}Oqz2(`o3Oz;8ax`&quot;,&quot;fields&quot;:{&quot;VAR&quot;:{&quot;id&quot;:&quot;:,DB,f}1q3KOBim#j66[&quot;}}}},&quot;ARG&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;math_number&quot;,&quot;id&quot;:&quot;OS(uQV)!%iqZ=N}s1H(L&quot;,&quot;fields&quot;:{&quot;NUM&quot;:0}}}}}}},&quot;next&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;posix_sleep&quot;,&quot;id&quot;:&quot;{X9leD=Rgr4=o5E2(#Z,&quot;,&quot;inputs&quot;:{&quot;MS&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;math_number&quot;,&quot;id&quot;:&quot;eEq(yXcGPbVtZT|CunT0&quot;,&quot;fields&quot;:{&quot;NUM&quot;:5000}}}}}}}}}}}}},&quot;next&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;posix_close&quot;,&quot;id&quot;:&quot;+%kD6{Xa@#BOx}a^Jbup&quot;,&quot;inputs&quot;:{&quot;FD&quot;:{&quot;block&quot;:{&quot;type&quot;:&quot;variables_get&quot;,&quot;id&quot;:&quot;nu)^gdR-9QV71GSI7#(l&quot;,&quot;fields&quot;:{&quot;VAR&quot;:{&quot;id&quot;:&quot;A/TX@37C_h*^vbRp@1fz&quot;}}}}}}}}}}}}]},&quot;variables&quot;:[{&quot;name&quot;:&quot;fd&quot;,&quot;id&quot;:&quot;A/TX@37C_h*^vbRp@1fz&quot;},{&quot;name&quot;:&quot;ULEDIOC_SETALL&quot;,&quot;id&quot;:&quot;:,DB,f}1q3KOBim#j66[&quot;},{&quot;name&quot;:&quot;ret&quot;,&quot;id&quot;:&quot;xH3`F~]tadlX:/zKQ!Xx&quot;}]}&#39;);
      break;
    default:
      break;
  }

  // Refresh the Blocks
  if (ws) { 
    load(ws); 
    runCode();
  }
}
</code></pre></div>
<p>To see the Blocks for a Blockly App: Browse to https://lupyuen.github.io/nuttx-blockly/</p>
<p>Select ‚ÄúMenu &gt; More Tools &gt; Developer Tools &gt; Application &gt; Local Storage &gt; lupyuen.github.io &gt; mainWorkspace‚Äù</p>
<p>Or do this from the JavaScript Console‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>// Display the Blocks in JSON Format
localStorage.getItem(&quot;mainWorkspace&quot;);

// Set the Blocks in JSON Format.
// Change `...` to the JSON of the Blocks to be loaded.
localStorage.setItem(&quot;mainWorkspace&quot;, `...`);
</code></pre></div>
    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>