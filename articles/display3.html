<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>RISC-V Star64 JH7110: Power Up the Display Controller with U-Boot Bootloader</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="RISC-V Star64 JH7110: Power Up the Display Controller with U-Boot Bootloader" 
    data-rh="true">
<meta property="og:description" 
    content="Let's power up the DC8200 Display Controller inside Star64 JH7110 RISC-V Single-Board Computer... By running MD and MW Commands in U-Boot Bootloader"
    data-rh="true">
<meta name="description" 
    content="Let's power up the DC8200 Display Controller inside Star64 JH7110 RISC-V Single-Board Computer... By running MD and MW Commands in U-Boot Bootloader">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/display3-title.png">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">RISC-V Star64 JH7110: Power Up the Display Controller with U-Boot Bootloader</h1>
    <nav id="TOC"><ul>
<li><a href="#dump-and-write-memory-with-u-boot-bootloader">1 Dump and Write Memory with U-Boot Bootloader</a><ul></ul></li>
<li><a href="#dump-the-jh7110-display-controller">2 Dump the JH7110 Display Controller</a><ul></ul></li>
<li><a href="#jh7110-power-management-unit">3 JH7110 Power Management Unit</a><ul></ul></li>
<li><a href="#clocks-and-resets-for-display-subsystem">4 Clocks and Resets for Display Subsystem</a><ul></ul></li>
<li><a href="#u-boot-script-to-power-up-the-display-subsystem">5 U-Boot Script to Power Up the Display Subsystem</a><ul></ul></li>
<li><a href="#clocks-and-resets-for-display-controller">6 Clocks and Resets for Display Controller</a><ul></ul></li>
<li><a href="#read-the-hardware-revision-and-chip-id">7 Read the Hardware Revision and Chip ID</a><ul></ul></li>
<li><a href="#nuttx-display-driver-for-jh7110">8 NuttX Display Driver for JH7110</a><ul></ul></li>
<li><a href="#unsolved-mysteries">9 Unsolved Mysteries</a><ul></ul></li>
<li><a href="#whats-next">10 What‚Äôs Next</a><ul></ul></li>
<li><a href="#appendix-jh7110-display-controller-mysteries">11 Appendix: JH7110 Display Controller Mysteries</a><ul></ul></li></ul></nav><p>üìù <em>7 Sep 2023</em></p>
<p><img src="https://lupyuen.github.io/images/display3-title.png" alt="Star64 JH7110 Display Controller is alive!" /></p>
<p>In the olden days we would <strong><code>peek</code></strong> and <strong><code>poke</code></strong> the <strong>Display Controller</strong>, to see weird and wonderful displays.</p>
<p>Today (46 years later), we poke around the Display Controller of <a href="https://wiki.pine64.org/wiki/STAR64"><strong>Star64 JH7110 RISC-V SBC</strong></a> with a modern tool (not BASIC): <a href="https://lupyuen.github.io/articles/linux#u-boot-bootloader-for-star64"><strong>U-Boot Bootloader</strong></a>!</p>
<p>(Spoiler: No weird and wonderful displays for today!)</p>
<p>In this article we discover‚Ä¶</p>
<ul>
<li>
<p>U-Boot Commands <strong><code>md</code></strong> and <strong><code>mw</code></strong>  for Dumping and Writing Memory (Pic above)</p>
</li>
<li>
<p>Which we use to power up the <strong>Video Output</strong> and <strong>Display Controller</strong> on the <a href="https://doc-en.rvspace.org/Doc_Center/jh7110.html"><strong>RISC-V StarFive JH7110 SoC</strong></a></p>
</li>
<li>
<p>By tweaking the JH7110 Registers for <strong>Power Management Unit</strong>, <strong>Clock and Reset</strong></p>
</li>
<li>
<p>And how we‚Äôll create our own <strong>Display Driver</strong> for JH7110</p>
</li>
<li>
<p>In spite of the <strong>Missing and Incorrect Docs</strong></p>
</li>
</ul>
<p><em>Why are we doing this?</em></p>
<p>We‚Äôre building a <strong>HDMI Display Driver</strong> for <a href="https://lupyuen.github.io/articles/release"><strong>Apache NuttX Real-Time Operating System</strong></a> (RTOS) on the Star64 SBC. (And probably for VisionFive2 too)</p>
<p>Our analysis today will be super useful for creating our <strong>HDMI Driver for NuttX</strong> on Star64. (Pic below)</p>
<p>And hopefully this article will be helpful for <strong>porting other Operating Systems</strong> to JH7110!</p>
<p><img src="https://lupyuen.github.io/images/linux-title.jpg" alt="Pine64 Star64 RISC-V SBC" /></p>
<h1 id="dump-and-write-memory-with-u-boot-bootloader"><a href="#dump-and-write-memory-with-u-boot-bootloader">1 Dump and Write Memory with U-Boot Bootloader</a></h1>
<p><em>Our Bootloader will Read AND Write any Memory?</em></p>
<p>Yep! Inside our Star64 SBC is the powerful (maybe risky) <a href="https://lupyuen.github.io/articles/linux#u-boot-bootloader-for-star64"><strong>U-Boot Bootloader</strong></a> that will read and write JH7110 SoC‚Äôs Memory: <strong>RAM, ROM, even I/O Registers</strong>!</p>
<p>(ROM is read-only of course)</p>
<p>Boot Star64 <strong>without a microSD Card</strong> and shut down our <a href="https://lupyuen.github.io/articles/tftp"><strong>TFTP Server</strong></a>. We should see the <strong>U-Boot Prompt</strong>.</p>
<p>The <strong><code>md</code></strong> command will dump JH7110 Memory (RAM, ROM, I/O Registers)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md
md - memory display
Usage: md [.b, .w, .l, .q] address [# of objects]
</code></pre></div>
<p>Let‚Äôs dump the <strong>JH7110 Boot ROM</strong> at <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/system_memory_map.html"><strong><code>0x2A00</code> <code>0000</code></strong></a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md 2A000000 0x20
2a000000: 00000297 12628293 30529073 30005073  ......b.s.R0sP.0
2a000010: 30405073 41014081 42014181 43014281  sP@0.@.A.A.B.B.C
2a000020: 44014381 45014481 46014581 47014681  .C.D.D.E.E.F.F.G
2a000030: 48014781 49014881 4a014981 4b014a81  .G.H.H.I.I.J.J.K
2a000040: 4c014b81 4d014c81 4e014d81 4f014e81  .K.L.L.M.M.N.N.O
2a000050: 01974f81 8193d710 02970ae1 82930000  .O..............
</code></pre></div>
<p>(Cute Alphabet Soup. Wonder where‚Äôs the Source Code?)</p>
<p><em>This works for I/O Registers?</em></p>
<p>We can dump the <strong>JH7110 UART Registers</strong> at <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/system_memory_map.html"><strong><code>0x1000</code> <code>0000</code></strong></a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md 10000000 0x20
10000000: 0000006d 00000000 000000c1 00000003  m...............
10000010: 00000003 00000000 00000000 00000000  ................
10000020: 00000000 00000000 00000000 00000000  ................
10000030: 00000064 00000064 00000064 00000064  d...d...d...d...
</code></pre></div>
<p><em>What about writing to I/O Registers?</em></p>
<p>Let‚Äôs <strong>write to UART Registers</strong>. The <strong><code>mw</code></strong> command writes to JH7110 Memory‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># mw
mw - memory write (fill)
Usage: mw [.b, .w, .l, .q] address value [count]
</code></pre></div>
<p>(Hmmm sounds like a Security Risk)</p>
<p>To transmit some UART Output, we poke <code>0x2A</code> into the <strong>UART Transmit Register</strong> at <a href="https://lupyuen.github.io/articles/nuttx2#uart-controller-on-star64"><strong><code>0x1000</code> <code>0000</code></strong></a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># mw 10000000 2a 1
*
</code></pre></div>
<p>Yep it prints ‚Äú<strong><code>*</code></strong>‚Äù, which is ASCII Code 2A!</p>
<p>Let‚Äôs do something more sophisticated: JH7110 Display Controller‚Ä¶</p>
<h1 id="dump-the-jh7110-display-controller"><a href="#dump-the-jh7110-display-controller">2 Dump the JH7110 Display Controller</a></h1>
<p><em>Dumping the JH7110 Display Controller should work right?</em></p>
<p>Let‚Äôs find out! Based on‚Ä¶</p>
<ul>
<li>
<p><a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/memory_map_display.html"><strong>JH7110 Display Subsystem Memory Map</strong></a></p>
</li>
<li>
<p><a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/system_memory_map.html"><strong>JH7110 System Memory Map</strong></a></p>
</li>
</ul>
<p>The registers for <strong>JH7110 Display Subsystem</strong> are at‚Ä¶</p>
<div><table><thead><tr><th style="text-align: center">Address</th><th style="text-align: left">Display Registers</th></tr></thead><tbody>
<tr><td style="text-align: center"><strong><code>0x2940 0000</code></strong></td><td style="text-align: left"><strong>DC8200 AHB0</strong> <br><em>(Display Bus 0)</em></td></tr>
<tr><td style="text-align: center"><strong><code>0x2948 0000</code></strong></td><td style="text-align: left"><strong>DC8200 AHB1</strong> <br><em>(Display Bus 1)</em></td></tr>
<tr><td style="text-align: center"><strong><code>0x2959 0000</code></strong></td><td style="text-align: left"><strong>U0_HDMITX</strong> <br><em>(HDMI)</em></td></tr>
<tr><td style="text-align: center"><strong><code>0x295B 0000</code></strong></td><td style="text-align: left"><strong>VOUT_SYSCON</strong> <br><em>(System Config)</em></td></tr>
<tr><td style="text-align: center"><strong><code>0x295C 0000</code></strong></td><td style="text-align: left"><strong>VOUT_CRG</strong> <br><em>(Clock and Reset)</em></td></tr>
<tr><td style="text-align: center"><strong><code>0x295D 0000</code></strong></td><td style="text-align: left"><strong>DSI TX</strong> <br><em>(MIPI Display Serial Interface)</em></td></tr>
<tr><td style="text-align: center"><strong><code>0x295E 0000</code></strong></td><td style="text-align: left"><strong>MIPITX DPHY</strong> <br><em>(MIPI Display Physical Layer)</em></td></tr>
</tbody></table>
</div>
<p><a href="https://lupyuen.github.io/articles/display2#dc8200-display-controller">(<strong>DC8200</strong> is the <strong>VeriSilicon Dual Display Controller</strong>)</a></p>
<p>Let‚Äôs dump the above <strong>Display Subsystem Registers</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md 29400000 0x20
29400000: 00000000 00000000 00000000 00000000  ................
29400010: 00000000 00000000 00000000 00000000  ................

# md 29480000 0x20
29480000: 00000000 00000000 00000000 00000000  ................
29480010: 00000000 00000000 00000000 00000000  ................

# md 29590000 0x20
29590000: 00000000 00000000 00000000 00000000  ................
29590010: 00000000 00000000 00000000 00000000  ................

# md 295B0000 0x20
295b0000: 00000000 00000000 00000000 00000000  ................
295b0010: 00000000 00000000 00000000 00000000  ................

# md 295C0000 0x20
295c0000: 00000000 00000000 00000000 00000000  ................
295c0010: 00000000 00000000 00000000 00000000  ................
</code></pre></div>
<p><em>But the values are all zero!</em></p>
<p>That‚Äôs because the Display Subsystem is <strong>not powered up</strong>.</p>
<p>Let‚Äôs tweak some registers and power up the Display Subsystem‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/display2-vout_block_diagram18.png" alt="JH7110 Display Subsystem Block Diagram" /></p>
<p><a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/block_diagram_display.html"><em>JH7110 Display Subsystem Block Diagram</em></a></p>
<h1 id="jh7110-power-management-unit"><a href="#jh7110-power-management-unit">3 JH7110 Power Management Unit</a></h1>
<p><em>How will we power up the Display Subsystem?</em></p>
<p>From the pic above, the Display Subsystem is powered in the <strong>Video Output Power Domain (DOM_VOUT)</strong>.</p>
<p>Which is powered by the JH7110 <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/overview_pm.html"><strong>Power Management Unit</strong></a> (PMU or PMIC)‚Ä¶</p>
<p><img src="https://doc-en.rvspace.org/JH7110/TRM/Image/RD/JH7110/power_stratey.png" alt="Power Management Unit" /></p>
<p><a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/overview_pm.html">(Source)</a></p>
<p><em>Is the power turned on for Video Output DOM_VOUT?</em></p>
<p>Let‚Äôs dump the status of the Power Domains‚Ä¶</p>
<ul>
<li>
<p>From <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/system_memory_map.html"><strong>System Memory Map</strong></a>: Base Address of PMU is <strong><code>0x1703</code> <code>0000</code></strong></p>
</li>
<li>
<p>From <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/register_info_pmu.html#register_info_pmu__section_rcx_pqz_msb"><strong>PMU Registers</strong></a>: Current Power Mode is at Offset <strong><code>0x80</code></strong></p>
</li>
</ul>
<p>Which means the <strong>Current Power Mode</strong> is at <strong><code>0x1703</code> <code>0080</code></strong>. Let‚Äôs dump the register‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md 17030080 1
17030080: 00000003
</code></pre></div>
<p><a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/register_info_pmu.html#register_info_pmu__section_rcx_pqz_msb"><strong>Current Power Mode</strong></a> is 3, which says that‚Ä¶</p>
<ul>
<li><strong>SYSTOP Power</strong> (Bit 0) is On</li>
<li><strong>CPU Power</strong> (Bit 1) is On</li>
<li>But <strong>VOUT Power</strong> (Bit 4) is Off!</li>
</ul>
<p><em>So how to power up VOUT?</em></p>
<p>From the <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/function_descript_pmu.html"><strong>PMU Function Description</strong></a>‚Ä¶</p>
<blockquote>
<p><strong>SW Encourage Turn-on Sequence</strong></p>
</blockquote>
<blockquote>
<p>(1) Configure the register <strong>SW Turn-On Power Mode</strong> (offset <strong><code>0x0C</code></strong>), write the bit 1 which Power Domain will be turn-on, write the others 0;</p>
</blockquote>
<blockquote>
<p>(2) Write the <strong>SW Turn-On Command Sequence</strong>. Write the register Software Encourage (offset <strong><code>0x44</code></strong>) <strong><code>0xFF</code></strong> ‚Üí <strong><code>0x05</code></strong> ‚Üí <strong><code>0x50</code></strong></p>
</blockquote>
<p><em>What‚Äôs a ‚ÄúSoftware Encourage‚Äù?</em></p>
<p>Something got Lost in Translation. Let‚Äôs assume it means ‚ÄúSoftware Trigger‚Äù.</p>
<p>Which means we set the <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/register_info_pmu.html#register_info_pmu__section_nhb_slz_msb"><strong>Power Mode</strong></a> (Offset <strong><code>0x0C</code></strong>) to <strong><code>0x10</code></strong> (Bit 4 for VOUT)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># mw 1703000c 0x10 1
</code></pre></div>
<p>Then we write the <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/register_info_pmu.html#register_info_pmu__section_jdh_x4z_msb"><strong>Command Sequence</strong></a> at Offset <strong><code>0x44</code></strong> (no delays needed)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># mw 17030044 0xff 1
# mw 17030044 0x05 1
# mw 17030044 0x50 1
</code></pre></div>
<p>Finally we dump the <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/register_info_pmu.html#register_info_pmu__section_rcx_pqz_msb"><strong>Current Power Mode</strong></a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md 17030080 1
17030080: 00000013
</code></pre></div>
<p><strong>Video Output Power VOUT</strong> (Bit 4) is now on!</p>
<p><em>So we can dump the Display Subsystem now?</em></p>
<p>Sadly nope, the <strong>Display Subsystem Registers</strong> are still empty‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md 295C0000 0x20
295c0000: 00000000 00000000 00000000 00000000  ................
295c0010: 00000000 00000000 00000000 00000000  ................
</code></pre></div>
<p>We need more tweaks, for the Clock and Reset Signals‚Ä¶</p>
<p>TODO: Pic of JH7110 Clock Structure</p>
<p><a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/clock_structure.html"><em>JH7110 Clock Structure</em></a></p>
<h1 id="clocks-and-resets-for-display-subsystem"><a href="#clocks-and-resets-for-display-subsystem">4 Clocks and Resets for Display Subsystem</a></h1>
<p><em>Display Subsystem (VOUT) is already powered up via the Power Management Unit (PMU)‚Ä¶</em></p>
<p><em>Anything else we need to make it work?</em></p>
<p>Always remember to enable the <strong>Clocks</strong> and deassert the <strong>Resets</strong>!</p>
<p>According to the <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/clock_structure.html"><strong>JH7110 Clock Structure</strong></a> (pic above), the <strong>Display Subsystem (VOUT)</strong> is Clocked by‚Ä¶</p>
<ul>
<li><strong>clk_vout_root</strong></li>
<li><strong>mipiphy ref clk</strong></li>
<li><strong>hdmiphy ref clk</strong></li>
<li><strong>clk_vout_src</strong> (1228.8 MHz)</li>
<li><strong>clk_vout_axi</strong> (614.4 MHz)</li>
<li><strong>clk_vout_ahb</strong> (204.8 MHz) / <strong>clk_ahb1</strong></li>
<li><strong>clk_mclk</strong> (51.2 MHz)</li>
</ul>
<p>Plus one Reset‚Ä¶</p>
<ul>
<li><strong>rstn_vout</strong></li>
</ul>
<p><em>How to enable the Clocks and deassert the Resets?</em></p>
<p>We‚Äôll set the <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/sys_crg.html"><strong>System Control Registers (SYS CRG)</strong></a> at Base Address <strong><code>0x1302</code> <code>0000</code></strong></p>
<p><a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/system_memory_map.html">(From the <strong>System Memory Map</strong>)</a></p>
<p>When we match the above Clocks to the <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/sys_crg.html"><strong>System Control Registers (SYS CRG)</strong></a>, we get‚Ä¶</p>
<div><table><thead><tr><th style="text-align: center">SYS CRG<br>Offset</th><th style="text-align: left">Clock</th></tr></thead><tbody>
<tr><td style="text-align: center"><strong><code>0x28</code></strong></td><td style="text-align: left">Clock AHB 1</td></tr>
<tr><td style="text-align: center"><strong><code>0x4C</code></strong></td><td style="text-align: left">MCLK Out</td></tr>
<tr><td style="text-align: center"><strong><code>0x98</code></strong></td><td style="text-align: left">clk_u0_sft7110_noc_bus _clk_cpu_axi</td></tr>
<tr><td style="text-align: center"><strong><code>0x9C</code></strong></td><td style="text-align: left">clk_u0_sft7110_noc_bus _clk_axicfg0_axi</td></tr>
<tr><td style="text-align: center"><strong><code>0xE8</code></strong></td><td style="text-align: left">clk_u0_dom_vout_top _clk_dom_vout_top_clk_vout_src</td></tr>
<tr><td style="text-align: center"><strong><code>0xF0</code></strong></td><td style="text-align: left">Clock NOC Display AXI</td></tr>
<tr><td style="text-align: center"><strong><code>0xF4</code></strong></td><td style="text-align: left">Clock Video Output AHB</td></tr>
<tr><td style="text-align: center"><strong><code>0xF8</code></strong></td><td style="text-align: left">Clock Video Output AXI</td></tr>
<tr><td style="text-align: center"><strong><code>0xFC</code></strong></td><td style="text-align: left">Clock Video Output HDMI TX0 MCLK</td></tr>
</tbody></table>
</div>
<p>(Looks excessive, but better to enable more Clocks than too few!)</p>
<p>To enable the Clock Registers above, we set <strong>Bit 31 (clk_icg)</strong> to 1.</p>
<p>Here are the U-Boot Commands to enable the Clocks‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>## Enable the Clocks for Video Output / Display Subsystem
mw 13020028 0x80000000 1
mw 1302004c 0x80000000 1
mw 13020098 0x80000000 1
mw 1302009c 0x80000000 1
mw 130200e8 0x80000000 1
mw 130200f0 0x80000000 1
mw 130200f4 0x80000000 1
mw 130200f8 0x80000000 1
mw 130200fc 0x80000000 1
</code></pre></div>
<p><em>What about the Resets?</em></p>
<p>Looking up the <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/sys_crg.html"><strong>System Control Registers (SYS CRG)</strong></a>, we need to <strong>deassert these Resets</strong>‚Ä¶</p>
<ul>
<li>
<p><strong>Software RESET 1 Address Selector</strong> (SYS CRG Offset <strong><code>0x2FC</code></strong>)</p>
<p><strong>Bit 11:</strong> rstn_u0_dom_vout_top _rstn_dom_vout_top_rstn_vout_src</p>
</li>
<li>
<p><strong>SYSCRG RESET Status 0</strong> (SYS CRG Offset <strong><code>0x308</code></strong>)</p>
<p><strong>Bit 26:</strong> rstn_u0_sft7110_noc_bus _reset_disp_axi_n</p>
</li>
<li>
<p><strong>SYSCRG RESET Status 1</strong> (SYS CRG Offset <strong><code>0x30C</code></strong>)</p>
<p><strong>Bit 11:</strong> rstn_u0_dom_vout_top _rstn_dom_vout_top_rstn_vout_src</p>
</li>
</ul>
<p>We set the above bits to 0 to deassert the Resets.</p>
<p>First we dump the above <strong>Reset Registers</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md 130202fc 1
130202fc: 07e7fe00

# md 13020308 1
13020308: ff9fffff

# md 1302030c 1
1302030c: f80001ff
</code></pre></div>
<p>Then we flip the <strong>Reset Bits</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># mw 130202fc 0x07e7f600 1
# mw 13020308 0xfb9fffff 1
</code></pre></div>
<p>(The last Reset is already deasserted, no need to change it)</p>
<p><em>What happens when we enable the Clocks and deassert the Resets?</em></p>
<p>We run the above commands to set the Clocks and Resets.</p>
<p>And again we dump the <strong>Display Subsystem Registers</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md 295C0000 0x20
295c0000: 00000004 00000004 00000004 0000000c  ................
295c0010: 00000000 00000000 00000000 00000000  ................
295c0020: 00000000 00000000 00000000 00000000  ................
295c0030: 00000000 00000000 00000000 00000000  ................
295c0040: 00000000 00000000 00000fff 00000000  ................
</code></pre></div>
<p>The Display Systems Registers are now visible at VOUT CRG <strong><code>0x295C</code> <code>0000</code></strong>‚Ä¶</p>
<p>Which means the Display Subsystem is alive yay!</p>
<p><img src="https://lupyuen.github.io/images/display3-title.png" alt="Star64 JH7110 Display Subsystem is alive!" /></p>
<p>TODO: The Default Values seem to match <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/dom_vout_crg.html">DOM VOUT CRG</a>. (<code>clk_tx_esc</code> should have default <code>24'hc</code>, there is a typo in the doc: <code>24'h12</code>)</p>
<p><img src="https://lupyuen.github.io/images/display3-typo.png" alt="clk_tx_esc should have default 24'hc, there is a typo in the doc: 24'h12" /></p>
<h1 id="u-boot-script-to-power-up-the-display-subsystem"><a href="#u-boot-script-to-power-up-the-display-subsystem">5 U-Boot Script to Power Up the Display Subsystem</a></h1>
<p><em>Phew that‚Äôs a long list of U-Boot Commands. Can we automate this?</em></p>
<div class="example-wrap"><pre class="language-text"><code>## Power Up the PMU for Video Output / Display Subsystem
mw 1703000c 0x10 1
mw 17030044 0xff 1
mw 17030044 0x05 1
mw 17030044 0x50 1

## Enable the Clocks for Video Output / Display Subsystem
mw 13020028 0x80000000 1
mw 1302004c 0x80000000 1
mw 13020098 0x80000000 1
mw 1302009c 0x80000000 1
mw 130200e8 0x80000000 1
mw 130200f0 0x80000000 1
mw 130200f4 0x80000000 1
mw 130200f8 0x80000000 1
mw 130200fc 0x80000000 1

## Deassert the Resets for Video Output / Display Subsystem
mw 130202fc 0x07e7f600 1
mw 13020308 0xfb9fffff 1
md 295C0000 0x20
</code></pre></div>
<p>Sure can! Run this to create a <strong>U-Boot Script</strong> that powers up the Display Subsystem‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>## Create the U-Boot Script to power up the Video Output
setenv video_on &#39;mw 1703000c 0x10 1 ; mw 17030044 0xff 1 ; mw 17030044 0x05 1 ; mw 17030044 0x50 1 ; mw 13020028 0x80000000 1 ; mw 1302004c 0x80000000 1 ; mw 13020098 0x80000000 1 ; mw 1302009c 0x80000000 1 ; mw 130200e8 0x80000000 1 ; mw 130200f0 0x80000000 1 ; mw 130200f4 0x80000000 1 ; mw 130200f8 0x80000000 1 ; mw 130200fc 0x80000000 1 ; mw 130202fc 0x07e7f600 1 ; mw 13020308 0xfb9fffff 1 ; md 295C0000 0x20 ; &#39;

## Check that it&#39;s correct
printenv video_on

## Save it for future reboots
saveenv

## Run the U-Boot Script to power up the Video Output
run video_on
</code></pre></div>
<p>The U-Boot Script <strong><code>video_on</code></strong> is now saved into our SBC‚Äôs Internal Flash Memory. </p>
<p>Now we can switch on our SBC and run the script anytime‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># run video_on
295c0000: 00000004 00000004 00000004 0000000c  ................
295c0010: 00000000 00000000 00000000 00000000  ................
295c0020: 00000000 00000000 00000000 00000000  ................
295c0030: 00000000 00000000 00000000 00000000  ................
295c0040: 00000000 00000000 00000fff 00000000  ................
</code></pre></div>
<p>So much easier to power up the Display Subsystem!</p>
<p>Let‚Äôs talk about the Display Controller‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/display2-vout_clkrst18.png" alt="JH7110 Display Subsystem Clock and Reset" /></p>
<p><a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/clock_n_reset_display.html"><em>JH7110 Display Subsystem Clock and Reset</em></a></p>
<h1 id="clocks-and-resets-for-display-controller"><a href="#clocks-and-resets-for-display-controller">6 Clocks and Resets for Display Controller</a></h1>
<p><em>JH7110 Display Subsystem is now powered up‚Ä¶</em></p>
<p><em>What about the Display Controller?</em></p>
<p>Nope our <strong>DC8200 Display Controller</strong> (DC8200 AHB0) is stil invisible‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md 29400000 0x20
29400000: 00000000 00000000 00000000 00000000  ................
29400010: 00000000 00000000 00000000 00000000  ................
</code></pre></div>
<p><em>What about the Clocks and Resets for the Display Controller?</em></p>
<p>The pic above shows the <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/clock_n_reset_display.html"><strong>Display Controller Clocks and Resets</strong></a>.</p>
<p>According to the <a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/dom_vout_crg.html"><strong>VOUT CRG</strong></a> (Video Output Clock and Reset Registers), these are the <strong>VOUT Clock Registers</strong> for HDMI‚Ä¶</p>
<div><table><thead><tr><th style="text-align: center">VOUT CRG<br>Offset</th><th style="text-align: left">Clock</th></tr></thead><tbody>
<tr><td style="text-align: center"><strong><code>0x10</code></strong></td><td style="text-align: left">clk_u0_dc8200_clk_axi</td></tr>
<tr><td style="text-align: center"><strong><code>0x14</code></strong></td><td style="text-align: left">clk_u0_dc8200_clk_core</td></tr>
<tr><td style="text-align: center"><strong><code>0x18</code></strong></td><td style="text-align: left">clk_u0_dc8200_clk_ahb</td></tr>
<tr><td style="text-align: center"><strong><code>0x1C</code></strong></td><td style="text-align: left">clk_u0_dc8200_clk_pix0</td></tr>
<tr><td style="text-align: center"><strong><code>0x20</code></strong></td><td style="text-align: left">clk_u0_dc8200_clk_pix1</td></tr>
<tr><td style="text-align: center"><strong><code>0x3C</code></strong></td><td style="text-align: left">clk_u0_hdmi_tx_clk_mclk</td></tr>
<tr><td style="text-align: center"><strong><code>0x40</code></strong></td><td style="text-align: left">clk_u0_hdmi_tx_clk_bclk</td></tr>
<tr><td style="text-align: center"><strong><code>0x44</code></strong></td><td style="text-align: left">clk_u0_hdmi_tx_clk_sys</td></tr>
</tbody></table>
</div>
<p>To enable the Clock Registers above, we set <strong>Bit 31 (clk_icg)</strong> to 1.</p>
<p><a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/memory_map_display.html">(<strong>VOUT CRG</strong> Base Address is <strong><code>0x295C</code> <code>0000</code></strong>)</a></p>
<p><strong>VOUT Resets</strong> for HDMI are at <em>Software_RESET_assert0_addr_assert_sel</em> (VOUT CRG Offset <strong><code>0x48</code></strong>)‚Ä¶</p>
<ul>
<li>
<p><strong>Bit 0:</strong> rstn_u0_dc8200_rstn_axi</p>
</li>
<li>
<p><strong>Bit 1:</strong> rstn_u0_dc8200_rstn_ahb</p>
</li>
<li>
<p><strong>Bit 2:</strong> rstn_u0_dc8200_rstn_core</p>
</li>
<li>
<p><strong>Bit 9:</strong> rstn_u0_hdmi_tx_rstn_hdmi</p>
</li>
</ul>
<p>We set the above bits to 0 to deassert the Resets.</p>
<p>TODO: Offset is 0x48 instead of 0x38</p>
<p>Here are the U-Boot Commands to set the <strong>VOUT Clocks and Resets</strong> for HDMI‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>## Power up the Video Output / Display Subsystem
run video_on

## Enable the VOUT HDMI Clocks
mw 295C0010 0x80000000 1
mw 295C0014 0x80000000 1
mw 295C0018 0x80000000 1
mw 295C001c 0x80000000 1
mw 295C0020 0x80000000 1
mw 295C003c 0x80000000 1
mw 295C0040 0x80000000 1
mw 295C0044 0x80000000 1

## Deassert the VOUT HDMI Resets.
## We deassert all Resets for now.
mw 295C0048 0 1
</code></pre></div>
<p><em>Does it work?</em></p>
<p>We run the above U-Boot Commands and dump our <strong>DC8200 Display Controller</strong> (DC8200 AHB0)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md 29400000 0x20
29400000: 00000900 80010000 00222200 00000000  .........&quot;&quot;.....
29400010: 00000000 00000004 14010000 000b4b41  ............AK..
29400020: 00008200 00005720 20210316 16015600  .... W....! .V..
29400030: 0000030e a0600084 00000000 00000000  ......`.........
</code></pre></div>
<p>Yep our DC8200 Display Controller is finally alive yay!</p>
<p>Based on the above commands, we write the <strong>U-Boot Script</strong> to power up the Display Controller‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>## Create the U-Boot Script to power up the Display Controller
setenv display_on &#39;mw 295C0010 0x80000000 1 ; mw 295C0014 0x80000000 1 ; mw 295C0018 0x80000000 1 ; mw 295C001c 0x80000000 1 ; mw 295C0020 0x80000000 1 ; mw 295C003c 0x80000000 1 ; mw 295C0040 0x80000000 1 ; mw 295C0044 0x80000000 1 ; mw 295C0048 0 1 ; md 29400000 0x20 ; &#39;

## Check that it&#39;s correct
printenv display_on

## Save it for future reboots
saveenv

## Run the U-Boot Script to power up the Video Output
run video_on

## Run the U-Boot Script to power up the Display Controller
run display_on
</code></pre></div>
<p>TODO: See the Output Log</p>
<p>Let‚Äôs verify the DC8200 Register Values‚Ä¶</p>
<p>TODO: Screenshot of DC8200</p>
<h1 id="read-the-hardware-revision-and-chip-id"><a href="#read-the-hardware-revision-and-chip-id">7 Read the Hardware Revision and Chip ID</a></h1>
<p><em>Are the DC8200 Register Values correct?</em></p>
<p>According to the <a href="https://lupyuen.github.io/articles/display2#dc8200-display-hardware-driver"><strong>DC8200 Display Driver</strong></a>, we can read these Register Values from the DC8200 Display Controller‚Ä¶</p>
<ul>
<li>
<p><strong>Hardware Revision</strong>: DC8200 AHB0 Offset <strong><code>0x24</code></strong></p>
</li>
<li>
<p><strong>Chip ID</strong>: DC8200 AHB0 Offset <strong><code>0x30</code></strong></p>
<p><a href="https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/memory_map_display.html">(<strong>DC8200 AHB0</strong> Base Address is <strong><code>0x2940</code> <code>0000</code></strong>)</a></p>
<p><a href="https://github.com/starfive-tech/linux/blob/JH7110_VisionFive2_devel/drivers/gpu/drm/verisilicon/vs_dc_hw.c#L1301-L1361">(Source)</a> </p>
</li>
</ul>
<p>Let‚Äôs dump the <strong>Hardware Revision</strong> and <strong>Chip ID</strong> in U-Boot‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>## Power up the Video Output
run video_on

## Power up the Display Controller
run display_on

## Dump the Hardware Revision
md 29400024 1

## Dump the Chip ID
md 29400030 1
</code></pre></div>
<p>We should see‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># md 29400024 1
29400024: 00005720

# md 29400030 1
29400030: 0000030e
</code></pre></div>
<p>Which means‚Ä¶</p>
<ul>
<li>
<p><strong>Hardware Revision</strong> is <strong><code>0x5720</code></strong> (DC_REV_0)</p>
</li>
<li>
<p><strong>Chip ID</strong> is <strong><code>0x30E</code></strong></p>
<p><a href="https://github.com/starfive-tech/linux/blob/JH7110_VisionFive2_devel/drivers/gpu/drm/verisilicon/vs_dc_hw.c#L1301-L1361">(Source)</a></p>
</li>
</ul>
<p>Our DC8200 Display Controller returns the correct Register Values yay!</p>
<p>(Do we have a Date at <strong><code>0x2940</code> <code>0024</code></strong>? It reads ‚Äú20210316‚Äù)</p>
<h1 id="nuttx-display-driver-for-jh7110"><a href="#nuttx-display-driver-for-jh7110">8 NuttX Display Driver for JH7110</a></h1>
<p>TODO</p>
<p><em>How will we test this in NuttX?</em></p>
<p>Probably inside <code>board_late_initialize</code> like this: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/hdmi/boards/risc-v/jh7110/star64/src/jh7110_appinit.c#L154-L215">jh7110_appinit.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>void board_late_initialize(void) {
  /* Mount the RAM Disk */
  mount_ramdisk();

  /* Perform board-specific initialization */
#ifdef CONFIG_NSH_ARCHINIT
  mount(NULL, &quot;/proc&quot;, &quot;procfs&quot;, 0, NULL);
#endif

  // Verify that Video Output / Display Subsystem is down
  uint32_t val = getreg32(0x295C0000);
  DEBUGASSERT(val == 0);

  // Power up the Video Output / Display Subsystem
  // TODO: Switch to constants
  putreg32(0x10, 0x1703000c);
  putreg32(0xff, 0x17030044);
  putreg32(0x05, 0x17030044);
  putreg32(0x50, 0x17030044);
  putreg32(0x80000000, 0x13020028);
  putreg32(0x80000000, 0x1302004c);
  putreg32(0x80000000, 0x13020098);
  putreg32(0x80000000, 0x1302009c);
  putreg32(0x80000000, 0x130200e8);
  putreg32(0x80000000, 0x130200f0);
  putreg32(0x80000000, 0x130200f4);
  putreg32(0x80000000, 0x130200f8);
  putreg32(0x80000000, 0x130200fc);

  // Software RESET 1 Address Selector: Offset 0x2fc
  // Clear Bit 11: rstn_u0_dom_vout_top_rstn_dom_vout_top_rstn_vout_src
  modifyreg32(0x130202fc, 1 &lt;&lt; 11, 0);  // Addr, Clear Bits, Set Bits

  // SYSCRG RESET Status 0: Offset 0x308
  // Clear Bit 26: rstn_u0_sft7110_noc_bus_reset_disp_axi_n
  modifyreg32(0x13020308, 1 &lt;&lt; 26, 0);  // Addr, Clear Bits, Set Bits

  // Verify that Video Output / Display Subsystem is up
  val = getreg32(0x295C0000);
  DEBUGASSERT(val == 4);

  // Test HDMI
  int test_hdmi(void);
  int ret = test_hdmi();
  DEBUGASSERT(ret == 0);
}

// Display Subsystem Base Address
// https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/memory_map_display.html
#define DISPLAY_BASE_ADDRESS (0x29400000)

// DOM VOUT Control Registers
// https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/memory_map_display.html
#define CRG_BASE_ADDRESS     (DISPLAY_BASE_ADDRESS + 0x1C0000)

// DOM VOUT Control Registers
// https://doc-en.rvspace.org/JH7110/TRM/JH7110_TRM/dom_vout_crg.html

#define clk_u0_dc8200_clk_axi   (CRG_BASE_ADDRESS + 0x10)
#define clk_u0_dc8200_clk_core  (CRG_BASE_ADDRESS + 0x14)
#define clk_u0_dc8200_clk_ahb   (CRG_BASE_ADDRESS + 0x18)
#define clk_u0_dc8200_clk_pix0  (CRG_BASE_ADDRESS + 0x1c)
#define clk_u0_dc8200_clk_pix1  (CRG_BASE_ADDRESS + 0x20)
#define clk_u0_hdmi_tx_clk_mclk (CRG_BASE_ADDRESS + 0x3c)
#define clk_u0_hdmi_tx_clk_bclk (CRG_BASE_ADDRESS + 0x40)
#define clk_u0_hdmi_tx_clk_sys  (CRG_BASE_ADDRESS + 0x44)
#define CLK_ICG (1 &lt;&lt; 31)

#define Software_RESET_assert0_addr_assert_sel (CRG_BASE_ADDRESS + 0x38)
#define rstn_u0_dc8200_rstn_axi   (1 &lt;&lt; 0)
#define rstn_u0_dc8200_rstn_ahb   (1 &lt;&lt; 1)
#define rstn_u0_dc8200_rstn_core  (1 &lt;&lt; 2)
#define rstn_u0_hdmi_tx_rstn_hdmi (1 &lt;&lt; 9)
</code></pre></div><h1 id="unsolved-mysteries"><a href="#unsolved-mysteries">9 Unsolved Mysteries</a></h1>
<p>TODO</p>
<p>Typo default 
Reset
Mux
Coefficient 
Encourage </p>
<h1 id="whats-next"><a href="#whats-next">10 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> (and the awesome NuttX Community) for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-star64"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>My Other Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/display3.md"><strong>lupyuen.github.io/src/display3.md</strong></a></p>
<h1 id="appendix-jh7110-display-controller-mysteries"><a href="#appendix-jh7110-display-controller-mysteries">11 Appendix: JH7110 Display Controller Mysteries</a></h1>
<p>TODO</p>
<p>Typo default 
Reset
Mux
Coefficient 
Encourage </p>

    
</body>
</html>