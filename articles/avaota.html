<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Porting Apache NuttX RTOS to Avaota-A1 SBC (Allwinner A527 SoC)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Porting Apache NuttX RTOS to Avaota-A1 SBC (Allwinner A527 SoC)" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/avaota-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.org/articles/avaota.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Porting Apache NuttX RTOS to Avaota-A1 SBC (Allwinner A527 SoC)</h1>
    <nav id="rustdoc"><ul>
<li><a href="#boot-linux-on-our-sbc" title="Boot Linux on our SBC">1 Boot Linux on our SBC</a><ul></ul></li>
<li><a href="#nuttx-kernel-build-for-arm64-qemu" title="NuttX Kernel Build for Arm64 QEMU">2 NuttX Kernel Build for Arm64 QEMU</a><ul></ul></li>
<li><a href="#boot-nuttx-kernel-on-our-sbc" title="Boot NuttX Kernel on our SBC">3 Boot NuttX Kernel on our SBC</a><ul></ul></li>
<li><a href="#print-to-uart-in-arm64-assembly" title="Print to UART in Arm64 Assembly">4 Print to UART in Arm64 Assembly</a><ul></ul></li>
<li><a href="#bootloader-log-says-that-start-address-is-0x40800000-we-change-it" title="Bootloader Log says that Start Address is 0x40800000. We change it">5 Bootloader Log says that Start Address is 0x40800000. We change it</a><ul></ul></li>
<li><a href="#16650-uart-driver" title="16650 UART Driver">6 16650 UART Driver</a><ul></ul></li>
<li><a href="#troubleboot-the-mmu-why-wont-it-start" title="Troubleboot the MMU. Why won‚Äôt it start?">7 Troubleboot the MMU. Why won‚Äôt it start?</a><ul></ul></li>
<li><a href="#hmmm-the-peripheral-address-space-is-missing-uart0-will-crash" title="Hmmm the Peripheral Address Space is missing. UART0 will crash!">8 Hmmm the Peripheral Address Space is missing. UART0 will crash!</a><ul></ul></li>
<li><a href="#lets-fix-the-peripheral-address-space-0x0-to-0x40000000-1-gb" title="Let‚Äôs fix the Peripheral Address Space: 0x0 to 0x40000000, 1 GB">9 Let‚Äôs fix the Peripheral Address Space: 0x0 to 0x40000000, 1 GB</a><ul></ul></li>
<li><a href="#whoa-heap-size-is-wrong-lets-find-out-why" title="Whoa Heap Size is wrong! Let‚Äôs find out why">10 Whoa Heap Size is wrong! Let‚Äôs find out why</a><ul></ul></li>
<li><a href="#oops-config_ram_end-is-too-small-lets-enlarge" title="Oops CONFIG_RAM_END is too small. Let‚Äôs enlarge">11 Oops CONFIG_RAM_END is too small. Let‚Äôs enlarge</a><ul></ul></li>
<li><a href="#ah-we-forgot-the-gic-address" title="Ah we forgot the GIC Address!">12 Ah we forgot the GIC Address!</a><ul></ul></li>
<li><a href="#load-the-nuttx-apps-filesystem-into-ram" title="Load the NuttX Apps Filesystem into RAM">13 Load the NuttX Apps Filesystem into RAM</a><ul></ul></li>
<li><a href="#mount-the-ram-disk" title="Mount the RAM Disk">14 Mount the RAM Disk</a><ul></ul></li>
<li><a href="#fix-the-uart-interrupt" title="Fix the UART Interrupt">15 Fix the UART Interrupt</a><ul></ul></li>
<li><a href="#todo" title="TODO">16 TODO</a><ul></ul></li>
<li><a href="#build-nuttx-for-avaota-a1" title="Build NuttX for Avaota-A1">17 Build NuttX for Avaota-A1</a><ul></ul></li>
<li><a href="#boot-nuttx-for-avaota-a1" title="Boot NuttX for Avaota-A1">18 Boot NuttX for Avaota-A1</a><ul></ul></li>
<li><a href="#allwinner-a527-docs" title="Allwinner A527 Docs">19 Allwinner A527 Docs</a><ul></ul></li>
<li><a href="#work-in-progress" title="Work In Progress">20 Work In Progress</a><ul>
<li><a href="#lets-make-our-build-test-cycle-quicker-we-do-passwordless-sudo-for-flipping-our-sdwire-mux" title="Let‚Äôs make our Build-Test Cycle quicker. We do Passwordless Sudo for flipping our SDWire Mux">20.1 Let‚Äôs make our Build-Test Cycle quicker. We do Passwordless Sudo for flipping our SDWire Mux</a><ul></ul></li></ul></li>
<li><a href="#whats-next" title="What‚Äôs Next">21 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>9 Apr 2025</em></p>
<p><img src="https://lupyuen.org/images/avaota-title.jpg" alt="Avaota-A1 SBC with SDWire MicroSD Multiplexer and Smart Power Plug" /></p>
<span style="font-size:80%">
<p><a href="https://youtu.be/PxaMcmMAzlM"><em>(Watch the Demo on YouTube)</em></a></p>
</span>
<p>TODO</p>
<p><em>Why are we doing this?</em></p>
<ul>
<li>Anyone porting NuttX from <strong>QEMU to Real SBC</strong>? This walkthrough shall be mighty helpful!</li>
</ul>
<p>TI ported NuttX to a simpler A527 board, the Avaota-A1 SBC by PINE64 ($55): https://pine64.com/product/yuzuki-avaota-a1-single-board-computer-4gb-32gb/</p>
<p>Avaota-A1 SBC is Open Source Hardware (CERN OHL Licensed). PINE64 sells it today, maybe we‚Äôll see more manufacturers with the same design: https://github.com/AvaotaSBC/Avaota-A1</p>
<p>I think NuttX on Avaota-A1 (Allwinner A527) will be super interesting because:</p>
<p>(1) It‚Äôs one of the first ports of Arm64 in NuttX Kernel Build (NXP i.MX93 might be another?)</p>
<p>(2) We‚Äôll run it as PR Test Bot for Validating Arm64 PRs</p>
<p>(3) PR Test Bot will be fully automated thanks to SDWire MicroSD Mux: https://lupyuen.org/articles/testbot3.html</p>
<p>Next article I‚Äôll explain how I ported NuttX from QEMU Arm64 (knsh) to Avaota-A1, completed within 24 hours.</p>
<p>Octa-Core CPU</p>
<p>Here‚Äôs the story</p>
<p>Build NuttX for
Port NuttX to</p>
<p>Schematic: https://github.com/AvaotaSBC/Avaota-A1/blob/master/hardware/v1.4/01_SCH/SCH_Avaota%20Pi%20A_2024-05-20.pdf</p>
<h1 id="boot-linux-on-our-sbc"><a class="doc-anchor" href="#boot-linux-on-our-sbc">¬ß</a>1 Boot Linux on our SBC</h1>
<p>Nifty Trick for Booting NuttX on <strong>Any Arm64 SBC</strong> (RISC-V too)</p>
<ul>
<li>
<p><strong>Arm64 Bootloader</strong> <em>(U-Boot / SyterKit)</em> will boot Linux by loading the <strong><code>Image</code></strong> file</p>
<p><em>(Containing the Linux Kernel)</em></p>
</li>
<li>
<p>Thus we <strong>‚ÄúHijack‚Äù the <code>Image</code> File</strong>, replace it by <strong>NuttX Kernel</strong></p>
</li>
<li>
<p>Which means <strong>NuttX Kernel</strong> shall look and feel like a <strong>Linux Kernel</strong></p>
</li>
<li>
<p>That‚Äôs why we have a <a href="TODO"><strong>Linux Kernel Header</strong></a> at the top of NuttX</p>
</li>
</ul>
<p>To begin, we observe our SBC and its <em>Natural Behaviour</em>: How does it <strong>Boot Linux?</strong></p>
<p>TODO: Download</p>
<p>TODO: MicroSD</p>
<p>TODO: SyterKit: https://github.com/YuzukiHD/SyterKit</p>
<p>TODO: Load Address</p>
<p>TODO: LCD Screen too</p>
<p>Download the <a href="https://github.com/AvaotaSBC/AvaotaOS/releases"><strong>Latest AvaotaOS Release</strong></a> <em>(Ubuntu Noble GNOME)</em> and uncompress it‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>wget https://github.com/AvaotaSBC/AvaotaOS/releases/download/0.3.0.4/AvaotaOS-0.3.0.4-noble-gnome-arm64-avaota-a1.img.xz
xz -d AvaotaOS-0.3.0.4-noble-gnome-arm64-avaota-a1.img.xz</code></pre></div>
<p>Write the <strong><code>.img</code></strong> file to a MicroSD with <a href="https://etcher.balena.io/"><strong>Balena Etcher</strong></a>.</p>
<p>We‚Äôll overwrite the <code>Image</code> file by <code>nuttx.bin</code>‚Ä¶</p>
<h1 id="nuttx-kernel-build-for-arm64-qemu"><a class="doc-anchor" href="#nuttx-kernel-build-for-arm64-qemu">¬ß</a>2 NuttX Kernel Build for Arm64 QEMU</h1>
<p>Follow these steps to Build and Run NuttX for <a href="TODO"><strong>Arm64 QEMU (Kernel Build)</strong></a></p>
<div class="example-wrap"><pre class="language-bash"><code>## Build NuttX Kernel (NuttX Kernel Build)
git clone https://github.com/apache/nuttx
git clone https://github.com/apache/nuttx-apps apps
cd nuttx
tools/configure.sh qemu-armv8a:knsh
make -j

## Build NuttX Apps (NuttX Kernel Build)
make -j export
pushd ../apps
./tools/mkimport.sh -z -x ../nuttx/nuttx-export-*.tar.gz
make -j import
popd

## Boot NuttX on QEMU
qemu-system-aarch64 \
  -semihosting \
  -cpu cortex-a53 \
  -nographic \
  -machine virt,virtualization=on,gic-version=3 \
  -net none \
  -chardev stdio,id=con,mux=on \
  -serial chardev:con \
  -mon chardev=con,mode=readline \
  -kernel ./nuttx</code></pre></div>
<p>Check that it works‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>TODO</code></pre></div>
<p>TODO: Why Kernel Build</p>
<h1 id="boot-nuttx-kernel-on-our-sbc"><a class="doc-anchor" href="#boot-nuttx-kernel-on-our-sbc">¬ß</a>3 Boot NuttX Kernel on our SBC</h1>
<p>TODO: Kernel Only, no apps</p>
<p>TODO: 28 MB Linux Kernel</p>
<p><a href="https://gist.github.com/lupyuen/6c0607daa0a8f37bda37cc80e76259ee">Build Log</a></p>
<div class="example-wrap"><pre class="language-bash"><code>$ ls -l /TODO
total 40261
-rwxr-xr-x 1 root root    78769 Feb 22 01:06 bl31.bin
-rwxr-xr-x 1 root root   180233 Feb 21 22:21 config-5.15.154-ga464bc4feaff
drwxr-xr-x 3 root root      512 Feb 21 22:56 dtb
drwxr-xr-x 2 root root      512 Feb 22 01:06 extlinux
-rwxr-xr-x 1 root root 27783176 Mar  7 21:24 Image
-rwxr-xr-x 1 root root   180228 Feb 22 01:06 scp.bin
-rwxr-xr-x 1 root root    12960 Feb 22 01:06 splash.bin
-rwxr-xr-x 1 root root  5193581 Feb 21 22:21 System.map-5.15.154-ga464bc4feaff
-rwxr-xr-x 1 root root  6497300 Feb 22 01:06 uInitrd</code></pre></div>
<p>TODO: We‚Äôll overwrite the <code>Image</code> file by <code>nuttx.bin</code>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>mv /TODO/Image /TODO/Image.old
cp nuttx.bin /TODO/Image
ls -l /TODO/Image
## Should be a lot smaller</code></pre></div>
<p>Nothing happens. Let‚Äôs print something‚Ä¶</p>
<h1 id="print-to-uart-in-arm64-assembly"><a class="doc-anchor" href="#print-to-uart-in-arm64-assembly">¬ß</a>4 Print to UART in Arm64 Assembly</h1>
<p><em>How will we know that NuttX is actually booting?</em></p>
<p>Let‚Äôs print something. <strong>UART0 Base Address</strong> is here‚Ä¶</p>
<p>
<div style="border: 2px solid #a0a0a0; max-width: fit-content;">
<div><table><thead><tr><th style="text-align: left"><a href="https://linux-sunxi.org/File:A523_User_Manual_V1.1_merged_cleaned.pdf">A523 User Manual</a></th><th style="text-align: left">Page 1839</th></tr></thead><tbody>
<tr><td style="text-align: left"><strong>Module</strong></td><td style="text-align: left"><strong>Base Address</strong></td></tr>
<tr><td style="text-align: left">UART0</td><td style="text-align: left"><em>0x0250_0000</em></td></tr>
</tbody></table>
</div></div>
</p>
<p>16550 Transmit Register is at <strong>Offset 0</strong>‚Ä¶</p>
<p>
<div style="border: 2px solid #a0a0a0; max-width: fit-content;">
<div><table><thead><tr><th style="text-align: left"><a href="https://linux-sunxi.org/File:A523_User_Manual_V1.1_merged_cleaned.pdf">A523 User Manual</a></th><th style="text-align: left">Page 1839</th></tr></thead><tbody>
<tr><td style="text-align: left"><strong>Offset</strong></td><td style="text-align: left"><strong>Register</strong></td></tr>
<tr><td style="text-align: left"><em>0x0000</em></td><td style="text-align: left">UART_THR <em>(Transmit Holding Register)</em></td></tr>
<tr><td style="text-align: left"><em>0x0004</em></td><td style="text-align: left">UART_DLH <em>(Divisor Latch High Register)</em></td></tr>
<tr><td style="text-align: left"><em>0x0008</em></td><td style="text-align: left">UART_IIR <em>(Interrupt Identity Register)</em></td></tr>
<tr><td style="text-align: left"><em>0x000C</em></td><td style="text-align: left">UART_LCR <em>(Line Control)</em></td></tr>
</tbody></table>
</div></div>
</p>
<p>Which means we can <a href="https://github.com/lupyuen2/wip-nuttx/blob/avaota/arch/arm64/src/qemu/qemu_boot.c#L269-L283"><strong>Print to UART</strong></a> like this‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>// Print `123` to UART0
*(volatile uint8_t *) 0x02500000 = &#39;1&#39;;
*(volatile uint8_t *) 0x02500000 = &#39;2&#39;;
*(volatile uint8_t *) 0x02500000 = &#39;3&#39;;</code></pre></div>
<p>Let‚Äôs do it in <strong>Arm64 Assembly</strong>: <a href="https://github.com/lupyuen2/wip-nuttx/commit/be2f1c55aa24eda9cd8652aa0bf38251335e9d01">arm64_head.S</a></p>
<div class="example-wrap"><pre class="language-text"><code>/* Bootloader starts NuttX here */
__start:
  add x13, x18, #0x16 /* &quot;MZ&quot;: Magic Number for Linux Kernel Header */
  b   real_start      /* Jump to Executable Code      */
  ...                 /* Omitted: Linux Kernel Header */

/* Executable Code begins here */
/* We print `123` to UART0     */
real_start:

  /* Load UART0 Base Address into Register X15 */
  mov  x15, #0x02500000

  /* Load character `1` into Register W16 */
  mov  w16, #0x31

  /* Store the lower byte from Register W16 (`1`) to UART0 Base Address */
  strb w16, [x15]

  /* Load and Store the lower byte from Register W16 (`2`) to UART0 Base Address */
  mov  w16, #0x32
  strb w16, [x15]

  /* Load and Store the lower byte from Register W16 (`3`) to UART0 Base Address */
  mov  w16, #0x33
  strb w16, [x15]</code></pre></div>
<p>Rebuild NuttX and recopy <strong><code>nuttx.bin</code></strong> to MicroSD, overwriting the <strong><code>Image</code></strong> file. NuttX boot and <a href="https://gist.github.com/lupyuen/14188c44049a14e3581523c593fdf2d8"><strong>prints <code>123</code> yay</strong></a>!</p>
<div class="example-wrap"><pre class="language-bash"><code>read /Image addr=40800000
Kernel addr: 0x40800000
BL31: v2.5(debug):9241004a9
sunxi-arisc driver is starting
ERROR: Error initializing runtime service opteed_fast
123</code></pre></div>
<p>(Ignore the <em>opteed_fast</em> error)</p>
<p>Address Independent Code</p>
<h1 id="bootloader-log-says-that-start-address-is-0x40800000-we-change-it"><a class="doc-anchor" href="#bootloader-log-says-that-start-address-is-0x40800000-we-change-it">¬ß</a>5 Bootloader Log says that Start Address is 0x40800000. We change it</h1>
<p>https://gist.github.com/lupyuen/14188c44049a14e3581523c593fdf2d8</p>
<div class="example-wrap"><pre class="language-bash"><code>read /Image addr=40800000
Kernel addr: 0x40800000
BL31: v2.5(debug):9241004a9
sunxi-arisc driver is starting
ERROR: Error initializing runtime service opteed_fast
123</code></pre></div>
<p>TODO: LCD also</p>
<p>Change start address to 0x40800000</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/c38e1f7c014e1af648a33847fc795930ba995bca</li>
</ul>
<p>Fix Image Load Offset</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/be2f1c55aa24eda9cd8652aa0bf38251335e9d01</li>
</ul>
<p>CONFIG_ARCH_PGPOOL_PBASE should match pgram</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/eb33ac06f88dda557bc8ac97bec7d6cbad4ccb86</li>
</ul>
<h1 id="16650-uart-driver"><a class="doc-anchor" href="#16650-uart-driver">¬ß</a>6 16650 UART Driver</h1>
<p>Enable 16650 UART</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/0cde58d84c16f255cb12e5a647ebeee3b6a8dd5f</li>
</ul>
<p>Remove UART1</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/8fc8ed6ba84cfea86184f61d9c4d7c8e21329987</li>
</ul>
<p>UART Buffer overflows. Let‚Äôs wait for UART Ready:</p>
<p>Wait for 16550 UART to be ready to transmit</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/544323e7c0e66c4df0d1312d4837147d420bc19d</li>
</ul>
<p>Add boot logging</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/029056c7e0da092e4d3a211b5f5b22b7014ba333</li>
</ul>
<p>Prints more yay!</p>
<ul>
<li>https://gist.github.com/lupyuen/563ed00d3f6e9f7fb9b27268d4eae26b</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>- Ready to Boot Primary CPU
- Boot from EL2
- Boot from EL1
- Boot to C runtime for OS Initialize
AB</code></pre></div><h1 id="troubleboot-the-mmu-why-wont-it-start"><a class="doc-anchor" href="#troubleboot-the-mmu-why-wont-it-start">¬ß</a>7 Troubleboot the MMU. Why won‚Äôt it start?</h1>
<p>Enable Logging for Scheduler and MMU</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/6f98f8a7cd214baa07288f581e58725aa76e4e58</li>
</ul>
<p>Disable CONFIG_MMU_DUMP_PTE</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/27faa28d0e70b3cf488bccc8d4b95e08b60fde9e</li>
</ul>
<p>init_xlat_tables: mmap: virt 1082130432x phys 1082130432x size 4194304x</p>
<ul>
<li>https://gist.github.com/lupyuen/40b12ab106e890fb0706fabdbead09d9</li>
</ul>
<p>Fix MMU Logging</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/a4d1b7c9f37e331607f80f2ad4556904ecb69b9d</li>
</ul>
<p>Still stuck at: <code>enable_mmu_el1: Enable the MMU and data cache</code></p>
<ul>
<li>https://gist.github.com/lupyuen/544a5d8f3fab2ab7c9d06d2e1583f362</li>
</ul>
<h1 id="hmmm-the-peripheral-address-space-is-missing-uart0-will-crash"><a class="doc-anchor" href="#hmmm-the-peripheral-address-space-is-missing-uart0-will-crash">¬ß</a>8 Hmmm the Peripheral Address Space is missing. UART0 will crash!</h1>
<p>From <a href="https://linux-sunxi.org/File:A523_User_Manual_V1.1_merged_cleaned.pdf">A523 User Manual</a>, Memory Map: Page 42</p>
<div class="example-wrap"><pre class="language-text"><code>BROM &amp; SRAM
S_BROM 0x0000 0000---0x0000 AFFF 44 K

PCIE
PCIE_SLV 0x2000 0000---0x2FFF FFFF 256 MB

DRAM Space
DRAM SPACE 0x4000 0000---0x13FFF FFFF
4 GB
RISC-V core accesses theDRAM address:
0x4004 0000---0x7FFFFFFF</code></pre></div><h1 id="lets-fix-the-peripheral-address-space-0x0-to-0x40000000-1-gb"><a class="doc-anchor" href="#lets-fix-the-peripheral-address-space-0x0-to-0x40000000-1-gb">¬ß</a>9 Let‚Äôs fix the Peripheral Address Space: 0x0 to 0x40000000, 1 GB</h1>
<p>Add MMU Logging</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/9488ecb5d8eb199bdbe16adabef483cf9cf04843</li>
</ul>
<p>Remove PCI from MMU Regions</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/ca273d05e015089a33072997738bf588b899f8e7</li>
</ul>
<p>Set CONFIG_DEVICEIO_BASEADDR to 0x00000000, size 1 GB (0x40000000)</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/005900ef7e1a1480b8df975d0dcd190fbfc60a45</li>
</ul>
<p><code>up_allocate_kheap: heap_start=0x0x40843000, heap_size=0xfffffffffffbd000</code></p>
<ul>
<li>https://gist.github.com/lupyuen/ad4cec0dee8a21f3f404144be180fa14</li>
</ul>
<h1 id="whoa-heap-size-is-wrong-lets-find-out-why"><a class="doc-anchor" href="#whoa-heap-size-is-wrong-lets-find-out-why">¬ß</a>10 Whoa Heap Size is wrong! Let‚Äôs find out why</h1>
<p>Assert CONFIG_RAM_END &gt; g_idle_topstack</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/480bbc64af4ca64c104964c24f430c6de48326b5</li>
</ul>
<p>Assertion fails</p>
<ul>
<li>https://gist.github.com/lupyuen/5f97773dcafc345a3510851629095c92</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>up_allocate_kheap: CONFIG_RAM_END=0x40800000, g_idle_topstack=0x40843000
dump_assert_info: Assertion failed</code></pre></div><h1 id="oops-config_ram_end-is-too-small-lets-enlarge"><a class="doc-anchor" href="#oops-config_ram_end-is-too-small-lets-enlarge">¬ß</a>11 Oops CONFIG_RAM_END is too small. Let‚Äôs enlarge</h1>
<p>CONFIG_RAM_SIZE should match CONFIG_RAMBANK1_SIZE</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/c8fbc5b86c2bf1dd7b8243b301b0790115c9c4ca</li>
</ul>
<p>GIC Failed</p>
<ul>
<li>https://gist.github.com/lupyuen/3a7d1e791ac14905532db2d768ae230f</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>gic_validate_dist_version: No GIC version detect
arm64_gic_initialize: no distributor detected, giving up ret=-19</code></pre></div><h1 id="ah-we-forgot-the-gic-address"><a class="doc-anchor" href="#ah-we-forgot-the-gic-address">¬ß</a>12 Ah we forgot the GIC Address!</h1>
<p>From <a href="https://linux-sunxi.org/File:A523_User_Manual_V1.1_merged_cleaned.pdf">A523 User Manual</a>, Page 263</p>
<div class="example-wrap"><pre class="language-text"><code>Module Name Base Address Comments
GIC
GIC600_MON_4 0x03400000 General interrupt controller(23*64KB)

Register Name Offset Description
GICD_CTLR 0x00000 Distributor Control Register
GICR_CTLR_C0 0x60000 Redistributor Control Register
GICR_CTLR_C1 0x80000 Redistributor Control Register
GICR_CTLR_C2 0xA0000 Redistributor Control Register
GICR_CTLR_C3 0xC0000 Redistributor Control Register
GICR_CTLR_C4 0xE0000 Redistributor Control Register
GICR_CTLR_C5 0x100000 Redistributor Control Register
GICR_CTLR_C6 0x120000 Redistributor Control Register
GICR_CTLR_C7 0x140000 Redistributor Control Register
GICDA_CTLR 0x160000 Distributor Control Register</code></pre></div>
<p>Set Address of GICD, GICR</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/f3a26dbba69a0714bc91d0c345b8fba5e0835b76</li>
</ul>
<p>Disable MM Logging</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/10c7173b142f4a0480d742688c72499b76f66f83</li>
</ul>
<p>/system/bin/init is missing yay!</p>
<ul>
<li>https://gist.github.com/lupyuen/3c587ac0f32be155c8f9a9e4ca18676c</li>
</ul>
<h1 id="load-the-nuttx-apps-filesystem-into-ram"><a class="doc-anchor" href="#load-the-nuttx-apps-filesystem-into-ram">¬ß</a>13 Load the NuttX Apps Filesystem into RAM</h1>
<p>Remove HostFS for Semihosting</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/40c4ab530dad2b7db0f354a2fa4b5e0f5263fb4e</li>
</ul>
<p>OK the Initial Filesystem is no longer available:</p>
<ul>
<li>https://gist.github.com/lupyuen/e74c29049f20c76a2c4fe6f863d55507</li>
</ul>
<p>Add the Initial RAM Disk</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/cf5fe66b97f4526fb8dfc993415ac04ce96f4c13</li>
</ul>
<p>Enable Logging for RAM Disk</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/60007f1b97b6af4445c793904c30d65ebbebb337</li>
</ul>
<p><code>default_fatal_handler: (IFSC/DFSC) for Data/Instruction aborts: alignment fault</code></p>
<ul>
<li>https://gist.github.com/lupyuen/f10af7903461f44689203d0e02fb9949</li>
</ul>
<p>Our RAM Disk Copier is accessing misligned addresses. Let‚Äôs fix the alignment‚Ä¶</p>
<p>Align RAM Disk Address to 8 bytes. Search from Idle Stack Top instead of EDATA.</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/07d9c387a7cb06ccec53e20eecd0c4bb9bad7109</li>
</ul>
<p>Log the Mount Error</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/38538f99333868f85b67e2cb22958fe496e285d6</li>
</ul>
<p>Mounting of ROMFS fails</p>
<ul>
<li>https://gist.github.com/lupyuen/d12e44f653d5c5597ecae6845e49e738</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>nx_start_application: ret=-15
dump_assert_info: Assertion failed : at file: init/nx_bringup.c:361</code></pre></div>
<p>Which is‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>#define ENOTBLK             15
#define ENOTBLK_STR         &quot;Block device required&quot;</code></pre></div>
<p>Why is /dev/ram0 not a Block Device?</p>
<div class="example-wrap"><pre class="language-c"><code>$ grep INIT .config
# CONFIG_BOARDCTL_FINALINIT is not set
# CONFIG_INIT_NONE is not set
CONFIG_INIT_FILE=y
CONFIG_INIT_ARGS=&quot;&quot;
CONFIG_INIT_STACKSIZE=8192
CONFIG_INIT_PRIORITY=100
CONFIG_INIT_FILEPATH=&quot;/system/bin/init&quot;
CONFIG_INIT_MOUNT=y
CONFIG_INIT_MOUNT_SOURCE=&quot;/dev/ram0&quot;
CONFIG_INIT_MOUNT_TARGET=&quot;/system/bin&quot;
CONFIG_INIT_MOUNT_FSTYPE=&quot;romfs&quot;
CONFIG_INIT_MOUNT_FLAGS=0x1
CONFIG_INIT_MOUNT_DATA=&quot;&quot;</code></pre></div>
<p>We check the logs‚Ä¶</p>
<p>Enable Filesystem Logging</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/cc4dffd60fd223a7c1f6b513dc99e1fa98a48496</li>
</ul>
<p><code>Failed to find /dev/ram0</code></p>
<ul>
<li>https://gist.github.com/lupyuen/805c2be2a3333a90c96926a26ec2d8cc</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>find_blockdriver: pathname=&quot;/dev/ram0&quot;
find_blockdriver: ERROR: Failed to find /dev/ram0
nx_mount: ERROR: Failed to find block driver /dev/ram0
nx_start_application: ret=-15</code></pre></div>
<p>Is /dev/ram0 created? Ah we forgot to Mount the RAM Disk!</p>
<h1 id="mount-the-ram-disk"><a class="doc-anchor" href="#mount-the-ram-disk">¬ß</a>14 Mount the RAM Disk</h1>
<p>Let‚Äôs mount the RAM Disk‚Ä¶</p>
<p>Mount the RAM Disk</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/65ae74507e95189e96816161b0c1a820722ca8a2</li>
</ul>
<p>/system/bin/init starts successfully yay!</p>
<ul>
<li>https://gist.github.com/lupyuen/ccb645efa72f6793743c033fade0b3ac</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>qemu_bringup:
mount_ramdisk:
nx_start_application: ret=0
nx_start_application: Starting init task: /system/bin/init
nxtask_activate: /system/bin/init pid=4,TCB=0x408469f0
nxtask_exit: AppBringUp pid=3,TCB=0x40846190
board_app_initialize:
nx_start: CPU0: Beginning Idle Loop</code></pre></div>
<p>NSH Prompt won‚Äôt appear until we fix the UART Interrupt‚Ä¶</p>
<h1 id="fix-the-uart-interrupt"><a class="doc-anchor" href="#fix-the-uart-interrupt">¬ß</a>15 Fix the UART Interrupt</h1>
<p>From <a href="https://linux-sunxi.org/File:A523_User_Manual_V1.1_merged_cleaned.pdf">A523 User Manual</a>, Page 256</p>
<div class="example-wrap"><pre class="language-text"><code>Interrupt Number Interrupt Source Interrupt Vector Description
34 UART0 0x0088</code></pre></div>
<p>So we set the UART0 Interrupt‚Ä¶</p>
<p>Set UART0 Interrupt to 34</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/cd6da8f5378eb493528e57c61f887b6585ab8eaf</li>
</ul>
<p>Disable Logging for MM and Scheduler</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/6c5c1a5f9fb1c939d8e75a5e9544b1a5261165ee</li>
</ul>
<p>Disable MMU Debugging</p>
<ul>
<li>https://github.com/lupyuen2/wip-nuttx/commit/e5c1b0449d3764d63d447eb96eb7186a27f77c88</li>
</ul>
<p>NSH Prompt appears! And passes OSTest yay!</p>
<ul>
<li>https://gist.github.com/lupyuen/c2248e7537ca98333d47e33b232217b6</li>
</ul>
<h1 id="todo"><a class="doc-anchor" href="#todo">¬ß</a>16 TODO</h1>
<p><img src="https://lupyuen.org/images/testbot2-flow3.jpg" alt="Apache NuttX RTOS for Avaota-A1 SBC (Allwinner A527 SoC)" /></p>
<p><em>How about booting and testing NuttX on Avaota-A1 SBC?</em></p>
<p>Exactly! Here‚Äôs why Avaota-A1 SBC should run NuttX‚Ä¶</p>
<ul>
<li>
<p><strong>Avaota-A1</strong> has the latest Octa-Core Arm64 SoC: <strong>Allwinner A527</strong></p>
<p><em>(Bonus: There‚Äôs a tiny RISC-V Core inside)</em></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/rust5#nuttx-flat-mode-vs-kernel-mode"><strong>NuttX Kernel Build</strong></a> sounds ideal for Allwinner A527 SoC</p>
<p><em>(Instead of the restrictive Flat Build)</em></p>
</li>
<li>
<p><strong>Avaota-A1</strong> could be the first Arm64 Port of NuttX Kernel Build</p>
<p><a href="https://github.com/apache/nuttx/pull/15556"><em>(NXP i.MX93 might be another)</em></a></p>
</li>
<li>
<p><strong>SDWire MicroSD Multiplexer</strong>: Avaota SBC was previously the <strong>Test Server</strong>, now it becomes the <strong>Test Device</strong></p>
<p><em>(Porting NuttX gets a lot quicker)</em></p>
</li>
<li>
<p><strong>Open-Source RTOS</strong> <em>(NuttX)</em> tested on <strong>Open-Source Hardware</strong> <em>(Avaota-A1)</em> ‚Ä¶ Perfectly sensible!</p>
</li>
</ul>
<p>We‚Äôll take the NuttX Kernel Build for <a href="https://github.com/apache/nuttx/blob/master/boards/arm64/qemu/qemu-armv8a/configs/knsh/defconfig"><strong>QEMU Arm64</strong></a>, boot it on Avaota-A1 SBC. We‚Äôre making terrific progress with <strong>NuttX on Avaota SBC</strong>‚Ä¶</p>
<p><img src="https://lupyuen.org/images/testbot3-port.png" alt="NuttX on Avaota-A1" /></p>
<p><em>Isn‚Äôt it faster to port NuttX with U-Boot TFTP?</em></p>
<p>Yeah for RISC-V Ports we boot <a href="https://lupyuen.github.io/articles/starpro64#boot-nuttx-over-tftp"><strong>NuttX over TFTP</strong></a>. But Avaota U-Boot <a href="https://gist.github.com/lupyuen/366f1ffefc8231670ffd58a3b88ae8e5"><strong>doesn‚Äôt support TFTP</strong></a>, so it‚Äôs back to MicroSD sigh. (Pic below)</p>
<p>Well thankfully we have a <strong>MicroSD Multiplexer</strong> that will make MicroSD Swapping a lot easier! (Not forgetting our <a href="https://lupyuen.github.io/articles/testbot#power-up-our-oz64-sbc"><strong>Smart Power Plug</strong></a>)</p>
<h1 id="build-nuttx-for-avaota-a1"><a class="doc-anchor" href="#build-nuttx-for-avaota-a1">¬ß</a>17 Build NuttX for Avaota-A1</h1>
<p><a href="https://youtu.be/PxaMcmMAzlM">(Watch the <strong>Demo on YouTube</strong>)</a></p>
<p>Our Avaota-A1 SBC is connected to SDWire MicroSD Multiplexer and Smart Power Plug (pic above). So our Build Script will do <strong>everything</strong> for us:</p>
<ul>
<li>
<p>Copy NuttX to MicroSD</p>
</li>
<li>
<p>Swap MicroSD from our Test PC to SBC</p>
</li>
<li>
<p>Power up SBC and boot NuttX!</p>
</li>
</ul>
<p>See the Build Script:</p>
<ul>
<li>https://gist.github.com/lupyuen/a4ac110fb8610a976c0ce2621cbb8587</li>
</ul>
<div class="example-wrap"><pre class="language-bash"><code>## Build NuttX and Apps (NuttX Kernel Build)
git clone https://github.com/lupyuen2/wip-nuttx nuttx --branch avaota
git clone https://github.com/lupyuen2/wip-nuttx-apps apps --branch avaota
cd nuttx
tools/configure.sh qemu-armv8a:knsh
make -j
make -j export
pushd ../apps
./tools/mkimport.sh -z -x ../nuttx/nuttx-export-*.tar.gz
make -j import
popd

## Generate the Initial RAM Disk
genromfs -f initrd -d ../apps/bin -V &quot;NuttXBootVol&quot;

## Prepare a Padding with 64 KB of zeroes
head -c 65536 /dev/zero &gt;/tmp/nuttx.pad

## Append Padding and Initial RAM Disk to the NuttX Kernel
cat nuttx.bin /tmp/nuttx.pad initrd \
  &gt;Image

## Get the Home Assistant Token, copied from http://localhost:8123/profile/security
## token=xxxx
set +x  ##  Disable echo
. $HOME/home-assistant-token.sh
set -x  ##  Enable echo

set +x  ##  Disable echo
echo &quot;----- Power Off the SBC&quot;
curl \
    -X POST \
    -H &quot;Authorization: Bearer $token&quot; \
    -H &quot;Content-Type: application/json&quot; \
    -d &#39;{&quot;entity_id&quot;: &quot;automation.starpro64_power_off&quot;}&#39; \
    http://localhost:8123/api/services/automation/trigger
set -x  ##  Enable echo

## Copy NuttX Image to MicroSD
## No password needed for sudo, see below
scp Image thinkcentre:/tmp/Image
ssh thinkcentre ls -l /tmp/Image
ssh thinkcentre sudo /home/user/copy-image.sh

set +x  ##  Disable echo
echo &quot;----- Power On the SBC&quot;
curl \
    -X POST \
    -H &quot;Authorization: Bearer $token&quot; \
    -H &quot;Content-Type: application/json&quot; \
    -d &#39;{&quot;entity_id&quot;: &quot;automation.starpro64_power_on&quot;}&#39; \
    http://localhost:8123/api/services/automation/trigger
set -x  ##  Enable echo

## Wait for SBC to finish booting
sleep 30

set +x  ##  Disable echo
echo &quot;----- Power Off the SBC&quot;
curl \
    -X POST \
    -H &quot;Authorization: Bearer $token&quot; \
    -H &quot;Content-Type: application/json&quot; \
    -d &#39;{&quot;entity_id&quot;: &quot;automation.starpro64_power_off&quot;}&#39; \
    http://localhost:8123/api/services/automation/trigger
set -x  ##  Enable echo</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/6c0607daa0a8f37bda37cc80e76259ee">(See the <strong>Build Log</strong>)</a></p>
<p>(<strong>copy-image.sh</strong> is explained below)</p>
<h1 id="boot-nuttx-for-avaota-a1"><a class="doc-anchor" href="#boot-nuttx-for-avaota-a1">¬ß</a>18 Boot NuttX for Avaota-A1</h1>
<p><a href="https://youtu.be/PxaMcmMAzlM">(Watch the <strong>Demo on YouTube</strong>)</a></p>
<p>NuttX boots to NSH Shell. And passes OSTest yay!</p>
<p>Here‚Äôs the latest NuttX Boot Log:</p>
<ul>
<li>https://gist.github.com/lupyuen/c2248e7537ca98333d47e33b232217b6</li>
</ul>
<span style="font-size:60%">
<div class="example-wrap"><pre class="language-text"><code>[    0.000255][I]  _____     _           _____ _ _
[    0.006320][I] |   __|_ _| |_ ___ ___|  |  |_| |_
[    0.012456][I] |__   | | |  _| -_|  _|    -| | _|
[    0.018566][I] |_____|_  |_| |___|_| |__|__|_|_|
[    0.024719][I]       |___|
[    0.030820][I] ***********************************
[    0.036948][I]  SyterKit v0.4.0 Commit: e4c0651
[    0.042781][I]  github.com/YuzukiHD/SyterKit
[    0.048882][I] ***********************************
[    0.054992][I]  Built by: arm-none-eabi-gcc 13.2.1
[    0.061119][I]
[    0.063943][I] Model: AvaotaSBC Avaota A1 board.
[    0.069856][I] Core: Arm Octa-Core Cortex-A55 v65 r2p0
[    0.076356][I] Chip SID = 0300ff1071c048247590d120506d1ed4
[    0.083280][I] Chip type = A527M000000H Chip Version = 2
[    0.091391][I] PMU: Found AXP717 PMU, Addr 0x35
[    0.098200][I] PMU: Found AXP323 PMU
[    0.112870][I] DRAM BOOT DRIVE INFO: V0.6581
[    0.118326][I] Set DRAM Voltage to 1160mv
[    0.123524][I] DRAM_VCC set to 1160 mv
[    0.247920][I] DRAM retraining ten
[    0.266135][I] [AUTO DEBUG]32bit,2 ranks training success!
[    0.296290][I] Soft Training Version: T2.0
[    1.819657][I] [SOFT TRAINING] CLK=1200M Stable memtest pass
[    1.826565][I] DRAM CLK =1200 MHZ
[    1.830992][I] DRAM Type =8 (3:DDR3,4:DDR4,6:LPDDR2,7:LPDDR3,8:LPDDR4)
[    1.843100][I] DRAM SIZE =4096 MBytes, para1 = 310a, para2 = 10001000, tpr13 = 6061
[    1.853431][I] DRAM simple test OK.
[    1.858011][I] Init DRAM Done, DRAM Size = 4096M
[    2.278300][I] SMHC: sdhci0 controller initialized
[    2.305826][I]   Capacity: 59.48GB
[    2.310439][I] SHMC: SD card detected
[    2.319537][I] FATFS: read bl31.bin addr=48000000
[    2.339744][I] FATFS: read in 13ms at 5.92MB/S
[    2.345498][I] FATFS: read scp.bin addr=48100000
[    2.374729][I] FATFS: read in 22ms at 8.00MB/S
[    2.380481][I] FATFS: read extlinux/extlinux.conf addr=40020000
[    2.389436][I] FATFS: read in 1ms at 0.29MB/S
[    2.395095][I] FATFS: read splash.bin addr=40080000
[    2.403142][I] FATFS: read in 1ms at 12.66MB/S
[    3.193943][I] FATFS: read /Image addr=40800000
[    3.341455][I] FATFS: read in 143ms at 8.86MB/S
[    3.347308][I] FATFS: read /dtb/allwinner/sun55i-t527-avaota-a1.dtb addr=40400000
[    3.400140][I] FATFS: read in 19ms at 7.46MB/S
[    3.405891][I] FATFS: read /uInitrd addr=43000000
[    4.113508][I] FATFS: read in 702ms at 9.04MB/S
[    4.119356][I] Initrd load 0x43000000, Size 0x00632414
[    5.376346][W] FDT: bootargs is null, using extlinux.conf append.
[    5.688989][I] EXTLINUX: load extlinux done, now booting...
[    5.695984][I] ATF: Kernel addr: 0x40800000
[    5.701523][I] ATF: Kernel DTB addr: 0x40400000
[    5.891085][I] disable mmu ok...
[    5.895615][I] disable dcache ok...
[    5.900478][I] disable icache ok...
[    5.905342][I] free interrupt ok...
NOTICE:  BL31: v2.5(debug):9241004a9
NOTICE:  BL31: Built : 13:37:46, Nov 16 2023
NOTICE:  BL31: No DTB found.
NOTICE:  [SCP] :wait arisc ready....
NOTICE:  [SCP] :arisc version: []
NOTICE:  [SCP] :arisc startup ready
NOTICE:  [SCP] :arisc startup notify message feedback
NOTICE:  [SCP] :sunxi-arisc driver is starting
ERROR:   Error initializing runtime service opteed_fast
123- Ready to Boot Primary CPU
- Boot from EL2
- Boot from EL1
- Boot to C runtime for OS Initialize
ABarm64_mmu_init:
setup_page_tables:
enable_mmu_el1:
enable_mmu_el1: UP_MB
enable_mmu_el1: Enable the MMU and data cache
up_allocate_kheap: CONFIG_RAM_END=0x48000000, g_idle_topstack=0x40847000
qemu_bringup:
mount_ramdisk:
nx_start_application: ret=0
board_app_initialize:

NuttShell (NSH) NuttX-12.4.0
nsh&gt; uname -a
NuttX 12.4.0 6c5c1a5f9f-dirty Mar  8 2025 21:57:02 arm64 qemu-armv8a
nsh&gt; free
      total       used       free    maxused    maxfree  nused  nfree name
  125538304      33848  125504456      52992  125484976     58      5 Kmem
    4194304     245760    3948544               3948544               Page
nsh&gt; ps
  PID GROUP PRI POLICY   TYPE    NPX STATE    EVENT     SIGMASK            STACK    USED FILLED COMMAND
    0     0   0 FIFO     Kthread   - Ready              0000000000000000 0008176 0000928  11.3%  Idle_Task
    1     0 192 RR       Kthread   - Waiting  Semaphore 0000000000000000 0008112 0000992  12.2%  hpwork 0x40834568 0x408345b8
    2     0 100 RR       Kthread   - Waiting  Semaphore 0000000000000000 0008112 0000992  12.2%  lpwork 0x408344e8 0x40834538
    4     4 100 RR       Task      - Running            0000000000000000 0008128 0002192  26.9%  /system/bin/init
nsh&gt; ls -l /dev
/dev:
 crw-rw-rw-           0 console
 crw-rw-rw-           0 null
 brw-rw-rw-    16777216 ram0
 crw-rw-rw-           0 ttyS0
 crw-rw-rw-           0 zero
nsh&gt; hello
Hello, World!!
nsh&gt; getprime
Set thread priority to 10
Set thread policy to SCHED_RR
Start thread #0
thread #0 started, looking for primes &lt; 10000, doing 10 run(s)
thread #0 finished, found 1230 primes, last one was 9973
Done
getprime took 162 msec
nsh&gt; hello
Hello, World!!
nsh&gt; getprime
Set thread priority to 10
Set thread policy to SCHED_RR
Start thread #0
thread #0 started, looking for primes &lt; 10000, doing 10 run(s)
thread #0 finished, found 1230 primes, last one was 9973
Done
getprime took 162 msec
nsh&gt; ostest
...
Final memory usage:
VARIABLE  BEFORE   AFTER
======== ======== ========
arena        a000    26000
ordblks         2        4
mxordblk     6ff8    1aff8
uordblks     27e8     6700
fordblks     7818    1f900
user_main: Exiting
ostest_main: Exiting with status 0
nsh&gt;</code></pre></div></span>
<p>How did we get here? Let‚Äôs walk through the steps‚Ä¶</p>
<h1 id="allwinner-a527-docs"><a class="doc-anchor" href="#allwinner-a527-docs">¬ß</a>19 Allwinner A527 Docs</h1>
<p>We used these docs (A527 is a variant of A523)</p>
<ul>
<li>https://linux-sunxi.org/A523</li>
<li>https://linux-sunxi.org/File:A527_Datasheet_V0.93.pdf</li>
<li>https://linux-sunxi.org/File:A523_User_Manual_V1.1_merged_cleaned.pdf</li>
</ul>
<h1 id="work-in-progress"><a class="doc-anchor" href="#work-in-progress">¬ß</a>20 Work In Progress</h1>
<p>We take NuttX for Arm64 QEMU knsh (Kernel Build) and tweak it iteratively for Avaota-A1 SBC, based on Allwinner A527 SoC‚Ä¶</p>
<h2 id="lets-make-our-build-test-cycle-quicker-we-do-passwordless-sudo-for-flipping-our-sdwire-mux"><a class="doc-anchor" href="#lets-make-our-build-test-cycle-quicker-we-do-passwordless-sudo-for-flipping-our-sdwire-mux">¬ß</a>20.1 Let‚Äôs make our Build-Test Cycle quicker. We do Passwordless Sudo for flipping our SDWire Mux</h2>
<p>SDWire Mux needs plenty of Sudo Passwords to flip the mux, mount the filesystem, copy to MicroSD.</p>
<p>Let‚Äôs make it Sudo Password-Less with visudo: https://help.ubuntu.com/community/Sudoers</p>
<div class="example-wrap"><pre class="language-bash"><code>## Start the Sudoers Editor
sudo visudo

## Add this line:
user ALL=(ALL) NOPASSWD: /home/user/copy-image.sh</code></pre></div>
<p>Edit /home/user/copy-image.sh‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>set -e  ## Exit when any command fails
set -x  ## Echo commands
whoami  ## I am root!

## Copy /tmp/Image to MicroSD
sd-mux-ctrl --device-serial=sd-wire_02-09 --ts
sleep 5
mkdir -p /tmp/sda1
mount /dev/sda1 /tmp/sda1
cp /tmp/Image /tmp/sda1/
ls -l /tmp/sda1

## Unmount MicroSD and flip it to the Test Device (Avaota-A1 SBC)
umount /tmp/sda1
sd-mux-ctrl --device-serial=sd-wire_02-09 --dut</code></pre></div>
<p>(Remember to <code>chmod +x /home/user/copy-image.sh</code>)</p>
<p>Now we can run copy-image.sh without a password yay!</p>
<div class="example-wrap"><pre class="language-bash"><code>## Sudo will NOT prompt for password yay!
sudo /home/user/copy-image.sh

## Also works over SSH: Copy NuttX Image to MicroSD
## No password needed for sudo yay!
scp nuttx.bin thinkcentre:/tmp/Image
ssh thinkcentre ls -l /tmp/Image
ssh thinkcentre sudo /home/user/copy-image.sh</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/a4ac110fb8610a976c0ce2621cbb8587">(See the <strong>Build Script</strong>)</a></p>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>21 What‚Äôs Next</h1>
<p>TODO</p>
<p>Special Thanks to <a href="https://lupyuen.org/articles/sponsor"><strong>My Sponsors</strong></a> for supporting my writing. Your support means so much to me üôè</p>
<ul>
<li>
<p><a href="https://lupyuen.org/articles/sponsor"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="TODO"><strong>Discuss this article on Hacker News</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-starpro64"><strong>My Current Project: ‚ÄúApache NuttX RTOS for StarPro64 EIC7700X‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/nuttx-sg2000"><strong>My Other Project: ‚ÄúNuttX for Oz64 SG2000‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/nuttx-ox64"><strong>Older Project: ‚ÄúNuttX for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/pinephone-nuttx"><strong>Olderer Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.org"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.org/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://codeberg.org/lupyuen/lupyuen.org/src/branch/master/src/avaota.md"><strong>lupyuen.org/src/avaota.md</strong></a></p>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>