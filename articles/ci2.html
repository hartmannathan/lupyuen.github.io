<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Your very own Build Farm for Apache NuttX RTOS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Your very own Build Farm for Apache NuttX RTOS" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/ci2-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.codeberg.page/articles/ci2.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Your very own Build Farm for Apache NuttX RTOS</h1>
    <nav id="TOC"><ul>
<li><a href="#target-groups-in-nuttx">1 Target Groups in NuttX</a><ul></ul></li>
<li><a href="#build-nuttx-for-one-target-group">2 Build NuttX for One Target Group</a><ul></ul></li>
<li><a href="#build-nuttx-for-all-target-groups">3 Build NuttX for All Target Groups</a><ul></ul></li>
<li><a href="#find-errors-and-warnings">4 Find Errors and Warnings</a><ul></ul></li>
<li><a href="#whats-next">5 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>20 Nov 2024</em></p>
<p><img src="https://lupyuen.github.io/images/ci2-title.jpg" alt="TODO" /></p>
<p><a href="TODO"><strong>Refurbished Ubuntu PCs</strong></a> have become quite affordable ($??? pic above). Can we turn them into a <strong>(Low-Cost) Build Farm</strong> for <a href="TODO"><strong>Apache NuttX RTOS</strong></a>?</p>
<p><em>Why not do all this in GitHub Actions? It‚Äôs free ain‚Äôt it?</em></p>
<p>We learnt a Painful Lesson: <strong>Freebies Won‚Äôt Last Forever!</strong></p>
<p>It‚Äôs probably a bad idea to be locked-in and over-dependent on a <strong>Single Provider for Continuous Integration</strong>. That‚Äôs why we‚Äôre exploring alternatives‚Ä¶</p>
<ul>
<li>TODO: Reducing GitHub Runners</li>
</ul>
<p><img src="https://lupyuen.github.io/images/ci2-log.jpg" alt="TODO" /></p>
<h1 id="target-groups-in-nuttx"><a class="doc-anchor" href="#target-groups-in-nuttx">¬ß</a>1 Target Groups in NuttX</h1>
<p>We‚Äôre creating a Build Farm that will compile all Target Groups in NuttX (pic above)</p>
<ul>
<li>TODO: Report</li>
</ul>
<p><em>What‚Äôs a Target Group?</em></p>
<div class="example-wrap"><pre class="language-bash"><code>## Select the NuttX Target and compile it
tools/configure.sh rv-virt:nsh
make
</code></pre></div>
<p>Remember this <strong>configure.sh</strong> thingy? Let‚Äôs call <strong>rv-virt:nsh</strong> a NuttX Target. There are <a href="TODO"><strong>??? NuttX Targets</strong></a>.</p>
<p>To compile all ??? Targets, we lump them into <strong>Target Groups</strong> (so they‚Äôre easier to track)</p>
<ul>
<li>
<p><a href="https://github.com/apache/nuttx/blob/master/tools/ci/testlist/arm-01.dat"><em>arm-01</em></a> ‚Ä¶ <em>arm-14</em></p>
</li>
<li>
<p><em>risc-v-01</em> ‚Ä¶ <em>risc-v-06</em></p>
</li>
<li>
<p><em>sim-01</em> ‚Ä¶ <em>sim-03</em></p>
</li>
<li>
<p><em>xtensa-01</em> ‚Ä¶ <em>xtensa-02</em></p>
</li>
<li>
<p><em>arm64-01</em>, <em>x86_64-01</em>, <a href="TODO"><em>other</em></a></p>
<p><a href="TODO">(Check out the <strong>Complete List</strong>)</a></p>
</li>
</ul>
<p><em>What‚Äôs inside the Target Groups?</em></p>
<p><a href="https://github.com/apache/nuttx/blob/master/tools/ci/testlist/arm-01.dat"><em>arm-01</em></a> has BeagleBone Black and Sony Spresense‚Ä¶</p>
<p>TODO</p>
<p><a href="https://github.com/apache/nuttx/blob/master/tools/ci/testlist/arm-06.dat"><em>arm-06</em></a> has RP2040 Boards‚Ä¶</p>
<p>TODO</p>
<p><a href="TODO"><em>risc-v-01</em></a> has ???</p>
<p><em>How are Target Groups defined?</em></p>
<p>Every NuttX Target has its own <strong>defconfig</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>$ cd nuttx ; find . -name defconfig
./boards/arm/am335x/beaglebone-black/configs/nsh/defconfig
./boards/arm/cxd56xx/spresense/configs/usbmsc/defconfig
./boards/arm/cxd56xx/spresense/configs/lte/defconfig
./boards/arm/cxd56xx/spresense/configs/wifi/defconfig
...
</code></pre></div>
<p>So NuttX uses a <strong>Wildcard Pattern</strong> to select the <strong>defconfig</strong> (as a NuttX Target): <a href="https://github.com/apache/nuttx/blob/master/tools/ci/testlist/arm-05.dat">tools/ci/testlist/arm-05.dat</a></p>
<div class="example-wrap"><pre class="language-text"><code>## arm-05 Target Group contains:
## boards/arm/[m-q]*/*/configs/*/defconfig
## Compile with `make` and GCC Toolchain
/arm/[m-q]*,CONFIG_ARM_TOOLCHAIN_GNU_EABI

## Except for these: Compile with CMake instead
CMake,arduino-nano-33ble:nsh

## Exclude this Target from the build
-moxa:nsh
</code></pre></div>
<p>TODO: <a href="https://docs.google.com/spreadsheets/d/1OdBxe30Sw3yhH0PyZtgmefelOL56fA6p26vMgHV0MRY/edit?gid=0#gid=0">NuttX Builds for CI</a></p>
<p><img src="https://lupyuen.github.io/images/ci2-flow2.jpg" alt="TODO" /></p>
<h1 id="build-nuttx-for-one-target-group"><a class="doc-anchor" href="#build-nuttx-for-one-target-group">¬ß</a>2 Build NuttX for One Target Group</h1>
<p>Suppose we wish to compile the Targets for <em>arm-01</em>‚Ä¶</p>
<p>TODO: Pic of targets</p>
<p>Here are the steps‚Ä¶</p>
<ol>
<li>
<p>Install Docker</p>
<p>TODO</p>
</li>
<li>
<p>Download the Docker Image for NuttX</p>
<div class="example-wrap"><pre class="language-bash"><code>sudo docker pull \
  ghcr.io/apache/nuttx/apache-nuttx-ci-linux:latest
</code></pre></div></li>
<li>
<p>Start the Docker Container</p>
<div class="example-wrap"><pre class="language-bash"><code>sudo docker run -it \
  ghcr.io/apache/nuttx/apache-nuttx-ci-linux:latest \
  /bin/bash -c &quot;...&quot;
</code></pre></div></li>
<li>
<p>Check out the <strong>master</strong> branch of <strong>nuttx</strong> repo</p>
<div class="example-wrap"><pre class="language-bash"><code>git clone \
  https://github.com/apache/nuttx
</code></pre></div></li>
<li>
<p>Do the same for <strong>nuttx-apps</strong> repo</p>
<div class="example-wrap"><pre class="language-bash"><code>git clone \
  https://github.com/apache/nuttx-apps \
  apps
</code></pre></div></li>
<li>
<p>Inside the Docker Container: Build the Targets for <em>arm-01</em></p>
<div class="example-wrap"><pre class="language-bash"><code>cd nuttx/tools/ci
./cibuild.sh \
  -c -A -N -R \
  testlist/arm-01.dat
</code></pre></div></li>
<li>
<p>Wait for <em>arm-01</em> to complete</p>
<p>(About 1.5 hours)</p>
</li>
</ol>
<p>Put everything together: <a href="https://github.com/lupyuen/nuttx-release/blob/main/run-job.sh">run-job.sh</a></p>
<div class="example-wrap"><pre class="language-bash"><code>## Build a NuttX Target Group with Docker
## Parameter is the Target Group, like &quot;arm-01&quot;
job=$1

## TODO: Install Docker

## Download the Docker Image for NuttX
sudo docker pull \
  ghcr.io/apache/nuttx/apache-nuttx-ci-linux:latest

## Inside the Docker Container:
## Build the Target Group 
sudo docker run -it \
  ghcr.io/apache/nuttx/apache-nuttx-ci-linux:latest \
  /bin/bash -c &quot;
  cd ;
  pwd ;
  git clone https://github.com/apache/nuttx ;
  git clone https://github.com/apache/nuttx-apps apps ;
  pushd nuttx ; echo NuttX Source: https://github.com/apache/nuttx/tree/\$(git rev-parse HEAD) ; popd ;
  pushd apps  ; echo NuttX Apps: https://github.com/apache/nuttx-apps/tree/\$(git rev-parse HEAD) ; popd ;
  cd nuttx/tools/ci ;
  ./cibuild.sh -c -A -N -R testlist/$job.dat ;
&quot;
</code></pre></div>
<p>We run it like this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>$ sudo ./run-job.sh arm-01
NuttX Source: https://github.com/apache/nuttx/tree/9c1e0d3d640a297cab9f2bfeedff02f6ce7a8162
NuttX Apps: https://github.com/apache/nuttx-apps/tree/52a50ea72a2d88ff5b7f3308e1d132d0333982e8
====================================================================================
Configuration/Tool: pcduino-a10/nsh,CONFIG_ARM_TOOLCHAIN_GNU_EABI
2024-10-20 17:38:10
------------------------------------------------------------------------------------
  Cleaning...
  Configuring...
  Disabling CONFIG_ARM_TOOLCHAIN_GNU_EABI
  Enabling CONFIG_ARM_TOOLCHAIN_GNU_EABI
  Building NuttX...
arm-none-eabi-ld: warning: /root/nuttx/nuttx has a LOAD segment with RWX permissions
  Normalize pcduino-a10/nsh
====================================================================================
Configuration/Tool: beaglebone-black/lcd,CONFIG_ARM_TOOLCHAIN_GNU_EABI
2024-10-20 17:39:09
</code></pre></div>
<p><em>What about building a Single Target?</em></p>
<p>Suppose we wish to build <strong>ox64:nsh</strong>. Just change this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>cd nuttx/tools/ci ;
./cibuild.sh -c -A -N -R testlist/$job.dat ;
</code></pre></div>
<p>To this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>cd nuttx ;
tools/configure.sh ox64:nsh ;
make ;
</code></pre></div>
<p>Now we scale up‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/ci2-flow.jpg" alt="TODO" /></p>
<h1 id="build-nuttx-for-all-target-groups"><a class="doc-anchor" href="#build-nuttx-for-all-target-groups">¬ß</a>3 Build NuttX for All Target Groups</h1>
<p><em>What if we‚Äôre compiling NuttX for All Target Groups? From <em>arm-01</em> to <em>arm-14</em>?</em></p>
<p>Let‚Äôs loop through all the Target Groups and compile them‚Ä¶</p>
<ul>
<li>
<p>For Each Target Group: <em>arm-01</em> ‚Ä¶ <em>arm-14</em></p>
</li>
<li>
<p>Build the Target Group</p>
</li>
<li>
<p>Check for Errors and Warnings</p>
</li>
<li>
<p>Upload the Build Log</p>
</li>
</ul>
<p>TODO: <a href="https://gist.github.com/nuttxpr">Here‚Äôs the CI Output Log</a></p>
<p>Our script becomes more sophisticated:  <a href="https://github.com/lupyuen/nuttx-release/blob/main/run-ci.sh">run-ci.sh</a></p>
<div class="example-wrap"><pre class="language-bash"><code>## Repeat Forever for All Target Groups
for (( ; ; )); do
  for job in \
    arm-01 arm-02 arm-03 arm-04 \
    arm-05 arm-06 arm-07 arm-08 \
    arm-09 arm-10 arm-11 arm-12 \
    arm-13 arm-14
  do
    ## Build the Target Group
    ## and find Errors / Warnings
    run_job $job
    clean_log
    find_messages

    ## Get the hashes for NuttX and Apps
    nuttx_hash=$(grep --only-matching -E &quot;nuttx/tree/[0-9a-z]+&quot; $log_file | grep --only-matching -E &quot;[0-9a-z]+$&quot;)
    apps_hash=$(grep --only-matching -E &quot;nuttx-apps/tree/[0-9a-z]+&quot; $log_file | grep --only-matching -E &quot;[0-9a-z]+$&quot;)

    ## Upload the log
    upload_log $job $nuttx_hash $apps_hash
    sleep 10
  done
done
</code></pre></div>
<p><a href="TODO">(<strong>clean_log</strong> is here)</a></p>
<p><strong>run_job</strong> will compile a single Target Group‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Build the Target Group, like &quot;arm-01&quot;
function run_job {
  local job=$1
  pushd /tmp
  script $log_file \
    $script_option \
    &quot;$script_dir/run-job.sh $job&quot;
  popd
}
</code></pre></div>
<p>Which calls the script we‚Äôve seen earlier: <a href="TODO"><strong>run-job.sh</strong></a></p>
<p><strong>upload_log</strong> will upload the log (to GitHub Gist) for further processing‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Upload to GitHub Gist
function upload_log {
  local job=$1
  local nuttx_hash=$2
  local apps_hash=$3
  cat $log_file | \
    gh gist create \
    --public \
    --desc &quot;[$job] CI Log for nuttx @ $nuttx_hash / nuttx-apps @ $apps_hash&quot; \
    --filename &quot;ci-$job.log&quot;
}
</code></pre></div>
<p>TODO: The outcome is here</p>
<p>Let‚Äôs talk about Errors and Warnings..</p>
<p><img src="https://lupyuen.github.io/images/ci2-flow3.jpg" alt="TODO" /></p>
<h1 id="find-errors-and-warnings"><a class="doc-anchor" href="#find-errors-and-warnings">¬ß</a>4 Find Errors and Warnings</h1>
<p>In the script above, we call <strong>find_messages</strong> to search for Errors and Warnings:</p>
<div class="example-wrap"><pre class="language-bash"><code>## Search for Errors and Warnings
function find_messages {
  local tmp_file=/tmp/release-tmp.log
  local msg_file=/tmp/release-msg.log
  local pattern=&#39;^(.*):(\d+):(\d+):\s+(warning|fatal error|error):\s+(.*)$&#39;
  grep -P &quot;$pattern&quot; $log_file \
    | uniq \
    &gt; $msg_file
  cat $msg_file $log_file &gt;$tmp_file
  mv $tmp_file $log_file
}
</code></pre></div>
<p>And inserts the Errors and Warnings into the top of the Log File.</p>
<p>TODO: <a href="TODO">(based on this <strong>GCC Pattern</strong>)</a></p>
<p>TODO: GCC Matcher is not perfect: CMake, strangely simplistic</p>
<p><a href="https://gist.github.com/nuttxpr/353f4c035473cdf67afe0d76496ca950#file-ci-arm-11-log-L421-L451">CMake Error</a></p>
<div class="example-wrap"><pre class="language-text"><code>====================================================================================
Cmake in present: stm32f334-disco/nsh,CONFIG_ARM_TOOLCHAIN_CLANG
Configuration/Tool: stm32f334-disco/nsh,CONFIG_ARM_TOOLCHAIN_CLANG
2024-10-22 20:31:16
------------------------------------------------------------------------------------
  Cleaning...
  Configuring...
CMake Warning at cmake/nuttx_kconfig.cmake:171 (message):
  Kconfig Configuration Error: warning: STM32_HAVE_HRTIM1_PLLCLK (defined at
  arch/arm/src/stm32/Kconfig:8109) has direct dependencies STM32_HRTIM &amp;&amp;
  ARCH_CHIP_STM32 &amp;&amp; ARCH_ARM with value n, but is currently being y-selected
  by the following symbols:

   - STM32_STM32F33XX (defined at arch/arm/src/stm32/Kconfig:1533), with value y, direct dependencies ARCH_CHIP_STM32 &amp;&amp; ARCH_ARM (value: y), and select condition ARCH_CHIP_STM32 &amp;&amp; ARCH_ARM (value: y)

Call Stack (most recent call first):
  CMakeLists.txt:322 (nuttx_olddefconfig)


  Select HOST_LINUX=y
CMake Warning at cmake/nuttx_kconfig.cmake:192 (message):
  Kconfig Configuration Error: warning: STM32_HAVE_HRTIM1_PLLCLK (defined at
  arch/arm/src/stm32/Kconfig:8109) has direct dependencies STM32_HRTIM &amp;&amp;
  ARCH_CHIP_STM32 &amp;&amp; ARCH_ARM with value n, but is currently being y-selected
  by the following symbols:

   - STM32_STM32F33XX (defined at arch/arm/src/stm32/Kconfig:1533), with value y, direct dependencies ARCH_CHIP_STM32 &amp;&amp; ARCH_ARM (value: y), and select condition ARCH_CHIP_STM32 &amp;&amp; ARCH_ARM (value: y)

Call Stack (most recent call first):
  cmake/nuttx_sethost.cmake:107 (nuttx_setconfig)
  CMakeLists.txt:333 (nuttx_sethost)
</code></pre></div>
<p><img src="https://lupyuen.github.io/nuttx-metrics/github-fulltime-runners.png" alt="TODO" /></p>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>5 What‚Äôs Next</h1>
<p><em>Huh? We‚Äôre expecting a Build Farm, not a Build Server?</em></p>
<p>Just add a second Ubuntu PC, partition the Target Groups across the PCs. And we‚Äôll have a Build Farm!</p>
<p><em>What about macOS?</em></p>
<p>macOS compiles NuttX a little differently from Linux. <a href="https://github.com/NuttX/nuttx/actions/runs/11470464140/job/31924857916#step:7:1448">(See <strong>sim/rpserver_virtio</strong>)</a></p>
<p>BUT‚Ä¶ GitHub charges a <a href="TODO"><strong>10x Premium for macOS Runners</strong></a>. That‚Äôs why <a href="TODO"><strong>we shut them down</strong></a> to cut costs. <a href="https://github.com/apache/nuttx/issues/14376#issuecomment-2428086912">(Pic above)</a></p>
<p>Probably cheaper to buy our own Refurbished Mac Mini (Intel only), running NuttX Jobs all day?</p>
<p><a href="TODO">(Sorry the NuttX Jobs won‚Äôt run on <strong>M1 Mac</strong>)</a></p>
<div class="example-wrap"><pre class="language-text"><code>https://gist.github.com/nuttxpr

https://docs.docker.com/engine/install/ubuntu/
sudo docker pull \
    ghcr.io/apache/nuttx/apache-nuttx-ci-linux:latest

https://lupyuen.github.io/articles/pr#appendix-downloading-the-docker-image-for-nuttx-ci

sudo docker run -it ghcr.io/apache/nuttx/apache-nuttx-ci-linux:latest /bin/bash 

root@f38a12771a26:~/nuttx/tools/ci# date ; ./cibuild.sh -c -A -N -R testlist/arm-01.dat ; date
Fri Oct 18 05:58:29 UTC 2024
...
Fri Oct 18 07:24:36 UTC 2024

arm-01: 1 hour 12 mins at GitHub
https://github.com/apache/nuttx/actions/runs/11387572001/job/31692229034

1 hour 26 mins at Ubuntu PC

Intel mac mini
security risk, not docker
firewall

https://github.com/apache/nuttx/blob/master/.github/gcc.json

^(.*):(\\d+):(\\d+):\\s+(warning|fatal error|error):\\s+(.*)$
</code></pre></div>
<p>TODO</p>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/ci2.md"><strong>lupyuen.github.io/src/ci2.md</strong></a></p>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>