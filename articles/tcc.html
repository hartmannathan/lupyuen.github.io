<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>TCC RISC-V Compiler runs in the Web Browser (thanks to Zig Compiler)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="TCC RISC-V Compiler runs in the Web Browser (thanks to Zig Compiler)" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/tcc-title.png">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.codeberg.page/articles/tcc.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">TCC RISC-V Compiler runs in the Web Browser (thanks to Zig Compiler)</h1>
    <nav id="TOC"><ul>
<li><a href="#tcc-in-the-web-browser">1 TCC in the Web Browser</a><ul></ul></li>
<li><a href="#zig-compiles-tccc-to-webassembly">2 Zig compiles TCCC to WebAssembly</a><ul></ul></li>
<li><a href="#posix-for-webassembly">3 POSIX for WebAssembly</a><ul></ul></li>
<li><a href="#file-input-and-output">4 File Input and Output</a><ul></ul></li>
<li><a href="#fearsome-fprintf-and-friends">5 Fearsome fprintf and Friends</a><ul></ul></li>
<li><a href="#test-with-apache-nuttx-rtos">6 Test with Apache NuttX RTOS</a><ul></ul></li>
<li><a href="#tcc-generates-64-bit-risc-v-code">7 TCC generates 64-bit RISC-V code</a><ul></ul></li>
<li><a href="#compile-tcc-with-zig-compiler">8 Compile TCC with Zig Compiler</a><ul></ul></li>
<li><a href="#compile-tcc-to-webassembly-with-zig-compiler">9 Compile TCC to WebAssembly with Zig Compiler</a><ul></ul></li>
<li><a href="#missing-functions-in-tcc-webassembly">10 Missing Functions in TCC WebAssembly</a><ul></ul></li>
<li><a href="#test-the-tcc-webassembly-with-nodejs">11 Test the TCC WebAssembly with NodeJS</a><ul></ul></li>
<li><a href="#test-the-tcc-webassembly-in-a-web-browser">12 Test the TCC WebAssembly in a Web Browser</a><ul></ul></li>
<li><a href="#fix-the-missing-functions">13 Fix the Missing Functions</a><ul></ul></li>
<li><a href="#tcc-webassembly-runs-ok-in-a-web-browser">14 TCC WebAssembly runs OK in a Web Browser!</a><ul></ul></li>
<li><a href="#verify-the-tcc-output">15 Verify the TCC Output</a><ul></ul></li>
<li><a href="#fearsome-fprintf-and-friends-1">16 Fearsome fprintf and Friends</a><ul></ul></li>
<li><a href="#test-tcc-output-with-nuttx">17 Test TCC Output with NuttX</a><ul></ul></li>
<li><a href="#how-nuttx-build-links-a-nuttx-app">18 How NuttX Build links a NuttX App</a><ul></ul></li>
<li><a href="#fix-missing-printf-in-nuttx-app">19 Fix Missing <code>printf</code> in NuttX App</a><ul></ul></li>
<li><a href="#ecall-for-nuttx-system-call">20 ECALL for NuttX System Call</a><ul></ul></li>
<li><a href="#whats-next">21 What‚Äôs Next</a><ul></ul></li>
<li><a href="#appendix-analysis-of-missing-functions">22 Appendix: Analysis of Missing Functions</a><ul>
<li><a href="#semaphore-functions">22.1 Semaphore Functions</a><ul></ul></li>
<li><a href="#standard-library">22.2 Standard Library</a><ul></ul></li>
<li><a href="#time-functions">22.3 Time Functions</a><ul></ul></li>
<li><a href="#math-functions">22.4 Math Functions</a><ul></ul></li>
<li><a href="#varargs-functions">22.5 Varargs Functions</a><ul></ul></li>
<li><a href="#filesystem-functions">22.6 Filesystem Functions</a><ul></ul></li>
<li><a href="#file-io-functions">22.7 File I/O Functions</a><ul></ul></li>
<li><a href="#string-functions">22.8 String Functions</a><ul></ul></li></ul></li></ul></nav><p>üìù <em>7 Feb 2024</em></p>
<p><img src="https://lupyuen.github.io/images/tcc-title.png" alt="TODO" /></p>
<p><em>TCC is a Tiny C Compiler for 64-bit RISC-V (and other platforms)‚Ä¶</em></p>
<p><em>Can we run TCC in a Web Browser?</em></p>
<p>Let‚Äôs do it! We‚Äôll compile <a href="https://github.com/sellicott/tcc-riscv32"><strong>TCC (Tiny C Compiler)</strong></a> from C to WebAssembly with <a href="https://ziglang.org/"><strong>Zig Compiler</strong></a>.</p>
<p>In this article, we talk about the tricky bits of the TCC Porting from <strong>C to WebAssembly</strong>‚Ä¶</p>
<p>TODO</p>
<p><a href="https://en.wikipedia.org/wiki/Turing_(programming_language)">(Not to be confused with <strong>TCC from the 80‚Äôs</strong>)</a></p>
<p><em>Why are we doing this?</em></p>
<p>TODO</p>
<p>Today we can run <a href="https://lupyuen.github.io/articles/tinyemu2"><strong>Apache NuttX RTOS in a Web Browser</strong></a>. (With WebAssembly + Emscripten + 64-bit RISC-V)</p>
<p>(<strong>Real-Time Operating System</strong> in Web Browser on General-Purpose Operating System!)</p>
<p>What if we could allow NuttX Apps to be compiled and tested in the Web Browser?</p>
<ol>
<li>
<p>We type a C Program into a HTML Textbox‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>int main(int argc, char *argv[]) {
  printf(&quot;Hello, World!!\n&quot;);
  return 0;
}
</code></pre></div></li>
<li>
<p>Run TCC in the Web Browser to compile the C Program into an ELF Executable (64-bit RISC-V)</p>
</li>
<li>
<p>Copy the ELF Executable to the NuttX Filesystem (via WebAssembly)</p>
</li>
<li>
<p>NuttX runs our ELF Executable inside the Web Browser</p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/tcc-web.png" alt="TCC RISC-V Compiler: Compiled to WebAssembly with Zig Compiler" /></p>
<p><a href="https://lupyuen.github.io/tcc-riscv32-wasm/"><em>(Try the <strong>Online Demo</strong>)</em></a></p>
<h1 id="tcc-in-the-web-browser"><a href="#tcc-in-the-web-browser">1 TCC in the Web Browser</a></h1>
<p>TODO</p>
<h1 id="zig-compiles-tccc-to-webassembly"><a href="#zig-compiles-tccc-to-webassembly">2 Zig compiles TCCC to WebAssembly</a></h1>
<p>TODO</p>
<h1 id="posix-for-webassembly"><a href="#posix-for-webassembly">3 POSIX for WebAssembly</a></h1>
<p><em>What‚Äôs this POSIX?</em></p>
<p>TODO: Also <a href="https://en.wikipedia.org/wiki/C_standard_library"><strong>libc (C Standard Library)</strong></a></p>
<p><a href="https://en.wikipedia.org/wiki/POSIX"><strong>POSIX</strong></a></p>
<h1 id="file-input-and-output"><a href="#file-input-and-output">4 File Input and Output</a></h1>
<p>TODO</p>
<h1 id="fearsome-fprintf-and-friends"><a href="#fearsome-fprintf-and-friends">5 Fearsome fprintf and Friends</a></h1>
<p>TODO: Funny how printf is the first thing we learn about C. But yet it‚Äôs incredibly difficult to implement!</p>
<h1 id="test-with-apache-nuttx-rtos"><a href="#test-with-apache-nuttx-rtos">6 Test with Apache NuttX RTOS</a></h1>
<p>TODO</p>
<h1 id="tcc-generates-64-bit-risc-v-code"><a href="#tcc-generates-64-bit-risc-v-code">7 TCC generates 64-bit RISC-V code</a></h1>
<p>TODO</p>
<p>We build TCC to support 64-bit RISC-V Target‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Build TCC for 64-bit RISC-V Target
git clone https://github.com/lupyuen/tcc-riscv32-wasm
cd tcc-riscv32-wasm
./configure
make help
make --trace cross-riscv64
./riscv64-tcc -v
</code></pre></div>
<p>We compile this C program‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>## Simple C Program
int main(int argc, char *argv[]) {
  printf(&quot;Hello, World!!\n&quot;);
  return 0;
}
</code></pre></div>
<p>Like this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Compile C to 64-bit RISC-V
/workspaces/bookworm/tcc-riscv32/riscv64-tcc \
    -c \
    /workspaces/bookworm/apps/examples/hello/hello_main.c

## Dump the 64-bit RISC-V Disassembly
riscv-none-elf-objdump \
  --syms --source --reloc --demangle --line-numbers --wide \
  --debugging \
  hello_main.o \
  &gt;hello_main.S \
  2&gt;&amp;1
</code></pre></div>
<p>The RISC-V Disassembly looks valid, very similar to a <a href="https://lupyuen.github.io/articles/app#inside-a-nuttx-app">NuttX App</a> (so it will probably run on NuttX): <a href="https://gist.github.com/lupyuen/46ffc9481c79e36274c0980f9d58f806">hello_main.S</a></p>
<div class="example-wrap"><pre class="language-text"><code>hello_main.o:     file format elf64-littleriscv
SYMBOL TABLE:
0000000000000000 l    df *ABS*  0000000000000000 /workspaces/bookworm/apps/examples/hello/hello_m
ain.c
0000000000000000 l     O .data.ro       0000000000000010 L.0
0000000000000000 g     F .text  0000000000000040 main
0000000000000000       F *UND*  0000000000000000 printf

Disassembly of section .text:
0000000000000000 &lt;main&gt;:
main():
   0:   fe010113                add     sp,sp,-32
   4:   00113c23                sd      ra,24(sp)
   8:   00813823                sd      s0,16(sp)
   c:   02010413                add     s0,sp,32
  10:   00000013                nop
  14:   fea43423                sd      a0,-24(s0)
  18:   feb43023                sd      a1,-32(s0)
  1c:   00000517                auipc   a0,0x0  1c: R_RISCV_PCREL_HI20  L.0
  20:   00050513                mv      a0,a0   20: R_RISCV_PCREL_LO12_I        .text
  24:   00000097                auipc   ra,0x0  24: R_RISCV_CALL_PLT    printf
  28:   000080e7                jalr    ra # 24 &lt;main+0x24&gt;
  2c:   0000051b                sext.w  a0,zero
  30:   01813083                ld      ra,24(sp)
  34:   01013403                ld      s0,16(sp)
  38:   02010113                add     sp,sp,32
  3c:   00008067                ret
</code></pre></div>
<p>See the Object File: <a href="https://gist.github.com/lupyuen/ac600d793a60b1e7f6ac95918580f266">hello_main.o</a></p>
<h1 id="compile-tcc-with-zig-compiler"><a href="#compile-tcc-with-zig-compiler">8 Compile TCC with Zig Compiler</a></h1>
<p>TODO</p>
<p>We compile TCC Compiler with the Zig Compiler. First we figure out the GCC Options‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Show the GCC Options
$ make --trace cross-riscv64
gcc \
  -o riscv64-tcc.o \
  -c tcc.c \
  -DTCC_TARGET_RISCV64 \
  -DCONFIG_TCC_CROSSPREFIX=&quot;\&quot;riscv64-\&quot;&quot;  \
  -DCONFIG_TCC_CRTPREFIX=&quot;\&quot;/usr/riscv64-linux-gnu/lib\&quot;&quot; \
  -DCONFIG_TCC_LIBPATHS=&quot;\&quot;{B}:/usr/riscv64-linux-gnu/lib\&quot;&quot; \
  -DCONFIG_TCC_SYSINCLUDEPATHS=&quot;\&quot;{B}/include:/usr/riscv64-linux-gnu/include\&quot;&quot;   \
  -DTCC_GITHASH=&quot;\&quot;main:b3d10a35\&quot;&quot; \
  -Wall \
  -O2 \
  -Wdeclaration-after-statement \
  -fno-strict-aliasing \
  -Wno-pointer-sign \
  -Wno-sign-compare \
  -Wno-unused-result \
  -Wno-format-truncation \
  -Wno-stringop-truncation \
  -I. 

gcc \
  -o riscv64-tcc riscv64-tcc.o \
  -lm \
  -lpthread \
  -ldl \
  -s \

## Probably won&#39;t need this for now
../riscv64-tcc -c lib-arm64.c -o riscv64-lib-arm64.o -B.. -I..
../riscv64-tcc -c stdatomic.c -o riscv64-stdatomic.o -B.. -I..
../riscv64-tcc -c atomic.S -o riscv64-atomic.o -B.. -I..
../riscv64-tcc -c dsohandle.c -o riscv64-dsohandle.o -B.. -I..
../riscv64-tcc -ar rcs ../riscv64-libtcc1.a riscv64-lib-arm64.o riscv64-stdatomic.o riscv64-atomic.o riscv64-dsohandle.o
</code></pre></div>
<p>We copy the above GCC Options and we compile TCC with Zig Compiler‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Compile TCC with Zig Compiler
export PATH=/workspaces/bookworm/zig-linux-x86_64-0.12.0-dev.2341+92211135f:$PATH
./configure
make --trace cross-riscv64
zig cc \
  tcc.c \
  -DTCC_TARGET_RISCV64 \
  -DCONFIG_TCC_CROSSPREFIX=&quot;\&quot;riscv64-\&quot;&quot;  \
  -DCONFIG_TCC_CRTPREFIX=&quot;\&quot;/usr/riscv64-linux-gnu/lib\&quot;&quot; \
  -DCONFIG_TCC_LIBPATHS=&quot;\&quot;{B}:/usr/riscv64-linux-gnu/lib\&quot;&quot; \
  -DCONFIG_TCC_SYSINCLUDEPATHS=&quot;\&quot;{B}/include:/usr/riscv64-linux-gnu/include\&quot;&quot;   \
  -DTCC_GITHASH=&quot;\&quot;main:b3d10a35\&quot;&quot; \
  -Wall \
  -O2 \
  -Wdeclaration-after-statement \
  -fno-strict-aliasing \
  -Wno-pointer-sign \
  -Wno-sign-compare \
  -Wno-unused-result \
  -Wno-format-truncation \
  -Wno-stringop-truncation \
  -I.

## Test our TCC compiled with Zig Compiler
/workspaces/bookworm/tcc-riscv32/a.out -v

/workspaces/bookworm/tcc-riscv32/a.out -c \
  /workspaces/bookworm/apps/examples/hello/hello_main.c

riscv-none-elf-objdump \
  --syms --source --reloc --demangle --line-numbers --wide \
  --debugging \
  hello_main.o \
  &gt;hello_main.S \
  2&gt;&amp;1
</code></pre></div>
<p>Yep it works OK!</p>
<h1 id="compile-tcc-to-webassembly-with-zig-compiler"><a href="#compile-tcc-to-webassembly-with-zig-compiler">9 Compile TCC to WebAssembly with Zig Compiler</a></h1>
<p>TODO</p>
<p>Now we compile TCC to WebAssembly.</p>
<p>Zig Compiler doesn‚Äôt like it, so we <a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/e30454a0eb9916f820d58a7c3e104eeda67988d8">Patch the longjmp / setjmp</a>. (We probably won‚Äôt need it unless TCC hits Compiler Errors)</p>
<div class="example-wrap"><pre class="language-bash"><code>## Compile TCC from C to WebAssembly
./configure
make --trace cross-riscv64
zig cc \
  -c \
  -target wasm32-freestanding \
  -dynamic \
  -rdynamic \
  -lc \
  tcc.c \
  -DTCC_TARGET_RISCV64 \
  -DCONFIG_TCC_CROSSPREFIX=&quot;\&quot;riscv64-\&quot;&quot;  \
  -DCONFIG_TCC_CRTPREFIX=&quot;\&quot;/usr/riscv64-linux-gnu/lib\&quot;&quot; \
  -DCONFIG_TCC_LIBPATHS=&quot;\&quot;{B}:/usr/riscv64-linux-gnu/lib\&quot;&quot; \
  -DCONFIG_TCC_SYSINCLUDEPATHS=&quot;\&quot;{B}/include:/usr/riscv64-linux-gnu/include\&quot;&quot;   \
  -DTCC_GITHASH=&quot;\&quot;main:b3d10a35\&quot;&quot; \
  -Wall \
  -O2 \
  -Wdeclaration-after-statement \
  -fno-strict-aliasing \
  -Wno-pointer-sign \
  -Wno-sign-compare \
  -Wno-unused-result \
  -Wno-format-truncation \
  -Wno-stringop-truncation \
  -I.

## Dump our Compiled WebAssembly
sudo apt install wabt
wasm-objdump -h tcc.o
wasm-objdump -x tcc.o &gt;/tmp/tcc.txt
</code></pre></div>
<p>Yep TCC compiles OK to WebAssembly with Zig Compiler!</p>
<h1 id="missing-functions-in-tcc-webassembly"><a href="#missing-functions-in-tcc-webassembly">10 Missing Functions in TCC WebAssembly</a></h1>
<p>TODO</p>
<p>We check the Compiled WebAssembly. These POSIX Functions are missing from the Compiled WebAssembly‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ wasm-objdump -x tcc.o &gt;/tmp/tcc.txt
$ cat /tmp/tcc.txt

Import[75]:
 - memory[0] pages: initial=2 &lt;- env.__linear_memory
 - global[0] i32 mutable=1 &lt;- env.__stack_pointer
 - func[0] sig=1 &lt;env.strcmp&gt; &lt;- env.strcmp
 - func[1] sig=12 &lt;env.memset&gt; &lt;- env.memset
 - func[2] sig=1 &lt;env.getcwd&gt; &lt;- env.getcwd
 - func[3] sig=1 &lt;env.strcpy&gt; &lt;- env.strcpy
 - func[4] sig=2 &lt;env.unlink&gt; &lt;- env.unlink
 - func[5] sig=0 &lt;env.free&gt; &lt;- env.free
 - func[6] sig=6 &lt;env.snprintf&gt; &lt;- env.snprintf
 - func[7] sig=2 &lt;env.getenv&gt; &lt;- env.getenv
 - func[8] sig=2 &lt;env.strlen&gt; &lt;- env.strlen
 - func[9] sig=12 &lt;env.sem_init&gt; &lt;- env.sem_init
 - func[10] sig=2 &lt;env.sem_wait&gt; &lt;- env.sem_wait
 - func[11] sig=1 &lt;env.realloc&gt; &lt;- env.realloc
 - func[12] sig=12 &lt;env.memmove&gt; &lt;- env.memmove
 - func[13] sig=2 &lt;env.malloc&gt; &lt;- env.malloc
 - func[14] sig=12 &lt;env.fprintf&gt; &lt;- env.fprintf
 - func[15] sig=2 &lt;env.puts&gt; &lt;- env.puts
 - func[16] sig=0 &lt;env.exit&gt; &lt;- env.exit
 - func[17] sig=2 &lt;env.sem_post&gt; &lt;- env.sem_post
 - func[18] sig=1 &lt;env.strchr&gt; &lt;- env.strchr
 - func[19] sig=1 &lt;env.strrchr&gt; &lt;- env.strrchr
 - func[20] sig=6 &lt;env.vsnprintf&gt; &lt;- env.vsnprintf
 - func[21] sig=1 &lt;env.printf&gt; &lt;- env.printf
 - func[22] sig=2 &lt;env.fflush&gt; &lt;- env.fflush
 - func[23] sig=12 &lt;env.memcpy&gt; &lt;- env.memcpy
 - func[24] sig=12 &lt;env.memcmp&gt; &lt;- env.memcmp
 - func[25] sig=12 &lt;env.sscanf&gt; &lt;- env.sscanf
 - func[26] sig=1 &lt;env.fputs&gt; &lt;- env.fputs
 - func[27] sig=2 &lt;env.close&gt; &lt;- env.close
 - func[28] sig=12 &lt;env.open&gt; &lt;- env.open
 - func[29] sig=18 &lt;env.lseek&gt; &lt;- env.lseek
 - func[30] sig=12 &lt;env.read&gt; &lt;- env.read
 - func[31] sig=12 &lt;env.strtol&gt; &lt;- env.strtol
 - func[32] sig=2 &lt;env.atoi&gt; &lt;- env.atoi
 - func[33] sig=19 &lt;env.strtoull&gt; &lt;- env.strtoull
 - func[34] sig=12 &lt;env.strtoul&gt; &lt;- env.strtoul
 - func[35] sig=1 &lt;env.strstr&gt; &lt;- env.strstr
 - func[36] sig=1 &lt;env.fopen&gt; &lt;- env.fopen
 - func[37] sig=12 &lt;env.sprintf&gt; &lt;- env.sprintf
 - func[38] sig=2 &lt;env.fclose&gt; &lt;- env.fclose
 - func[39] sig=12 &lt;env.fseek&gt; &lt;- env.fseek
 - func[40] sig=2 &lt;env.ftell&gt; &lt;- env.ftell
 - func[41] sig=6 &lt;env.fread&gt; &lt;- env.fread
 - func[42] sig=6 &lt;env.fwrite&gt; &lt;- env.fwrite
 - func[43] sig=2 &lt;env.remove&gt; &lt;- env.remove
 - func[44] sig=1 &lt;env.gettimeofday&gt; &lt;- env.gettimeofday
 - func[45] sig=1 &lt;env.fdopen&gt; &lt;- env.fdopen
 - func[46] sig=12 &lt;env.strncpy&gt; &lt;- env.strncpy
 - func[47] sig=24 &lt;env.__extendsftf2&gt; &lt;- env.__extendsftf2
 - func[48] sig=25 &lt;env.__extenddftf2&gt; &lt;- env.__extenddftf2
 - func[49] sig=9 &lt;env.__floatunditf&gt; &lt;- env.__floatunditf
 - func[50] sig=3 &lt;env.__floatunsitf&gt; &lt;- env.__floatunsitf
 - func[51] sig=26 &lt;env.__trunctfsf2&gt; &lt;- env.__trunctfsf2
 - func[52] sig=27 &lt;env.__trunctfdf2&gt; &lt;- env.__trunctfdf2
 - func[53] sig=28 &lt;env.__netf2&gt; &lt;- env.__netf2
 - func[54] sig=29 &lt;env.__fixunstfdi&gt; &lt;- env.__fixunstfdi
 - func[55] sig=30 &lt;env.__subtf3&gt; &lt;- env.__subtf3
 - func[56] sig=30 &lt;env.__multf3&gt; &lt;- env.__multf3
 - func[57] sig=28 &lt;env.__eqtf2&gt; &lt;- env.__eqtf2
 - func[58] sig=30 &lt;env.__divtf3&gt; &lt;- env.__divtf3
 - func[59] sig=30 &lt;env.__addtf3&gt; &lt;- env.__addtf3
 - func[60] sig=2 &lt;env.strerror&gt; &lt;- env.strerror
 - func[61] sig=1 &lt;env.fputc&gt; &lt;- env.fputc
 - func[62] sig=1 &lt;env.strcat&gt; &lt;- env.strcat
 - func[63] sig=12 &lt;env.strncmp&gt; &lt;- env.strncmp
 - func[64] sig=31 &lt;env.ldexp&gt; &lt;- env.ldexp
 - func[65] sig=32 &lt;env.strtof&gt; &lt;- env.strtof
 - func[66] sig=8 &lt;env.strtold&gt; &lt;- env.strtold
 - func[67] sig=33 &lt;env.strtod&gt; &lt;- env.strtod
 - func[68] sig=2 &lt;env.time&gt; &lt;- env.time
 - func[69] sig=2 &lt;env.localtime&gt; &lt;- env.localtime
 - func[70] sig=13 &lt;env.qsort&gt; &lt;- env.qsort
 - func[71] sig=19 &lt;env.strtoll&gt; &lt;- env.strtoll
 - table[0] type=funcref initial=4 &lt;- env.__indirect_function_table
</code></pre></div>
<p>TODO: How to fix these missing POSIX Functions for WebAssembly (Web Browser)</p>
<p>TODO: Do we need all of them? Maybe we run in a Web Browser and see what crashes? <a href="https://lupyuen.github.io/articles/lvgl3">Similar to this</a></p>
<h1 id="test-the-tcc-webassembly-with-nodejs"><a href="#test-the-tcc-webassembly-with-nodejs">11 Test the TCC WebAssembly with NodeJS</a></h1>
<p>TODO</p>
<p>We link our Compiled WebAssembly <code>tcc.o</code> with our Zig App: <a href="zig/tcc-wasm.zig">zig/tcc-wasm.zig</a></p>
<div class="example-wrap"><pre class="language-bash"><code>## Compile our Zig App `tcc-wasm.zig` for WebAssembly
## and link with TCC compiled for WebAssembly
zig build-exe \
  --verbose-cimport \
  -target wasm32-freestanding \
  -rdynamic \
  -lc \
  -fno-entry \
  --export=compile_program \
  zig/tcc-wasm.zig \
  tcc.o

## Dump our Linked WebAssembly
wasm-objdump -h tcc-wasm.wasm
wasm-objdump -x tcc-wasm.wasm &gt;/tmp/tcc-wasm.txt

## Run our Linked WebAssembly
## Shows: ret=123
node zig/test.js
</code></pre></div>
<p>Yep it runs OK and prints <code>123</code>, with our NodeJS Script: <a href="zig/test.js">zig/test.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>const fs = require(&#39;fs&#39;);
const source = fs.readFileSync(&quot;./tcc-wasm.wasm&quot;);
const typedArray = new Uint8Array(source);

WebAssembly.instantiate(typedArray, {
  env: {
    print: (result) =&gt; { console.log(`The result is ${result}`); }
  }}).then(result =&gt; {
  const compile_program = result.instance.exports.compile_program;
  const ret = compile_program();
  console.log(`ret=${ret}`);
});
</code></pre></div><h1 id="test-the-tcc-webassembly-in-a-web-browser"><a href="#test-the-tcc-webassembly-in-a-web-browser">12 Test the TCC WebAssembly in a Web Browser</a></h1>
<p>TODO</p>
<p>We test the TCC WebAssembly in a Web Browser with <a href="docs/index.html">docs/index.html</a> and <a href="docs/tcc.js">docs/tcc.js</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Start the Web Server
cargo install simple-http-server
simple-http-server ./docs &amp;

## Copy the Linked TCC WebAssembly to the Web Server
cp tcc-wasm.wasm docs/
</code></pre></div>
<p>Browse to‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>http://localhost:8000/index.html
</code></pre></div>
<p>Open the JavaScript Console. Yep our TCC WebAssembly runs OK in a Web Browser!</p>
<div class="example-wrap"><pre class="language-text"><code>main: start
ret=123
main: end
</code></pre></div>
<p>Also published publicly here (see the JavaScript Console): https://lupyuen.github.io/tcc-riscv32-wasm/</p>
<h1 id="fix-the-missing-functions"><a href="#fix-the-missing-functions">13 Fix the Missing Functions</a></h1>
<p>TODO</p>
<p>When we call <code>main()</code> in our Zig App: <a href="zig/tcc-wasm.zig">zig/tcc-wasm.zig</a></p>
<p>We see many many Undefined Symbols‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>+ zig build-exe --verbose-cimport -target wasm32-freestanding -rdynamic -lc -fno-entry --export=compile_program zig/tcc-wasm.zig tcc.o
error: wasm-ld: tcc.o: undefined symbol: realloc
error: wasm-ld: tcc.o: undefined symbol: free
error: wasm-ld: tcc.o: undefined symbol: snprintf
[...many many more...]
</code></pre></div>
<p>So we stubbed them in our Zig App: <a href="zig/tcc-wasm.zig">zig/tcc-wasm.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// Fix the Missing Variables
pub export var errno: c_int = 0;
pub export var stdout: c_int = 1;
pub export var stderr: c_int = 2;

/// Fix the Missing Functions
pub export fn atoi(_: c_int) c_int {
    @panic(&quot;TODO: atoi&quot;);
}
pub export fn close(_: c_int) c_int {
    @panic(&quot;TODO: close&quot;);
}
[...many many more...]
</code></pre></div>
<p>Then we‚Ä¶</p>
<ol>
<li>
<p>Borrow from <a href="https://github.com/ZigEmbeddedGroup/foundation-libc">foundation-libc</a> and <a href="https://github.com/marler8997/ziglibc">ziglibc</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/e7c76474deb52acadd3540dec0589ab98ae243a9#diff-5ecd8d41f5376644e9c3f17c9eac540841ff6f7c00bca34d7811b54e0b9bd7a0">Fix malloc()</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/c230681899503ea4fe37a3c7ff0031f7018e2e2d">Add getenv()</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/4ea06f7602471a65539c65c746bfa65c6d1d4184">Add String Functions</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/c0095568c3595c09345936b74616b528c99b364e">Add open()</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/99d1d4a19a2530d1972222d0cdea1c52771f537c">Add sem_init, sem_wait, puts</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/765bc8b1313d579f9e8975ec57e949408385ae6e">Increase malloc buffer</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/abf18acd6053b852363afa9adefcc81501f334ed">Add sscanf</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/c76b671e771d6ba4bb62230e1546aeb3e8637850">Add vsnprintf and fflush</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/36d591ea197eb87eb5f14e9632512cfecc99cbaf">Add fprintf</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/7fe054b38cb52a289f1f512ba1e4ab07823b2ca4">Add read</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/dd0161168815d570259e08d4bf0370a363e6e6e7">Add sprintf, snprintf</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/812eaa10d36bd29b6f4efcc35b09f4899f880d5b">Add close, sem_post, unlink</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/7380fe18d6d109abb55b473b7b7e53749f92a32b">Add fdopen</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/865eaa7970193cc1d3d3dbdfb2b1314971cc1d1c">Add fwrite</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/679d28b1020098d5e4e81f4646611f26270374a7">Add fputc</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/455724992a92bcc2c6294a0a93612c5a616c1013">Add fclose</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/547759dcf9b991c3b49737e24133b45c47dfd378">Add fputs</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/3c8e4337a66e77d06877f7b1606db71139560104">Change <code>L.%u</code> to <code>L.0</code>, <code>.rela%s</code> to <code>.rela.text</code></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/tcc-riscv32-wasm/commit/a6602a602293addfeb9ce548b9a3aacb62127c5f">Dump the <code>a.out</code> file</a></p>
</li>
</ol>
<h1 id="tcc-webassembly-runs-ok-in-a-web-browser"><a href="#tcc-webassembly-runs-ok-in-a-web-browser">14 TCC WebAssembly runs OK in a Web Browser!</a></h1>
<p>TODO</p>
<p>When we run it in a <a href="https://lupyuen.github.io/tcc-riscv32-wasm/">Web Browser</a>: TCC compiles <code>hello.c</code> and writes to <code>a.out</code> yay!</p>
<div class="example-wrap"><pre class="language-text"><code>+ node zig/test.js
compile_program
open: path=hello.c, oflag=0, return fd=3
sem_init: sem=tcc-wasm.sem_t@107678, pshared=0, value=1
sem_wait: sem=tcc-wasm.sem_t@107678
TODO: setjmp
TODO: sscanf: str=0.9.27, format=%d.%d.%d
TODO: vsnprintf: size=128, format=#define __TINYC__ %d
TODO: vsnprintf: return str=#define __TINYC__ %d
TODO: vsnprintf: size=107, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=94, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=81, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=196, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=183, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=170, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=157, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=144, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=131, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=118, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=105, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=92, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=335, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=322, format=#define __SIZEOF_POINTER__ %d
TODO: vsnprintf: return str=#define __SIZEOF_POINTER__ %d
TODO: vsnprintf: size=292, format=#define __SIZEOF_LONG__ %d
TODO: vsnprintf: return str=#define __SIZEOF_LONG__ %d
TODO: vsnprintf: size=265, format=#define %s%s
TODO: vsnprintf: return str=#define FIX_vsnprintf
TODO: vsnprintf: size=252, format=#define __STDC_VERSION__ %dL
TODO: vsnprintf: return str=#define __STDC_VERSION__ %dL
TODO: vsnprintf: size=497, format=#define __BASE_FILE__ &quot;%s&quot;
TODO: vsnprintf: return str=#define __BASE_FILE__ &quot;%s&quot;
TODO: vsnprintf: size=128, format=In file included from %s:%d:
TODO: vsnprintf: return str=In file included from %s:%d:
TODO: vsnprintf: size=99, format=%s:%d: 
TODO: vsnprintf: return str=%s:%d: 
TODO: vsnprintf: size=92, format=warning: 
TODO: vsnprintf: return str=warning: 
TODO: vsnprintf: size=83, format=%s redefined
TODO: vsnprintf: return str=%s redefined
fprintf: stream=tcc-wasm.FILE@2, format=%s
read: fd=3, nbyte=8192
read: return buf=int main(int argc, char *argv[]) {
  printf(&quot;Hello, World!!\n&quot;);
  return 0;
}
TODO: vsnprintf: size=128, format=%s:%d: 
TODO: vsnprintf: return str=%s:%d: 
TODO: vsnprintf: size=121, format=warning: 
TODO: vsnprintf: return str=warning: 
TODO: vsnprintf: size=112, format=implicit declaration of function &#39;%s&#39;
TODO: vsnprintf: return str=implicit declaration of function &#39;%s&#39;
fprintf: stream=tcc-wasm.FILE@2, format=%s
TODO: sprintf: format=L.%u
TODO: sprintf: return str=L.0
TODO: snprintf: size=256, format=.rela%s
TODO: snprintf: return str=.rela.text
read: fd=3, nbyte=8192
read: return 0
close: fd=3
sem_post: sem=tcc-wasm.sem_t@107678
TODO: snprintf: size=1024, format=%s
TODO: snprintf: return str=%s

unlink: path=a.out
open: path=a.out, oflag=577, return fd=4
fdopen: fd=4, mode=wb, return FILE=5
fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  7F 45 4C 46 02 01 01 00  00 00 00 00 00 00 00 00  .ELF............
  0016:  01 00 F3 00 01 00 00 00  00 00 00 00 00 00 00 00  ................
  0032:  00 00 00 00 00 00 00 00  D0 01 00 00 00 00 00 00  ................
  0048:  04 00 00 00 40 00 00 00  00 00 40 00 09 00 08 00  ....@.....@.....

fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  13 01 01 FE 23 3C 11 00  23 38 81 00 13 04 01 02  ....#&lt;..#8......
  0016:  13 00 00 00 23 34 A4 FE  23 30 B4 FE 17 05 00 00  ....#4..#0......
  0032:  13 05 05 00 97 00 00 00  E7 80 00 00 1B 05 00 00  ................
  0048:  83 30 81 01 03 34 01 01  13 01 01 02 67 80 00 00  .0...4......g...

fwrite: size=1, nmemb=16, stream=tcc-wasm.FILE@5
  0000:  48 65 6C 6C 6F 2C 20 57  6F 72 6C 64 21 21 0A 00  Hello, World!!..

fwrite: size=1, nmemb=144, stream=tcc-wasm.FILE@5
  0000:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0016:  00 00 00 00 00 00 00 00  01 00 00 00 04 00 F1 FF  ................
  0032:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0048:  0E 00 00 00 01 00 03 00  00 00 00 00 00 00 00 00  ................
  0064:  10 00 00 00 00 00 00 00  00 00 00 00 00 00 01 00  ................
  0080:  1C 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0096:  09 00 00 00 12 00 01 00  00 00 00 00 00 00 00 00  ................
  0112:  40 00 00 00 00 00 00 00  12 00 00 00 12 00 00 00  @...............
  0128:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................

fwrite: size=1, nmemb=25, stream=tcc-wasm.FILE@5
  0000:  00 68 65 6C 6C 6F 2E 63  00 6D 61 69 6E 00 4C 2E  .hello.c.main.L.
  0016:  30 00 70 72 69 6E 74 66  00                       0.printf.

fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fwrite: size=1, nmemb=72, stream=tcc-wasm.FILE@5
  0000:  1C 00 00 00 00 00 00 00  17 00 00 00 02 00 00 00  ................
  0016:  00 00 00 00 00 00 00 00  20 00 00 00 00 00 00 00  ........ .......
  0032:  18 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  ................
  0048:  24 00 00 00 00 00 00 00  13 00 00 00 05 00 00 00  $...............
  0064:  00 00 00 00 00 00 00 00                           ........

fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fputc: c=0x00, stream=tcc-wasm.FILE@5
fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  00 2E 74 65 78 74 00 2E  64 61 74 61 00 2E 64 61  ..text..data..da
  0016:  74 61 2E 72 6F 00 2E 62  73 73 00 2E 73 79 6D 74  ta.ro..bss..symt
  0032:  61 62 00 2E 73 74 72 74  61 62 00 2E 72 65 6C 61  ab..strtab..rela
  0048:  2E 74 65 78 74 00 2E 73  68 73 74 72 74 61 62 00  .text..shstrtab.

fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0016:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0032:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0048:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................

fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  01 00 00 00 01 00 00 00  06 00 00 00 00 00 00 00  ................
  0016:  00 00 00 00 00 00 00 00  40 00 00 00 00 00 00 00  ........@.......
  0032:  40 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  @...............
  0048:  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................

fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  07 00 00 00 01 00 00 00  03 00 00 00 00 00 00 00  ................
  0016:  00 00 00 00 00 00 00 00  80 00 00 00 00 00 00 00  ................
  0032:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0048:  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................

fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  0D 00 00 00 01 00 00 00  03 00 00 00 00 00 00 00  ................
  0016:  00 00 00 00 00 00 00 00  80 00 00 00 00 00 00 00  ................
  0032:  10 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0048:  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................

fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  16 00 00 00 08 00 00 00  03 00 00 00 00 00 00 00  ................
  0016:  00 00 00 00 00 00 00 00  90 00 00 00 00 00 00 00  ................
  0032:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0048:  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................

fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  1B 00 00 00 02 00 00 00  00 00 00 00 00 00 00 00  ................
  0016:  00 00 00 00 00 00 00 00  90 00 00 00 00 00 00 00  ................
  0032:  90 00 00 00 00 00 00 00  06 00 00 00 04 00 00 00  ................
  0048:  08 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  ................

fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  23 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  #...............
  0016:  00 00 00 00 00 00 00 00  20 01 00 00 00 00 00 00  ........ .......
  0032:  19 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0048:  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................

fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  2B 00 00 00 04 00 00 00  00 00 00 00 00 00 00 00  +...............
  0016:  00 00 00 00 00 00 00 00  40 01 00 00 00 00 00 00  ........@.......
  0032:  48 00 00 00 00 00 00 00  05 00 00 00 01 00 00 00  H...............
  0048:  08 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  ................

fwrite: size=1, nmemb=64, stream=tcc-wasm.FILE@5
  0000:  36 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  6...............
  0016:  00 00 00 00 00 00 00 00  90 01 00 00 00 00 00 00  ................
  0032:  40 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  @...............
  0048:  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................

close: stream=tcc-wasm.FILE@5
a.out: 1040 bytes
  0000:  7F 45 4C 46 02 01 01 00  00 00 00 00 00 00 00 00  .ELF............
  0016:  01 00 F3 00 01 00 00 00  00 00 00 00 00 00 00 00  ................
  0032:  00 00 00 00 00 00 00 00  D0 01 00 00 00 00 00 00  ................
  0048:  04 00 00 00 40 00 00 00  00 00 40 00 09 00 08 00  ....@.....@.....
  0064:  13 01 01 FE 23 3C 11 00  23 38 81 00 13 04 01 02  ....#&lt;..#8......
  0080:  13 00 00 00 23 34 A4 FE  23 30 B4 FE 17 05 00 00  ....#4..#0......
  0096:  13 05 05 00 97 00 00 00  E7 80 00 00 1B 05 00 00  ................
  0112:  83 30 81 01 03 34 01 01  13 01 01 02 67 80 00 00  .0...4......g...
  0128:  48 65 6C 6C 6F 2C 20 57  6F 72 6C 64 21 21 0A 00  Hello, World!!..
  0144:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0160:  00 00 00 00 00 00 00 00  01 00 00 00 04 00 F1 FF  ................
  0176:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0192:  0E 00 00 00 01 00 03 00  00 00 00 00 00 00 00 00  ................
  0208:  10 00 00 00 00 00 00 00  00 00 00 00 00 00 01 00  ................
  0224:  1C 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0240:  09 00 00 00 12 00 01 00  00 00 00 00 00 00 00 00  ................
  0256:  40 00 00 00 00 00 00 00  12 00 00 00 12 00 00 00  @...............
  0272:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0288:  00 68 65 6C 6C 6F 2E 63  00 6D 61 69 6E 00 4C 2E  .hello.c.main.L.
  0304:  30 00 70 72 69 6E 74 66  00 00 00 00 00 00 00 00  0.printf........
  0320:  1C 00 00 00 00 00 00 00  17 00 00 00 02 00 00 00  ................
  0336:  00 00 00 00 00 00 00 00  20 00 00 00 00 00 00 00  ........ .......
  0352:  18 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  ................
  0368:  24 00 00 00 00 00 00 00  13 00 00 00 05 00 00 00  $...............
  0384:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0400:  00 2E 74 65 78 74 00 2E  64 61 74 61 00 2E 64 61  ..text..data..da
  0416:  74 61 2E 72 6F 00 2E 62  73 73 00 2E 73 79 6D 74  ta.ro..bss..symt
  0432:  61 62 00 2E 73 74 72 74  61 62 00 2E 72 65 6C 61  ab..strtab..rela
  0448:  2E 74 65 78 74 00 2E 73  68 73 74 72 74 61 62 00  .text..shstrtab.
  0464:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0480:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0496:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0512:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0528:  01 00 00 00 01 00 00 00  06 00 00 00 00 00 00 00  ................
  0544:  00 00 00 00 00 00 00 00  40 00 00 00 00 00 00 00  ........@.......
  0560:  40 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  @...............
  0576:  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0592:  07 00 00 00 01 00 00 00  03 00 00 00 00 00 00 00  ................
  0608:  00 00 00 00 00 00 00 00  80 00 00 00 00 00 00 00  ................
  0624:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0640:  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0656:  0D 00 00 00 01 00 00 00  03 00 00 00 00 00 00 00  ................
  0672:  00 00 00 00 00 00 00 00  80 00 00 00 00 00 00 00  ................
  0688:  10 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0704:  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0720:  16 00 00 00 08 00 00 00  03 00 00 00 00 00 00 00  ................
  0736:  00 00 00 00 00 00 00 00  90 00 00 00 00 00 00 00  ................
  0752:  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0768:  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0784:  1B 00 00 00 02 00 00 00  00 00 00 00 00 00 00 00  ................
  0800:  00 00 00 00 00 00 00 00  90 00 00 00 00 00 00 00  ................
  0816:  90 00 00 00 00 00 00 00  06 00 00 00 04 00 00 00  ................
  0832:  08 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  ................
  0848:  23 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  #...............
  0864:  00 00 00 00 00 00 00 00  20 01 00 00 00 00 00 00  ........ .......
  0880:  19 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0896:  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................
  0912:  2B 00 00 00 04 00 00 00  00 00 00 00 00 00 00 00  +...............
  0928:  00 00 00 00 00 00 00 00  40 01 00 00 00 00 00 00  ........@.......
  0944:  48 00 00 00 00 00 00 00  05 00 00 00 01 00 00 00  H...............
  0960:  08 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  ................
  0976:  36 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  6...............
  0992:  00 00 00 00 00 00 00 00  90 01 00 00 00 00 00 00  ................
  1008:  40 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  @...............
  1024:  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................

ret=1040
</code></pre></div>
<p>Also published publicly here (see the JavaScript Console): https://lupyuen.github.io/tcc-riscv32-wasm/</p>
<p>TODO: Check our WebAssembly with <a href="https://github.com/dylibso/modsurfer">Modsurfer</a></p>
<p>TODO: Need to implement vsnprintf() in C? Or we hardcode the patterns?</p>
<p>TODO: Didn‚Äôt we pass the TCC Option <code>-c</code> to generate as Object File? Why is the output <code>a.out</code>?</p>
<p>Note: <code>invalid macro name</code> is caused by <code>#define %s%s</code>. We should mock up a valid name for <code>%s%s</code></p>
<p><img src="https://lupyuen.github.io/images/tcc-title.png" alt="TCC RISC-V Compiler: Compiled to WebAssembly with Zig Compiler" /></p>
<p><a href="https://lupyuen.github.io/tcc-riscv32-wasm/"><em>(Try the <strong>Online Demo</strong>)</em></a></p>
<h1 id="verify-the-tcc-output"><a href="#verify-the-tcc-output">15 Verify the TCC Output</a></h1>
<p>TODO</p>
<p>Let‚Äôs verify the generated <code>a.out</code>.</p>
<p>We copy the above <code>a.out</code> Hex Dump into a Text File: <a href="https://gist.github.com/lupyuen/fd78742847b146c6eea5dfcff0d932f7">a.txt</a></p>
<p>Then we decompile it‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Convert a.txt to a.out
cat a.txt \
  | cut --bytes=10-58 \
  | xxd -revert -plain \
  &gt;a.out

## Decompile the a.out to RISC-V Disassembly a.S
riscv-none-elf-objdump \
  --syms --source --reloc --demangle --line-numbers --wide \
  --debugging \
  a.out \
  &gt;a.S \
  2&gt;&amp;1
</code></pre></div>
<p>And the Decompiled RISC-V Disassembly looks correct! <a href="https://gist.github.com/lupyuen/9a9fe3a7c061503f33752221dcb0992c">a.S</a></p>
<div class="example-wrap"><pre class="language-text"><code>main():
   0:	fe010113          	add	sp,sp,-32
   4:	00113c23          	sd	ra,24(sp)
   8:	00813823          	sd	s0,16(sp)
   c:	02010413          	add	s0,sp,32
  10:	00000013          	nop
  14:	fea43423          	sd	a0,-24(s0)
  18:	feb43023          	sd	a1,-32(s0)
  1c:	00000517          	auipc	a0,0x0	1c: R_RISCV_PCREL_HI20	L.0
  20:	00050513          	mv	a0,a0	20: R_RISCV_PCREL_LO12_I	.text
  24:	00000097          	auipc	ra,0x0	24: R_RISCV_CALL_PLT	printf
  28:	000080e7          	jalr	ra # 24 &lt;main+0x24&gt;
  2c:	0000051b          	sext.w	a0,zero
  30:	01813083          	ld	ra,24(sp)
  34:	01013403          	ld	s0,16(sp)
  38:	02010113          	add	sp,sp,32
  3c:	00008067          	ret
</code></pre></div>
<p>Very similar to <a href="https://gist.github.com/lupyuen/46ffc9481c79e36274c0980f9d58f806">hello_main.S</a></p>
<p>So yes TCC runs correctly in a Web Browser. With some limitations and lots of hacking! Yay!</p>
<p><img src="https://lupyuen.github.io/images/tcc-web.png" alt="TCC RISC-V Compiler: Compiled to WebAssembly with Zig Compiler" /></p>
<p><a href="https://lupyuen.github.io/tcc-riscv32-wasm/"><em>(Try the <strong>Online Demo</strong>)</em></a></p>
<p>TODO: Pic of Format Patterns</p>
<h1 id="fearsome-fprintf-and-friends-1"><a href="#fearsome-fprintf-and-friends-1">16 Fearsome fprintf and Friends</a></h1>
<p>TODO</p>
<p><em>TCC calls C Formatting Functions with Variable Arguments: fprintf, sprintf, ‚Ä¶</em></p>
<p><em>How will we implement them with Zig in WebAssembly?</em></p>
<p>Parsing the C Format Strings in Zig will be tedious. Thankfully, TCC only uses 5 patterns of C Format Strings: <a href="https://github.com/lupyuen/tcc-riscv32-wasm/blob/main/zig/tcc-wasm.zig#L191-L209">tcc-wasm.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// Pattern Matching for String Formatting: We will match these patterns when formatting strings
const format_patterns = [_]FormatPattern{
    // Format a Single `%d`, like `#define __TINYC__ %d`
    FormatPattern{ .c_spec = &quot;%d&quot;, .zig_spec = &quot;{}&quot;, .type0 = c_int, .type1 = null },

    // Format a Single `%u`, like `L.%u`
    FormatPattern{ .c_spec = &quot;%u&quot;, .zig_spec = &quot;{}&quot;, .type0 = c_int, .type1 = null },

    // Format a Single `%s`, like `#define __BASE_FILE__ &quot;%s&quot;` or `.rela%s`
    FormatPattern{ .c_spec = &quot;%s&quot;, .zig_spec = &quot;{s}&quot;, .type0 = [*:0]const u8, .type1 = null },

    // Format Two `%s`, like `#define %s%s\n`
    FormatPattern{ .c_spec = &quot;%s%s&quot;, .zig_spec = &quot;{s}{s}&quot;, .type0 = [*:0]const u8, .type1 = [*:0]const u8 },

    // Format `%s:%d`, like `%s:%d: `
    FormatPattern{ .c_spec = &quot;%s:%d&quot;, .zig_spec = &quot;{s}:{}&quot;, .type0 = [*:0]const u8, .type1 = c_int },
};
</code></pre></div>
<p>We use <code>comptime</code> functions in Zig to implement the C String Formatting: <a href="https://github.com/lupyuen/tcc-riscv32-wasm/blob/main/zig/tcc-wasm.zig#L276-L326">tcc-wasm.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// CompTime Function to format a string by Pattern Matching.
/// Format a Single Specifier, like `#define __BASE_FILE__ &quot;%s&quot;`
/// If the Spec matches the Format: Return the number of bytes written to `str`, excluding terminating null.
/// Else return 0.
fn format_string1(
    ap: *std.builtin.VaList,
    str: [*]u8,
    size: size_t,
    format: []const u8, // Like `#define %s%s\n`
    comptime c_spec: []const u8, // Like `%s%s`
    comptime zig_spec: []const u8, // Like `{s}{s}`
    comptime T0: type, // Like `[*:0]const u8`
) usize {
    // Count the Format Specifiers: `%`
    const spec_cnt = std.mem.count(u8, c_spec, &quot;%&quot;);
    const format_cnt = std.mem.count(u8, format, &quot;%&quot;);

    // Check the Format Specifiers: `%`
    if (format_cnt != spec_cnt or // Quit if the number of specifiers are different
        !std.mem.containsAtLeast(u8, format, 1, c_spec)) // Or if the specifiers are not found
    {
        return 0;
    }

    // Fetch the args
    const a = @cVaArg(ap, T0);
    if (T0 == c_int) {
        debug(&quot;format_string1: size={}, format={s}, a={}&quot;, .{ size, format, a });
    } else {
        debug(&quot;format_string1: size={}, format={s}, a={s}&quot;, .{ size, format, a });
    }

    // Format the string. TODO: Check for overflow
    var buf: [100]u8 = undefined; // Limit to 100 chars
    const buf_slice = std.fmt.bufPrint(&amp;buf, zig_spec, .{a}) catch {
        wasmlog.Console.log(&quot;*** format_string1 error: buf too small&quot;, .{});
        @panic(&quot;*** format_string1 error: buf too small&quot;);
    };

    // Replace the Format Specifier
    var buf2 = std.mem.zeroes([100]u8); // Limit to 100 chars
    _ = std.mem.replace(u8, format, c_spec, buf_slice, &amp;buf2);

    // Return the string
    const len = std.mem.indexOfScalar(u8, &amp;buf2, 0).?;
    @memcpy(str[0..len], buf2[0..len]);
    str[len] = 0;
    return len;
}
</code></pre></div>
<p>Previously without <code>comptime</code>, the implementation of C String Formatting gets very lengthy: <a href="https://github.com/lupyuen/tcc-riscv32-wasm/blob/8df0b4f64d188ff5936225dc545e8387ca512b8d/zig/tcc-wasm.zig#L188-L401">tcc-wasm.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>export fn vsnprintf(str: [*:0]u8, size: size_t, format: [*:0]const u8, ...) c_int {
    // Count the Format Specifiers: `%`
    const format_slice = std.mem.span(format);
    const format_cnt = std.mem.count(u8, format_slice, &quot;%&quot;);

    // TODO: Catch overflow
    if (format_cnt == 0) {
        // If no Format Specifiers: Return the Format, like `warning: `
        debug(&quot;vsnprintf: size={}, format={s}, format_cnt={}&quot;, .{ size, format, format_cnt });
        _ = memcpy(str, format, strlen(format));
        str[strlen(format)] = 0;
    } else if (format_cnt == 2 and std.mem.containsAtLeast(u8, format_slice, 1, &quot;%s%s&quot;)) {
        // Format Two `%s`, like `#define %s%s\n`
        var ap = @cVaStart();
        defer @cVaEnd(&amp;ap);
        const s0 = @cVaArg(&amp;ap, [*:0]const u8);
        const s1 = @cVaArg(&amp;ap, [*:0]const u8);
        debug(&quot;vsnprintf: size={}, format={s}, s0={s}, s1={s}&quot;, .{ size, format, s0, s1 });

        // Format the string
        const format2 = &quot;{s}{s}&quot;; // Equivalent to C: `%s%s`
        var buf: [100]u8 = undefined; // Limit to 100 chars
        const buf_slice = std.fmt.bufPrint(&amp;buf, format2, .{ s0, s1 }) catch {
            wasmlog.Console.log(&quot;*** vsnprintf error: buf too small&quot;, .{});
            @panic(&quot;*** vsnprintf error: buf too small&quot;);
        };

        // Replace the Format Specifier
        var buf2 = std.mem.zeroes([100]u8); // Limit to 100 chars
        _ = std.mem.replace(u8, format_slice, &quot;%s%s&quot;, buf_slice, &amp;buf2);

        // Return the string
        const len = std.mem.indexOfScalar(u8, &amp;buf2, 0).?;
        _ = memcpy(str, &amp;buf2, @intCast(len));
        str[len] = 0;
    } else if (format_cnt == 2 and std.mem.containsAtLeast(u8, format_slice, 1, &quot;%s:%d&quot;)) {
      // ...
</code></pre></div>
<p>Plus lots lots more of tedious coding! It‚Äôs a lot simpler now with <code>comptime</code> Format Patterns.</p>
<p>Now we can handle all String Formatting correctly in TCC‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>+ node zig/test.js
compile_program: start
compile_program: options=[&quot;-c&quot;,&quot;hello.c&quot;]
compile_program: code=
    int main(int argc, char *argv[]) {
      printf(&quot;Hello, World!!\n&quot;);
      return 0;
    }

compile_program: options[0]=-c
compile_program: options[1]=hello.c
open: path=hello.c, oflag=0, return fd=3
sem_init: sem=tcc-wasm.sem_t@10cfe8, pshared=0, value=1
sem_wait: sem=tcc-wasm.sem_t@10cfe8
TODO: setjmp
TODO: sscanf: str=0.9.27, format=%d.%d.%d
format_string1: size=128, format=#define __TINYC__ %d, a=1991381505
vsnprintf: return str=#define __TINYC__ 1991381505
format_string2: size=99, format=#define %s%s, a0=__riscv, a1= 1
vsnprintf: return str=#define __riscv 1
format_string2: size=81, format=#define %s%s, a0=__riscv_xlen 64, a1=
vsnprintf: return str=#define __riscv_xlen 64
format_string2: size=185, format=#define %s%s, a0=__riscv_flen 64, a1=
vsnprintf: return str=#define __riscv_flen 64
format_string2: size=161, format=#define %s%s, a0=__riscv_div, a1= 1
vsnprintf: return str=#define __riscv_div 1
format_string2: size=139, format=#define %s%s, a0=__riscv_mul, a1= 1
vsnprintf: return str=#define __riscv_mul 1
format_string2: size=117, format=#define %s%s, a0=__riscv_fdiv, a1= 1
vsnprintf: return str=#define __riscv_fdiv 1
format_string2: size=94, format=#define %s%s, a0=__riscv_fsqrt, a1= 1
vsnprintf: return str=#define __riscv_fsqrt 1
format_string2: size=326, format=#define %s%s, a0=__riscv_float_abi_double, a1= 1
vsnprintf: return str=#define __riscv_float_abi_double 1
format_string2: size=291, format=#define %s%s, a0=__linux__, a1= 1
vsnprintf: return str=#define __linux__ 1
format_string2: size=271, format=#define %s%s, a0=__linux, a1= 1
vsnprintf: return str=#define __linux 1
format_string2: size=253, format=#define %s%s, a0=__unix__, a1= 1
vsnprintf: return str=#define __unix__ 1
format_string2: size=234, format=#define %s%s, a0=__unix, a1= 1
vsnprintf: return str=#define __unix 1
format_string2: size=217, format=#define %s%s, a0=__CHAR_UNSIGNED__, a1= 1
vsnprintf: return str=#define __CHAR_UNSIGNED__ 1
format_string1: size=189, format=#define __SIZEOF_POINTER__ %d, a=8
vsnprintf: return str=#define __SIZEOF_POINTER__ 8
format_string1: size=160, format=#define __SIZEOF_LONG__ %d, a=8
vsnprintf: return str=#define __SIZEOF_LONG__ 8
format_string2: size=134, format=#define %s%s, a0=__STDC__, a1= 1
vsnprintf: return str=#define __STDC__ 1
format_string1: size=115, format=#define __STDC_VERSION__ %dL, a=199901
vsnprintf: return str=#define __STDC_VERSION__ 199901L
format_string1: size=356, format=#define __BASE_FILE__ &quot;%s&quot;, a=hello.c
vsnprintf: return str=#define __BASE_FILE__ &quot;hello.c&quot;
read: fd=3, nbyte=8192
read: return buf=
    int main(int argc, char *argv[]) {
      printf(&quot;Hello, World!!\n&quot;);
      return 0;
    }
  
format_string2: size=128, format=%s:%d: , a0=hello.c, a1=3
vsnprintf: return str=hello.c:3: 
format_string0: size=117, format=warning: 
vsnprintf: return str=warning: 
format_string1: size=108, format=implicit declaration of function &#39;%s&#39;, a=printf
vsnprintf: return str=implicit declaration of function &#39;printf&#39;
format_string1: size=0, format=%s, a=hello.c:3: warning: implicit declaration of function &#39;printf&#39;
fprintf: stream=tcc-wasm.FILE@2
hello.c:3: warning: implicit declaration of function &#39;printf&#39;
format_string1: size=0, format=L.%u, a=0
sprintf: return str=L.0
format_string1: size=256, format=.rela%s, a=.text
snprintf: return str=.rela.text
read: fd=3, nbyte=8192
read: return buf=
close: fd=3
sem_post: sem=tcc-wasm.sem_t@10cfe8
format_string1: size=1024, format=%s, a=hello.c
snprintf: return str=hello.c
unlink: path=hello.o
open: path=hello.o, oflag=577, return fd=4
fdopen: fd=4, mode=wb, return FILE=5
...
close: stream=tcc-wasm.FILE@5
a.out: 1040 bytes
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/3e650bd6ad72b2e8ee8596858bc94f36">(See the Complete Log)</a></p>
<p>TODO: Implement sscanf: <code>str=0.9.27, format=%d.%d.%d</code></p>
<h1 id="test-tcc-output-with-nuttx"><a href="#test-tcc-output-with-nuttx">17 Test TCC Output with NuttX</a></h1>
<p>TODO</p>
<p><em>TCC in WebAssembly has compiled our C Program into the ELF Binary <code>a.out</code>. What happens when we run it on NuttX?</em></p>
<p>Let‚Äôs run the TCC Output <code>a.out</code> on NuttX! We copy <code>a.out</code> to NuttX Apps Filesystem‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>mv ~/Downloads/a.out ~/riscv/apps/bin/
chmod +x ~/riscv/apps/bin/*
file  ~/riscv/apps/bin/a.out
ls -l ~/riscv/apps/bin
</code></pre></div>
<p>Which shows‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ file  ~/riscv/apps/bin/a.out
~/riscv/apps/bin/a.out: ELF 64-bit LSB relocatable, UCB RISC-V, version 1 (SYSV), not stripped

$ ls -l ~/riscv/apps/bin
total 4744
-rwxr-xr-x@ 1   1040 Jan 29 09:24 a.out
-rwxr-xr-x  1 200176 Jan 29 09:05 getprime
-rwxr-xr-x  1 119560 Jan 29 09:05 hello
-rwxr-xr-x  1 697368 Jan 29 09:05 init
-rwxr-xr-x  1 703840 Jan 29 09:05 ostest
-rwxr-xr-x  1 694648 Jan 29 09:05 sh
</code></pre></div>
<p>Then we boot NuttX on QEMU (64-bit RISC-V) and run <code>a.out</code> on NuttX‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; a.out
[   23.292000] load_absmodule: Loading /system/bin/a.out
[   23.293000] elf_loadbinary: Loading file: /system/bin/a.out
[   23.294000] elf_init: filename: /system/bin/a.out loadinfo: 0x8020afa8
[   23.295000] elf_read: Read 64 bytes from offset 0
[   23.297000] elf_dumploadinfo: LOAD_INFO:
[   23.298000] elf_dumploadinfo:   textalloc:    00000000
[   23.299000] elf_dumploadinfo:   dataalloc:    00000000
[   23.300000] elf_dumploadinfo:   textsize:     0
[   23.301000] elf_dumploadinfo:   datasize:     0
[   23.303000] elf_dumploadinfo:   textalign:    0
[   23.304000] elf_dumploadinfo:   dataalign:    0
[   23.305000] elf_dumploadinfo:   filelen:      1040
[   23.305000] elf_dumploadinfo:   symtabidx:    0
[   23.306000] elf_dumploadinfo:   strtabidx:    0
[   23.307000] elf_dumploadinfo: ELF Header:
[   23.308000] elf_dumploadinfo:   e_ident:      7f 45 4c 46
[   23.309000] elf_dumploadinfo:   e_type:       0001
[   23.310000] elf_dumploadinfo:   e_machine:    00f3
[   23.311000] elf_dumploadinfo:   e_version:    00000001
[   23.312000] elf_dumploadinfo:   e_entry:      00000000
[   23.313000] elf_dumploadinfo:   e_phoff:      0
[   23.314000] elf_dumploadinfo:   e_shoff:      464
[   23.315000] elf_dumploadinfo:   e_flags:      00000004
[   23.316000] elf_dumploadinfo:   e_ehsize:     64
[   23.317000] elf_dumploadinfo:   e_phentsize:  0
[   23.318000] elf_dumploadinfo:   e_phnum:      0
[   23.319000] elf_dumploadinfo:   e_shentsize:  64
[   23.320000] elf_dumploadinfo:   e_shnum:      9
[   23.321000] elf_dumploadinfo:   e_shstrndx:   8
[   23.323000] elf_load: loadinfo: 0x8020afa8
[   23.324000] elf_loadphdrs: No programs(?)
[   23.325000] elf_read: Read 576 bytes from offset 464
[   23.381000] elf_loadfile: Loaded sections:
[   23.382000] elf_read: Read 64 bytes from offset 64
[   23.382000] elf_loadfile: 1. 00000000-&gt;c0000000
[   23.383000] elf_read: Read 0 bytes from offset 128
[   23.383000] elf_loadfile: 2. 00000000-&gt;c0101000
[   23.383000] elf_read: Read 16 bytes from offset 128
[   23.385000] elf_loadfile: 3. 00000000-&gt;c0101000
[   23.387000] elf_loadfile: 4. 00000000-&gt;c0101010
[   23.388000] elf_dumploadinfo: LOAD_INFO:
[   23.390000] elf_dumploadinfo:   textalloc:    c0000000
[   23.390000] elf_dumploadinfo:   dataalloc:    c0101000
[   23.390000] elf_dumploadinfo:   textsize:     64
[   23.391000] elf_dumploadinfo:   datasize:     16
[   23.392000] elf_dumploadinfo:   textalign:    8
[   23.393000] elf_dumploadinfo:   dataalign:    8
[   23.393000] elf_dumploadinfo:   filelen:      1040
[   23.393000] elf_dumploadinfo:   symtabidx:    0
[   23.395000] elf_dumploadinfo:   strtabidx:    0
[   23.395000] elf_dumploadinfo: ELF Header:
[   23.395000] elf_dumploadinfo:   e_ident:      7f 45 4c 46
[   23.395000] elf_dumploadinfo:   e_type:       0001
[   23.396000] elf_dumploadinfo:   e_machine:    00f3
[   23.396000] elf_dumploadinfo:   e_version:    00000001
[   23.396000] elf_dumploadinfo:   e_entry:      00000000
[   23.397000] elf_dumploadinfo:   e_phoff:      0
[   23.397000] elf_dumploadinfo:   e_shoff:      464
[   23.397000] elf_dumploadinfo:   e_flags:      00000004
[   23.399000] elf_dumploadinfo:   e_ehsize:     64
[   23.400000] elf_dumploadinfo:   e_phentsize:  0
[   23.401000] elf_dumploadinfo:   e_phnum:      0
[   23.402000] elf_dumploadinfo:   e_shentsize:  64
[   23.403000] elf_dumploadinfo:   e_shnum:      9
[   23.403000] elf_dumploadinfo:   e_shstrndx:   8
[   23.403000] elf_dumploadinfo: Sections 0:
[   23.405000] elf_dumploadinfo:   sh_name:      00000000
[   23.406000] elf_dumploadinfo:   sh_type:      00000000
[   23.407000] elf_dumploadinfo:   sh_flags:     00000000
[   23.407000] elf_dumploadinfo:   sh_addr:      00000000
[   23.409000] elf_dumploadinfo:   sh_offset:    0
[   23.410000] elf_dumploadinfo:   sh_size:      0
[   23.412000] elf_dumploadinfo:   sh_link:      0
[   23.413000] elf_dumploadinfo:   sh_info:      0
[   23.414000] elf_dumploadinfo:   sh_addralign: 0
[   23.415000] elf_dumploadinfo:   sh_entsize:   0
[   23.416000] elf_dumploadinfo: Sections 1:
[   23.417000] elf_dumploadinfo:   sh_name:      00000001
[   23.419000] elf_dumploadinfo:   sh_type:      00000001
[   23.420000] elf_dumploadinfo:   sh_flags:     00000006
[   23.422000] elf_dumploadinfo:   sh_addr:      c0000000
[   23.423000] elf_dumploadinfo:   sh_offset:    64
[   23.426000] elf_dumploadinfo:   sh_size:      64
[   23.427000] elf_dumploadinfo:   sh_link:      0
[   23.428000] elf_dumploadinfo:   sh_info:      0
[   23.429000] elf_dumploadinfo:   sh_addralign: 8
[   23.430000] elf_dumploadinfo:   sh_entsize:   0
[   23.431000] elf_dumploadinfo: Sections 2:
[   23.432000] elf_dumploadinfo:   sh_name:      00000007
[   23.432000] elf_dumploadinfo:   sh_type:      00000001
[   23.433000] elf_dumploadinfo:   sh_flags:     00000003
[   23.433000] elf_dumploadinfo:   sh_addr:      c0101000
[   23.433000] elf_dumploadinfo:   sh_offset:    128
[   23.433000] elf_dumploadinfo:   sh_size:      0
[   23.433000] elf_dumploadinfo:   sh_link:      0
[   23.435000] elf_dumploadinfo:   sh_info:      0
[   23.435000] elf_dumploadinfo:   sh_addralign: 8
[   23.436000] elf_dumploadinfo:   sh_entsize:   0
[   23.437000] elf_dumploadinfo: Sections 3:
[   23.438000] elf_dumploadinfo:   sh_name:      0000000d
[   23.439000] elf_dumploadinfo:   sh_type:      00000001
[   23.442000] elf_dumploadinfo:   sh_flags:     00000003
[   23.443000] elf_dumploadinfo:   sh_addr:      c0101000
[   23.444000] elf_dumploadinfo:   sh_offset:    128
[   23.445000] elf_dumploadinfo:   sh_size:      16
[   23.446000] elf_dumploadinfo:   sh_link:      0
[   23.447000] elf_dumploadinfo:   sh_info:      0
[   23.447000] elf_dumploadinfo:   sh_addralign: 8
[   23.447000] elf_dumploadinfo:   sh_entsize:   0
[   23.447000] elf_dumploadinfo: Sections 4:
[   23.447000] elf_dumploadinfo:   sh_name:      00000016
[   23.448000] elf_dumploadinfo:   sh_type:      00000008
[   23.450000] elf_dumploadinfo:   sh_flags:     00000003
[   23.451000] elf_dumploadinfo:   sh_addr:      c0101010
[   23.453000] elf_dumploadinfo:   sh_offset:    144
[   23.454000] elf_dumploadinfo:   sh_size:      0
[   23.456000] elf_dumploadinfo:   sh_link:      0
[   23.457000] elf_dumploadinfo:   sh_info:      0
[   23.458000] elf_dumploadinfo:   sh_addralign: 8
[   23.460000] elf_dumploadinfo:   sh_entsize:   0
[   23.462000] elf_dumploadinfo: Sections 5:
[   23.463000] elf_dumploadinfo:   sh_name:      0000001b
[   23.464000] elf_dumploadinfo:   sh_type:      00000002
[   23.465000] elf_dumploadinfo:   sh_flags:     00000000
[   23.467000] elf_dumploadinfo:   sh_addr:      00000000
[   23.468000] elf_dumploadinfo:   sh_offset:    144
[   23.469000] elf_dumploadinfo:   sh_size:      144
[   23.471000] elf_dumploadinfo:   sh_link:      6
[   23.473000] elf_dumploadinfo:   sh_info:      4
[   23.474000] elf_dumploadinfo:   sh_addralign: 8
[   23.475000] elf_dumploadinfo:   sh_entsize:   24
[   23.477000] elf_dumploadinfo: Sections 6:
[   23.477000] elf_dumploadinfo:   sh_name:      00000023
[   23.479000] elf_dumploadinfo:   sh_type:      00000003
[   23.480000] elf_dumploadinfo:   sh_flags:     00000000
[   23.481000] elf_dumploadinfo:   sh_addr:      00000000
[   23.482000] elf_dumploadinfo:   sh_offset:    288
[   23.484000] elf_dumploadinfo:   sh_size:      25
[   23.485000] elf_dumploadinfo:   sh_link:      0
[   23.486000] elf_dumploadinfo:   sh_info:      0
[   23.487000] elf_dumploadinfo:   sh_addralign: 1
[   23.488000] elf_dumploadinfo:   sh_entsize:   0
[   23.489000] elf_dumploadinfo: Sections 7:
[   23.490000] elf_dumploadinfo:   sh_name:      0000002b
[   23.491000] elf_dumploadinfo:   sh_type:      00000004
[   23.493000] elf_dumploadinfo:   sh_flags:     00000000
[   23.494000] elf_dumploadinfo:   sh_addr:      00000000
[   23.495000] elf_dumploadinfo:   sh_offset:    320
[   23.496000] elf_dumploadinfo:   sh_size:      72
[   23.498000] elf_dumploadinfo:   sh_link:      5
[   23.499000] elf_dumploadinfo:   sh_info:      1
[   23.500000] elf_dumploadinfo:   sh_addralign: 8
[   23.501000] elf_dumploadinfo:   sh_entsize:   24
[   23.502000] elf_dumploadinfo: Sections 8:
[   23.504000] elf_dumploadinfo:   sh_name:      00000036
[   23.505000] elf_dumploadinfo:   sh_type:      00000003
[   23.507000] elf_dumploadinfo:   sh_flags:     00000000
[   23.508000] elf_dumploadinfo:   sh_addr:      00000000
[   23.509000] elf_dumploadinfo:   sh_offset:    400
[   23.510000] elf_dumploadinfo:   sh_size:      64
[   23.511000] elf_dumploadinfo:   sh_link:      0
[   23.512000] elf_dumploadinfo:   sh_info:      0
[   23.513000] elf_dumploadinfo:   sh_addralign: 1
[   23.514000] elf_dumploadinfo:   sh_entsize:   0
[   23.518000] elf_read: Read 72 bytes from offset 320
[   23.519000] elf_read: Read 24 bytes from offset 192
[   23.521000] elf_symvalue: Other: 00000000+c0101000=c0101000
[   23.523000] up_relocateadd: PCREL_HI20 at c000001c [00000517] to sym=0x80209030 st_value=c0101000
[   23.530000] _calc_imm: offset=1052644: hi=257 lo=-28
[   23.535000] elf_read: Read 24 bytes from offset 216
[   23.536000] elf_symvalue: Other: 0000001c+c0000000=c000001c
[   23.536000] up_relocateadd: PCREL_LO12_I at c0000020 [00050513] to sym=0x80209070 st_value=c000001c
[   23.537000] _calc_imm: offset=1052644: hi=257 lo=-28
[   23.539000] elf_read: Read 24 bytes from offset 264
[   23.541000] elf_read: Read 32 bytes from offset 306
[   23.542000] elf_symvalue: SHN_UNDEF: Exported symbol &quot;printf&quot; not found
[   23.549000] elf_relocateadd: Section 7 reloc 2: Failed to get value of symbol[5]: -2
[   23.556000] elf_loadbinary: Failed to bind symbols program binary: -2
[   23.562000] exec_internal: ERROR: Failed to load program &#39;a.out&#39;: -2
nsh: a.out: command not found
nsh&gt; 
</code></pre></div>
<p>It says <code>printf</code> is missing. Let‚Äôs fix it‚Ä¶</p>
<p>For Reference: Here‚Äôs the log for an ELF that loads properly on NuttX: <a href="https://gist.github.com/lupyuen/847f7adee50499cac5212f2b95d19cd3">NuttX ELF Loader Log</a></p>
<h1 id="how-nuttx-build-links-a-nuttx-app"><a href="#how-nuttx-build-links-a-nuttx-app">18 How NuttX Build links a NuttX App</a></h1>
<p>TODO</p>
<p><em><code>printf</code> is missing from our TCC Output <code>a.out</code>. How does NuttX Build link a NuttX App?</em></p>
<p>Let‚Äôs find out‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>cd apps
rm bin/hello
make --trace import
</code></pre></div>
<p>We see the Linker Command that produces the <code>hello</code> app‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>riscv-none-elf-ld \
  --oformat elf64-littleriscv \
  -e _start \
  -Bstatic \
  -Tapps/import/scripts/gnu-elf.ld \
  -Lapps/import/libs \
  -L &quot;xpack-riscv-none-elf-gcc-13.2.0-2/bin/../lib/gcc/riscv-none-elf/13.2.0/rv64imafdc_zicsr/lp64d&quot; apps/import/startup/crt0.o  hello_main.c.workspaces.bookworm.apps.examples.hello.o \
  --start-group \
  -lmm \
  -lc \
  -lproxies \
  -lgcc apps/libapps.a xpack-riscv-none-elf-gcc-13.2.0-2/bin/../lib/gcc/riscv-none-elf/13.2.0/rv64imafdc_zicsr/lp64d/libgcc.a \
  --end-group \
  -o  apps/bin/hello
</code></pre></div>
<p>This says that NuttX Build links NuttX Apps with these libraries‚Ä¶</p>
<ul>
<li>
<p><code>crt0.o</code>: Start Code <a href="https://github.com/apache/nuttx/blob/master/arch/risc-v/src/common/crt0.c#L144-L194"><code>_start</code></a></p>
</li>
<li>
<p><code>-lmm</code>: Mmmmm?</p>
</li>
<li>
<p><code>-lc</code>: C Library</p>
</li>
<li>
<p><code>-lproxies</code>: <a href="https://lupyuen.github.io/articles/app#nuttx-app-calls-nuttx-kernel">NuttX Proxy Functions</a> for NuttX System Calls</p>
</li>
<li>
<p><code>-lgcc libgcc.a</code>: GCC Library</p>
</li>
</ul>
<p>Which are located at <code>apps/import/libs</code>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ ls -l apps/import/libs
total 18776
-rwxr-xr-x 1 3132730 Jan 29 02:12 libapps.a
-rw-r--r-- 1    1064 Jan 29 01:18 libarch.a
-rw-r--r-- 1 8946828 Jan 29 01:18 libc.a
-rw-r--r-- 1 1462710 Sep 24 08:10 libgcc.a
-rw-r--r-- 1 1276866 Jan 29 01:18 libm.a
-rw-r--r-- 1 1304366 Jan 29 01:18 libmm.a
-rw-r--r-- 1 3086312 Jan 29 01:18 libproxies.a
</code></pre></div>
<p>Let‚Äôs run TCC to link <code>a.out</code> with the above libraries‚Ä¶</p>
<h1 id="fix-missing-printf-in-nuttx-app"><a href="#fix-missing-printf-in-nuttx-app">19 Fix Missing <code>printf</code> in NuttX App</a></h1>
<p>TODO</p>
<p>We run TCC to link <code>a.out</code> with the above libraries‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>tcc-riscv32-wasm/riscv64-tcc \
  -nostdlib \
  apps/import/startup/crt0.o \
  apps/bin/a.out \
  apps/import/libs/libmm.a \
  apps/import/libs/libc.a \
  apps/import/libs/libproxies.a \
  apps/import/libs/libgcc.a
</code></pre></div>
<p>It says‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>tcc: error: Unknown relocation type for got: 60
</code></pre></div>
<p>When we remove <code>libproxies.a</code>, we don‚Äôt see the Unknown Relocation Type‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ tcc-riscv32-wasm/riscv64-tcc \
  -nostdlib \
  apps/import/startup/crt0.o \
  apps/bin/a.out \
  apps/import/libs/libmm.a \
  apps/import/libs/libc.a \
  apps/import/libs/libgcc.a

tcc: error: undefined symbol &#39;_exit&#39;
tcc: error: undefined symbol &#39;_assert&#39;
tcc: error: undefined symbol &#39;nxsem_destroy&#39;
tcc: error: undefined symbol &#39;gettid&#39;
tcc: error: undefined symbol &#39;nxsem_wait&#39;
tcc: error: undefined symbol &#39;nxsem_trywait&#39;
tcc: error: undefined symbol &#39;clock_gettime&#39;
tcc: error: undefined symbol &#39;nxsem_clockwait&#39;
tcc: error: undefined symbol &#39;nxsem_post&#39;
tcc: error: undefined symbol &#39;write&#39;
tcc: error: undefined symbol &#39;lseek&#39;
tcc: error: undefined symbol &#39;nx_pthread_exit&#39;
</code></pre></div>
<p>Why is <code>libproxies.a</code> using Relocation Type 60? We dump the Proxy Object File‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>riscv-none-elf-readelf --wide -all nuttx/syscall/PROXY_write.o
</code></pre></div>
<p>TODO: Check the <a href="https://gist.github.com/lupyuen/cb0484ec055a7a7dfa34b8a8a34244ee">ELF Dump</a></p>
<p>Let‚Äôs link the Proxy Functions ourselves‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>tcc-riscv32-wasm/riscv64-tcc \
  -nostdlib \
  apps/bin/a.out \
  nuttx/syscall/PROXY__exit.o \
  nuttx/syscall/PROXY__assert.o \
  nuttx/syscall/PROXY_nxsem_destroy.o \
  nuttx/syscall/PROXY_gettid.o \
  nuttx/syscall/PROXY_nxsem_wait.o \
  nuttx/syscall/PROXY_nxsem_trywait.o \
  nuttx/syscall/PROXY_clock_gettime.o \
  nuttx/syscall/PROXY_nxsem_clockwait.o \
  nuttx/syscall/PROXY_nxsem_post.o \
  nuttx/syscall/PROXY_write.o \
  nuttx/syscall/PROXY_lseek.o \
  nuttx/syscall/PROXY_nx_pthread_exit.o \
  apps/import/startup/crt0.o \
  apps/import/libs/libmm.a \
  apps/import/libs/libc.a \
  apps/import/libs/libgcc.a
</code></pre></div>
<p><em>Does it work?</em></p>
<p>Arg nope‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>tcc: error: Unknown relocation type for got: 60
</code></pre></div>
<p>Now Unknown Relocation Type is coming from <code>libc.a</code>. If we remove <code>libc.a</code>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ tcc-riscv32-wasm/riscv64-tcc \
  -nostdlib \
  apps/import/startup/crt0.o \
  apps/bin/a.out \
  nuttx/syscall/PROXY__exit.o \
  nuttx/syscall/PROXY__assert.o \
  nuttx/syscall/PROXY_nxsem_destroy.o \
  nuttx/syscall/PROXY_gettid.o \
  nuttx/syscall/PROXY_nxsem_wait.o \
  nuttx/syscall/PROXY_nxsem_trywait.o \
  nuttx/syscall/PROXY_clock_gettime.o \
  nuttx/syscall/PROXY_nxsem_clockwait.o \
  nuttx/syscall/PROXY_nxsem_post.o \
  nuttx/syscall/PROXY_write.o \
  nuttx/syscall/PROXY_lseek.o \
  nuttx/syscall/PROXY_nx_pthread_exit.o \
  apps/import/libs/libmm.a

tcc: error: undefined symbol &#39;printf&#39;
tcc: error: undefined symbol &#39;exit&#39;
</code></pre></div>
<p><em>What if we call <code>write</code> directly? (Since <code>write</code> is a Proxy to NuttX System Call) And stub out <code>exit</code>?</em></p>
<div class="example-wrap"><pre class="language-c"><code>int write(int fildes, const void *buf, int nbyte);

int main(int argc, char *argv[]) {
  const char msg[] = &quot;Hello, World!!\\n&quot;;
  write(1, msg, sizeof(msg));
  return 0;
}

void exit(int status) {
  const char msg[] = &quot;TODO: exit\\n&quot;;
  write(1, msg, sizeof(msg));
}
</code></pre></div>
<p>Still the same sigh‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>tcc: error: Unknown relocation type for got: 60
</code></pre></div>
<p>Let‚Äôs skip everything, we link only <code>a.out</code>. Since the other modules are causing the Unknown Relocation Type.</p>
<p>We discovered that <code>a.out</code> must be Relocatable Code, otherwise it crashes in NuttX. So we add <code>-r</code> to TCC Compiler Options in our modified <a href="https://github.com/lupyuen/tcc-riscv32-wasm/blob/main/zig/test.js#L48-L64">test.js</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Allocate a String for passing the Compiler Options to Zig
  const options = [&quot;-c&quot;, &quot;-r&quot;, &quot;hello.c&quot;];
  const options_ptr = allocateString(JSON.stringify(options));

  // Allocate a String for passing Program Code to Zig
  const code_ptr = allocateString(`
    int main(int argc, char *argv[]) {
      return 0;
    }
  `);

  // Call TCC to compile a program
  const ptr = wasm.instance.exports
    .compile_program(options_ptr, code_ptr);
  console.log(`ptr=${ptr}`);
</code></pre></div>
<p>And we run <code>a.out</code> on NuttX. Now we get an <a href="https://gist.github.com/lupyuen/a715e4e77c011d610d0b418e97f8bf5d">Instruction Page Fault</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-12.4.0
nsh&gt; a.out
...
[    6.240000] binfmt_copyargv: args=2 argsize=23
[    6.240000] exec_module: Initialize the user heap (heapsize=528384)
[    6.242000] riscv_exception: EXCEPTION: Instruction page fault. MCAUSE: 000000000000000c, EPC: 000000008000ad8a, MTVAL: 000000008000ad8a
[    6.242000] riscv_exception: PANIC!!! Exception = 000000000000000c
[    6.242000] _assert: Current Version: NuttX  12.4.0 f8b0b06b978 Jan 29 2024 01:16:20 risc-v
[    6.242000] _assert: Assertion failed panic: at file: common/riscv_exception.c:85 task: /system/bin/init process: /system/bin/init 0xc000001a
[    6.242000] up_dump_register: EPC: 000000008000ad8a
</code></pre></div>
<p><em>Where is the Exception Program Counter 0x8000ad8a?</em></p>
<p>0x8000ad8a is actually in NuttX Kernel‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>up_task_start():
nuttx/arch/risc-v/src/common/riscv_task_start.c:65
void up_task_start(main_t taskentry, int argc, char *argv[]) {
    8000ad7a:	1141                	add	sp,sp,-16
    8000ad7c:	86b2                	mv	a3,a2
nuttx/arch/risc-v/src/common/riscv_task_start.c:68
  /* Let sys_call3() do all of the work */

  sys_call3(SYS_task_start, (uintptr_t)taskentry, (uintptr_t)argc,
    8000ad7e:	862e                	mv	a2,a1
    8000ad80:	85aa                	mv	a1,a0
    8000ad82:	4511                	li	a0,4
nuttx/arch/risc-v/src/common/riscv_task_start.c:65
    8000ad84:	e406                	sd	ra,8(sp)
nuttx/arch/risc-v/src/common/riscv_task_start.c:68
  sys_call3(SYS_task_start, (uintptr_t)taskentry, (uintptr_t)argc,
    8000ad86:	875f50ef          	jal	800005fa &lt;sys_call0&gt;
nuttx/arch/risc-v/src/common/riscv_task_start.c:71
            (uintptr_t)argv);
  PANIC();
    8000ad8a:	0000e617          	auipc	a2,0xe
</code></pre></div>
<p>Maybe NuttX Kernel crashed because our NuttX App terminated without calling <code>exit()</code>?</p>
<p>We‚Äôre guessing: NuttX Apps should NOT simply <code>ret</code> to the caller. They should call the NuttX System Call <code>__exit</code> to terminate peacefully.</p>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/risc-v/src/common/crt0.c#L144-L194">(As mentioned in <code>_start</code>)</a></p>
<p><em>But is our NuttX App actually started?</em></p>
<p>Let‚Äôs tweak our code to loop forever, see whether our app actually gets started‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Allocate a String for passing Program Code to Zig
  const code_ptr = allocateString(`
    int main(int argc, char *argv[]) {
      for (;;) {}
      return 0;
    }
  `);

  // Call TCC to compile a program
  const ptr = wasm.instance.exports
    .compile_program(options_ptr, code_ptr);
  console.log(`ptr=${ptr}`);
</code></pre></div>
<p>Yep NuttX hangs when starting our app! Which means our TCC Compiled App is actually started by NuttX yay!</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-12.4.0
nsh&gt; a.out
...
load_absmodule: Successfully loaded module /system/bin/a.out
binfmt_dumpmodule: Module:
binfmt_dumpmodule:   entrypt:   0xc0000000
binfmt_dumpmodule:   mapped:    0 size=0
binfmt_dumpmodule:   alloc:     0 0 0
binfmt_dumpmodule:   addrenv:   0x80209b80
binfmt_dumpmodule:   stacksize: 2048
binfmt_dumpmodule:   unload:    0
exec_module: Executing a.out
binfmt_copyargv: args=1 argsize=6
binfmt_copyargv: args=2 argsize=23
exec_module: Initialize the user heap (heapsize=528384)
&lt; ...NuttX Hangs... &gt;
</code></pre></div>
<p>(NuttX seems to be starting the first thing that appears in <code>a.out</code>)</p>
<p>TODO: Unknown Relocation Type may be due to <a href="https://lists.gnu.org/archive/html/tinycc-devel/2020-06/msg00000.html">Thread Local Storage</a> generated by GCC Compiler?</p>
<h1 id="ecall-for-nuttx-system-call"><a href="#ecall-for-nuttx-system-call">20 ECALL for NuttX System Call</a></h1>
<p>TODO</p>
<p><em>TCC fails to link our NuttX App because of Unknown Relocation Type for printf(). How else can we print something in our NuttX App?</em></p>
<p>We can make a <a href="https://lupyuen.github.io/articles/app#nuttx-app-calls-nuttx-kernel">NuttX System Call (ECALL)</a> to <code>write(fd, buf, buflen)</code>.</p>
<p>Directly in our C Code! Like this: <a href="https://github.com/lupyuen/tcc-riscv32-wasm/blob/main/zig/test-nuttx.js#L55-L87">test-nuttx.js</a></p>
<div class="example-wrap"><pre class="language-c"><code>  int main(int argc, char *argv[])
  {
    // Make NuttX System Call to write(fd, buf, buflen)
    const unsigned int nbr = 61; // SYS_write
    const void *parm1 = 1;       // File Descriptor (stdout)
    const void *parm2 = &quot;Hello, World!!\n&quot;; // Buffer
    const void *parm3 = 15; // Buffer Length

    // Execute ECALL for System Call to NuttX Kernel
    register long r0 asm(&quot;a0&quot;) = (long)(nbr);
    register long r1 asm(&quot;a1&quot;) = (long)(parm1);
    register long r2 asm(&quot;a2&quot;) = (long)(parm2);
    register long r3 asm(&quot;a3&quot;) = (long)(parm3);
  
    asm volatile
    (
      // ECALL for System Call to NuttX Kernel
      &quot;ecall \n&quot;

      // We inserted NOP, because TCC says it&#39;s invalid (see below)
      &quot;.word 0x0001 \n&quot;
      :: &quot;r&quot;(r0), &quot;r&quot;(r1), &quot;r&quot;(r2), &quot;r&quot;(r3)
      : &quot;memory&quot;
    );
  
    // TODO: TCC says this is invalid
    // asm volatile(&quot;nop&quot; : &quot;=r&quot;(r0));

    // Loop Forever
    for(;;) {}
    return 0;
  }
</code></pre></div>
<p>Why SysCall 61? Because that‚Äôs the value of <code>SYS_write</code> System Call according to <code>nuttx.S</code> (the RISC-V Disassembly of NuttX Kernel).</p>
<p><em>Does it work?</em></p>
<p>Nope we don‚Äôt see SysCall 61, but we see a SysCall 15 (what?)‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code>NuttShell (NSH) NuttX-12.4.0
nsh&gt; a.out
...
riscv_swint: Entry: regs: 0x8020be10 cmd: 15
up_dump_register: EPC: 00000000c000006c
up_dump_register: A0: 000000000000000f A1: 00000000c0202010 A2: 0000000000000001 A3: 00000000c0202010
up_dump_register: A4: 00000000c0000000 A5: 0000000000000000 A6: 0000000000000000 A7: 0000000000000000
up_dump_register: T0: 0000000000000000 T1: 0000000000000000 T2: 0000000000000000 T3: 0000000000000000
up_dump_register: T4: 0000000000000000 T5: 0000000000000000 T6: 0000000000000000
up_dump_register: S0: 00000000c0202800 S1: 0000000000000000 S2: 0000000000000000 S3: 0000000000000000
up_dump_register: S4: 0000000000000000 S5: 0000000000000000 S6: 0000000000000000 S7: 0000000000000000
up_dump_register: S8: 0000000000000000 S9: 0000000000000000 S10: 0000000000000000 S11: 0000000000000000
up_dump_register: SP: 00000000c02027a0 FP: 00000000c0202800 TP: 0000000000000000 RA: 000000008000adee
riscv_swint: SWInt Return: 7
</code></pre></div>
<p><em>But the registers A0, A1, A2 and A3 don‚Äôt look right!</em></p>
<p>Let‚Äôs hardcode Registers A0, A1, A2 and A3 in Machine Code (because TCC won‚Äôt assemble the <code>li</code> instruction): <a href="https://github.com/lupyuen/tcc-riscv32-wasm/blob/main/zig/test-nuttx.js#L55-L87">test-nuttx.js</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Load 61 to Register A0 (SYS_write)
// li a0, 61
&quot;.long 0x03d00513 \\n&quot;

// Load 1 to Register A1 (File Descriptor)
// li a1, 1
&quot;.long 0x00100593 \\n&quot;

// Load 0xc0101000 to Register A2 (Buffer)
// li a2, 0xc0101000
&quot;.long 0x000c0637 \\n&quot;
&quot;.long 0x1016061b \\n&quot;
&quot;.long 0x00c61613 \\n&quot;

// Load 15 to Register A3 (Buffer Length)
// li a3, 15
&quot;.long 0x00f00693 \\n&quot;

// ECALL for System Call to NuttX Kernel
&quot;ecall \\n&quot;

// We inserted NOP, because TCC says it&#39;s invalid (see below)
&quot;.word 0x0001 \\n&quot;
</code></pre></div>
<p>(We used this <a href="https://riscvasm.lucasteske.dev/#">RISC-V Online Assembler</a> to assemble the Machine Code)</p>
<p>When we run this, we see SysCall 61‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code>NuttShell (NSH) NuttX-12.4.0
nsh&gt; a.out
...
riscv_swint: Entry: regs: 0x8020be10 cmd: 61
up_dump_register: EPC: 00000000c0000084
up_dump_register: A0: 000000000000003d A1: 0000000000000001 A2: 00000000c0101000 A3: 000000000000000f
up_dump_register: A4: 00000000c0000000 A5: 0000000000000000 A6: 0000000000000000 A7: 0000000000000000
up_dump_register: T0: 0000000000000000 T1: 0000000000000000 T2: 0000000000000000 T3: 0000000000000000
up_dump_register: T4: 0000000000000000 T5: 0000000000000000 T6: 0000000000000000
up_dump_register: S0: 00000000c0202800 S1: 0000000000000000 S2: 0000000000000000 S3: 0000000000000000
up_dump_register: S4: 0000000000000000 S5: 0000000000000000 S6: 0000000000000000 S7: 0000000000000000
up_dump_register: S8: 0000000000000000 S9: 0000000000000000 S10: 0000000000000000 S11: 0000000000000000
up_dump_register: SP: 00000000c02027a0 FP: 00000000c0202800 TP: 0000000000000000 RA: 000000008000adee
riscv_swint: SWInt Return: 35
Hello, World!!
</code></pre></div>
<p>And ‚ÄúHello, World!!‚Äù is printed yay!</p>
<p><em>How did we figure out that the buffer is at 0xc0101000?</em></p>
<p>We saw this in the NuttX Log‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code>NuttShell (NSH) NuttX-12.4.0
nsh&gt; a.out
...
elf_read: Read 576 bytes from offset 512
elf_loadfile: Loaded sections:
elf_read: Read 154 bytes from offset 64
elf_loadfile: 1. 00000000-&gt;c0000000
elf_read: Read 0 bytes from offset 224
elf_loadfile: 2. 00000000-&gt;c0101000
elf_read: Read 16 bytes from offset 224
elf_loadfile: 3. 00000000-&gt;c0101000
elf_loadfile: 4. 00000000-&gt;c0101010
</code></pre></div>
<p>Which says that the NuttX ELF Loader copied 16 bytes from our NuttX App Data Section <code>.data.ro</code> to 0xc0101000. That‚Äôs all 15 bytes of ‚ÄúHello, World!!\n‚Äù, including the terminating null!</p>
<p><em>Something odd about the TCC-generated RISC-V Machine Code?</em></p>
<p>The registers seem to be mushed up in the generated RISC-V Machine Code. That‚Äôs why it was passing value 15 in Register A0. (Supposed to be Register A3)</p>
<div class="example-wrap"><pre class="language-text"><code>// register long a0 asm(&quot;a0&quot;) = 61; // SYS_write
// register long a1 asm(&quot;a1&quot;) = 1;  // File Descriptor (stdout)
// register long a2 asm(&quot;a2&quot;) = &quot;Hello, World!!\\n&quot;; // Buffer
// register long a3 asm(&quot;a3&quot;) = 15; // Buffer Length
// Execute ECALL for System Call to NuttX Kernel
// asm volatile (
// ECALL for System Call to NuttX Kernel
//   &quot;ecall \\n&quot;
//   &quot;.word 0x0001 \\n&quot;

main():
   0:   fc010113                add     sp,sp,-64
   4:   02113c23                sd      ra,56(sp)
   8:   02813823                sd      s0,48(sp)
   c:   04010413                add     s0,sp,64
  10:   00000013                nop
  14:   fea43423                sd      a0,-24(s0)
  18:   feb43023                sd      a1,-32(s0)

// Correct: Load Register A0 with 61 (SYS_write)
  1c:   03d0051b                addw    a0,zero,61
  20:   fca43c23                sd      a0,-40(s0)

// Nope: Load Register A0 with 1?
// Mixed up with Register A1! (Value 1)
  24:   0010051b                addw    a0,zero,1
  28:   fca43823                sd      a0,-48(s0)

// Nope: Load Register A0 with &quot;Hello World&quot;?
// Mixed up with Register A2!
  2c:   00000517                auipc   a0,0x0  2c: R_RISCV_PCREL_HI20  L.0
  30:   00050513                mv      a0,a0   30: R_RISCV_PCREL_LO12_I        .text
  34:   fca43423                sd      a0,-56(s0)

// Nope: Load Register A0 with 15?
// Mixed up with Register A3! (Value 15)
  38:   00f0051b                addw    a0,zero,15
  3c:   fca43023                sd      a0,-64(s0)

// Execute ECALL with Register A0 set to 15.
// Nope A0 should be 1!
  40:   00000073                ecall
  44:   0001                    nop

// Loop Forever
  46:   0000006f                j       46 &lt;main+0x46&gt;
  4a:   03813083                ld      ra,56(sp)
  4e:   03013403                ld      s0,48(sp)
  52:   04010113                add     sp,sp,64
  56:   00008067                ret
</code></pre></div>
<p>TODO: Is there a workaround? Do we paste the ECALL Machine Code ourselves?</p>
<p>TODO: Call the NuttX System Call <code>__exit</code> to terminate peacefully</p>
<h1 id="whats-next"><a href="#whats-next">21 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> (and the awesome NuttX and Zig Communities) for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-ox64"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-star64"><strong>My Other Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>Older Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/tcc.md"><strong>lupyuen.github.io/src/tcc.md</strong></a></p>
<h1 id="appendix-analysis-of-missing-functions"><a href="#appendix-analysis-of-missing-functions">22 Appendix: Analysis of Missing Functions</a></h1>
<p>TODO</p>
<p>TCC calls surprisingly few External Functions! We might get it running on WebAssembly. Here‚Äôs our analysis of the Missing Functions: <a href="zig/tcc-wasm.zig">zig/tcc-wasm.zig</a></p>
<h2 id="semaphore-functions"><a href="#semaphore-functions">22.1 Semaphore Functions</a></h2>
<p>TODO</p>
<p>Not sure why TCC uses Semaphores? Maybe we‚Äôll understand when we support <code>#include</code> files.</p>
<p>TODO: Borrow Semaphore Functions from where?</p>
<ul>
<li>sem_init, sem_post, sem_wait</li>
</ul>
<h2 id="standard-library"><a href="#standard-library">22.2 Standard Library</a></h2>
<p>TODO</p>
<p>qsort isn‚Äôt used right now. Maybe for the Linker later?</p>
<p>TODO: Borrow qsort from where?</p>
<ul>
<li>exit, qsort</li>
</ul>
<h2 id="time-functions"><a href="#time-functions">22.3 Time Functions</a></h2>
<p>TODO</p>
<p>Not used right now.</p>
<p>TODO: Borrow Time Functions from where?</p>
<ul>
<li>time, gettimeofday, localtime</li>
</ul>
<h2 id="math-functions"><a href="#math-functions">22.4 Math Functions</a></h2>
<p>TODO</p>
<p>Also not used right now.</p>
<p>TODO: Borrow Math Functions from where?</p>
<ul>
<li>ldexp</li>
</ul>
<h2 id="varargs-functions"><a href="#varargs-functions">22.5 Varargs Functions</a></h2>
<p>TODO</p>
<p>Varargs will be tricky to implement in Zig. Probably we should implement in C. Maybe MUSL?</p>
<p>Right now we‚Äôre doing simple Pattern Matching. But it won‚Äôt work for Real Programs.</p>
<ul>
<li>printf, snprintf, sprintf, vsnprintf</li>
<li>sscanf</li>
</ul>
<h2 id="filesystem-functions"><a href="#filesystem-functions">22.6 Filesystem Functions</a></h2>
<p>TODO</p>
<p>Will mock up these functions for WebAssembly. Maybe an Emulated Filesystem, similar to <a href="https://emscripten.org/docs/porting/files/file_systems_overview.html">Emscripten File System</a>?</p>
<ul>
<li>getcwd</li>
<li>remove, unlink</li>
</ul>
<h2 id="file-io-functions"><a href="#file-io-functions">22.7 File I/O Functions</a></h2>
<p>TODO</p>
<p>Will mock up these functions for WebAssembly. Right now we read only 1 simple C Source File, and produce only 1 Object File. No header files, no libraries. And it works!</p>
<p>But later we might need an Emulated Filesystem, similar to <a href="https://emscripten.org/docs/porting/files/file_systems_overview.html">Emscripten File System</a>. And our File I/O code will support Multiple Files with proper Buffer Overflow Checks.</p>
<ul>
<li>open, fopen, fdopen, </li>
<li>close, fclose</li>
<li>fprintf, fputc, fputs</li>
<li>read, fread</li>
<li>fwrite</li>
<li>fflush</li>
<li>fseek, ftell, lseek</li>
<li>puts</li>
</ul>
<h2 id="string-functions"><a href="#string-functions">22.8 String Functions</a></h2>
<p>TODO</p>
<p>Borrow from <a href="https://github.com/ZigEmbeddedGroup/foundation-libc">foundation-libc</a> and <a href="https://github.com/marler8997/ziglibc">ziglibc</a></p>
<ul>
<li>atoi</li>
<li>strcat, strchr, strcmp</li>
<li>strncmp, strncpy, strrchr</li>
<li>strstr, strtod, strtof</li>
<li>strtol, strtold, strtoll</li>
<li>strtoul, strtoull</li>
<li>strerror</li>
</ul>

    
</body>
</html>