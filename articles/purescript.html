<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Too many Embedded Logs? PureScript might help (Ox64 BL808 SBC / Apache NuttX RTOS)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Too many Embedded Logs? PureScript might help (Ox64 BL808 SBC / Apache NuttX RTOS)" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/purescript-title.png">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.codeberg.page/articles/purescript.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Too many Embedded Logs? PureScript might help (Ox64 BL808 SBC / Apache NuttX RTOS)</h1>
    <nav id="TOC"><ul>
<li><a href="#demo-walkthrough">1 Demo Walkthrough</a><ul></ul></li>
<li><a href="#explain-the-risc-v-exception">2 Explain the RISC-V Exception</a><ul></ul></li>
<li><a href="#parsing-apache-nuttx-rtos-logs-with-purescript">3 Parsing Apache NuttX RTOS Logs with PureScript</a><ul></ul></li>
<li><a href="#parse-nuttx-stack-dump-with-purescript">4 Parse NuttX Stack Dump with PureScript</a><ul></ul></li>
<li><a href="#parse-nuttx-exception-with-purescript">5 Parse NuttX Exception with PureScript</a><ul></ul></li>
<li><a href="#explain-nuttx-exception-with-purescript">6 Explain NuttX Exception with PureScript</a><ul></ul></li>
<li><a href="#rewrite-javascript-generated-by-purescript">7 Rewrite JavaScript generated by PureScript</a><ul></ul></li>
<li><a href="#call-purescript-from-nuttx-emulator">8 Call PureScript from NuttX Emulator</a><ul></ul></li>
<li><a href="#parse-nuttx-logs-in-nuttx-emulator">9 Parse NuttX Logs in NuttX Emulator</a><ul></ul></li>
<li><a href="#show-nuttx-disassembly-by-address">10 Show NuttX Disassembly by Address</a><ul></ul></li>
<li><a href="#identify-a-nuttx-address">11 Identify a NuttX Address</a><ul></ul></li>
<li><a href="#purescript-editor-for-nuttx">12 PureScript Editor for NuttX</a><ul></ul></li>
<li><a href="#bigint-in-purescript">13 BigInt in PureScript</a><ul></ul></li>
<li><a href="#run-parsecsv-in-nodejs">14 Run parseCSV in Node.js</a><ul></ul></li>
<li><a href="#run-parsecsv-in-web-browser">15 Run parseCSV in Web Browser</a><ul></ul></li>
<li><a href="#run-parsecsv-in-trypurescriptorg">16 Run parseCSV in try.purescript.org</a><ul></ul></li>
<li><a href="#compile-purescript-to-javascript-in-web-browser">17 Compile PureScript to JavaScript in Web Browser</a><ul></ul></li>
<li><a href="#whats-next">18 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>7 Mar 2024</em></p>
<p><img src="https://lupyuen.github.io/images/purescript-title.png" alt="TODO" /></p>
<p>Over the Lunar New Year holidays, we were porting <a href="TODO"><strong>QuickJS</strong></a> to <a href="TODO"><strong>Ox64 BL808 SBC</strong></a>. And we hit a <strong>Baffling Exception</strong> on <a href="TODO"><strong>Apache NuttX RTOS</strong></a>‚Ä¶</p>
<p>TODO: Pic</p>
<p>Which made us ponder (our life choices)‚Ä¶</p>
<ul>
<li>
<p>Can we show the <strong>RISC-V Exception</strong> promimently?</p>
<p>(Without scrolling back pages and pages of logs)</p>
</li>
<li>
<p>And <strong>Explain the Exception</strong></p>
<p>(For folks new to RISC-V Exceptions)</p>
</li>
<li>
<p>Analyse the <strong>Stack Dump</strong> and point out Interesting Addresses</p>
<p>(For Code, Data, BSS, Heap, ‚Ä¶)</p>
</li>
</ul>
<p>In this article, </p>
<p><a href="https://www.hackster.io/lupyuen/8-risc-v-sbc-on-a-real-time-operating-system-ox64-nuttx-474358"><strong>Ox64 BL808 64-bit RISC-V SBC</strong></a></p>
<p><a href="https://nuttx.apache.org/docs/latest/index.html"><strong>Apache NuttX RTOS</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/quickjs"><strong>QuickJS for NuttX</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/tinyemu2"><strong>TinyEMU WebAssembly for NuttX</strong></a></p>
<p><a href="https://developer.chrome.com/docs/capabilities/serial"><strong>Web Serial API</strong></a> with <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/blockly/term.js"><strong>Term.js</strong></a></p>
<p><img src="https://lupyuen.github.io/images/purescript-title.png" alt="Parsing Apache NuttX RTOS Logs with PureScript" /></p>
<p><a href="https://lupyuen.github.io/nuttx-tinyemu/purescript">(Try the Online Demo)</a></p>
<p><a href="https://youtu.be/9oBhy3P7pYc">(Watch the Demo on YouTube)</a></p>
<h1 id="demo-walkthrough"><a href="#demo-walkthrough">1 Demo Walkthrough</a></h1>
<p>TODO</p>
<p>We begin with the smarty stuff‚Ä¶</p>
<h1 id="explain-the-risc-v-exception"><a href="#explain-the-risc-v-exception">2 Explain the RISC-V Exception</a></h1>
<p><em>How did we explain the RISC-V Exception?</em></p>
<blockquote>
<p>‚ÄúWe hit a Load Page Fault. Our code at Code Address 8000a0e4 tried to access the Data Address 880203b88, which is Invalid‚Äù</p>
</blockquote>
<p>That‚Äôs our message that explains the <strong>RISC-V Exception</strong>‚Ä¶</p>
<ul>
<li>
<p><strong>MCAUSE 13</strong>: Cause of Exception</p>
</li>
<li>
<p><strong>EPC <code>8000_A0E4</code></strong>: Exception Program Counter</p>
</li>
<li>
<p><strong>MTVAL <code>8_8020_3B88</code></strong>: Exception Value</p>
</li>
</ul>
<p><strong>In PureScript:</strong> This is how we compose the helpful message: <a href="https://github.com/lupyuen/nuttx-purescript-parser/blob/main/src/Main.purs#L29-L51">Main.purs</a></p>
<div class="example-wrap"><pre class="language-purescript"><code>-- Explain the RISC-V Exception with mcause 13
-- `&lt;&gt;` will concat 2 strings
-- &quot;üéµ I never promised you a rose garden&quot;

explainException 13 epc mtval =
  &quot;We hit a Load Page Fault.&quot;
  &lt;&gt; &quot; Our code at Code Address &quot; &lt;&gt; epc
  &lt;&gt; &quot; tried to access the Data Address &quot; &lt;&gt; mtval
  &lt;&gt; &quot;, which is Invalid.&quot;
</code></pre></div>
<p><em>Hello Marvin the Martian?</em></p>
<p>Yeah we‚Äôll meet some alien symbols in PureScript.</p>
<p>‚Äò<strong><code>&lt;&gt;</code></strong>‚Äô <em>(Diamond Operator)</em> will <strong>concatenate 2 strings</strong>.</p>
<p>We explain the other RISC-V Exceptions the same way‚Ä¶</p>
<div class="example-wrap"><pre class="language-purescript"><code>-- Explain the RISC-V Exception with mcause 12
-- `&lt;&gt;` will concat 2 strings

explainException 12 epc mtval =
  &quot;Instruction Page Fault at &quot; &lt;&gt; epc &lt;&gt; &quot;, &quot; &lt;&gt; mtval

-- Explain the Other RISC-V Exceptions,
-- that are not matched with the above.
-- `show` converts a Number to a String

explainException mcause epc mtval =
  &quot;Unknown Exception: mcause=&quot; &lt;&gt; show mcause &lt;&gt; &quot;, epc=&quot; &lt;&gt; epc &lt;&gt; &quot;, mtval=&quot; &lt;&gt; mtval
</code></pre></div>
<p>Which looks like a neat bunch of <strong>Explain Rules</strong>. (Similar to Prolog!)</p>
<p>This thing about PureScript looks totally alien‚Ä¶</p>
<div class="example-wrap"><pre class="language-purescript"><code>-- Declare the Function Type. We can actually erase it, VSCode PureScript Extension will helpfully suggest it for us.

explainException ‚à∑ 
  Int       -- MCAUSE: Cause of Exception
  ‚Üí String  -- EPC: Exception Program Counter
  ‚Üí String  -- MTVAL: Exception Value
  ‚Üí String  -- Returns the Exception Explanation
</code></pre></div>
<p>But it works like a <strong>Function Declaration</strong> in C.</p>
<p><a href="TODO">(<strong>VSCode</strong> will auto-generate it)</a></p>
<p><em>How will we call this from JavaScript?</em></p>
<p>Inside our <strong>Web Browser JavaScript</strong>, this is how we call PureScript: <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/purescript/term.js#L1521-L1528">term.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// In JavaScript: Call PureScript via a Curried Function.
// Returns &quot;Code Address 8000a0e4 failed to access Data Address 880203b88&quot;
result = explainException(13)(&quot;8000a0e4&quot;)(&quot;880203b88&quot;);

// Instead of the normal non-spicy Uncurried Way:
// explainException(13, &quot;8000a0e4&quot;, &quot;880203b88&quot;)
</code></pre></div>
<p>Our JavaScript will call PureScript the (yummy) <a href="https://en.wikipedia.org/wiki/Partial_application"><strong>Curried Way</strong></a>.</p>
<p>(Because PureScript is a Functional Programming Language)</p>
<p><em>Why PureScript? Could‚Äôve done all this in JavaScript‚Ä¶</em></p>
<p>TODO: Why</p>
<h1 id="parsing-apache-nuttx-rtos-logs-with-purescript"><a href="#parsing-apache-nuttx-rtos-logs-with-purescript">3 Parsing Apache NuttX RTOS Logs with PureScript</a></h1>
<p>TODO</p>
<p>In the Web Browser, we can get Real-Time Logs from NuttX Devices (Web Serial API) NuttX Emulator (Term.js)‚Ä¶</p>
<p>What if we could Analyse the NuttX Logs in Real-Time? And show the results in the Web Browser?</p>
<p>Like for <a href="https://gist.github.com/lupyuen/a715e4e77c011d610d0b418e97f8bf5d#file-nuttx-tcc-app-log-L168-L224">Stack Dumps</a>, <a href="https://gist.github.com/lupyuen/a715e4e77c011d610d0b418e97f8bf5d#file-nuttx-tcc-app-log-L1-L167">ELF Loader Log</a>, <a href="https://docs.google.com/spreadsheets/d/1g0-O2qdgjwNfSIxfayNzpUN8mmMyWFmRf2dMyQ9a8JI/edit#gid=0">Memory Manager Log</a> (malloc / free)?</p>
<p>Let‚Äôs do it with PureScript, since Functional Languages are better for Parsing Text.</p>
<p>And we‚Äôll support Online Scripting of our PureScript for Log Parsing, similar to <a href="https://try.purescript.org/">try.purescript.org</a></p>
<p>(Also automate the <a href="https://nuttx.apache.org/docs/latest/guides/cortexmhardfaults.html#">Stack Dump Analysis</a>)</p>
<p>(Here‚Äôs a <a href="https://lupyuen.github.io/nuttx-tinyemu/purescript/">NuttX Emulator that crashes</a>. Guess why?)</p>
<p><em>Why not code all this in JavaScript instead of PureScript?</em></p>
<p>(1) NuttX Logs might appear differently over time. Good to have a quick way to patch our parser as the NuttX Logs change.</p>
<p>(2) We need to implement high-level Declarative Rules that will interpret the parsed NuttX Logs. We might adjust the Rules over time.</p>
<p>(FYI Parsing CSV in JavaScript <a href="https://github.com/Chevrotain/chevrotain/blob/master/examples/grammars/csv/csv.js">looks like this</a>)</p>
<p><em>Why PureScript instead of Haskell?</em></p>
<p>Right now our NuttX Logs are accessible in a Web Browser through JavaScript: NuttX Emulator (over WebAssembly) and NuttX Device (over Web Serial API).</p>
<p>PureScript is probably easier to run in a Web Browser for processing the JavaScript Logs.</p>
<p><a href="https://github.com/zephyrproject-rtos/zephyr/issues/4416">(Zephyr Stack Dumps are also complicated)</a></p>
<h1 id="parse-nuttx-stack-dump-with-purescript"><a href="#parse-nuttx-stack-dump-with-purescript">4 Parse NuttX Stack Dump with PureScript</a></h1>
<p>TODO</p>
<p>Let‚Äôs parse the <a href="https://gist.github.com/lupyuen/a715e4e77c011d610d0b418e97f8bf5d#file-nuttx-tcc-app-log-L168-L224">NuttX Stack Dump</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>[    6.242000] riscv_exception: EXCEPTION: Instruction page fault. MCAUSE: 000000000000000c, EPC: 000000008000ad8a, MTVAL: 000000008000ad8a
[    6.242000] riscv_exception: PANIC!!! Exception = 000000000000000c
[    6.242000] _assert: Current Version: NuttX  12.4.0 f8b0b06b978 Jan 29 2024 01:16:20 risc-v
[    6.242000] _assert: Assertion failed panic: at file: common/riscv_exception.c:85 task: /system/bin/init process: /system/bin/init 0xc000001a
[    6.242000] up_dump_register: EPC: 000000008000ad8a
[    6.242000] up_dump_register: A0: 0000000000000000 A1: 00000000c0202010 A2: 0000000000000001 A3: 00000000c0202010
[    6.242000] up_dump_register: A4: 00000000c0000000 A5: 0000000000000000 A6: 0000000000000000 A7: 0000000000000000
[    6.242000] up_dump_register: T0: 0000000000000000 T1: 0000000000000000 T2: 0000000000000000 T3: 0000000000000000
[    6.242000] up_dump_register: T4: 0000000000000000 T5: 0000000000000000 T6: 0000000000000000
[    6.242000] up_dump_register: S0: 0000000000000000 S1: 0000000000000000 S2: 0000000000000000 S3: 0000000000000000
[    6.242000] up_dump_register: S4: 0000000000000000 S5: 0000000000000000 S6: 0000000000000000 S7: 0000000000000000
[    6.242000] up_dump_register: S8: 0000000000000000 S9: 0000000000000000 S10: 0000000000000000 S11: 0000000000000000
[    6.242000] up_dump_register: SP: 00000000c0202800 FP: 0000000000000000 TP: 0000000000000000 RA: 000000008000ad8a
[    6.242000] dump_stack: User Stack:
[    6.242000] dump_stack:   base: 0xc0202040
[    6.242000] dump_stack:   size: 00003008
[    6.242000] dump_stack:     sp: 0xc0202800
[    6.242000] stack_dump: 0xc02027e0: c0202010 00000000 00000001 00000000 00000000 00000000 8000ad8a 00000000
[    6.242000] stack_dump: 0xc0202800: 00000000 00000000 0007e7f0 00000000 c0200208 00000000 c02001e8 00000000
</code></pre></div>
<p>Let‚Äôs try this single line‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>[    6.242000] stack_dump: 0xc02027e0: c0202010 00000000 00000001 00000000 00000000 00000000 8000ad8a 00000000
</code></pre></div>
<p>Here‚Äôs our parser in PureScript: <a href="src/Main.purs">src/Main.purs</a></p>
<div class="example-wrap"><pre class="language-purescript"><code>-- Parse the NuttX Stack Dump.
-- The next line declares the Function Type. We can actually erase it, VSCode PureScript Extension will helpfully suggest it for us.
printResults :: Effect Unit
printResults = do
  doRunParser &quot;parseStackDump&quot; parseStackDump
    &quot;[    6.242000] stack_dump: 0xc02027e0: c0202010 00000000 00000001 00000000 00000000 00000000 8000ad8a 00000000&quot;

-- Parse a line of NuttX Stack Dump.
-- Result: { addr: &quot;c02027e0&quot;, timestamp: &quot;6.242000&quot;, v1: &quot;c0202010&quot;, v2: &quot;00000000&quot;, v3: &quot;00000001&quot;, v4: &quot;00000000&quot;, v5: &quot;00000000&quot;, v6: &quot;00000000&quot;, v7: &quot;8000ad8a&quot;, v8: &quot;00000000&quot; }
-- The next line declares the Function Type. We can actually erase it, VSCode PureScript Extension will helpfully suggest it for us.
parseStackDump ‚à∑ Parser { addr ‚à∑ String , timestamp ‚à∑ String , v1 ‚à∑ String , v2 ‚à∑ String , v3 ‚à∑ String , v4 ‚à∑ String , v5 ‚à∑ String , v6 ‚à∑ String , v7 ‚à∑ String , v8 ‚à∑ String }
parseStackDump = do

  -- To parse the line: `[    6.242000] stack_dump: 0xc02027e0: c0202010 00000000 00000001 00000000 00000000 00000000 8000ad8a 00000000`
  -- Skip `[    `
  -- `void` means ignore the Text Captured
  -- `$ something something` is shortcut for `( something something )`
  -- `&lt;*` is the Delimiter between Patterns
  void $
    string &quot;[&quot;    -- Match the string `[`
    &lt;* skipSpaces -- Skip the following spaces

  -- `timestamp` becomes `6.242000`
  -- `&lt;*` says when we should stop the Text Capture
  timestamp &lt;-
    regex &quot;[.0-9]+&quot; 
    &lt;* string &quot;]&quot; 
    &lt;* skipSpaces

  -- Skip `stack_dump: `
  -- `void` means ignore the Text Captured
  -- `$ something something` is shortcut for `( something something )`
  -- `&lt;*` is the Delimiter between Patterns
  void $ string &quot;stack_dump:&quot; &lt;* skipSpaces

  -- `addr` becomes `c02027e0`
  void $ string &quot;0x&quot;
  addr &lt;- regex &quot;[0-9a-f]+&quot; &lt;* string &quot;:&quot; &lt;* skipSpaces

  -- `v1` becomes `c0202010`
  -- `v2` becomes `00000000` and so on
  v1 &lt;- regex &quot;[0-9a-f]+&quot; &lt;* skipSpaces
  v2 &lt;- regex &quot;[0-9a-f]+&quot; &lt;* skipSpaces
  v3 &lt;- regex &quot;[0-9a-f]+&quot; &lt;* skipSpaces
  v4 &lt;- regex &quot;[0-9a-f]+&quot; &lt;* skipSpaces
  v5 &lt;- regex &quot;[0-9a-f]+&quot; &lt;* skipSpaces
  v6 &lt;- regex &quot;[0-9a-f]+&quot; &lt;* skipSpaces
  v7 &lt;- regex &quot;[0-9a-f]+&quot; &lt;* skipSpaces
  v8 &lt;- regex &quot;[0-9a-f]+&quot; &lt;* skipSpaces

  -- Return the parsed content
  -- `pure` because we&#39;re in a `do` block that allows Effects
  pure
    { timestamp
    , addr
    , v1
    , v2
    , v3
    , v4
    , v5
    , v6
    , v7
    , v8
    }
</code></pre></div>
<p>Result of parsing‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## We&#39;re parsing: [    6.242000] stack_dump: 0xc02027e0: c0202010 00000000 00000001 00000000 00000000 00000000 8000ad8a 00000000
$ spago run
[info] Build succeeded.
(runParser) Parsing content with &#39;parseStackDump&#39;
Result: {
  addr: &quot;c02027e0&quot;, timestamp: &quot;6.242000&quot;,
  v1: &quot;c0202010&quot;, v2: &quot;00000000&quot;, v3: &quot;00000001&quot;, v4: &quot;00000000&quot;,
  v5: &quot;00000000&quot;, v6: &quot;00000000&quot;, v7: &quot;8000ad8a&quot;, v8: &quot;00000000&quot; }
</code></pre></div>
<p>Not that hard! We could have refactored the code to make it shorter. But we‚Äôll keep it long because it‚Äôs easier to read.</p>
<p>Works OK in JavaScript too: <a href="index.html">index.html</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// Run parseStackDump
const stackDump = `[    6.242000] stack_dump: 0xc02027e0: c0202010 00000000 00000001 00000000 00000000 00000000 8000ad8a 00000000`;
const result = StringParser_Parser
  .runParser
  (parseStackDump)
  (stackDump)
  ;
console.log({result});
</code></pre></div>
<p>Shows‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{
    &quot;result&quot;: {
        &quot;value0&quot;: {
            &quot;timestamp&quot;: &quot;6.242000&quot;,
            &quot;addr&quot;: &quot;c02027e0&quot;,
            &quot;v1&quot;: &quot;c0202010&quot;,
            &quot;v2&quot;: &quot;00000000&quot;,
            &quot;v3&quot;: &quot;00000001&quot;,
            &quot;v4&quot;: &quot;00000000&quot;,
            &quot;v5&quot;: &quot;00000000&quot;,
            &quot;v6&quot;: &quot;00000000&quot;,
            &quot;v7&quot;: &quot;8000ad8a&quot;,
            &quot;v8&quot;: &quot;00000000&quot;
        }
    }
}
</code></pre></div>
<p><em>What if the parsing fails?</em></p>
<p>We‚Äôll see <code>result.error</code>‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{
    &quot;result&quot;: {
        &quot;value0&quot;: {
            &quot;pos&quot;: 0,
            &quot;error&quot;: &quot;Expected &#39;[&#39;.&quot;
        }
    }
}
</code></pre></div>
<p>So we can run <code>parseStackDump</code> on every line of NuttX Log. And skip the lines with <code>result.error</code></p>
<p>TODO: Spot interesting addresses like 8000ad8a, c0202010</p>
<h1 id="parse-nuttx-exception-with-purescript"><a href="#parse-nuttx-exception-with-purescript">5 Parse NuttX Exception with PureScript</a></h1>
<p>TODO</p>
<p>Let‚Äôs parse the <a href="https://gist.github.com/lupyuen/a715e4e77c011d610d0b418e97f8bf5d#file-nuttx-tcc-app-log-L168-L224">NuttX Exception</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>[    6.242000] riscv_exception: EXCEPTION: Instruction page fault. MCAUSE: 000000000000000c, EPC: 000000008000ad8a, MTVAL: 000000008000ad8a
</code></pre></div>
<p>Here‚Äôs how we parse the NuttX Exception in PureScript: <a href="src/Main.purs">src/Main.purs</a></p>
<div class="example-wrap"><pre class="language-purescript"><code>-- Parse the NuttX Exception.
-- Given this NuttX Exception: `riscv_exception: EXCEPTION: Instruction page fault. MCAUSE: 000000000000000c, EPC: 000000008000ad8a, MTVAL: 000000008000ad8a`
-- Result: { epc: &quot;000000008000ad8a&quot;, exception: &quot;Instruction page fault&quot;, mcause: 12, mtval: &quot;000000008000ad8a&quot; }
-- The next line declares the Function Type. We can actually erase it, VSCode PureScript Extension will helpfully suggest it for us.
parseException ‚à∑ Parser { exception ‚à∑ String, mcause :: Int, epc :: String, mtval :: String }
parseException = do

  -- To parse the line: `riscv_exception: EXCEPTION: Instruction page fault. MCAUSE: 000000000000000c, EPC: 000000008000ad8a, MTVAL: 000000008000ad8a`
  -- Skip `riscv_exception: EXCEPTION: `
  -- `void` means ignore the Text Captured
  -- `$ something something` is shortcut for `( something something )`
  -- `&lt;*` is the Delimiter between Patterns
  void $
    string &quot;riscv_exception:&quot; -- Match the string `riscv_exception:`
    &lt;* skipSpaces             -- Skip the following spaces
    &lt;* string &quot;EXCEPTION:&quot;    -- Match the string `EXCEPTION:`
    &lt;* skipSpaces             -- Skip the following spaces

  -- `exception` becomes `Instruction page fault`
  -- `&lt;*` says when we should stop the Text Capture
  exception &lt;- regex &quot;[^.]+&quot; 
    &lt;* string &quot;.&quot; 
    &lt;* skipSpaces 

  -- Skip `MCAUSE: `
  -- `void` means ignore the Text Captured
  -- `$ something something` is shortcut for `( something something )`
  -- `&lt;*` is the Delimiter between Patterns
  void $ string &quot;MCAUSE:&quot; &lt;* skipSpaces

  -- `mcauseStr` becomes `000000000000000c`
  -- We&#39;ll convert to integer later
  mcauseStr &lt;- regex &quot;[0-9a-f]+&quot; &lt;* string &quot;,&quot; &lt;* skipSpaces

  -- Skip `EPC: `
  -- `epc` becomes `000000008000ad8a`
  void $ string &quot;EPC:&quot; &lt;* skipSpaces
  epc &lt;- regex &quot;[0-9a-f]+&quot; &lt;* string &quot;,&quot; &lt;* skipSpaces

  -- Skip `MTVAL: `
  -- `mtval` becomes `000000008000ad8a`
  void $ string &quot;MTVAL:&quot; &lt;* skipSpaces
  mtval &lt;- regex &quot;[0-9a-f]+&quot;

  -- Return the parsed content
  -- `pure` because we&#39;re in a `do` block that allows (Side) Effects
  pure 
    {
      exception
    , mcause: -1 `fromMaybe`               -- If `mcauseStr` is not a valid hex, return -1
        fromStringAs hexadecimal mcauseStr -- Else return the hex value of `mcauseStr`
    , epc
    , mtval
    }
</code></pre></div>
<p>We can run it in Web Browser JavaScript: <a href="index.html">index.html</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Run parseException
  const exception = `riscv_exception: EXCEPTION: Instruction page fault. MCAUSE: 000000000000000c, EPC: 000000008000ad8a, MTVAL: 000000008000ad8a`
  const result1 = StringParser_Parser
    .runParser
    (parseException)
    (exception)
    ;
  console.log({result1});
</code></pre></div>
<p>Which shows‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{
    &quot;result1&quot;: {
        &quot;value0&quot;: {
            &quot;exception&quot;: &quot;Instruction page fault&quot;,
            &quot;mcause&quot;: 12,
            &quot;epc&quot;: &quot;000000008000ad8a&quot;,
            &quot;mtval&quot;: &quot;000000008000ad8a&quot;
        }
    }
}
</code></pre></div><h1 id="explain-nuttx-exception-with-purescript"><a href="#explain-nuttx-exception-with-purescript">6 Explain NuttX Exception with PureScript</a></h1>
<p>TODO</p>
<p>We explain in friendly words what the NuttX Exception means‚Ä¶</p>
<p>‚ÄúNuttX crashed because it tried to read or write an Invalid Address. The Invalid Address is 8000ad8a. The code that caused this is at 8000ad8a. Check the NuttX Disassembly for the Source Code of the crashing line.‚Äù</p>
<p>Here‚Äôs how we explain the NuttX Exception in PureScript: <a href="src/Main.purs">src/Main.purs</a></p>
<div class="example-wrap"><pre class="language-purescript"><code>-- Given this NuttX Exception: `riscv_exception: EXCEPTION: Instruction page fault. MCAUSE: 000000000000000c, EPC: 000000008000ad8a, MTVAL: 000000008000ad8a`
-- Explain in friendly words: &quot;NuttX stopped because it tried to read or write an Invalid Address. The Invalid Address is 8000ad8a. The code that caused this is at 8000ad8a. Check the NuttX Disassembly for the Source Code of the crashing line.&quot;
-- The next line declares the Function Type. We can actually erase it, VSCode PureScript Extension will helpfully suggest it for us.
explainException ‚à∑ Int ‚Üí String ‚Üí String ‚Üí String

-- Explain the NuttX Exception with mcause 12
explainException 12 epc mtval =
  &quot;Instruction Page Fault at &quot; &lt;&gt; epc &lt;&gt; &quot;, &quot; &lt;&gt; mtval

-- Explain the Other NuttX Exceptions, that are not matched with the above
explainException mcause epc mtval =
  &quot;Unknown Exception: mcause=&quot; &lt;&gt; show mcause &lt;&gt; &quot;, epc=&quot; &lt;&gt; epc &lt;&gt; &quot;, mtval=&quot; &lt;&gt; mtval
</code></pre></div>
<p>We can run it in Web Browser JavaScript: <a href="index.html">index.html</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Run explainException
  const result2 = explainException(12)(&#39;000000008000ad8a&#39;)(&#39;000000008000ad8a&#39;)
  console.log({result2});
</code></pre></div>
<p>Which shows‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{
    &quot;result2&quot;: &quot;Instruction Page Fault at 000000008000ad8a, 000000008000ad8a&quot;
}
</code></pre></div><h1 id="rewrite-javascript-generated-by-purescript"><a href="#rewrite-javascript-generated-by-purescript">7 Rewrite JavaScript generated by PureScript</a></h1>
<p>TODO</p>
<p>In the JavaScript generated by PureScript, we point the PureScript Imports to compile.purescript.org, so we don‚Äôt need to deploy the imports: <a href="run.sh">run.sh</a></p>
<div class="example-wrap"><pre class="language-bash"><code>## Change:
##   import { main, doBoth, doRunParser, parseCSV, exampleContent2, parseException, parseStackDump, explainException } from &#39;./output/Main/index.js&#39;;
## To:
##   import { main, doBoth, doRunParser, parseCSV, exampleContent2, parseException, parseStackDump, explainException } from &#39;./index.js&#39;;
## Change:
##   import * as StringParser_Parser from &quot;./output/StringParser.Parser/index.js&quot;;
## To:
##   import * as StringParser_Parser from &quot;https://compile.purescript.org/output/StringParser.Parser/index.js&quot;;
cat index.html \
  | sed &#39;s/output\/Main\///&#39; \
  | sed &#39;s/.\/output\//https:\/\/compile.purescript.org\/output\//&#39; \
  &gt;docs/index.html

## Change:
##   import * as Control_Alt from &quot;../Control.Alt/index.js&quot;;
## To:
##   import * as Control_Alt from &quot;https://compile.purescript.org/output/Control.Alt/index.js&quot;;
cat output/Main/index.js \
  | sed &#39;s/from \&quot;../from \&quot;https:\/\/compile.purescript.org\/output/&#39; \
  &gt;docs/index.js
</code></pre></div>
<p>Try it here: https://lupyuen.github.io/nuttx-purescript-parser/</p>
<h1 id="call-purescript-from-nuttx-emulator"><a href="#call-purescript-from-nuttx-emulator">8 Call PureScript from NuttX Emulator</a></h1>
<p>TODO</p>
<p>After rewriting the JavaScript Imports, we may now call PureScript from NuttX Emulator: <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/purescript/index.html#L31-L98">index.html</a></p>
<div class="example-wrap"><pre class="language-html"><code>&lt;script type=module&gt;
  // Import Main Module
  import { main, doBoth, doRunParser, parseCSV, exampleContent2, parseException, parseStackDump, explainException } from &#39;https://lupyuen.github.io/nuttx-purescript-parser/index.js&#39;;
  import * as StringParser_Parser from &quot;https://compile.purescript.org/output/StringParser.Parser/index.js&quot;;

  // Run parseException
  console.log(&#39;Running parseException...&#39;);
  const exception = `riscv_exception: EXCEPTION: Instruction page fault. MCAUSE: 000000000000000c, EPC: 000000008000ad8a, MTVAL: 000000008000ad8a`
  const result1 = StringParser_Parser
    .runParser
    (parseException)
    (exception)
    ;
  console.log({result1});

  // Run explainException
  const result2 = explainException(12)(&#39;000000008000ad8a&#39;)(&#39;000000008000ad8a&#39;)
  console.log({result2});

  // Run parseStackDump
  console.log(&#39;Running parseStackDump...&#39;);
  const stackDump = `[    6.242000] stack_dump: 0xc02027e0: c0202010 00000000 00000001 00000000 00000000 00000000 8000ad8a 00000000`;
  const result3 = StringParser_Parser
    .runParser
    (parseStackDump)
    (stackDump)
    ;
  console.log({result3});
&lt;/script&gt;
</code></pre></div>
<p>Try it here: https://lupyuen.github.io/nuttx-tinyemu/purescript</p>
<h1 id="parse-nuttx-logs-in-nuttx-emulator"><a href="#parse-nuttx-logs-in-nuttx-emulator">9 Parse NuttX Logs in NuttX Emulator</a></h1>
<p>TODO</p>
<p>This is how we parse every line of Terminal Output from NuttX Emulator: <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/purescript/term.js#L1483-L1527">term.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// When TinyEMU prints to the Terminal Output...
Term.prototype.write = function(str) {
    // Parse the output with PureScript
    parseLog(str);
    ...
}

// Parse NuttX Logs with PureScript.
// Assume `str` is a single character for Terminal Output. We accumulate the characters and parse the line.
// PureScript Parser is inited in `index.html`
function parseLog(str) {

    // Accumulate the characters into a line
    if (!window.StringParser_Parser) { return; }
    termbuf += str;
    if (termbuf.indexOf(&quot;\r&quot;) &lt; 0) { return; }

    // Ignore all Newlines and Carriage Returns
    termbuf = termbuf
        .split(&quot;\r&quot;).join(&quot;&quot;)
        .split(&quot;\n&quot;).join(&quot;&quot;);
    // console.log({termbuf});

    // Parse the Exception
    const exception = StringParser_Parser
        .runParser(parseException)(termbuf)
        .value0;

    // Explain the Exception
    if (exception.error === undefined) {
        console.log({exception});
        const explain = explainException(exception.mcause)(exception.epc)(exception.mtval);
        console.log({explain});
    }

    // Run parseStackDump
    const stackDump = StringParser_Parser
        .runParser(parseStackDump)(termbuf)
        .value0;
    if (stackDump.error === undefined) { console.log({stackDump}); }

    // Reset the Line Buffer
    termbuf = &quot;&quot;;
}

// Buffer the last line of the Terminal Output
let termbuf = &quot;&quot;;
</code></pre></div>
<p>And it works correctly yay!</p>
<div class="example-wrap"><pre class="language-text"><code>&quot;exception&quot;: {
    &quot;exception&quot;: &quot;Load page fault&quot;,
    &quot;mcause&quot;: 13,
    &quot;epc&quot;: &quot;000000008000a0e4&quot;,
    &quot;mtval&quot;: &quot;0000000880203b88&quot;
}
&quot;explain&quot;: &quot;Load Page Fault at 000000008000a0e4, 0000000880203b88&quot;
</code></pre></div>
<p>Try it here: https://lupyuen.github.io/nuttx-tinyemu/purescript</p>
<p><a href="https://youtu.be/9oBhy3P7pYc">(Watch the Demo on YouTube)</a></p>
<p><img src="https://lupyuen.github.io/images/purescript-title.png" alt="Parsing Apache NuttX RTOS Logs with PureScript" /></p>
<h1 id="show-nuttx-disassembly-by-address"><a href="#show-nuttx-disassembly-by-address">10 Show NuttX Disassembly by Address</a></h1>
<p>TODO</p>
<p><em>Given an Exception Address like 8000ad8a, can we show the NuttX Disassembly?</em></p>
<p>We need to chunk nuttx.S (or qjs.S) by address: nuttx-8000ad90.S, nuttx-8000ae00.S, nuttx-8000b000.S, nuttx-80010000.S. And link to the NuttX Repo Source Code.</p>
<p>Let‚Äôs chunk <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/purescript/qjs.S">qjs.S</a>, the NuttX App Disassembly for QuickJS JavaScript Engine‚Ä¶</p>
<ul>
<li>
<p>Code Addresses are at 0x8000_0000 to 0x8006_4a28</p>
</li>
<li>
<p>Spanning 277K lines of code!</p>
</li>
</ul>
<p>We created a <a href="https://github.com/lupyuen/nuttx-disassembly-chunker/blob/main/src/main.rs">NuttX Disassembly Chunker</a> that will‚Ä¶</p>
<ul>
<li>
<p>Split a huge NuttX Disassembly: <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/purescript/qjs.S">qjs.S</a></p>
</li>
<li>
<p>Into smaller Disassembly Chunk Files: <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/purescript/qjs-chunk/qjs-80001000.S">qjs-chunk/qjs-80001000.S</a></p>
</li>
<li>
<p>So that Disassembly Address 0x8000_0000 will be located in <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/purescript/qjs-chunk/qjs-80001000.S">qjs-80001000.S</a></p>
</li>
<li>
<p>And Disassembly Address 0x8000_1000 will be located in <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/purescript/qjs-chunk/qjs-80002000.S">qjs-80002000.S</a>, ‚Ä¶</p>
</li>
</ul>
<p>This is how we chunk a NuttX Disassembly from <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/purescript/qjs.S">qjs.S</a> to <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/purescript/qjs-chunk">qjs-chunk</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Chunk NuttX Disassembly $HOME/qjs.S into
## $HOME/qjs-chunk/qjs-80001000.S
## $HOME/qjs-chunk/qjs-80002000.S
## ...

chunkpath=$HOME
chunkbase=qjs
mkdir -p $chunkpath/$chunkbase-chunk
rm -f $chunkpath/$chunkbase-chunk/*
cargo run -- $chunkpath $chunkbase
</code></pre></div>
<p>And this is how we display the Disassembly Chunk by Address: <a href="https://github.com/lupyuen/nuttx-tinyemu/blob/main/docs/purescript/disassemble.js">disassemble.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// Show the NuttX Disassembly for the Requested Address
// http://localhost:8000/nuttx-tinyemu/docs/purescript/disassemble.html?addr=80007028

// Show 20 lines before and after the Requested Address
const before_count = 20;
const after_count  = 20;

// Convert `nuttx/arch/risc-v/src/common/crt0.c:166`
// To `&lt;a href=&quot;https://github.com/apache/nuttx/blob/master/arch/risc-v/src/common/crt0.c#L166&quot;&gt;...`
// Convert `quickjs-nuttx/quickjs-libc.c:1954`
// To `&lt;a href=&quot;https://github.com/lupyuen/quickjs-nuttx/blob/master/quickjs-libc.c#L1954&quot;&gt;...`
const search1  = &quot;nuttx/&quot;;
const replace1 = &quot;https://github.com/apache/nuttx/blob/master/&quot;;
const search2  = &quot;quickjs-nuttx/&quot;;
const replace2 = &quot;https://github.com/lupyuen/quickjs-nuttx/blob/master/&quot;;

// Convert the Source File to Source URL
function processLine(line) {
  line = line.split(&quot;\t&quot;).join(&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;);
  if (line.indexOf(&quot;:&quot;) &lt; 0) { return line; }
  let url = line.split(&quot;:&quot;, 2).join(&quot;#L&quot;);

  // Search and replace Source File to Source URL
  if (line.indexOf(search1) == 0) {
    url = url.split(search1, 2).join(replace1);
  } else if (line.indexOf(search2) == 0) {
    url = url.split(search2, 2).join(replace2);
  } else {
    return line;
  }
  return `&lt;a href=&quot;${url}&quot; target=&quot;_blank&quot;&gt;${line}&lt;/a&gt;`;
}

// Fetch our Disassembly File, line by line
// https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch#processing_a_text_file_line_by_line
async function* makeTextFileLineIterator(fileURL) {
  const utf8Decoder = new TextDecoder(&quot;utf-8&quot;);
  const response = await fetch(fileURL);
  const reader = response.body.getReader();
  let { value: chunk, done: readerDone } = await reader.read();
  chunk = chunk ? utf8Decoder.decode(chunk) : &quot;&quot;;

  const newline = /\r?\n/gm;
  let startIndex = 0;
  let result;

  while (true) {
    const result = newline.exec(chunk);
    if (!result) {
      if (readerDone) break;
      const remainder = chunk.substr(startIndex);
      ({ value: chunk, done: readerDone } = await reader.read());
      chunk = remainder + (chunk ? utf8Decoder.decode(chunk) : &quot;&quot;);
      startIndex = newline.lastIndex = 0;
      continue;
    }
    yield chunk.substring(startIndex, result.index);
    startIndex = newline.lastIndex;
  }

  if (startIndex &lt; chunk.length) {
    // Last line didn&#39;t end in a newline char
    yield chunk.substr(startIndex);
  }
}

// Fetch and display our Disassembly File, line by line
async function run() {

  // Set the Title. `addr` is `80007028`
  const addr = new URL(document.URL).searchParams.get(&quot;addr&quot;);
  const title = document.getElementById(&quot;title&quot;);
  title.innerHTML += 
    addr.substring(0, 4).toUpperCase()
    + &quot;_&quot;
    + addr.substring(4).toUpperCase();

  // URL of our Disassembly File, chunked for easier display.
  // TODO: Given an Exception Address like 8000ad8a. we should try multiple files by address:
  // qjs-8000ad90.S, qjs-8000ae00.S, qjs-8000b000.S, qjs-80010000.S
  const url = &quot;qjs-chunk/qjs-80008000.S&quot;;

  // Remember the lines before and after the Requested Address
  const before_lines = [];
  const after_lines = [];
  let linenum = 0;

  // Process our Disassembly File, line by line
  const iter = makeTextFileLineIterator(url);
  for await (const line1 of iter) {
    if (after_lines.length == 0) { linenum++; }

    // Look for the Requested Address
    if (line1.indexOf(`    ${addr}:`) == 0) {
      const line2 = processLine(line1);
      after_lines.push(line2);
      continue;
    }

    // Save the lines before the Requested Address
    const line2 = processLine(line1);
    if (after_lines.length == 0) {
      before_lines.push(line2);
      if (before_lines.length &gt; before_count) { before_lines.shift(); }  
    } else {
      // Save the lines after the Requested Address
      after_lines.push(line2);
      if (after_lines.length &gt; after_count) { break; }
    }
  }

  // Requested Line is `after_lines[0]`.
  // Show the Before and After Lines.
  const line = after_lines[0];
  after_lines.shift();
  console.log({before_lines});
  console.log({line});
  console.log({after_lines});

  const disassembly = document.getElementById(&quot;disassembly&quot;);
  const file = `https://github.com/lupyuen/nuttx-tinyemu/tree/main/docs/purescript/${url}#L${linenum}`;
  disassembly.innerHTML = [
    `&lt;p&gt;&lt;a href=${file}&gt;(See the Disassembly File)&lt;/a&gt;&lt;/p&gt;`,
    before_lines.join(&quot;&lt;br&gt;&quot;),
    `&lt;span id=&quot;highlight&quot;&gt;&lt;br&gt;${line}&lt;br&gt;&lt;/span&gt;`,
    after_lines.join(&quot;&lt;br&gt;&quot;),
    `&lt;p&gt;&lt;a href=${file}&gt;(See the Disassembly File)&lt;/a&gt;&lt;/p&gt;`,
  ].join(&quot;&lt;br&gt;&quot;);
}

run();
</code></pre></div>
<p>Try it here: https://lupyuen.github.io/nuttx-tinyemu/purescript/disassemble.html?addr=8000702a</p>
<p><img src="https://lupyuen.github.io/images/purescript-disassembly.png" alt="NuttX Disassembly" /></p>
<h1 id="identify-a-nuttx-address"><a href="#identify-a-nuttx-address">11 Identify a NuttX Address</a></h1>
<p>TODO</p>
<p><em>Given a NuttX Address like 80007028: How will we know whether it‚Äôs in NuttX Kernel or NuttX Apps? And whether it‚Äôs Code, Data, BSS or Heap?</em></p>
<p>This is how we identify a NuttX Address in PureScript: <a href="src/Main.purs">src/Main.purs</a></p>
<div class="example-wrap"><pre class="language-purescript"><code>-- Given an Address, identify the Origin (NuttX Kernel or App) and Type (Code / Data / BSS / Heap)
identifyAddress ‚à∑ String ‚Üí Maybe { origin ‚à∑ String , type ‚à∑ AddressType }

-- Address 502xxxxx comes from NuttX Kernel Code
-- Address 800xxxxx comes from NuttX App Code (QuickJS)
-- `|` works like `if ... else if`
-- &quot;a `matches` b&quot; is same as &quot;(matches a b)&quot;
-- `Just` returns an OK Value. `Nothing` returns No Value.
identifyAddress addr
  | &quot;502.....&quot; `matches` addr = Just { origin: &quot;nuttx&quot;, type: Code }
  | &quot;800.....&quot; `matches` addr = Just { origin: &quot;qjs&quot;,   type: Code }
  | otherwise = Nothing

-- Address can point to Code, Data, BSS or Heap
data AddressType = Code | Data | BSS | Heap

-- How to display an Address Type
instance Show AddressType where
  show Code = &quot;Code&quot;
  show Data = &quot;Data&quot;
  show BSS  = &quot;BSS&quot;
  show Heap = &quot;Heap&quot;

-- Return True if the Address matches the Regex Pattern.
-- Pattern is assumed to match the Entire Address.
matches ‚à∑ String ‚Üí String ‚Üí Boolean

-- Match the Begin `^` and End `$` of the Address
-- `&lt;&gt;` will concat 2 strings
-- &quot;a `unsafeRegex` b&quot; is same as &quot;(unsafeRegex a b)&quot;
matches pattern addr = 
  let 
    patternWrap = &quot;^&quot; &lt;&gt; pattern &lt;&gt; &quot;$&quot;
  in
    isJust $                            -- Is there a Match...
      patternWrap `unsafeRegex` noFlags -- For our Regex Pattern (no special flags)
        `match` addr                    -- Against the Address?

-- Test our code. Parse the NuttX Exception and NuttX Stack Dump. Explain the NuttX Exception.
-- `Effect` says that it will do Side Effects (printing to console)
-- `Unit` means that no value will be returned
-- The next line declares the Function Type. We can actually erase it, VSCode PureScript Extension will helpfully suggest it for us.
printResults :: Effect Unit
printResults = do

  -- NuttX Kernel: 0x5020_0000 to 0x5021_98ac
  -- NuttX App (qjs): 0x8000_0000 to 0x8006_4a28
  logShow $ identifyAddress &quot;502198ac&quot; -- (Just { origin: &quot;nuttx&quot;, type: Code })
  logShow $ identifyAddress &quot;8000a0e4&quot; -- (Just { origin: &quot;qjs&quot;, type: Code })
  logShow $ identifyAddress &quot;0000000800203b88&quot; -- Nothing
</code></pre></div>
<p><em>Tsk tsk so much Hard Coding‚Ä¶</em></p>
<p>Our Rules are still evolving, we‚Äôre not sure how the NuttX Log Parser will be used in future.</p>
<p>That‚Äôs why we need a PureScript Editor that will allow the Rules to be tweaked easily for other platforms‚Ä¶</p>
<h1 id="purescript-editor-for-nuttx"><a href="#purescript-editor-for-nuttx">12 PureScript Editor for NuttX</a></h1>
<p>TODO</p>
<p><em>How to build a PureScript Editor that will allow the Rules to be tweaked easily for other platforms?</em></p>
<p>To run our PureScript Editor for NuttX‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>git clone https://github.com/lupyuen/nuttx-trypurescript
cd nuttx-trypurescript
cd client

## Build and Test Locally:
npm install
## Produces `output` folder
## And `public/js/index.js`
npm run serve:production
## Test at http://127.0.0.1:8080

## Deploy to GitHub Pages:
rm -r ../docs
cp -r public ../docs
simple-http-server .. &amp;
## Test at http://0.0.0.0:8000/docs/index.html

## If we need `client.js` bundle:
## npm run build:production
</code></pre></div>
<p>Try it here: https://lupyuen.github.io/nuttx-trypurescript</p>
<p>Copy <a href="src/Main.purs">src/Main.purs</a> to the PureScript Editor.</p>
<div class="example-wrap"><pre class="language-purescript"><code>main :: Effect Unit
main = printResults
</code></pre></div>
<p>To this‚Ä¶</p>
<div class="example-wrap"><pre class="language-purescript"><code>import TryPureScript (render, withConsole)

main :: Effect Unit
main = render =&lt;&lt; withConsole do
  printResults
</code></pre></div>
<p>Our NuttX Parser Output appears‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Instruction Page Fault at epc, mtval
Unknown Exception: mcause=0, epc=epc, mtval=mtval
(runParser) Parsing content with &#39;parseException&#39;
Result: { epc: &quot;000000008000ad8a&quot;, exception: &quot;Instruction page fault&quot;, mcause: 12, mtval: &quot;000000008000ad8a&quot; }
-----
(runParser) Parsing content with &#39;parseStackDump&#39;
Result: { addr: &quot;c02027e0&quot;, timestamp: &quot;6.242000&quot;, v1: &quot;c0202010&quot;, v2: &quot;00000000&quot;, v3: &quot;00000001&quot;, v4: &quot;00000000&quot;, v5: &quot;00000000&quot;, v6: &quot;00000000&quot;, v7: &quot;8000ad8a&quot;, v8: &quot;00000000&quot; }
-----
</code></pre></div>
<p>The Generated Web Browser JavaScript looks like this‚Ä¶</p>
<div class="example-wrap"><pre class="language-html"><code>&lt;script type=&quot;module&quot;&gt;
import * as Control_Alt from &quot;https://compile.purescript.org/output/Control.Alt/index.js&quot;;
import * as Control_Applicative from &quot;https://compile.purescript.org/output/Control.Applicative/index.js&quot;;
import * as Control_Apply from &quot;https://compile.purescript.org/output/Control.Apply/index.js&quot;;
...
var bind = /* #__PURE__ */ Control_Bind.bind(StringParser_Parser.bindParser);
var alt = /* #__PURE__ */ Control_Alt.alt(StringParser_Parser.altParser);
var voidRight = /* #__PURE__ */ Data_Functor.voidRight(StringParser_Parser.functorParser);
...
</code></pre></div>
<p>TODO: Where is Main Function?</p>
<p>TODO: Copy Generated JavaScript to NuttX Emulator</p>
<h1 id="bigint-in-purescript"><a href="#bigint-in-purescript">13 BigInt in PureScript</a></h1>
<p>TODO</p>
<p><em>Why are we passing addresses in Text instead of Numbers? Like <code>8000ad8a</code></em></p>
<p>That‚Äôs because 0x8000ad8a is too big for PureScript Int, a signed 32-bit integer. PureScript Int is meant to interoperate with JavaScript Integer, which is also 32-bit.</p>
<p><em>What about PureScript BigInt?</em></p>
<div class="example-wrap"><pre class="language-bash"><code>spago install bigints
npm install big-integer
</code></pre></div>
<p>If we use <a href="https://pursuit.purescript.org/packages/purescript-bigints/7.0.1/docs/Data.BigInt#t:BigInt">PureScript BigInt</a>, then we need NPM big-integer.</p>
<p>But NPM big-integer won‚Äôt run inside a Web Browser with Plain Old JavaScript. That‚Äôs why we‚Äôre passing addresses as Strings instead of Numbers.</p>
<h1 id="run-parsecsv-in-nodejs"><a href="#run-parsecsv-in-nodejs">14 Run parseCSV in Node.js</a></h1>
<p>TODO</p>
<p>Let‚Äôs run <a href="https://github.com/purescript-contrib/purescript-string-parsers/blob/main/test/Examples.purs">parseCSV</a> in Node.js. Normally we run PureScript like this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>spago run
</code></pre></div>
<p>This is how we run it in Node.js‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>$ spago build
$ node .spago/run.js

### Example Content 1 ###
(runParser) Parsing content with &#39;fail&#39;
{ error: &quot;example failure message&quot;, pos: 0 }
-----
(unParser) Parsing content with &#39;fail&#39;
Position: 0
Error: &quot;example failure message&quot;
-----
(runParser) Parsing content with &#39;numberOfAs&#39;
Result was: 6
-----
(unParser) Parsing content with &#39;numberOfAs&#39;
Result was: 6
Suffix was: { position: 59, substring: &quot;&quot; }
-----
(runParser) Parsing content with &#39;removePunctuation&#39;
Result was: &quot;How many as are in this sentence you ask Not that many&quot;
-----
(unParser) Parsing content with &#39;removePunctuation&#39;
Result was: &quot;How many as are in this sentence you ask Not that many&quot;
Suffix was: { position: 59, substring: &quot;&quot; }
-----
(runParser) Parsing content with &#39;replaceVowelsWithUnderscore&#39;
Result was: &quot;H_w m_ny &#39;_&#39;s _r_ _n th_s s_nt_nc_, y__ _sk? N_t th_t m_ny.&quot;
-----
(unParser) Parsing content with &#39;replaceVowelsWithUnderscore&#39;
Result was: &quot;H_w m_ny &#39;_&#39;s _r_ _n th_s s_nt_nc_, y__ _sk? N_t th_t m_ny.&quot;
Suffix was: { position: 59, substring: &quot;&quot; }
-----
(runParser) Parsing content with &#39;tokenizeContentBySpaceChars&#39;
Result was: (NonEmptyList (NonEmpty &quot;How&quot; (&quot;many&quot; : &quot;&#39;a&#39;s&quot; : &quot;are&quot; : &quot;in&quot; : &quot;this&quot; : &quot;sentence,&quot; : &quot;you&quot; : &quot;ask?&quot; : &quot;Not&quot; : &quot;that&quot; : &quot;many.&quot; : Nil)))
-----
(unParser) Parsing content with &#39;tokenizeContentBySpaceChars&#39;
Result was: (NonEmptyList (NonEmpty &quot;How&quot; (&quot;many&quot; : &quot;&#39;a&#39;s&quot; : &quot;are&quot; : &quot;in&quot; : &quot;this&quot; : &quot;sentence,&quot; : &quot;you&quot; : &quot;ask?&quot; : &quot;Not&quot; : &quot;that&quot; : &quot;many.&quot; : Nil)))
Suffix was: { position: 59, substring: &quot;&quot; }
-----
(runParser) Parsing content with &#39;extractWords&#39;
Result was: (NonEmptyList (NonEmpty &quot;How&quot; (&quot;many&quot; : &quot;a&quot; : &quot;s&quot; : &quot;are&quot; : &quot;in&quot; : &quot;this&quot; : &quot;sentence&quot; : &quot;you&quot; : &quot;ask&quot; : &quot;Not&quot; : &quot;that&quot; : &quot;many&quot; : Nil)))
-----
(unParser) Parsing content with &#39;extractWords&#39;
Result was: (NonEmptyList (NonEmpty &quot;How&quot; (&quot;many&quot; : &quot;a&quot; : &quot;s&quot; : &quot;are&quot; : &quot;in&quot; : &quot;this&quot; : &quot;sentence&quot; : &quot;you&quot; : &quot;ask&quot; : &quot;Not&quot; : &quot;that&quot; : &quot;many&quot; : Nil)))
Suffix was: { position: 59, substring: &quot;&quot; }
-----
(runParser) Parsing content with &#39;badExtractWords&#39;
{ error: &quot;Could not find a character that separated the content...&quot;, pos: 43 }
-----
(unParser) Parsing content with &#39;badExtractWords&#39;
Position: 43
Error: &quot;Could not find a character that separated the content...&quot;
-----
(runParser) Parsing content with &#39;quotedLetterExists&#39;
Result was: true
-----
(unParser) Parsing content with &#39;quotedLetterExists&#39;
Result was: true
Suffix was: { position: 59, substring: &quot;&quot; }
-----

### Example Content 2 ###
(runParser) Parsing content with &#39;parseCSV&#39;
Result was: { age: &quot;24&quot;, firstName: &quot;Mark&quot;, idNumber: &quot;523&quot;, lastName: &quot;Kenderson&quot;, modifiedEmail: &quot;mynameismark@mark.mark.com&quot;, originalEmail: &quot;my.name.is.mark@mark.mark.com&quot; }
-----
(unParser) Parsing content with &#39;parseCSV&#39;
Result was: { age: &quot;24&quot;, firstName: &quot;Mark&quot;, idNumber: &quot;523&quot;, lastName: &quot;Kenderson&quot;, modifiedEmail: &quot;mynameismark@mark.mark.com&quot;, originalEmail: &quot;my.name.is.mark@mark.mark.com&quot; }
Suffix was: { position: 110, substring: &quot;&quot; }
-----
</code></pre></div><h1 id="run-parsecsv-in-web-browser"><a href="#run-parsecsv-in-web-browser">15 Run parseCSV in Web Browser</a></h1>
<p>TODO</p>
<p>Here‚Äôs how we run <a href="https://github.com/purescript-contrib/purescript-string-parsers/blob/main/test/Examples.purs">parseCSV</a> in the Web Browser: <a href="index.html">index.html</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Import Main Module
  import { main, doBoth, doRunParser, parseCSV, exampleContent2 } from &#39;./output/Main/index.js&#39;;
  import * as StringParser_Parser from &quot;./output/StringParser.Parser/index.js&quot;;

  // Run parseCSV
  const result = StringParser_Parser
    .runParser
    (parseCSV)
    (exampleContent2)
    ;
  console.log({result});
</code></pre></div>
<p>Output:</p>
<div class="example-wrap"><pre class="language-json"><code>{
    &quot;result&quot;: {
        &quot;value0&quot;: {
            &quot;idNumber&quot;: &quot;523&quot;,
            &quot;firstName&quot;: &quot;Mark&quot;,
            &quot;lastName&quot;: &quot;Kenderson&quot;,
            &quot;age&quot;: &quot;24&quot;,
            &quot;originalEmail&quot;: &quot;my.name.is.mark@mark.mark.com&quot;,
            &quot;modifiedEmail&quot;: &quot;mynameismark@mark.mark.com&quot;
        }
    }
}
</code></pre></div>
<p>We expose the PureScript Functions in the Web Browser: <a href="index.html">index.html</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>// Import Main Module
import { main, doBoth, doRunParser, parseCSV, exampleContent2 } from &#39;./output/Main/index.js&#39;;
import * as StringParser_Parser from &quot;./output/StringParser.Parser/index.js&quot;;

// For Testing: Export the PureScript Functions
window.main = main;
window.doBoth = doBoth;
window.doRunParser = doRunParser;
window.parseCSV = parseCSV;
window.exampleContent2 = exampleContent2;
window.StringParser_Parser = StringParser_Parser;
</code></pre></div>
<p>So we can run experiments in the JavaScript Console‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>// Run parseCSV in JavaScript Console
window.StringParser_Parser
  .runParser
  (window.parseCSV)
  (window.exampleContent2)
</code></pre></div><h1 id="run-parsecsv-in-trypurescriptorg"><a href="#run-parsecsv-in-trypurescriptorg">16 Run parseCSV in try.purescript.org</a></h1>
<p>TODO</p>
<p>To run <a href="https://github.com/purescript-contrib/purescript-string-parsers/blob/main/test/Examples.purs">parseCSV</a> at <a href="https://try.purescript.org/">try.purescript.org</a>, change‚Ä¶</p>
<div class="example-wrap"><pre class="language-purescript"><code>main :: Effect Unit
main = printResults
</code></pre></div>
<p>To this‚Ä¶</p>
<div class="example-wrap"><pre class="language-purescript"><code>import TryPureScript (render, withConsole)

main :: Effect Unit
main = render =&lt;&lt; withConsole do
  printResults
</code></pre></div><h1 id="compile-purescript-to-javascript-in-web-browser"><a href="#compile-purescript-to-javascript-in-web-browser">17 Compile PureScript to JavaScript in Web Browser</a></h1>
<p>TODO</p>
<p>Here‚Äôs how we compile PureScript to JavaScript inside our Web Browser‚Ä¶</p>
<p>https://github.com/lupyuen/nuttx-tinyemu/blob/fc22c9fba2d6fbc4faf8c1fb02f4761952cb66cd/docs/blockly/jslinux.js#L755-L804</p>
<div class="example-wrap"><pre class="language-javascript"><code>// Compile PureScript to JavaScript
// Maybe we&#39;ll run a PureScript to analyse the Real-Time Logs from a NuttX Device?
// https://lupyuen.github.io/nuttx-tinyemu/blockly/
async function compile_purescript() {

    // Public Server API that compiles PureScript to JavaScript
    // https://github.com/purescript/trypurescript#server-api
    const url = &quot;https://compile.purescript.org/compile&quot;;
    const contentType = &quot;text/plain;charset=UTF-8&quot;;

    // PureScript to be compiled to JavaScript
    const body =
`
module Main where

import Prelude

import Effect (Effect)
import Effect.Console (log)
import Data.Array ((..))
import Data.Foldable (for_)
import TryPureScript (render, withConsole)

main :: Effect Unit
main = render =&lt;&lt; withConsole do
  for_ (10 .. 1) \\n -&gt; log (show n &lt;&gt; &quot;...&quot;)
  log &quot;Lift off!&quot;
`;

    // Call Public Server API to compile our PureScript to JavaScript
    // Default options are marked with *
    // https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
    const response = await fetch(url, {
        method: &quot;POST&quot;, // *GET, POST, PUT, DELETE, etc.
        mode: &quot;cors&quot;, // no-cors, *cors, same-origin
        cache: &quot;no-cache&quot;, // *default, no-cache, reload, force-cache, only-if-cached
        credentials: &quot;same-origin&quot;, // include, *same-origin, omit
        headers: { &quot;Content-Type&quot;: contentType },
        redirect: &quot;follow&quot;, // manual, *follow, error
        referrerPolicy: &quot;no-referrer&quot;, // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
        body: body,
    });

    // Print the response
    // { &quot;js&quot;: &quot;import * as Control_Bind from \&quot;../Control.Bind/index.js\&quot;;\nimport * as Data_Array from \&quot;../Data.Array/index.js\&quot;;\nimport * as Data_Foldable from \&quot;../Data.Foldable/index.js\&quot;;\nimport * as Data_Show from \&quot;../Data.Show/index.js\&quot;;\nimport * as Effect from \&quot;../Effect/index.js\&quot;;\nimport * as Effect_Console from \&quot;../Effect.Console/index.js\&quot;;\nimport * as TryPureScript from \&quot;../TryPureScript/index.js\&quot;;\nvar show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);\nvar main = /* #__PURE__ */ Control_Bind.bindFlipped(Effect.bindEffect)(TryPureScript.render)(/* #__PURE__ */ TryPureScript.withConsole(function __do() {\n    Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableArray)(Data_Array.range(10)(1))(function (n) {\n        return Effect_Console.log(show(n) + \&quot;...\&quot;);\n    })();\n    return Effect_Console.log(\&quot;Lift off!\&quot;)();\n}));\nexport {\n    main\n};&quot;,
    //   &quot;warnings&quot;: [] }
    console.log(await response.json());
}
</code></pre></div>
<p>The JSON Response looks like this‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>{
  &quot;js&quot;: &quot;
    import * as Control_Bind from &quot;../Control.Bind/index.js&quot;;
    import * as Data_Array from &quot;../Data.Array/index.js&quot;;
    import * as Data_Foldable from &quot;../Data.Foldable/index.js&quot;;
    import * as Data_Show from &quot;../Data.Show/index.js&quot;;
    import * as Effect from &quot;../Effect/index.js&quot;;
    import * as Effect_Console from &quot;../Effect.Console/index.js&quot;;
    import * as TryPureScript from &quot;../TryPureScript/index.js&quot;;
    var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
    var main = /* #__PURE__ */ Control_Bind.bindFlipped(Effect.bindEffect)(TryPureScript.render)(/* #__PURE__ */ TryPureScript.withConsole(function __do() {
          Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableArray)(Data_Array.range(10)(1))(function (n) {
              return Effect_Console.log(show(n) + &quot;...&quot;);
        })();
        return Effect_Console.log(&quot;Lift off!&quot;)();
    }));
    export {
          main
    };
  &quot;,
  &quot;warnings&quot;: []
}
</code></pre></div><h1 id="whats-next"><a href="#whats-next">18 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Hello Marvin the Martian?</p>
<p>Yum curry‚Ä¶</p>
<p>Easier to understand </p>
<div class="example-wrap"><pre class="language-bash"><code>git clone TODO
cd TODO
code .
## Open src/main TODO
</code></pre></div>
<p>Install vscode extension </p>
<p>It‚Äôs 2024‚Ä¶ Surely there‚Äôs a better way to grok the log?
Stack trace / mm log / elf loader </p>
<p>Concat ‚Äúüéµ I never promised you a rose garden‚Äù</p>
<p>TODO</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> (and the awesome NuttX Community) for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-ox64"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-star64"><strong>My Other Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>Older Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/purescript.md"><strong>lupyuen.github.io/src/purescript.md</strong></a></p>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>