<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="/_static/css/banner-styles.css?v=bsmaklHF" />
  <link rel="stylesheet" type="text/css" href="/_static/css/iconochive.css?v=qtvMKcIJ" />
  <link rel="canonical" href="https://lupyuen.org/articles/stm32-blue-pill-dissecting-the-webusb-bootloader-for-makecode.html" />
  <!-- End Wayback Rewrite JS Include -->
  <title data-rh="true">STM32 Blue Pill — Dissecting the WebUSB Bootloader for MakeCode</title>
  <meta data-rh="true" charset="utf-8" />
  <meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
  <meta data-rh="true" name="theme-color" content="#000000" />
  <meta data-rh="true" property="og:type" content="article" />
  <meta data-rh="true" property="article:published_time" content="2019-02-15T17:01:46.544Z" />
  <meta data-rh="true" name="title" content="STM32 Blue Pill — Dissecting the WebUSB Bootloader for MakeCode" />
  <meta data-rh="true" property="og:title" content="STM32 Blue Pill — Dissecting the WebUSB Bootloader for MakeCode" />
  <meta data-rh="true" property="twitter:title"
    content="STM32 Blue Pill — Dissecting the WebUSB Bootloader for MakeCode" />
  <meta data-rh="true" name="description"
    content="How the MakeCode Bootloader for Blue Pill implements flashing over WebUSB" />
  <meta data-rh="true" property="og:description"
    content="How  the MakeCode Bootloader for Blue Pill implements flashing over WebUSB" />
  <meta data-rh="true" property="twitter:description"
    content="How  the MakeCode Bootloader for Blue Pill implements flashing over WebUSB" />
  <meta data-rh="true" name="twitter:card" content="summary_large_image" />
  <meta data-rh="true" name="twitter:creator" content="@MisterTechBlog" />
  <meta data-rh="true" name="author" content="Lup Yuen Lee 李立源" />
  <meta data-rh="true" name="robots" content="index,follow" />
  <meta data-rh="true" name="referrer" content="unsafe-url" />
  <meta data-rh="true" name="twitter:label1" value="Reading time" />
  <meta data-rh="true" name="twitter:data1" value="13 min read" />
  <meta property="og:image" 
  content="https://lupyuen.github.io/images/legacy2/k1.png">

<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">

<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->

</head>

<body>
  <div id="root">
    <div class="a b c">
      <article class="meteredContent">
        <section class="cy cz da db ak dc ct n dd"></section><span class="r"></span>
        <div>
          <div class="de u df dg dh di"></div>
          <section class="dj dk dl dm dn">
            <div class="do ak">
              <div class="figure dp do ak paragraph-image">
                
                
                <p><img src="https://lupyuen.github.io/images/legacy2/k1.png" /></p>



              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <div>
                  <div id="8c8f" class="eh ei ar bz ej b ek el em en eo ep eq">
                    <h1 class="ej b ek er ar">STM32 Blue Pill — Dissecting the WebUSB Bootloader for MakeCode</h1>
                  </div>
                  <div class="es">
                    <div class="n et eu ev ew">
                      <div class="o n">
                        <div><a rel="noopener"
                            href="https://lupyuen.github.io">
                            <div class="ds ex ey">
                              <div class="ch n ez o p de fa fb fc fd fe di"></div>
                              
                            </div>
                          </a></div>
                        <div class="fg ak r">
                          <div class="n">
                            <div style="flex:1"><span class="by b bz ca cb cc r ar q">
                                <div class="fh n o fi"><span class="by fj fk ca ax fl fm au av aw ar"><a
                                      class="bi bj bk bl bm bn bo bp bq br fn bu bv bw bx" rel="noopener"
                                      href="https://lupyuen.github.io">Lup
                                      Yuen Lee 李立源</a></span>
                               
                                </div>
                              </span></div>
                          </div><span class="by b bz ca cb cc r cd ce"><span class="by fj fk ca ax fl fm au av aw cd">
                              <div><a class="bi bj bk bl bm bn bo bp bq br fn bu bv bw bx" rel="noopener"
                                  href="https://lupyuen.github.io/articles/stm32-blue-pill-dissecting-the-webusb-bootloader-for-makecode">
                                  15 Feb 2019</a> <!-- -->·
                                <!-- -->
                                <!-- -->13
                                <!-- --> min read<span style="padding-left:4px"></span>
                              </div>
                            </span></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <p id="d978" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">Could <a
                    href="http://wiki.stm32duino.com/index.php?title=Blue_Pill"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">STM32 Blue Pill</a> overtake
                  Arduino as the <strong class="go he">preferred platform for creating IoT prototypes?</strong></p>
                <p id="f241" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">1️⃣ Blue Pill is <strong
                    class="go he">packed with features</strong>, yet costs <strong class="go he">under US$ 2</strong>
                </p>
                <p id="5d99" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">2️⃣ <strong class="go he">Cheaper
                    Blue Pill clones</strong> are now emerging. No signs of Blue Pill fatigue.</p>
                <p id="76af" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">3️⃣ Microcontrollers are joining
                  <strong class="go he">mesh networks</strong> to become smarter collectives. Cheap microcontrollers
                  like Blue Pill are needed.</p>
                <p id="9df0" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">4️⃣ The closest competitor,
                  <strong class="go he">ESP8266 / ESP32</strong>, is still slowly growing its software base from scratch
                  (though the embedded WiFi is a huge advantage)</p>
                <p id="f4a0" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">5️⃣ Blue Pill developers have
                  <strong class="go he">plenty of open-source Arm and STM32 code</strong> to guide them</p>
                <p id="c014" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">So what’s holding back Blue Pill?
                  <em class="hf">Blue Pill is way more advanced than the ancient Arduino Uno, yet we are still using the
                    same primitive coding tools… </em><strong class="go he"><em class="hf">a text editor and a C
                      compiler.</em></strong></p>
                <p id="9613" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">There must be a modern, easier
                  way to write Blue Pill programs. Maybe we should sacrifice a bit of Blue Pill’s processing power to
                  make it faster and friendlier to code and test. And this leads to MakeCode, the popular web-based tool
                  for programming and flashing microcontrollers…</p>
              </div>
            </div>
            <div class="do ak">
              <div class="figure hg hh hi hj hk do">
                <div class="dz r ds">
                  <div class="hl r"><iframe
                      src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2FDSNDvrVOJns%3Ffeature%3Doembed&amp;url=http%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DDSNDvrVOJns&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2FDSNDvrVOJns%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube"
                      allowfullscreen="" frameborder="0" height="300" width="400"
                      title="STM32 Blue Pill USB Bootloader and MakeCode" class="de t u dw ak"
                      scrolling="auto"></iframe></div>
                </div>
                <figcaption><p><em>Creating a MakeCode visual program and flashing
                  to Blue Pill</em></p></figcaption>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <p id="8ac4" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz"><a
                    href="https://makecode.com/about"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow"><strong
                      class="go he">MakeCode</strong></a> is an open-source <strong class="go he">visual programming
                    tool</strong> that’s easy to learn and use — makers around the world are already using MakeCode
                  today with the BBC micro:bit. It generates <a
                    href="https://makecode.com/language"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow"><strong class="go he">Static
                      TypeScript</strong></a>, a variant of JavaScript that’s optimised for newer powerful
                  microcontrollers like Blue Pill. <em class="hf">MakeCode could be the missing element that will make
                    Blue Pill wildly successful for IoT.</em></p>
                <p id="f46e" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">Will MakeCode run on Blue Pill?
                  There’s no official port of MakeCode for Blue Pill, but we’re nearly there. I have ported the most
                  complicated part of MakeCode to Blue Pill: the <strong class="go he">MakeCode Bootloader</strong>. If
                  the MakeCode Bootloader runs on Blue Pill, the rest is a piece of cake!</p>
                <p id="0c84" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">In this article we’ll take our
                  surgical scalpels, dissect and explore the innards of the MakeCode Bootloader that I have ported to
                  Blue Pill. We’ll learn…</p>
                <ol class="">
                  <li id="54b7" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz hr hs ht">What’s a <strong
                      class="go he">Bootloader</strong> and why we need a <strong class="go he">Custom
                      Bootloader</strong></li>
                  <li id="9c81" class="gm gn ar bz go b gp hu gr hv gt hw gv hx gx hy gz hr hs ht"><strong
                      class="go he">CODAL</strong> runtime library used by MakeCode to execute Blue Pill-specific
                    functions</li>
                  <li id="8dc0" class="gm gn ar bz go b gp hu gr hv gt hw gv hx gx hy gz hr hs ht">How the <strong
                      class="go he">Bootloader uses Blue Pill memory optimally</strong></li>
                  <li id="f6de" class="gm gn ar bz go b gp hu gr hv gt hw gv hx gx hy gz hr hs ht"><strong
                      class="go he">HF2 Protocol</strong> used by MakeCode and the Bootloader to flash the Blue Pill
                  </li>
                  <li id="bc88" class="gm gn ar bz go b gp hu gr hv gt hw gv hx gx hy gz hr hs ht"><strong
                      class="go he">Linker Script</strong> used to create the Bootloader memory layout</li>
                </ol>
                <p id="e56c" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">What’s a visual program? <a
                    href="https://youtu.be/P8GDrmWWSbk"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Check this video</a> to see how
                  MakeCode may be used to write a visual program that blinks the Blue Pill LED.</p>
              </div>
            </div>
          </section>
          <hr class="hz fj ia ib ic ho id ie if ig ih" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <h1 id="16d5" class="ii ij ar bz by ik il im in io ip iq ir is it iu iv">What’s A Bootloader?</h1>
                <p id="15ae" class="gm gn ar bz go b gp iw gr ix gt iy gv iz gx ja gz">Well it <strong
                    class="go he">boots</strong> and it <strong class="go he">loads</strong>… Duh.</p>
                <p id="54b9" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz"><strong
                    class="go he">Boot</strong>: The Bootloader is a small program that’s pre-installed in the ROM of
                  the microcontroller. It’s the first program that runs when we power on the device. Normally the
                  Bootloader will jump to the custom program that we have flashed into the ROM (assuming it has been
                  flashed). So most of the time we won’t notice that the Bootloader is actually started before our
                  custom program.</p>
                <p id="7a08" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz"><strong
                    class="go he">Load</strong>: The Bootloader enables us to load (or flash) our custom program into
                  ROM. On the Arduino Uno, the Bootloader receives our custom program file via the USB Serial Port and
                  flashes the custom program into ROM. For Blue Pill, the factory-installed Bootloader works the same
                  way except that it uses the UART pins instead of the USB port. See<em class="hf"> </em><a
                    href="https://www.st.com/content/ccc/resource/technical/document/application_note/51/5f/03/1e/bd/9b/45/be/CD00264342.pdf/files/CD00264342.pdf/jcr:content/translations/en.CD00264342.pdf"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow"><em class="hf">AN3155: USART
                      protocol used in the STM32 bootloader</em></a> and <a
                    href="https://www.st.com/content/ccc/resource/technical/document/application_note/b9/9b/16/3a/12/1e/40/0c/CD00167594.pdf/files/CD00167594.pdf/jcr:content/translations/en.CD00167594.pdf"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow"><em class="hf">AN2606: STM32
                      microcontroller system memory boot mode</em></a>.</p>
                <p id="090f" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">Remember that we set the <code
                    class="ea jb jc jd je b">BOOT0</code> jumper to <code class="ea jb jc jd je b">0</code> while
                  flashing Blue Pill via ST Link? This disables the factory-installed Bootloader so we don’t actually
                  flash the custom program via the UART pins. ST Link uses the SWD port on the Blue Pill to flash our
                  custom program into the ROM.</p>
                <h1 id="af68" class="ii ij ar bz by ik il jf in jg ip jh ir ji it jj iv">Why Build A Custom Bootloader?
                </h1>
                <p id="4960" class="gm gn ar bz go b gp iw gr ix gt iy gv iz gx ja gz">Flashing the Blue Pill via the
                  bare UART pins or the SWD port (via ST Link) is cumbersome. What if we could simply <strong
                    class="go he">click a button in a web page, and transmit our custom program directly into the Blue
                    Pill ROM</strong>? And how would we connect the Blue Pill to our computer? Just use the <strong
                    class="go he">USB port</strong> that’s already provided on Blue Pill! <em class="hf">Flashing the
                    Blue Pill would become so easy — just like in the demo above!</em></p>
                <p id="fe22" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz"><strong class="go he"><em
                      class="hf">But there’s a catch (or two)…</em></strong></p>
                <p id="f15e" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">1️⃣ <strong class="go he">The
                    Blue Pill’s USB port doesn’t have any built-in functionality.</strong> (Surprised? Many of my
                  students assumed that the Blue Pill USB port actually did <em class="hf">something</em>.) We need to
                  write the Blue Pill code to perform the flashing over USB. And the code will go into a <strong
                    class="go he">Custom Bootloader</strong> that we’ll install ourselves into our new Blue Pills. Once
                  installed, we shouldn’t need to re-flash the Custom Bootloader <em class="hf">(although there’s
                    actually an easy way to do this… in our next article!)</em></p>
                <p id="642a" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">2️⃣ <strong class="go he">Web
                    Browsers won’t allow us to access all types of USB devices (e.g. Blue Pill) directly through a web
                    page, for safety reasons</strong>. The Chrome browser provides the <a
                    href="https://developers.google.com/web/updates/2016/03/access-usb-devices-on-the-web"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow"><strong class="go he">WebUSB
                      JavaScript API</strong></a> for safely accessing some USB devices, including Blue Pill. With the
                  right code in the web page and the right code in the Custom Bootloader, we’ll see in a while that it’s
                  indeed possible to flash the Blue Pill via a web page, as we have seen in the demo above.</p>
                <p id="7ea0" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">So this article is all about the
                  <strong class="go he">internals of the Custom Bootloader for Blue Pill that supports flashing over
                    WebUSB</strong>. Details on implementing WebUSB on Blue Pill may be found in <a
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-usb-bootloader-how-i-fixed-the-usb-storage-serial-dfu-and-webusb-interfaces">my
                    earlier article</a>.</p>
                <div class="jk jl jm jn jo jp"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-usb-bootloader-how-i-fixed-the-usb-storage-serial-dfu-and-webusb-interfaces">
                    <section class="js da db ak ct n bh jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh">
                      <div class="ki n dd p kj kk">
                        <h2 class="by ik kl ca ar">
                          <div class="ax jq fm au jr aw">STM32 Blue Pill USB Bootloader — How I fixed the USB Storage,
                            Serial, DFU and WebUSB interfaces</div>
                        </h2>
                      </div>
                      <div class="ko r">
                        <div class="kp r kq kr ks ko kt ku kv"></div>
                      </div>
                    </section>
                  </a></div>
              </div>
            </div>
          </section>
          <hr class="hz fj ia ib ic ho id ie if ig ih" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <div class="hg hh hi hj hk jp"><a
                    href="https://lancaster-university.github.io/codal/?source=post_page-----b7f1a1508e89----------------------"
                    rel="noopener nofollow">
                    <section class="js da db ak ct n bh jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh">
                      <div class="ki n dd p kj kk">
                        <h2 class="by ik kl ca ar">
                          <div class="ax jq fm au jr aw">CODAL</div>
                        </h2>
                      </div>
                    </section>
                  </a></div>
                <h1 id="a2de" class="ii ij ar bz by ik il jf in jg ip jh ir ji it jj iv">CODAL Runtime for Embedded
                  Devices</h1>
                <p id="5671" class="gm gn ar bz go b gp iw gr ix gt iy gv iz gx ja gz">The <a
                    href="https://lancaster-university.github.io/codal/"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">CODAL runtime library created by
                    Lancaster University</a> provides a friendly and flexible C++ API for programming embedded devices.
                  MakeCode compiles our visual programs into Static TypeScript code that calls the CODAL library to
                  access the device and peripheral functions like the onboard LED and ports for UART, I2C, SPI, …</p>
                <p id="1d1f" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">Here’s a <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/samples/main.cpp"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">sample CODAL program that blinks
                    the LED</a>…</p>
                <pre
                  class="hg hh hi hj hk kw kx ky"><span id="e934" class="kz ij ar bz je b fk la lb r lc">void Blink_main(<strong class="je he">STM32BluePill</strong>&amp; device) {<br/> int state = 0;<br/> while(1) {    <br/><strong class="je he">   device.io.led.setDigitalValue(state);<br/></strong>   device.sleep(1000);<br/>   state = !state;<br/> }<br/>}</span></pre>
                <p id="0122" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">Comparing this with the <a
                    href="https://www.arduino.cc/en/tutorial/blink"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">same Arduino program that blinks
                    the LED</a>, it doesn’t look that different. But note that the onboard LED is neatly encapsulated as
                  <code class="ea jb jc jd je b"><strong class="go he">device.io.led</strong></code>. <code
                    class="ea jb jc jd je b">device</code> is an <code
                    class="ea jb jc jd je b"><a href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/model/STM32BluePill.h" class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow"><strong class="go he">STM32BluePill</strong></a></code>
                  object that’s defined as…</p>
                <pre
                  class="hg hh hi hj hk kw kx ky"><span id="9810" class="kz ij ar bz je b fk la lb r lc">class STM32BluePill : public CodalComponent {<br/>public:<br/>  Timer              timer;<br/>  MessageBus         messageBus;<br/>  STM32BluePillIO    io;<br/>  I2C                i2c1;<br/>  SPI                spi1;<br/>  SPI                spi2;<br/>  Serial             usart2;</span></pre>
                <p id="decb" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">Wow we have just dissected the
                  Blue Pill to reveal its innards: the system timer, I2C port, SPI port, USART port, … Each of these are
                  CODAL objects that expose methods for accessing the device and port-specific functions. The <code
                    class="ea jb jc jd je b">led</code> object we saw earlier is just another CODAL object defined in
                  <code class="ea jb jc jd je b">STM32BluePillIO</code>.</p>
                <p id="beba" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">CODAL gives us a clean way to
                  write embedded programs in C++ that will work with many types of modern microcontrollers, without
                  resorting to Arduino’s preprocessor symbols like in <code
                    class="ea jb jc jd je b">digitalWrite(LED_BUILTIN, HIGH)</code>.</p>
                <p id="7c1e" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">CODAL is officially supported for
                  <a href="https://github.com/lancaster-university/codal-mbed"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Arm microcontrollers</a> that use
                  Arm’s Mbed device library (including the <a
                    href="https://github.com/lancaster-university/microbit-dal"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">BBC micro:bit</a>). However Mbed
                  is not optimised for Blue Pill so I have ported CODAL to Blue Pill using the optimised open-source <a
                    href="https://github.com/libopencm3/libopencm3/wiki"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">libopencm3</a> library instead…
                </p>
                <div class="jk jl jm jn jo jp"><a
                    href="https://github.com/lupyuen/codal-libopencm3?source=post_page-----b7f1a1508e89----------------------"
                    rel="noopener nofollow">
                    <section class="js da db ak ct n bh jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh">
                      <div class="ki n dd p kj kk">
                        <h2 class="by ik kl ca ar">
                          <div class="ax jq fm au jr aw">lupyuen/codal-libopencm3</div>
                        </h2>
                      </div>
                      <div class="ko r">
                        <div class="ld r kq kr ks ko kt ku kv"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="ea2e" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">From here onwards, we’ll use the
                  term “CODAL” to refer to the Blue Pill version of CODAL. We’ll now look at the challenges in squeezing
                  CODAL to run on Blue Pill, coexisting with the Bootloader.</p>
              </div>
            </div>
          </section>
          <hr class="hz fj ia ib ic ho id ie if ig ih" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <div class="hg hh hi hj hk jp"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-analyse-and-optimise-your-ram-and-rom">
                    <section class="js da db ak ct n bh jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh">
                      <div class="ki n dd p kj kk">
                        <h2 class="by ik kl ca ar">
                          <div class="ax jq fm au jr aw">STM32 Blue Pill — Analyse and Optimise Your RAM and ROM</div>
                        </h2>
                      </div>
                      <div class="ko r">
                        <div class="le r kq kr ks ko kt ku kv"></div>
                      </div>
                    </section>
                  </a></div>
                <h1 id="1d5c" class="ii ij ar bz by ik il jf in jg ip jh ir ji it jj iv">Memory Layout for Bootloader
                </h1>
                <p id="1b01" class="gm gn ar bz go b gp iw gr ix gt iy gv iz gx ja gz">In <a class="bi cv ha hb hc hd"
                    target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-analyse-and-optimise-your-ram-and-rom">my
                    article on memory optimisation</a>, we learnt that the Blue Pill has <strong class="go he">64 KB of
                    ROM</strong>, from address <code class="ea jb jc jd je b">0x0800 0000</code> to <code
                    class="ea jb jc jd je b">0x0801 0000</code>. Assuming that we can use all 64 KB of ROM, our MakeCode
                  Application (the one we created through drag-and-drop) will fill up the available ROM like this…</p>
              </div>
            </div>
            <div class="do ak">
              <div class="figure hg hh hi hj hk do ak paragraph-image">                
                
                <p><img src="https://lupyuen.github.io/images/legacy2/k2.png" /></p>



              
                <figcaption><p><em>Memory Layout for MakeCode Application
                </em></p></figcaption>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <p id="651c" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">MakeCode compiles our visual
                  program into <strong class="go he">Arm Cortex machine code </strong>(not into intermediate bytecode),
                  so the compiled MakeCode App appears to Blue Pill like any other C function. The compiled MakeCode App
                  calls the <a
                    href="https://github.com/lupyuen/codal-libopencm3"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">CODAL library</a> to execute Blue
                  Pill device functions. To do its job, CODAL needs to call some friends…</p>
                <ul class="">
                  <li id="a327" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz lg hs ht"><strong
                      class="go he">libopencm3</strong>: The <a
                      href="https://github.com/libopencm3/libopencm3/wiki"
                      class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">open-source library</a> for Blue
                    Pill device functions</li>
                  <li id="8e8b" class="gm gn ar bz go b gp hu gr hv gt hw gv hx gx hy gz lg hs ht"><strong
                      class="go he">nano-float</strong>:<a
                      href="https://github.com/lupyuen/codal-libopencm3/tree/master/lib/nano-float"
                      class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow"> Math library</a> optimised for
                    Blue Pill. Includes <a
                      href="https://www.quinapalus.com/qfplib.html"
                      class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Qfplib</a>. I wrote about
                    nano-float <a class="bi cv ha hb hc hd" target="_blank" rel="noopener"
                      href="https://lupyuen.github.io/articles/stm32-blue-pill-shrink-your-math-libraries-with-qfplib">in
                      this article</a> and the <a class="bi cv ha hb hc hd" target="_blank" rel="noopener"
                      href="https://lupyuen.github.io/articles/stm32-blue-pill-unit-testing-with-qemu-blue-pill-emulator">Unit
                      Testing</a> too.</li>
                  <li id="7ba2" class="gm gn ar bz go b gp hu gr hv gt hw gv hx gx hy gz lg hs ht"><strong
                      class="go he">newlib</strong>: <a
                      href="https://github.com/lupyuen/newlib/tree/master"
                      class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Standard C library</a> optimised
                    for Blue Pill</li>
                  <li id="73d2" class="gm gn ar bz go b gp hu gr hv gt hw gv hx gx hy gz lg hs ht"><strong
                      class="go he">logger</strong>: <a
                      href="https://github.com/lupyuen/codal-libopencm3/tree/master/stm32/logger"
                      class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Library for logging</a> errors
                    and diagnostic messages</li>
                  <li id="2836" class="gm gn ar bz go b gp hu gr hv gt hw gv hx gx hy gz lg hs ht"><strong
                      class="go he">bluepill</strong>: <a
                      href="https://github.com/lupyuen/codal-libopencm3/tree/master/stm32/bluepill"
                      class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Common functions</a> for
                    Real-Time Clock and System Timers</li>
                  <li id="0077" class="gm gn ar bz go b gp hu gr hv gt hw gv hx gx hy gz lg hs ht"><strong
                      class="go he">hal</strong>: <a
                      href="https://github.com/lupyuen/codal-libopencm3/tree/master/stm32/hal"
                      class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Hardware Adaptation Layer</a>,
                    called by CODAL</li>
                </ul>
                <p id="ed9c" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">What’s missing from the picture?
                  The <strong class="go he">Bootloader</strong> of course! Without the Bootloader, we won’t be able to
                  flash the MakeCode App to Blue Pill via the web browser. Let’s add the Bootloader…</p>
              </div>
            </div>
            <div class="do ak">
              <div class="figure hg hh hi hj hk do ak paragraph-image">                
                
                <p><img src="https://lupyuen.github.io/images/legacy2/k3.png" /></p>



             
                <figcaption><p><em>Memory Layout after adding Bootloader
                </em></p></figcaption>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <p id="fb1e" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">Now we have a problem… 1️⃣
                  <strong class="go he">CODAL calls the libopencm3 library</strong> to access the Blue Pill device
                  functions 2️⃣ <strong class="go he">Bootloader needs the libopencm3 library</strong> to write to flash
                  memory and to access the USB port. So we have <strong class="go he">TWO copies</strong> of the
                  libopencm3 code in ROM.</p>
                <p id="3421" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">We don’t have enough ROM space
                  for two copies of libopencm3, so let’s use only one copy of libopencm3, shared by the <strong
                    class="go he">Application</strong> (CODAL + MakeCode App) and the <strong
                    class="go he">Bootloader</strong>…</p>
              </div>
            </div>
            <div class="do ak">
              <div class="figure hg hh hi hj hk do ak paragraph-image">                
                
                <p><img src="https://lupyuen.github.io/images/legacy2/k4.png" /></p>



            
                <figcaption><p><em>Memory Layout optimised for Application +
                  Bootloader</em></p></figcaption>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <p id="e92a" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">For clarity, we segregate the
                  Bootloader and the Application into two Memory Regions: <code
                    class="ea jb jc jd je b"><strong class="go he">bootrom</strong></code> (for Bootloader) and <code
                    class="ea jb jc jd je b"><strong class="go he">rom</strong></code> (for Application). Recall that
                  the Application (<code class="ea jb jc jd je b">rom</code>) will be updated more often than the
                  Bootloader (<code class="ea jb jc jd je b">bootrom</code>).</p>
                <p id="5001" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">This Bootloader design is rarely
                  used in real life because it needs the <strong class="go he">Bootloader and the Application to be
                    carefully matched by code version.</strong> Otherwise the Application might call a shared function
                  (in libopencm3, for example) using an older address that’s no longer valid in the current Bootloader.
                </p>
                <p id="dfc1" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">How do we tell the Blue Pill
                  compiler and linker to use this memory layout? We define the memory layout in the <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/ld/stm32f103x8.ld"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Linker Script</a>. The details may
                  be found in the <em class="hf">“For Advanced Programmers: Linker Script for Bootloader”</em> section
                  below.</p>
              </div>
            </div>
          </section>
          <hr class="hz fj ia ib ic ho id ie if ig ih" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <h1 id="d175" class="ii ij ar bz by ik il im in io ip iq ir is it iu iv">WebUSB Flashing with the HF2
                  Protocol</h1>
                <p id="5c9c" class="gm gn ar bz go b gp iw gr ix gt iy gv iz gx ja gz">The <a
                    href="https://github.com/lupyuen/codal-libopencm3/tree/master/stm32/bootloader"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">WebUSB Bootloader</a> that I have
                  implemented for Blue Pill (adapted from <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/README.md"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">various sources</a>) is a hefty
                  embedded program taking <strong class="go he">29 KB of ROM</strong> space. Why is it so huge? Because
                  it supports…</p>
                <p id="ebdd" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">1️⃣ <strong class="go he">WebUSB
                    and WinUSB</strong> protocols. Allows the MakeCode website to access the Blue Pill via USB through
                  the Chrome web browser, without installing any drivers. I wrote about WebUSB and WinUSB <a
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-usb-bootloader-how-i-fixed-the-usb-storage-serial-dfu-and-webusb-interfaces">in
                    this article</a>.</p>
                <p id="9346" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">2️⃣ <strong class="go he">USB
                    Serial Port</strong> (<a
                    href="https://en.wikipedia.org/wiki/USB_communications_device_class"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">USB CDC</a>) for debug logging</p>
                <p id="c131" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">3️⃣ <a
                    href="https://github.com/Microsoft/uf2/blob/master/hf2.md"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow"><strong class="go he">HF2
                      Protocol</strong></a> for flashing Blue Pill via WebUSB</p>
                <p id="36f1" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">4️⃣ And remember that the
                  Bootloader includes <strong class="go he">libopencm3 and other common functions</strong> used by the
                  MakeCode Application, due to the way we partitioned the ROM space into Bootloader and Application
                  regions.</p>
                <p id="fe8e" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">How do we tell Blue Pill that we
                  want to flash a new Application into ROM? Do we press a button on Blue Pill to enter Bootloader Mode,
                  <a href="https://learn.adafruit.com/makecode/downloading-and-flashing"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">like on some MakeCode devices</a>?
                </p>
                <p id="8214" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">Not so! The demo above shows that
                  the flashing of Blue Pill is fully automated and triggered by the web browser, when we click the <code
                    class="ea jb jc jd je b">Download</code> button in the MakeCode web page. How does this work?</p>
                <p id="aa78" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">While the Application runs on
                  Blue Pill (we call this the <strong class="go he">Application Mode</strong>), the Bootloader is called
                  periodically to check for USB requests. When the Bootloader receives a request for flashing, it
                  restarts the Blue Pill into <strong class="go he">Bootloader Mode</strong> to perform the flashing.
                  The Application doesn’t run until the flashing has been completed.</p>
              </div>
            </div>
            <div class="do ak">
              <div class="figure hg hh hi hj hk do ak paragraph-image">                
                
                <p><img src="https://lupyuen.github.io/images/legacy2/k5.png" /></p>



              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <p id="386b" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">The flashing magic is made
                  possible by the <strong class="go he">HF2 Protocol</strong> implemented in the <a
                    href="https://github.com/lupyuen/stm32bluepill-makecode"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">MakeCode website</a> and in the
                  Bootloader code. The MakeCode website <a
                    href="https://github.com/lupyuen/pxt/blob/master/pxtlib/hf2.ts"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">transmits HF2 command packets</a>
                  via in-browser JavaScript, via the WebUSB JavaScript API, via the WinUSB driver (on Windows), finally
                  to the USB port of the Blue Pill.</p>
                <p id="fa37" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">The <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/hf2.c"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Blue Pill Bootloader</a> receives
                  the HF2 command packets and executes them, switching between Application and Bootloader Modes when
                  necessary.</p>
                <p id="c82a" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">Here’s the overall flow of the
                  HF2 flashing process as implemented in our <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/hf2.c#L101-L215"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Blue Pill WebUSB Bootloader</a>…
                </p>
                <div class="figure hg hh hi hj hk do da db paragraph-image">                
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/k6.png" /></p>
  
  
                </div>
                <p id="2f2b" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">1️⃣ MakeCode website first sends
                  the <code class="ea jb jc jd je b">BININFO</code> command. Blue Pill returns the current mode
                  (Application or Bootloader Mode), and the flash memory size (64 KB).</p>
                <p id="f7df" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">2️⃣ MakeCode then sends the <code
                    class="ea jb jc jd je b">INFO</code> command. Blue Pill returns the identity of the device e.g.
                  <code class="ea jb jc jd je b">STM32BLUEPILL</code>.</p>
                <p id="2696" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">3️⃣ MakeCode sends <code
                    class="ea jb jc jd je b">START_FLASH</code>. Blue Pill restarts in Bootloader Mode to begin
                  flashing.</p>
                <div class="figure hg hh hi hj hk do da db paragraph-image">                
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/k7.png" /></p>
  
  
  
                </div>
                <p id="ed5f" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">4️⃣ For each 1 KB page of data to
                  be flashed, MakeCode sends the <code class="ea jb jc jd je b">WRITE_FLASH_PAGE</code> command and the
                  data to be flashed. Blue Pill compares the received data with the current ROM data. If the data is
                  different, it writes the received data to ROM. This is only applicable for the Application ROM, not
                  the Bootloader ROM.</p>
                <p id="3328" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">5️⃣ MakeCode sends <code
                    class="ea jb jc jd je b">RESET_INTO_APP</code>. Blue Pill restarts in Application Mode and runs the
                  flashed Application.</p>
                <p id="6fe6" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">What if the Bootloader needs to
                  be upgraded? The same flow works for upgrading the Bootloader as well. In the next article I’ll
                  explain how the <a
                    href="https://github.com/lupyuen/codal-libopencm3/tree/master/stm32/baseloader"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Baseloader</a> upgrades the
                  Bootloader code.</p>
              </div>
            </div>
          </section>
          <hr class="hz fj ia ib ic ho id ie if ig ih" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <h1 id="5c8c" class="ii ij ar bz by ik il im in io ip iq ir is it iu iv">What’s Next?</h1>
                <p id="4055" class="gm gn ar bz go b gp iw gr ix gt iy gv iz gx ja gz">The WebUSB Bootloader for
                  MakeCode on Blue Pill is incredibly complex — it required four articles (plus this article) to explain
                  the topics that we have covered today…</p>
                <p id="7026" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">1️⃣ We implemented the WebUSB and
                  WinUSB interfaces on Blue Pill…</p>
                <div class="jk jl jm jn jo jp"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-usb-bootloader-how-i-fixed-the-usb-storage-serial-dfu-and-webusb-interfaces">
                    <section class="js da db ak ct n bh jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh">
                      <div class="ki n dd p kj kk">
                        <h2 class="by ik kl ca ar">
                          <div class="ax jq fm au jr aw">STM32 Blue Pill USB Bootloader — How I fixed the USB Storage,
                            Serial, DFU and WebUSB interfaces</div>
                        </h2>
                      </div>
                      <div class="ko r">
                        <div class="kp r kq kr ks ko kt ku kv"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="4e43" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">2️⃣ We applied memory
                  optimisation tools and techniques to squeeze the Bootloader into Blue Pill…</p>
                <div class="jk jl jm jn jo jp"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-analyse-and-optimise-your-ram-and-rom">
                    <section class="js da db ak ct n bh jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh">
                      <div class="ki n dd p kj kk">
                        <h2 class="by ik kl ca ar">
                          <div class="ax jq fm au jr aw">STM32 Blue Pill — Analyse and Optimise Your RAM and ROM</div>
                        </h2>
                      </div>
                      <div class="ko r">
                        <div class="le r kq kr ks ko kt ku kv"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="38d8" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">3️⃣ We created nano-float, an
                  optimised version of the standard math library…</p>
                <div class="jk jl jm jn jo jp"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-shrink-your-math-libraries-with-qfplib">
                    <section class="js da db ak ct n bh jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh">
                      <div class="ki n dd p kj kk">
                        <h2 class="by ik kl ca ar">
                          <div class="ax jq fm au jr aw">STM32 Blue Pill – Shrink your math libraries with Qfplib</div>
                        </h2>
                      </div>
                      <div class="ko r">
                        <div class="ll r kq kr ks ko kt ku kv"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="60d5" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">4️⃣ And we verified the accuracy
                  of the nano-float library through Unit Testing…</p>
                <div class="jk jl jm jn jo jp"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-unit-testing-with-qemu-blue-pill-emulator">
                    <section class="js da db ak ct n bh jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh">
                      <div class="ki n dd p kj kk">
                        <h2 class="by ik kl ca ar">
                          <div class="ax jq fm au jr aw">STM32 Blue Pill — Unit Testing with Qemu Blue Pill Emulator
                          </div>
                        </h2>
                      </div>
                      <div class="ko r">
                        <div class="lm r kq kr ks ko kt ku kv"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="1c37" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">5️⃣ We have one upcoming article
                  that explains how the Baseloader upgrades the Bootloader.</p>
                <p id="e041" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">It’s been a long journey —<strong
                    class="go he"> join me if you’re keen to complete the Blue Pill port of MakeCode!</strong> So that
                  we’ll finally have the perfect platform to build and test IoT prototypes.</p>
                <p id="b3c7" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">There are too many topics to
                  cover, so I kept a log of all things that I have tried (even the failed ones)…</p>
                <div class="jk jl jm jn jo jp"><a rel="noopener"
                    href="https://web.archive.org/web/20191204194221/https://medium.com/@ly.lee/work-in-progress-stm32-blue-pill-visual-programming-with-makecode-codal-and-libopencm3-422d308f252e?source=friends_link&sk=b39519335652415d5f4aa17c9e4af1d2">
                    <section class="js da db ak ct n bh jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh">
                      <div class="ki n dd p kj kk">
                        <h2 class="by ik kl ca ar">
                          <div class="ax jq fm au jr aw">[Work In Progress] STM32 Blue Pill Visual Programming with
                            MakeCode, CODAL and libopencm3</div>
                        </h2>
                      </div>
                      <div class="ko r">
                        <div class="ln r kq kr ks ko kt ku kv"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="427a" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">Why not port MicroPython to Blue
                  Pill? <a
                    href="https://github.com/lupyuen/send_altitude_cocoos/tree/micropython/lib/bluepill-micropython/ports/bluepill"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">I tried but failed miserably</a>.
                  MicroPython was designed for dynamic memory allocation, which works poorly on Blue Pill’s constrained
                  RAM. Unlike MakeCode, which implements Static TypeScript without dynamic memory.</p>
                <p id="345d" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">Look forward to having you
                  onboard the Blue Pill MakeCode journey! :-)</p>
              </div>
            </div>
          </section>
          <hr class="hz fj ia ib ic ho id ie if ig ih" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <h1 id="37f4" class="ii ij ar bz by ik il im in io ip iq ir is it iu iv">For Advanced Programmers:
                  Linker Script for Bootloader</h1>
                <p id="b877" class="gm gn ar bz go b gp iw gr ix gt iy gv iz gx ja gz"><em class="hf">If you’re
                    interested in writing a Linker Script to customise the memory layout in your embedded program, read
                    on…</em></p>
                <pre
                  class="hg hh hi hj hk kw kx ky"><span id="465f" class="kz ij ar bz je b fk la lb r lc">_bootrom_size = 29K<br/>...<br/>MEMORY /* Define memory regions. */<br/>{<br/>  /* Available ROM is 64K (0x10000). <br/>     Reserve lower part for Bootloader, <br/>     upper part for Application. */</span><span id="3538" class="kz ij ar bz je b fk lo lp lq lr ls lb r lc">bootrom (rx)  : ORIGIN = 0x08000000,      <br/>                 LENGTH = _bootrom_size</span><span id="5fc9" class="kz ij ar bz je b fk lo lp lq lr ls lb r lc">rom     (rx)  : ORIGIN = 0x08000000 + _bootrom_size, <br/>                 LENGTH = 64K - _bootrom_size</span></pre>
                <p id="05a6" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">The above <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/ld/stm32f103x8.ld"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Linker Script</a> tells the GNU
                  Linker to create two memory regions: <code class="ea jb jc jd je b">bootrom</code> (29 KB) and <code
                    class="ea jb jc jd je b">rom</code> (64–29=35 KB). How do we instruct the linker to allocate various
                  libraries to <code class="ea jb jc jd je b">bootrom</code> and <code
                    class="ea jb jc jd je b">rom</code>?</p>
              </div>
            </div>
            <div class="do ak">
              <div class="figure hg hh hi hj hk do ak paragraph-image">                
                
                <p><img src="https://lupyuen.github.io/images/legacy2/k8.png" /></p>



         
                <figcaption><p><em>Memory Layout with two memory regions
                </em></p></figcaption>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eg aj ak">
                <p id="fef5" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">From <a class="bi cv ha hb hc hd"
                    target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-analyse-and-optimise-your-ram-and-rom">my
                    article on memory optimisation</a>, you’ll recall that the <code class="ea jb jc jd je b">rom</code>
                  memory region contains a <strong class="go he">Text Section</strong> (for program code) and a <strong
                    class="go he">Data Section</strong> (for initial values of non-zero variables). Here’s how we tell
                  the linker which libraries to allocate into the Text Section of <code
                    class="ea jb jc jd je b">bootrom</code>…</p>
                <pre
                  class="hg hh hi hj hk kw kx ky"><span id="bbd7" class="kz ij ar bz je b fk la lb r lc">SECTIONS<br/>{<br/> .boot_text : { /* Bootloader ROM */<br/>  ...<br/>  *liblibopencm3.a: (.text*) /* libopencm3       */<br/>  *libnano-float.a: (.text*) /* Math Library     */<br/>  *libnewlib.a:     (.text*) /* C Library        */<br/>  *liblogger.a:     (.text*) /* Logger           */<br/>  *libbluepill.a:   (.text*) /* Device Functions */<br/>  *libbootloader.a: (.text*) /* Bootloader       */<br/>  ...<br/>} &gt;bootrom</span></pre>
                <p id="23f2" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">The <code
                    class="ea jb jc jd je b">*</code> wildcard matches any number of characters. When used like this…
                </p>
                <pre
                  class="hg hh hi hj hk kw kx ky"><span id="804b" class="kz ij ar bz je b fk la lb r lc">*liblibopencm3.a: (.text*)</span></pre>
                <p id="0888" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">…the linker takes all object
                  files (<code class="ea jb jc jd je b">*.o</code>) from the library <code
                    class="ea jb jc jd je b">liblibopencm3.a</code>, extracts all the Text Sections, and writes them
                  into the <code class="ea jb jc jd je b">bootrom</code> memory region.</p>
                <p id="0f36" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">All other libraries and object
                  files that don’t match the above patterns will be allocated in the <code
                    class="ea jb jc jd je b">rom</code> memory region, according to this rule…</p>
                <pre
                  class="hg hh hi hj hk kw kx ky"><span id="0eac" class="kz ij ar bz je b fk la lb r lc">.text : {          /* Application ROM        */<br/>  ...<br/>  * (.text*) /* Other Application Code */<br/>  ...<br/>} &gt;rom</span></pre>
                <p id="fa86" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">What about the Blue Pill RAM? We
                  allocate the available RAM into three memory regions: <code class="ea jb jc jd je b">bootram</code>
                  (for the Bootloader), <code class="ea jb jc jd je b">ram</code> (for the Application) and <code
                    class="ea jb jc jd je b">bootbuf</code>. <code class="ea jb jc jd je b">bootbuf</code> contains the
                  RAM buffers used for flashing the ROM in Bootloader Mode. Since <code
                    class="ea jb jc jd je b">bootbuf</code> is not used in Application Mode, <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/bootloader.c#L170-L173"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">we convert </a><code
                    class="ea jb jc jd je b"><a href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/bootloader.c#L170-L173" class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">bootbuf</a></code><a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/bootloader.c#L170-L173"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow"> into an extended memory space for
                    the stack and the heap</a> while running the Application.</p>
                <p id="05ef" class="gm gn ar bz go b gp gq gr gs gt gu gv gw gx gy gz">The <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/ld/stm32f103x8.ld"
                    class="bi cv ha hb hc hd" target="_blank" rel="noopener nofollow">Linker Script</a> for RAM layout
                  looks like this…</p>
                <pre
                  class="hg hh hi hj hk kw kx ky"><span id="13cc" class="kz ij ar bz je b fk la lb r lc">_bootrom_size = 29K;    /* Size of Bootloader ROM <br/>                           (code + constant data) */</span><span id="5881" class="kz ij ar bz je b fk lo lp lq lr ls lb r lc">_bootram_size =  4K;    /* Size of Bootloader RAM */</span><span id="c6c3" class="kz ij ar bz je b fk lo lp lq lr ls lb r lc">_bootbuf_size = /* Size of the Bootloader buffers...         */<br/> 1090 +         /* flashBuf from stm32/bootloader/ghostfat.c */<br/> 1024 +         /* hf2_buffer from stm32/bootloader/hf2.c    */<br/>    2;          /* Align to 4 bytes */<br/>...<br/>MEMORY /* Define memory regions. */<br/>{<br/>  /* Available RAM is 20K (0x5000). <br/>     Reserve lower part for Bootloader, <br/>     middle part for Application,<br/>     upper part for Bootloader flash buffers <br/>     (not used in Application Mode). */</span><span id="2ee4" class="kz ij ar bz je b fk lo lp lq lr ls lb r lc">  bootram (rwx) : ORIGIN = 0x20000000,      <br/>                  LENGTH = _bootram_size</span><span id="0368" class="kz ij ar bz je b fk lo lp lq lr ls lb r lc">  ram     (rwx) : ORIGIN = 0x20000000 + _bootram_size, <br/>                  LENGTH = 20K - _bootram_size - _bootbuf_size</span><span id="531c" class="kz ij ar bz je b fk lo lp lq lr ls lb r lc">  bootbuf (rwx) : ORIGIN = 0x20005000 - _bootbuf_size, <br/>                  LENGTH = _bootbuf_size</span></pre>
              </div>
            </div>
          </section>
        </div>
      </article>
    </div>
  </div>

  <ul>
    <li>
    <p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io">Check out my articles</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
    </li>
  </ul>
    
</body>

</html>
<!--
     FILE ARCHIVED ON 19:42:07 Dec 04, 2019 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 01:30:26 Feb 23, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 132.391
  exclusion.robots: 0.37
  exclusion.robots.policy: 0.357
  RedisCDXSource: 2.02
  esindex: 0.016
  LoadShardBlock: 94.043 (3)
  PetaboxLoader3.datanode: 54.885 (4)
  CDXLines.iter: 31.615 (3)
  load_resource: 52.065
  PetaboxLoader3.resolve: 20.617
-->