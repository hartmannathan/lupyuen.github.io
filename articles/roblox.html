<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>IoT Digital Twin with Roblox and The Things Network</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="IoT Digital Twin with Roblox and The Things Network" 
    data-rh="true">
<meta property="og:description" 
    content="Can we use Roblox to monitor and control an IoT Device... Through LoRaWAN and The Things Network?"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/roblox-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">IoT Digital Twin with Roblox and The Things Network</h1>
    <nav id="TOC"><ul>
<li><a href="#roblox-mirrors-real-life">1 Roblox Mirrors Real Life</a><ul></ul></li>
<li><a href="#roblox-fetches-sensor-data">2 Roblox Fetches Sensor Data</a><ul>
<li><a href="#define-constants">2.1 Define Constants</a><ul></ul></li>
<li><a href="#import-modules">2.2 Import Modules</a><ul></ul></li>
<li><a href="#send-http-request">2.3 Send HTTP Request</a><ul></ul></li>
<li><a href="#decode-http-response">2.4 Decode HTTP Response</a><ul></ul></li>
<li><a href="#check-errors">2.5 Check Errors</a><ul></ul></li>
<li><a href="#return-sensor-data">2.6 Return Sensor Data</a><ul></ul></li></ul></li>
<li><a href="#roblox-mirroring-in-action">3 Roblox Mirroring In Action</a><ul>
<li><a href="#create-part-and-script">3.1 Create Part and Script</a><ul></ul></li>
<li><a href="#edit-settings">3.2 Edit Settings</a><ul></ul></li>
<li><a href="#create-modulescripts">3.3 Create ModuleScripts</a><ul></ul></li>
<li><a href="#watch-it-run">3.4 Watch It Run</a><ul></ul></li></ul></li>
<li><a href="#decode-base64-and-cbor-in-roblox">4 Decode Base64 and CBOR in Roblox</a><ul>
<li><a href="#base64-and-cbor-modulescripts">4.1 Base64 and CBOR ModuleScripts</a><ul></ul></li></ul></li>
<li><a href="#render-temperature-with-roblox-particle-emitter">5 Render Temperature With Roblox Particle Emitter</a><ul>
<li><a href="#magic-numbers">5.1 Magic Numbers</a><ul></ul></li>
<li><a href="#interpolate-the-particle-emitter">5.2 Interpolate the Particle Emitter</a><ul></ul></li>
<li><a href="#update-the-particle-emitter">5.3 Update the Particle Emitter</a><ul></ul></li>
<li><a href="#linear-interpolation">5.4 Linear Interpolation</a><ul></ul></li></ul></li>
<li><a href="#digital-twin-demo">6 Digital Twin Demo</a><ul>
<li><a href="#demo-code">6.1 Demo Code</a><ul></ul></li></ul></li>
<li><a href="#whats-next">7 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">8 Notes</a><ul></ul></li>
<li><a href="#appendix-install-roblox-studio">9 Appendix: Install Roblox Studio</a><ul></ul></li>
<li><a href="#appendix-particle-emitter-settings">10 Appendix: Particle Emitter Settings</a><ul></ul></li>
<li><a href="#appendix-the-things-network-settings">11 Appendix: The Things Network Settings</a><ul>
<li><a href="#storage-integration">11.1 Storage Integration</a><ul></ul></li>
<li><a href="#api-key">11.2 API Key</a><ul></ul></li>
<li><a href="#security">11.3 Security</a><ul></ul></li></ul></li>
<li><a href="#appendix-fetch-sensor-data-from-the-things-network">12 Appendix: Fetch Sensor Data from The Things Network</a><ul></ul></li></ul></nav><p>üìù <em>8 Oct 2021</em></p>
<p><a href="https://developer.roblox.com/en-us/"><strong>Roblox</strong></a> is a <strong>Multiplayer Virtual World</strong> that lets us create <strong>3D Objects</strong> and interact with them. (Free to create and play)</p>
<p><a href="https://lupyuen.github.io/articles/ttn"><strong>The Things Network</strong></a> is a <strong>Public Wireless Network</strong> that connects many <strong>IoT Gadgets</strong> around the world. (It‚Äôs free too)</p>
<p><em>Can we connect Roblox to The Things Network‚Ä¶ To Monitor and Control Real-World Gadgets?</em></p>
<p><img src="https://lupyuen.github.io/images/digital-twin.jpg" alt="Digital Twin" /></p>
<p>Think of the possibilities‚Ä¶</p>
<ol>
<li>
<p>Walk around a <strong>Roblox House</strong> to <strong>monitor the temperature</strong> in our Smart Home. </p>
<p>Flip the lights on and off in the Virtual House, to <strong>control the lights</strong> in our Real Home.</p>
<p><a href="https://medium.com/@camden.o.b/how-we-could-make-a-roblox-smart-home-that-connects-to-the-real-world-e4d89b309516">(Check out this excellent article by Camden Bruce)</a></p>
</li>
<li>
<p>Wander about a <strong>Roblox Farm</strong> to check on <strong>Farm Crops and Livestock</strong> in real life.</p>
<p><a href="https://www.thethingsindustries.com/news/implementing-gps-cattle-tracking-solution-lorawan/">(Yes there are Cow Sensors)</a></p>
</li>
<li>
<p>Teach young learners about <strong>Internet of Things (IoT)</strong>‚Ä¶</p>
<p>How <strong>Sensors and Actuators</strong> work, and how they impact our lives.</p>
</li>
</ol>
<p>Sounds very ‚ÄúFree Guy‚Äù and ‚ÄúMatrix‚Äù-ish, but the above is actually a well-known concept in IoT: <strong>Digital Twin</strong>.</p>
<p><em>What‚Äôs a Digital Twin?</em></p>
<p>A <a href="https://en.m.wikipedia.org/wiki/Digital_twin"><strong>Digital Twin</strong></a> is a Virtual Object that <strong>mirrors a Real-World Object</strong> through <strong>Sensors and Actuators</strong>. (Like the pic above)</p>
<p>For today‚Äôs experiment we shall take this IoT Gadget: <a href="https://lupyuen.github.io/articles/pinedio2"><strong>PineDio Stack BL604 RISC-V Board</strong></a>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/ttn-title.jpg" alt="PineDio Stack BL604 RISC-V Board (foreground) talking to The Things Network via RAKWireless RAK7248 LoRaWAN Gateway (background)" /></p>
<p>And turn it into a <strong>Virtual Gadget in Roblox</strong> such that‚Ä¶</p>
<ul>
<li>
<p>If our <strong>Real Gadget</strong> feels hot‚Ä¶</p>
</li>
<li>
<p>Then our <strong>Virtual Gadget</strong> looks hot too!</p>
</li>
</ul>
<p>All <strong>Roblox Scripts</strong> may be found in this repo‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/roblox-the-things-network"><strong>lupyuen/roblox-the-things-network</strong></a></li>
</ul>
<p>(Apologies if my Roblox looks rough‚Ä¶ This is my first time using Roblox üôè)</p>
<p><img src="https://lupyuen.github.io/images/roblox-title.jpg" alt="Cold / Hot / Normal IoT Objects rendered in Roblox" /></p>
<h1 id="roblox-mirrors-real-life"><a href="#roblox-mirrors-real-life">1 Roblox Mirrors Real Life</a></h1>
<p>The pic shows what we shall accomplish with Roblox‚Ä¶ </p>
<p>A Virtual Object that <strong>visualises the Live Temperature</strong> of our Real Object (PineDio Stack)</p>
<ul>
<li>
<p><strong>Freezing Cold</strong> (left)</p>
</li>
<li>
<p><strong>Normal Temperature</strong> (middle)</p>
<p>(Think Shrek and green fireflies)</p>
</li>
<li>
<p><strong>Fiery Hot</strong> (right)</p>
</li>
</ul>
<p>In fact we‚Äôll show <strong>10,000 Levels of Hotness / Coldness</strong>, thanks to a little Math. <a href="https://en.wikipedia.org/wiki/Linear_interpolation">(And Linear Interpolation)</a></p>
<ul>
<li><a href="https://www.youtube.com/watch?v=3CP7ELTAFLg"><strong>Watch the Demo Video on YouTube</strong></a></li>
</ul>
<p><em>What magic makes this mirroring possible?</em></p>
<p>This mirroring of real things in Roblox is possible because‚Ä¶</p>
<ol>
<li>
<p>Roblox lets us write <strong>Lua Scripts</strong> that can make <strong>HTTP Requests</strong> to the internet</p>
</li>
<li>
<p>The Things Network exposes a <strong>HTTP Service</strong> that lets us retrieve the <strong>Sensor Data</strong> (like Temperature) sent by IoT Gadgets</p>
</li>
</ol>
<p>Connect (1) to (2) and we‚Äôll get a Roblox Gadget that <strong>mirrors the Hot / Cold State</strong> of a Real Gadget.</p>
<p>Let‚Äôs talk about Roblox Lua Scripts and HTTP Requests‚Ä¶</p>
<p><a href="https://education.roblox.com/en-us/resources/intro-to-coding-coding-1-create-a-script">(More about Roblox Lua Scripting)</a></p>
<p><a href="https://lupyuen.github.io/articles/ttn">(More about The Things Network)</a></p>
<p><img src="https://lupyuen.github.io/images/roblox-http.jpg" alt="Roblox talking to The Things Network" /></p>
<h1 id="roblox-fetches-sensor-data"><a href="#roblox-fetches-sensor-data">2 Roblox Fetches Sensor Data</a></h1>
<p>Roblox provides a <strong>HttpService API</strong> that we may call in our Lua Scripts to <strong>fetch External HTTP URLs</strong> (via GET and POST)‚Ä¶</p>
<ul>
<li><a href="https://developer.roblox.com/en-us/api-reference/class/HttpService"><strong>Roblox HttpService API</strong></a></li>
</ul>
<p>Below we see HttpService in action, fetching the current <strong>latitude and longitude of International Space Station</strong>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/roblox-script.png" alt="Roblox Lua Script calls HttpService" /></p>
<p><a href="https://developer.roblox.com/en-us/api-reference/function/HttpService/GetAsync">(Source)</a></p>
<p>To <strong>fetch Sensor Data</strong> from The Things Network, we have created a <strong>getSensorData</strong> function in <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L22-L77">DigitalTwin.lua</a>.</p>
<p>When we run this Roblox Script‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Fetch the Sensor Data from The Things Network (LoRa)
local sensorData = getSensorData()

-- Show the Temperature
if sensorData then
  print(&quot;Temperature:&quot;)
  print(sensorData.t)
else
  print(&quot;Failed to get sensor data&quot;)
end</code></pre></div>
<p><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L328-L335">(Source)</a></p>
<p>We should see the <strong>Temperature Sensor Data</strong> fetched from The Things Network‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Temperature: 1236</code></pre></div>
<p>(This means <code>12.36</code> ¬∫C, our values have been scaled up by 100 times)</p>
<p>Let‚Äôs study the code inside our <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L22-L77"><strong>getSensorData</strong></a> function.</p>
<h2 id="define-constants"><a href="#define-constants">2.1 Define Constants</a></h2>
<p>We begin by <strong>defining the constants</strong> for accessing The Things Network: <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L1-L77">DigitalTwin.lua</a></p>
<div class="example-wrap"><pre class="language-lua"><code>-- Enable type checking
--!strict

-- TODO: Change this to your Application ID for The Things Network
-- (Must have permission to Read Application Traffic)
local TTN_APPLICATION_ID = &quot;YOUR_APPLICATION_ID&quot;

-- TODO: Change this to your API Key for The Things Network
local TTN_API_KEY = &quot;YOUR_API_KEY&quot;

-- TODO: Change this to your region-specific URL for The Things Network
local TTN_URL = &quot;https://au1.cloud.thethings.network/api/v3/as/applications/&quot; .. TTN_APPLICATION_ID .. &quot;/packages/storage/uplink_message?limit=1&amp;order=-received_at&quot;</code></pre></div>
<p>(‚Äú<code>..</code>‚Äù in Lua means concatenate the strings)</p>
<p>Our URL for The Things Network (<strong>TTN_URL</strong>) looks like‚Ä¶</p>
<div class="example-wrap"><pre class="language-uri"><code>https://au1.cloud.thethings.network/api/v3/as/
  applications/YOUR_APPLICATION_ID/
  packages/storage/uplink_message
  ?limit=1&amp;order=-received_at</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/roblox#appendix-the-things-network-settings">(More about these settings in the Appendix)</a></p>
<p>Note that we enable <strong>Type Checking</strong> at the top‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Enable type checking
--!strict</code></pre></div>
<p>This is super helpful for catching incorrect parameters passed to function calls.</p>
<p>Click <strong>View ‚Üí Script Analysis</strong> to see the warnings.</p>
<p><a href="https://lupyuen.github.io/articles/roblox#notes">(Ignore the two warnings for ‚ÄúArgument count mismatch‚Äù)</a></p>
<h2 id="import-modules"><a href="#import-modules">2.2 Import Modules</a></h2>
<p>Next we get the <strong>HttpService</strong> from Roblox‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Get the HttpService for making HTTP Requests
local HttpService = game:GetService(&quot;HttpService&quot;)</code></pre></div>
<p><strong>HTTP Requests must be enabled</strong> in Roblox‚Ä¶</p>
<p>Click <strong>Home ‚Üí Game Settings ‚Üí Security ‚Üí Allow HTTP Requests</strong></p>
<p>We import the <strong>ModuleScripts</strong> that will be called to decode our Sensor Data‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Load the Base64 and CBOR ModuleScripts from ServerStorage
local ServerStorage = game:GetService(&quot;ServerStorage&quot;)
local base64 = require(ServerStorage.Base64)
local cbor   = require(ServerStorage.Cbor)</code></pre></div>
<p>We‚Äôll talk about Base64 and CBOR in a while.</p>
<p><a href="https://education.roblox.com/en-us/resources/intro-to-module-scripts">(More about Roblox ModuleScripts)</a></p>
<h2 id="send-http-request"><a href="#send-http-request">2.3 Send HTTP Request</a></h2>
<p>Our function begins by <strong>declaring the variables</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Fetch Sensor Data from The Things Network (LoRa) as a Lua Table
local function getSensorData()
  -- HTTPS JSON Response from The Things Network
  local response = nil
  -- Lua Table parsed from JSON response
  local data = nil
  -- Message Payload from the Lua Table (encoded with Base64)
  local frmPayload = nil
  -- Message Payload after Base64 Decoding
  local payload = nil
  -- Lua Table of Sensor Data after CBOR Decoding
  local sensorData = nil</code></pre></div>
<ul>
<li>
<p><strong>response</strong>: Contains the HTTP Response (JSON format) returned by The Things Network</p>
</li>
<li>
<p><strong>data</strong>: Lua Table we get after parsing the JSON HTTP Response</p>
</li>
<li>
<p><strong>frmPayload</strong>: Encoded Sensor Data, extracted from our Parsed JSON Response</p>
</li>
<li>
<p><strong>payload</strong>: Sensor Data after Base64 Decoding</p>
</li>
<li>
<p><strong>sensorData</strong>: Sensor Data after CBOR Decoding</p>
</li>
</ul>
<p>We set the <strong>API Key</strong> in the HTTP Request Header (as ‚ÄúAuthorization‚Äù)‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- Set the API Key in the HTTP Request Header	
  local headers = {
    [&quot;Authorization&quot;] = &quot;Bearer &quot; .. TTN_API_KEY,
  }</code></pre></div>
<p>(‚Äú<code>..</code>‚Äù in Lua means concatenate the strings)</p>
<p>Then we <strong>fetch the URL</strong> (via HTTP GET), passing the API Key in the headers‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- Wrap with pcall in case something goes wrong
  pcall(function ()

    -- Fetch the data from The Things Network, no caching
    response = HttpService:GetAsync(TTN_URL, false, headers)</code></pre></div>
<p><a href="https://developer.roblox.com/en-us/api-reference/function/HttpService/GetAsync">(GetAsync is documented here)</a></p>
<p><em>What is ‚Äúpcall‚Äù?</em></p>
<p>We wrap our code with <strong>‚Äúpcall‚Äù</strong> to catch any errors returned by the HTTP Fetching. </p>
<p>(Also for catching Decoding Errors)</p>
<p>If any error occurs, execution resumes <strong>after the ‚Äúpcall‚Äù block</strong>.</p>
<p>And we‚Äôll check for errors then.</p>
<p><a href="https://developer.roblox.com/en-us/api-reference/lua-docs/Lua-Globals">(pcall is documented here)</a></p>
<p><img src="https://lupyuen.github.io/images/roblox-script2.png" alt="JSON HTTP Response decoded as Lua Table" /></p>
<h2 id="decode-http-response"><a href="#decode-http-response">2.4 Decode HTTP Response</a></h2>
<p>Now we <strong>decode the HTTP Response</strong> (JSON format) from The Things Network.</p>
<p>First we <strong>parse the JSON</strong> returned by The Things Network‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>    -- Decode the JSON response into a Lua Table
    data = HttpService:JSONDecode(response)</code></pre></div>
<p><a href="https://developer.roblox.com/en-us/api-reference/function/HttpService/JSONDecode">(JSONDecode is documented here)</a></p>
<p>This returns a <strong>Lua Table</strong> that contains the JSON Fields.</p>
<p>(See the pic above)</p>
<p>As shown in the pic, we need to <strong>extract the Encoded Sensor Data</strong> from the field: <strong>result ‚Üí uplink_message ‚Üí frm_payload</strong></p>
<div class="example-wrap"><pre class="language-lua"><code>    -- Get the Message Payload. If missing, pcall will catch the error.
    frmPayload = data.result.uplink_message.frm_payload</code></pre></div>
<p><strong>frmPayload</strong> contains the Sensor Data encoded with Base64 and CBOR.</p>
<p>(Looks like gibberish: ‚Äú<code>omF0GQTUYWwZCSs=</code>‚Äù)</p>
<p>We call the Base64 and CBOR ModuleScripts to <strong>decode the Sensor Data</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>    -- Base64 Decode the Message Payload
    payload = base64.decode(frmPayload)

    -- Decode the CBOR Map to get Sensor Data
    sensorData = cbor.decode(payload)

  -- End of pcall block
  end)</code></pre></div>
<p>(More about Base64 and CBOR in a while)</p>
<p><strong>sensorData</strong> now contains meaningful Sensor Data in a Lua Table‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>{
  [&quot;l&quot;] = 2347,
  [&quot;t&quot;] = 1236
}</code></pre></div>
<p>Above are the values recorded by our <strong>Light Sensor</strong> and <strong>Temperature Sensor</strong>, scaled up by 100 times.</p>
<p>Note that our <strong>‚Äúpcall‚Äù block</strong> ends here. So we check the errors next.</p>
<h2 id="check-errors"><a href="#check-errors">2.5 Check Errors</a></h2>
<p>We‚Äôre at the spot after the ‚Äúpcall‚Äù block.</p>
<p>We <strong>check for errors</strong> that could have occurred inside the ‚Äúpcall‚Äù block‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- Show the error
  if response == nil then
    print(&quot;Error returned by The Things Network&quot;)
  elseif data == nil then
    print(&quot;Failed to parse JSON response from The Things Network&quot;)
  elseif frmPayload == nil then
    print(&quot;Missing message payload&quot;)
  elseif payload == nil then
    print(&quot;Base64 decoding failed&quot;)
  elseif sensorData == nil then
    print(&quot;CBOR decoding failed&quot;)
  end</code></pre></div>
<p>This code checks for HTTP Request Errors and Decoding Errors.</p>
<h2 id="return-sensor-data"><a href="#return-sensor-data">2.6 Return Sensor Data</a></h2>
<p>Finally we <strong>return the Sensor Data</strong> (as a Lua Table) to the caller‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- sensorData will be nil if our request failed or JSON failed to parse
  -- or Message Payload missing or Base64 / CBOR decoding failed
  return sensorData
end</code></pre></div>
<p>Our Sensor Data is returned as <strong>nil</strong> in case of error.</p>
<p>And that‚Äôs how our Roblox Script fetches Sensor Data from The Things Network!</p>
<p><img src="https://lupyuen.github.io/images/roblox-script3.png" alt="Roblox Fetches Sensor Data" /></p>
<h1 id="roblox-mirroring-in-action"><a href="#roblox-mirroring-in-action">3 Roblox Mirroring In Action</a></h1>
<p>Before heading deeper into our Roblox Scripts, let‚Äôs watch our <strong>Virtual Gadget in action</strong>!</p>
<ol>
<li>
<p>Download and install <strong>Roblox Studio</strong>‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/roblox#appendix-install-roblox-studio"><strong>‚ÄúInstall Roblox Studio‚Äù</strong></a></p>
</li>
<li>
<p>In Roblox Studio, click <strong>New ‚Üí Classic Baseplate</strong></p>
</li>
<li>
<p>We need to enable HTTP Requests‚Ä¶</p>
<p>At the top bar, click <strong>Home ‚Üí Game Settings ‚Üí Security ‚Üí Allow HTTP Requests</strong></p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/roblox-studio.png" alt="Create Part in Roblox Studio" /></p>
<h2 id="create-part-and-script"><a href="#create-part-and-script">3.1 Create Part and Script</a></h2>
<ol>
<li>
<p>At <strong>Explorer ‚Üí Workspace</strong> (at right)‚Ä¶</p>
<p>Click <strong>(+)</strong> and create a <strong>Part</strong></p>
<p>(See pic above)</p>
</li>
<li>
<p>Under our <strong>Part</strong>‚Ä¶</p>
<p>Click <strong>(+)</strong> and create a <strong>Script</strong></p>
<p>(See pic below)</p>
</li>
<li>
<p>Copy and paste the contents of this link into the script‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua"><strong>DigitalTwin.lua</strong></a></li>
</ul>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/roblox-studio2.png" alt="Create Script in Roblox Studio" /></p>
<h2 id="edit-settings"><a href="#edit-settings">3.2 Edit Settings</a></h2>
<ol>
<li>
<p>If we have an IoT Gadget connected to The Things Network: </p>
<p>Edit these settings‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- TODO: Change this to your Application ID for The Things Network
-- (Must have permission to Read Application Traffic)
local TTN_APPLICATION_ID = &quot;YOUR_APPLICATION_ID&quot;

-- TODO: Change this to your API Key for The Things Network
local TTN_API_KEY = &quot;YOUR_API_KEY&quot;

-- TODO: Change this to your region-specific URL for The Things Network
local TTN_URL = &quot;https://au1.cloud.thethings.network/api/v3/as/applications/&quot; .. TTN_APPLICATION_ID .. &quot;/packages/storage/uplink_message?limit=1&amp;order=-received_at&quot;</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/roblox#appendix-the-things-network-settings">(More about this in the Appendix)</a></p>
</li>
<li>
<p>If we don‚Äôt have an IoT Gadget: </p>
<p>Leave the above settings as is. </p>
<p>The script will run in <strong>Demo Mode</strong>, simulating a real gadget.</p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/roblox-studio3.png" alt="Create Base64 ModuleScript in Roblox Studio" /></p>
<h2 id="create-modulescripts"><a href="#create-modulescripts">3.3 Create ModuleScripts</a></h2>
<ol>
<li>
<p>At <strong>Explorer ‚Üí ServerStorage</strong> (at right)‚Ä¶</p>
<p>Click <strong>(+)</strong> and create two <strong>ModuleScripts</strong>: </p>
<p><strong><code>Base64</code></strong> and <strong><code>Cbor</code></strong></p>
<p>(See pic above)</p>
</li>
<li>
<p>Copy and paste the the contents of these links into the ModuleScripts‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/Base64.lua"><strong><code>Base64</code></strong></a> (See pic above)</p>
</li>
<li>
<p><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/Cbor.lua"><strong><code>Cbor</code></strong></a> (See pic below)</p>
</li>
</ul>
<p>(Yep they need to be <strong>ModuleScripts</strong>. Normal Scripts won‚Äôt work)</p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/roblox-studio4.png" alt="Create Cbor ModuleScript in Roblox Studio" /></p>
<h2 id="watch-it-run"><a href="#watch-it-run">3.4 Watch It Run</a></h2>
<p>At the top bar, click <strong>Home ‚Üí Play</strong></p>
<p>(Or press <strong>F5</strong>)</p>
<p>Roblox renders our Virtual Gadget in its <strong>Hot / Cold State</strong>!</p>
<p><a href="https://www.youtube.com/watch?v=3CP7ELTAFLg"><strong>Watch the Demo Video on YouTube</strong></a></p>
<p><img src="https://lupyuen.github.io/images/roblox-title2.jpg" alt="Cold / Normal / Hot IoT Objects rendered in Roblox" /></p>
<h1 id="decode-base64-and-cbor-in-roblox"><a href="#decode-base64-and-cbor-in-roblox">4 Decode Base64 and CBOR in Roblox</a></h1>
<p><em>Why do we need CBOR Decoding?</em></p>
<p>Normally IoT Gadgets will transmit <strong>Sensor Data in JSON</strong> like so‚Ä¶.</p>
<div class="example-wrap"><pre class="language-json"><code>{ 
  &quot;t&quot;: 1236, 
  &quot;l&quot;: 2347 
}</code></pre></div>
<p>That‚Äôs <strong>19 bytes of JSON</strong> for Temperature Sensor and Light Sensor Data.</p>
<p>But this won‚Äôt fit into the <strong>Maximum Message Size</strong> for The Things Network: <strong>12 bytes</strong>.</p>
<p><a href="https://lupyuen.github.io/articles/ttn#fair-use-of-the-things-network">(Assuming 10 messages per hour)</a></p>
<p>Instead we compress the Sensor Data into <a href="https://en.wikipedia.org/wiki/CBOR"><strong>Concise Binary Object Representation (CBOR)</strong></a> Format.</p>
<p>(CBOR works like a compact, binary form of JSON)</p>
<p>And we need only <strong>11 bytes of CBOR!</strong></p>
<div class="example-wrap"><pre class="language-text"><code>a2 61 74 19 04 d4 61 6c 19 09 2b</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/cbor">(More about CBOR)</a></p>
<p><img src="https://lupyuen.github.io/images/cbor-title.jpg" alt="Encoding Sensor Data with CBOR on BL602" /></p>
<p><a href="https://lupyuen.github.io/articles/cbor">(Source)</a></p>
<p><em>What about the Base64 Decoding?</em></p>
<p>Our IoT Gadget transmits Sensor Data to The Things Network in <strong>Binary Format (CBOR)</strong>.</p>
<p>But our Roblox script fetches the Sensor Data in <strong>JSON Format</strong>, which can‚Äôt embed Binary Data.</p>
<p>Hence our Binary Data is converted to Text Format with <a href="https://en.wikipedia.org/wiki/Base64"><strong>Base64 Encoding</strong></a>, when fetched by Roblox.</p>
<p>Our Sensor Data <strong>encoded with CBOR</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>a2 61 74 19 04 d4 61 6c 19 09 2b</code></pre></div>
<p>Becomes this Text String when <strong>encoded with Base64</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>omF0GQTUYWwZCSs=</code></pre></div>
<p>This explains why we need two stages of decoding: <strong>Base64 followed by CBOR</strong>.</p>
<p><img src="https://lupyuen.github.io/images/roblox-studio3.png" alt="Create Base64 ModuleScript in Roblox Studio" /></p>
<h2 id="base64-and-cbor-modulescripts"><a href="#base64-and-cbor-modulescripts">4.1 Base64 and CBOR ModuleScripts</a></h2>
<p><em>How do we decode Base64 and CBOR in Roblox?</em></p>
<p>We call these two <strong>ModuleScripts in ServerStorage</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/Base64.lua"><strong><code>Base64</code></strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/Cbor.lua"><strong><code>Cbor</code></strong></a></p>
</li>
</ul>
<p>Like so‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Load the Base64 and CBOR ModuleScripts from ServerStorage
local ServerStorage = game:GetService(&quot;ServerStorage&quot;)
local base64 = require(ServerStorage.Base64)
local cbor   = require(ServerStorage.Cbor)

-- Base64 Decode the Message Payload
payload = base64.decode(&#39;omF0GQTUYWwZCSs=&#39;)
print(&quot;payload:&quot;)
print(payload)

-- Decode the CBOR Map
sensorData = cbor.decode(payload)
print(&quot;sensorData:&quot;)
print(sensorData)</code></pre></div>
<p><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L337-L345">(Source)</a></p>
<p>We should see‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>payload:
ÔøΩatÔøΩal

sensorData:
{
  [&quot;l&quot;] = 2347,
  [&quot;t&quot;] = 1236
}</code></pre></div>
<p><em>Did we create the ModuleScripts from scratch?</em></p>
<p>Nope, they were copied from <strong>existing Lua Libraries</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/iskolbin/lbase64/blob/master/base64.lua"><strong>iskolbin/lbase64</strong></a></p>
</li>
<li>
<p><a href="https://github.com/Zash/lua-cbor/blob/master/cbor.lua"><strong>Zash/lua-cbor</strong></a></p>
</li>
</ul>
<p><em>Was it difficult to port the Lua Libraries into Roblox?</em></p>
<p>Not at all! We changed only one line of code in <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/Base64.lua#L28-L29"><strong>Base64.lua</strong></a> from‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>local extract = _G.bit32 and _G.bit32.extract</code></pre></div>
<p>To‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>local extract = bit32 and bit32.extract</code></pre></div>
<p>And the ModuleScripts worked perfectly!</p>
<p><img src="https://lupyuen.github.io/images/roblox-script5.png" alt="Porting Lua Libraries into Roblox" /></p>
<h1 id="render-temperature-with-roblox-particle-emitter"><a href="#render-temperature-with-roblox-particle-emitter">5 Render Temperature With Roblox Particle Emitter</a></h1>
<p><em>How did we render the Temperature of our Roblox Gadget?</em></p>
<p><em>(The green fireflies thingy?)</em></p>
<p>We rendered the Temperature with a <a href="https://developer.roblox.com/en-us/articles/Particle-Emitters"><strong>Roblox Particle Emitter</strong></a>.</p>
<p>This is how we render a Particle Emitter in our Roblox Script‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Create a Particle Emitter for Normal Temperature
local emitter = createParticleEmitter()</code></pre></div>
<p><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L287-L288">(Source)</a></p>
<p>The code above renders our Roblox Gadget with <strong>Normal Temperature</strong>.</p>
<p>(Yep Shrek and his green fireflies)</p>
<p><strong>createParticleEmitter</strong> is defined in <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L79-L135">DigitalTwin.lua</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Create the Particle Emitter for Normal Temperature
-- Based on https://developer.roblox.com/en-us/api-reference/class/ParticleEmitter
local function createParticleEmitter()

  -- Create an instance of Particle Emitter and enable it
  local emitter = Instance.new(&quot;ParticleEmitter&quot;)
  emitter.Enabled = true </code></pre></div>
<p>We begin by <strong>creating an Instance</strong> of Particle Emitter.</p>
<p>Next we set the <strong>rate of particles emitted</strong> and their lifetime‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- Number of particles = Rate * Lifetime
  emitter.Rate = 20 -- Particles per second
  emitter.Lifetime = NumberRange.new(5, 10) -- How long the particles should be alive (min, max)</code></pre></div>
<p>(Why these Magic Numbers? We‚Äôll learn later)</p>
<p>We set the <strong>texture of the particles</strong> to a Star Sparkle image‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- Visual properties
  -- Texture for the particles: &quot;star sparkle particle&quot; by @Vupatu
  -- https://www.roblox.com/library/6490035152/star-sparkle-particle
  emitter.Texture = &quot;rbxassetid://6490035152&quot;</code></pre></div>
<p>(Somehow I couldn‚Äôt set the texture to ‚Äúrbxasset:textures/particles/sparkles_main.dds‚Äù. Only ‚Äúrbxassetid‚Äù works)</p>
<p>Our particles can <strong>change color</strong>, but we‚Äôll stick to green <em>(R=0.3, G=0.6, B=0.0)</em>‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- For Color, build a ColorSequence using ColorSequenceKeypoint
  local colorKeypoints = {
    -- API: ColorSequenceKeypoint.new(time, color)
    ColorSequenceKeypoint.new( 0.0, Color3.new(0.3, 0.6, 0.0)),  -- At time=0: Green
    ColorSequenceKeypoint.new( 1.0, Color3.new(0.3, 0.6, 0.0))   -- At time=1: Green
  }
  emitter.Color = ColorSequence.new(colorKeypoints)</code></pre></div>
<p>This <strong>Color Sequence</strong> says that from start <em>(time=0)</em> to end <em>(time=1)</em>, the particles stay green.</p>
<p>We won‚Äôt vary the <strong>particle transparency</strong> either‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- For Transparency, build a NumberSequence using NumberSequenceKeypoint
  local numberKeypoints = {
    -- API: NumberSequenceKeypoint.new(time, size, envelop)
    NumberSequenceKeypoint.new( 0.0, 0.0);    -- At time=0, fully opaque
    NumberSequenceKeypoint.new( 1.0, 0.0);    -- At time=1, fully opaque
  }
  emitter.Transparency = NumberSequence.new(numberKeypoints)</code></pre></div>
<p>From start to end, our particles are fully opaque.</p>
<p>We set the <strong>Light Emission and Influence</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- Light Emission and Influence
  emitter.LightEmission = 0 -- If 1: When particles overlap, multiply their color to be brighter
  emitter.LightInfluence = 1 -- If 0: Don&#39;t be affected by world lighting</code></pre></div>
<p>We define the <strong>speed and spread</strong> of our particles‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- Speed properties
  emitter.EmissionDirection = Enum.NormalId.Top -- Emit towards top
  emitter.Speed = NumberRange.new(5.0, 5.0) -- Speed
  emitter.Drag = 10.0 -- Apply drag to particle motion
  emitter.VelocityInheritance = 0 -- Don&#39;t inherit parent velocity
  emitter.Acceleration = Vector3.new(0.0, 0.0, 0.0)
  emitter.LockedToPart = false -- Don&#39;t lock the particles to the parent 
  emitter.SpreadAngle = Vector2.new(50.0, 50.0) -- Spread angle on X and Y</code></pre></div>
<p>We set the <strong>size and rotation</strong> of our particles‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- Simulation properties
  local numberKeypoints2 = {
    NumberSequenceKeypoint.new(0.0, 0.2);  -- Size at time=0
    NumberSequenceKeypoint.new(1.0, 0.2);  -- Size at time=1
  }
  emitter.Size = NumberSequence.new(numberKeypoints2)
  emitter.ZOffset = 0.0 -- Render in front or behind the actual position
  emitter.Rotation = NumberRange.new(0.0, 0.0) -- Rotation
  emitter.RotSpeed = NumberRange.new(0.0) -- Do not rotate during simulation</code></pre></div>
<p>Finally we <strong>add the emitter</strong> to our Roblox Part‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- Add the emitter to our Part
  emitter.Parent = script.Parent
  return emitter
end</code></pre></div>
<p>And our Roblox Gadget starts emitting green particles to represent Normal Temperature!</p>
<p>(Centre one in the pic below)</p>
<p><img src="https://lupyuen.github.io/images/roblox-title2.jpg" alt="Cold / Normal / Hot IoT Objects rendered in Roblox" /></p>
<h2 id="magic-numbers"><a href="#magic-numbers">5.1 Magic Numbers</a></h2>
<p><em>All the Magic Numbers above‚Ä¶ Where did they come from?</em></p>
<p>I created <strong>three Particle Emitters</strong> for the Cold, Normal and Hot Temperatures‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/roblox-studio5.png" alt="Particle Emitters for Cold / Normal / Hot Temperatures" /></p>
<p>I tweaked them till they looked OK. Then I <strong>dumped the settings</strong> of the Particle Emitters like so‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Dump the 3 Particle Emitters: Cold, Normal, Hot
print(&quot;COLD Particle Emitter (t=0)&quot;)
dumpParticleEmitter(script.Parent.Cold)

print(&quot;NORMAL Particle Emitter (t=5000)&quot;)
dumpParticleEmitter(script.Parent.Normal)

print(&quot;HOT Particle Emitter (t=10000)&quot;)
dumpParticleEmitter(script.Parent.Hot)</code></pre></div>
<p><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L347-L353">(Source)</a></p>
<p>(<strong>dumpParticleEmitter</strong> is defined in <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L243-L264">DigitalTwin.lua</a>)</p>
<p>The <strong>Particle Emitter settings</strong> look like‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code>NORMAL Particle Emitter (t=5000)
  Acceleration: 0, 0, 0
  Color: 
    0 0.3 0.6 0 0 
    1 0.3 0.6 0 0 
  Drag: 10
  ...</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/roblox#appendix-particle-emitter-settings">(See the complete settings)</a></p>
<p>These are the Magic Numbers that we plugged into our <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L79-L135"><strong>createParticleEmitter</strong></a> function.</p>
<p><em>Why did we create the Particle Emitter in Roblox Script?</em></p>
<p><em>Why not reuse the Particle Emitters that we have created manually?</em></p>
<p>That‚Äôs because we want to render <strong>10,000 Levels of Hotness / Coldness</strong>.</p>
<p>Our Roblox Script will <strong>tweak the Particle Emitter at runtime</strong> to render the Live Temperature.</p>
<p>Read on to learn how we do this with <a href="https://en.wikipedia.org/wiki/Linear_interpolation"><strong>Linear Interpolation</strong></a>.</p>
<p><img src="https://lupyuen.github.io/images/roblox-title2.jpg" alt="Cold / Normal / Hot IoT Objects rendered in Roblox" /></p>
<h2 id="interpolate-the-particle-emitter"><a href="#interpolate-the-particle-emitter">5.2 Interpolate the Particle Emitter</a></h2>
<p>Previously we have <strong>dumped the settings</strong> for our Hot / Normal / Cold Particle Emitters‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code>COLD Particle Emitter (t=0)
  Drag:  5
  Speed: 0 0 
  Color: (time, red, green, blue)
    0 0.3 1.0 1.0 
    1 0.3 1.0 1.0 
    ...

NORMAL Particle Emitter (t=5000)
  Drag:  10
  Speed: 5 5 
  Color: (time, red, green, blue)
    0 0.3 0.6 0.0 
    1 0.3 0.6 0.0 
    ...

HOT Particle Emitter (t=10000)
  Drag:  0
  Speed: 1 1 
  Color: (time, red, green, blue)
    0 1.0 0.3 0.0 
    1 1.0 0.3 0.0 
    ...</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/roblox#appendix-particle-emitter-settings">(See the complete settings)</a></p>
<p>The three emitters represent the <strong>Min / Mid / Max Temperatures</strong>‚Ä¶</p>
<ul>
<li><strong>Cold:</strong> <code>t=0</code></li>
<li><strong>Normal:</strong> <code>t=5000</code></li>
<li><strong>Hot:</strong> <code>t=10000</code></li>
</ul>
<p><em>How shall we interpolate the three emitters‚Ä¶ To render 10,000 Levels of Hotness / Coldness?</em></p>
<p>Based on the values above, we derive the following values that shall be <strong>interpolated into 10,000 levels</strong> as we transition between Cold / Normal / Hot‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code>Drag:
  COLD:   5
  NORMAL: 10
  HOT:    0

Speed: 
  COLD:   0 0 
  NORMAL: 5 5 
  HOT:    1 1 

Color: (time, red, green, blue)
  COLD:
    0 0.3 1.0 1.0 
    1 0.3 1.0 1.0 
  NORMAL:
    0 0.3 0.6 0.0 
    1 0.3 0.6 0.0 
  HOT:
    0 1.0 0.3 0.0 
    1 1.0 0.3 0.0 
    ...</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/roblox#appendix-particle-emitter-settings">(See the complete interpolation)</a></p>
<p>Let‚Äôs plug the derived values into our Roblox Script.</p>
<p><img src="https://lupyuen.github.io/images/roblox-interpolate.png" alt="Interpolating the Particle Emitter" /></p>
<h2 id="update-the-particle-emitter"><a href="#update-the-particle-emitter">5.3 Update the Particle Emitter</a></h2>
<p>We take the values derived above and plug them into our <strong>updateParticleEmitter</strong> function from <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L166-L241">DigitalTwin.lua</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Update the Particle Emitter based on the Temperature t.
-- t ranges from T_MIN (0) to T_MAX (10,000).
local function updateParticleEmitter(emitter, t)

  -- Interpolate Drag:
  -- COLD:   5
  -- NORMAL: 10
  -- HOT:    0
  emitter.Drag = lin(t, 5.0, 10.0, 0.0)

  -- Interpolate Speed: 
  -- COLD:   0 0
  -- NORMAL: 5 5
  -- HOT:    1 1
  local speed = lin(t, 0.0, 5.0, 1.0)
  emitter.Speed = NumberRange.new(speed, speed) -- Speed</code></pre></div>
<p><strong>lin</strong> is our helper function that computes <a href="https://en.wikipedia.org/wiki/Linear_interpolation"><strong>Linear Interpolation</strong></a>.</p>
<p>(More about this in the next section)</p>
<p>In the code above we <strong>interpolate the Drag and Speed</strong> of our Particle Emitter, based on the Temperature (t).</p>
<p>For the color of our Particle Emitter, we compute the <strong>interpolated color</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  -- Interpolate Color: (Red, Green, Blue)
  -- COLD:   0.3, 1.0, 1.0
  -- NORMAL: 0.3, 0.6, 0.0
  -- HOT:    1.0, 0.3, 0.0
  local color = Color3.new(
    lin(t, 0.3, 0.3, 1.0),  -- Red
    lin(t, 1.0, 0.6, 0.3),  -- Green
    lin(t, 1.0, 0.0, 0.0)   -- Blue
  )</code></pre></div>
<p>Then we update the <strong>Color Sequence</strong> based on the interpolated color‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>  local colorKeypoints = {
    -- API: ColorSequenceKeypoint.new(time, color)
    ColorSequenceKeypoint.new(0.0, color),  -- At time=0
    ColorSequenceKeypoint.new(1.0, color)   -- At time=1
  }
  emitter.Color = ColorSequence.new(colorKeypoints)</code></pre></div>
<p><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L166-L241">(See the rest of the function here)</a></p>
<p>And we‚Äôre done! To render the Live Temperature, we call <strong>updateParticleEmitter</strong> like so‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Create a Particle Emitter for Normal Temperature
local emitter = createParticleEmitter()

-- Update the emitter to render Temperature=1234
updateParticleEmitter(emitter, 1234)</code></pre></div>
<p><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L284-L323">(Source)</a></p>
<p>Here‚Äôs how our Interpolating Particle Emitter looks‚Ä¶</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=3CP7ELTAFLg"><strong>Watch the Demo Video on YouTube</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/roblox-emitter.png" alt="Updating the Particle Emitter" /></p>
<h2 id="linear-interpolation"><a href="#linear-interpolation">5.4 Linear Interpolation</a></h2>
<p><em>How does the <strong>lin</strong> function compute Linear Interpolation?</em></p>
<p>Earlier we saw this‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Interpolate Drag:
-- COLD:   5
-- NORMAL: 10
-- HOT:    0
emitter.Drag = lin(t, 5.0, 10.0, 0.0)</code></pre></div>
<p>This code <strong>interpolates the Drag</strong> of our Particle Emitter based on the Temperature (t).</p>
<p>The values passed to <strong>lin</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>5.0, 10.0, 0.0</code></pre></div>
<p>Correspond to the Drag values for <strong>Min / Mid / Max Temperatures</strong>.</p>
<p>The Min / Mid / Max Temperatures are defined here: <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L137-L164">DigitalTwin.lua</a></p>
<div class="example-wrap"><pre class="language-lua"><code>-- Minimum, Maximum and Mid values for Temperature (t) that will be interpolated
local T_MIN = 0
local T_MAX = 10000
local T_MID = (T_MIN + T_MAX) / 2</code></pre></div>
<p>We compute the <a href="https://en.wikipedia.org/wiki/Linear_interpolation"><strong>Linear Interpolation</strong></a> by drawing lines between the Min, Mid and Max values‚Ä¶</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/roblox-interpolate2.jpg" alt="Computing the Linear Interpolation" /></p>
</blockquote>
<p>Note that we compute the Linear Interpolation a little differently depending on whether the Temperature is <strong>less or greater than 5,000</strong> (T_MID)‚Ä¶</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/roblox-interpolate3.jpg" alt="Computing the Linear Interpolation" /></p>
</blockquote>
<p>Below is our <strong>lin</strong> function that handles both cases: <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L137-L164">DigitalTwin.lua</a></p>
<div class="example-wrap"><pre class="language-lua"><code>-- Linear Interpolate the value of y, given that
-- (1) x ranges from T_MIN to T_MAX
-- (2) When x=T_MIN, y=yMin
-- (3) When x=T_MID, y=yMid
-- (4) When x=T_MAX, y=yMax
local function lin(x: number, yMin: number, yMid: number, yMax: number) : number
  local y: number
  if x &lt; T_MID then
    -- Interpolate between T_MIN and T_MID
    y = yMin + (yMid - yMin) * (x - T_MIN) / (T_MID - T_MIN)
  else
    -- Interpolate between T_MID and T_MAX
    y = yMid + (yMax - yMid) * (x - T_MID) / (T_MAX - T_MID)
  end	
  -- Force y to be between yMin and yMax
  if y &lt; math.min(yMin, yMid, yMax) then
    y = math.min(yMin, yMid, yMax)
  end
  if y &gt; math.max(yMin, yMid, yMax) then
    y = math.max(yMin, yMid, yMax)
  end
  return y
end</code></pre></div>
<p><a href="https://developer.roblox.com/en-us/api-reference/class/TweenService">UPDATE: There‚Äôs another way to do Linear Interpolation in Roblox: <strong>TweenService</strong></a></p>
<p><img src="https://lupyuen.github.io/images/ttn-title.jpg" alt="PineDio Stack BL604 RISC-V Board (foreground) talking to The Things Network via RAKWireless RAK7248 LoRaWAN Gateway (background)" /></p>
<h1 id="digital-twin-demo"><a href="#digital-twin-demo">6 Digital Twin Demo</a></h1>
<p>As promised, here‚Äôs the Real-Life Demo of our <strong>Roblox Digital Twin</strong> featuring <strong>PineDio Stack</strong>! (Pic above)</p>
<ul>
<li><a href="https://youtu.be/QKjtue_tPGM"><strong>Watch the Demo Video on YouTube</strong></a></li>
</ul>
<p>We follow the instructions below to run the <strong>LoRaWAN Firmware</strong> on PineDio Stack‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/cbor#appendix-build-and-run-lorawan-firmware"><strong>‚ÄúBuild and Run LoRaWAN Firmware‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/roblox-demo.jpg" alt="Digital Twin 55.55 ‚Å∞C" /></p>
<p>Our demo setup‚Ä¶</p>
<ul>
<li>
<p><strong>At Left</strong>: Serial Terminal connected to our <a href="https://lupyuen.github.io/articles/pinedio2"><strong>PineDio Stack board</strong></a></p>
<p>(We control PineDio Stack by entering commands into the Serial Terminal)</p>
</li>
<li>
<p><strong>At Right</strong>: Roblox running our <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua"><strong>Digital Twin Script</strong></a></p>
<p>(With <strong><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/Base64.lua">Base64</a></strong> and <strong><a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/Cbor.lua">Cbor</a></strong> ModuleScripts)</p>
</li>
<li>
<p>Grey block is the <strong>Roblox Gadget</strong> that mirrors our real-world IoT Gadget (PineDio Stack)‚Ä¶</p>
<p>When <strong>PineDio Stack</strong> gets hot, the <strong>Roblox Gadget</strong> will look hot too!</p>
</li>
<li>
<p>We sync PineDio Stack (left) with Roblox Gadget (right) via <a href="https://lupyuen.github.io/articles/ttn"><strong>The Things Network</strong></a>, the public wireless IoT network</p>
</li>
<li>
<p>Through The Things Network, Roblox fetches the <strong>Live Temperature</strong> of PineDio Stack every 5 seconds.</p>
<p>(Shown at lower right: <code>5555</code>)</p>
</li>
</ul>
<p>The temperature is now <strong>55.55 ‚Å∞C</strong>. Let‚Äôs set the PineDio Stack temperature to <strong>99.99 ‚Å∞C</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>las_app_tx_cbor 2 0 9999 0</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/cbor#lorawan-with-cbor">(<strong>las_app_tx_cbor</strong> is explained here)</a></p>
<p>Our Roblox Gadget <strong>receives the high temperature</strong> and bursts into flames!</p>
<p><img src="https://lupyuen.github.io/images/roblox-demo2.jpg" alt="Digital Twin at 99.99 ‚Å∞C" /></p>
<p>Let‚Äôs turn down PineDio Stack to <strong>77.77 ‚Å∞C</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>las_app_tx_cbor 2 0 7777 0</code></pre></div>
<p>Our Roblox Gadget <strong>receives the updated temperature</strong> over The Things Network. And cools down a little.</p>
<p><img src="https://lupyuen.github.io/images/roblox-demo3.jpg" alt="Digital Twin at 77.77 ‚Å∞C" /></p>
<p>We cool PineDio Stack down to <strong>33.33 ‚Å∞C</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>las_app_tx_cbor 2 0 3333 0</code></pre></div>
<p>Our Roblox Gadget <strong>turns blue</strong>.</p>
<p><img src="https://lupyuen.github.io/images/roblox-demo4.jpg" alt="Digital Twin at 33.33 ‚Å∞C" /></p>
<p>We start to freeze PineDio Stack at <strong>11.11 ‚Å∞C</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>las_app_tx_cbor 2 0 1111 0</code></pre></div>
<p>Our Roblox Gadget <strong>turns into ice</strong>!</p>
<p><img src="https://lupyuen.github.io/images/roblox-demo5.jpg" alt="Digital Twin at 11.11 ‚Å∞C" /></p>
<h2 id="demo-code"><a href="#demo-code">6.1 Demo Code</a></h2>
<p>Below is the <strong>source code for the demo</strong> that we‚Äôve seen. It calls all the functions that we‚Äôve covered in this article: <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L284-L323">DigitalTwin.lua</a></p>
<div class="example-wrap"><pre class="language-lua"><code>-- Main Function. Fetch and render the Sensor Data from The Things Network every 5 seconds.
-- If fetch failed, show Demo Mode.
local function main()	
  -- Create a Particle Emitter for Normal Temperature
  local emitter = createParticleEmitter()
  
  -- Loop forever fetching and rendering Sensor Data from The Things Network
  while true do
    -- Lua Table that will contain Sensor Data from The Things Network	
    local sensorData = nil

    -- Temperature from The Things Network. Ranges from 0 to 10,000.
    local t = nil

    -- If API Key for The Things Network is defined...
    if TTN_API_KEY ~= &quot;YOUR_API_KEY&quot; then
      -- Fetch the Sensor Data from The Things Network
      sensorData = getSensorData()	

      -- Get the Temperature if it exists
      if sensorData then
        t = sensorData.t
      end
    end

    -- If Temperature was successfully fetched from The Things Network...
    if t then
      -- Render the Temperature with our Particle Emitter
      print(&quot;t:&quot;, t)
      updateParticleEmitter(emitter, t)
    else
      -- Else render our Particle Emitter in Demo Mode
      print(&quot;Failed to get sensor data. Enter Demo Mode.&quot;)
      demoMode(emitter)
    end
    
    -- Sleep 5 seconds so we don&#39;t overwhelm The Things Network
    wait(5)		
  end
end

-- Start the Main Function
main()</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/roblox#appendix-particle-emitter-settings">(<strong>demoMode</strong> is explained here)</a></p>
<p>That‚Äôs all for our demo today. Would be so fun if someday Roblox could overlay Real-World Objects through <strong>Augmented Reality</strong>‚Ä¶ And show us Sensor Data in real time!</p>
<p><img src="https://lupyuen.github.io/images/roblox-ar.jpg" alt="Digital Twin with Augmented Reality" /></p>
<h1 id="whats-next"><a href="#whats-next">7 What‚Äôs Next</a></h1>
<p>I‚Äôm new to Roblox, but I had fun connecting things in the real world to Roblox. I hope you enjoyed it too!</p>
<p>In the next article we shall head back to PineDio Stack coding, as we read and transmit PineDio Stack‚Äôs <strong>Internal Temperature Sensor</strong> to The Things Network.</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/tsen"><strong>‚ÄúInternal Temperature Sensor on BL602‚Äù</strong></a></li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/robloxgamedev/comments/q3utea/iot_digital_twin_with_roblox_and_the_things/">Discuss the article on Reddit</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/roblox.md"><code>lupyuen.github.io/src/roblox.md</code></a></p>
<h1 id="notes"><a href="#notes">8 Notes</a></h1>
<ol>
<li>
<p>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1443824711050301444">this Twitter Thread</a></p>
</li>
<li>
<p>Can Roblox control IoT Gadgets, like flipping the lights in our Smart Home on and off?</p>
<p>Yes this <strong>Remote Actuation</strong> is technically feasible, because The Things Network exposes a HTTP POST API for Roblox to <strong>push Downlink Messages</strong> to IoT Gadgets‚Ä¶</p>
<ul>
<li><a href="https://www.thethingsindustries.com/docs/integrations/webhooks/scheduling-downlinks/"><strong>The Things Network: Scheduling Downlinks</strong></a></li>
</ul>
<p>Our IoT Gadget would need to <strong>handle Downlink Messages</strong> and actuate accordingly. (Like switch the light on / off)</p>
</li>
<li>
<p>We may ignore these two <strong>Type Checking Warnings</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>-- Base64 Decode the Message Payload
payload = base64.decode(frmPayload)

W000: (53,27) Argument count mismatch. Function expects 3 arguments, but only 1 is specified</code></pre></div><div class="example-wrap"><pre class="language-text"><code>-- Decode the CBOR Map to get Sensor Data
sensorData = cbor.decode(payload)

W000: (56,28) Argument count mismatch. Function expects 2 arguments, but only 1 is specified</code></pre></div>
<p>That‚Äôs because the imported ModuleScripts (<strong>Base64</strong> and <strong>Cbor</strong>) don‚Äôt support Type Checking.</p>
</li>
<li>
<p>Is our Roblox Script running on the Roblox Server or Client?</p>
<p>Our script runs on the <strong>Roblox Server</strong>. So the API Key is not visible by players.</p>
<p>Does the Roblox Server run our script all the time?</p>
<p>When a player joins the game, <strong>Roblox starts a server</strong> to run our script. (Up to 50 players per server)</p>
<p>When all players leave the game, Roblox shuts down the server.</p>
</li>
<li>
<p>If we don‚Äôt wish to decode CBOR in the Roblox Script, there‚Äôs another solution: Decode CBOR in The Things Network with a <strong>Payload Formatter</strong>‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/payload"><strong>‚ÄúCBOR Payload Formatter for The Things Network‚Äù</strong></a></p>
</li>
</ol>
<h1 id="appendix-install-roblox-studio"><a href="#appendix-install-roblox-studio">9 Appendix: Install Roblox Studio</a></h1>
<p>Here are the steps to download and install <strong>Roblox Studio for macOS and Windows</strong>‚Ä¶</p>
<ol>
<li>
<p>Sign up for a free account at <a href="https://www.roblox.com/home"><strong>roblox.com</strong></a></p>
</li>
<li>
<p>Log in to <a href="https://www.roblox.com/home"><strong>roblox.com</strong></a></p>
</li>
<li>
<p>Click <strong>‚ÄúCreate‚Äù</strong> at the top bar</p>
</li>
<li>
<p>Click <strong>‚ÄúStart Creating‚Äù</strong></p>
</li>
<li>
<p>The Roblox Studio Installer will be downloaded.</p>
<p>Click the Installer to install Roblox Studio.</p>
</li>
<li>
<p><strong>For macOS:</strong> If the Installer (or upgrade) fails‚Ä¶</p>
<p>Reboot macOS.</p>
<p>Delete Roblox Studio in the <strong>Applications Folder</strong>.</p>
<p>Reinstall Roblox Studio.</p>
<p>(That‚Äôs how I fixed Roblox Studio on macOS)</p>
</li>
</ol>
<p>To install <strong>Roblox Studio on Linux</strong>, see this‚Ä¶</p>
<ul>
<li><a href="https://roblox.fandom.com/wiki/Tutorial:Using_Roblox_on_Linux"><strong>‚ÄúUsing Roblox on Linux‚Äù</strong></a></li>
</ul>
<p>If we‚Äôre in China, Roblox works a little differently. See this‚Ä¶</p>
<ul>
<li><a href="https://roblox.fandom.com/wiki/Roblox_China"><strong>‚ÄúRoblox China‚Äù</strong></a></li>
</ul>
<p><strong>Remember to log in</strong> when browsing the <a href="https://devforum.roblox.com/"><strong>Roblox Developer Forum</strong></a>.</p>
<p>This lets us <strong>‚Äúlevel up‚Äù</strong> quicker to receive posting privileges. <a href="https://devforum.roblox.com/t/how-to-level-up-on-the-roblox-developer-forum/320109">(See this)</a></p>
<p>(We need roughly 3 hours of ‚ÄúRead Time‚Äù to get posting privilege)</p>
<p><img src="https://lupyuen.github.io/images/roblox-forum.png" alt="Roblox Developer Forum" /></p>
<h1 id="appendix-particle-emitter-settings"><a href="#appendix-particle-emitter-settings">10 Appendix: Particle Emitter Settings</a></h1>
<p>During development, we created three <strong>Particle Emitters</strong>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/roblox-title2.jpg" alt="Cold / Normal / Hot Particle Emitters" /></p>
<ol>
<li>
<p><strong>Cold Particle Emitter</strong> (t=0)</p>
<div class="example-wrap"><pre class="language-yaml"><code>Acceleration: 0, 0, 0
Color: 0 0.333333 1 1 0 1 0.333333 1 1 0 
Drag: 5
EmissionDirection: Enum.NormalId.Top
Lifetime: 5 10 
LightEmission: 1
LightInfluence: 1
Orientation: Enum.ParticleOrientation.FacingCamera
Rate: 20
Rotation: 0 180 
RotSpeed: -170 -170 
Size: 0 1 0 1 1 0 
Speed: 0 0 
SpreadAngle: 10, 10
Texture: rbxasset:textures/particles/sparkles_main.dds
TimeScale: 1
Transparency: 0 0 0 1 0 0 
VelocityInheritance: 0
ZOffset: 0</code></pre></div></li>
<li>
<p><strong>Normal Particle Emitter</strong> (t=5000)</p>
<div class="example-wrap"><pre class="language-yaml"><code>Acceleration: 0, 0, 0
Color: 0 0.333333 0.666667 0 0 1 0.333333 0.666667 0 0 
Drag: 10
EmissionDirection: Enum.NormalId.Top
Lifetime: 5 10 
LightEmission: 0
LightInfluence: 1
Orientation: Enum.ParticleOrientation.FacingCamera
Rate: 20
Rotation: 0 0 
RotSpeed: 0 0 
Size: 0 0.2 0 1 0.2 0 
Speed: 5 5 
SpreadAngle: 50, 50
Texture: rbxasset:textures/particles/sparkles_main.dds
TimeScale: 1
Transparency: 0 0 0 1 0 0 
VelocityInheritance: 0
ZOffset: 0</code></pre></div></li>
<li>
<p><strong>Hot Particle Emitter</strong> (t=10000)</p>
<div class="example-wrap"><pre class="language-yaml"><code>Acceleration: 0, 0, 0
Color: 0 1 0.333333 0 0 1 1 0.333333 0 0 
Drag: 0
EmissionDirection: Enum.NormalId.Top
Lifetime: 5 10 
LightEmission: 0
LightInfluence: 0
Orientation: Enum.ParticleOrientation.FacingCamera
Rate: 20
Rotation: 0 0 
RotSpeed: 0 0 
Size: 0 0.4 0 1 0.4 0 
Speed: 1 1 
SpreadAngle: 50, 50
Texture: rbxasset:textures/particles/sparkles_main.dds
TimeScale: 1
Transparency: 0 0 0 1 0 0 
VelocityInheritance: 0
ZOffset: 0</code></pre></div></li>
</ol>
<p>(The settings were dumped with the <strong>dumpParticleEmitter</strong> function in <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L243-L264">DigitalTwin.lua</a>)</p>
<p>To render the Temperature in 10,000 levels (from t=0 to t=10000), we performed <strong>Linear Interpolation</strong> on the three Particle Emitters.</p>
<p>By matching the above settings (row by row), we derive the <strong>emitter settings that will be interpolated</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code>Color:
  COLD:
    0 0.333333 1 1 0 
    1 0.333333 1 1 0 
  NORMAL:
    0 0.333333 0.666667 0 0 
    1 0.333333 0.666667 0 0 
  HOT:
    0 1 0.333333 0 0 
    1 1 0.333333 0 0 

Drag:
  COLD:   5
  NORMAL: 10
  HOT:    0

LightEmission: 
  COLD:   1
  NORMAL: 0
  HOT:    0

LightInfluence: 
  COLD:   1
  NORMAL: 1
  HOT:    0

Rotation: 
  COLD:   0 180 
  NORMAL: 0 0 
  HOT:    0 0 

RotSpeed: 
  COLD:   -170 -170 
  NORMAL: 0    0 
  HOT:    0    0 

Size: 
  COLD:   0 1   0 1 1   0 
  NORMAL: 0 0.2 0 1 0.2 0 
  HOT:    0 0.4 0 1 0.4 0 
  
Speed: 
  COLD:   0 0 
  NORMAL: 5 5 
  HOT:    1 1 

SpreadAngle: 
  COLD:   10, 10
  NORMAL: 50, 50
  HOT:    50, 50</code></pre></div>
<p><img src="https://lupyuen.github.io/images/roblox-interpolate.png" alt="Interpolating the Particle Emitter" /></p>
<p>To create a Particle Emitter for Normal Temperature, we call <strong>createParticleEmitter</strong> in <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L79-L135">DigitalTwin.lua</a></p>
<div class="example-wrap"><pre class="language-lua"><code>-- Create a Particle Emitter for Normal Temperature
local emitter = createParticleEmitter()</code></pre></div>
<p>Then to interpolate the Particle Emitter for High / Mid / Low Temperatures, we call <strong>updateParticleEmitter</strong> in <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L166-L241">DigitalTwin.lua</a></p>
<p>(We‚Äôve seen <strong>createParticleEmitter</strong> and <strong>updateParticleEmitter</strong> earlier)</p>
<p>Here‚Äôs how our <strong>demoMode</strong> function calls <strong>updateParticleEmitter</strong> to render the Temperature in Demo Mode. (High to low, then back to high)</p>
<p>From <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L266-L282">DigitalTwin.lua</a>:</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Demo Mode if we don&#39;t have an IoT Device connected to The Things Network.
-- Gradually update our Particle Emitter for Temperature=10,000 to 0 and back to 10,000.
local function demoMode(emitter)

  -- Gradually update the emitter for Temperature=10,000 to 0
  for t = T_MAX, T_MIN, -600 do
    print(&quot;t:&quot;, t)
    updateParticleEmitter(emitter, t)
    wait(4)
  end
  
  -- Gradually update the emitter for Temperature=0 to 10,000
  for t = T_MIN, T_MAX, 600 do
    print(&quot;t:&quot;, t)
    updateParticleEmitter(emitter, t)
    wait(4)
  end
end</code></pre></div>
<p>Our <strong>Interpolating Particle Emitter</strong> in Demo Mode looks like this‚Ä¶</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=3CP7ELTAFLg"><strong>Watch the Demo Video on YouTube</strong></a></li>
</ul>
<p>Note that <strong>rbxasset</strong> won‚Äôt work for setting the Texture‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- This doesn&#39;t work
emitter.Texture = &quot;rbxasset:textures/particles/sparkles_main.dds&quot;</code></pre></div>
<p>But <strong>rbxassetid</strong> works OK‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- Texture for the particles: &quot;star sparkle particle&quot; by @Vupatu
-- https://www.roblox.com/library/6490035152/star-sparkle-particle
emitter.Texture = &quot;rbxassetid://6490035152&quot;</code></pre></div><h1 id="appendix-the-things-network-settings"><a href="#appendix-the-things-network-settings">11 Appendix: The Things Network Settings</a></h1>
<p>Earlier we saw these settings for The Things Network in <a href="https://github.com/lupyuen/roblox-the-things-network/blob/main/DigitalTwin.lua#L1-L12">DigitalTwin.lua</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- TODO: Change this to your Application ID for The Things Network
-- (Must have permission to Read Application Traffic)
local TTN_APPLICATION_ID = &quot;YOUR_APPLICATION_ID&quot;

-- TODO: Change this to your API Key for The Things Network
local TTN_API_KEY = &quot;YOUR_API_KEY&quot;

-- TODO: Change this to your region-specific URL for The Things Network
local TTN_URL = &quot;https://au1.cloud.thethings.network/api/v3/as/applications/&quot; .. TTN_APPLICATION_ID .. &quot;/packages/storage/uplink_message?limit=1&amp;order=-received_at&quot;</code></pre></div>
<p>This chapter explains the steps for getting the settings from The Things Network.</p>
<p>We assume that we have created an <strong>Application and Device</strong> in The Things Network‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/ttn#add-device-to-the-things-network"><strong>‚ÄúAdd Device to The Things Network‚Äù</strong></a></li>
</ul>
<p>To get the <strong>TTN_APPLICATION_ID</strong>‚Ä¶</p>
<ol>
<li>
<p>Log on to <a href="https://www.thethingsnetwork.org/"><strong>The Things Network</strong></a></p>
</li>
<li>
<p>Click <strong>Menu ‚Üí Console</strong></p>
<p>Select our region: <strong>Europe, North America or Australia</strong>.</p>
</li>
<li>
<p>Copy this setting‚Ä¶</p>
<p><strong>(Your Region) ‚Üí Applications ‚Üí (Your Application) ‚Üí Application ID</strong></p>
</li>
<li>
<p>Paste it here‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- TODO: Change this to your Application ID for The Things Network
-- (Must have permission to Read Application Traffic)
local TTN_APPLICATION_ID = &quot;YOUR_APPLICATION_ID&quot;</code></pre></div></li>
</ol>
<h2 id="storage-integration"><a href="#storage-integration">11.1 Storage Integration</a></h2>
<p>For Roblox to fetch Sensor Data from The Things Network, we shall enable <strong>Storage Integration</strong>‚Ä¶</p>
<ul>
<li><a href="https://www.thethingsindustries.com/docs/integrations/storage/"><strong>The Things Network: Storage Integration</strong></a></li>
</ul>
<p>When Storage Integration is enabled, The Things Network will <strong>save the Uplink Messages</strong> transmitted by our devices.</p>
<p>(Saved messages will disappear after 2 or 3 days)</p>
<p>To enable Storage Integration, click‚Ä¶</p>
<p><strong>(Your Application) ‚Üí Integrations ‚Üí Storage Integration ‚Üí Activate Storage Integration</strong></p>
<p><img src="https://lupyuen.github.io/images/roblox-ttn2.png" alt="The Things Network Storage Integration" /></p>
<p>We‚Äôll see the <strong>Region-Specific URL</strong> for retrieving data‚Ä¶</p>
<div class="example-wrap"><pre class="language-uri"><code>https://au1.cloud.thethings.network/api/v3/as/
  applications/YOUR_APPLICATION_ID/
  packages/storage/uplink_message</code></pre></div>
<p>The first part of the URL‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>au1.cloud.thethings.network</code></pre></div>
<p>Depends on the region we‚Äôre using: <strong>Europe, North America or Australia</strong>.</p>
<p>Copy the first part of the URL and paste into the first part of <strong>TTN_URL</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- TODO: Change this to your region-specific URL for The Things Network
local TTN_URL = &quot;https://au1.cloud.thethings.network/api/v3/as/applications/&quot; .. TTN_APPLICATION_ID .. &quot;/packages/storage/uplink_message?limit=1&amp;order=-received_at&quot;</code></pre></div>
<p>(‚Äú<code>..</code>‚Äù in Lua means concatenate the strings)</p>
<p>Our full URL for The Things Network (<strong>TTN_URL</strong>) looks like‚Ä¶</p>
<div class="example-wrap"><pre class="language-uri"><code>https://au1.cloud.thethings.network/api/v3/as/
  applications/YOUR_APPLICATION_ID/
  packages/storage/uplink_message
  ?limit=1&amp;order=-received_at</code></pre></div>
<p>Note that we‚Äôre fetching the <strong>Latest Uplink Message</strong> from The Things Network‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>?limit=1&amp;order=-received_at</code></pre></div>
<p>More about this in the next chapter.</p>
<h2 id="api-key"><a href="#api-key">11.2 API Key</a></h2>
<p>Roblox needs an <strong>API Key</strong> to access the stored Uplink Messages from The Things Network.</p>
<p>To create an API Key, click‚Ä¶</p>
<p><strong>(Your Application) ‚Üí API Keys ‚Üí Add API Key</strong></p>
<p><img src="https://lupyuen.github.io/images/roblox-ttn3.png" alt="The Things Network API Key" /></p>
<p>Click <strong>‚ÄúGrant Individual Rights‚Äù</strong></p>
<p>Click <strong>‚ÄúRead application traffic (uplink and downlink)‚Äù</strong></p>
<p>Click <strong>‚ÄúCreate API Key‚Äù</strong></p>
<p>Copy the API Key and paste here‚Ä¶</p>
<div class="example-wrap"><pre class="language-lua"><code>-- TODO: Change this to your API Key for The Things Network
local TTN_API_KEY = &quot;YOUR_API_KEY&quot;</code></pre></div><h2 id="security"><a href="#security">11.3 Security</a></h2>
<p>If we publish our game for the public to join, players may see these (potentially sensitive) details in <strong>Roblox‚Äôs Server-Side Network Log</strong>‚Ä¶</p>
<ul>
<li>Application ID</li>
<li>Device EUI</li>
<li>Gateway EUI</li>
<li>Gateway Latitude / Longitude (which may reveal the location of our device)</li>
</ul>
<p>(API Key is not visible fortunately)</p>
<p>So be careful when publishing our game for public access.</p>
<p><img src="https://lupyuen.github.io/images/roblox-log.jpg" alt="Roblox‚Äôs Server-Side Network Log" /></p>
<h1 id="appendix-fetch-sensor-data-from-the-things-network"><a href="#appendix-fetch-sensor-data-from-the-things-network">12 Appendix: Fetch Sensor Data from The Things Network</a></h1>
<p>The Things Network exposes a HTTP GET API to <strong>fetch the Uplink Messages</strong> transmitted by our IoT Device‚Ä¶</p>
<ul>
<li><a href="https://www.thethingsindustries.com/docs/integrations/storage/retrieve/"><strong>‚ÄúRetrieve Uplink Messages‚Äù</strong></a></li>
</ul>
<p>(Assuming that Storage Integration is enabled. Saved messages will disappear after 2 or 3 days)</p>
<p>Here‚Äôs the command to fetch the latest Uplink Message‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>curl \
  -G &quot;https://au1.cloud.thethings.network/api/v3/as/applications/$YOUR_APPLICATION_ID/packages/storage/uplink_message&quot; \
  -H &quot;Authorization: Bearer $YOUR_API_KEY&quot; \
  -H &quot;Accept: text/event-stream&quot; \
  -d &quot;limit=1&quot; \
  -d &quot;order=-received_at&quot;</code></pre></div>
<p>(See the previous chapter for <strong>$YOUR_APPLICATION_ID</strong> and <strong>$YOUR_API_KEY</strong>. The first part of the URL is specific to our region: ‚Äúau1.cloud.thethings.network‚Äù)</p>
<p>Which returns‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{
  &quot;result&quot;: {
    &quot;end_device_ids&quot;: {
      &quot;device_id&quot;: &quot;eui-YOUR_DEVICE_EUI&quot;,
      &quot;application_ids&quot;: {
        &quot;application_id&quot;: &quot;luppy-application&quot;
      },
      &quot;dev_eui&quot;: &quot;YOUR_DEVICE_EUI&quot;,
      &quot;dev_addr&quot;: &quot;YOUR_DEVICE_ADDR&quot;
    },
    &quot;received_at&quot;: &quot;2021-10-02T12:10:54.594006440Z&quot;,
    &quot;uplink_message&quot;: {
      &quot;f_port&quot;: 2,
      &quot;f_cnt&quot;: 3,
      &quot;frm_payload&quot;: &quot;omF0GQTUYWwZCSs=&quot;,
      &quot;rx_metadata&quot;: [
        {
          &quot;gateway_ids&quot;: {
            &quot;gateway_id&quot;: &quot;luppy-wisgate-rak7248&quot;,
            &quot;eui&quot;: &quot;YOUR_GATEWAY_EUI&quot;
          },
          &quot;time&quot;: &quot;2021-10-02T13:04:34.552513Z&quot;,
          &quot;timestamp&quot;: 3576406949,
          &quot;rssi&quot;: -53,
          &quot;channel_rssi&quot;: -53,
          &quot;snr&quot;: 12.2,
          &quot;location&quot;: {
            &quot;latitude&quot;: 1.27125,
            &quot;longitude&quot;: 103.80795,
            &quot;altitude&quot;: 70,
            &quot;source&quot;: &quot;SOURCE_REGISTRY&quot;
          },
          &quot;channel_index&quot;: 4
        }
      ],
      &quot;settings&quot;: {
        &quot;data_rate&quot;: {
          &quot;lora&quot;: {
            &quot;bandwidth&quot;: 125000,
            &quot;spreading_factor&quot;: 10
          }
        },
        &quot;data_rate_index&quot;: 2,
        &quot;coding_rate&quot;: &quot;4/5&quot;,
        &quot;frequency&quot;: &quot;922600000&quot;,
        &quot;timestamp&quot;: 3576406949,
        &quot;time&quot;: &quot;2021-10-02T13:04:34.552513Z&quot;
      },
      &quot;received_at&quot;: &quot;2021-10-02T12:10:54.385972437Z&quot;,
      &quot;consumed_airtime&quot;: &quot;0.370688s&quot;,
      &quot;network_ids&quot;: {
        &quot;net_id&quot;: &quot;000013&quot;,
        &quot;tenant_id&quot;: &quot;ttn&quot;,
        &quot;cluster_id&quot;: &quot;ttn-au1&quot;
      }
    }
  }
}</code></pre></div>
<p><strong>result.uplink_message.frm_payload</strong> contains the Sensor Data that we need, encoded with Base64 and CBOR‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>&quot;frm_payload&quot;: &quot;omF0GQTUYWwZCSs=&quot;</code></pre></div>
<p>Our Sensor Data is encoded with <a href="https://en.wikipedia.org/wiki/CBOR"><strong>Concise Binary Object Representation (CBOR)</strong></a> to keep the LoRa Packets small (max 12 bytes), due to the Fair Use Policy of The Things Network‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/ttn#fair-use-of-the-things-network"><strong>‚ÄúFair Use of The Things Network‚Äù</strong></a></li>
</ul>
<p>More about CBOR Encoding‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/cbor"><strong>‚ÄúEncode Sensor Data with CBOR on BL602‚Äù</strong></a></li>
</ul>

    
</body>
</html>