<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Early Days of Rust Apps on Apache NuttX RTOS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Early Days of Rust Apps on Apache NuttX RTOS" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/rust6-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.codeberg.page/articles/rust6.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Early Days of Rust Apps on Apache NuttX RTOS</h1>
    <nav id="TOC"><ul>
<li><a href="#todo">1 TODO</a><ul></ul></li>
<li><a href="#whats-next">2 What’s Next</a><ul></ul></li></ul></nav><p>📝 <em>19 Aug 2024</em></p>
<p><img src="https://lupyuen.github.io/images/rust6-title.jpg" alt="TODO" /></p>
<p>TODO</p>
<p>My student Rushabh Gala has successfully completed </p>
<p>Final Report</p>
<p>Midterm Report</p>
<p>NuttX Workshop Presentation </p>
<p>In this article we look at the challenges and (partial) solutions </p>
<p>We have fixed the Rust Target for QEMU 64-bit RISC-V…</p>
<ul>
<li>
<p><a href="https://github.com/apache/nuttx/pull/12854"><strong>“Fix the Rust and D Builds for QEMU RISC-V”</strong></a></p>
</li>
<li>
<p><a href="https://github.com/apache/nuttx/pull/12858"><strong>“Add Rust Target for QEMU RISC-V 64-bit”</strong></a></p>
</li>
<li>
<p><a href="https://github.com/apache/nuttx/pull/12862"><strong>“Add Build Config for leds64_rust”</strong></a></p>
</li>
</ul>
<ol>
<li>
<p>Super interesting new development: Some folks in the NuttX Community are working with the Rust Project, adding NuttX as an official platform for Rust Standard Library! <a href="https://lists.apache.org/thread/oqx7p3vb4dcgko4mm2f0vqgqnkorn49p">(See this)</a></p>
<p>This might take some time to complete, because supporting NuttX in the Rust Standard Library will require lots of coding and testing. So our Project Report is still relevant, it will be the “Interim Way” to build Rust Apps for NuttX. And we have to demonstrate how Rust Apps can be built and tested with Rust Core Library, without <code>cargo</code>. (Exactly what we’re doing now)</p>
</li>
<li>
<p><strong>[Updated 11 Aug]</strong> “What’s left to do”: Here are the outstanding items for the project, which I have just completed. We fixed the Rust Build for QEMU 64-bit RISC-V, and added it to the NuttX Continuous Integration (at GitHub Actions)…</p>
<ul>
<li>
<p><a href="https://github.com/apache/nuttx/pull/12854"><strong>“Fix the Rust and D Builds for QEMU RISC-V”</strong></a></p>
</li>
<li>
<p><a href="https://github.com/apache/nuttx/pull/12858"><strong>“Add Rust Target for QEMU RISC-V 64-bit”</strong></a></p>
</li>
<li>
<p><a href="https://github.com/apache/nuttx/pull/12862"><strong>“Add Build Config for leds64_rust”</strong></a></p>
</li>
</ul>
</li>
<li>
<p><strong>[Updated 12 Aug]</strong> We’re now building and testing <code>leds_rust</code> every daily at GitHub Actions. We will be notified if the Rust Build breaks or if the Rust Execution fails in future.</p>
<p><a href="https://github.com/lupyuen/nuttx-riscv64/actions/workflows/qemu-riscv-leds64-rust.yml">Test Log</a></p>
<p><a href="https://github.com/lupyuen/nuttx-riscv64/blob/main/.github/workflows/qemu-riscv-leds64-rust.yml">GitHub Actions Workflow</a></p>
</li>
</ol>
<h1 id="todo"><a class="doc-anchor" href="#todo">§</a>1 TODO</h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/nuttx-rust-app/blob/main/app/src/main.rs">app/src/main.rs</a></p>
<p><a href="https://github.com/apache/nuttx-apps/blob/master/examples/leds_rust/leds_rust_main.rs">examples/leds_rust/leds_rust_main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// Comment out these lines for testing with Rust Standard Library 
// #![no_main]
// #![no_std]

</span><span class="kw">mod </span>nuttx;

<span class="attr">#[cfg(target_os = <span class="string">"none"</span>)]
</span><span class="kw">use </span>core::{
  panic::PanicInfo,
  result::Result::{<span class="self">self</span>, <span class="prelude-val">Err</span>, <span class="prelude-val">Ok</span>},
};
<span class="kw">use </span>nuttx::<span class="kw-2">*</span>;

<span class="comment">// Panic Handler (needed for [no_std] compilation)
</span><span class="attr">#[cfg(target_os = <span class="string">"none"</span>)]  </span><span class="comment">// For NuttX
</span><span class="attr">#[panic_handler]
</span><span class="kw">fn </span>panic(_panic: <span class="kw-2">&amp;</span>PanicInfo&lt;<span class="lifetime">'_</span>&gt;) -&gt; ! {
  <span class="kw">loop </span>{}
}

<span class="kw">fn </span>rust_main(_argc: i32, _argv: <span class="kw-2">*const *const </span>u8) -&gt; <span class="prelude-ty">Result</span>&lt;i32, i32&gt; {
  safe_puts(<span class="string">"Hello, Rust!!"</span>);

  safe_puts(<span class="string">"Opening /dev/userleds"</span>);
  <span class="kw">let </span>fd = safe_open(<span class="string">"/dev/userleds"</span>, O_WRONLY)<span class="question-mark">?</span>;
  safe_puts(<span class="string">"Set LED 1 to 1"</span>);

  safe_ioctl(fd, ULEDIOC_SETALL, <span class="number">1</span>)<span class="question-mark">?</span>;
  safe_puts(<span class="string">"Sleeping..."</span>);
  <span class="kw">unsafe </span>{
    usleep(<span class="number">500_000</span>);
  }

  safe_puts(<span class="string">"Set LED 1 to 0"</span>);
  safe_ioctl(fd, ULEDIOC_SETALL, <span class="number">0</span>)<span class="question-mark">?</span>;
  <span class="kw">unsafe </span>{
    close(fd);
  }
  <span class="prelude-val">Ok</span>(<span class="number">0</span>)
}

<span class="attr">#[no_mangle]
</span><span class="kw">pub extern </span><span class="string">"C" </span><span class="kw">fn </span>leds_rust_main(_argc: i32, _argv: <span class="kw-2">*const *const </span>u8) -&gt; i32 {
  <span class="comment">// Call the program logic in Rust Main
  </span><span class="kw">let </span>res = rust_main(<span class="number">0</span>, core::ptr::null());

  <span class="comment">// If Rust Main returns an error, print it
  </span><span class="kw">if let </span><span class="prelude-val">Err</span>(e) = res {
    <span class="kw">unsafe </span>{
      printf(
        <span class="string">b"ERROR: rust_main() failed with error %d\n\0" </span><span class="kw">as </span><span class="kw-2">*const </span>u8,
        e,
      );
    }
    e
  } <span class="kw">else </span>{
    <span class="number">0
  </span>}
}

<span class="comment">// For Testing Locally
</span><span class="attr">#[cfg(not(target_os = <span class="string">"none"</span>))]
</span><span class="kw">fn </span>main() {
  leds_rust_main(<span class="number">0</span>, core::ptr::null());
}</code></pre></div>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">§</a>2 What’s Next</h1>
<p>TODO</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> (and the awesome NuttX Community) for supporting my work! This article wouldn’t have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-sg2000"><strong>My Current Project: “Apache NuttX RTOS for Sophgo SG2000”</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-ox64"><strong>My Other Project: “NuttX for Ox64 BL808”</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-star64"><strong>Older Project: “NuttX for Star64 JH7110”</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>Olderer Project: “NuttX for PinePhone”</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here…</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/rust6.md"><strong>lupyuen.github.io/src/rust6.md</strong></a></p>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>