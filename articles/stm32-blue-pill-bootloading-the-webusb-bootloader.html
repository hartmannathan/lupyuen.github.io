<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="/_static/css/banner-styles.css?v=bsmaklHF" />
  <link rel="stylesheet" type="text/css" href="/_static/css/iconochive.css?v=qtvMKcIJ" />
  <link rel="canonical" href="https://lupyuen.org/articles/stm32-blue-pill-bootloading-the-webusb-bootloader.html" />
  <!-- End Wayback Rewrite JS Include -->
  <title data-rh="true">STM32 Blue Pill — Bootloading the WebUSB Bootloader</title>
  <meta data-rh="true" charset="utf-8" />
  <meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
  <meta data-rh="true" name="theme-color" content="#000000" />
  <meta data-rh="true" property="og:type" content="article" />
  <meta data-rh="true" property="article:published_time" content="2019-02-25T08:09:17.176Z" />
  <meta data-rh="true" name="title" content="STM32 Blue Pill — Bootloading the WebUSB Bootloader" />
  <meta data-rh="true" property="og:title" content="STM32 Blue Pill — Bootloading the WebUSB Bootloader" />
  <meta data-rh="true" property="twitter:title" content="STM32 Blue Pill — Bootloading the WebUSB Bootloader" />
  <meta data-rh="true" name="description"
    content="How does the WebUSB Bootloader upgrade itself? With a special Baseloader" />
  <meta data-rh="true" property="og:description"
    content="How does the WebUSB Bootloader upgrade itself? With a special Baseloader" />
  <meta data-rh="true" property="twitter:description"
    content="How does the WebUSB Bootloader upgrade itself? With a special Baseloader" />
  <meta data-rh="true" name="twitter:card" content="summary_large_image" />
  <meta data-rh="true" name="twitter:creator" content="@MisterTechBlog" />
  <meta data-rh="true" name="author" content="Lup Yuen Lee 李立源" />
  <meta data-rh="true" name="robots" content="index,follow" />
  <meta data-rh="true" name="referrer" content="unsafe-url" />
  <meta data-rh="true" name="twitter:label1" value="Reading time" />
  <meta data-rh="true" name="twitter:data1" value="9 min read" />
  <meta property="og:image" 
  content="https://lupyuen.github.io/images/legacy2/j1.gif">

<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">

<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->

</head>

<body>
  <div id="root">
    <div class="a b c">
      <article>
        <section class="cj ck cl cm ak cn ce n co"></section><span class="r"></span>
        <div>
          <div class="cp u cq cr cs ct"></div>
          <section class="cu cv cw cx cy">
            <div class="cz ak">
              <div class="figure da cz ak paragraph-image">

                
                <p><img src="https://lupyuen.github.io/images/legacy2/j1.gif" /></p>


              
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <div>
                  <div id="a008" class="dq dr ds bk dt b du dv dw dx dy dz ea">
                    <h1 class="dt b du eb ds">STM32 Blue Pill — Bootloading the WebUSB Bootloader</h1>
                  </div>
                  <div class="ec">
                    <div class="n ed ee ef eg">
                      <div class="o n">
                        <div><a rel="noopener"
                            href="https://lupyuen.github.io">
                            <div class="di eh ei">
                              <div class="bs n ej o p cp ek el em en eo ct"></div>
                              
                            </div>
                          </a></div>
                        <div class="eq ak r">
                          <div class="n">
                            <div style="flex:1"><span class="bj b bk bl bm bn r ds q">
                                <div class="er n o es"><span class="bj et eu bl de ev ew ex ey ez ds"><a
                                      class="at au av aw ax ay az ba bb bc fa bf bg bh bi" rel="noopener"
                                      href="https://lupyuen.github.io">Lup
                                      Yuen Lee 李立源</a></span>
                               
                                </div>
                              </span></div>
                          </div><span class="bj b bk bl bm bn r bo bp"><span class="bj et eu bl de ev ew ex ey ez bo">
                              <div><a class="at au av aw ax ay az ba bb bc fa bf bg bh bi" rel="noopener"
                                  href="https://lupyuen.github.io/articles/stm32-blue-pill-bootloading-the-webusb-bootloader">
                                  25 Feb 2019</a> <!-- -->·
                                <!-- -->
                                <!-- -->9
                                <!-- --> min read
                              </div>
                            </span></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <blockquote class="fz ga gb">
                  <p id="a396" class="gc gd ds ge gf b gg gh gi gj gk gl gm gn go gp gq">The year is 2029. At <a
                      class="at cg gr gs gt gu" target="_blank" rel="noopener"
                      href="https://lupyuen.github.io/articles/stm32-blue-pill-unit-testing-with-qemu-blue-pill-emulator">Moon
                      Base One</a>, two Moon Base Operators nearly wiped out their entire crop of beautiful red
                    tomatoes… All because of a firmware bug in their IoT monitoring device that slipped past <a
                      class="at cg gr gs gt gu" target="_blank" rel="noopener"
                      href="https://lupyuen.github.io/articles/stm32-blue-pill-unit-testing-with-qemu-blue-pill-emulator">Embedded
                      Unit Testing</a>.</p>
                  <p id="cbc9" class="gc gd ds ge gf b gg gh gi gj gk gl gm gn go gp gq">Operator 1: Are we all set to
                    flash our STM32-BLUEST-PILL monitoring devices with the new firmware? The one that passed Embedded
                    Unit Testing?</p>
                  <p id="bf3c" class="gc gd ds ge gf b gg gh gi gj gk gl gm gn go gp gq">Operator 2: Yes! Lemme launch
                    <a class="at cg gr gs gt gu" target="_blank" rel="noopener"
                      href="https://lupyuen.github.io/articles/stm32-blue-pill-dissecting-the-webusb-bootloader-for-makecode"><strong
                        class="gf gv">MakeCode</strong></a><strong class="gf gv"> version 2029</strong>… Hitting the
                    DOWNLOAD button… Now regenerating the new <a
                      href="https://github.com/Microsoft/uf2"
                      class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">UF2 firmware image</a>…
                    Transmitting firmware image to all <a class="at cg gr gs gt gu" target="_blank" rel="noopener"
                      href="https://lupyuen.github.io/articles/stm32-blue-pill-dissecting-the-webusb-bootloader-for-makecode">STM32-BLUEST-PILL
                      Bootloaders</a>… And <strong class="gf gv">Firmware version 2029</strong> has been flashed to all
                    1,000 devices! Wait we got 1,000 errors… “<strong class="gf gv">Critical system library </strong><a
                      href="https://github.com/libopencm3/libopencm3/wiki"
                      class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow"><strong
                        class="gf gv">libopencm3</strong></a><strong class="gf gv"> version 2029 not found</strong>”…
                  </p>
                  <p id="9d62" class="gc gd ds ge gf b gg gh gi gj gk gl gm gn go gp gq">Operator 1: WHAT’S HAPPENING TO
                    OUR SENSORS ??? OUR IOT DASHBOARDS ALL TURNED BLANK !!! We’re running <strong
                      class="gf gv">Bootloader version 2028</strong>, which contains <strong class="gf gv">libopencm3
                      version 2028! </strong>We don’t use version 2029 here!</p>
                  <p id="bded" class="gc gd ds ge gf b gg gh gi gj gk gl gm gn go gp gq">Operator 2: So we just upgrade
                    the Bootloader to version 2029. Piece of cake right? Oh wait… There’s no button for MakeCode
                    Bootloader Upgrade. <strong class="gf gv">We haven’t implemented the Bootloader Upgrade
                      yet.</strong> How often do we upgrade the Bootloader right? Heh heh…</p>
                  <p id="0451" class="gc gd ds ge gf b gg gh gi gj gk gl gm gn go gp gq">Operator 1: The sprinklers have
                    stopped !!! Our juicy tomatoes are drying up and turning into… SUN-DRIED TOMATOES !!! NOOOOOOO…</p>
                </blockquote>
              </div>
            </div>
          </section>
          <hr class="gw et gx gy gz ha hb hc hd he hf" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <p id="943f" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">With a Bootloader installed,
                  programming the <a
                    href="http://wiki.stm32duino.com/index.php?title=Blue_Pill"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">STM32 Blue Pill</a> via USB gets a
                  lot simpler and faster… <a
                    href="https://youtu.be/DSNDvrVOJns"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">A single click</a> is all it takes
                  to flash the Blue Pill!</p>
                <p id="1352" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq"><a class="at cg gr gs gt gu"
                    target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-dissecting-the-webusb-bootloader-for-makecode">In
                    the previous article</a> we learned how our <a
                    href="https://makecode.com/about"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">MakeCode</a> Bootloader flashed
                  Applications to Blue Pill via <a
                    href="https://developers.google.com/web/updates/2016/03/access-usb-devices-on-the-web"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">WebUSB</a>. The chronicles of <em
                    class="ge">Moon Base One</em> have taught us that we need a way to upgrade the Bootloader as well.
                </p>
                <p id="632b" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">But how do we upgrade the
                  Bootloader when it’s <em class="ge">always running in the background, waiting for flashing
                    requests</em>? This article explains a special technique I used to upgrade the MakeCode Bootloader
                  over WebUSB… I call it “<strong class="gf gv">Baseloading</strong>”. We’ll learn…</p>
                <ol class="">
                  <li id="06d7" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq hg hh hi">How to <strong
                      class="gf gv">write to Blue Pill’s flash memory</strong> without calling any libraries</li>
                  <li id="c7eb" class="gc gd ds bk gf b gg hj gi hk gk hl gm hm go hn gq hg hh hi">How we used this
                    method of flashing to <strong class="gf gv">update the Bootloader</strong> code</li>
                  <li id="2ef3" class="gc gd ds bk gf b gg hj gi hk gk hl gm hm go hn gq hg hh hi">How to use <strong
                      class="gf gv">Backup Registers</strong> to remember the state of the Blue Pill after restarting
                  </li>
                </ol>
              </div>
            </div>
          </section>
          <hr class="gw et gx gy gz ha hb hc hd he hf" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <h1 id="d5da" class="ho hp ds bk bj hq hr hs ht hu hv hw hx hy hz ia ib">Flashing with Zero Dependencies
                </h1>
                <p id="f42e" class="gc gd ds bk gf b gg ic gi id gk ie gm if go ig gq">Take a look at <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/baseloader/baseloader.c#L256-L362"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">this code that we use for flashing
                    the Blue Pill WebUSB Bootloader</a>…</p>
                <div class="figure ii ij ik il im cz cl cm paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/j2.png" /></p>
  
  
             
                  <figcaption><p><em>Baseloader code for flashing the Bootloader.
                    From <a
                      href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/baseloader/baseloader.c#L256-L362"
                      class="at cg gr gs gt gu" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/baseloader/baseloader.c#L256-L362</a>
                  </em></p></figcaption>
                </div>
                <p id="48f9" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">Looks like typical Blue Pill
                  code… <code class="dj iv iw ix iy b">baseloader_start()</code> calls some functions to <strong
                    class="gf gv">lock, unlock, erase and update</strong> Blue Pill’s flash memory. Now look at the <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/logs/firmware.dump#L875-L1650"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">Arm Cortex-M3 assembly code</a>
                  that the C compiler generated for <code class="dj iv iw ix iy b">baseloader_start()</code>…</p>
                <div class="figure ii ij ik il im cz cl cm paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/j3.png" /></p>
  
  
             
                  <figcaption><p><em>Compiled Baseloader code. From <a
                      href="https://github.com/lupyuen/codal-libopencm3/blob/master/logs/firmware.dump#L875-L1650"
                      class="at cg gr gs gt gu" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/codal-libopencm3/blob/master/logs/firmware.dump#L875-L1650</a>
                  </em></p></figcaption>
                </div>
                <p id="b3d7" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">Do you see the magic here?
                  <strong class="gf gv">There are no calls to other functions!</strong> It’s as though all the <strong
                    class="gf gv">lock / unlock / erase / update</strong> functions are done within this <code
                    class="dj iv iw ix iy b">baseloader_start()</code> function… <code
                    class="dj iv iw ix iy b">baseloader_start()</code> has <strong class="gf gv">Zero
                    Dependencies</strong>!</p>
                <p id="76bb" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">How is that possible? That’s
                  because Blue Pill uses <a
                    href="https://en.wikipedia.org/wiki/Memory-mapped_I/O"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow"><strong
                      class="gf gv">Memory-Mapped I/O</strong></a>. By reading/writing some special memory location, we
                  can control the Blue Pill peripherals, including the flash memory. The <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/baseloader/baseloader.c#L67-L212"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">lock / unlock / erase / update
                    functions above are actually C macros</a> that read/write the special memory addresses that control
                  the Blue Pill flash memory.</p>
                <p id="5f8e" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">Also note that <code
                    class="dj iv iw ix iy b">baseloader_start()</code> uses <a
                    href="https://en.wikipedia.org/wiki/Addressing_mode#PC-relative_2"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow"><strong class="gf gv">Relative
                      Addresses</strong></a> (instead of Absolute Addresses) when branching conditionally to other parts
                  of the function. Just look at the above <a
                    href="https://www.st.com/content/ccc/resource/technical/document/programming_manual/5b/ca/8d/83/56/7f/40/08/CD00228163.pdf/files/CD00228163.pdf/jcr:content/translations/en.CD00228163.pdf"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">branch instructions</a> like <code
                    class="dj iv iw ix iy b">bls.n, b.n, bcs.n</code>.</p>
                <p id="afed" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">Zero Dependencies + Relative
                  Addressing… That means the code is perfect for <strong class="gf gv">Relocation</strong> anywhere in
                  Blue Pill memory! <em class="ge">We can copy the </em><code
                    class="dj iv iw ix iy b"><em class="ge">baseloader_start()</em></code><em class="ge"> function into
                    any chunk of Blue Pill memory and it will still work!</em> Assuming of course we don’t mess around
                  with the global variables accessed by <code class="dj iv iw ix iy b">baseloader_start()</code>.</p>
                <p id="ef7d" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">That’s the key reason why our
                  Bootloader code is able to update itself… It’s able to <em class="ge">clone itself into a new chunk of
                    ROM memory AND execute the cloned copy of Bootloader to update the old ROM copy of Bootloader</em>!
                </p>
                <p id="6b1f" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">From now on we’ll call this “<em
                    class="ge">code that updates the Bootloader</em>” as the <strong class="gf gv">Baseloader</strong>.
                </p>
                <p id="f437" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">Now if the Baseloader can’t fetch
                  the new Bootloader code from the USB port (remember that the Baseloader only uses flash memory),<em
                    class="ge"> how can the Baseloader update the Bootloader?</em></p>
                <p id="59c0" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">By carefully juggling flash
                  memory, as we shall soon see…</p>
              </div>
            </div>
          </section>
          <hr class="gw et gx gy gz ha hb hc hd he hf" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <h1 id="d708" class="ho hp ds bk bj hq hr hs ht hu hv hw hx hy hz ia ib">Upgrading the Bootloader, step
                  by step</h1>
                <p id="d352" class="gc gd ds bk gf b gg ic gi id gk ie gm if go ig gq">How does our Blue Pill WebUSB
                  Bootloader upgrade its own code? Let’s watch how it’s done with the <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/baseloader/baseloader.c"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">Baseloader</a>…</p>
              </div>
            </div>
            <div class="cz ak">
              <div class="figure ii ij ik il im cz ak paragraph-image">
                
                <p><img src="https://lupyuen.github.io/images/legacy2/j4.gif" /></p>


           
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <p id="8bc4" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">1️⃣ We have partitioned Blue
                  Pill’s ROM with this layout: <a class="at cg gr gs gt gu" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-dissecting-the-webusb-bootloader-for-makecode"><strong
                      class="gf gv">Bootloader in the lower ROM region, Application in the upper ROM region</strong></a>
                </p>
              </div>
            </div>
            <div class="cz ak">
              <div class="figure ii ij ik il im cz ak paragraph-image">
                
                <p><img src="https://lupyuen.github.io/images/legacy2/j5.gif" /></p>


             
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <p id="6931" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">2️⃣ When we click <code
                    class="dj iv iw ix iy b">Download</code> to update the Blue Pill, the MakeCode Website <a
                    href="https://github.com/lupyuen/pxt/tree/master/pxtcompiler/emitter"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">generates a Blue Pill firmware
                    image</a> with the <strong class="gf gv">same ROM layout</strong></p>
                <p id="e30f" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">3️⃣ MakeCode Website <a
                    href="https://github.com/lupyuen/pxt/blob/master/pxtlib/hf2.ts#L454-L495"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">transfers the firmware image in
                    chunks</a> to Blue Pill via the <a
                    href="https://github.com/lupyuen/pxt/blob/master/pxtlib/hf2.ts#L57-L123"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">USB HF2 protocol</a>, from low to
                  high address (<strong class="gf gv">Bootloader followed by Application</strong>)</p>
              </div>
            </div>
            <div class="cz ak">
              <div class="figure ii ij ik il im cz ak paragraph-image">
                
                <p><img src="https://lupyuen.github.io/images/legacy2/j6.gif" /></p>


            
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <p id="ed3b" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">4️⃣ Blue Pill Bootloader receives
                  <strong class="gf gv">the new Bootloader code</strong> and <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/hf2.c#L267-L294"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">writes temporarily into the
                    <strong class="gf gv">old Application region</strong></a></p>
              </div>
            </div>
            <div class="cz ak">
              <div class="figure ii ij ik il im cz ak paragraph-image">
                
                <p><img src="https://lupyuen.github.io/images/legacy2/j7.gif" /></p>


           
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <p id="8de9" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">5️⃣ Bootloader <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/hf2.c#L304-L314"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">compares the old and new
                    Bootloader code</a>. Assuming that the code has changed, the Bootloader <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/hf2.c#L316-L332"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow"><strong class="gf gv">clones the
                      Baseloader code</strong></a> (inside the Bootloader) into the next available ROM space. Bootloader
                  reboots the Blue Pill and <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/bootloader.c#L72-L155"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow"><strong class="gf gv">starts the
                      Baseloader</strong></a>.</p>
              </div>
            </div>
            <div class="cz ak">
              <div class="figure ii ij ik il im cz ak paragraph-image">
                
                <p><img src="https://lupyuen.github.io/images/legacy2/j8.gif" /></p>


              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <p id="ac78" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">6️⃣ Baseloader <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/baseloader/baseloader.c#L314-L345"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow"><strong class="gf gv">moves the
                      new Bootloader code into the Bootloader ROM region</strong></a>, overwriting the old Bootloader.
                  The Bootloader is not running now, so it’s safe to overwrite.</p>
                <p id="1a4e" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">7️⃣ The Baseloader code is
                  <strong class="gf gv">Relocatable</strong>, so it may be <strong class="gf gv">executed anywhere in
                    ROM</strong>. That’s why the Baseloader can run outside the Bootloader ROM region. Unlike the
                  Bootloader, which may only be executed at a fixed address in the Bootloader ROM region (<code
                    class="dj iv iw ix iy b">0x0800 0000</code>).</p>
                <p id="66ae" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">8️⃣ The Baseloader code is
                  Relocatable because <strong class="gf gv">it doesn’t call any other functions</strong> (it uses only C
                  macros that access I/O memory). And because it branches to other parts of its own code through <strong
                    class="gf gv">Relative Addresses, not Absolute Addresses</strong>.</p>
                <p id="d785" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">9️⃣ Baseloader <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/baseloader/baseloader.c#L353-L361"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">reboots the Blue Pill</a> and
                  <strong class="gf gv">starts the new Bootloader</strong></p>
              </div>
            </div>
            <div class="cz ak">
              <div class="figure ii ij ik il im cz ak paragraph-image">
                
                <p><img src="https://lupyuen.github.io/images/legacy2/j9.gif" /></p>


             
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <p id="a4da" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">🔟 Bootloader continues to
                  receive the firmware from MakeCode via USB. Bootloader <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/hf2.c#L267-L295"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow"><strong class="gf gv">writes the
                      updated Application code into the Application ROM region</strong></a><strong
                    class="gf gv">,</strong> overwriting the old Application code.</p>
                <p id="a9af" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">After flashing, Bootloader
                  reboots the Blue Pill and <strong class="gf gv">starts the new Application</strong></p>
                <p id="c6c4" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">As we can see, the Bootloader
                  upgrade is made possible by the Baseloader, a special tiny program that has zero dependencies and
                  performs only one job — <em class="ge">overwrite the old Bootloader in ROM by the new Bootloader</em>
                  (also in ROM).</p>
                <p id="4c2c" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">Once again, watch how the
                  Bootloader works together with the Baseloader to update its own code…</p>
              </div>
            </div>
            <div class="cz">
              <div class="n p">
                <div class="jh ji jj jk jl jm ag jn ah jo aj ak">
                  <div class="figure ii ij ik il im cz">
                    <div class="dh r di">
                      <div class="jp r"><iframe
                          src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2FAU0aQ9Vro1g%3Ffeature%3Doembed&amp;url=http%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DAU0aQ9Vro1g&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2FAU0aQ9Vro1g%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube"
                          allowfullscreen="" frameborder="0" height="480" width="854"
                          title="Upgrading the Blue Pill WebUSB Bootloader" class="cp t u dd ak"
                          scrolling="auto"></iframe></div>
                    </div>
                    <figcaption><p><em>Upgrading the WebUSB Bootloader</em></p></figcaption>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <hr class="gw et gx gy gz ha hb hc hd he hf" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <h1 id="4b10" class="ho hp ds bk bj hq hr hs ht hu hv hw hx hy hz ia ib">Remembering the Blue Pill state
                  after restarting</h1>
                <p id="ab27" class="gc gd ds bk gf b gg ic gi id gk ie gm if go ig gq">In some of the above steps we had
                  to restart Blue Pill in either the Bootloader, Baseloader or Application Modes. How does Blue Pill
                  remember which mode it should switch to after restarting?</p>
                <p id="9fdc" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">Before we answer that, here’s the
                  libopencm3 function that we should call to restart the Blue Pill…</p>
                <pre
                  class="ii ij ik il im jq jr js"><span id="4d12" class="jt hp ds bk iy b eu ju jv r jw">scb_reset_system();</span></pre>
                <p id="a594" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">After restarting, all contents of
                  the RAM are wiped out. ROM is non-volatile, so we could flash a value into ROM to indicate the restart
                  mode. But on Blue Pill there’s an easier, safer way to remember the restart mode: <strong
                    class="gf gv">Backup Registers</strong>.</p>
                <p id="a96c" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">The Blue Pill’s Backup Registers
                  are ten 16-bit registers that we may use to store 20 bytes of data. The contents of the registers will
                  be preserved across restarts,<strong class="gf gv"> as long as there is power supplied to Blue
                    Pill</strong>.</p>
                <div class="figure ii ij ik il im cz">
              
                  <p><script src="https://gist.github.com/lupyuen/ebe183a495201248127da64f50a28e89.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/stm32f103/backup.c"
                      class="at cg gr gs gt gu" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/stm32f103/backup.c</a>
                  </em></p></figcaption>
                </div>
                <p id="5eef" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">In the <a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/stm32f103/backup.c"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">Bootloader code above</a> we use
                  macro <code class="dj iv iw ix iy b">RTC_BKP_DR()</code> to read and write the contents of the Backup
                  Registers. Note that the <code class="dj iv iw ix iy b">RTC_BKP_DR()</code> macro is called twice, so
                  that we can store a 32-bit value into two 16-bit registers.</p>
                <p id="529f" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">Also note the calls to libopencm3
                  functions <code class="dj iv iw ix iy b">pwr_disable_backup_domain_write_protect()</code> and <code
                    class="dj iv iw ix iy b">pwr_enable_backup_domain_write_protect()</code>. The Backup Registers are
                  write-protected against any possible data corruption, in case the Blue Pill is restarted and the power
                  is unstable. We need to call <code
                    class="dj iv iw ix iy b">pwr_disable_backup_domain_write_protect()</code> to disable the
                  write-protection before writing to the Backup Registers, and call <code
                    class="dj iv iw ix iy b">pwr_enable_backup_domain_write_protect()</code> when we’re done.</p>
                <p id="458f" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">So here’s what happens when our
                  Blue Pill restarts…</p>
                <p id="42f7" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">1️⃣ Before restarting, the
                  Bootloader sets the restart mode to Bootloader, Baseloader or Application Mode by calling <code
                    class="dj iv iw ix iy b"><a href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/stm32f103/target_stm32f103.c#L240-L246" class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">boot_target_manifest_bootloader()</a>, <a href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/stm32f103/target_stm32f103.c#L232-L238" class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">boot_target_manifest_baseloader()</a></code>
                  or <code
                    class="dj iv iw ix iy b"><a href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/stm32f103/target_stm32f103.c#L224-L230" class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">boot_target_manifest_app()</a></code>.
                  These three functions store the restart mode into Backup Registers 0 and 1.</p>
                <p id="d9a0" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">1️⃣ Upon restarting, <code
                    class="dj iv iw ix iy b"><a href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/bootloader.c#L157-L205" class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">bootloader_start()</a></code><a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/bootloader.c#L157-L205"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow"> in our Bootloader</a> is the
                  function that runs first. It calls <code
                    class="dj iv iw ix iy b">boot_target_get_startup_mode()</code> to get the restart mode.</p>
                <p id="5016" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">2️⃣ <code
                    class="dj iv iw ix iy b"><a href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/stm32f103/target_stm32f103.c#L67-L103" class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">boot_target_get_startup_mode()</a></code><a
                    href="https://github.com/lupyuen/codal-libopencm3/blob/master/stm32/bootloader/stm32f103/target_stm32f103.c#L67-L103"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow"> in our Bootloader</a> reads the
                  Backup Registers 0 and 1 to get the restart mode.</p>
              </div>
            </div>
          </section>
          <hr class="gw et gx gy gz ha hb hc hd he hf" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dp aj ak">
                <h1 id="cfd7" class="ho hp ds bk bj hq hr hs ht hu hv hw hx hy hz ia ib">End of the Journey?</h1>
                <p id="187b" class="gc gd ds bk gf b gg ic gi id gk ie gm if go ig gq">The WebUSB Bootloader for
                  MakeCode on Blue Pill is incredibly complex — it required five articles (plus this article) to explain
                  the topics that we have covered today…</p>
                <p id="4472" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">1️⃣ We implemented the WebUSB and
                  WinUSB interfaces on Blue Pill…</p>
                <div class="jy jz ka kb kc kd"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-usb-bootloader-how-i-fixed-the-usb-storage-serial-dfu-and-webusb-interfaces">
                    <section class="kg cl cm ak ce n ar kh ki kj kk kl km kn ko kp kq kr ks kt ku kv">
                      <div class="kw n co p kx ky">
                        <h2 class="bj hq kz bl ds">
                          <div class="de ke ew ex kf ez">STM32 Blue Pill USB Bootloader — How I fixed the USB Storage,
                            Serial, DFU and WebUSB interfaces</div>
                        </h2>
                      </div>
                      <div class="lc r">
                        <div class="ld r le lf lg lc lh li lj"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="4e43" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">2️⃣ We applied memory
                  optimisation tools and techniques to squeeze the Bootloader into Blue Pill…</p>
                <div class="jy jz ka kb kc kd"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-analyse-and-optimise-your-ram-and-rom">
                    <section class="kg cl cm ak ce n ar kh ki kj kk kl km kn ko kp kq kr ks kt ku kv">
                      <div class="kw n co p kx ky">
                        <h2 class="bj hq kz bl ds">
                          <div class="de ke ew ex kf ez">STM32 Blue Pill — Analyse and Optimise Your RAM and ROM</div>
                        </h2>
                      </div>
                      <div class="lc r">
                        <div class="lk r le lf lg lc lh li lj"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="38d8" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">3️⃣ We created nano-float, an
                  optimised version of the standard math library…</p>
                <div class="jy jz ka kb kc kd"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-shrink-your-math-libraries-with-qfplib">
                    <section class="kg cl cm ak ce n ar kh ki kj kk kl km kn ko kp kq kr ks kt ku kv">
                      <div class="kw n co p kx ky">
                        <h2 class="bj hq kz bl ds">
                          <div class="de ke ew ex kf ez">STM32 Blue Pill — Shrink your math libraries with Qfplib</div>
                        </h2>
                      </div>
                      <div class="lc r">
                        <div class="ll r le lf lg lc lh li lj"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="60d5" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">4️⃣ And we verified the accuracy
                  of the nano-float library through Unit Testing…</p>
                <div class="jy jz ka kb kc kd"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-unit-testing-with-qemu-blue-pill-emulator">
                    <section class="kg cl cm ak ce n ar kh ki kj kk kl km kn ko kp kq kr ks kt ku kv">
                      <div class="kw n co p kx ky">
                        <h2 class="bj hq kz bl ds">
                          <div class="de ke ew ex kf ez">STM32 Blue Pill — Unit Testing with Qemu Blue Pill Emulator
                          </div>
                        </h2>
                      </div>
                      <div class="lc r">
                        <div class="lm r le lf lg lc lh li lj"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="1c37" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">5️⃣ Finally we combined all the
                  topics from the above articles into a complex Bootloader…</p>
                <div class="jy jz ka kb kc kd"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-dissecting-the-webusb-bootloader-for-makecode">
                    <section class="kg cl cm ak ce n ar kh ki kj kk kl km kn ko kp kq kr ks kt ku kv">
                      <div class="kw n co p kx ky">
                        <h2 class="bj hq kz bl ds">
                          <div class="de ke ew ex kf ez">STM32 Blue Pill — Dissecting the WebUSB Bootloader for MakeCode
                          </div>
                        </h2>
                      </div>
                      <div class="lc r">
                        <div class="ln r le lf lg lc lh li lj"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="054e" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">We have done so many incredible
                  things with Blue Pill… Is there a limit? Nope we haven’t hit the limit yet. <em class="ge">So why
                    don’t we create better development tools to let everyone enjoy the power of Blue Pill?</em></p>
                <p id="49a8" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">A good Bootloader is essential
                  for a great programming experience on Blue Pill, and we have come a long way since the first Blue Pill
                  Bootloader…</p>
                <p id="0a5a" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">1️⃣ <a
                    href="https://www.st.com/content/ccc/resource/technical/document/application_note/51/5f/03/1e/bd/9b/45/be/CD00264342.pdf/files/CD00264342.pdf/jcr:content/translations/en.CD00264342.pdf"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">Blue Pill Factory-Installed
                    Bootloader</a>: Needs the UART pins to be connected before flashing. No USB support.</p>
                <p id="8d95" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">2️⃣ <a
                    href="https://github.com/rogerclarkmelbourne/STM32duino-bootloader"
                    class="at cg gr gs gt gu" target="_blank" rel="noopener nofollow">Blue Pill Arduino Bootloader</a>:
                  Works with USB. Flashing works only with Arduino IDE client.</p>
                <p id="d648" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">3️⃣ <a class="at cg gr gs gt gu"
                    target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-dissecting-the-webusb-bootloader-for-makecode">Blue
                    Pill MakeCode Bootloader</a>: Works with Chrome and other WebUSB-compatible web browsers. Allows
                  Bootloader to be reflashed via WebUSB. Probably the best Blue Pill Bootloader to date!</p>
                <p id="24cb" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">It’s been a long journey —
                  <strong class="gf gv">join me if you’re keen to complete the Blue Pill port of MakeCode!</strong> So
                  that we’ll finally have the perfect platform to build and test IoT prototypes.</p>
                <p id="e56d" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">There are too many topics to
                  cover, so I kept a log of all things that I have tried (even the failed ones)…</p>
                <div class="jy jz ka kb kc kd"><a rel="noopener"
                    href="https://web.archive.org/web/20191204194221/https://medium.com/@ly.lee/work-in-progress-stm32-blue-pill-visual-programming-with-makecode-codal-and-libopencm3-422d308f252e?source=friends_link&sk=b39519335652415d5f4aa17c9e4af1d2">
                    <section class="kg cl cm ak ce n ar kh ki kj kk kl km kn ko kp kq kr ks kt ku kv">
                      <div class="kw n co p kx ky">
                        <h2 class="bj hq kz bl ds">
                          <div class="de ke ew ex kf ez">[Work In Progress] STM32 Blue Pill Visual Programming with
                            MakeCode, CODAL and libopencm3</div>
                        </h2>
                      </div>
                      <div class="lc r">
                        <div class="lo r le lf lg lc lh li lj"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="b151" class="gc gd ds bk gf b gg gh gi gj gk gl gm gn go gp gq">Look forward to having you
                  onboard the Blue Pill MakeCode journey! :-)</p>
              </div>
            </div>
          </section>
        </div>
      </article>
    </div>
  </div>

  <ul>
    <li>
    <p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io">Check out my articles</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
    </li>
  </ul>
    
</body>

</html>
<!--
     FILE ARCHIVED ON 19:41:11 Dec 04, 2019 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 01:30:24 Feb 23, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 300.993
  exclusion.robots: 0.152
  exclusion.robots.policy: 0.145
  RedisCDXSource: 19.97
  esindex: 0.007
  LoadShardBlock: 248.701 (3)
  PetaboxLoader3.datanode: 197.736 (4)
  CDXLines.iter: 28.85 (3)
  load_resource: 49.069
  PetaboxLoader3.resolve: 21.641
-->