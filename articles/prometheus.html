<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Monitor IoT Devices in The Things Network with Prometheus and Grafana</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Monitor IoT Devices in The Things Network with Prometheus and Grafana" 
    data-rh="true">
<meta property="og:description" 
    content="How we monitor our IoT Sensor Devices connected to The Things Network... With Prometheus Time Series Database and Grafana Dashboards"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/prometheus-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Monitor IoT Devices in The Things Network with Prometheus and Grafana</h1>
    <nav id="TOC"><ul>
<li><a href="#payload-formatter">1 Payload Formatter</a><ul>
<li><a href="#checkpoint-alpha">1.1 Checkpoint Alpha</a><ul></ul></li></ul></li>
<li><a href="#mqtt-gateway-for-prometheus">2 MQTT Gateway for Prometheus</a><ul>
<li><a href="#prometheus-metrics">2.1 Prometheus Metrics</a><ul></ul></li>
<li><a href="#start-mqtt-gateway">2.2 Start MQTT Gateway</a><ul></ul></li>
<li><a href="#checkpoint-bravo">2.3 Checkpoint Bravo</a><ul></ul></li></ul></li>
<li><a href="#prometheus-time-series-database">3 Prometheus Time Series Database</a><ul>
<li><a href="#checkpoint-charlie">3.1 Checkpoint Charlie</a><ul></ul></li></ul></li>
<li><a href="#grafana-dashboard">4 Grafana Dashboard</a><ul>
<li><a href="#checkpoint-delta">4.1 Checkpoint Delta</a><ul></ul></li></ul></li>
<li><a href="#transform-and-filter-sensor-data">5 Transform and Filter Sensor Data</a><ul>
<li><a href="#auto-dashboard-refresh">5.1 Auto Dashboard Refresh</a><ul></ul></li></ul></li>
<li><a href="#mqtt-with-tls-encryption">6 MQTT with TLS Encryption</a><ul>
<li><a href="#checkpoint-echo">6.1 Checkpoint Echo</a><ul></ul></li></ul></li>
<li><a href="#sensor-data-alerts">7 Sensor Data Alerts</a><ul></ul></li>
<li><a href="#whats-next">8 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">9 Notes</a><ul></ul></li>
<li><a href="#appendix-configure-the-things-network-mqtt">10 Appendix: Configure The Things Network MQTT</a><ul></ul></li>
<li><a href="#appendix-install-grafana">11 Appendix: Install Grafana</a><ul></ul></li></ul></nav><p>üìù <em>21 Oct 2021</em></p>
<p>Suppose we have some <strong>IoT Devices</strong> that transmit <strong>Sensor Data</strong> (via LoRa and LoRaWAN) to <strong>The Things Network</strong>‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/ttn">(That‚Äôs the free-to-use public global wireless network for IoT Devices)</a></p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/grafana-flow3.jpg" alt="IoT Devices transmitting Sensor Data to The Things Network" /></p>
</blockquote>
<p><em>How shall we monitor the Sensor Data transmitted by the IoT Devices?</em></p>
<p>Today we shall monitor IoT Sensor Data by connecting open source <strong>Prometheus and Grafana</strong> to The Things Network‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/prometheus-title.jpg" alt="Monitoring IoT Devices in The Things Network with Prometheus and Grafana" /></p>
<ol>
<li>
<p><strong>The Things Network</strong> pushes our <strong>Sensor Data over MQTT</strong> in real time</p>
</li>
<li>
<p>Our <strong>MQTT Gateway</strong> consumes the Sensor Data‚Ä¶</p>
</li>
<li>
<p>And publishes the Sensor Data to our <strong>Prometheus Time Series Database</strong>‚Ä¶</p>
</li>
<li>
<p>Which gets rendered as a <strong>Grafana Dashboard</strong> like this‚Ä¶</p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/prometheus-grafana4.png" alt="Monitoring Devices on The Things Network with Prometheus and Grafana" /></p>
<p><em>Why Prometheus and Grafana?</em></p>
<p>Prometheus works great for <strong>storing and querying</strong> IoT Sensor Data.</p>
<p>And Grafana works well with Prometheus for <strong>visualising IoT Sensor Data</strong>.</p>
<p><img src="https://lupyuen.github.io/images/ttn-title.jpg" alt="PineDio Stack BL604 RISC-V Board (foreground) talking to The Things Network via RAKWireless RAK7248 LoRaWAN Gateway (background)" /></p>
<p>In a while we shall demo this Prometheus + Grafana Setup with <strong>PineDio Stack BL604 RISC-V Board</strong> (pic above)</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/ttn"><strong>‚ÄúThe Things Network on PineDio Stack BL604 RISC-V Board‚Äù</strong></a></li>
</ul>
<p>But it should work for <strong>any LoRaWAN Device</strong> connected to The Things Network‚Ä¶ Assuming that we have configured a suitable <strong>Payload Formatter</strong> in The Things Network. </p>
<p>(Read on to learn how)</p>
<p><img src="https://lupyuen.github.io/images/payload-title.jpg" alt="CBOR Payload Formatter for The Things Network" /></p>
<h1 id="payload-formatter"><a href="#payload-formatter">1 Payload Formatter</a></h1>
<p><em>What‚Äôs a Payload Formatter in The Things Network?</em></p>
<p>A <strong>Payload Formatter</strong> is JavaScript Code that we configure in The Things Network to <strong>decode the Sensor Data</strong> in the LoRaWAN Message Payload.</p>
<p>For PineDio Stack our Sensor Data is encoded with CBOR (Concise Binary Object Representation), so we use this <strong>CBOR Payload Formatter</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/payload"><strong>‚ÄúCBOR Payload Formatter for The Things Network‚Äù</strong></a></li>
</ul>
<p><em>Is it mandatory to use a Payload Formatter?</em></p>
<p>Yes, our MQTT Gateway will work only if we <strong>configure a suitable Payload Formatter</strong> that will decode our Sensor Data.</p>
<p><a href="https://lupyuen.github.io/articles/payload#whats-a-payload-formatter">(More about Payload Formatters)</a></p>
<p><em>What if we can‚Äôt find a suitable Payload Formatter?</em></p>
<p>We can make one together! <a href="https://www.reddit.com/r/TheThingsNetwork/comments/qafzu4/cbor_payload_formatter_for_the_things_network/?utm_source=share&amp;utm_medium=web2x&amp;context=3">Post a comment here</a></p>
<h2 id="checkpoint-alpha"><a href="#checkpoint-alpha">1.1 Checkpoint Alpha</a></h2>
<p>Let‚Äôs verify that our <strong>Payload Formatter works OK</strong> for decoding our Sensor Data‚Ä¶</p>
<ol>
<li>
<p>Start the <strong>LoRaWAN Firmware</strong> on our LoRaWAN Device (PineDio Stack).</p>
<p>Transmit some Sensor Data every minute‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/tsen#run-the-lorawan-firmware"><strong>‚ÄúRun the LoRaWAN Firmware‚Äù</strong></a></p>
</li>
<li>
<p>Log on to <strong>The Things Network Console</strong></p>
</li>
<li>
<p>Click <strong>Applications ‚Üí (Your Application) ‚Üí Live Data</strong></p>
</li>
<li>
<p>Our <strong>Decoded Sensor Data</strong> should appear in the Live Data Table like so‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>Payload: { l: 4000, t: 4669 }</code></pre></div>
<p><img src="https://lupyuen.github.io/images/payload-ttn3.png" alt="Decoded Sensor Data in the Live Data Table" /></p>
</li>
<li>
<p>Click on a message in the <strong>Live Data Table</strong>. </p>
<p>We should see the <strong>decoded_payload</strong> field containing our Decoded Sensor Data‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{
  ...
  &quot;uplink_message&quot;: {
    ...
    &quot;decoded_payload&quot;: {
      &quot;l&quot;: 4000,
      &quot;t&quot;: 4656
    }    </code></pre></div>
<p>These are the <strong>Light Sensor</strong> (‚Äú<code>l</code>‚Äù) and <strong>Temperature Sensor</strong> (‚Äú<code>t</code>‚Äù) values transmitted by our LoRaWAN Device (PineDio Stack).</p>
<p><a href="https://lupyuen.github.io/articles/cbor#floating-point-numbers">(Our Temperature Values are scaled up 100 times‚Ä¶ <code>4656</code> means <code>46.56</code> ¬∫C)</a></p>
</li>
</ol>
<p>Also verify that the <strong>MQTT Server works OK</strong> at The Things Network‚Ä¶</p>
<ol>
<li>
<p>Start our <strong>LoRaWAN Firmware</strong> and transmit Sensor Data every minute</p>
<p><a href="https://lupyuen.github.io/articles/tsen#run-the-lorawan-firmware">(Like this)</a></p>
</li>
<li>
<p>Copy the <strong>MQTT Public Address, Username and Password</strong> from The Things Network‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/prometheus#appendix-configure-the-things-network-mqtt"><strong>‚ÄúConfigure The Things Network MQTT‚Äù</strong></a></p>
</li>
<li>
<p>Install the <strong>command-line tools for MQTT</strong>‚Ä¶</p>
<p><a href="https://mosquitto.org/download/"><strong>‚ÄúDownload Eclipse Mosquitto‚Äù</strong></a></p>
</li>
<li>
<p>Enter this at the command line‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code># Change au1.cloud.thethings.network to our 
# MQTT Public Address (without the port number)
# Change YOUR_USERNAME to our MQTT Username
# Change YOUR_PASSWORD to our MQTT Password

# For Linux and macOS:
mosquitto_sub \
  -h au1.cloud.thethings.network \
  -t &quot;#&quot; \
  -u &quot;YOUR_USERNAME&quot; \
  -P &quot;YOUR_PASSWORD&quot; \
  -d

# For Windows:
&quot;c:\Program Files\Mosquitto\mosquitto_sub&quot; ^
  -h au1.cloud.thethings.network ^
  -t &quot;#&quot; ^
  -u &quot;YOUR_USERNAME&quot; ^
  -P &quot;YOUR_PASSWORD&quot; ^
  -d</code></pre></div></li>
<li>
<p>We should see the <strong>Uplink Messages transmitted</strong> by our LoRaWAN Device‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{
  ...
  &quot;uplink_message&quot;: {
    ...
    &quot;decoded_payload&quot;: {
      &quot;l&quot;: 4000,
      &quot;t&quot;: 4656
    }    </code></pre></div>
<p>Including <strong>decoded_payload</strong> and the Decoded Sensor Data.</p>
<p><a href="https://github.com/lupyuen/cbor-the-things-network#mqtt-log">(See the complete message)</a></p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/prometheus-flow2.jpg" alt="MQTT Gateway for Prometheus" /></p>
<h1 id="mqtt-gateway-for-prometheus"><a href="#mqtt-gateway-for-prometheus">2 MQTT Gateway for Prometheus</a></h1>
<p>Now we connect our MQTT Gateway to The Things Network‚Ä¶</p>
<ul>
<li><a href="https://github.com/hikhvar/mqtt2prometheus"><strong>MQTT2Prometheus MQTT Gateway</strong></a></li>
</ul>
<p>Our MQTT Gateway shall‚Ä¶</p>
<ul>
<li>
<p><strong>Subscribe to all MQTT Topics</strong> published on The Things Network</p>
<p>(Including the Uplink Messages transmitted by our device)</p>
</li>
<li>
<p><strong>Ingest the Decoded Sensor Data</strong> from the Uplink Messages</p>
<p>(As Prometheus Metrics)</p>
</li>
</ul>
<p>Follow these steps to <strong>configure our MQTT Gateway</strong>‚Ä¶</p>
<ol>
<li>
<p>Download the <strong>MQTT Gateway Configuration File</strong>‚Ä¶</p>
<p><a href="https://github.com/lupyuen/prometheus-the-things-network/blob/main/ttn-mqtt.yaml"><strong>ttn-mqtt.yaml</strong></a></p>
</li>
<li>
<p>Edit the file. Fill in the <strong>MQTT Public Address, Username and Password</strong> for The Things Network <a href="https://lupyuen.github.io/articles/prometheus#appendix-configure-the-things-network-mqtt">(from here)</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code># Change au1.cloud.thethings.network to our MQTT Public Address
server: tcp://au1.cloud.thethings.network:1883

# Change luppy-application@ttn to our MQTT Username
user: luppy-application@ttn

# Change YOUR_API_KEY to our MQTT Password
password: YOUR_API_KEY</code></pre></div></li>
<li>
<p>Note that we‚Äôre subscribing to <strong>all MQTT Topics</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code># Topic path to subscribe to. &quot;#&quot; means All Topics.
topic_path: &quot;#&quot;</code></pre></div></li>
<li>
<p>Our MQTT Gateway shall extract the <strong>Device ID</strong> from the MQTT Topic Path‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code># Extract the device ID (eui-YOUR_DEVICE_EUI) 
# from the topic path, which looks like...
# v3/luppy-application@ttn/devices/eui-YOUR_DEVICE_EUI/up
device_id_regex: &quot;(.*/)?devices/(?P&lt;deviceid&gt;.*)/.*&quot;</code></pre></div>
<p>(Which will be helpful for filtering our Sensor Data by Device ID in Grafana)</p>
<p><img src="https://lupyuen.github.io/images/prometheus-config4.png" alt="MQTT Configuration File" /></p>
</li>
</ol>
<h2 id="prometheus-metrics"><a href="#prometheus-metrics">2.1 Prometheus Metrics</a></h2>
<p><em>What‚Äôs a Prometheus Metric?</em></p>
<p>A Metric is an item of <strong>Monitoring Data</strong> that‚Äôs collected and reported by Prometheus.</p>
<p>(Think of Metrics like CPU Usage and RAM Utilisation‚Ä¶ Prometheus was originally created for monitoring servers)</p>
<p>In this article we shall use ‚ÄúSensor Data‚Äù and ‚ÄúMetric‚Äù interchangeably, since Prometheus treats our <strong>Sensor Data as Metrics</strong>.</p>
<p>Let‚Äôs define the Sensor Data / Metrics that will be <strong>ingested by our MQTT Gateway</strong>‚Ä¶</p>
<ol>
<li>
<p>Edit <a href="https://github.com/lupyuen/prometheus-the-things-network/blob/main/ttn-mqtt.yaml"><strong>ttn-mqtt.yaml</strong></a></p>
<p>Look for the <strong>metrics</strong> section‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/prometheus-config5.png" alt="Prometheus Metrics for MQTT Gateway" /></p>
</li>
<li>
<p>We define the <strong>Metric for Temperature</strong> like so‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code># Temperature Metric
# Name of the metric in prometheus
- prom_name: t

  # JSON Path of the metric in our MQTT JSON message
  mqtt_name: &quot;uplink_message.decoded_payload.t&quot;

  # Prometheus help text for this metric
  help: &quot;Temperature&quot;

  # Prometheus type for this metric.
  # Valid values are: &quot;gauge&quot; and &quot;counter&quot;
  type: gauge

  # Map of string to string for constant labels.
  # The labels will be attached to every Prometheus metric.
  const_labels:
    sensor_type: t    </code></pre></div></li>
<li>
<p>This tells MQTT Gateway: Our LoRaWAN Device (PineDio Stack) transmits a <strong>Temperature Value</strong> (named ‚Äút‚Äù) at this JSON Path‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>uplink_message.decoded_payload.t</code></pre></div>
<p>Which matches our <strong>JSON Message Format</strong> from Checkpoint Alpha‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{
  ...
  &quot;uplink_message&quot;: {
    ...
    &quot;decoded_payload&quot;: {
      &quot;l&quot;: 4000,
      &quot;t&quot;: 4656
    }    </code></pre></div>
<p><a href="https://lupyuen.github.io/articles/cbor#floating-point-numbers">(Our Temperature Values are scaled up 100 times‚Ä¶ <code>4656</code> means <code>46.56</code> ¬∫C)</a></p>
<p><img src="https://lupyuen.github.io/images/prometheus-config7.jpg" alt="Prometheus Metrics for MQTT Gateway" /></p>
</li>
<li>
<p>We define other Metrics the same way, like this <strong>Light Level Metric</strong> that‚Äôs transmitted by PineDio Stack‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code># Light Level Metric
# Name of the metric in prometheus
- prom_name: l

  # JSON Path of the metric in our MQTT JSON message
  mqtt_name: &quot;uplink_message.decoded_payload.l&quot;

  # Prometheus help text for this metric
  help: &quot;Light Level&quot;

  # Prometheus type for this metric.
  # Valid values are: &quot;gauge&quot; and &quot;counter&quot;
  type: gauge

  # Map of string to string for constant labels.
  # The labels will be attached to every Prometheus metric.
  const_labels:
    sensor_type: l</code></pre></div></li>
</ol>
<h2 id="start-mqtt-gateway"><a href="#start-mqtt-gateway">2.2 Start MQTT Gateway</a></h2>
<p>We‚Äôre ready to <strong>start our MQTT Gateway</strong>!</p>
<p>Follow these steps to download and run <strong>MQTT2Prometheus</strong>‚Ä¶</p>
<ol>
<li>
<p>Install the <strong>latest version of Go</strong>‚Ä¶</p>
<p><a href="https://golang.org"><strong><code>golang.org</code></strong></a></p>
</li>
<li>
<p>Enter this at the command line‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code># Download mqtt2prometheus
go get github.com/hikhvar/mqtt2prometheus

# For Linux and macOS:
cd $GOPATH/src/github.com/hikhvar/mqtt2prometheus

# For Windows:
cd %GOPATH%\src\github.com\hikhvar\mqtt2prometheus

# Build mqtt2prometheus
go build ./cmd

# Run mqtt2prometheus.
# Change &quot;ttn-mqtt.yaml&quot; to the full path of our
# MQTT Gateway Configuration File.
go run ./cmd -log-level debug -config ttn-mqtt.yaml</code></pre></div></li>
<li>
<p>For Windows: Click <strong>‚ÄúPrivate Network: Allow Access‚Äù</strong> when prompted</p>
<p>(That‚Äôs because our MQTT Gateway starts a HTTP Server at port 9641)</p>
</li>
<li>
<p>We should see our MQTT Gateway <strong>ingesting Sensor Data</strong> from The Things Network‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>mqttclient/mqttClient.go:20     
Connected to MQTT Broker

mqttclient/mqttClient.go:21     
Will subscribe to topic &quot;#&quot;

web/tls_config.go:191           
&quot;TLS is disabled.&quot;, &quot;http2&quot;: false

metrics/ingest.go:42    
Got message     
&quot;topic&quot;: &quot;v3/luppy-application@ttn/devices/eui-YOUR_DEVICE_EUI/up&quot;, &quot;payload&quot;: 
{
  ...
  &quot;uplink_message&quot;: {
    &quot;decoded_payload&quot;: {
      &quot;l&quot;: 4000,
      &quot;t&quot;: 5017
    }</code></pre></div></li>
<li>
<p>MQTT Gateway is now listening for <strong>HTTP Requests at port 9641</strong>!</p>
</li>
</ol>
<h2 id="checkpoint-bravo"><a href="#checkpoint-bravo">2.3 Checkpoint Bravo</a></h2>
<p>Let‚Äôs check the <strong>Sensor Data ingested</strong> by our MQTT Gateway‚Ä¶</p>
<ol>
<li>
<p>Start our <strong>LoRaWAN Firmware</strong> and transmit Sensor Data every minute</p>
<p><a href="https://lupyuen.github.io/articles/tsen#run-the-lorawan-firmware">(Like this)</a></p>
</li>
<li>
<p>Enter this at the command-line‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>curl -v http://localhost:9641/metrics</code></pre></div></li>
<li>
<p>We should see our Sensor Data (Temperature and Light Level) ingested as <strong>Prometheus Metrics</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># HELP l Light Level
# TYPE l gauge
l{sensor=&quot;eui-YOUR_DEVICE_EUI&quot;,
sensor_type=&quot;l&quot;,
topic=&quot;v3/luppy-application@ttn/devices/eui-YOUR_DEVICE_EUI/up&quot;
} 4000 1634364863274
...    

# HELP t Temperature
# TYPE t gauge
t{sensor=&quot;eui-YOUR_DEVICE_EUI&quot;,
sensor_type=&quot;t&quot;,
topic=&quot;v3/luppy-application@ttn/devices/eui-YOUR_DEVICE_EUI/up&quot;
} 5056 1634364863274</code></pre></div>
<p>This says that the Light Level is <code>4000</code> and the Temperature is <code>50.56</code> ¬∫C, recorded at the Timestamp of <code>1634364863274</code>.</p>
</li>
<li>
<p>Also watch for <strong>received_messages</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code># HELP received_messages received messages per topic and status
# TYPE received_messages counter
received_messages{status=&quot;success&quot;,
topic=&quot;v3/luppy-application@ttn/devices/eui-YOUR_DEVICE_EUI/up&quot;
} 3</code></pre></div>
<p>This says that our MQTT Gateway has successfully processed 3 messages from The Things Network.</p>
<p>Let‚Äôs move on to Prometheus‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/prometheus-flow3.jpg" alt="Prometheus Time Series Database" /></p>
</li>
</ol>
<h1 id="prometheus-time-series-database"><a href="#prometheus-time-series-database">3 Prometheus Time Series Database</a></h1>
<p><em>How do we push the Sensor Data / Metrics from MQTT Gateway to Prometheus?</em></p>
<p>Prometheus collects Metrics by <strong>scraping them over HTTP</strong>‚Ä¶</p>
<p>(Much like the <strong>curl</strong> command from Checkpoint Bravo)</p>
<p>And stores the Metrics in its <strong>Time Series Database</strong>.</p>
<p>(Which is super efficient for querying sensor values that vary over time)</p>
<p>Let‚Äôs <strong>configure and start Prometheus</strong> to scrape the Metrics from our MQTT Gateway‚Ä¶</p>
<ol>
<li>
<p>Download and unzip <strong>Prometheus</strong>‚Ä¶</p>
<p><a href="https://prometheus.io/download/"><strong>‚ÄúPrometheus Download‚Äù</strong></a></p>
</li>
<li>
<p>In the unzipped folder, edit the Prometheus Configuration File‚Ä¶</p>
<p><a href="https://github.com/lupyuen/prometheus-the-things-network#configure-prometheus"><strong>prometheus.yml</strong></a></p>
<p><img src="https://lupyuen.github.io/images/prometheus-config6.png" alt="Prometheus Configuration for MQTT Gateway" /></p>
</li>
<li>
<p>Under the <strong><code>scrape_configs</code></strong> section, add the following‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code># Scrape configuration containing the endpoints to scrape
scrape_configs:
...

  # Scrape The Things Network Metrics from MQTT2Prometheus
  - job_name: &quot;ttn&quot;

    # Metrics will be scraped from MQTT2Prometheus
    # at http://localhost:9641/metrics
    static_configs:
      - targets: [&quot;localhost:9641&quot;]</code></pre></div></li>
<li>
<p>Note that Prometheus will scrape the Metrics from MQTT Gateway <strong>every 15 seconds</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code># Global Configuration
global:

  # Set the scrape interval to every 15 seconds
  scrape_interval: 15s</code></pre></div></li>
<li>
<p>Start the <strong>Prometheus Server</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code># Change this to the unzipped path of Prometheus
cd prometheus

# For Linux and macOS:
./prometheus

# For Windows:
prometheus.exe</code></pre></div></li>
<li>
<p>We should see‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>main.go:400
&quot;No time or size retention was set so using the default time retention&quot; duration=15d

main.go:438
&quot;Starting Prometheus&quot; version=&quot;(version=2.30.3, branch=HEAD, revision=f29caccc42557f6a8ec30ea9b3c8c089391bd5df)&quot;

web.go:541
&quot;Start listening for connections&quot; address=0.0.0.0:9090

main.go:852
&quot;TSDB started&quot;    

main.go:794
&quot;Server is ready to receive web requests.&quot;</code></pre></div></li>
<li>
<p>Prometheus is now listening for <strong>HTTP Requests at port 9090</strong>!</p>
</li>
</ol>
<h2 id="checkpoint-charlie"><a href="#checkpoint-charlie">3.1 Checkpoint Charlie</a></h2>
<p>Let‚Äôs check the <strong>Metrics scraped by Prometheus</strong> from MQTT Gateway‚Ä¶</p>
<ol>
<li>
<p>Start our <strong>LoRaWAN Firmware</strong> and transmit Sensor Data every minute</p>
<p><a href="https://lupyuen.github.io/articles/tsen#run-the-lorawan-firmware">(Like this)</a></p>
</li>
<li>
<p>Browse to our <strong>Prometheus Server</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-uri"><code>http://localhost:9090</code></pre></div></li>
<li>
<p>Enter the <strong>name of our Metric</strong> (like for Temperature)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>t</code></pre></div>
<p>Like this‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/prometheus-metric2.png" alt="Checking the Metrics scraped by Prometheus from MQTT Gateway" /></p>
</li>
<li>
<p>Click <strong>‚ÄúExecute‚Äù</strong> and <strong>‚ÄúGraph‚Äù</strong></p>
<p>Our Metric appears in the graph.</p>
<p>(See pic above)</p>
</li>
</ol>
<p>We‚Äôre ready for our final step‚Ä¶ Connecting Prometheus to Grafana!</p>
<p><img src="https://lupyuen.github.io/images/prometheus-flow4.jpg" alt="Grafana Dashboard for Prometheus" /></p>
<h1 id="grafana-dashboard"><a href="#grafana-dashboard">4 Grafana Dashboard</a></h1>
<p>Finally we <strong>install and configure Grafana</strong> to pull the Metrics from Prometheus (over HTTP) for rendering in a Grafana Dashboard‚Ä¶</p>
<ol>
<li>
<p>Follow the steps below to <strong>download and install Grafana</strong>‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/prometheus#appendix-install-grafana"><strong>‚ÄúInstall Grafana‚Äù</strong></a></p>
</li>
<li>
<p>Browse to our <strong>Grafana Server</strong>‚Ä¶</p>
<p><strong><code>http://localhost:3000</code></strong></p>
<p><strong>Username:</strong> admin</p>
<p><strong>Password:</strong> admin</p>
</li>
<li>
<p>In the left menu bar, click‚Ä¶</p>
<p><strong>Configuration</strong> ‚Üí <strong>Data Sources</strong></p>
<p>Click <strong>‚ÄúAdd Data Source‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/grafana-datasource4.png" alt="Add Data Source" /></p>
</li>
<li>
<p>Look for <strong>‚ÄúPrometheus‚Äù</strong> and click <strong>‚ÄúSelect‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/prometheus-datasource.png" alt="Prometheus Data Source for Grafana" /></p>
</li>
<li>
<p>Set the <strong>HTTP URL</strong> to‚Ä¶</p>
<div class="example-wrap"><pre class="language-uri"><code>http://localhost:9090</code></pre></div>
<p><img src="https://lupyuen.github.io/images/prometheus-grafana5.png" alt="Grafana Data Source for Prometheus" /></p>
</li>
<li>
<p>Click <strong>‚ÄúSave &amp; Test‚Äù</strong></p>
</li>
</ol>
<h2 id="checkpoint-delta"><a href="#checkpoint-delta">4.1 Checkpoint Delta</a></h2>
<p>For our final checkpoint let‚Äôs render our Sensor Data in a <strong>Grafana Dashboard</strong>!</p>
<ol>
<li>
<p>Start our <strong>LoRaWAN Firmware</strong> and transmit Sensor Data every minute</p>
<p><a href="https://lupyuen.github.io/articles/tsen#run-the-lorawan-firmware">(Like this)</a></p>
</li>
<li>
<p>In Grafana, click <strong>‚ÄúAdd Panel‚Äù</strong> (top right)</p>
<p>Click <strong>‚ÄúAdd An Empty Panel‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/grafana-dashboard3.png" alt="Add Panel" /></p>
</li>
<li>
<p>Set the <strong>Data Source</strong> to <strong>‚ÄúPrometheus‚Äù</strong></p>
<p>Under <strong>Metric Browser</strong>: Enter the name of our Metric (like for Temperature)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>t</code></pre></div>
<p>Like this‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/prometheus-grafana6.png" alt="Grafana Panel for Prometheus" /></p>
</li>
<li>
<p>Click the <strong>‚ÄúSave‚Äù</strong> button (top right)</p>
</li>
<li>
<p>Our <strong>Sensor Data from The Things Network</strong> appears in the Grafana Dashboard!</p>
<p><img src="https://lupyuen.github.io/images/prometheus-grafana4.png" alt="Monitoring Devices on The Things Network with Prometheus and Grafana" /></p>
<p>(Remember: Our Temperature Values are scaled up 100 times)</p>
</li>
</ol>
<h1 id="transform-and-filter-sensor-data"><a href="#transform-and-filter-sensor-data">5 Transform and Filter Sensor Data</a></h1>
<p><em>Can we tweak the display of Sensor Data in Grafana?</em></p>
<p>Grafana lets us <strong>transform and filter</strong> the Sensor Data for our Dashboard.</p>
<p>First we show the <strong>Raw Sensor Data</strong> as a table‚Ä¶</p>
<ol>
<li>
<p>Click <strong>‚ÄúPanel Title‚Äù</strong> and <strong>‚ÄúEdit‚Äù</strong></p>
</li>
<li>
<p>Click <strong>‚ÄúTable View‚Äù</strong> (at top)</p>
<p><img src="https://lupyuen.github.io/images/prometheus-table.png" alt="Table View for Grafana Panel" /></p>
</li>
<li>
<p>Not quite what we expected‚Ä¶ Everything gets lumped into a <strong>single column</strong>!</p>
<p>Let‚Äôs <strong>split our Time Series Data</strong> into separate columns.</p>
</li>
<li>
<p>Click <strong>‚ÄúTransform‚Äù</strong> Tab (at bottom)</p>
<p>Click <strong>‚ÄúAdd Transformation‚Äù</strong></p>
<p>Select <strong>‚ÄúLabels To Fields‚Äù</strong></p>
</li>
<li>
<p>We should see this‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/prometheus-transform.png" alt="Labels to Fields for Grafana Panel" /></p>
<p>Much better! Our <strong>Device ID</strong> (‚Äúsensor‚Äù), <strong>Sensor Type</strong> (‚Äút‚Äù) and <strong>Value</strong> are now in separate columns.</p>
</li>
<li>
<p>If we‚Äôre rendering <strong>Multiple Devices or Sensor Types</strong>, we should set the <strong>Value Field Name</strong></p>
<p><a href="https://lupyuen.github.io/articles/prometheus#notes">(See this)</a></p>
</li>
</ol>
<p>Next we <strong>filter the Sensor Data</strong> that will be rendered in our Dashboard‚Ä¶</p>
<ol>
<li>
<p>Click <strong>‚ÄúTransform‚Äù</strong> Tab (at bottom)</p>
<p>Click <strong>‚ÄúAdd Transformation‚Äù</strong></p>
<p>Select <strong>‚ÄúFilter Data By Values‚Äù</strong></p>
</li>
<li>
<p>Click <strong>‚ÄúAdd Condition‚Äù</strong> and set the Condition‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/prometheus-filter.png" alt="Grafana Panel with Filter" /></p>
</li>
<li>
<p>The above filter matches the <strong>Device ID</strong> with the Regular Expression‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>eui-70b3.*</code></pre></div>
<p>Which means that only Device IDs starting with <strong>‚Äúeui-70b3‚Äù</strong> will be rendered.</p>
</li>
<li>
<p>When we‚Äôre done, click the <strong>‚ÄúApply‚Äù</strong> button (top right)</p>
</li>
</ol>
<h2 id="auto-dashboard-refresh"><a href="#auto-dashboard-refresh">5.1 Auto Dashboard Refresh</a></h2>
<p><em>Our Grafana Dashboard doesn‚Äôt refresh automatically for real-time Sensor Data?</em></p>
<p>No worries! This neat trick will <strong>auto-refresh our Grafana Dashboard</strong> to render real-time Sensor Data‚Ä¶</p>
<ol>
<li>
<p>In our Grafana Dashboard, click the <strong>‚ÄúSettings‚Äù</strong> button (top right)</p>
<p><img src="https://lupyuen.github.io/images/prometheus-refresh3.png" alt="Dashboard Settings" /></p>
</li>
<li>
<p>Under <strong>‚ÄúTime Options‚Äù</strong>, uncheck <strong>‚ÄúHide Time Picker‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/prometheus-refresh2.png" alt="Hide Time Picker" /></p>
</li>
<li>
<p>Click <strong>‚ÄúSave Dashboard‚Äù</strong></p>
</li>
<li>
<p>Click the <strong>‚ÄúRefresh Interval‚Äù</strong> (top right)</p>
<p>Select <strong>‚Äú5 Seconds‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/prometheus-refresh4.png" alt="Refresh Interval" /></p>
<p>Now our Grafana Dashboard auto-refreshes every 5 seconds!</p>
</li>
</ol>
<h1 id="mqtt-with-tls-encryption"><a href="#mqtt-with-tls-encryption">6 MQTT with TLS Encryption</a></h1>
<p>There‚Äôs a <strong>Security Risk</strong> in our configuration of MQTT Gateway‚Ä¶</p>
<p>Our <strong>MQTT Password is transmitted as clear text</strong> from our computer to The Things Network!</p>
<p>To secure our MQTT Password with <strong>TLS Encryption</strong>, follow the instructions here‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/prometheus-the-things-network#mqtt-with-tls"><strong>‚ÄúMQTT with TLS Encryption‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/prometheus-tls.jpg" alt="MQTT with TLS Encryption" /></p>
<h2 id="checkpoint-echo"><a href="#checkpoint-echo">6.1 Checkpoint Echo</a></h2>
<p><em>What if we have problems enabling TLS Encryption for MQTT?</em></p>
<p>Run <a href="https://www.wireshark.org/"><strong>Wireshark</strong></a> on our computer and trace the <strong>TLS Certificates</strong> that are presented by The Things Network and by our computer.</p>
<p>The certificates should appear like this‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/prometheus-wireshark2.png" alt="Tracing MQTT with TLS Encryption" /></p>
<h1 id="sensor-data-alerts"><a href="#sensor-data-alerts">7 Sensor Data Alerts</a></h1>
<p><em>Can we create Alerts for monitoring our Sensor Data?</em></p>
<p><em>Like when the Temperature gets too hot?</em></p>
<p>Yes that‚Äôs possible with <strong>Prometheus Alert Manager</strong>!</p>
<blockquote>
<p>‚ÄúThe Alertmanager handles alerts sent by client applications such as the Prometheus server.‚Äù</p>
</blockquote>
<blockquote>
<p>‚ÄúIt takes care of <strong>deduplicating, grouping, and routing</strong> them to the correct receiver integration such as <strong>email, PagerDuty, or OpsGenie</strong>.‚Äù</p>
</blockquote>
<blockquote>
<p>‚ÄúIt also takes care of <strong>silencing and inhibition</strong> of alerts.‚Äù</p>
</blockquote>
<p>More details here‚Ä¶</p>
<ul>
<li><a href="https://prometheus.io/docs/alerting/latest/alertmanager/"><strong>Prometheus Alert Manager</strong></a></li>
</ul>
<p>Drop me a note if you‚Äôre keen to learn about Prometheus Alerts!</p>
<p><img src="https://lupyuen.github.io/images/prometheus-arch.png" alt="Prometheus Architecture" /></p>
<p><a href="https://prometheus.io/docs/introduction/overview/">(Prometheus Architecture)</a></p>
<h1 id="whats-next"><a href="#whats-next">8 What‚Äôs Next</a></h1>
<p>I had fun integrating The Things Network with Prometheus and Grafana‚Ä¶ It‚Äôs something I always wanted to do. I hope you enjoyed it too!</p>
<p>In the next article I‚Äôll head back to <a href="https://lupyuen.github.io/articles/pinedio2"><strong>PineDio Stack BL604</strong></a> and run more IoT Experiments with LoRaWAN and The Things Network.</p>
<p>(Thankfully we now have a proper platform for Sensor Data visualisation and analysis: Prometheus + Grafana!)</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/TheThingsNetwork/comments/qclqxg/monitor_iot_devices_in_the_things_network_with/">Discuss this article on Reddit</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/prometheus.md"><code>lupyuen.github.io/src/prometheus.md</code></a></p>
<h1 id="notes"><a href="#notes">9 Notes</a></h1>
<ol>
<li>
<p>If we‚Äôre rendering <strong>Multiple Sensor Types</strong> in a Grafana Panel (like Temperature and Light Level)‚Ä¶</p>
<p>Set <strong>Labels To Fields</strong> ‚Üí <strong>Value Field Name</strong> to <strong>‚Äúsensor_type‚Äù</strong>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/prometheus-transform2.png" alt="Rendering multiple Sensor Types" /></p>
<p>This fixes the graph to plot one line per Sensor Type.</p>
</li>
<li>
<p>If we‚Äôre rendering <strong>Multiple Devices</strong> in a Grafana Panel‚Ä¶</p>
<p>Set <strong>Labels To Fields</strong> ‚Üí <strong>Value Field Name</strong> to <strong>‚Äúsensor‚Äù</strong>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/prometheus-transform3.png" alt="Rendering multiple Sensor Devices" /></p>
<p>This fixes the graph to plot one line per Device.</p>
</li>
<li>
<p>Why not use an SQL Database (like MySQL) instead of Prometheus?</p>
<p>Well an SQL Database might not scale up for high volumes of Sensor Data because‚Ä¶</p>
<ul>
<li>
<p>SQL Inserts can be costly, due to the frequent indexing. If we run SQL Select queries too often, we might have contention in the SQL Index.</p>
</li>
<li>
<p>SQL doesn‚Äôt work well with time-based queries like ‚ÄúWhat‚Äôs the average daily temperature every day for the past year‚Äù. It gets tedious to code such queries (nested SQL) and they don‚Äôt perform well.</p>
</li>
</ul>
<p>That‚Äôs why we use a Time Series Database like Prometheus. And when we use a Time Series Database, we need a tool like Grafana that can visualise the Time Series Data.</p>
</li>
<li>
<p>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1450262680795713538">this Twitter Thread</a></p>
</li>
</ol>
<h1 id="appendix-configure-the-things-network-mqtt"><a href="#appendix-configure-the-things-network-mqtt">10 Appendix: Configure The Things Network MQTT</a></h1>
<p>Follow these steps to <strong>enable the MQTT Server</strong> in The Things Network‚Ä¶</p>
<ol>
<li>
<p>Log on to <strong>The Things Network Console</strong></p>
</li>
<li>
<p>Click <strong>Applications</strong> ‚Üí <em>(Your Application)</em> ‚Üí <strong>Integrations</strong> ‚Üí <strong>MQTT</strong></p>
<p><img src="https://lupyuen.github.io/images/grafana-ttn.png" alt="Configure The Things Network MQTT Server" /></p>
</li>
<li>
<p>Click <strong>‚ÄúGenerate New API Key‚Äù</strong> and copy the values for‚Ä¶</p>
<ul>
<li>
<p><strong>Public Address</strong></p>
</li>
<li>
<p><strong>Username</strong></p>
</li>
<li>
<p><strong>Password</strong></p>
</li>
</ul>
<p>(This is the only time we can see the password. Don‚Äôt forget to copy it!)</p>
</li>
</ol>
<h1 id="appendix-install-grafana"><a href="#appendix-install-grafana">11 Appendix: Install Grafana</a></h1>
<p>Follow these steps to <strong>install Grafana</strong> on Linux, macOS and Windows‚Ä¶</p>
<ol>
<li>
<p>Browse to <a href="https://grafana.com/oss/grafana/"><strong>grafana.com/oss/grafana</strong></a></p>
<p>Click <strong>‚ÄúGet Grafana ‚Üí Self-Managed ‚Üí Download Grafana‚Äù</strong></p>
</li>
<li>
<p>For <strong>‚ÄúEdition‚Äù</strong> select <strong>‚ÄúOSS‚Äù</strong></p>
</li>
<li>
<p>Click Linux, macOS, Windows, Arm or Docker</p>
<p>(Grafana for Linux works on WSL too)</p>
</li>
<li>
<p>Follow the instructions to download and install Grafana</p>
</li>
<li>
<p>For Linux and macOS: Start the Grafana Server</p>
<div class="example-wrap"><pre class="language-bash"><code># For Ubuntu and WSL
sudo service grafana-server restart
sudo service grafana-server status

# For macOS
brew services start grafana</code></pre></div></li>
<li>
<p>To test Grafana, browse to </p>
<p><strong><code>http://localhost:3000</code></strong></p>
<p><strong>Username:</strong> admin</p>
<p><strong>Password:</strong> admin</p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/prometheus-refresh5.png" alt="Grafana rendering PineDio Stack‚Äôs Internal Temperature over a one-hour period, thanks to Prometheus and The Things Network" /></p>
<p><em>Grafana rendering PineDio Stack‚Äôs Internal Temperature over a one-hour period, thanks to Prometheus and The Things Network</em></p>

    
</body>
</html>