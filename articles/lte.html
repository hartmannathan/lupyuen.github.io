<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>NuttX RTOS for PinePhone: 4G LTE Modem</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="NuttX RTOS for PinePhone: 4G LTE Modem" 
    data-rh="true">
<meta property="og:description" 
    content="All about the Quectel EG25-G 4G LTE Modem inside Pine64 PinePhone... And how we'll control it with Apache NuttX RTOS"
    data-rh="true">
<meta name="description" 
    content="All about the Quectel EG25-G 4G LTE Modem inside Pine64 PinePhone... And how we'll control it with Apache NuttX RTOS">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/lte-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">NuttX RTOS for PinePhone: 4G LTE Modem</h1>
    <nav id="TOC"><ul>
<li><a href="#quectel-eg25-g-lte-modem">1 Quectel EG25-G LTE Modem</a><ul></ul></li>
<li><a href="#data-interfaces-for-lte-modem">2 Data Interfaces for LTE Modem</a><ul></ul></li>
<li><a href="#control-pins-for-lte-modem">3 Control Pins for LTE Modem</a><ul></ul></li>
<li><a href="#lte-modem-power">4 LTE Modem Power</a><ul></ul></li>
<li><a href="#power-output">5 Power Output</a><ul></ul></li>
<li><a href="#power-on-lte-modem">6 Power On LTE Modem</a><ul></ul></li>
<li><a href="#power-up-wth-nuttx">7 Power Up wth NuttX</a><ul></ul></li>
<li><a href="#whats-next">8 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">9 Notes</a><ul></ul></li>
<li><a href="#appendix-lte-modem-pins">10 Appendix: LTE Modem Pins</a><ul>
<li><a href="#power-supply">10.1 Power Supply</a><ul></ul></li>
<li><a href="#power-on--off">10.2 Power On / Off</a><ul></ul></li>
<li><a href="#status-indication">10.3 Status Indication</a><ul></ul></li>
<li><a href="#usb-interface">10.4 USB Interface</a><ul></ul></li>
<li><a href="#main-uart-interface">10.5 Main UART Interface</a><ul></ul></li>
<li><a href="#other-interface-pins">10.6 Other Interface Pins</a><ul></ul></li>
<li><a href="#io-parameters-definition">10.7 I/O Parameters Definition</a><ul></ul></li></ul></li></ul></nav><p>üìù <em>12 Apr 2023</em></p>
<p><img src="https://lupyuen.github.io/images/lte-title.jpg" alt="Quectel EG25-G LTE Modem inside PinePhone" /></p>
<p><a href="https://wiki.pine64.org/images/2/20/Quectel_EG25-G_Hardware_Design_V1.4.pdf"><em>Quectel EG25-G LTE Modem inside PinePhone</em></a></p>
<p>What makes <a href="https://wiki.pine64.org/index.php/PinePhone"><strong>Pine64 PinePhone</strong></a> a phone? It‚Äôs the <a href="https://en.wikipedia.org/wiki/LTE_(telecommunication)"><strong>4G LTE Modem</strong></a> inside that makes Phone Calls and sends Text Messages!</p>
<p>Now we‚Äôre building a <a href="https://lupyuen.github.io/articles/usb2#pinephone--nuttx--feature-phone"><strong>Feature Phone</strong></a> with <a href="https://lupyuen.github.io/articles/what"><strong>Apache NuttX RTOS</strong></a> (Real-Time Operating System). To make things simpler, we‚Äôre writing down <strong>everything we know</strong> about the 4G LTE Modem, and how it works inside PinePhone‚Ä¶</p>
<ul>
<li>
<p>What‚Äôs the <strong>Quectel EG25-G LTE Modem</strong></p>
</li>
<li>
<p>How it‚Äôs <strong>connected inside PinePhone</strong></p>
</li>
<li>
<p>How we make <strong>Phone Calls</strong> and send <strong>Text Messages</strong></p>
</li>
<li>
<p>How we <strong>power up</strong> the LTE Modem</p>
</li>
<li>
<p><strong>Programming the LTE Modem</strong> with UART, USB and Apache NuttX RTOS</p>
</li>
</ul>
<p>Read on to learn all about PinePhone‚Äôs 4G LTE Modem‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/usb2-modem.jpg" alt="Quectel EG25-G LTE Modem" /></p>
<p><a href="https://wiki.pine64.org/wiki/File:Quectel_EG25-G_LTE_Standard_Specification_V1.3.pdf"><em>Quectel EG25-G LTE Modem</em></a></p>
<h1 id="quectel-eg25-g-lte-modem"><a href="#quectel-eg25-g-lte-modem">1 Quectel EG25-G LTE Modem</a></h1>
<p><em>What‚Äôs this LTE Modem?</em></p>
<p>Inside PinePhone is the <a href="https://wiki.pine64.org/index.php/PinePhone#Modem"><strong>Quectel EG25-G LTE Modem</strong></a> for <a href="https://en.wikipedia.org/wiki/LTE_(telecommunication)"><strong>4G LTE</strong></a> Voice Calls, SMS and Mobile Data, plus GPS (pic above)‚Ä¶</p>
<ul>
<li>
<p><a href="https://wiki.pine64.org/wiki/File:Quectel_EG25-G_LTE_Standard_Specification_V1.3.pdf"><strong>Quectel EG25-G Datasheet</strong></a></p>
</li>
<li>
<p><a href="https://wiki.pine64.org/wiki/File:Quectel_EG25-G_Hardware_Design_V1.4.pdf"><strong>EG25-G Hardware Design</strong></a></p>
</li>
</ul>
<p>To control the LTE Modem, we send <strong>AT Commands</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://wiki.pine64.org/wiki/File:Quectel_EC2x%26EG9x%26EG2x-G%26EM05_Series_AT_Commands_Manual_V2.0.pdf"><strong>EG25-G AT Commands</strong></a></p>
</li>
<li>
<p><a href="https://wiki.pine64.org/wiki/File:Quectel_EC2x%26EG9x%26EG2x-G%26EM05_Series_GNSS_Application_Note_V1.3.pdf"><strong>EG25-G GNSS</strong></a></p>
</li>
<li>
<p><a href="https://www.twilio.com/docs/iot/supersim/works-with-super-sim/quectel-eg25-g"><strong>Get Started with AT Commands</strong></a></p>
</li>
</ul>
<p>So to dial the number <strong><code>1711</code></strong>, we send this AT Command‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>ATD1711;
</code></pre></div>
<p>The LTE Modem has similar AT Commands for SMS and Mobile Data.</p>
<p><a href="https://xnux.eu/devices/feature/modem-pp.html#toc-modem-on-pinephone">(EG25-G runs on <strong>Qualcomm MDM 9607</strong> with a Cortex-A7 CPU inside)</a></p>
<p><em>How to send the AT Commands to LTE Modem?</em></p>
<p>The LTE Modem accepts <strong>AT Commands</strong> in two ways (pic below)‚Ä¶</p>
<ul>
<li>
<p>Via the <strong>UART Port (Serial)</strong></p>
<p>Which is Slower: Up to 921.6 kbps</p>
</li>
<li>
<p>Via the <strong>USB Port (USB Serial)</strong></p>
<p>Which is Faster: Up to 480 Mbps</p>
</li>
</ul>
<p>So if we‚Äôre sending and receiving <strong>lots of 4G Mobile Data</strong>, USB is the better way.</p>
<p>(UART Interface is probably sufficient for a Feature Phone)</p>
<p>Let‚Äôs talk about the UART and USB Interfaces‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lte-title4.jpg" alt="Data Interfaces for LTE Modem" /></p>
<h1 id="data-interfaces-for-lte-modem"><a href="#data-interfaces-for-lte-modem">2 Data Interfaces for LTE Modem</a></h1>
<p><em>There‚Äôs a band of bass players in my PinePhone?</em></p>
<p>Ahem the <a href="https://en.wikipedia.org/wiki/Baseband_processor"><strong>Baseband Processor</strong></a> inside the LTE Modem (pic above) is the hardware that handles the <strong>Radio Functions</strong> for 4G LTE and GPS.</p>
<p>According to the <a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><strong>PinePhone Schematic</strong></a> (Page 15), the Baseband Processor talks to PinePhone (Allwinner A64) over the following <strong>Data Interfaces</strong> (pic above)‚Ä¶</p>
<ul>
<li>
<p><strong>USB</strong> ‚áÜ A64 Port <strong>USB1</strong> <em>(USB Serial)</em></p>
<p>For AT Commands and GPS Output. (Up to 480 Mbps)</p>
</li>
<li>
<p><strong>SIM</strong> ‚áÜ PinePhone 4G SIM Card</p>
<p>For connecting to the 4G LTE Mobile Network.</p>
</li>
<li>
<p><strong>PCM</strong> ‚áÜ A64 Port <strong>PCM0</strong></p>
<p><a href="https://en.wikipedia.org/wiki/Pulse-code_modulation"><strong>PCM Digital Audio Stream</strong></a> for 4G Voice Calls.</p>
</li>
<li>
<p><strong>UART</strong> ‚áÜ A64 Port <strong>UART3</strong> <em>(RX / TX)</em>, <strong>UART4</strong> <em>(CTS / RTS)</em></p>
<p>Simpler, alternative interface for AT Commands.</p>
<p>(Default 115.2 kbps, up to 921.6 kbps)</p>
</li>
</ul>
<p>UART is slower than USB, so we should probably use USB instead of UART.</p>
<p>(Unless we‚Äôre building a simple Feature Phone without GPS)</p>
<p>PinePhone also controls the LTE Modem with a bunch of GPIO Pins‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lte-title3.jpg" alt="Control Pins for LTE Modem" /></p>
<h1 id="control-pins-for-lte-modem"><a href="#control-pins-for-lte-modem">3 Control Pins for LTE Modem</a></h1>
<p><em>PinePhone‚Äôs LTE Modem is controlled only by AT Commands?</em></p>
<p>There‚Äôs more! According to the <a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><strong>PinePhone Schematic</strong></a> (Page 15), the LTE Modem is controlled by the following GPIO Pins (pic above)‚Ä¶</p>
<ul>
<li>
<p><strong>Baseband Power</strong> ‚Üê A64 Port <strong>PL7</strong></p>
<p>Supplies power to LTE Modem.</p>
<p>(Also connected to Battery Power VBAT and Power Management DCDC1)</p>
</li>
<li>
<p><strong>Power Key</strong> ‚Üê A64 Port <strong>PB3</strong></p>
<p>Power up the LTE Modem.</p>
<p><a href="https://lupyuen.github.io/articles/lte#power-on--off">(See this)</a></p>
</li>
<li>
<p><strong>Reset</strong> ‚Üê A64 Port <strong>PC4</strong></p>
<p>Reset the LTE Modem.</p>
<p><a href="https://lupyuen.github.io/articles/lte#power-on--off">(See this)</a></p>
</li>
</ul>
<p>We‚Äôll control the above GPIO Pins to <strong>power up the LTE Modem</strong> at startup. (More in the next section)</p>
<p>Also at startup, we‚Äôll read this GPIO Pin to check if the <strong>LTE Modem is hunky dory</strong>‚Ä¶</p>
<ul>
<li>
<p><strong>Status</strong> ‚Üí A64 Port <strong>PH9</strong></p>
<p>Read the Modem Status.</p>
<p><a href="https://lupyuen.github.io/articles/lte#status-indication">(See this)</a></p>
</li>
</ul>
<p>These GPIO Pins control the <strong>Airplane Mode</strong> and <strong>Sleep State</strong>‚Ä¶</p>
<ul>
<li>
<p><strong>Disable</strong> ‚Üê A64 Port <strong>PH8</strong></p>
<p>Enable or Disable Airplane Mode.</p>
<p><a href="https://lupyuen.github.io/articles/lte#other-interface-pins">(See this)</a></p>
</li>
<li>
<p><strong>AP Ready</strong> ‚Üê A64 Port <strong>PH7</strong></p>
<p>Set the Modem Sleep State.</p>
<p><a href="https://lupyuen.github.io/articles/lte#other-interface-pins">(See this)</a></p>
</li>
</ul>
<p>And the LTE Modem signals PinePhone on this GPIO Pin for <strong>Incoming Calls</strong>‚Ä¶</p>
<ul>
<li>
<p><strong>Ring Indicator</strong> ‚Üí A64 Port <strong>PL6</strong></p>
<p>Indicates Incoming Calls.</p>
<p><a href="https://lupyuen.github.io/articles/lte#main-uart-interface">(See this)</a></p>
</li>
</ul>
<p>Let‚Äôs power up the LTE Modem‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lte-title1.jpg" alt="LTE Modem Power" /></p>
<h1 id="lte-modem-power"><a href="#lte-modem-power">4 LTE Modem Power</a></h1>
<p><em>How will we power up the LTE Modem?</em></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><strong>PinePhone Schematic</strong></a> (Page 15) says that PinePhone controls the power via <strong>GPIO Pin PL7</strong> (pic above)‚Ä¶</p>
<ul>
<li>
<p><strong>RF Power</strong> ‚Üê A64 Port <strong>PL7</strong></p>
<p>Supplies power to the Radio Frequency Transmitter and Receiver.</p>
<p>(4G LTE and GPS Transceiver)</p>
</li>
<li>
<p><strong>Baseband Power</strong> ‚Üê A64 Port <strong>PL7</strong></p>
<p>Supplies power to the Baseband Processor.</p>
<p>(4G LTE and GPS Radio Functions)</p>
</li>
</ul>
<p><strong>GPIO Pin PL7</strong> (bottom left) switches on the <strong>Battery Power 4G-BAT</strong> (top left)‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lte-power.png" alt="LTE Modem Power" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>PinePhone Schematic (Page 15)</em></a></p>
<p>Which powers the <strong>LTE Modem via VBAT_BB</strong> (top right).</p>
<p>Thus LTE Modem won‚Äôt power up without the Lithium-ion Battery.</p>
<p><a href="https://datasheet.lcsc.com/lcsc/1811131731_WILLSEMI-Will-Semicon-WPM1481-6-TR_C239798.pdf">(<strong>WPM1481</strong> is a Power Controller)</a></p>
<p><em>What‚Äôs Switch SW1-A? (Bottom left)</em></p>
<p><a href="https://wiki.pine64.org/index.php/PinePhone#Privacy_switch_configuration"><strong>Hardware Privacy Switch 1 (Modem)</strong></a> should be set to ‚ÄúOn‚Äù.</p>
<p>Or the LTE Modem won‚Äôt power on!</p>
<p>(Indeed that‚Äôs a Hardware Switch, not a Soft Switch)</p>
<p><em>So we set GPIO Pin PL7 and the modem powers on?</em></p>
<p>There‚Äôs a <strong>Soft Switch</strong> inside the LTE Modem that we need to toggle‚Ä¶</p>
<ul>
<li>
<p><strong>Power Key</strong> ‚Üê A64 Port <strong>PB3</strong></p>
<p>Power up the LTE Modem.</p>
<p><a href="https://lupyuen.github.io/articles/lte#power-on--off">(See this)</a></p>
</li>
</ul>
<p>Sounds complicated, but we‚Äôll explain the complete Power Up Sequence in a while.</p>
<p>(Power Key works like the press-and-hold Power Button on vintage Nokia Phones)</p>
<p><em>Anything else to power up the LTE Modem?</em></p>
<p>In a while we‚Äôll set the <strong>Reset Pin</strong> and check the <strong>Status Pin</strong>‚Ä¶</p>
<ul>
<li>
<p><strong>Reset</strong> ‚Üê A64 Port <strong>PC4</strong></p>
<p>Reset the LTE Modem.</p>
<p><a href="https://lupyuen.github.io/articles/lte#power-on--off">(See this)</a></p>
</li>
<li>
<p><strong>Status</strong> ‚Üí A64 Port <strong>PH9</strong></p>
<p>Read the Modem Status.</p>
<p><a href="https://lupyuen.github.io/articles/lte#status-indication">(See this)</a></p>
</li>
</ul>
<p>We need to program PinePhone‚Äôs <strong>Power Management Integrated Circuit (PMIC)</strong> to supply <strong>3.3 V on DCDC1</strong>.  Here‚Äôs why‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lte-title2.jpg" alt="LTE Modem Power Output" /></p>
<h1 id="power-output"><a href="#power-output">5 Power Output</a></h1>
<p><em>Wait there‚Äôs a Power Output for the LTE Modem?</em></p>
<p>Yeah it gets confusing. The LTE Modem <strong>outputs 1.8 Volts</strong> to PinePhone (pic above)‚Ä¶</p>
<ul>
<li>
<p><strong>Power Output (1.8 V)</strong> ‚Üí PinePhone <strong>VDD_EXT</strong></p>
<p>Power Output from LTE Modem to PinePhone. (1.8 V)</p>
<p><a href="https://lupyuen.github.io/articles/lte#power-supply">(See this)</a></p>
</li>
</ul>
<p>Which goes into PinePhone‚Äôs <strong>Voltage Translators</strong> as <strong>VDD_EXT</strong> (top left)‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lte-vddext.png" alt="LTE Modem Power Output" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>PinePhone Schematic (Page 15)</em></a></p>
<p><a href="https://www.ti.com/lit/ds/symlink/txb0104.pdf">(<strong>TXB0104</strong> is a Voltage Translator)</a></p>
<p>The circuit above converts the <strong>UART Signals</strong> (TX / RX / CTS / RTS)‚Ä¶</p>
<ul>
<li>
<p>From <strong>1.8 V (LTE Modem, left)</strong></p>
</li>
<li>
<p>To <strong>3.3 V (PinePhone, right)</strong></p>
</li>
</ul>
<p>Voltage Translators are also used for the <a href="https://lupyuen.github.io/articles/lte#control-pins-for-lte-modem"><strong>LTE Modem Control Pins</strong></a>.</p>
<p><em>What‚Äôs DCDC1? (Top right)</em></p>
<p>We need to program PinePhone‚Äôs <a href="https://lupyuen.github.io/articles/de#appendix-power-management-integrated-circuit"><strong>Power Management Integrated Circuit (PMIC)</strong></a> to supply <strong>3.3 V on DCDC1</strong>.</p>
<p>Otherwise the UART Port (and the Control Pins) will get blocked by the Voltage Translators.</p>
<p><em>Why 1.8 V for the LTE Modem?</em></p>
<p>Most parts of the LTE Modem run on 3.3 V‚Ä¶ Just that it needs to power up the <strong>SIM Card at 1.8 V</strong>. <a href="https://en.wikipedia.org/wiki/SIM_card#Design">(See this)</a></p>
<p>(Remember that the SIM Card is actually a microcontroller)</p>
<p>This <a href="https://www.sdcard.org/developers/sd-standard-overview/low-voltage-signaling/"><strong>Low Voltage Signaling</strong></a> is probably meant for newer, power-efficient gadgets. <a href="https://www.sdcard.org/developers/sd-standard-overview/low-voltage-signaling/">(Like this)</a></p>
<p><img src="https://lupyuen.github.io/images/lte-title.jpg" alt="LTE Modem inside PinePhone" /></p>
<h1 id="power-on-lte-modem"><a href="#power-on-lte-modem">6 Power On LTE Modem</a></h1>
<p><em>Whoa LTE Modem has more pins than a Bowling Alley! (Pic above)</em></p>
<p><em>How exactly do we power up the LTE Modem?</em></p>
<p>Earlier we spoke about PinePhone‚Äôs <strong>GPIO Pins</strong> that control the LTE Modem‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">LTE Modem Pin</th><th style="text-align: center">A64 GPIO Pin</th></tr></thead><tbody>
<tr><td style="text-align: left"><a href="https://lupyuen.github.io/articles/lte#lte-modem-power"><strong>RF Power</strong></a></td><td style="text-align: center">‚Üê <strong>PL7</strong></td></tr>
<tr><td style="text-align: left"><a href="https://lupyuen.github.io/articles/lte#lte-modem-power"><strong>Baseband Power</strong></a></td><td style="text-align: center">‚Üê <strong>PL7</strong></td></tr>
<tr><td style="text-align: left"><a href="https://lupyuen.github.io/articles/lte#lte-modem-power"><strong>Reset</strong></a></td><td style="text-align: center">‚Üê  <strong>PC4</strong></td></tr>
<tr><td style="text-align: left"><a href="https://lupyuen.github.io/articles/lte#lte-modem-power"><strong>Power Key</strong></a></td><td style="text-align: center">‚Üê <strong>PB3</strong></td></tr>
<tr><td style="text-align: left"><a href="https://lupyuen.github.io/articles/lte#control-pins-for-lte-modem"><strong>Disable</strong></a></td><td style="text-align: center">‚Üê <strong>PH8</strong></td></tr>
<tr><td style="text-align: left"><a href="https://lupyuen.github.io/articles/lte#lte-modem-power"><strong>Status</strong></a></td><td style="text-align: center">‚Üí <strong>PH9</strong></td></tr>
</tbody></table>
</div>
<p>This is how we control the GPIO Pins to <strong>power up the LTE Modem</strong>‚Ä¶</p>
<ol>
<li>
<p>Program PinePhone‚Äôs <a href="https://lupyuen.github.io/articles/de#appendix-power-management-integrated-circuit"><strong>Power Management Integrated Circuit (PMIC)</strong></a> to supply <strong>3.3 V on DCDC1</strong></p>
</li>
<li>
<p>Set <strong>PL7 to High</strong> to power on the RF Transceiver and Baseband Processor</p>
</li>
<li>
<p>Set <strong>PC4 to High</strong> to deassert LTE Modem Reset</p>
</li>
<li>
<p>Set <strong>PB3 to High</strong> to prepare the Power Key for startup</p>
</li>
<li>
<p><strong>Wait 30 milliseconds</strong> for VBAT Power Supply to be stable</p>
</li>
<li>
<p>Toggle <strong>PB3 (Power Key)</strong> to start the LTE Modem, like this:</p>
<p>Set <strong>PB3 to Low</strong> for at least 500 ms‚Ä¶</p>
<p>Then set <strong>PB3 to High</strong>.</p>
</li>
<li>
<p>Set <strong>PH8 to High</strong> to disable Airplane Mode</p>
</li>
<li>
<p><strong>Read PH9</strong> to check the LTE Modem Status:</p>
<p>PH9 goes from <strong>High to Low</strong> when the LTE Modem is ready, in 2.5 seconds.</p>
</li>
<li>
<p><strong>UART and USB Interfaces</strong> will be operational in 13 seconds</p>
</li>
</ol>
<p><a href="https://wiki.pine64.org/images/2/20/Quectel_EG25-G_Hardware_Design_V1.4.pdf"><strong>EG25-G Hardware Design</strong></a> (Page 41) illustrates the <strong>Power On Sequence</strong>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lte-power2.png" alt="LTE Modem Power" /></p>
<p><em>LTE Modem Status goes High to Low when the LTE Modem is ready. Any gotchas?</em></p>
<p>We might NOT be able to <strong>read the LTE Modem Status reliably</strong> via GPIO Pin PH9.</p>
<p>This will affect our NuttX Testing, as we‚Äôll soon see.</p>
<p><a href="https://lupyuen.github.io/articles/lte#status-indication">(More about this)</a></p>
<p><em>Power Key looks funky: High - Low - High‚Ä¶</em></p>
<p>Yeah the Power Key is probably inspired by the press-and-hold Power Button on vintage Nokia Phones.</p>
<p>Let‚Äôs implement the steps with Apache NuttX RTOS‚Ä¶</p>
<h1 id="power-up-wth-nuttx"><a href="#power-up-wth-nuttx">7 Power Up wth NuttX</a></h1>
<p><em>We‚Äôve seen the Power On Sequence for LTE Modem‚Ä¶</em></p>
<p><em>How do we implement it in Apache NuttX RTOS?</em></p>
<p>TODO</p>
<p>To do this in NuttX, our code looks like this: <a href="https://github.com/lupyuen/pinephone-nuttx-usb/blob/3ceaf44c23b85ec105a0d85cd377f4a55eff5ef5/a64_usbhost.c#L337-L421">a64_usbhost.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Read PH9 to check LTE Modem Status
#define STATUS (PIO_INPUT | PIO_PORT_PIOH | PIO_PIN9)
ret = a64_pio_config(STATUS);
DEBUGASSERT(ret == OK);
_info(&quot;Status=%d\n&quot;, a64_pio_read(STATUS));
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>// Power on DCDC1
int pinephone_pmic_usb_init(void);
ret = pinephone_pmic_usb_init();
DEBUGASSERT(ret == OK);
_info(&quot;Status=%d\n&quot;, a64_pio_read(STATUS));
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>// Wait 1000 ms
_info(&quot;Wait 1000 ms\n&quot;);
up_mdelay(1000);
_info(&quot;Status=%d\n&quot;, a64_pio_read(STATUS));
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>// Set PL7 to High to Power On LTE Modem (4G-PWR-BAT)

#define P_OUTPUT (PIO_OUTPUT | PIO_PULL_NONE | PIO_DRIVE_MEDLOW | \
                PIO_INT_NONE | PIO_OUTPUT_SET)
#define PWR_BAT (P_OUTPUT | PIO_PORT_PIOL | PIO_PIN7)
_info(&quot;Configure PWR_BAT (PL7) for Output\n&quot;);
ret = a64_pio_config(PWR_BAT);
DEBUGASSERT(ret &gt;= 0);

_info(&quot;Set PWR_BAT (PL7) to High\n&quot;);
a64_pio_write(PWR_BAT, true);
_info(&quot;Status=%d\n&quot;, a64_pio_read(STATUS));

</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>// Wait 1000 ms
_info(&quot;Wait 1000 ms\n&quot;);
up_mdelay(1000);
_info(&quot;Status=%d\n&quot;, a64_pio_read(STATUS));
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>// Set PC4 to High to Deassert LTE Modem Reset (BB-RESET / RESET_N)

#define RESET_N (P_OUTPUT | PIO_PORT_PIOC | PIO_PIN4)
_info(&quot;Configure RESET_N (PC4) for Output\n&quot;);
ret = a64_pio_config(RESET_N);
DEBUGASSERT(ret &gt;= 0);

_info(&quot;Set RESET_N (PC4) to High\n&quot;);
a64_pio_write(RESET_N, true);
_info(&quot;Status=%d\n&quot;, a64_pio_read(STATUS));
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>// TODO: Set PB3 to High (BB-PWRKEY / PWRKEY).

// Wait 30 ms for VBAT to be stable
_info(&quot;Wait 30 ms for VBAT to be stable\n&quot;);
up_mdelay(30);
_info(&quot;Status=%d\n&quot;, a64_pio_read(STATUS));
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>// Set PB3 to Power On LTE Modem (BB-PWRKEY / PWRKEY).
// PWRKEY should be pulled down at least 500 ms, then pulled up.

#define PWRKEY (P_OUTPUT | PIO_PORT_PIOB | PIO_PIN3)
_info(&quot;Configure PWRKEY (PB3) for Output\n&quot;);
ret = a64_pio_config(PWRKEY);
DEBUGASSERT(ret &gt;= 0);

_info(&quot;Set PWRKEY (PB3) to Low\n&quot;);
a64_pio_write(PWRKEY, false);
_info(&quot;Status=%d\n&quot;, a64_pio_read(STATUS));
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>_info(&quot;Wait 500 ms\n&quot;);
up_mdelay(500);
_info(&quot;Status=%d\n&quot;, a64_pio_read(STATUS));

_info(&quot;Set PWRKEY (PB3) to High\n&quot;);
a64_pio_write(PWRKEY, true);
_info(&quot;Status=%d\n&quot;, a64_pio_read(STATUS));
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>// Set PH8 to High to Disable Airplane Mode (BB-DISABLE / W_DISABLE#)

#define W_DISABLE (P_OUTPUT | PIO_PORT_PIOH | PIO_PIN8)
_info(&quot;Configure W_DISABLE (PH8) for Output\n&quot;);
ret = a64_pio_config(W_DISABLE);
DEBUGASSERT(ret &gt;= 0);

_info(&quot;Set W_DISABLE (PH8) to High\n&quot;);
a64_pio_write(W_DISABLE, true);
_info(&quot;Status=%d\n&quot;, a64_pio_read(STATUS));
</code></pre></div>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/0216f6968a82a73b67fb48a276b3c0550c47008a/boards/arm64/a64/pinephone/src/pinephone_pmic.c#L294-L340">(<strong>pinephone_pmic_usb_init</strong> is defined here)</a></p>
<p>TODO: Why does LTE Modem Status change from Low to High, then stay at High? <a href="https://github.com/lupyuen/pinephone-nuttx-usb/blob/6fb84655b4ed19af7209817cc01b2a589798620a/README.md#output-log">(See this)</a></p>
<p>Is it because of this‚Ä¶</p>
<p>‚ÄúCurrently STATUS pin is connected to PWRKEY and to PB3. STATUS can‚Äôt be read reliably since voltage divider from R1526 and R1517 places the STATUS signal at 0V or 0.5*Vcc-IO, which is unspecified input value according to A64 datasheet (Vih is 0.7*Vcc-IO, Vil is 0.3*Vcc-IO, the range in between is unspecified).‚Äù </p>
<p><a href="https://wiki.pine64.org/wiki/PinePhone_Power_Management#Open_Questions_2">(Source)</a># LTE Modem UART</p>
<p>TODO: LTE Modem UART</p>
<ul>
<li>
<p>BB-TX: PD1-UART3_RX</p>
</li>
<li>
<p>BB-RX: PD0-UART3_TX</p>
</li>
<li>
<p>BB-CTS: PD5-UART4_CTS</p>
</li>
<li>
<p>BB-RTS: PD4-UART4_RTS</p>
</li>
<li>
<p>BB-DTR: PB2-DTR</p>
</li>
</ul>
<p>TODO: UART3</p>
<p>TODO: Configure UART</p>
<p>TODO: Copy from Allwinner A1X</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/master/arch/arm/src/a1x/a1x_serial.c">a1x_serial.c</a></p>
<p>TODO: USB Enumerate Devices</p>
<p><img src="https://lupyuen.github.io/images/wayland-sd.jpg" alt="Quectel EG25-G LTE Modem inside PinePhone" /></p>
<p><a href="https://wiki.pine64.org/index.php/PinePhone#Modem"><em>Quectel EG25-G LTE Modem inside PinePhone</em></a></p>
<h1 id="whats-next"><a href="#whats-next">8 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Meanwhile please check out the other articles on NuttX for PinePhone‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>My Current Project: ‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>My Other Project: ‚ÄúThe RISC-V BL602 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/lte.md"><strong>lupyuen.github.io/src/lte.md</strong></a></p>
<h1 id="notes"><a href="#notes">9 Notes</a></h1>
<ol>
<li>
<p>References:</p>
<p><a href="https://wiki.pine64.org/wiki/PinePhone_Power_Management"><strong>‚ÄúPinePhone Power Management‚Äù</strong></a></p>
<p><a href="https://xnux.eu/devices/feature/modem-pp.html"><strong>‚ÄúModem on PinePhone‚Äù</strong></a></p>
<p><a href="https://xnux.eu/devices/feature/audio-pp.html"><strong>‚ÄúAudio on PinePhone‚Äù</strong></a></p>
<p><a href="https://xnux.eu/devices/feature/modem-pp-reveng.html"><strong>‚ÄúEG25-G Reverse Engineering‚Äù</strong></a></p>
<p><a href="https://genodians.org/ssumpf/2022-05-09-telephony"><strong>‚ÄúGenode: PinePhone Telephony‚Äù</strong></a></p>
<p><a href="https://wiki.osdev.org/PinePhone"><strong>‚ÄúOSDev: PinePhone‚Äù</strong></a></p>
</li>
</ol>
<h1 id="appendix-lte-modem-pins"><a href="#appendix-lte-modem-pins">10 Appendix: LTE Modem Pins</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/lte-title.jpg" alt="LTE Modem inside PinePhone" /></p>
<p><em>What‚Äôs the purpose of the above LTE Modem pins?</em></p>
<p>From <a href="https://wiki.pine64.org/images/2/20/Quectel_EG25-G_Hardware_Design_V1.4.pdf">Quectel EG25-G Hardware Design</a>‚Ä¶</p>
<h2 id="power-supply"><a href="#power-supply">10.1 Power Supply</a></h2>
<p>TODO</p>
<p>From <a href="https://wiki.pine64.org/images/2/20/Quectel_EG25-G_Hardware_Design_V1.4.pdf">Quectel EG25-G Hardware Design</a>‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">Pin Name</th><th style="text-align: center">Pin No.</th><th style="text-align: center">I/O</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">VDD_EXT</td><td style="text-align: center">7</td><td style="text-align: center">PO</td><td style="text-align: left">Provide 1.8 V for external circuit</td></tr>
</tbody></table>
</div><h2 id="power-on--off"><a href="#power-on--off">10.2 Power On / Off</a></h2>
<p>TODO</p>
<p>From <a href="https://wiki.pine64.org/images/2/20/Quectel_EG25-G_Hardware_Design_V1.4.pdf">Quectel EG25-G Hardware Design</a>‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">Pin Name</th><th style="text-align: center">Pin No.</th><th style="text-align: center">I/O</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">PWRKEY</td><td style="text-align: center">21</td><td style="text-align: center">DI</td><td style="text-align: left">Turn on / off the module</td></tr>
<tr><td style="text-align: left">RESET_N</td><td style="text-align: center">20</td><td style="text-align: center">DI</td><td style="text-align: left">Reset signal of the module</td></tr>
</tbody></table>
</div>
<ul>
<li>
<p>PWRKEY should be pulled down at least 500 ms, then pulled up</p>
<p>(EG25-G HW Design, Page 41)</p>
</li>
<li>
<p>‚ÄúMake sure that VBAT is stable before pulling down PWRKEY pin. It is recommended that the time between powering up VBAT and pulling down PWRKEY pin is no less than 30 ms.‚Äù</p>
<p>(EG25-G HW Design, Page 41)</p>
</li>
<li>
<p>‚ÄúThe RESET_N pin can be used to reset the module. The module can be reset by driving RESET_N to a low level voltage for 150‚Äì460 ms‚Äù</p>
<p>(EG25-G HW Design, Page 42)</p>
</li>
</ul>
<h2 id="status-indication"><a href="#status-indication">10.3 Status Indication</a></h2>
<p>TODO</p>
<p>From <a href="https://wiki.pine64.org/images/2/20/Quectel_EG25-G_Hardware_Design_V1.4.pdf">Quectel EG25-G Hardware Design</a>‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">Pin Name</th><th style="text-align: center">Pin No.</th><th style="text-align: center">I/O</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">STATUS</td><td style="text-align: center">61</td><td style="text-align: center">OD</td><td style="text-align: left">Indicate the module operating status</td></tr>
</tbody></table>
</div>
<ul>
<li>
<p>When PWRKEY is pulled Low, STATUS goes High for ‚â•2.5 s, then STATUS goes Low</p>
<p>(EG25-G HW Design, Page 41)</p>
</li>
<li>
<p>STATUS can‚Äôt be read reliably‚Ä¶</p>
<p>‚ÄúCurrently STATUS pin is connected to PWRKEY and to PB3. STATUS can‚Äôt be read reliably since voltage divider from R1526 and R1517 places the STATUS signal at 0V or 0.5*Vcc-IO, which is unspecified input value according to A64 datasheet (Vih is 0.7*Vcc-IO, Vil is 0.3*Vcc-IO, the range in between is unspecified).‚Äù </p>
<p><a href="https://wiki.pine64.org/wiki/PinePhone_Power_Management#Open_Questions_2">(Source)</a></p>
</li>
</ul>
<h2 id="usb-interface"><a href="#usb-interface">10.4 USB Interface</a></h2>
<p>TODO</p>
<p>From <a href="https://wiki.pine64.org/images/2/20/Quectel_EG25-G_Hardware_Design_V1.4.pdf">Quectel EG25-G Hardware Design</a>‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">Pin Name</th><th style="text-align: center">Pin No.</th><th style="text-align: center">I/O</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">USB_VBUS</td><td style="text-align: center">71</td><td style="text-align: center">PI</td><td style="text-align: left">USB connection detection</td></tr>
</tbody></table>
</div><h2 id="main-uart-interface"><a href="#main-uart-interface">10.5 Main UART Interface</a></h2>
<p>TODO</p>
<p>From <a href="https://wiki.pine64.org/images/2/20/Quectel_EG25-G_Hardware_Design_V1.4.pdf">Quectel EG25-G Hardware Design</a>‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">Pin Name</th><th style="text-align: center">Pin No.</th><th style="text-align: center">I/O</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">RI</td><td style="text-align: center">62</td><td style="text-align: center">DO</td><td style="text-align: left">Ring indicator</td></tr>
</tbody></table>
</div><h2 id="other-interface-pins"><a href="#other-interface-pins">10.6 Other Interface Pins</a></h2>
<p>TODO</p>
<p>From <a href="https://wiki.pine64.org/images/2/20/Quectel_EG25-G_Hardware_Design_V1.4.pdf">Quectel EG25-G Hardware Design</a>‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">Pin Name</th><th style="text-align: center">Pin No.</th><th style="text-align: center">I/O</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">W_DISABLE#</td><td style="text-align: center">4</td><td style="text-align: center">DI</td><td style="text-align: left">Airplane mode control</td></tr>
<tr><td style="text-align: left">AP_READY</td><td style="text-align: center">2</td><td style="text-align: center">DI</td><td style="text-align: left">Application processor sleep state detection</td></tr>
</tbody></table>
</div>
<ul>
<li>
<p>‚ÄúThe W_DISABLE# pin is pulled up by default. Driving it to low level will let the module enter airplane mode‚Äù</p>
<p>(EG25-G HW Design, Page 37)</p>
</li>
</ul>
<h2 id="io-parameters-definition"><a href="#io-parameters-definition">10.7 I/O Parameters Definition</a></h2>
<p>TODO</p>
<p>From <a href="https://wiki.pine64.org/images/2/20/Quectel_EG25-G_Hardware_Design_V1.4.pdf">Quectel EG25-G Hardware Design</a>‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">AI</td><td style="text-align: left">Analog Input</td></tr>
<tr><td style="text-align: left">AO</td><td style="text-align: left">Analog Output</td></tr>
<tr><td style="text-align: left">DI</td><td style="text-align: left">Digital Input</td></tr>
<tr><td style="text-align: left">DO</td><td style="text-align: left">Digital Output</td></tr>
<tr><td style="text-align: left">IO</td><td style="text-align: left">Bidirectional</td></tr>
<tr><td style="text-align: left">OD</td><td style="text-align: left">Open Drain</td></tr>
<tr><td style="text-align: left">PI</td><td style="text-align: left">Power Input</td></tr>
<tr><td style="text-align: left">PO</td><td style="text-align: left">Power Output</td></tr>
</tbody></table>
</div>
    
</body>
</html>