<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>RISC-V Ox64 BL808 SBC: UART Interrupt and Platform-Level Interrupt Controller (PLIC)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="RISC-V Ox64 BL808 SBC: UART Interrupt and Platform-Level Interrupt Controller (PLIC)" 
    data-rh="true">
<meta property="og:description" 
    content="TODO"
    data-rh="true">
<meta name="description" 
    content="TODO">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/plic2-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.codeberg.page/articles/plic2.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">RISC-V Ox64 BL808 SBC: UART Interrupt and Platform-Level Interrupt Controller (PLIC)</h1>
    <nav id="TOC"><ul>
<li><a href="#platform-level-interrupt-controller">1 Platform Level Interrupt Controller</a><ul></ul></li>
<li><a href="#uart-interrupt">2 UART Interrupt</a><ul></ul></li>
<li><a href="#initialise-the-interrupts">3 Initialise the Interrupts</a><ul>
<li><a href="#disable-all-interrupts">3.1 Disable all Interrupts</a><ul></ul></li>
<li><a href="#clear-the-interrupts">3.2 Clear the Interrupts</a><ul></ul></li>
<li><a href="#set-the-interrupt-priority">3.3 Set the Interrupt Priority</a><ul></ul></li>
<li><a href="#set-the-interrupt-threshold">3.4 Set the Interrupt Threshold</a><ul></ul></li></ul></li>
<li><a href="#enable-the-interrupt">4 Enable the Interrupt</a><ul></ul></li>
<li><a href="#hart-0-supervisor-mode">5 Hart 0, Supervisor Mode</a><ul></ul></li>
<li><a href="#handle-the-interrupt">6 Handle the Interrupt</a><ul>
<li><a href="#claim-the-interrupt">6.1 Claim the Interrupt</a><ul></ul></li>
<li><a href="#dispatch-the-interrupt">6.2 Dispatch the Interrupt</a><ul></ul></li>
<li><a href="#complete-the-interrupt">6.3 Complete the Interrupt</a><ul></ul></li>
<li><a href="#pending-interrupts">6.4 Pending Interrupts</a><ul></ul></li></ul></li>
<li><a href="#trouble-with-interrupt-priority">7 Trouble with Interrupt Priority</a><ul></ul></li>
<li><a href="#more-trouble-with-interrupt-claim">8 More Trouble with Interrupt Claim</a><ul></ul></li>
<li><a href="#t-head-vs-sifive">9 T-Head vs SiFive</a><ul></ul></li>
<li><a href="#whats-next">10 What‚Äôs Next</a><ul></ul></li>
<li><a href="#appendix-nuttx-uart-driver-for-ox64">11 Appendix: NuttX UART Driver for Ox64</a><ul></ul></li>
<li><a href="#appendix-uart-interrupt-for-ox64">12 Appendix: UART Interrupt for Ox64</a><ul></ul></li>
<li><a href="#appendix-strangeness-in-ox64-plic">13 Appendix: Strangeness in Ox64 PLIC</a><ul></ul></li></ul></nav><p>üìù <em>7 Dec 2023</em></p>
<p><img src="https://lupyuen.github.io/images/plic2-title.jpg" alt="TODO" /></p>
<p><a href="https://lupyuen.github.io/articles/ox2"><strong>Apache NuttX RTOS</strong></a> (Real-Time Operating System) for <a href="https://wiki.pine64.org/wiki/Ox64"><strong>Pine64 Ox64 BL808</strong></a> 64-bit RISC-V SBC (pic below)‚Ä¶</p>
<p>TODO</p>
<p>Use NuttX to explain how we handle Interrupts on a 64-bit RISC-V SoC</p>
<p><img src="https://lupyuen.github.io/images/ox64-sd.jpg" alt="Pine64 Ox64 64-bit RISC-V SBC (Bouffalo Lab BL808)" /></p>
<h1 id="platform-level-interrupt-controller"><a href="#platform-level-interrupt-controller">1 Platform Level Interrupt Controller</a></h1>
<p><em>What‚Äôs this PLIC?</em></p>
<p>TODO</p>
<h1 id="uart-interrupt"><a href="#uart-interrupt">2 UART Interrupt</a></h1>
<p>TODO</p>
<h1 id="initialise-the-interrupts"><a href="#initialise-the-interrupts">3 Initialise the Interrupts</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/plic2-registers3a.jpg" alt="Disable Interrupts" /></p>
<h2 id="disable-all-interrupts"><a href="#disable-all-interrupts">3.1 Disable all Interrupts</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/jh7110_irq.c#L41-L61">jh7110_irq.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Init the Platform-Level Interrupt Controller
void up_irqinitialize(void) {

  // Disable Supervisor-Mode Interrupts (SIE Register)
  up_irq_save();

  // Disable all External Interrupts
  putreg32(0x0, JH7110_PLIC_ENABLE1);
  putreg32(0x0, JH7110_PLIC_ENABLE2);
</code></pre></div>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/plic2-registers5a.jpg" alt="Clear Interrupts" /></p>
<h2 id="clear-the-interrupts"><a href="#clear-the-interrupts">3.2 Clear the Interrupts</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/jh7110_irq.c#L61-L68">jh7110_irq.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  // Claim and Complete the Outstanding Interrupts
  uintptr_t val = getreg32(JH7110_PLIC_CLAIM);
  putreg32(val, JH7110_PLIC_CLAIM);
</code></pre></div>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/plic2-registers1.jpg" alt="Set Interrupt Priority" /></p>
<h2 id="set-the-interrupt-priority"><a href="#set-the-interrupt-priority">3.3 Set the Interrupt Priority</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/jh7110_irq.c#L75C1-L90">jh7110_irq.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  // Set Priority for all External Interrupts to 1 (Lowest)
  for (int id = 1; id &lt;= NR_IRQS; id++) {
    putreg32(
      1,  // Value
      (uintptr_t)(JH7110_PLIC_PRIORITY + 4 * id)  // Address
    );
  }
</code></pre></div>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/plic2-registers2.jpg" alt="Set Interrupt Threshold" /></p>
<h2 id="set-the-interrupt-threshold"><a href="#set-the-interrupt-threshold">3.4 Set the Interrupt Threshold</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/jh7110_irq.c#L90-L114">jh7110_irq.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  // Set Interrupt Threshold to 0
  // (Permits all External Interrupts)
  putreg32(0, JH7110_PLIC_THRESHOLD);

  // Attach the Common Interrupt Handlers
  // TODO: Show do this earlier
  riscv_exception_attach();

  // Enable Supervisor-Mode Interrupts (SIE Register)
  up_irq_enable();
}
</code></pre></div>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/plic2-registers3.jpg" alt="Enable Interrupt" /></p>
<h1 id="enable-the-interrupt"><a href="#enable-the-interrupt">4 Enable the Interrupt</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/jh7110_irq.c#L158-L208">jh7110_irq.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Enable the NuttX IRQ specified by `irq`
void up_enable_irq(int irq) {

  // Omitted: Enable Inter-CPU Interrupts (SIE Register)
  // Omitted: Enable Timer Interrupts (TIE Register)

  // If this is an External Interrupt...
  if (irq &gt; RISCV_IRQ_EXT) {

    // Subtract 25 from NuttX IRQ to get the RISC-V IRQ
    int extirq = irq - RISCV_IRQ_EXT;

    // Set the Interrupt Enable Bit for `extirq` in PLIC
    if (0 &lt;= extirq &amp;&amp; extirq &lt;= 63) {
      modifyreg32(
        JH7110_PLIC_ENABLE1 + (4 * (extirq / 32)),  // Address
        0,  // Clear Bits
        1 &lt;&lt; (extirq % 32)  // Set Bits
      );
    }
    else { PANIC(); }  // IRQ not supported (for now)
  }
}
</code></pre></div>
<p>TODO: We‚Äôre halfway through! Steps 1, 2 and 3</p>
<p>Before the complete the rest, let‚Äôs talk about Harts‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/plic2-registers.jpg" alt="Registers for Platform-Level Interrupt Controller" /></p>
<h1 id="hart-0-supervisor-mode"><a href="#hart-0-supervisor-mode">5 Hart 0, Supervisor Mode</a></h1>
<p><em>The pic above: Why does it say ‚ÄúHart 0, Supervisor Mode‚Äù?</em></p>
<p>TODO</p>
<p>‚ÄúHart‚Äù refers to</p>
<p>‚ÄúHart 0‚Äù refers to</p>
<p><img src="https://lupyuen.github.io/images/plic2-bl808a.jpg" alt="BL808" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/plic2-bl808b.jpg" alt="JH7110" /></p>
<p><em>Why ‚ÄúSupervisor Mode‚Äù?</em></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/plic2-registers4.jpg" alt="Handle Interrupt" /></p>
<h1 id="handle-the-interrupt"><a href="#handle-the-interrupt">6 Handle the Interrupt</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/plic2-registers5.jpg" alt="Claim Interrupt" /></p>
<h2 id="claim-the-interrupt"><a href="#claim-the-interrupt">6.1 Claim the Interrupt</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/jh7110_irq_dispatch.c#L48-L105">jh7110_irq.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Dispatch the RISC-V Interrupt
void *riscv_dispatch_irq(uintptr_t vector, uintptr_t *regs) {

  // Compute the (Interim) NuttX IRQ Number
  int irq = (vector &gt;&gt; RV_IRQ_MASK) | (vector &amp; 0xf);

  // If this is an External Interrupt...
  if (RISCV_IRQ_EXT == irq) {

    // Read the RISC-V IRQ Number
    // and Claim the Interrupt.
    uintptr_t val = getreg32(
      JH7110_PLIC_CLAIM  // From PLIC Claim Register
    );

    // Compute the Actual NuttX IRQ Number:
    // RISC-V IRQ Number + 25 (RISCV_IRQ_EXT)
    irq += val;
  }
  // Up Next: Dispatch and Complete the Interrupt
</code></pre></div><h2 id="dispatch-the-interrupt"><a href="#dispatch-the-interrupt">6.2 Dispatch the Interrupt</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/jh7110_irq_dispatch.c#L48-L105">jh7110_irq.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  // Omitted: Claim the Interrupt
  ...
  // Remember: `irq` is now the ACTUAL NuttX IRQ Number:
  // RISC-V IRQ Number + 25 (RISCV_IRQ_EXT)

  // If the RISC-V IRQ Number is valid (non-zero)...
  if (RISCV_IRQ_EXT != irq) {

    // Call the Interrupt Handler
    regs = riscv_doirq(irq, regs);
  }
  // Up Next: Complete the Interrupt
</code></pre></div><h2 id="complete-the-interrupt"><a href="#complete-the-interrupt">6.3 Complete the Interrupt</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/jh7110_irq_dispatch.c#L48-L105">jh7110_irq.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  // Omitted: Claim and Dispatch the Interrupt
  ...
  // If this is an External Interrupt...
  if (RISCV_IRQ_EXT &lt;= irq) {

    // Compute the RISC-V IRQ Number
    // and Complete the Interrupt.
    putreg32(
      irq - RISCV_IRQ_EXT,  // RISC-V IRQ Number (RISCV_IRQ_EXT = 25)
      JH7110_PLIC_CLAIM     // PLIC Claim (Complete) Register
    );
  }

  // Return the Registers to the Caller
  return regs;
}
</code></pre></div>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/plic2-registers6.jpg" alt="Pending Interrupts" /></p>
<h2 id="pending-interrupts"><a href="#pending-interrupts">6.4 Pending Interrupts</a></h2>
<p><em>What‚Äôs with the Pending Interrupts? (Pic above)</em></p>
<p>TODO: Normally the Claim / Complete is perfectly adequate for handling interrupts </p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/jh7110_irq_dispatch.c#L48-L105">jh7110_irq.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Check the Pending Interrupts...

// Read PLIC_IP0: Interrupt Pending for interrupts 1 to 31
uintptr_t ip0 = getreg32(0xe0001000);

// Read PLIC_IP1: Interrupt Pending for interrupts 32 to 63
uintptr_t ip1 = getreg32(0xe0001004);

// If Bit 20 of `ip0` is set...
if (ip0 &amp; (1 &lt;&lt; 20)) {
  // Then UART3 Interrupt was fired (RISC-V IRQ 20)
  val = 20;
}
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>// Clear the Pending Interrupts...
// TODO: Clear the Individual Bits instead of wiping out the Entire Register

// Clear PLIC_IP0: Interrupt Pending for interrupts 1 to 31
putreg32(0, 0xe0001000);

// Clear PLIC_IP1: Interrupt Pending for interrupts 32 to 63
putreg32(0, 0xe0001004);
</code></pre></div>
<p>TODO: All this tested with</p>
<ul>
<li>
<p>Star64 JH7110 RISC-V Supervisor Mode (SiFive U74)</p>
</li>
<li>
<p>C906 RISC-V Machine Mode</p>
</li>
</ul>
<p>But not C906 RISC-V Supervisor Mode (BL808)</p>
<p><img src="https://lupyuen.github.io/images/plic2-registers1.jpg" alt="Set Interrupt Priority" /></p>
<h1 id="trouble-with-interrupt-priority"><a href="#trouble-with-interrupt-priority">7 Trouble with Interrupt Priority</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/jh7110_irq.c#L75C1-L90">jh7110_irq.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  // Set Priority for all External Interrupts to 1 (Lowest)
  for (int id = 1; id &lt;= NR_IRQS; id++) {
    putreg32(
      1,  // Value
      (uintptr_t)(JH7110_PLIC_PRIORITY + 4 * id)  // Address
    );
  }

  // Dump the Interrupt Priorities
  infodumpbuffer(&quot;PLIC Interrupt Priority: After&quot;, 0xe0000004, 0x50 * 4);
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-text"><code>PLIC Interrupt Priority: After (0xe0000004):
0000  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0010  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0030  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/4e8ca1f0c0c2bd3b22a8b63f098abdd5#file-ox64-nuttx-int-clear-pending-log-L150-L170">(See the <strong>Complete Log</strong>)</a></p>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/bl602_serial.c#L444-L465">bl602_serial.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Test the setting of PLIC Interrupt Priority
void test_interrupt_priority(void) {
  // Read the values before setting Interrupt Priority
  uint32_t before50 = *(volatile uint32_t *) 0xe0000050UL;
  uint32_t before54 = *(volatile uint32_t *) 0xe0000054UL;

  // Set the Interrupt Priority
  // for 50 but NOT 54
  *(volatile uint32_t *) 0xe0000050UL = 1;

  // Read the values after setting Interrupt Priority
  uint32_t after50 = *(volatile uint32_t *) 0xe0000050UL;
  uint32_t after54 = *(volatile uint32_t *) 0xe0000054UL;

  // Dump before and after values:
  _info(&quot;before50=%u, before54=%u, after50=%u, after54=%u\n&quot;,
    before50, before54, after50, after54);
}
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-text"><code>before50=0, before54=0
after50=1,  after54=1
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/4e8ca1f0c0c2bd3b22a8b63f098abdd5#file-ox64-nuttx-int-clear-pending-log-L257">(See the <strong>Complete Log</strong>)</a></p>
<p>TODO</p>
<div class="example-wrap"><pre class="language-text"><code>PLIC Hart 0 S-Mode Interrupt Enable: Before (0xe0002080):
0000  00 00 00 00 00 00 00 00                          ........        
up_enable_irq: extirq=20, addr=0xe0002080, val=0x1048576
PLIC Hart 0 S-Mode Interrupt Enable: After (0xe0002080):
0000  00 00 10 00 00 00 10 00                          ........  
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/4e8ca1f0c0c2bd3b22a8b63f098abdd5#file-ox64-nuttx-int-clear-pending-log-L194-L198">(See the <strong>Complete Log</strong>)</a></p>
<p><img src="https://lupyuen.github.io/images/plic2-title.jpg" alt="TODO" /></p>
<h1 id="more-trouble-with-interrupt-claim"><a href="#more-trouble-with-interrupt-claim">8 More Trouble with Interrupt Claim</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/jh7110_irq_dispatch.c#L48-L105">jh7110_irq.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Dispatch the RISC-V Interrupt
void *riscv_dispatch_irq(uintptr_t vector, uintptr_t *regs) {

  // Compute the (Interim) NuttX IRQ Number
  int irq = (vector &gt;&gt; RV_IRQ_MASK) | (vector &amp; 0xf);

  // If this is an External Interrupt...
  if (RISCV_IRQ_EXT == irq) {

    // Read the RISC-V IRQ Number
    // and Claim the Interrupt.
    uintptr_t val = getreg32(
      JH7110_PLIC_CLAIM  // From PLIC Claim Register
    );
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>    ////Begin
    if (val == 0) {  // If Interrupt Claimed is 0...
      // Check Pending Interrupts
      uintptr_t ip0 = getreg32(0xe0001000);  // PLIC_IP0: Interrupt Pending for interrupts 1 to 31
      uintptr_t ip1 = getreg32(0xe0001004);  // PLIC_IP1: Interrupt Pending for interrupts 32 to 63
      if (ip0 &amp; (1 &lt;&lt; 20)) { val = 20; }  // UART3 Interrupt was fired
    }
    ////End

    // Compute the Actual NuttX IRQ Number:
    // RISC-V IRQ Number + 25 (RISCV_IRQ_EXT)
    irq += val;
  }

  // Omitted: Call the Interrupt Handler
  // and Complete the Interrupt
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>    // TODO: Can&#39;t Complete the Interrupt
    // Clear the Pending Interrupts
    putreg32(0, 0xe0001000);  // PLIC_IP0: Interrupt Pending for interrupts 1 to 31
    putreg32(0, 0xe0001004);  // PLIC_IP1: Interrupt Pending for interrupts 32 to 63

    // Dump the Pending Interrupts
    infodumpbuffer(&quot;PLIC Interrupt Pending&quot;, 0xe0001000, 2 * 4);
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-12.0.3
nsh&gt;

riscv_dispatch_irq: claim=0

riscv_dispatch_irq: irq=45, claim=0

PLIC Interrupt Pending (0xe0001000):
0000  00 00 00 00 00 00 00 00                          ........        

bl602_receive: rxdata=-1
bl602_receive: rxdata=0x0
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/4e8ca1f0c0c2bd3b22a8b63f098abdd5#file-ox64-nuttx-int-clear-pending-log-L293-L308">(See the <strong>Complete Log</strong>)</a></p>
<h1 id="t-head-vs-sifive"><a href="#t-head-vs-sifive">9 T-Head vs SiFive</a></h1>
<p>TODO</p>
<p><em>Feels like we‚Äôre wading into murky greyish brackish territory‚Ä¶ Like Jaws meets Twilight Zone on the Beach‚Ä¶</em></p>
<p>Yeah we said last time</p>
<p>Sv39 and PLIC are officially speced</p>
<h1 id="whats-next"><a href="#whats-next">10 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>We‚Äôll do much more for <strong>NuttX on Ox64 BL808</strong>, stay tuned for updates!</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> (and the awesome NuttX Community) for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-ox64"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-star64"><strong>My Other Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>Older Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/plic2.md"><strong>lupyuen.github.io/src/plic2.md</strong></a></p>
<h1 id="appendix-nuttx-uart-driver-for-ox64"><a href="#appendix-nuttx-uart-driver-for-ox64">11 Appendix: NuttX UART Driver for Ox64</a></h1>
<p>TODO</p>
<p>BL808 UART is mostly identical to BL602 UART, so we ported the NuttX BL602 UART Driver to BL808.</p>
<p>Here‚Äôs the UART Driver ported to BL808: [bl602_serial.c] (https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64a/arch/risc-v/src/jh7110/bl602_serial.c)</p>
<p>We hardcoded the UART3 Base Address: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64a/arch/risc-v/src/jh7110/hardware/bl602_uart.h#L30-L41">bl602_uart.h</a></p>
<div class="example-wrap"><pre class="language-c"><code>#define BL602_UART0_BASE 0x30002000
#define BL602_UART_BASE(n) (BL602_UART0_BASE)
// Previously: #define BL602_UART_BASE(n)    (BL602_UART0_BASE + (n * (BL602_UART1_BASE - BL602_UART0_BASE)))
</code></pre></div>
<p>We fixed the NuttX Start Code to call our new UART Driver: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64a/arch/risc-v/src/jh7110/jh7110_start.c#L175-L184">jh7110_start.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>void riscv_earlyserialinit(void) {
  bl602_earlyserialinit();
}

void riscv_serialinit(void) {
  bl602_serialinit();
}
</code></pre></div>
<p>We disabled UART Interrupts for now: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64a/arch/risc-v/src/jh7110/bl602_serial.c#L377-L431">bl602_attach and bl602_detach</a></p>
<p>And the UART Driver works! <a href="https://gist.github.com/lupyuen/74a44a3e432e159c62cc2df6a726cb89">(See the log)</a></p>
<p>TODO: /dev/ttyS0 is missing</p>
<p>TODO: Enable UART Interrupts</p>
<h1 id="appendix-uart-interrupt-for-ox64"><a href="#appendix-uart-interrupt-for-ox64">12 Appendix: UART Interrupt for Ox64</a></h1>
<p>TODO</p>
<p>Let‚Äôs fix the UART Interrupts for NuttX on Ox64 BL808!</p>
<p>We fix the PLIC Offsets according to <a href="https://occ-intl-prod.oss-ap-southeast-1.aliyuncs.com/resource/XuanTie-OpenC906-UserManual.pdf">C906 User Manual (Page 77)</a></p>
<p><em>What‚Äôs the UART3 IRQ?</em></p>
<p>From the Linux Device Tree‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>serial@30002000 {
  compatible = &quot;bflb,bl808-uart&quot;;
  reg = &lt;0x30002000 0x1000&gt;;
  interrupts = &lt;0x14 0x04&gt;;
  clocks = &lt;0x04&gt;;
  status = &quot;okay&quot;;
  phandle = &lt;0x0a&gt;;
};
</code></pre></div>
<p>Thus‚Ä¶</p>
<ul>
<li>
<p>RISC-V IRQ = 0x14 = 20</p>
</li>
<li>
<p>UART3 Int = (IRQ_NUM_BASE + 4)</p>
</li>
<li>
<p>IRQ_NUM_BASE = 16</p>
</li>
<li>
<p>NuttX IRQ = 45 (Offset by RISCV_IRQ_EXT)</p>
</li>
<li>
<p>RISCV_IRQ_EXT = 25</p>
</li>
</ul>
<p>We show the UART Interrupt Status‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>bl602_attach: BL602_UART_INT_STS=0x84
bl602_attach: BL602_UART_INT_MASK=0xfff
bl602_attach: BL602_UART_INT_CLEAR=0x0
bl602_attach: BL602_UART_INT_EN=0xfff
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/c3f187af9f5c81594ddf8f854de2ed0a">(Source)</a></p>
<p>‚Äúurx_fer_int = 1‚Äù means ‚ÄúUART RX FIFO error interrupt, auto-cleared when FIFO overflow/underflow error flag is cleared‚Äù</p>
<p>We clear the RX FIFO Underflow, but still no UART Interrupts‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>bl602_attach: BL602_UART_FIFO_CONFIG_0=0x80
bl602_attach: BL602_UART_FIFO_CONFIG_0=0x8
</code></pre></div>
<p>We dump the PLIC and UART Registers in U-Boot‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## UART Registers
=&gt; md 0x30002000 0x36
30002000: 00001705 00000701 00130013 00000000  ................
30002010: 009f0070 0000006f 0000000f 00000000  p...o..........
30002020: 00000012 00000fff 00000000 00000fff  ................
30002030: 00000001 00000000 00000000 00000000  ................
30002040: 00000000 00000000 00000003 00000000  ................
30002050: 0026ffff 00000002 00000000 00000000  ..&amp;.............
30002060: 00000000 00000000 00000000 00000000  ................
30002070: 00000000 00000000 00000000 00000000  ................
30002080: 00000000 07070000 0000000a 00000078  ............x...
30002090: 00000000 00000000 00000000 00000000  ................
300020a0: 00000000 00000000 00000000 00000000  ................
300020b0: 00000000 00000000 00000000 00000000  ................
300020c0: 00000000 00000000 00000000 00000000  ................
300020d0: 00000000 00000000                    ........

## PLIC Interrupt Priority
=&gt; md 0xe0000004 0x50
e0000004: 00000000 00000000 00000000 00000000  ................
e0000014: 00000000 00000000 00000000 00000000  ................
e0000024: 00000000 00000000 00000000 00000000  ................
e0000034: 00000000 00000000 00000000 00000000  ................
e0000044: 00000000 00000000 00000000 00000000  ................
e0000054: 00000000 00000000 00000000 00000000  ................
e0000064: 00000000 00000000 00000000 00000000  ................
e0000074: 00000000 00000000 00000000 00000000  ................
e0000084: 00000000 00000000 00000000 00000000  ................
e0000094: 00000000 00000000 00000000 00000000  ................
e00000a4: 00000000 00000000 00000000 00000000  ................
e00000b4: 00000000 00000000 00000000 00000000  ................
e00000c4: 00000000 00000000 00000000 00000000  ................
e00000d4: 00000000 00000000 00000000 00000000  ................
e00000e4: 00000000 00000000 00000000 00000000  ................
e00000f4: 00000000 00000000 00000000 00000000  ................
e0000104: 00000000 00000000 00000000 00000000  ................
e0000114: 00000000 00000000 00000000 00000000  ................
e0000124: 00000000 00000000 00000000 00000000  ................
e0000134: 00000000 00000000 00000000 00000000  ................

## PLIC Hart 0 S-Mode Interrupt Enable
=&gt; md 0xe0002080 2
e0002080: 00000000 00000000                    ........

## PLIC Hart 0 S-Mode Priority Threshold
=&gt; md 0xe0201000 2
e0201000: 00000007 00000000                    ........

## PLIC Hart 0 S-Mode Claim / Complete
=&gt; md 0xe0201004 1
e0201004: 00000000                             ....

## Interrupt Pending
=&gt; md 0xe0001000 2
e0001000: 00000000 00000000                    ........

## PLIC Hart 0 M-Mode Interrupt Enable
=&gt; md 0xe0002000 2
e0002000: 00000000 00000000                    ........

## PLIC Hart 0 M-Mode Priority Threshold
=&gt; md 0xe0200000 2
e0200000: 00000007 00000000                    ........

## PLIC Hart 0 M-Mode Claim / Complete
=&gt; md 0xe0200004 1
e0200004: 00000000                             ....

## Doesn&#39;t work: PLIC permission control register
## md 0xe01ffffc 1
</code></pre></div>
<p>TODO: Why UART Interrupt not enabled? U-Boot and OpenSBI don‚Äôt use UART Interrupts?</p>
<p>TODO: What is Priority Threshold 7?</p>
<p>But after enabling UART IRQ, PLIC Interrupt Priority is 0 and Invalid!</p>
<div class="example-wrap"><pre class="language-text"><code>PLIC Interrupt Priority (0xe0000004):
0000  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0010  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0030  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0040  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</code></pre></div>
<p>We set PLIC Interrupt Priority to 1 ourselves‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>bl602_attach: Set PLIC Interrupt Priority to 1
PLIC Interrupt Priority (0xe0000004):
0000  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0010  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0030  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0040  00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00  ................
0050  01 00 00 00 01 00 00 00 01 00 00 00 00 00 00 00  ................
0060  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0070  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0080  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0090  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00a0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00b0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00c0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00d0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ...............
00e0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00f0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0100  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0110  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0120  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0130  00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00  ................
</code></pre></div>
<p>Then <a href="https://gist.github.com/lupyuen/af6112c80db6907e5e5dec3519af53ff">IRQ 25 is OK yay!</a></p>
<div class="example-wrap"><pre class="language-text"><code>riscv_dispatch_irq: irq=8
riscv_dispatch_irq: irq=8

NuttShell (NSH) NuttX-12.0.3
riscv_dispatch_irq: irq=25
riscv_dispatch_irq: irq=25
riscv_dispatch_irq: irq=25
</code></pre></div>
<p>But UART Interrupt can‚Äôt be handled because <a href="https://gist.github.com/lupyuen/e1e6bf670ee4eefa0f968f1901407419">PLIC Claim is 0</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>riscv_dispatch_irq: Do irq=8
NuttShell (NSH) NuttX-12.0.3
riscv_dispatch_irq: irq=25, claim=0
riscv_dispatch_irq: *0xe0201004=0
PLIC Interrupt Pending (0xe0001000):
0000  00 00 10 00 00 00 10 00                          ........        
</code></pre></div>
<p><em>Why is PLIC Claim = 0?</em></p>
<p>This means that there are no External Interrupts triggered. So NuttX does nothing, again and again, till it becomes too busy to respond.</p>
<p>But Interrupt Pending is actually set for 2 External Interrupts!</p>
<p><em>What are the 2 Interrupts Pending?</em></p>
<div class="example-wrap"><pre class="language-text"><code>PLIC Interrupt Pending (0xe0001000):
0000  00 00 10 00 00 00 10 00                          ........        
</code></pre></div>
<ul>
<li>
<p>(0xe0001000) PLIC_IP0: Interrupt Pending for interrupts 1 to 31</p>
<p>0x100000 = (1 &lt;&lt; 20) = IRQ 20 (UART3)</p>
</li>
<li>
<p>(0xe0001004) PLIC_IP1: Interrupt Pending for interrupts 32 to 63</p>
<p>0x100000 = (1 &lt;&lt; 20) = IRQ 52 (EMAC2)</p>
<p>TODO: Why EMAC2? We didn‚Äôt enable the interrupt</p>
</li>
</ul>
<p>We <a href="https://gist.github.com/lupyuen/84959d9ba79498a13a759b5b86c6fa29">handle Interrupt Pending</a> ourselves‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>riscv_dispatch_irq: irq=25, claim=0
riscv_dispatch_irq: *0xe0201004=0
PLIC Interrupt Pending (0xe0001000):
0000  00 00 10 00 00 00 10 00                          ........        
riscv_dispatch_irq: Do irq=45
After Claim (0xe0001000):
0000  00 00 10 00 00 00 10 00                          ........        

riscv_dispatch_irq: irq=25, claim=0
riscv_dispatch_irq: *0xe0201004=0
PLIC Interrupt Pending (0xe0001000):
0000  00 00 10 00 00 00 10 00                          ........        
riscv_dispatch_irq: Do irq=45
After Claim (0xe0001000):
0000  00 00 10 00 00 00 10 00                          ........
</code></pre></div>
<p>‚ÄúDo IRQ‚Äù now works! But Interrupt Pending is not cleared, after we Claimed the interrupt.</p>
<p><em>Doesn‚Äôt NuttX already implement C906 PLIC?</em></p>
<p>Yep but for Machine Mode only‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/risc-v/src/c906/c906_irq.c">c906_irq.c</a></p>
</li>
<li>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/risc-v/src/c906/c906_irq_dispatch.c">c906_irq_dispatch.c</a></p>
</li>
</ul>
<p><em>What if we copy this code into Ox64 PLIC?</em></p>
<div class="example-wrap"><pre class="language-c"><code>// From arch/risc-v/src/c906/c906_irq.c
/* Clear pendings in PLIC */
uintptr_t val = getreg32(JH7110_PLIC_CLAIM);
putreg32(val, JH7110_PLIC_CLAIM);
</code></pre></div>
<p>Still the same, Claim = 0‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>riscv_dispatch_irq: irq=25, claim=0
riscv_dispatch_irq: *0xe0201004=0
PLIC Interrupt Pending (0xe0001000):
0000  00 00 10 00 00 00 10 00                          ........        
</code></pre></div>
<p><em>Something special about T-Head C906 PLIC?</em></p>
<p>According to the Linux Device Tree, Ox64 uses this PLIC Driver: ‚Äúthead,c900-plic‚Äù</p>
<div class="example-wrap"><pre class="language-text"><code>interrupt-controller@e0000000 {
  compatible = &quot;thead,c900-plic&quot;;
</code></pre></div>
<p>Then from this <a href="https://lore.kernel.org/lkml/CAJF2gTS8Z+6Ewy0D5+0X_h2Jz4BqsJp7wEC5F0iNaDsSpiE2aw@mail.gmail.com/">Linux Patch</a></p>
<blockquote>
<p>‚ÄúThe T-HEAD C9xx SoC implements a modified/custom T-HEAD PLIC
specification which will mask current IRQ upon read to CLAIM register
and will unmask the IRQ upon write to CLAIM register. The
thead,c900-plic compatible string represents the custom T-HEAD PLIC
specification.‚Äù</p>
</blockquote>
<p>‚Äúthead,c900-plic‚Äù is implemented in Linux here: <a href="https://github.com/torvalds/linux/blob/master/drivers/irqchip/irq-sifive-plic.c#L574-L582">irq-sifive-plic.c</a></p>
<p>Which sets <a href="https://github.com/torvalds/linux/blob/master/drivers/irqchip/irq-sifive-plic.c#L64">PLIC_QUIRK_EDGE_INTERRUPT</a>, which is used by‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/torvalds/linux/blob/master/drivers/irqchip/irq-sifive-plic.c#L212-L235">plic_irq_set_type</a></p>
</li>
<li>
<p><a href="https://github.com/torvalds/linux/blob/master/drivers/irqchip/irq-sifive-plic.c#L312-L325">plic_irq_domain_translate</a></p>
<p>Which calls <a href="https://github.com/torvalds/linux/blob/master/kernel/irq/irqdomain.c#L1060-L1081">irq_domain_translate_twocell</a></p>
<p>(Instead of the normal <a href="https://github.com/torvalds/linux/blob/master/kernel/irq/irqdomain.c#L1043-L1060">irq_domain_translate_onecell</a>)</p>
</li>
</ul>
<p><em>What does it do?</em></p>
<p>From another <a href="https://lore.kernel.org/all/20220630100241.35233-3-samuel@sholland.org/">Linux Patch</a></p>
<blockquote>
<p>The Renesas RZ/Five SoC has a RISC-V AX45MP AndesCore with NCEPLIC100. The
NCEPLIC100 supports both edge-triggered and level-triggered interrupts. In
case of edge-triggered interrupts NCEPLIC100 ignores the next interrupt
edge until the previous completion message has been received and
NCEPLIC100 doesn‚Äôt support pending interrupt counter, hence losing the
interrupts if not acknowledged in time.</p>
</blockquote>
<blockquote>
<p>So the workaround for edge-triggered interrupts to be handled correctly
and without losing is that it needs to be acknowledged first and then
handler must be run so that we don‚Äôt miss on the next edge-triggered
interrupt.</p>
</blockquote>
<p>TODO: Fix this for Ox64 NuttX</p>
<p>After Clearing the Pending Interrupts, <a href="https://gist.github.com/lupyuen/4e8ca1f0c0c2bd3b22a8b63f098abdd5">NuttX responds to Key Presses yay!</a></p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-12.0.3
riscv_dispatch_irq: Clear Pending Interrupts, irq=45, claim=0
PLIC Interrupt Pending (0xe0001000):
0000  00 00 00 00 00 00 00 00                          ........        
nsh&gt; riscv_dispatch_irq: Clear Pending Interrupts, irq=45, claim=0
PLIC Interrupt Pending (0xe0001000):
0000  00 00 00 00 00 00 00 00                          ........        
riscv_dispatch_irq: Clear Pending Interrupts, irq=45, claim=0
PLIC Interrupt Pending (0xe0001000):
0000  00 00 00 00 00 00 00 00                          ........        
nx_start: CPU0: Beginning Idle Loop
riscv_dispatch_irq: Clear Pending Interrupts, irq=45, claim=0
PLIC Interrupt Pending (0xe0001000):
0000  00 00 00 00 00 00 00 00                          ........        
Àáriscv_dispatch_irq: Clear Pending Interrupts, irq=45, claim=0
PLIC Interrupt Pending (0xe0001000):
0000  00 00 00 00 00 00 00 00                          ........ 
</code></pre></div>
<p>But Claim is still 0 though.</p>
<p>TODO: Key press not read correctly</p>
<p>TODO: Why is up_irqinitialize not setting Interrupt Priority properly? Signed arithmetic? Or delay?</p>
<h1 id="appendix-strangeness-in-ox64-plic"><a href="#appendix-strangeness-in-ox64-plic">13 Appendix: Strangeness in Ox64 PLIC</a></h1>
<p>TODO</p>
<p><em>PLIC in Ox64 BL808 is acting really strange‚Ä¶</em></p>
<p><em>Why is Interrupt Priority set for 4 Interrupts, when we only set 1 (for UART)?</em></p>
<div class="example-wrap"><pre class="language-text"><code>bl602_attach: Set PLIC Interrupt Priority to 1
PLIC Interrupt Priority (0xe0000004):
...
0040  00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00  ................
0050  01 00 00 00 01 00 00 00 01 00 00 00 00 00 00 00  ................
</code></pre></div>
<p><em>Maybe it‚Äôs a problem with the RISC-V Code generated by GCC?</em></p>
<p>Let‚Äôs do a simple test: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/ox64b/arch/risc-v/src/jh7110/bl602_serial.c#L447-L473">bl602_serial.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Test the setting of PLIC Interrupt Priority
void test_interrupt_priority(void) {
  static uint32_t before1 = 0xFF;
  static uint32_t before2 = 0xFF;
  static uint32_t after1 = 0xFF;
  static uint32_t after2 = 0xFF;

  // Read the values before setting Interrupt Priority
  before1 = *(volatile uint32_t *) 0xe0000050UL;
  before2 = *(volatile uint32_t *) 0xe0000054UL;

  // Set the Interrupt Priority
  *(volatile uint32_t *) 0xe0000050UL = 1;

  // Read the values after setting Interrupt Priority
  after1 = *(volatile uint32_t *) 0xe0000050UL;
  after2 = *(volatile uint32_t *) 0xe0000054UL;
  _info(&quot;before1=%u, before2=%u, after1=%u, after2=%u\n&quot;, before1, before2, after1, after2);
}
</code></pre></div>
<p>The Interrupt Priority <a href="https://gist.github.com/lupyuen/4e8ca1f0c0c2bd3b22a8b63f098abdd5">wasn‚Äôt be set correctly</a>. Why did 0xe0000054 change from 0 to 1?</p>
<div class="example-wrap"><pre class="language-text"><code>bl602_attach: Test Interrupt Priority
test_interrupt_priority: before1=0, before2=0, after1=1, after2=1
</code></pre></div>
<p>Here‚Äôs the Disassembly, which looks OK‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>0000000050200daa &lt;test_interrupt_priority&gt;:
test_interrupt_priority():
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:451
  uint32_t before1 = *(volatile uint32_t *) 0xe0000050;
    50200daa:	461d                	li	a2,7
    50200dac:	0676                	slli	a2,a2,0x1d

/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:454
  *(volatile uint32_t *) 0xe0000050 = 1;
    50200dae:	4785                	li	a5,1

/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:451
  uint32_t before1 = *(volatile uint32_t *) 0xe0000050;
    50200db0:	4a34                	lw	a3,80(a2)

/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:452
  uint32_t before2 = *(volatile uint32_t *) 0xe0000054;
    50200db2:	4a78                	lw	a4,84(a2)

/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:454
  *(volatile uint32_t *) 0xe0000050 = 1;
    50200db4:	ca3c                	sw	a5,80(a2)

/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:457
  uint32_t after1 = *(volatile uint32_t *) 0xe0000050;
    50200db6:	4a3c                	lw	a5,80(a2)

/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:458
  uint32_t after2 = *(volatile uint32_t *) 0xe0000054;
    50200db8:	05462803          	lw	a6,84(a2)
</code></pre></div>
<p><em>Maybe we need to flush the CPU Cache?</em></p>
<p>Nope <code>sfence</code> doesn‚Äôt help‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>0000000050200daa &lt;test_interrupt_priority&gt;:
test_interrupt_priority():
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:451
  uint32_t before1 = *(volatile uint32_t *) 0xe0000050;
    50200daa:	461d                	li	a2,7
    50200dac:	0676                	slli	a2,a2,0x1d
    50200dae:	4a34                	lw	a3,80(a2)
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:452
  uint32_t before2 = *(volatile uint32_t *) 0xe0000054;
    50200db0:	4a78                	lw	a4,84(a2)
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:455
  *(volatile uint32_t *) 0xe0000050 = 1;
    50200db2:	4785                	li	a5,1
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:451
  uint32_t before1 = *(volatile uint32_t *) 0xe0000050;
    50200db4:	2681                	sext.w	a3,a3
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:452
  uint32_t before2 = *(volatile uint32_t *) 0xe0000054;
    50200db6:	2701                	sext.w	a4,a4
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:455
  *(volatile uint32_t *) 0xe0000050 = 1;
    50200db8:	ca3c                	sw	a5,80(a2)
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:458
  __asm__ __volatile__
    50200dba:	12000073          	sfence.vma
    50200dbe:	0330000f          	fence	rw,rw
    50200dc2:	0000100f          	fence.i
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:467
  uint32_t after1 = *(volatile uint32_t *) 0xe0000050;
    50200dc6:	4a3c                	lw	a5,80(a2)
    50200dc8:	2781                	sext.w	a5,a5
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:469
  __asm__ __volatile__
    50200dca:	12000073          	sfence.vma
    50200dce:	0330000f          	fence	rw,rw
    50200dd2:	0000100f          	fence.i
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:477
  uint32_t after2 = *(volatile uint32_t *) 0xe0000054;
    50200dd6:	05462803          	lw	a6,84(a2)
    50200dda:	2801                	sext.w	a6,a6
/Users/Luppy/ox64/nuttx/arch/risc-v/src/chip/bl602_serial.c:479
  __asm__ __volatile__
    50200ddc:	12000073          	sfence.vma
    50200de0:	0330000f          	fence	rw,rw
    50200de4:	0000100f          	fence.i
</code></pre></div>
<p>Let‚Äôs do the same with U-Boot Bootloader. It looks OK, doesn‚Äôt have the same problem‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Read the values before setting Interrupt Priority
=&gt; md 0xe0000050 1
e0000050: 00000000                             ....
=&gt; md 0xe0000054 1
e0000054: 00000000                             ....

## Set the Interrupt Priority
=&gt; mw 0xe0000050 0x01 1

## Read the values after setting Interrupt Priority
=&gt; md 0xe0000050 1
e0000050: 00000001                             ....
=&gt; md 0xe0000054 1
e0000054: 00000000                             ....
</code></pre></div>
<p>And U-Boot doesn‚Äôt use MMU.</p>
<p><em>Could it be caused by MMU?</em></p>
<p>Let‚Äôs try setting Interrupt Priority before MMU Init. It works OK!</p>
<div class="example-wrap"><pre class="language-text"><code>123jh7110_copy_ramdisk: _edata=0x50400258, _sbss=0x504002a0, _ebss=0x50408000, JH7110_IDLESTACK_TOP=0x50408c00
jh7110_copy_ramdisk: ramdisk_addr=0x50410291
jh7110_copy_ramdisk: size=8192000
ABCjh7110_mm_init: Test Interrupt Priority
test_interrupt_priority: before1=0, before2=0, after1=1, after2=0
jh7110_kernel_mappings: map I/O regions
</code></pre></div>
<p>When we set Interrupt Priority after MMU Init, it looks incorrect‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>123jh7110_copy_ramdisk: _edata=0x50400258, _sbss=0x504002a0, _ebss=0x50408000, JH7110_IDLESTACK_TOP=0x50408c00
jh7110_copy_ramdisk: ramdisk_addr=0x50410291
jh7110_copy_ramdisk: size=8192000
ABCjh7110_kernel_mappings: map I/O regions
jh7110_kernel_mappings: map PLIC as Interrupt L2
jh7110_kernel_mappings: connect the L1 and Interrupt L2 page tables for PLIC
jh7110_kernel_mappings: map kernel text
jh7110_kernel_mappings: map kernel data
jh7110_kernel_mappings: connect the L1 and L2 page tables
jh7110_kernel_mappings: map the page pool
mmu_satp_reg: pgbase=0x50407000, asid=0x0, reg=0x8000000000050407
mmu_write_satp: reg=0x8000000000050407
jh7110_mm_init: Test Interrupt Priority
test_interrupt_priority: before1=0, before2=0, after1=0, after2=0
nx_start: Entry
</code></pre></div>
<p>So it‚Äôs an MMU problem!</p>
<p><em>Why is MMU messing up our updates to Ox64 BL808 PLIC?</em></p>
<p>We might have missed something specific to C906 MMU. Here are the Extended Page Attributes, from <a href="https://occ-intl-prod.oss-ap-southeast-1.aliyuncs.com/resource/XuanTie-OpenC906-UserManual.pdf">C906 User Manual (Page 53)</a></p>
<ul>
<li>
<p><strong>SO ‚Äì Strong order</strong> (Bit 63)</p>
<p>Indicates the access order required by memory.</p>
<p>0: no strong order (Normal-memory)</p>
<p>1: strong order (Device)</p>
<p>The default value is no strong order.</p>
</li>
<li>
<p><strong>C ‚Äì Cacheable</strong> (Bit 62)</p>
<p>0: Non-cacheable</p>
<p>1: Cacheable</p>
<p>The default value is Non-cacheable.</p>
</li>
<li>
<p><strong>B ‚Äì Buffer</strong> (Bit 61)</p>
<p>0: Non-bufferable</p>
<p>1: Bufferable</p>
<p>The default value is Non-bufferable</p>
</li>
</ul>
<p>Also‚Ä¶</p>
<blockquote>
<p>‚ÄúC906 extended page attributes exist only when the MAEE bit in the MXSTATUS register is 1.‚Äù</p>
</blockquote>
<p>TODO: Set MAEE Bit in MXSTATUS Register</p>
<p>TODO: <a href="https://github.com/openbouffalo/OBLFR/blob/master/apps/d0_lowload/src/rv32i_xtheade_lz4.S">d0_lowload Boot Code</a> doesn‚Äôt set MXSTATUS</p>
<p>TODO: Set Strong Order (Bit 63) in MMU Page Table Entries. Retest the setting of PLIC Interrupt Priority</p>
<p><em>What if we disable and re-enable MMU, while setting PLIC Interrupt Priority?</em></p>
<p>Yep seems to work‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>jh7110_mm_init: Disable MMU
mmu_write_satp: reg=0
jh7110_mm_init: Test Interrupt Priority
test_interrupt_priority: before1=0, before2=0, after1=1, after2=0
jh7110_mm_init: Enable MMU
</code></pre></div>
<p><img src="https://lupyuen.github.io/images/plic2-draw.jpg" alt="TODO" /></p>

    
</body>
</html>