<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Zig Visual Programming with Blockly</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Zig Visual Programming with Blockly" 
    data-rh="true">
<meta property="og:description" 
    content="How we create a Zig program visually with Blockly, the drag-n-drop way... And how we might use it to build Sensor IoT Apps for Apache NuttX RTOS"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/blockly-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Zig Visual Programming with Blockly</h1>
    <nav id="TOC"><ul>
<li><a href="#visual-program">1 Visual Program</a><ul></ul></li>
<li><a href="#code-generator">2 Code Generator</a><ul>
<li><a href="#set-variable">2.1 Set Variable</a><ul></ul></li>
<li><a href="#print-expression">2.2 Print Expression</a><ul></ul></li>
<li><a href="#repeat-loop">2.3 Repeat Loop</a><ul></ul></li>
<li><a href="#main-function">2.4 Main Function</a><ul></ul></li></ul></li>
<li><a href="#define-functions">3 Define Functions</a><ul></ul></li>
<li><a href="#blockly-is-typeless">4 Blockly is Typeless</a><ul></ul></li>
<li><a href="#constants-vs-variables">5 Constants vs Variables</a><ul></ul></li>
<li><a href="#desktop-and-mobile">6 Desktop and Mobile</a><ul></ul></li>
<li><a href="#iot-sensor-apps">7 IoT Sensor Apps</a><ul></ul></li>
<li><a href="#read-sensor-data">8 Read Sensor Data</a><ul></ul></li>
<li><a href="#transmit-sensor-data">9 Transmit Sensor Data</a><ul></ul></li>
<li><a href="#whats-next">10 What’s Next</a><ul></ul></li>
<li><a href="#notes">11 Notes</a><ul></ul></li>
<li><a href="#appendix-fixed-point-numbers">12 Appendix: Fixed-Point Numbers</a><ul></ul></li>
<li><a href="#appendix-add-a-zig-tab">13 Appendix: Add a Zig Tab</a><ul></ul></li>
<li><a href="#appendix-zig-code-generator">14 Appendix: Zig Code Generator</a><ul></ul></li>
<li><a href="#appendix-load-code-generator">15 Appendix: Load Code Generator</a><ul></ul></li>
<li><a href="#appendix-build-blockly">16 Appendix: Build Blockly</a><ul></ul></li>
<li><a href="#appendix-test-blockly">17 Appendix: Test Blockly</a><ul></ul></li></ul></nav><p>📝 <em>7 Aug 2022</em></p>
<p><img src="https://lupyuen.github.io/images/blockly-title.jpg" alt="Zig Visual Programming with Blockly" /></p>
<p><em>Can we create a Zig program visually… The Drag-and-Drop way?</em></p>
<p>Let’s find out! Today we shall explore <a href="https://developers.google.com/blockly"><strong>Blockly</strong></a>, the Scratch-like browser-based coding toolkit…</p>
<p>And how we might customise Blockly to <strong>create Zig programs</strong> visually. (Pic above)</p>
<p><em>Will it work for any Zig program?</em></p>
<p>We’re not quite done yet. We hit some <strong>interesting challenges</strong>, like Blockly’s “Typelessness” and Zig’s “Anti-Shadowing”.</p>
<p>But it might work for creating <strong>IoT Sensor Apps</strong> for Embedded Platforms like <a href="https://lupyuen.github.io/articles/zig"><strong>Apache NuttX RTOS</strong></a>.</p>
<p>(More about this below)</p>
<p>Let’s head down into our Zig experiment with Blocky…</p>
<ul>
<li><a href="https://github.com/lupyuen3/blockly-zig-nuttx"><strong>lupyuen3/blockly-zig-nuttx</strong></a></li>
</ul>
<p>And learn how how we ended up here…</p>
<ul>
<li>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/"><strong>Blockly with Zig (Work in Progress)</strong></a></p>
</li>
<li>
<p><a href="https://youtu.be/192ZKA-1OqY"><strong>Watch the Demo on YouTube</strong></a></p>
</li>
</ul>
<h1 id="visual-program"><a href="#visual-program">1 Visual Program</a></h1>
<p><em>What’s Visual Programming like with Blockly?</em></p>
<p>With Blockly, we create Visual Programs by dragging and dropping <strong>Interlocking Blocks</strong>. (Exactly like Scratch and MakeCode)</p>
<p>This is a Visual Program that loops 10 times, printing the number <code>123.45</code>…</p>
<p><img src="https://lupyuen.github.io/images/blockly-run1.png" alt="Blockly Visual Program" /></p>
<p>We can try dragging-n-dropping the Blocks here…</p>
<ul>
<li>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/"><strong>Blockly with Zig (Work in Progress)</strong></a></p>
</li>
<li>
<p><a href="https://youtu.be/192ZKA-1OqY"><strong>Watch the Demo on YouTube</strong></a></p>
</li>
</ul>
<p>To find the above Blocks, click the <strong>Blocks Toolbox</strong> (at left) and look under <strong>“Loops”</strong>, <strong>“Variables”</strong>, <strong>“Math”</strong> and <strong>“Text”</strong>.</p>
<p><em>But will it produce a Zig program?</em></p>
<p>Yep if we click the <strong>Zig Tab</strong>…</p>
<p><img src="https://lupyuen.github.io/images/blockly-run3a.png" alt="Zig Tab in Blockly" /></p>
<p>This <strong>Zig Program</strong> appears…</p>
<div class="example-wrap"><pre class="language-zig"><code>/// Import Standard Library
const std = @import(&quot;std&quot;);

/// Main Function
pub fn main() !void {
  var count: usize = 0;
  while (count &lt; 10) : (count += 1) {
    const a: f32 = 123.45;
    debug(&quot;a={}&quot;, .{ a });
  }
}

/// Aliases for Standard Library
const assert = std.debug.assert;
const debug  = std.log.debug;</code></pre></div>
<p>When we copy-n-paste the program and run it with Zig…</p>
<div class="example-wrap"><pre class="language-text"><code>$ zig run a.zig
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02</code></pre></div>
<p>Indeed it produces the right result!</p>
<p>(Not the tidiest output, but we’ll come back to this)</p>
<p><em>Will this work with all Blocks?</em></p>
<p>Not quite. We customised Blockly to support the <strong>bare minimum of Blocks</strong>.</p>
<p>There’s plenty more to be customised for Zig. Lemme know if you’re keen to help! 🙏</p>
<p><img src="https://lupyuen.github.io/images/blockly-run2.png" alt="Zig Code generated by Blocky" /></p>
<h1 id="code-generator"><a href="#code-generator">2 Code Generator</a></h1>
<p><em>How did Blockly automagically output our Zig Program?</em></p>
<p>Blockly comes bundled with <strong>Code Generators</strong> that will churn out programs in JavaScript, Python, Dart, …</p>
<p>Sadly it doesn’t have one for Zig. So we built our own <strong>Zig Code Generator</strong> for Blockly…</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/blockly#appendix-add-a-zig-tab"><strong>“Add a Zig Tab”</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/blockly#appendix-zig-code-generator"><strong>“Zig Code Generator”</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/blockly#appendix-load-code-generator"><strong>“Load Code Generator”</strong></a></p>
</li>
</ul>
<p><em>Every Block generates its own Zig Code?</em></p>
<p>Our Code Generator needs to output Zig Code for <strong>every kind of Block</strong>.</p>
<p>(Which makes it tiresome to customise Blockly for Zig)</p>
<p>To understand the work involved, we’ll look at three Blocks and how our Code Generator handles them…</p>
<ul>
<li>
<p><strong>Set Variable</strong></p>
</li>
<li>
<p><strong>Print Expression</strong></p>
</li>
<li>
<p><strong>Repeat Loop</strong></p>
</li>
</ul>
<p>We’ll also study the <strong>Main Function</strong> that’s produced by our Code Generator.</p>
<p><img src="https://lupyuen.github.io/images/blockly-run5.png" alt="Set Variable" /></p>
<h2 id="set-variable"><a href="#set-variable">2.1 Set Variable</a></h2>
<p>Blockly will let us assign Values to Variables. (Pic above)</p>
<p>To keep things simple, we’ll handle Variables as <strong>Constants</strong>. And they shall be <strong>Floating-Point Numbers</strong>. (We’ll explain why)</p>
<p>Thus the Block above will generate this Zig code…</p>
<div class="example-wrap"><pre class="language-zig"><code>const a: f32 = 123.45;</code></pre></div>
<p><strong>UPDATE:</strong> We have removed <code>f32</code> from all <code>const</code> declarations, replying on <strong>Type Inference</strong> instead. This works better for supporting CBOR Messages. <a href="https://twitter.com/MisterTechBlog/status/1557857587667775489">(Like so)</a></p>
<p>This is how we generate the code with a template (through <strong>String Interpolation</strong>): <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig/variables.js#L25-L32">generators/zig/variables.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>Zig[&#39;variables_set&#39;] = function(block) {
  // Variable setter.
  ...
  return `const ${varName}: f32 = ${argument0};\n`;
};</code></pre></div>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">(More about String Interpolation)</a></p>
<p><em>Isn’t this (gasp) JavaScript?</em></p>
<p>Blockly is coded in <strong>plain old JavaScript</strong>. Hence we’ll write our Zig Code Generator in JavaScript too.</p>
<p>(Maybe someday we’ll convert the Zig Code Generator to WebAssembly and build it in Zig)</p>
<p><img src="https://lupyuen.github.io/images/blockly-run6.png" alt="Print Expression" /></p>
<h2 id="print-expression"><a href="#print-expression">2.2 Print Expression</a></h2>
<p>To <strong>print the value</strong> of an expression (pic above), we generate this Zig code…</p>
<div class="example-wrap"><pre class="language-zig"><code>debug(&quot;a={}&quot;, .{ a });</code></pre></div>
<p>Here’s the implementation in our Zig Code Generator: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig/text.js#L268-L272">generators/zig/text.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>Zig[&#39;text_print&#39;] = function(block) {
  // Print statement.
  ...
  return `debug(&quot;${msg}={}&quot;, .{ ${msg} });\n`;
};</code></pre></div>
<p>(It won’t work with strings, we’ll handle that later)</p>
<p><img src="https://lupyuen.github.io/images/blockly-run4.png" alt="Repeat Loop" /></p>
<h2 id="repeat-loop"><a href="#repeat-loop">2.3 Repeat Loop</a></h2>
<p>To run a <strong>repeating loop</strong> (pic above), we generate this Zig code…</p>
<div class="example-wrap"><pre class="language-zig"><code>var count: usize = 0;
while (count &lt; 10) : (count += 1) {
  ...
}</code></pre></div>
<p>With this template in our Zig Code Generator: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig/loops.js#L19-L45">generators/zig/loops.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>Zig[&#39;controls_repeat_ext&#39;] = function(block) {
  // Repeat n times.
  ...
  code += [
    `var ${loopVar}: usize = 0;\n`,
    `while (${loopVar} &lt; ${endVar}) : (${loopVar} += 1) {\n`,
    branch,
    &#39;}\n&#39;
  ].join(&#39;&#39;);
  return code;
};</code></pre></div>
<p><em>What if we have two Repeat Loops? Won’t “<code>count</code>” clash?</em></p>
<p>Blockly will helpfully <strong>generate another counter</strong> like “<code>count2</code>”…</p>
<div class="example-wrap"><pre class="language-zig"><code>var count2: usize = 0;
while (count2 &lt; 10) : (count2 += 1) {
  ...
}</code></pre></div>
<p>(Try it out!)</p>
<h2 id="main-function"><a href="#main-function">2.4 Main Function</a></h2>
<p>To become a valid Zig program, our generated Zig code needs to be wrapped into a <strong>Main Function</strong> like this…</p>
<div class="example-wrap"><pre class="language-zig"><code>/// Import Standard Library
const std = @import(&quot;std&quot;);

/// Main Function
pub fn main() !void {
  // TODO: Generated Zig Code here
  ...
}

/// Aliases for Standard Library
const assert = std.debug.assert;
const debug  = std.log.debug;</code></pre></div>
<p>We do this with another template in our Zig Code Generator: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig.js#L132-L193">generators/zig.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>Zig.finish = function(code) {
  ...
  // Compose Main Function
  code = [
    &#39;/// Main Function\n&#39;,
    &#39;pub fn main() !void {\n&#39;,
    code,
    &#39;}&#39;,
  ].join(&#39;&#39;);</code></pre></div>
<p>The code above composes the <strong>Main Function</strong>.</p>
<p>Next we define the <strong>Header and Trailer</strong>…</p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Compose Zig Header
  const header = [
    &#39;/// Import Standard Library\n&#39;,
    &#39;const std = @import(&quot;std&quot;);\n&#39;,
  ].join(&#39;&#39;);

  // Compose Zig Trailer
  const trailer = [
    &#39;/// Aliases for Standard Library\n&#39;,
    &#39;const assert = std.debug.assert;\n&#39;,
    &#39;const debug  = std.log.debug;\n&#39;,
  ].join(&#39;&#39;);</code></pre></div>
<p>Finally we combine them and return the result…</p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Combine Header, Code, 
  // Function Definitions and Trailer
  return [
    header,
    &#39;\n&#39;,
    code,
    (allDefs == &#39;&#39;) ? &#39;&#39; : &#39;\n\n&#39;,
    allDefs.replace(/\n\n+/g, &#39;\n\n&#39;).replace(/\n*$/, &#39;\n\n&#39;),
    trailer,
  ].join(&#39;&#39;);
};</code></pre></div>
<p>Let’s talk about Function Definitions…</p>
<h1 id="define-functions"><a href="#define-functions">3 Define Functions</a></h1>
<p><em>Can we define Zig Functions in Blockly?</em></p>
<p>Sure can! This <strong>Function Block</strong>…</p>
<p><img src="https://lupyuen.github.io/images/blockly-run7a.jpg" alt="Define Blockly Function" /></p>
<p><a href="https://lupyuen.github.io/images/blockly-run9.jpg">(Parameters are defined in <strong>Function Settings</strong>)</a></p>
<p><a href="https://youtu.be/192ZKA-1OqY?t=56">(Watch the Demo on YouTube)</a></p>
<p>Will generate this perfectly valid <strong>Zig Function</strong>…</p>
<div class="example-wrap"><pre class="language-zig"><code>fn do_something(x: f32, y: f32) !f32 {
  const a: f32 = 123.45;
  debug(&quot;a={}&quot;, .{ a });
  return x + y;
}</code></pre></div>
<p>And calling the above function…</p>
<p><img src="https://lupyuen.github.io/images/blockly-run7b.jpg" alt="Call Blockly Function" /></p>
<p>Works OK with Zig too…</p>
<div class="example-wrap"><pre class="language-zig"><code>const a: f32 = 123.45;
const b: f32 = try do_something(a, a);
debug(&quot;b={}&quot;, .{ b });</code></pre></div>
<p>Thus indeed it’s possible to create <a href="https://lupyuen.github.io/images/blockly-run10.jpg"><strong>Complex Blockly Apps</strong></a> with Zig. <a href="https://lupyuen.github.io/images/blockly-run10.jpg">(Like this)</a></p>
<p>The above templates are defined in our Code Generator at <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig/procedures.js#L18-L92">generators/zig/procedures.js</a></p>
<h1 id="blockly-is-typeless"><a href="#blockly-is-typeless">4 Blockly is Typeless</a></h1>
<p><em>Why are our Constants declared as Floating-Point <code>f32</code>?</em></p>
<p>Here comes the interesting challenge with Zig on Blockly…</p>
<p><strong>Blockly is Typeless!</strong></p>
<p>Blockly doesn’t recognise Types, so it will gladly accept this…</p>
<p><img src="https://lupyuen.github.io/images/blockly-run8.jpg" alt="Blocky is Typeless" /></p>
<p>Which works fine with <a href="https://developer.mozilla.org/en-US/docs/Glossary/Dynamic_typing"><strong>Dynamically-Typed Languages</strong></a> like JavaScript…</p>
<div class="example-wrap"><pre class="language-javascript"><code>// Dynamic Type in JavaScript
var a;
a = 123.45;
a = &#39;abc&#39;;</code></pre></div>
<p>But not for <a href="https://developer.mozilla.org/en-US/docs/Glossary/Static_typing"><strong>Statically-Typed Languages</strong></a> like Zig!</p>
<p>That’s why we constrain all Types as <code>f32</code>, until we figure out how to handle strings and other types…</p>
<div class="example-wrap"><pre class="language-zig"><code>// Static Type in Zig
const a: f32 = 123.45;
// Nope we won&#39;t accept &quot;abc&quot;</code></pre></div>
<p><em>Won’t that severely limit our Zig Programs?</em></p>
<p><code>f32</code> is probably sufficient for simple <strong>IoT Sensor Apps</strong>.</p>
<p>Such apps work only with numeric <strong>Sensor Data</strong> (like temperature, humidity). And they don’t need to manipulate strings.</p>
<p>(More about this in a while)</p>
<h1 id="constants-vs-variables"><a href="#constants-vs-variables">5 Constants vs Variables</a></h1>
<p><em>What other challenges do we have with Zig on Blockly?</em></p>
<p>Our Astute Reader would have seen this Oncoming Wreckage (from miles away)…</p>
<p><img src="https://lupyuen.github.io/images/blockly-run12.jpg" alt="Redeclared Constants in Blockly" /></p>
<p>The <strong>Double Assignment</strong> above will cause Constant Problems…</p>
<div class="example-wrap"><pre class="language-zig"><code>// This is OK
const a: f32 = 123.45;

// Oops! `a` is redeclared...
const a: f32 = 234.56;</code></pre></div>
<p>Our Code Generator will have to stop this somehow.</p>
<p><em>Why not declare as a Variable? (Instead of a Constant)</em></p>
<div class="example-wrap"><pre class="language-zig"><code>// This is OK
var a: f32 = undefined;
a = 123.45;
a = 234.56;</code></pre></div>
<p>Call me stupendously stubborn, but I think Constants look neater than Variables?</p>
<p>Also we might have a problem with <a href="https://ziglang.org/documentation/master/#Shadowing"><strong>Shadowed Identifiers</strong></a>…</p>
<p><img src="https://lupyuen.github.io/images/blockly-run15.jpg" alt="Shadowing in Blockly" /></p>
<p>This code won’t compile with Zig even if we change <code>const</code> to <code>var</code>…</p>
<div class="example-wrap"><pre class="language-zig"><code>// This is OK
const a: f32 = 123.45;
debug(&quot;a={}&quot;, .{ a });

var count: usize = 0;
while (count &lt; 10) : (count += 1) {

  // Oops! `a` is shadowed...
  const a: f32 = 234.56;
  debug(&quot;a={}&quot;, .{ a });
}</code></pre></div>
<p><a href="https://ziglang.org/documentation/master/#Shadowing">(More about Shadowing)</a></p>
<p>So yeah, supporting Zig on Blockly can get really challenging.</p>
<p>(Though supporting C on Blockly without Type Inference would be a total nightmare!)</p>
<h1 id="desktop-and-mobile"><a href="#desktop-and-mobile">6 Desktop and Mobile</a></h1>
<p><em>Can we build Blockly apps on Mobile Devices?</em></p>
<p>Blockly works OK with Mobile Web Browsers…</p>
<p><img src="https://lupyuen.github.io/images/blockly-mobile.jpg" alt="Blocky on Mobile Web Browser" /></p>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/">(Source)</a></p>
<p><em>Is Blockly available as an offline, non-web Desktop App?</em></p>
<p>Not yet. But we could package Blockly as a <strong>VSCode Extension</strong> that will turn it into a Desktop App…</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/advanced-topics-for-visual-embedded-rust-programming"><strong>Blockly Extension for VSCode</strong></a></li>
</ul>
<p>Or we might package Blockly into a <strong>Standalone App</strong> with Tauri…</p>
<ul>
<li><a href="https://tauri.app/"><strong>Tauri Desktop Bundler</strong></a></li>
</ul>
<p><em>Why would we need a Desktop App for Blockly?</em></p>
<p>It’s easier to <strong>compile the Generated Zig Code</strong> when we’re on a Desktop App.</p>
<p>And a Desktop App is more convenient for <strong>flashing the compiled code</strong> to Embedded Devices.</p>
<h1 id="iot-sensor-apps"><a href="#iot-sensor-apps">7 IoT Sensor Apps</a></h1>
<p><em>We said earlier that Blockly might be suitable for IoT Sensor Apps. Why?</em></p>
<p>Suppose we’re building an <strong>IoT Sensor Device</strong> that will monitor Temperature and Humidity.</p>
<p>The firmware in our device will periodically <strong>read and transmit the Sensor Data</strong> like this…</p>
<p><img src="https://lupyuen.github.io/images/blockly-iot.jpg" alt="IoT Sensor App" /></p>
<p>Which we might <strong>build with Blockly</strong> like so…</p>
<p><img src="https://lupyuen.github.io/images/sensor-visual.jpg" alt="Visual Programming for Zig with NuttX Sensors" /></p>
<p><em>Whoa that’s a lot to digest!</em></p>
<p>We’ll break down this IoT Sensor App in the next section.</p>
<p><em>But why build IoT Sensor Apps with Blockly and Zig?</em></p>
<ul>
<li>
<p><strong>Types are simpler:</strong> Only Floating-Point Numbers will be supported for Sensor Data</p>
<p>(No strings needed)</p>
</li>
<li>
<p><strong>Blockly is Typeless:</strong> With Zig we can use Type Inference to deduce the missing Types</p>
<p>(Doing this in C would be extremely painful)</p>
</li>
<li>
<p><strong>Easier to experiment</strong> with various IoT Sensors: Temperature, Humidity, Air Pressure, …</p>
<p>(Or mix and match a bunch of IoT Sensors!)</p>
</li>
</ul>
<p>Let’s talk about the reading and sending of Sensor Data…</p>
<h1 id="read-sensor-data"><a href="#read-sensor-data">8 Read Sensor Data</a></h1>
<p>Previously we talked about our IoT Sensor App <strong>reading Sensor Data</strong> (like Temperature) from a real sensor <a href="https://www.bosch-sensortec.com/products/environmental-sensors/humidity-sensors-bme280/">(like <strong>Bosch BME280</strong>)</a>.</p>
<p>This is how it might look in Blockly…</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/sensor-visual2.jpg" alt="Read Sensor Data in Blockly" /></p>
</blockquote>
<p>(We’ll populate Blockly with a whole bunch of <strong>Sensor Blocks</strong> like BME280)</p>
<p>And this is the Zig Code that we might auto-generate: <a href="https://github.com/lupyuen/visual-zig-nuttx/blob/visual/visual.zig#L27-L115">visual-zig-nuttx/visual/visual.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>// Read the Temperature
const temperature: f32 = blk: {

  // Open the Sensor Device
  const fd = c.open(
    &quot;/dev/uorb/sensor_baro0&quot;,  // Path of Sensor Device
    c.O_RDONLY | c.O_NONBLOCK    // Open for read-only
  );

  // Close the Sensor Device when this block returns
  defer {
    _ = c.close(fd);
  }

  // If Sensor Data is available...
  var sensor_value: f32 = undefined;
  if (c.poll(&amp;fds, 1, -1) &gt; 0) {

    // Define the Sensor Data Type
    var sensor_data = std.mem.zeroes(c.struct_sensor_event_baro);
    const len = @sizeOf(@TypeOf(sensor_data));

    // Read the Sensor Data
    if (c.read(fd, &amp;sensor_data, len) &gt;= len) {

      // Remember the Sensor Value
      sensor_value = sensor_data.temperature;
            
    } else { std.log.err(&quot;Sensor data incorrect size&quot;, .{}); }
  } else { std.log.err(&quot;Sensor data not available&quot;, .{}); }

  // Return the Sensor Value
  break :blk sensor_value;
};

// Print the Temperature
debug(&quot;temperature={}&quot;, .{
  floatToFixed(temperature)
});</code></pre></div>
<p>When we run this on <strong>Apache NuttX RTOS</strong>, it will actually fetch the Temperature from the Bosch BME280 Sensor!</p>
<p><a href="https://lupyuen.github.io/articles/sensor#read-barometer-sensor">(As explained here)</a></p>
<p><em>What a huge chunk of Zig!</em></p>
<p>The complete implementation is a huger chunk of Zig, because we need to <strong>handle Errors</strong>. <a href="https://github.com/lupyuen/visual-zig-nuttx/blob/visual/sensor.zig#L33-L109">(See this)</a></p>
<p>But it might be hunky dory for Blockly. We just need to define one Block for <strong>every Sensor</strong> supported by NuttX. (Like BME280)</p>
<p>And every Block will churn out the <strong>Boilerplate Code</strong> (plus Error Handling) that we see above.</p>
<p><em>Surely some of the code can be refactored into reusable Zig Functions?</em></p>
<p>Refactoring the code can get tricky because the <strong>Sensor Data Struct and Fields</strong> are dependent on the Sensor…</p>
<div class="example-wrap"><pre class="language-zig"><code>// Define the Sensor Data Type
// Note: `sensor_event_baro` depends on the sensor
var sensor_data = std.mem.zeroes(
  c.struct_sensor_event_baro
);
const len = @sizeOf(@TypeOf(sensor_data));

// Read the Sensor Data
if (c.read(fd, &amp;sensor_data, len) &gt;= len) {

  // Remember the Sensor Value
  // Note: `temperature` depends on the sensor
  sensor_value = sensor_data.temperature;</code></pre></div>
<p><a href="https://ziglang.org/documentation/master/#Compile-Time-Parameters">(<strong><code>comptime</code> Generics</strong> might help)</a></p>
<p><em>What’s floatToFixed?</em></p>
<div class="example-wrap"><pre class="language-zig"><code>// Read the Temperature as a Float
const temperature: f32 = ...

// Print the Temperature as a
// Fixed-Point Number (2 decimal places)
debug(&quot;temperature={}&quot;, .{
  floatToFixed(temperature)
});</code></pre></div>
<p>That’s our tidy way of printing <a href="https://en.wikipedia.org/wiki/Fixed-point_arithmetic"><strong>Fixed-Point Numbers</strong></a> (with 2 decimal places)…</p>
<div class="example-wrap"><pre class="language-text"><code>temperature=23.45</code></pre></div>
<p>Instead of the awful <code>2.34500007e+01</code> we saw earlier.</p>
<p><a href="https://lupyuen.github.io/articles/blockly#appendix-fixed-point-numbers">(More about this in the Appendix)</a></p>
<p><em>What’s <code>blk</code>?</em></p>
<p>That’s how we return a value from the <strong>Block Expression</strong>…</p>
<div class="example-wrap"><pre class="language-zig"><code>// Read the Temperature
const temperature: f32 = blk: {

  // Do something
  var fd = ...

  // Return the Sensor Value
  break :blk 23.45;
};</code></pre></div>
<p>This sets <code>temperature</code> to <code>23.45</code>.</p>
<p>Block Expressions are a great way to <strong>prevent leakage</strong> of our Local Variables (like <code>fd</code>) into the Outer Scope and <a href="https://lupyuen.github.io/articles/blockly#constants-vs-variables"><strong>avoid Shadowing</strong></a>.</p>
<p><a href="https://ziglang.org/documentation/master/#blocks">(More about Block Expressions)</a></p>
<h1 id="transmit-sensor-data"><a href="#transmit-sensor-data">9 Transmit Sensor Data</a></h1>
<p>Two sections ago we talked about our IoT Sensor App <strong>transmitting Sensor Data</strong> (like Temperature) to a Wireless IoT Network <a href="https://makezine.com/2021/05/24/go-long-with-lora-radio/">(like <strong>LoRaWAN</strong>)</a>.</p>
<p>We’ll do this in two steps…</p>
<ul>
<li>
<p><strong>Compose</strong> the Sensor Data Message</p>
<p>(Compress our Sensor Data into a tiny Data Packet)</p>
</li>
<li>
<p><strong>Transmit</strong> the Sensor Data Message</p>
<p>(Over LoRaWAN)</p>
</li>
</ul>
<p>Assume we’ve read Temperature and Humidity from our sensor.</p>
<p>This is how we shall <strong>compose a Sensor Data Message</strong> with Blockly…</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/sensor-visual3.jpg" alt="Compose Sensor Data Message in Blockly" /></p>
</blockquote>
<p>The Block above will pack the Temperature and Humidity into this format…</p>
<div class="example-wrap"><pre class="language-json"><code>{
  &quot;t&quot;: 2345,
  &quot;h&quot;: 6789
}</code></pre></div>
<p>(Numbers have been scaled up by 100)</p>
<p>Then compress it with <a href="https://lupyuen.github.io/articles/cbor2"><strong>Concise Binary Object Representation (CBOR)</strong></a>.</p>
<p><em>Why CBOR? Why not JSON?</em></p>
<p>The message above compressed with CBOR will require only <strong>11 bytes!</strong> <a href="https://lupyuen.github.io/images/blockly-cbor.jpg">(See this)</a></p>
<p>That’s 8 bytes fewer than JSON! Tiny compressed messages will work better with Low-Bandwidth Networks like LoRaWAN.</p>
<p>After composing our Sensor Data Message, we shall <strong>transmit the Sensor Data Message</strong> with Blockly…</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/sensor-visual4.jpg" alt="Transmit Sensor Data Message in Blockly" /></p>
</blockquote>
<p>This Block transmits our compressed CBOR Message to the <a href="https://makezine.com/2021/05/24/go-long-with-lora-radio/"><strong>LoRaWAN Wireless Network</strong></a>.</p>
<p><em>Will Zig talk to LoRaWAN?</em></p>
<p>Yep we’ve previously created a Zig app for LoRaWAN and Apache NuttX RTOS…</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/iot"><strong>“Build an IoT App with Zig and LoRaWAN”</strong></a></li>
</ul>
<p>We’ll reuse the code to transmit our message to LoRaWAN.</p>
<p><em>Is it OK to create Custom Blocks in Blockly? Like for “BME280 Sensor”, “Compose Message” and “Transmit Message”?</em></p>
<p>Yep here are the steps to create a <strong>Custom Block</strong> in Blockly…</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/lisp#customise-blockly-for-ulisp"><strong>“Customise Blockly”</strong></a></li>
</ul>
<p>When our Custom Blocks are done, we’re all set to create IoT Sensor Apps with Blockly!</p>
<p><img src="https://lupyuen.github.io/images/sensor-visual.jpg" alt="Visual Programming for Zig with NuttX Sensors" /></p>
<h1 id="whats-next"><a href="#whats-next">10 What’s Next</a></h1>
<p>This has been a fun experiment with Blockly. I hope we’ll extend it to make it more accessible to <strong>Zig Learners</strong>!</p>
<p>I’ll continue to customise Blockly for <strong>NuttX Sensors</strong>. Hopefully we’ll create <strong>IoT Sensor Apps</strong> the drag-n-drop way, real soon!</p>
<ul>
<li><a href="https://twitter.com/MisterTechBlog/status/1557857587667775489"><strong>Follow the updates on Twitter</strong></a></li>
</ul>
<p>Check out my earlier work on Zig, NuttX, LoRaWAN and LVGL…</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/zig"><strong>“Zig on RISC-V BL602: Quick Peek with Apache NuttX RTOS”</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/iot"><strong>“Build an IoT App with Zig and LoRaWAN”</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/lvgl"><strong>“Build an LVGL Touchscreen App with Zig”</strong></a></p>
</li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn’t have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/Zig/comments/wi57d8/zig_visual_programming_with_blockly/"><strong>Discuss this article on Reddit</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>Read “The RISC-V BL602 / BL604 Book”</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here…</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/blockly.md"><strong>lupyuen.github.io/src/blockly.md</strong></a></p>
<h1 id="notes"><a href="#notes">11 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1554650482240397312"><strong>this Twitter Thread</strong></a></li>
</ol>
<h1 id="appendix-fixed-point-numbers"><a href="#appendix-fixed-point-numbers">12 Appendix: Fixed-Point Numbers</a></h1>
<p>Earlier we talked about reading <strong>Floating-Point Sensor Data</strong> (like Temperature)…</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/blockly#read-sensor-data"><strong>“Read Sensor Data”</strong></a></li>
</ul>
<p>And we wrote this to <strong>print our Sensor Data</strong>: <a href="https://github.com/lupyuen/visual-zig-nuttx/blob/visual/visual.zig#L15-L25">visual-zig-nuttx/visual/visual.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>// Assume we&#39;ve read the Temperature as a Float
const temperature: f32 = 23.45;

// Print the Temperature as a
// Fixed-Point Number (2 decimal places)
debug(&quot;temperature={}&quot;, .{
  floatToFixed(temperature)
});</code></pre></div>
<p>This prints the Temperature correctly as…</p>
<div class="example-wrap"><pre class="language-text"><code>temperature=23.45</code></pre></div>
<p>Instead of the awful <code>2.34500007e+01</code> that we see typically with printed Floating-Point Numbers.</p>
<p><em>What’s floatToFixed?</em></p>
<p>We call <strong>floatToFixed</strong> to convert a Floating-Point Number to a <a href="https://en.wikipedia.org/wiki/Fixed-point_arithmetic"><strong>Fixed-Point Number</strong></a> (2 decimal places) for printing.</p>
<p>(We’ll see <strong>floatToFixed</strong> in a while)</p>
<p><strong>UPDATE:</strong> We no longer need to call <strong>floatToFixed</strong> when printing only one Floating-Point Number. The Debug Logger auto-converts it to Fixed-Point for us. <a href="https://github.com/lupyuen/visual-zig-nuttx/blob/main/sensortest.zig#L266-L294">(See this)</a></p>
<p><em>How do we represent Fixed-Point Numbers?</em></p>
<p>Our Fixed-Point Number has two Integer components…</p>
<ul>
<li>
<p><strong>int</strong>: The Integer part</p>
</li>
<li>
<p><strong>frac</strong>: The Fraction part, scaled by 100</p>
</li>
</ul>
<p>So to represent <code>123.456</code>, we break it down as…</p>
<ul>
<li>
<p><strong>int</strong> = <code>123</code></p>
</li>
<li>
<p><strong>frac</strong> = <code>45</code></p>
</li>
</ul>
<p>We drop the final digit <code>6</code> when we convert to Fixed-Point.</p>
<p>In Zig we define Fixed-Point Numbers as a <strong>FixedPoint Struct</strong>…</p>
<div class="example-wrap"><pre class="language-zig"><code>/// Fixed Point Number (2 decimal places)
pub const FixedPoint = struct {

  /// Integer Component
  int: i32,

  /// Fraction Component (scaled by 100)
  frac: u8,

  /// Format the output for Fixed Point Number (like 123.45)
  pub fn format(...) !void { ... }
};</code></pre></div>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx/blob/visual/sensor.zig#L54-L75">(Source)</a></p>
<p>(We’ll explain <strong>format</strong> in a while)</p>
<p><em>How do we convert Floating-Point to Fixed-Point?</em></p>
<p>Below is the implementation of <strong>floatToFixed</strong>, which receives a Floating-Point Number and returns the Fixed-Point Number (as a Struct): <a href="https://github.com/lupyuen/visual-zig-nuttx/blob/visual/sensor.zig#L39-L49">visual-zig-nuttx/visual/sensor.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// Convert the float to a fixed-point number (`int`.`frac`) with 2 decimal places.
/// We do this because `debug` has a problem with floats.
pub fn floatToFixed(f: f32) FixedPoint {
  const scaled = @floatToInt(i32, f * 100.0);
  const rem = @rem(scaled, 100);
  const rem_abs = if (rem &lt; 0) -rem else rem;
  return .{
    .int  = @divTrunc(scaled, 100),
    .frac = @intCast(u8, rem_abs),
  };
}</code></pre></div>
<p>(See the docs: <a href="https://ziglang.org/documentation/master/#floatToInt"><strong>@floatToInt</strong></a>, <a href="https://ziglang.org/documentation/master/#rem"><strong>@rem</strong></a>, <a href="https://ziglang.org/documentation/master/#divTrunc"><strong>@divTrunc</strong></a>, <a href="https://ziglang.org/documentation/master/#intCast"><strong>@intCast</strong></a>)</p>
<p>This code has been tested for positive and negative numbers.</p>
<p><em>Why handle Sensor Data as Fixed-Point Numbers? Why not Floating-Point?</em></p>
<p>When we tried printing the Sensor Data as Floating-Point Numbers, we hit some <strong>Linking and Runtime Issues</strong>…</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx#fix-floating-point-values"><strong>“Fix Floating-Point Values”</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx#floating-point-link-error"><strong>“Floating-Point Link Error”</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx#fixed-point-printing"><strong>“Fixed-Point Printing”</strong></a></p>
</li>
</ul>
<p>Computations on Floating-Point Numbers are OK, only printing is affected. So we print the numbers as Fixed-Point instead.</p>
<p>(We observed these issues with Zig Compiler version 0.10.0, they might have been fixed in later versions of the compiler)</p>
<p><em>Isn’t our Sensor Data less precise in Fixed-Point?</em></p>
<p>Yep we lose some precision with Fixed-Point Numbers. (Like the final digit <code>6</code> from earlier)</p>
<p>But most IoT Gadgets will <strong>truncate Sensor Data</strong> before transmission anyway.</p>
<p>And for some data formats (like CBOR), we need <strong>fewer bytes</strong> to transmit Fixed-Point Numbers instead of Floating-Point…</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/cbor2#floating-point-numbers"><strong>“Floating-Point Numbers (CBOR)”</strong></a></li>
</ul>
<p>Thus we’ll probably stick to Fixed-Point Numbers for our upcoming IoT projects.</p>
<p><em>How do we print Fixed-Point Numbers?</em></p>
<p>This works OK for printing Fixed-Point Numbers…</p>
<div class="example-wrap"><pre class="language-zig"><code>// Print the Temperature as a
// Fixed-Point Number (2 decimal places)
debug(&quot;temperature={}&quot;, .{
  floatToFixed(temperature)
});</code></pre></div>
<p>Because our Fixed-Point Struct includes a <a href="https://ziglearn.org/chapter-2/#formatting"><strong>Custom Formatter</strong></a>…</p>
<div class="example-wrap"><pre class="language-zig"><code>/// Fixed Point Number (2 decimal places)
pub const FixedPoint = struct {

  /// Integer Component
  int: i32,

  /// Fraction Component (scaled by 100)
  frac: u8,

  /// Format the output for Fixed Point Number (like 123.45)
  pub fn format(
    self: FixedPoint,
    comptime fmt: []const u8,
    options: std.fmt.FormatOptions,
    writer: anytype,
  ) !void {
    _ = fmt;
    _ = options;
    try writer.print(&quot;{}.{:0&gt;2}&quot;, .{
      self.int, 
      self.frac 
    });
  }
};</code></pre></div>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx/blob/visual/sensor.zig#L54-L75">(Source)</a></p>
<p><em>Why print the numbers as “<code>{}.{:0&gt;2}</code>”?</em></p>
<p>Our Format String “<code>{}.{:0&gt;2}</code>” says…</p>
<div><table><thead><tr><th style="text-align: center"></th><th style="text-align: left"></th></tr></thead><tbody>
<tr><td style="text-align: center"><code>{}</code></td><td style="text-align: left">Print <strong>int</strong> as a number</td></tr>
<tr><td style="text-align: center"><code>.</code></td><td style="text-align: left">Print <code>.</code></td></tr>
<tr><td style="text-align: center"><code>{:0&gt;2}</code></td><td style="text-align: left">Print <strong>frac</strong> as a 2-digit number, padded at the left by <code>0</code></td></tr>
</tbody></table>
</div>
<p>Which gives us the printed output <code>123.45</code></p>
<h1 id="appendix-add-a-zig-tab"><a href="#appendix-add-a-zig-tab">13 Appendix: Add a Zig Tab</a></h1>
<p>This section explains how we added the Zig Tab to Blockly.</p>
<p>Blockly is bundled with a list of Demos…</p>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/">lupyuen3.github.io/blockly-zig-nuttx/demos</a></p>
<p>There’s a <strong>Code Generation Demo</strong> that shows the code generated by Blockly for JavaScript, Python, Dart, …</p>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/">lupyuen3.github.io/blockly-zig-nuttx/demos/code</a></p>
<p>Let’s add a <strong>Zig Tab</strong> that will show the Zig code generated by Blockly: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/demos/code/index.html">demos/code/index.html</a></p>
<div class="example-wrap"><pre class="language-html"><code>&lt;!--  Inserted this to Load Messages: (Not sure why)  --&gt;
&lt;script src=&quot;../../msg/messages.js&quot;&gt;&lt;/script&gt;
...
&lt;tr id=&quot;tabRow&quot; height=&quot;1em&quot;&gt;
  &lt;td id=&quot;tab_blocks&quot; class=&quot;tabon&quot;&gt;...&lt;/td&gt;
  &lt;td class=&quot;tabmin tab_collapse&quot;&gt;&amp;nbsp;&lt;/td&gt;
  &lt;!-- Inserted these two lines: --&gt;
  &lt;td id=&quot;tab_zig&quot; class=&quot;taboff tab_collapse&quot;&gt;Zig&lt;/td&gt;
  &lt;td class=&quot;tabmin tab_collapse&quot;&gt;&amp;nbsp;&lt;/td&gt;
...
&lt;div id=&quot;content_blocks&quot; class=&quot;content&quot;&gt;&lt;/div&gt;
&lt;!-- Inserted this line: --&gt;
&lt;pre id=&quot;content_zig&quot; class=&quot;content prettyprint lang-zig&quot;&gt;&lt;/pre&gt;</code></pre></div>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-dcf2ffe98d7d8b4a0dd7b9f769557dbe8c9e0e726236ef229def25c956a43d8f">(See the changes)</a></p>
<p>We’ll see the Zig Tab like this…</p>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/">lupyuen3.github.io/blockly-zig-nuttx/demos/code</a></p>
<p><img src="https://lupyuen.github.io/images/blockly-run3a.png" alt="Zig Tab in Blockly" /></p>
<p>Let’s generate the Zig code…</p>
<h1 id="appendix-zig-code-generator"><a href="#appendix-zig-code-generator">14 Appendix: Zig Code Generator</a></h1>
<p>Blockly comes bundled with Code Generators for JavaScript, Python, Dart, …</p>
<p>Let’s create a <strong>Code Generator for Zig</strong>, by copying from the Dart Code Generator.</p>
<p>Copy <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/dart.js">generators/dart.js</a> to <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig.js">generators/zig.js</a></p>
<p>Copy all files from <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/dart">generators/dart</a> to <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig">generators/zig</a>…</p>
<div class="example-wrap"><pre class="language-text"><code>all.js
colour.js
lists.js
logic.js
loops.js
math.js
procedures.js
text.js
variables.js  
variables_dynamic.js</code></pre></div>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/commit/ba968942c6ee55937ca554e1d290d8d563fa0b78">(See the copied files)</a></p>
<p>Edit <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/dart.js">generators/zig.js</a> and all files in <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig">generators/zig</a>.</p>
<p>Change all “<code>Dart</code>” to “<code>Zig</code>”, remember to <strong>preserve case</strong>.</p>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/commit/efe185d6cac4306dcdc6b6a5f261b331bb992976">(See the changes)</a></p>
<p>This is how we load our Code Generator…</p>
<h1 id="appendix-load-code-generator"><a href="#appendix-load-code-generator">15 Appendix: Load Code Generator</a></h1>
<p>Let’s <strong>load our Zig Code Generator</strong> in Blockly…</p>
<p>Add the Zig Code Generator to <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/demos/code/index.html">demos/code/index.html</a>…</p>
<div class="example-wrap"><pre class="language-html"><code>&lt;!--  Load Zig Code Generator  --&gt;
&lt;script src=&quot;../../zig_compressed.js&quot;&gt;&lt;/script&gt;</code></pre></div>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-dcf2ffe98d7d8b4a0dd7b9f769557dbe8c9e0e726236ef229def25c956a43d8f">(See the changes)</a></p>
<p>Enable the Zig Code Generator in <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/demos/code/code.js">demos/code/code.js</a>…</p>
<div class="example-wrap"><pre class="language-javascript"><code>// Inserted `zig`...
Code.TABS_ = [
  &#39;blocks&#39;, &#39;zig&#39;, &#39;javascript&#39;, &#39;php&#39;, &#39;python&#39;, &#39;dart&#39;, &#39;lua&#39;, &#39;xml&#39;, &#39;json&#39;
];
...
// Inserted `Zig`...
Code.TABS_DISPLAY_ = [
  &#39;Blocks&#39;, &#39;Zig&#39;, &#39;JavaScript&#39;, &#39;PHP&#39;, &#39;Python&#39;, &#39;Dart&#39;, &#39;Lua&#39;, &#39;XML&#39;, &#39;JSON&#39;
];
...
Code.renderContent = function() {
  ...
  } else if (content.id === &#39;content_json&#39;) {
    var jsonTextarea = document.getElementById(&#39;content_json&#39;);
    jsonTextarea.value = JSON.stringify(
        Blockly.serialization.workspaces.save(Code.workspace), null, 2);
    jsonTextarea.focus();
  // Inserted this...
  } else if (content.id == &#39;content_zig&#39;) {
    Code.attemptCodeGeneration(Blockly.Zig);</code></pre></div>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-d72873b861dee958e5d443c919726dd856de594bd56b1e73d8948a7719163553">(See the changes)</a></p>
<p>Add our Code Generator to the Build Task: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/scripts/gulpfiles/build_tasks.js#L98-L139">scripts/gulpfiles/build_tasks.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code> const chunks = [
   // Added this...
   {
      name: &#39;zig&#39;,
      entry: &#39;generators/zig/all.js&#39;,
      reexport: &#39;Blockly.Zig&#39;,
   }
 ];</code></pre></div>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-a9a5784f43ce15ca76bb3e99eb6625c3ea15381e20eac6f7527ecbcb2945ac14">(See the changes)</a></p>
<p>Now we compile our Zig Code Generator…</p>
<h1 id="appendix-build-blockly"><a href="#appendix-build-blockly">16 Appendix: Build Blockly</a></h1>
<p>Blockly builds fine with Linux, macOS and WSL. (But not plain old Windows CMD)</p>
<p>To build Blockly with the Zig Code Generator…</p>
<div class="example-wrap"><pre class="language-bash"><code># Download Blockly and install the dependencies
git clone --recursive https://github.com/lupyuen3/blockly-zig-nuttx
cd blockly-zig-nuttx
npm install

# Build Blockly and the Code Generators.
# Run these steps when we change the Zig Code Generator.
npm run build
npm run publish

# When prompted &quot;Is this the correct branch?&quot;,
# press N

# Instead of &quot;npm run publish&quot; (which can be slow), we may do this...
# cp build/*compressed* .

# For WSL: We can copy the generated files to c:\blockly-zig-nuttx for testing on Windows
# cp *compressed*      /mnt/c/blockly-zig-nuttx
# cp demos/code/*.*    /mnt/c/blockly-zig-nuttx/demos/code
# cp generators/zig.js /mnt/c/blockly-zig-nuttx/generators
# cp generators/zig/*  /mnt/c/blockly-zig-nuttx/generators/zig</code></pre></div>
<p>This compiles and updates the Zig Code Generator in <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/zig_compressed.js">zig_compressed.js</a> and <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/zig_compressed.js.map">zig_compressed.js.map</a></p>
<p>If we’re using VSCode, here’s the Build Task: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/.vscode/tasks.json">.vscode/tasks.json</a></p>
<p>Finally we test our compiled Code Generator…</p>
<h1 id="appendix-test-blockly"><a href="#appendix-test-blockly">17 Appendix: Test Blockly</a></h1>
<p>Browse to <strong>blockly-zig-nuttx/demos/code</strong> with a Local Web Server. <a href="https://chrome.google.com/webstore/detail/web-server-for-chrome/ofhbbkphhbklhfoeikjpcbhemlocgigb/">(Like Web Server for Chrome)</a></p>
<p>We should see this…</p>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/">lupyuen3.github.io/blockly-zig-nuttx/demos/code</a></p>
<p><img src="https://lupyuen.github.io/images/blockly-run3a.png" alt="Zig Tab in Blockly" /></p>
<p>Blockly will NOT render correctly with <strong>file://…</strong>, it must be <strong>http://localhost:port/…</strong></p>
<p>Drag-and-drop some Blocks and click the <strong>Zig Tab.</strong></p>
<p>The Zig Tab now shows the generated code in Zig.</p>
<p>Some of the generated code might appear as Dart (instead of Zig) because we haven’t completely converted our Code Generator from Dart to Zig.</p>
<p>In case of problems, check the <strong>JavaScript Console</strong>. (Ignore the <strong>storage.js</strong> error)</p>
<p><em>Can we save the Blocks? So we don’t need to drag them again when retesting?</em></p>
<p>Click the <strong>JSON Tab</strong> and copy the Blockly JSON that appears.</p>
<p>Whenever we rebuild Blockly and reload the site, just paste the Blockly JSON back into the JSON Tab. The Blocks will be automagically restored.</p>

    
</body>
</html>