<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="/_static/css/banner-styles.css?v=bsmaklHF" />
  <link rel="stylesheet" type="text/css" href="/_static/css/iconochive.css?v=qtvMKcIJ" />
  <link rel="canonical" href="https://lupyuen.org/articles/build-your-iot-sensor-network-stm32-blue-pill-nrf24l01-esp8266-apache-mynewt-thethings-io.html" />
  <!-- End Wayback Rewrite JS Include -->
  <title data-rh="true">Build Your IoT Sensor Network — STM32 Blue Pill + nRF24L01 + ESP8266 + Apache Mynewt +
    thethings.io</title>
  <meta data-rh="true" charset="utf-8" />
  <meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
  <meta data-rh="true" name="theme-color" content="#000000" />
  <meta data-rh="true" property="og:type" content="article" />
  <meta data-rh="true" property="article:published_time" content="2019-07-25T18:15:14.138Z" />
  <meta data-rh="true" name="title"
    content="Build Your IoT Sensor Network — STM32 Blue Pill + nRF24L01 + ESP8266 + Apache Mynewt + thethings.io" />
  <meta data-rh="true" property="og:title"
    content="Build Your IoT Sensor Network — STM32 Blue Pill + nRF24L01 + ESP8266 + Apache Mynewt + thethings.io" />
  <meta data-rh="true" property="twitter:title"
    content="Build Your IoT Sensor Network — STM32 Blue Pill + nRF24L01 + ESP8266 + Apache Mynewt + thethings.io" />
  <meta data-rh="true" name="description"
    content="Learn to build a Sensor Network that routes sensor data from the nRF24L01 local network to the ESP8266 WiFi network" />
  <meta data-rh="true" property="og:description"
    content="Learn to build a Sensor Network that routes sensor data from the nRF24L01 local network to the ESP8266 WiFi network" />
  <meta data-rh="true" property="twitter:description"
    content="Learn to build a Sensor Network that routes sensor data from the nRF24L01 local network to the ESP8266 WiFi network" />
  <meta data-rh="true" name="twitter:card" content="summary_large_image" />
  <meta data-rh="true" name="twitter:creator" content="@MisterTechBlog" />
  <meta data-rh="true" name="author" content="Lup Yuen Lee 李立源" />
  <meta data-rh="true" name="robots" content="index,follow" />
  <meta data-rh="true" name="referrer" content="unsafe-url" />
  <meta data-rh="true" name="twitter:label1" value="Reading time" />
  <meta data-rh="true" name="twitter:data1" value="18 min read" />
  <meta property="og:image" 
  content="https://lupyuen.github.io/images/legacy2/f1.png">

<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">

<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->

</head>

<body>
  <div id="root">
    <div class="a b c">
      <article>
        <section class="cj ck cl cm ak cn ce n co"></section><span class="r"></span>
        <div>
          <div class="cp u cq cr cs ct"></div>
          <section class="cu cv cw cx cy">
            <div class="cz">
              <div class="n p">
                <div class="da db dc dd de df ag dg ah dh aj ak">
                  <div class="figure dj dk dl dm dn cz do dp paragraph-image">

                
                    <p><img src="https://lupyuen.github.io/images/legacy2/f1.png" /></p>



                    <figcaption><p><em>Mythical sonorous creature for belly
                      illustration purpose only. Not required for implementation. Do not attempt to catch!</em></p></figcaption>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <div>
                  <div id="dffd" class="ep eq er bk es b et eu ev ew ex ey ez">
                    <h1 class="es b et fa er">Build Your IoT Sensor Network — STM32 Blue Pill + nRF24L01 + ESP8266 +
                      Apache Mynewt + thethings.io</h1>
                  </div>
                  <div class="fb">
                    <div class="n fc fd fe ff">
                      <div class="o n">
                        <div><a rel="noopener"
                            href="https://lupyuen.github.io">
                            <div class="ds fg fh">
                              <div class="bs n fi o p cp fj fk fl fm fn ct"></div>
                              

                            </div>
                          </a></div>
                        <div class="fp ak r">
                          <div class="n">
                            <div style="flex:1"><span class="bj b bk bl bm bn r er q">
                                <div class="fq n o fr"><span class="bj en eh bl dx fs ft fu fv fw er"><a
                                      class="at au av aw ax ay az ba bb bc fx bf bg bh bi" rel="noopener"
                                      href="https://lupyuen.github.io">Lup
                                      Yuen Lee 李立源</a></span>
                                 
                                </div>
                              </span></div>
                          </div><span class="bj b bk bl bm bn r bo bp"><span class="bj en eh bl dx fs ft fu fv fw bo">
                              <div><a class="at au av aw ax ay az ba bb bc fx bf bg bh bi" rel="noopener"
                                  href="https://lupyuen.github.io/articles/build-your-iot-sensor-network-stm32-blue-pill-nrf24l01-esp8266-apache-mynewt-thethings-io">
                                  27 May 2019</a> <!-- -->·
                                <!-- -->
                                <!-- -->18
                                <!-- --> min read
                              </div>
                            </span></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <p id="e5a2" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj hk"><span
                    class="r hl hm hn ho hp hq hr hs ht ds">L</span><strong class="gy hu"><em class="hv">aw of
                      Thermospatiality</em></strong><em class="hv">: Air-conditioning always feels </em><strong
                    class="gy hu"><em class="hv">too warm</em></strong><em class="hv"> AND </em><strong
                    class="gy hu"><em class="hv">too cold </em></strong><em class="hv">by </em><strong class="gy hu"><em
                      class="hv">different individuals</em></strong><em class="hv"> in a sizeable room</em></p>
                <div class="figure hx hy hz ia ib cz eg ic cd id hl ie if ig ba ih ii ij ik il im paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/f2.png" /></p>

             
                  <figcaption><p><em>Law of Thermospatiality in action</em></p></figcaption>
                </div>
                <p id="93a4" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">It’s impossible to get <strong
                    class="gy hu">perfect air-conditioning</strong> in any room… But we can try! We begin by installing
                  <strong class="gy hu">5 temperature sensors</strong> around our living room (to monitor the actual
                  temperature at 5 different spots).</p>
                <p id="6f5a" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">We’ll call them the <strong
                    class="gy hu">5 Sensor Nodes</strong>. Each Sensor Node will be an <a
                    href="http://wiki.stm32duino.com/index.php?title=Blue_Pill"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">STM32 Blue
                      Pill</strong></a> with a temperature sensor.</p>
                <p id="6029" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Running cables through the living
                  room is out of the question, so our Blue Pills will have to <strong class="gy hu">connect
                    wirelessly</strong> to transmit the temperature data. Perhaps with an <a
                    href="https://www.espressif.com/en/products/hardware/esp8266ex/overview"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">ESP8266
                      WiFi</strong></a> module?</p>
                <p id="0ddc" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">But each Sensor Node is only
                  doing a <strong class="gy hu">dead simple</strong> job… 1️⃣ Read the temperature sensor 2️⃣ Transmit
                  the temperature value. Do we really need an <a class="at cg io ip iq ir" target="_blank"
                    rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-esp8266-with-apache-mynewt">ESP8266
                    with the <strong class="gy hu">whole CoAP + UDP + IP stack</strong></a>? (Don’t forget: we need to
                  configure each ESP8266 with WiFi MAC Address security in case somebody spoofs our Sensor Nodes and
                  breaks into our home WiFi)</p>
                <p id="b08b" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The <a
                    href="https://www.sparkfun.com/datasheets/Components/nRF24L01_prelim_prod_spec_1_2.pdf"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">Nordic
                      Semiconductor nRF24L01</strong></a><strong class="gy hu"> wireless transceiver</strong> is perfect
                  for this scenario. Each Blue Pill transmits the temperature data via the nRF24L01 module to a simple
                  <strong class="gy hu">2.4 GHz Sensor Network</strong>, without any WiFi / IP / UDP protocol overheads.
                </p>
                <p id="bcd0" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">To bridge the 5 Sensor Nodes to a
                  proper IoT CoAP Server (like <a
                    href="https://thethings.io/" class="at cg io ip iq ir"
                    target="_blank" rel="noopener nofollow">thethings.io</a>), we use a Blue Pill running as a <strong
                    class="gy hu">Collector Node.</strong> It collects temperature data from Sensor Nodes via nRF24L01,
                  and transmits the data to the CoAP Server. That way, <strong class="gy hu">only ONE node</strong>
                  needs the ESP8266 and the entire CoAP + UDP + IP stack (and the WiFi security).</p>
              </div>
            </div>
            <div class="cz">
              <div class="n p">
                <div class="da db dc dd de df ag dg ah dh aj ak">
                  <div class="figure hx hy hz ia ib cz do dp paragraph-image">
                
                    <p><img src="https://lupyuen.github.io/images/legacy2/f3.png" /></p>

                 
                    <figcaption><p><em>Our Sensor Network: 5 Sensor Nodes
                      (nRF24L01) and 1 Collector Node (nRF24L01 + ESP8266 WiFi)</em></p></figcaption>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <p id="c5f7" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">With this Sensor Network design,
                  we <strong class="gy hu">keep the Sensor Nodes dead simple</strong>, and push the complex embedded
                  software to the Collector Node, for easier <strong class="gy hu">troubleshooting and
                    upgrading</strong>. If we upgrade to the <strong class="gy hu">nRF24L01+ with RF power
                    amplifier</strong>, the Sensor Nodes can be as far as <strong class="gy hu">1 kilometre
                    away</strong> from the Collector Node! (Subject to various conditions of course)</p>
                <p id="d8e0" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">In this tutorial we’ll learn to
                  <strong class="gy hu">set up this Sensor Network</strong> (refer to the diagram)…</p>
                <p id="8781" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ One Blue Pill shall serve as
                  the <strong class="gy hu">Sensor Node</strong>. Via the <strong class="gy hu">nRF24L01
                    network</strong>, the Sensor Node <strong class="gy hu">transmits the Temperature Sensor
                    value</strong> every 10 seconds to another Blue Pill, the <strong class="gy hu">Collector
                    Node</strong>.</p>
                <p id="977c" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ Another Blue Pill shall serve
                  as the <strong class="gy hu">Collector Node</strong>. Via the nRF24L01 network, the Collector Node
                  shall receive the Temperature Sensor value from the Sensor Node.</p>
                <p id="f960" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">3️⃣ Via the <strong
                    class="gy hu">ESP8266 WiFi network</strong>, the Collector Node shall transmit the Temperature
                  Sensor value to the <strong class="gy hu">CoAP Server at thethings.io</strong>. So that the sensor
                  data may be transformed, recorded and visualised at thethings.io.</p>
                <p id="2109" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">By the end of the tutorial, we’ll
                  have a Sensor Network like this running on two Blue Pills with nRF24L01 and ESP8266…</p>
              </div>
            </div>
            <div class="cz">
              <div class="n p">
                <div class="da db dc dd de df ag dg ah dh aj ak">
                  <div class="figure hx hy hz ia ib cz">
                   
                    <figcaption><p><em>Demo of Sensor Network with two Blue Pills
                      with nRF24L01 and ESP8266</em></p></figcaption>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <blockquote class="iv iw ix">
                  <p id="9603" class="gw gx er hv gy b gz ha hb hc hd he hf hg hh hi hj"><em class="bk">💎</em> <em
                      class="bk">Sections marked with a diamond are meant for advanced developers. If you’re new to
                      embedded programming, you may skip these sections</em></p>
                </blockquote>
              </div>
            </div>
          </section>
          <hr class="iy en iz ja jb ek jc jd je jf jg" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <h1 id="1516" class="jh ji er bk bj jj jk jl jm jn jo jp jq jr js jt ju">Connect the Hardware</h1>
                <p id="fc0a" class="gw gx er bk gy b gz jv hb jw hd jx hf jy hh jz hj">We’ll need the following hardware
                  for <strong class="gy hu">one Collector Node</strong> and <strong class="gy hu">one Sensor
                    Node</strong>…</p>
                <p id="c5ba" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ <strong class="gy hu">Two
                  </strong><a
                    href="http://wiki.stm32duino.com/index.php?title=Blue_Pill"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">Blue
                      Pills</strong></a>, or two <a class="at cg io ip iq ir" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/super-blue-pill-like-stm32-blue-pill-but-better"><strong
                      class="gy hu">Super Blue Pills</strong></a> which have onboard connectors for ESP8266 and
                  nRF24L01…</p>
                <div class="dj dk dl dm dn ka"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/super-blue-pill-like-stm32-blue-pill-but-better">
                    <section class="kd cl cm ak ce n ar ke kf kg kh ki kj kk kl km kn ko kp kq kr ks">
                      <div class="kt n co p ku kv">
                        <h2 class="bj jj kw bl er">
                          <div class="dx kb ft fu kc fw">Super Blue Pill — Like STM32 Blue Pill, But Better!</div>
                        </h2>
                      </div>
                      <div class="kz r">
                        <div class="la r lb lc ld kz le lf lg"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="cca4" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ <strong class="gy hu">Two
                    ST-Link V2 USB Adapters </strong>(<a
                    href="https://www.lazada.sg/-i105322107-s106873847.html?urlFlag=true&amp;mp=1"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">or compatible</a>) for connecting
                  the (Super) Blue Pills to your computers. Check <a class="at cg io ip iq ir" target="_blank"
                    rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-esp8266-with-apache-mynewt">the
                    previous article</a> for the instructions on connecting the (Super) Blue Pills to ST-Link V2. (Look
                  for the <a
                    href="https://cdn-images-1.medium.com/max/1120/1*XC9f49KW9neBDa762pfTTQ.png"
                    class="at cg io ip iq ir" target="_blank" rel="noopener">ST-Link V2 photo</a>)</p>
                <p id="5edb" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">3️⃣ <strong class="gy hu">Two
                    Computers </strong>(Windows 10 or macOS)<strong class="gy hu"> </strong>for debugging the two
                  (Super) Blue Pills</p>
                <p id="39cb" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">4️⃣ <strong class="gy hu">One
                    ESP8266 WiFi module</strong>. I tested with the <a
                    href="https://www.lazada.sg/-i281003794-s442063247.html?urlFlag=true&amp;mp=1&amp;spm=spm=a2o42.order_details.item_title.1"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">ESP-01S</a>.</p>
                <p id="19fd" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">5️⃣ <strong class="gy hu">Two
                    nRF24L01 RF modules</strong>. I used the <a
                    href="https://www.lazada.sg/-i288146861-s465579095.html?urlFlag=true&amp;mp=1"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">nRF24L01+</a>, which includes an
                  RF power amplifier for longer range (up to 1 km).</p>
                <div class="figure hx hy hz ia ib cz eg ic cd id hl ie if ig ba ih ii ij ik il im paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/f4.jpeg" /></p>

                
                  <figcaption><p><em>Super Blue Pill with ESP8266 (left) and
                    nRF24L01 (right)</em></p></figcaption>
                </div>
                <p id="fce7" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><strong class="gy hu"><em
                      class="hv">If you have two Super Blue Pills…</em></strong></p>
                <p id="fe9b" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><strong class="gy hu">Collector
                    Node</strong>: Plug both <strong class="gy hu">ESP8266 </strong>and <strong class="gy hu">nRF24L01
                  </strong>modules into the onboard connectors of a Super Blue Pill.</p>
                <p id="eb3b" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><strong class="gy hu">Sensor
                    Node</strong>: Plug the <strong class="gy hu">nRF24L01</strong> module into the onboard connector of
                  the other Super Blue Pill.</p>
                <div class="figure hx hy hz ia ib cz cl cm paragraph-image">
                

                
                  <p><img src="https://lupyuen.github.io/images/legacy2/h0.png" /></p>

             
                <div class="figure ej cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">

                  <p><script src="https://gist.github.com/lupyuen/2eff9acb902ab2e00e1097d7de2b7187.js"></script></p>


                  <figcaption><p><em>Connect Blue Pill to ESP8266</em></p></figcaption>
                </div>
                <div class="figure lq cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
        
                  <p><script src="https://gist.github.com/lupyuen/570bd8b42471c052c4a7e2059c03092f.js"></script></p>


                  <figcaption><p><em>Connect Blue Pill to nRF24L01</em></p></figcaption>
                </div>
                <p id="e239" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><strong class="gy hu"><em
                      class="hv">If you have two older Blue Pills…</em></strong></p>
                <p id="eb70" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><strong class="gy hu">Collector
                    Node</strong>: Using a breadboard, connect a Blue Pill to the <strong class="gy hu">ESP8266</strong>
                  and <strong class="gy hu">nRF24L01</strong> modules as shown.</p>
                <p id="7725" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><strong class="gy hu">Sensor
                    Node</strong>: Using a breadboard, connect the other Blue Pill to the <strong
                    class="gy hu">nRF24L01</strong> module as shown.</p>
              </div>
            </div>
          </section>
          <hr class="iy en iz ja jb ek jc jd je jf jg" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <h1 id="19ba" class="jh ji er bk bj jj jk jl jm jn jo jp jq jr js jt ju">Download, Configure, Build and
                  Run</h1>
                <p id="5dbb" class="gw gx er bk gy b gz jv hb jw hd jx hf jy hh jz hj">On <strong class="gy hu">both
                    computers</strong>, follow the instructions in <a class="at cg io ip iq ir" target="_blank"
                    rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-esp8266-with-apache-mynewt">the
                    previous tutorial</a> under the sections below to download, configure, build and run the Blue Pill
                  application…</p>
                <p id="dae5" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ Section <em
                    class="hv">“</em><strong class="gy hu"><em class="hv">Download Source Code</em></strong><em
                    class="hv">” </em>of <a class="at cg io ip iq ir" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-esp8266-with-apache-mynewt">the
                    previous tutorial</a>. If you have previously downloaded <code
                    class="eb lr ls lt lu b">stm32bluepill-mynewt-sensor</code><strong class="gy hu">, </strong>rename
                  the old folder before downloading.</p>
                <p id="2283" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ Section <em
                    class="hv">“</em><strong class="gy hu"><em class="hv">Configure WiFi Settings</em></strong><em
                    class="hv">” </em>of <a class="at cg io ip iq ir" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-esp8266-with-apache-mynewt">the
                    previous tutorial</a></p>
                <p id="d21f" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">3️⃣ Section <em
                    class="hv">“</em><strong class="gy hu"><em class="hv">Build The Application</em></strong><em
                    class="hv">” </em>of <a class="at cg io ip iq ir" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-esp8266-with-apache-mynewt">the
                    previous tutorial</a></p>
                <p id="750b" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">4️⃣ Section <em
                    class="hv">“</em><strong class="gy hu"><em class="hv">Run The Application</em></strong><em
                    class="hv">” </em>of <a class="at cg io ip iq ir" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-esp8266-with-apache-mynewt">the
                    previous tutorial</a></p>
                <p id="c504" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">When the Collector Node and
                  Sensor Node are communicating correctly, you should see messages like these…</p>
                <p id="b593" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/logs/collector-node.log"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Sample log for <strong
                      class="gy hu">Collector Node</strong></a></p>
                <p id="d3d5" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/logs/sensor-node.log"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Sample log for <strong
                      class="gy hu">Sensor Node</strong></a></p>
                <p id="b5e6" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">However the Collector and Sensor
                  Nodes won’t operate correctly yet… There’s a list of <strong class="gy hu">Hardware IDs that you need
                    to populate in the settings file</strong>, due to the way network addresses are allocated in
                  nRF24L01 networks. Read on to learn more…</p>
              </div>
            </div>
          </section>
          <hr class="iy en iz ja jb ek jc jd je jf jg" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <h1 id="089e" class="jh ji er bk bj jj jk jl jm jn jo jp jq jr js jt ju">Sensor Network Addresses</h1>
                <p id="bde3" class="gw gx er bk gy b gz jv hb jw hd jx hf jy hh jz hj">Unlike complicated WiFi networks
                  that dynamically allocate IP addresses, nRF24L01 networks are so simple that we need to <strong
                    class="gy hu">allocate the addresses ourselves</strong>.</p>
                <p id="0f93" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><em class="hv">How does the
                    Collector Node know which Sensor Node sent the temperature data?</em> Each Sensor Node is
                  distinguished from the other 4 Sensor Nodes by an <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L66-L74"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">8-bit
                      address that we allocate to each Sensor Node</strong></a>. For the demo we’re using these
                  addresses (in hexadecimal) for the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L77-L91"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">5 Sensor Nodes</a> (derived from
                  the <a
                    href="https://www.sparkfun.com/datasheets/Components/nRF24L01_prelim_prod_spec_1_2.pdf"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">sample configuration in the
                    datasheet</a>)…</p>
                <pre
                  class="hx hy hz ia ib lv lw lx"><span id="05b8" class="ly ji er bk lu b eh lz ma r mb">Sensor Node Addresses (last byte): F1, CD, A3, 0F and 05</span></pre>
                <blockquote class="iv iw ix">
                  <p id="89db" class="gw gx er hv gy b gz ha hb hc hd he hf hg hh hi hj"><em class="bk">💎 </em>nRF24L01
                    operates in the crowded licence-free 2.4 GHz frequency band (shared with WiFi, Bluetooth and
                    microwave ovens). The above 5 bytes, which contain as many different bits as possible, were chosen
                    so that we could detect (and reject) packet addresses that have been corrupted due to RF
                    interference.</p>
                </blockquote>
                <p id="21f2" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><em class="hv">What if our
                    neighbour decides to set up their own nRF24L01 Sensor Network?</em> To prevent address collisions,
                  we distinguish each Sensor Network by allocating a <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L57-L62"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">unique
                      32-bit (4-byte) network address</strong></a>. For the demo we’re using <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L74-L76"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">this network address</a>…</p>
                <pre
                  class="hx hy hz ia ib lv lw lx"><span id="9e62" class="ly ji er bk lu b eh lz ma r mb">Sensor Network Address (four bytes): B3-B4-B5-B6</span></pre>
                <p id="82bf" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">When we combine the Sensor
                  Network Address with the Sensor Node Address, we get <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L63-L74"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">5 unique node address</a>, each
                  containing 5 bytes…</p>
                <pre
                  class="hx hy hz ia ib lv lw lx"><span id="67ea" class="ly ji er bk lu b eh lz ma r mb">Sensor Node 1 Full Address: B3-B4-B5-B6-F1<br/>Sensor Node 2 Full Address: B3-B4-B5-B6-CD<br/>Sensor Node 3 Full Address: B3-B4-B5-B6-A3<br/>Sensor Node 4 Full Address: B3-B4-B5-B6-0F<br/>Sensor Node 5 Full Address: B3-B4-B5-B6-05</span></pre>
                <p id="3bcc" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Which we may interpret as the 5
                  statically-allocated “IP Addresses” for each Sensor Node in our nRF24L01 network.</p>
              </div>
            </div>
            <div class="cz">
              <div class="n p">
                <div class="da db dc dd de df ag dg ah dh aj ak">
                  <div class="figure hx hy hz ia ib cz do dp paragraph-image">
                
                    <p><img src="https://lupyuen.github.io/images/legacy2/f5.png" /></p>

            
                    <figcaption><p><em>Collector and Sensor Node Addresses
                    </em></p></figcaption>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <p id="d23b" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><em class="hv">What about the
                    Collector Node?</em> We’re free to allocate any unique <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L57-L62"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">5-byte node address</a>. (No need
                  to share the same 4 bytes of the Sensor Network Address as the other nodes) <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L71-L73"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">For the demo</a>, we’re using…</p>
                <pre
                  class="hx hy hz ia ib lv lw lx"><span id="d89e" class="ly ji er bk lu b eh lz ma r mb">Collector Node Address (five bytes): 78-78-78-78-78</span></pre>
                <div class="figure hx hy hz ia ib cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
        
                  <p><script src="https://gist.github.com/lupyuen/01c7e43940d1fde1f3517612a6bbfd11.js"></script></p>


                  <figcaption><p><em>nRF24L01 Settings. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L66-L91"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L66-L91</a>
                  </em></p></figcaption>
                </div>
                <p id="2381" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">If you need to configure the
                  nRF24L01 addresses to avoid conflicts with nearby nRF24L01 networks, edit the settings in <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L66-L91" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">targets/bluepill_my_sensor/syscfg.yml</a></code>
                </p>
              </div>
            </div>
          </section>
          <hr class="iy en iz ja jb ek jc jd je jf jg" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <h1 id="6684" class="jh ji er bk bj jj jk jl jm jn jo jp jq jr js jt ju">Assigning Network Addresses
                  Automatically</h1>
                <p id="0ffe" class="gw gx er bk gy b gz jv hb jw hd jx hf jy hh jz hj">Each Sensor Network can have 1
                  Collector Node and up to 5 Sensor Nodes. So we may need to assign 6 addresses manually to each of the
                  6 nodes. Does this mean we need to <em class="hv">create 6 different ROM images for flashing</em>,
                  each with a different address inside? Nope, there’s an easier way!</p>
                <p id="a34f" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Inside every Blue Pill is a
                  <strong class="gy hu">unique 12-byte Hardware ID</strong> that’s burned in during manufacturing. I
                  have provided a <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/master/libs/sensor_network"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">Sensor
                      Network Library</strong></a> that…</p>
                <p id="b5a2" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L326-L336"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Reads the Blue Pill’s Hardware
                    ID</a> (by calling Mynewt’s <code
                    class="eb lr ls lt lu b"><a href="https://mynewt.apache.org/latest/os/modules/hal/hal_bsp/hal_bsp.html#c.hal_bsp_hw_id" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">hal_bsp_hw_id</a>()</code>
                  API)</p>
                <p id="bf37" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L336-L348"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Matches the Hardware ID</a>
                  against a configurable list of Hardware IDs for the Collector and Sensor Nodes</p>
                <p id="256d" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">3️⃣ And <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L338-L342"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">assigns the respective
                    addresses</a> for the Collector and Sensor Nodes.</p>
                <div class="figure hx hy hz ia ib cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
                
                  <p><script src="https://gist.github.com/lupyuen/6fac0ffbb22a66707e64b3e38f5adfa4.js"></script></p>


                  <figcaption><p><em>Hardware ID settings. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L44-L65"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L44-L65</a>
                  </em></p></figcaption>
                </div>
                <p id="c2dc" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">All you need to do is to fill in
                  the list of Hardware IDs for your Blue Pills in <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L44-L65" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">targets/bluepill_my_sensor/syscfg.yml</a></code>…
                </p>
                <p id="e411" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">To discover the Hardware ID for
                  your Blue Pill, start the debugger and watch out for this message at startup…</p>
                <pre
                  class="hx hy hz ia ib lv lw lx"><span id="260a" class="ly ji er bk lu b eh lz ma r mb">NET hwid 57 ff 6a 06 78 78 54 50 49 29 24 67</span></pre>
                <p id="6813" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">When updating the settings,
                  convert the Hardware ID into a hexadecimal list like this…</p>
                <pre
                  class="hx hy hz ia ib lv lw lx"><span id="9797" class="ly ji er bk lu b eh lz ma r mb">0x57, 0xff, 0x6a, 0x06, 0x78, 0x78, 0x54, 0x50, 0x49, 0x29, 0x24, 0x67</span></pre>
                <p id="b2b3" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Rebuild the application and
                  restart the debugger. At startup, watch for <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L326-L347"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">one of these messages</a> that
                  indicates the type of node…</p>
                <pre
                  class="hx hy hz ia ib lv lw lx"><span id="307c" class="ly ji er bk lu b eh lz ma r mb">NET collector node<br/>NET sensor node #1</span></pre>
                <p id="3a82" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">If you see <code
                    class="eb lr ls lt lu b">NET standalone node</code> it means that the program <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L242-L268"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">was unable to match your Hardware
                    ID</a> with any Collector or Sensor Hardware IDs. Verify the list of Hardware IDs in <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L44-L65" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">targets/bluepill_my_sensor/syscfg.yml</a></code>
                </p>
                <p id="ceb3" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">So only <strong class="gy hu">ONE
                    version of the ROM image</strong> (containing all 6 Hardware IDs and node addresses) needs to be
                  flashed to all 6 Blue Pills. So easy to deploy and upgrade. <em class="hv">The rest happens
                    automatically… like magic!</em></p>
                <blockquote class="iv iw ix">
                  <p id="3f53" class="gw gx er hv gy b gz ha hb hc hd he hf hg hh hi hj"><em class="bk">💎 </em>When we
                    build only one ROM image for all Collector and Sensor Nodes, it means that the same code is present
                    on ALL nodes. Depending on the Hardware ID, some parts of the code are disabled at runtime. This
                    also means that we need to squeeze all code into the 64 KB ROM limit. More about this in a while…
                  </p>
                </blockquote>
              </div>
            </div>
          </section>
          <hr class="iy en iz ja jb ek jc jd je jf jg" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <h1 id="cfb0" class="jh ji er bk bj jj jk jl jm jn jo jp jq jr js jt ju">Mynewt Driver for Remote
                  Sensors</h1>
                <div class="figure hx hy hz ia ib cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
            
                  <p><script src="https://gist.github.com/lupyuen/7c7cbca4d46b44eed33cf3a3c6c9fb67.js"></script></p>


                  <figcaption><p><em>Calling Mynewt’s Sensor Framework to poll a
                    sensor. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/listen_sensor.c#L46-L76"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/listen_sensor.c#L46-L76</a>
                  </em></p></figcaption>
                </div>
                <p id="2258" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Mynewt has an excellent <a
                    href="https://mynewt.apache.org/latest/os/modules/sensor_framework/sensor_framework.html"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">Sensor
                      Framework</strong></a> that’s perfect for integrating IoT devices with sensors.</p>
                <p id="d786" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">No need to code our own
                  background task to poll the sensor periodically (like our temperature sensor) and to process the
                  sensor data… Just tell the Sensor Framework <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/listen_sensor.c#L46-L76"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">which sensor
                      to poll and how often</strong></a>!</p>
                <p id="8c22" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Mynewt triggers our <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/listen_sensor.c#L109-L152"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">Listener
                      Function</strong></a> to process the sensor data that has been polled.</p>
                <p id="dd49" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><em class="hv">But our new Sensor
                    Network is complicated</em>. On the Collector Node, Mynewt is blissfully unaware about the Sensor
                  Nodes that are periodically transmitting sensor data to the Collector Node.<em class="hv"> Can we tell
                    Mynewt about the Sensor Nodes and their attached sensors?</em></p>
                <div class="figure hx hy hz ia ib cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
               
                  <p><script src="https://gist.github.com/lupyuen/9193f3791ee6dde9f2219f10e2005fac.js"></script></p>


                  <figcaption><p><em>Declaring a Remote Sensor Type for the Raw
                    Temperature Sensor. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L135-L155"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L135-L155</a>
                  </em></p></figcaption>
                </div>
                <p id="6138" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Yes, with the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/master/libs/remote_sensor"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">Remote
                      Sensor Driver</strong></a> that I have provided! When installed on the Collector Node, the Remote
                  Sensor Driver enables Sensor Nodes (and attached sensors) to <strong class="gy hu">masquerade as
                    locally-attached sensors</strong>!</p>
                <p id="a4ed" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The above <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L135-L155"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">Remote
                      Sensor Configuration</strong></a> tells Mynewt about a <strong class="gy hu">Raw Temperature
                    Sensor Type</strong> that’s attached to a Sensor Node (<code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L135-L155" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">targets/bluepill_my_sensor/syscfg.yml</a></code>)…
                </p>
                <p id="56dd" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ <code
                    class="eb lr ls lt lu b"><strong class="gy hu">temp_raw</strong></code> is the name of the Raw
                  Temperature Sensor Type. This is an integer value (0 to 4095) that’s provided by the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/master/libs/temp_stm32"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Blue Pill Internal Temperature
                    Sensor</a> (<a class="at cg io ip iq ir" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-esp8266-with-apache-mynewt">described
                    in my previous article</a>).</p>
                <p id="f358" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ <code
                    class="eb lr ls lt lu b"><strong class="gy hu">t</strong></code> is the field name that appears in
                  the message transmitted by the Sensor Node. The message looks like <code
                    class="eb lr ls lt lu b">{ &quot;t&quot;: 1745 }</code></p>
                <p id="bb96" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">3️⃣ <code
                    class="eb lr ls lt lu b"><strong class="gy hu">strd</strong></code> is the <code
                    class="eb lr ls lt lu b">union</code> type that shall store the sensor value in memory. This follows
                  Mynewt’s Sensor Framework convention of <a
                    href="https://mynewt.apache.org/latest/os/modules/sensor_framework/sensor_api.html#c.sensor_data_t"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">using a </a><code
                    class="eb lr ls lt lu b"><a href="https://mynewt.apache.org/latest/os/modules/sensor_framework/sensor_api.html#c.sensor_data_t" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">union</a></code><a
                    href="https://mynewt.apache.org/latest/os/modules/sensor_framework/sensor_api.html#c.sensor_data_t"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"> to store each type of sensor
                    value</a>. <code class="eb lr ls lt lu b">strd</code> is defined in <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/custom_sensor/include/custom_sensor/custom_sensor.h" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">libs/custom_sensor/include/custom_sensor/custom_sensor.h</a></code>
                </p>
                <p id="c328" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">4️⃣ <code
                    class="eb lr ls lt lu b"><strong class="gy hu">AMBIENT_TEMPERATURE_RAW</strong></code> is the unique
                  Sensor Type ID for the Raw Temperature Sensor Type. Mynewt’s Sensor Framework uses the <a
                    href="https://mynewt.apache.org/latest/os/modules/sensor_framework/sensor_api.html#c.SensorAPI::sensor_type_t"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Sensor Type ID</a> to discover
                  which Sensor Drivers can return values of each Sensor Type. <code
                    class="eb lr ls lt lu b">AMBIENT_TEMPERATURE_RAW</code> is defined in <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/custom_sensor/include/custom_sensor/custom_sensor.h" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">libs/custom_sensor/include/custom_sensor/custom_sensor.h</a></code>
                </p>
                <p id="b230" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">5️⃣ The last 2 settings declare
                  whether the sensor provides integer (<code
                    class="eb lr ls lt lu b"><strong class="gy hu">INT</strong></code>) or double-precision
                  floating-point (<code class="eb lr ls lt lu b"><strong class="gy hu">DOUBLE</strong></code>) sensor
                  values.</p>
                <div class="figure hx hy hz ia ib cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
              
                  <p><script src="https://gist.github.com/lupyuen/534bd3dfc4f036ba0ecafd4a5224010c.js"></script></p>


                  <figcaption><p><em>Starting the Remote Sensor Listeners. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/listen_sensor.c#L77-L108"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/listen_sensor.c#L77-L108</a>
                  </em></p></figcaption>
                </div>
                <p id="1b85" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Once we declare the Remote Sensor
                  Type for the remote temperature sensor (<a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/listen_sensor.c#L77-L108"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">and start the Remote Sensor
                    Listeners</a>), we may program the sensor as though it were a local temperature sensor… <em
                    class="hv">Mynewt’s familiar Sensor Framework works exactly the same way!</em></p>
                <p id="a553" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Just provide a <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/listen_sensor.c#L109-L152"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Listener Function</a> and Mynewt
                  will helpfully <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/remote_sensor/src/route_coap.c#L64-L148"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">trigger the function whenever it
                    receives sensor data from the Sensor Nodes</a>.</p>
                <p id="25d4" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Programming with Distributed IoT
                  sensors becomes fun and easy, with this simple Remote Sensor Driver for Mynewt that converts a Remote
                  Sensor into a Local Sensor. Now we understand why we adopted a multitasking realtime operating system
                  like Mynewt… because without Mynewt, the Collector Node can’t possibly <strong class="gy hu">receive
                    and send sensor messages over two different networks</strong> <strong
                    class="gy hu">simultaneously</strong>.</p>
              </div>
            </div>
          </section>
          <hr class="iy en iz ja jb ek jc jd je jf jg" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <h1 id="88d2" class="jh ji er bk bj jj jk jl jm jn jo jp jq jr js jt ju">Packaging and shipping Sensor
                  Data</h1>
                <p id="0b22" class="gw gx er bk gy b gz jv hb jw hd jx hf jy hh jz hj">Remember earlier we declared that
                  Sensor Nodes should be kept dead simple, using a simple network (nRF24L01) and a simple deployment
                  method (only ONE ROM image!) The Sensor Data needs to be kept simple too…</p>
                <p id="a0d9" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ <strong
                    class="gy hu">Eliminate all floating-point code</strong>: On Blue Pill, we pay a hefty price for any
                  computation involving floating-point (decimal) numbers. Even calculating a simple temperature like
                  “28.9 degrees Celsius” will require a huge chunk of floating-point code (from the standard math
                  library) to be embedded in ROM. Which inflates the ROM size, bloating beyond the 64 KB limit.</p>
                <p id="e6ca" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">In this demo we transmit the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/temp_stm32/include/temp_stm32/temp_stm32.h#L35-L48"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">raw temperature values as
                    integers</a> (directly from <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/temp_stm32/src/temp_stm32.c#L142-L183"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Blue Pill’s Analogue-to-Digital
                    Converter</a>) instead of the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/temp_stm32/src/temp_stm32.c#L184-L209"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">computed floating-point
                    temperature</a> values (<a class="at cg io ip iq ir" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-esp8266-with-apache-mynewt">like
                    in the previous tutorial</a>). The integer sensor values are transmitted from the Sensor Node to the
                  Collector Node, and also from the Collector Node to the CoAP Server.</p>
                <p id="df2f" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The raw temperature values are <a
                    href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/transform.js"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">converted into floating-point</a>
                  only upon reaching the CoAP Server at thethings.io. So that we could visualise the temperature
                  properly as “28.9 degrees Celsius” instead of <code class="eb lr ls lt lu b">1745</code>.</p>
                <p id="4266" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">No more floating-point bloat in
                  our ROM!</p>
                <p id="40ec" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ <strong class="gy hu">Compact
                    CBOR encoding instead of JSON</strong>: Our Collector Node transmits the raw temperature to the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L115-L118"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">CoAP Server with JSON
                    encoding</a>, which is accepted by all CoAP Servers…</p>
                <pre
                  class="hx hy hz ia ib lv lw lx"><span id="59cb" class="ly ji er bk lu b eh lz ma r mb">{ &quot;t&quot;: 1745 }</span></pre>
                <p id="9551" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">During the JSON transmission we
                  preserve the sensor field name <code class="eb lr ls lt lu b">&quot;t&quot;</code> so that it’s easier
                  to visualise the sensor data and execute rules on the CoAP Server (like thethings.io).</p>
                <p id="3a47" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">But JSON bloats our sensor data
                  messages — we need <strong class="gy hu">10 data bytes</strong> to transmit the simple message above.
                  Hence our Sensor Network demo uses <a
                    href="https://en.wikipedia.org/wiki/CBOR"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">CBOR
                      encoding</strong></a>, a compressed, binary version of JSON. And it’s natively supported by
                  Mynewt.</p>
                <p id="b96d" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Between the Sensor Node and the
                  Collector Node, we <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L115-L118"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">encode sensor data messages in
                    CBOR format</a> instead of JSON. Which requires only <strong class="gy hu">6 data bytes</strong>
                  instead of 10 bytes for the above example!</p>
                <p id="b62f" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">By adopting CBOR as the message
                  format in the local Sensor Network, we also simplify the design of the Remote Sensor Driver. The
                  driver only needs to <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/remote_sensor/src/route_coap.c#L149-L176"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">decode incoming CBOR messages</a>,
                  and <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/remote_sensor/src/route_coap.c#L109-L148"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">trigger the right Listener
                    Function</a>. The Remote Sensor Driver <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/remote_sensor/src/remote_sensor.c#L85-L96"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">selects the Listener Function</a>
                  based on the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/remote_sensor/src/sensor_type_desc.h#L31-L46"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">sensor field name </a><code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/remote_sensor/src/sensor_type_desc.h#L31-L46" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">&quot;t&quot;</a></code>
                </p>
                <blockquote class="iv iw ix">
                  <p id="9e40" class="gw gx er hv gy b gz ha hb hc hd he hf hg hh hi hj"><em class="bk">💎 </em>Mynewt
                    natively encodes CoAP messages using CBOR encoding. We <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/nrf24l01/src/transport.cpp#L89-L128"
                      class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">discard the CoAP Header</a>,
                    keeping only the CoAP Payload in CBOR, which occupies 6 data bytes. An additional byte <code
                      class="eb lr ls lt lu b">0xff</code> is added by Mynewt as the payload terminator. The final byte
                    of the nRF24L01 message is the <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/nrf24l01/src/transport.cpp#L110-L112"
                      class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">message counter</a>, useful for
                    detecting missing messages.</p>
                  <p id="0282" class="gw gx er hv gy b gz ha hb hc hd he hf hg hh hi hj">nRF24L01 messages can be up to
                    32 bytes in length. But for the demo we have <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/nrf24l01/src/transport.cpp#L113-L116"
                      class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">fixed the message length as 12
                      bytes</a>. It’s big enough to transmit 2 sensor values, yet small enough to reduce the risk of RF
                    interference and allow farther transmission distances. To change the message length, edit the <code
                      class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L110-L112" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">NRF24L01_TX_SIZE</a></code>
                    setting in <code
                      class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L110-L112" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">targets/bluepill_my_sensor/syscfg.yml</a></code>
                  </p>
                </blockquote>
              </div>
            </div>
          </section>
          <hr class="iy en iz ja jb ek jc jd je jf jg" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <h1 id="0eaa" class="jh ji er bk bj jj jk jl jm jn jo jp jq jr js jt ju">Selecting JSON or CBOR Encoding
                </h1>
                <p id="be5f" class="gw gx er bk gy b gz jv hb jw hd jx hf jy hh jz hj">Now that we have two formats for
                  encoding sensor data…</p>
                <p id="6191" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L115-L118"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">CBOR
                      Encoding</strong></a> from Sensor Node to Collector Node (via nRF24L01)</p>
                <p id="8566" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L115-L118"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">JSON
                      Encoding</strong></a> from Collector Node to CoAP Server (via ESP8266)</p>
                <p id="b029" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><em class="hv">Does this make
                    Blue Pill device programming twice as difficult?</em></p>
                <p id="a69d" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Not at all! The Sensor Network
                  Library hides the encoding details inside high-level functions that we may call to compose and
                  transmit messages…</p>
                <p id="84a3" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">0️⃣ Previously we called <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_coap/src/sensor_coap.c#L156-L186" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">init_sensor_post</strong></a>() … <a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_coap/src/sensor_coap.c#L187-L193" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">do_sensor_post</strong></a>()</code>
                  to send CoAP messages to the CoAP Server via the ESP8266 Network Transport (from the ESP8266 Network
                  Driver)</p>
                <p id="cf2a" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ Now we call <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L175-L185" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">init_collector_post</strong></a>() … <a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L222-L231" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">do_collector_post</strong></a>()</code>
                  to send messages to the Collector Node via the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/nrf24l01/src/transport.cpp#L89-L157"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">nRF24L01 Network Transport</a>
                  (from the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/master/libs/nrf24l01"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">nRF24L01 Network Driver</a>)</p>
                <p id="9761" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ And we call <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L165-L174" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">init_server_post</strong></a>() … <a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L212-L221" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">do_server_post</strong></a>()</code>
                  to send messages to the CoAP Server via the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/esp8266/src/transport.cpp#L102-L131"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">ESP8266 Network Transport</a>
                  (from the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/master/libs/esp8266"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">ESP8266 Network Driver</a>)</p>
                <p id="c7b8" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/master/libs/nrf24l01"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">nRF24L01
                      Network Driver</strong></a> was <a
                    href="https://os.mbed.com/users/Owen/code/nRF24L01P/file/8ae48233b4e4/nRF24L01P.cpp/"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">ported from mbed</a> to Mynewt.
                  The driver settings may be found in <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/syscfg.yml#L92-L134" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">targets/bluepill_my_sensor/syscfg.yml</a></code>
                </p>
                <p id="9f2c" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The nRF24L01 driver is connected
                  to the SPI port and supports simple <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/nrf24l01/include/nrf24l01/nrf24l01.h#L84-L104"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">transmit and receive
                    functions</a>. There’s no need to call the nRF24L01 functions directly — the Sensor Network Library
                  calls them when <code class="eb lr ls lt lu b">do_collector_post()</code> is invoked.</p>
                <p id="5cd1" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The nRF24L01 driver <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/nrf24l01/src/driver.cpp#L250-L271"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">handles interrupts</a> raised by
                  the nRF24L01 module when data has been received (so no polling is needed). The driver calls the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/remote_sensor/src/route_coap.c#L64-L108"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Receive Callback Function</a>
                  provided by the Remote Sensor Library. The callback function decodes the CBOR message and forwards it
                  to the Remote Sensor Listener Function.</p>
                <p id="71c6" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The <strong class="gy hu">ESP8266
                    Network Driver</strong> is connected to the UART port. It has been covered in detail in <a
                    class="at cg io ip iq ir" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-esp8266-with-apache-mynewt">the
                    previous tutorial</a>.</p>
                <div class="figure hx hy hz ia ib cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
                
                  <p><script src="https://gist.github.com/lupyuen/01f404171802be4598ea88e38b68328a.js"></script></p>


                  <figcaption><p><em>Using CP macros to compose messages for
                    Collector Node and CoAP Server. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/send_coap.c#L182-L222"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/send_coap.c#L182-L222</a>
                  </em></p></figcaption>
                </div>
                <p id="a696" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Composing messages with the
                  macros <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_coap/include/sensor_coap/sensor_coap.h#L289-L324" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">CP_ITEM_STR</a>(), <a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_coap/include/sensor_coap/sensor_coap.h#L289-L324" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">CP_ITEM_FLOAT</a>(), … </code>works
                  exactly like before. The right encoding (CBOR or JSON) is automatically selected when we call <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L186-L195" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">init_collector_post</a>()</code>
                  and <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L186-L195" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">init_server_post</a>()</code>
                </p>
                <p id="0e8d" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">To allow easier passing and
                  encoding of Sensor Values, we have created a <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_coap/include/sensor_coap/sensor_coap.h#L11-L20" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">sensor_value</strong></a> struct</code>
                  that contains one Sensor Key (e.g. <code class="eb lr ls lt lu b">&quot;t&quot;</code> for raw
                  temperature) and one Sensor Value (<code class="eb lr ls lt lu b">int</code> or <code
                    class="eb lr ls lt lu b">float</code>). New macros have been created to add a <code
                    class="eb lr ls lt lu b">sensor_value</code> to a message: <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_coap/include/sensor_coap/sensor_coap.h#L230-L235" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">CP_SET_INT_VAL</a>(), <a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_coap/include/sensor_coap/sensor_coap.h#L236-L241" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">CP_SET_FLOAT_VAL</a>(), <a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_coap/include/sensor_coap/sensor_coap.h#L262-L267" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">CP_ITEM_INT_VAL</a>(), <a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_coap/include/sensor_coap/sensor_coap.h#L268-L273" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">CP_ITEM_FLOAT_VAL</a>()</code>.
                </p>
                <p id="c025" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The new macros are used in <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/send_coap.c#L113-L224" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">apps/my_sensor_app/src/send_coap.c</a></code>
                  to compose <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/send_coap.c#L182-L224"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Collector Node messages</a> and <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/apps/my_sensor_app/src/send_coap.c#L113-L181"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">CoAP Server messages</a>. All
                  macros have been updated to <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_coap/include/sensor_coap/sensor_coap.h#L140-L218"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">support both CBOR and JSON
                    encoding</a>, selected at runtime (instead of compile-time).</p>
                <p id="c3d5" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The Sensor Network Library brings
                  us one step closer to the vision of <strong class="gy hu">Network-Agnostic IoT</strong>… Doesn’t
                  matter whether our devices are connected via ESP8266 or nRF24L01, <em class="hv">the same code still
                    works</em>! The <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/README.md"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Sensor Network Library</a>…</p>
                <p id="a135" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L326-L348"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">Assigns
                      network addresses</strong></a> (nRF24L01)<strong class="gy hu"> </strong>based on one common ROM
                  image</p>
                <p id="691b" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/include/sensor_network/sensor_network.h#L82-L117"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">Provides
                      generic functions</strong></a> to perform operations on network interfaces, like <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L222-L231" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">do_collector_post</a>()</code>
                  and <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L212-L221" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">do_server_post</a>()</code>
                </p>
                <p id="3050" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">3️⃣ <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L186-L195"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">Selects
                      message encoding</strong></a> (CBOR or JSON) based on the destination of the message (Collector
                  Node vs CoAP Server)</p>
                <p id="8eab" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">4️⃣ <strong
                    class="gy hu">Enforces a standard data format</strong> (CoAP JSON) for aggregating and encoding
                  sensor data when transmitting sensor data to the IoT Server for processing</p>
                <p id="555a" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">We’ll now learn how thethings.io
                  may be used to process the standardised sensor data.</p>
                <blockquote class="iv iw ix">
                  <p id="c8e4" class="gw gx er hv gy b gz ha hb hc hd he hf hg hh hi hj"><em class="bk">💎 </em>The
                    Sensor Network Library is clearly able to transmit sensor data locally (nRF24L01) and over internet
                    (ESP8266)… yet the library has <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/pkg.yml#L29-L33"
                      class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">no dependencies on the nRF24L01
                      and ESP8266 drivers</a>! This was done with a programming trick known as “<a
                      href="https://en.wikipedia.org/wiki/Inversion_of_control"
                      class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">Inversion of Control</a>” — the
                    <a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/libs/sensor_network/src/sensor_network.c#L349-L360"
                      class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">network drivers register
                      themselves</a> with the Sensor Network library, not the other way around.</p>
                  <p id="13c2" class="gw gx er hv gy b gz ha hb hc hd he hf hg hh hi hj">This enables the Sensor Network
                    Library to be truly Network Agnostic. The Sensor Network Library will support many other network
                    adapters and network protocols in future: NB-IoT, LoRa, Sigfox, Zigbee, Bluetooth, …</p>
                </blockquote>
              </div>
            </div>
          </section>
          <hr class="iy en iz ja jb ek jc jd je jf jg" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <h1 id="7071" class="jh ji er bk bj jj jk jl jm jn jo jp jq jr js jt ju">Configuring the CoAP Server at
                  thethings.io</h1>
                <p id="ca3b" class="gw gx er bk gy b gz jv hb jw hd jx hf jy hh jz hj"><a
                    href="https://thethings.io/" class="at cg io ip iq ir"
                    target="_blank" rel="noopener nofollow">thethings.io</a> is an excellent example of a modern hosted
                  IoT server that’s capable of processing the CoAP standard-based sensor data transmitted by our
                  Collector Node. Follow the steps below to configure the CoAP Server at thethings.io and understand how
                  the server can transform our sensor data (Raw Temperature to Computed Temperature) and visualise the
                  data…</p>
                <p id="4714" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ Follow the video below to
                  sign up for a 14-day free trial account (no credit card needed) and to install three custom JavaScript
                  programs for processing the data: <code class="eb lr ls lt lu b">forward_geolocate</code>, <code
                    class="eb lr ls lt lu b">transform</code>, <code class="eb lr ls lt lu b">update_state</code>. The
                  scripts are located here: <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/thethingsio-wifi-geolocation" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">https://github.com/lupyuen/thethingsio-wifi-geolocation</a></code>
                </p>
                <p id="05d0" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Click <code
                    class="eb lr ls lt lu b">CC</code> to view the instructions…</p>
                <blockquote class="iv iw ix">
                  <p id="89d7" class="gw gx er hv gy b gz ha hb hc hd he hf hg hh hi hj"><em class="bk">💎 </em>If you
                    will be using WiFi Geolocation, copy the script <code class="eb lr ls lt lu b">geolocate.js</code>
                    and install it as the Cloud Code Function named <code class="eb lr ls lt lu b">geolocate</code></p>
                </blockquote>
              </div>
            </div>
            <div class="cz">
              <div class="n p">
                <div class="da db dc dd de df ag dg ah dh aj ak">
                  <div class="figure hx hy hz ia ib cz">
                    <div class="ea r ds">
                      <div class="iu r"><iframe
                          src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2F4KJiZMboaUg%3Ffeature%3Doembed&amp;url=http%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D4KJiZMboaUg&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2F4KJiZMboaUg%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube"
                          allowfullscreen="" frameborder="0" height="300" width="400"
                          title="Transform sensor data with thethings.io (Part 1 of 3)" class="cp t u dw ak"
                          scrolling="auto"></iframe></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <p id="c63e" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ The second video explains the
                  steps for creating a dashboard that visualises the Raw Temperature transmitted by our Collector Node.
                </p>
                <p id="2de2" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Click <code
                    class="eb lr ls lt lu b">CC</code> to view the instructions…</p>
              </div>
            </div>
            <div class="cz">
              <div class="n p">
                <div class="da db dc dd de df ag dg ah dh aj ak">
                  <div class="figure hx hy hz ia ib cz">
                    <div class="ea r ds">
                      <div class="iu r"><iframe
                          src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2FszCHheKEC7I%3Ffeature%3Doembed&amp;url=http%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DszCHheKEC7I&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2FszCHheKEC7I%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube"
                          allowfullscreen="" frameborder="0" height="300" width="400"
                          title="Transform sensor data with thethings.io (Part 2 of 3)" class="cp t u dw ak"
                          scrolling="auto"></iframe></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <p id="0fce" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">3️⃣ In the final video we verify
                  that the Raw Temperature <code class="eb lr ls lt lu b">t</code> is transformed to Computed
                  Temperature <code class="eb lr ls lt lu b">tmp</code> correctly. We visualise the Computed Temperature
                  <code class="eb lr ls lt lu b">tmp</code> in the dashboard.</p>
                <p id="9514" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Click <code
                    class="eb lr ls lt lu b">CC</code> to view the instructions…</p>
              </div>
            </div>
            <div class="cz">
              <div class="n p">
                <div class="da db dc dd de df ag dg ah dh aj ak">
                  <div class="figure hx hy hz ia ib cz">
                    <div class="ea r ds">
                      <div class="iu r"><iframe
                          src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2FdMelHn4xTcM%3Ffeature%3Doembed&amp;url=http%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DdMelHn4xTcM&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2FdMelHn4xTcM%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube"
                          allowfullscreen="" frameborder="0" height="300" width="400"
                          title="Transform sensor data with thethings.io (Part 3 of 3)" class="cp t u dw ak"
                          scrolling="auto"></iframe></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <p id="6af3" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">After configuring the demo in
                  thethings.io, we now fully appreciate how a comprehensive end-to-end IoT solution may benefit us…</p>
                <p id="3e57" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣<strong class="gy hu"> Gather
                    raw sensor data</strong> efficiently from Sensor Nodes dispersed around a region, up to 1 km away
                </p>
                <p id="010f" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ <strong
                    class="gy hu">Aggregate and transmi</strong>t the raw sensor data to a standards-based IoT server
                  (like thethings.io)</p>
                <p id="3e10" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">3️⃣ <strong
                    class="gy hu">Transform the raw sensor data</strong> to the final display format (e.g. degrees
                  Celsius) at the IoT server</p>
                <p id="c869" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">4️⃣ <strong
                    class="gy hu">Visualise the transformed sensor data</strong> as realtime text and graphical displays
                </p>
              </div>
            </div>
          </section>
          <hr class="iy en iz ja jb ek jc jd je jf jg" />
          <section class="cu cv cw cx cy">
            <div class="cz">
              <div class="n p">
                <div class="da db dc dd de df ag dg ah dh aj ak">
                  <div class="figure hx hy hz ia ib cz do dp paragraph-image">
                
                    <p><img src="https://lupyuen.github.io/images/legacy2/f6.png" /></p>

                   
                    <figcaption><p><em>thethings.io Cloud Code Trigger and
                      Functions used in the demo</em></p></figcaption>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <h1 id="b985" class="jh ji er bk bj jj jk mg jm mh jo mi jq mj js mk ju">Processing Sensor Data at
                  thethings.io</h1>
                <p id="2087" class="gw gx er bk gy b gz jv hb jw hd jx hf jy hh jz hj">With Network-Agnostic IoT, our
                  Collector Node aggregates and transmits sensor data to the IoT Server in a standard format: <strong
                    class="gy hu">CoAP JSON</strong>. This ensures that our sensor data can be <strong
                    class="gy hu">easily processed, regardless of the network and server used</strong>. Here’s how we
                  process the sensor data with the CoAP Server hosted at thethings.io…</p>
                <p id="416e" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><code
                    class="eb lr ls lt lu b"><strong class="gy hu">forward_geolocate</strong></code>, <code
                    class="eb lr ls lt lu b"><strong class="gy hu">geolocate</strong></code>, <code
                    class="eb lr ls lt lu b"><strong class="gy hu">transform</strong></code> and <code
                    class="eb lr ls lt lu b"><strong class="gy hu">update_thing</strong></code> are the Cloud Code
                  Trigger and Functions that we install at thethings.io to process the sensor data. They call one
                  another like a Finite State Machine to perform WiFi geolocation, transform sensor values (raw
                  temperature to computed temperature) and update the thing state…</p>
                <div class="figure hx hy hz ia ib cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
               
                  <p><script src="https://gist.github.com/lupyuen/20050215a487c2ba15667ce44d92409c.js"></script></p>


                  <figcaption><p><em>forward_geolocate Cloud Code Trigger. From <a
                      href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/forward_geolocate.js#L61-L122"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/forward_geolocate.js#L61-L122</a>
                  </em></p></figcaption>
                </div>
                <p id="0d33" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/forward_geolocate.js" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">forward_geolocate</strong></a></code>
                  is the Cloud Code Trigger that will receive any sensor data transmitted by our Collector Node over
                  CoAP. This trigger allows us to intercept the sensor values and transform them.</p>
                <p id="f317" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ <code
                    class="eb lr ls lt lu b">forward_geolocate</code> checks whether the message contains any <code
                    class="eb lr ls lt lu b">ssid</code> or <code class="eb lr ls lt lu b">rssi</code> (signal strength)
                  fields.</p>
                <p id="c1d3" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">If the <code
                    class="eb lr ls lt lu b">ssid</code> and <code class="eb lr ls lt lu b">rssi</code> fields were
                  found, it forwards the message to the Cloud Code Function <code
                    class="eb lr ls lt lu b">geolocate</code> for processing.</p>
                <p id="1e6a" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">This was the code from <a
                    class="at cg io ip iq ir" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-esp8266-with-apache-mynewt">the
                    previous tutorial</a> that performs WiFi Geolocation given a list of WiFi SSIDs their Signal
                  Strength. <code class="eb lr ls lt lu b">geolocate</code> is not needed if you don’t use the WiFi
                  Geolocation feature.</p>
                <div class="figure hx hy hz ia ib cz cl cm paragraph-image">

                
                  <p><img src="https://lupyuen.github.io/images/legacy2/h0.png" /></p>

             
                </div>
                <div class="figure ej cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
                
                  <p><script src="https://gist.github.com/lupyuen/851acf34da2e8166e40fd8c2e7ac21c9.js"></script></p>


                  <figcaption><p><em>geolocate Cloud Code Function. From <a
                      href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/geolocate.js#L66-L114"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/geolocate.js#L66-L114</a>
                  </em></p></figcaption>
                </div>
                <p id="464c" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">3️⃣ If WiFi Geolocation is
                  enabled, Cloud Code Function <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/geolocate.js" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">geolocate</strong></a></code>
                  passes the WiFi SSID and Signal Strength info to the Google WiFi Geolocation API. This info was
                  obtained from the ESP8266 scanning nearby WiFI networks.</p>
                <p id="35e4" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The Geolocation API estimates the
                  location of the device and returns the latitude, longitude and accuracy (in metres).</p>
                <p id="c622" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><code
                    class="eb lr ls lt lu b">geolocate</code> calls the Cloud Code Function <code
                    class="eb lr ls lt lu b">update_thing</code> to update the thing state with the geolocation results,
                  so that the results will be stored in thethings.io and the dashboards will be updated.</p>
                <div class="figure hx hy hz ia ib cz cl cm paragraph-image">

                
                  <p><img src="https://lupyuen.github.io/images/legacy2/h0.png" /></p>

             
                </div>
                <div class="figure ej cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
              
                  <p><script src="https://gist.github.com/lupyuen/3c24492cceb08ca1476d3df9eb88d7e1.js"></script></p>


                  <figcaption><p><em>update_thing Cloud Code Function. From <a
                      href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/update_thing.js#L5-L49"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/update_thing.js#L5-L49</a>
                  </em></p></figcaption>
                </div>
                <p id="c0e5" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">4️⃣ Cloud Function <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/update_thing.js" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">update_thing</strong></a></code>
                  receives the updated sensor values (latitude, longitude, accuracy) and updates the thethings.io thing
                  state by calling the HTTP API.</p>
                <p id="48d1" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Since the option <code
                    class="eb lr ls lt lu b">broadcast=true</code> was specified, all the dashboards for the thing will
                  be instantly refreshed, including the geolocation result.</p>
                <p id="92ea" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">5️⃣ The updating of the thing
                  state also indirectly triggers <code class="eb lr ls lt lu b">forward_geolocate</code> with the
                  updated sensor values. Which leads to the next step…</p>
                <div class="figure hx hy hz ia ib cz cl cm paragraph-image">

                
                  <p><img src="https://lupyuen.github.io/images/legacy2/h0.png" /></p>

              
                </div>
                <div class="figure ej cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
       
                  <p><script src="https://gist.github.com/lupyuen/d8866f714b5b992a50a63c1b01795e7c.js"></script></p>


                  <figcaption><p><em>forward_geolocate Cloud Code Trigger. From <a
                      href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/forward_geolocate.js#L61-L122"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/forward_geolocate.js#L61-L122</a>
                  </em></p></figcaption>
                </div>
                <p id="fb55" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">6️⃣ The next step of <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/forward_geolocate.js" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">forward_geolocate</strong></a></code>
                  checks whether the sensor values have been transformed (i.e. whether the <code
                    class="eb lr ls lt lu b">transformed</code> key exists).</p>
                <p id="708e" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">If the values have not been
                  transformed, it calls Cloud Function <code class="eb lr ls lt lu b">transform</code> to transform the
                  values.</p>
                <div class="figure hx hy hz ia ib cz cl cm paragraph-image">

                
                  <p><img src="https://lupyuen.github.io/images/legacy2/h0.png" /></p>

          
                </div>
                <div class="figure ej cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
                
                  <p><script src="https://gist.github.com/lupyuen/207a6bc35894a233223f7b12a257b421.js"></script></p>


                  <figcaption><p><em>transform Cloud Code Function. From <a
                      href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/transform.js#L1-L36"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/transform.js#L1-L36</a>
                  </em></p></figcaption>
                </div>
                <p id="526d" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">7️⃣ Cloud Code Function <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/transform.js" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">transform</strong></a></code>
                  computes the actual floating-point temperature <code class="eb lr ls lt lu b">tmp</code> given the raw
                  temperature <code class="eb lr ls lt lu b">t</code>.</p>
                <p id="7991" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">It calls Cloud Code Function
                  <code class="eb lr ls lt lu b">update_thing</code> to update the thing state with the computed
                  temperature <code class="eb lr ls lt lu b">tmp</code>. The <code
                    class="eb lr ls lt lu b">transformed</code> key is added to the sensor values to indicate that the
                  sensor values have been transformed.</p>
                <p id="5b7e" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">This leads to Steps 4️⃣ and 5️⃣
                  that we have seen earlier. Any dashboards that render the <code class="eb lr ls lt lu b">tmp</code>
                  value will be automatically refreshed.</p>
                <p id="6cbe" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj"><code
                    class="eb lr ls lt lu b">forward_geolocate</code> is triggered once again, leading to the final
                  step…</p>
                <div class="figure hx hy hz ia ib cz eg ic cd id hl ie if ig ba ih ll lm ln lo im">
                
                  <p><script src="https://gist.github.com/lupyuen/be1b1f95e34aa8ff805bd6320c71edc5.js"></script></p>


                  <figcaption><p><em>pushSensorData from Cloud Code Trigger
                    forward_geolocate. From <a
                      href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/forward_geolocate.js#L17-L60"
                      class="at cg io ip iq ir" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/forward_geolocate.js#L17-L60</a>
                  </em></p></figcaption>
                </div>
                <p id="3b21" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">8️⃣ <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/forward_geolocate.js" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">forward_geolocate</strong></a></code>
                  takes the geolocated and transformed sensor values (latitude, longitude, accuracy, computed
                  temperature) and transmits them to an external server <code
                    class="eb lr ls lt lu b">blue-pill-geolocate.appspot.com</code> via a HTTP POST request.</p>
                <p id="c205" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">This step is not needed if you’re
                  not using an external server to share your sensor data publicly.</p>
                <p id="3e5d" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Details of the external server
                  setup may be found in <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/gcloud-wifi-geolocation" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">gcloud-wifi-geolocation</a></code>
                </p>
                <div class="figure hx hy hz ia ib cz cl cm paragraph-image">

                
                  <p><img src="https://lupyuen.github.io/images/legacy2/h0.png" /></p>

               
                </div>
                <p id="c989" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">Note that the nRF24L01 Sensor
                  Node Address (e.g. <code class="eb lr ls lt lu b">B3-B4-B5-B6-F1</code>) is transmitted to
                  thethings.io as sensor field <code class="eb lr ls lt lu b">node</code>. It’s possible to interpret
                  the <code class="eb lr ls lt lu b">node</code> field so that each Sensor Node is represented by a
                  different Thing in thethings.io. In the <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/thethingsio-wifi-geolocation/blob/master/update_thing.js" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow"><strong class="gy hu">update_thing</strong></a></code>
                  Cloud Code Function, we may map <code class="eb lr ls lt lu b">node</code> to a Thing Token using a
                  predefined mapping table. If you need more details, drop me a note!</p>
              </div>
            </div>
          </section>
          <hr class="iy en iz ja jb ek jc jd je jf jg" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <h1 id="b360" class="jh ji er bk bj jj jk jl jm jn jo jp jq jr js jt ju">Bootloader Stub</h1>
                <p id="5507" class="gw gx er bk gy b gz jv hb jw hd jx hf jy hh jz hj">The application for the Sensor
                  Network has grown quite complex, since it contains drivers for both nRF24L01 and ESP8266, as well as
                  the encoding libraries for CoAP, JSON and CBOR message formats.</p>
                <p id="99fd" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">To squeeze the code into 64 KB of
                  ROM on Blue Pill, we have switched to a <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/master/apps/boot_stub"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">smaller bootloader called
                  </a><code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/master/apps/boot_stub" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">boot_stub</a></code>.
                  This bootloader doesn’t do any of the <a
                    href="https://mynewt.apache.org/latest/os/modules/bootloader/bootloader.html"
                    class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">typical Mynewt Bootloader
                    functions</a>; it simply jumps to the application code.</p>
                <p id="a8ae" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The bootloader fits in 4 KB of
                  ROM. The rest of the ROM (up to 60 KB) is available for the application.</p>
                <p id="f496" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The Board Support Package for
                  Blue Pill has been locally patched on your Mynewt build to use the new memory layout: <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/patch/bluepill.ld" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">bluepill.ld</a></code>,
                  <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/patch/bsp.yml" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">bsp.yml</a></code>.
                  The ROM flashing scripts in the <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/master/scripts" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">scripts</a></code>
                  folder have also been updated.</p>
                <p id="3f1d" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">The current application size is
                  close to 60 KB. If we’re not using the debugger, we may reduce the application size by switching the
                  build profile from <code class="eb lr ls lt lu b">debug</code> to <code
                    class="eb lr ls lt lu b">optimized</code> in <code
                    class="eb lr ls lt lu b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/master/targets/bluepill_my_sensor/target.yml" class="at cg io ip iq ir" target="_blank" rel="noopener nofollow">targets/bluepill_my_sensor/target.yml</a></code>:
                </p>
                <pre
                  class="hx hy hz ia ib lv lw lx"><span id="0cca" class="ly ji er bk lu b eh lz ma r mb">target.build_profile: optimized</span></pre>
              </div>
            </div>
          </section>
          <hr class="iy en iz ja jb ek jc jd je jf jg" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah eo aj ak">
                <h1 id="021e" class="jh ji er bk bj jj jk jl jm jn jo jp jq jr js jt ju">What’s Next?</h1>
                <p id="c7ac" class="gw gx er bk gy b gz jv hb jw hd jx hf jy hh jz hj">The full power of Apache Mynewt
                  is obvious while we were building the Sensor Network on Blue Pill…</p>
                <p id="6681" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">1️⃣ <strong
                    class="gy hu">Simultaneously receiving and transmitting</strong> sensor data messages</p>
                <p id="1d01" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">2️⃣ <strong
                    class="gy hu">Multitasking of network drivers</strong> (nRF24L01 and ESP8266) with interrupts</p>
                <p id="52ed" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">3️⃣ <strong
                    class="gy hu">Built-in CoAP, JSON and CBOR</strong> encoding and decoding</p>
                <p id="0b84" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">4️⃣ <strong
                    class="gy hu">Built-in Sensor Framework</strong> for multitasking multiple sensors, including Remote
                  Sensors</p>
                <p id="e757" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">All this compiled into <em
                    class="hv">60 KB of ROM</em> on Blue Pill!</p>
                <p id="1d6f" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">And we have wrapped all of the
                  above into a <strong class="gy hu">Sensor Network Library</strong> that’s <strong
                    class="gy hu">Network-Agnostic</strong> (works on any network) and makes Sensor Network development
                  so simple.</p>
                <p id="3262" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">I’m keen to prove that <strong
                    class="gy hu">Network-Agnostic IoT is feasible</strong>, that we can make the same device code run
                  on any network. Today I have proven this for ESP8266 (WiFi) and nRF24L01 networks, <em class="hv">tell
                    me which networks I should tackle next!</em></p>
                <p id="53ed" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">[UPDATE] I have ported the code
                  in this article to Rust for a safer, smarter coding experience…</p>
                <div class="dj dk dl dm dn ka"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/hosting-embedded-rust-apps-on-apache-mynewt-with-stm32-blue-pill">
                    <section class="kd cl cm ak ce n ar ke kf kg kh ki kj kk kl km kn ko kp kq kr ks">
                      <div class="kt n co p ku kv">
                        <h2 class="bj jj kw bl er">
                          <div class="dx kb ft fu kc fw">Hosting Embedded Rust apps on Apache Mynewt with STM32 Blue
                            Pill</div>
                        </h2>
                      </div>
                      <div class="kz r">
                        <div class="ml r lb lc ld kz le lf lg"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="3abc" class="gw gx er bk gy b gz ha hb hc hd he hf hg hh hi hj">I have added <strong
                    class="gy hu">NB-IoT support for the Sensor Network Library</strong> here…</p>
                <div class="dj dk dl dm dn ka"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-nb-iot-with-quectel-bc95-g-and-apache-mynewt">
                    <section class="kd cl cm ak ce n ar ke kf kg kh ki kj kk kl km kn ko kp kq kr ks">
                      <div class="kt n co p ku kv">
                        <h2 class="bj jj kw bl er">
                          <div class="dx kb ft fu kc fw">Connect STM32 Blue Pill to NB-IoT with Quectel BC95-G and
                            Apache Mynewt</div>
                        </h2>
                      </div>
                      <div class="kz r">
                        <div class="mm r lb lc ld kz le lf lg"></div>
                      </div>
                    </section>
                  </a></div>
              </div>
            </div>
          </section>
        </div>
      </article>
    </div>
  </div>

  <ul>
    <li>
    <p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io">Check out my articles</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
    </li>
  </ul>
    
</body>

</html>
<!--
     FILE ARCHIVED ON 19:40:39 Dec 04, 2019 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 01:29:49 Feb 23, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  esindex: 0.014
  captures_list: 191.452
  load_resource: 67.769
  RedisCDXSource: 0.772
  LoadShardBlock: 156.062 (3)
  exclusion.robots: 0.442
  PetaboxLoader3.datanode: 177.48 (4)
  exclusion.robots.policy: 0.424
  CDXLines.iter: 29.675 (3)
  PetaboxLoader3.resolve: 30.95
-->