<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="/_static/css/banner-styles.css?v=bsmaklHF" />
  <link rel="stylesheet" type="text/css" href="/_static/css/iconochive.css?v=qtvMKcIJ" />
  <link rel="canonical" href="https://lupyuen.org/articles/stm32-blue-pill-usb-bootloader-how-i-fixed-the-usb-storage-serial-dfu-and-webusb-interfaces.html" />
  <!-- End Wayback Rewrite JS Include -->
  <title data-rh="true">STM32 Blue Pill USB Bootloader — How I fixed the USB Storage, Serial, DFU and WebUSB interfaces
  </title>
  <meta data-rh="true" charset="utf-8" />
  <meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
  <meta data-rh="true" name="theme-color" content="#000000" />
  <meta data-rh="true" property="og:type" content="article" />
  <meta data-rh="true" property="article:published_time" content="2019-04-03T22:49:55.131Z" />
  <meta data-rh="true" name="title"
    content="STM32 Blue Pill USB Bootloader — How I fixed the USB Storage, Serial, DFU and WebUSB interfaces" />
  <meta data-rh="true" property="og:title"
    content="STM32 Blue Pill USB Bootloader —  How I fixed the USB Storage, Serial, DFU and WebUSB interfaces" />
  <meta data-rh="true" property="twitter:title"
    content="STM32 Blue Pill USB Bootloader —  How I fixed the USB Storage, Serial, DFU and WebUSB interfaces" />
  <meta data-rh="true" name="description"
    content="Building a complex composite USB device with libopencm3 that works on Windows, Mac and Linux" />
  <meta data-rh="true" property="og:description"
    content="Building a complex composite USB device with libopencm3 that works on Windows, Mac and Linux" />
  <meta data-rh="true" property="twitter:description"
    content="Building a complex composite USB device with libopencm3 that works on Windows, Mac and Linux" />
  <meta data-rh="true" name="twitter:card" content="summary_large_image" />
  <meta data-rh="true" name="twitter:creator" content="@MisterTechBlog" />
  <meta data-rh="true" name="author" content="Lup Yuen Lee 李立源" />
  <meta data-rh="true" name="robots" content="index,follow" />
  <meta data-rh="true" name="referrer" content="unsafe-url" />
  <meta data-rh="true" name="twitter:label1" value="Reading time" />
  <meta data-rh="true" name="twitter:data1" value="14 min read" />
  <meta property="og:image" 
  content="https://lupyuen.github.io/images/legacy2/o1.png">

<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">

<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->

</head>

<body>
  <div id="root">
    <div class="a b c">
      <article>
        <section class="cj ck cl cm ak cn ce n co"></section><span class="r"></span>
        <div>
          <div class="cp u cq cr cs ct"></div>
          <section class="cu cv cw cx cy">
            <div class="cz ak">
              <div class="figure da cz ak paragraph-image">

                
                <p><img src="https://lupyuen.github.io/images/legacy2/o1.png" /></p>


               
                <figcaption><p><em>Blue Pill Bootloader connected to Windows
                </em></p></figcaption>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <div>
                  <div id="e9ca" class="dx dy dz bk ea b eb ec ed ee ef eg eh">
                    <h1 class="ea b eb ei dz">STM32 Blue Pill USB Bootloader — How I fixed the USB Storage, Serial, DFU
                      and WebUSB interfaces</h1>
                  </div>
                  <div class="ej">
                    <div class="n ek el em en">
                      <div class="o n">
                        <div><a rel="noopener"
                            href="https://lupyuen.github.io">
                            <div class="di eo ep">
                              <div class="bs n eq o p cp er es et eu ev ct"></div>
                              
                            </div>
                          </a></div>
                        <div class="ex ak r">
                          <div class="n">
                            <div style="flex:1"><span class="bj b bk bl bm bn r dz q">
                                <div class="ey n o ez"><span class="bj dv dp bl de fa fb fc fd fe dz"><a
                                      class="at au av aw ax ay az ba bb bc ff bf bg bh bi" rel="noopener"
                                      href="https://lupyuen.github.io">Lup
                                      Yuen Lee 李立源</a></span>
                               
                                </div>
                              </span></div>
                          </div><span class="bj b bk bl bm bn r bo bp"><span class="bj dv dp bl de fa fb fc fd fe bo">
                              <div><a class="at au av aw ax ay az ba bb bc ff bf bg bh bi" rel="noopener"
                                  href="https://lupyuen.github.io/articles/stm32-blue-pill-usb-bootloader-how-i-fixed-the-usb-storage-serial-dfu-and-webusb-interfaces">
                                  17 Dec 2018</a> <!-- -->·
                                <!-- -->
                                <!-- -->14
                                <!-- --> min read
                              </div>
                            </span></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <p id="e317" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">The <a
                    href="http://wiki.stm32duino.com/index.php?title=Blue_Pill"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">STM32 Blue Pill</a> is a
                  remarkable microcontroller for US$ 2. I proved it by running the USB Storage, USB Serial, USB DFU
                  (Direct Firmware Upgrade) and WebUSB interfaces all on the same Blue Pill concurrently, without any
                  additional hardware!</p>
                <p id="5552" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Why did I do this? I was building
                  a <a class="at cg gs gt gu gv" target="_blank" rel="noopener"
                    href="https://web.archive.org/web/20191204194221/https://medium.com/@ly.lee/work-in-progress-stm32-blue-pill-visual-programming-with-makecode-codal-and-libopencm3-422d308f252e?source=friends_link&sk=b39519335652415d5f4aa17c9e4af1d2">USB
                    Bootloader for the MakeCode visual programming tool</a> that’s web-browser based and requires all
                  these interfaces. I ran into lots of difficulty making all these interfaces coexist, almost giving up,
                  thinking it’s a Blue Pill hardware limitation… But it turned out to be a software problem.</p>
                <p id="faa5" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">This article documents all the
                  fixes I have made to create a working Blue Pill bootloader that has been tested on Windows, Mac and
                  Linux. If you’re creating a USB device based on STM32 microcontrollers, this article might help you
                  learn about the complex world of USB protocols. The complete source code is here…</p>
                <div class="gw gx gy gz ha hb"><a
                    href="https://github.com/lupyuen/bluepill-bootloader?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; lupyuen/bluepill-bootloader</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="ic r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
              </div>
            </div>
          </section>
          <hr class="ij dv ik il im ds in io ip iq ir" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <h1 id="b0d5" class="is it dz bk bj hx iu iv iw ix iy iz ja jb jc jd je">Capture USB Data with Wireshark
                </h1>
                <p id="1861" class="ge gf dz bk gg b gh jf gj jg gl jh gn ji gp jj gr">I highly recommend installing <a
                    href="https://www.wireshark.org/"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">Wireshark</a> to capture and view
                  USB data. After installing Wireshark (be sure to select USBPcap or usbmon when prompted during
                  installation), check this article for further instructions (Windows and Linux)…</p>
                <div class="gw gx gy gz ha hb"><a
                    href="https://wiki.wireshark.org/CaptureSetup/USB?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; CaptureSetup/USB - The Wireshark Wiki</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="jk r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="b506" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">For Mac check this article…</p>
                <div class="gw gx gy gz ha hb"><a
                    href="https://aud-ios.com/2017/10/22/usb-monitoring-with-wireshark/?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; macOS - How to: USB Monitoring with WireShark</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="jl r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="5689" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Once you have Wireshark
                  installed, you may download and view <a
                    href="https://github.com/lupyuen/bluepill-bootloader/tree/master/logs"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">the USB logs that I have
                    captured</a> while connecting our Blue Pill bootloader to Windows, Mac and Ubuntu.</p>
              </div>
            </div>
          </section>
          <hr class="ij dv ik il im ds in io ip iq ir" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <div class="figure jn jo jp jq jr cz cl cm paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/o2.png" /></p>
  
  
                
                  <figcaption><p><em>Common sight during my USB development…
                    “Drivers not installed” due to USB descriptor errors or USB request processing errors</em></p></figcaption>
                </div>
                <h1 id="62ce" class="is it dz bk bj hx iu jt iw ju iy jv ja jw jc jx je">The Original Bootloader</h1>
                <p id="3134" class="ge gf dz bk gg b gh jf gj jg gl jh gn ji gp jj gr">I started with this bootloader
                  code by Michał Moskal and Devan Lai…</p>
                <div class="gw gx gy gz ha hb"><a
                    href="https://github.com/mmoskal/uf2-stm32f103?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; mmoskal/uf2-stm32f103</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="jy r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="97a9" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">It’s based on the <a
                    href="http://libopencm3.org/docs/latest/stm32f1/html/modules.html"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">open-source libopencm3 library</a>
                  for STM32. It didn’t build with the latest version of libopencm3 on Visual Studio Code with the
                  PlatformIO extension, so I applied some patches from here…</p>
                <div class="gw gx gy gz ha hb"><a
                    href="https://github.com/trezor/trezor-mcu?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; trezor/trezor-mcu</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="jz r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="5d60" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">The patches fixed the build to
                  support WebUSB, USB 2.1 and Windows USB (more about this later). After <a class="at cg gs gt gu gv"
                    target="_blank" rel="noopener"
                    href="https://web.archive.org/https://medium.com/coinmonks/connect-stm32-blue-pill-to-sigfox-28c6f91bddc1">flashing
                    the Blue Pill with the ST Link V2 and PlatformIO</a>, I soon ran into interesting problems…</p>
              </div>
            </div>
          </section>
          <hr class="ij dv ik il im ds in io ip iq ir" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <div class="figure jn jo jp jq jr cz cl cm paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/o3.png" /></p>
  
  
                
                  <figcaption><p><em>USB Mass Storage Class (MSC) request to fetch
                    the maximum logical unit number (i.e. drive number). From the Wireshark log <a
                      href="https://github.com/lupyuen/bluepill-bootloader/blob/master/logs/usb-windows.pcapng.gz"
                      class="at cg gs gt gu gv" target="_blank"
                      rel="noopener nofollow">usb-windows.pcapng.gz</a>
                  </em></p></figcaption>
                </div>
                <h1 id="2619" class="is it dz bk bj hx iu jt iw ju iy jv ja jw jc jx je">USB Storage</h1>
                <p id="353c" class="ge gf dz bk gg b gh jf gj jg gl jh gn ji gp jj gr">The fixed code for supporting USB
                  storage is in <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/msc.c"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">msc.c</a>.</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km kn ko kp kq kr paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/o4.png" /></p>
  
  
               
                  <figcaption><p><em>Blue Pill appears on Windows as a USB Mass
                    Storage Device. At the lower left are the files emulated by Blue Pill (done by ghostfat.c)
                  </em></p></figcaption>
                </div>
                <p id="b519" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">To implement USB storage in any
                  USB device, we need to implement the <a
                    href="https://usb.org/sites/default/files/usbmassbulk_10.pdf"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow"><strong class="gg kt">USB Mass
                      Storage Class (MSC)</strong> specs</a>. So that we can connect the Blue Pill to a computer and it
                  will appear as a USB drive. Within the specs, we’ll see that it actually uses the (very old!) SCSI
                  protocol for reading and writing to the USB drive, and also for fetching the storage details. The
                  Wireshark screen above shows a simple USB MSC command.</p>
                <p id="f7b0" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Thankfully we don’t need to
                  implement the SCSI protocol ourselves. libopencm3 handles it for us, according to <a
                    href="https://github.com/libopencm3/libopencm3-examples/blob/master/examples/stm32/f4/stm32f4-discovery/usb_msc/msc.c"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">this sample code</a>… just call
                  <code class="dj ku kv kw kx b">usb_msc_init()</code> and libopencm3 does everything automagically.
                  However the USB MSC implementation <code class="dj ku kv kw kx b">usb_msc_init()</code> in libopencm3
                  is missing some features, so I copied the libopencm3 source file and patched myself…</p>
                <p id="7080" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr"><strong class="gg kt">1️⃣
                    libopencm3 doesn’t implement the </strong><code
                    class="dj ku kv kw kx b"><strong class="gg kt">SCSI_READ_FORMAT_CAPACITIES</strong></code><strong
                    class="gg kt"> and </strong><code
                    class="dj ku kv kw kx b"><strong class="gg kt">SCSI_PREVENT_ALLOW_MEDIUM_REMOVAL</strong></code><strong
                    class="gg kt"> SCSI commands</strong></p>
                <p id="e501" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr"><code
                    class="dj ku kv kw kx b">SCSI_READ_FORMAT_CAPACITIES</code> is important because Windows will send
                  this command to query the storage size. Without it, our USB bootloader won’t work with Windows. I
                  found the implementation here..</p>
                <div class="gw gx gy gz ha hb"><a
                    href="https://habr.com/company/thirdpin/blog/304924/?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; USB mass storage device и libopencm3</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="ky r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="65dd" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">And patched it <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/msc.c#L551-L572"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">in my code here</a>. Note that the
                  <code
                    class="dj ku kv kw kx b"><a href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/msc.c#L568" class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">bytes_to_write</a></code><a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/msc.c#L568"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow"> setting in the article is
                    incorrect</a>. I have also applied a <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/msc.c#L723-L739"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">patch for MSC request handling</a>
                  that’s mentioned in the article.</p>
                <p id="aa3e" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">According my logs, Windows is
                  also sending the command <code class="dj ku kv kw kx b">SCSI_PREVENT_ALLOW_MEDIUM_REMOVAL</code>. I
                  cooked up a <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/msc.c#L624-L632"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">dummy implementation here</a>.</p>
                <p id="1891" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">2️⃣ <strong
                    class="gg kt">libopencm3 doesn’t implement </strong><code
                    class="dj ku kv kw kx b"><strong class="gg kt">SCSI_INQUIRY</strong></code><strong class="gg kt">
                    completely</strong></p>
                <p id="9467" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">This bug took me a while to track
                  down. When I logged the USB requests from Windows, I noticed that Windows kept sending the <code
                    class="dj ku kv kw kx b"><a href="http://www.usbmadesimple.co.uk/ums_4.htm" class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">SET_ADDRESS</a></code>
                  USB request to Blue Pill every minute. Windows was telling Blue Pill, <em class="kz">“use USB address
                    5 now… switch to address 6 now… switch back to address 5 now…”</em></p>
                <div class="figure jn jo jp jq jr cz">
                  
                  <p><script src="https://gist.github.com/lupyuen/2f05e5a1875c279023bf92c952683e49.js"></script></p>


                  <figcaption><p><em>Windows sending SET_ADDRESS 5… 6… 5… 6…
                  </em></p></figcaption>
                </div>
                <p id="e9dc" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">I soon discovered that’s a sign
                  that Windows is resetting our Blue Pill because it didn’t like the response to one of the previous
                  commands. I traced it to the <code class="dj ku kv kw kx b">SCSI_INQUIRY</code> command, which missed
                  out some important bits,<a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/msc.c#L438-L549"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow"> and I patched my version
                    here</a>. (Yes I had to dig through the tedious SCSI specs.)</p>
                <p id="4074" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">3️⃣ <strong
                    class="gg kt">libopencm3 doesn’t play nice with with multiple USB interfaces</strong></p>
                <p id="0abf" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">The official documentation for
                  <code class="dj ku kv kw kx b">usb_msc_init()</code> says cryptically, <a
                    href="http://libopencm3.org/docs/latest/stm32f1/html/group__usb__msc.html#ga5e6959c3ac6ff4efab4fd3b59353f497"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow"><em class="kz">“Currently you can
                      only have this profile active.”</em></a> I found out the hard way that it doesn’t coexist well
                  with other USB interfaces (e.g. USB Serial). Instead of rejecting unrecognised USB requests with an
                  error (<code class="dj ku kv kw kx b">USBD_REQ_NOTSUPP</code>), I fixed the code to <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/msc.c#L887"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">hand off the unknown request to
                    the next USB interface</a> (<code class="dj ku kv kw kx b">USBD_REQ_NEXT_CALLBACK</code>).</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km kn ko kp kq kr paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/o5.png" /></p>
  
  
                
                  <figcaption><p><em>ghostfat.c emulates a 4 MB flash drive and
                    exposes the 3 files above</em></p></figcaption>
                </div>
                <p id="e6fe" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">For our bootloader, we expect
                  MakeCode users to copy <a
                    href="https://github.com/Microsoft/uf2"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">UF2 files</a> in order to flash
                  the Blue Pill ROM. So in the USB storage code <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/usb_conf.c#L395-L403"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">we register the callbacks</a>
                  <code class="dj ku kv kw kx b">read_block(), write_block()</code> (<a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/ghostfat.c"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">defined in </a><code
                    class="dj ku kv kw kx b"><a href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/ghostfat.c" class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">ghostfat.c</a></code>)
                  that will flash each 512-byte block of the UF2 file into ROM.</p>
                <p id="9e5a" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">By handling the <code
                    class="dj ku kv kw kx b">read_block(), write_block()</code> callbacks, <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/ghostfat.c"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">the code in </a><code
                    class="dj ku kv kw kx b"><a href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/ghostfat.c" class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">ghostfat.c</a></code>
                  emulates a 4 MB flash drive formatted with the FAT filesystem (sector size 512). The Blue Pill
                  hardware doesn’t actually have 4 MB of storage. When we copy a UF2 file into the drive for flashing,
                  <code class="dj ku kv kw kx b">ghostfat.c</code> will read in 1 sector (512 bytes) from the computer,
                  write the 512 bytes into flash memory, and repeat until the entire UF2 file is processed.</p>
                <p id="c3ae" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr"><a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/msc.c.old"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">Check this file</a> for a RAM Disk
                  implementation of the FAT filesystem.</p>
              </div>
            </div>
          </section>
          <hr class="ij dv ik il im ds in io ip iq ir" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <h1 id="ebb8" class="is it dz bk bj hx iu iv iw ix iy iz ja jb jc jd je">USB Serial</h1>
                <p id="814c" class="ge gf dz bk gg b gh jf gj jg gl jh gn ji gp jj gr">The code for handling USB Serial
                  interface is in <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/cdc.c"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">cdc.c</a>. This is based on the <a
                    href="https://github.com/Apress/Beg-STM32-Devel-FreeRTOS-libopencm3-GCC/blob/master/rtos/usbcdcdemo/usbcdc.c"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">sample code here</a>.</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km kn ko kp kq kr paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/o6.png" /></p>
  
  
                  <figcaption><p><em>Blue Pill appears as a USB Serial Device on
                    COM3. We may use putty to connect to COM3 and Blue Pill will echo everything that we type
                  </em></p></figcaption>
                </div>
                <p id="aead" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">When you connect the Blue Pill to
                  your computer, the bootloader code exposes a USB serial port to the computer, which is useful for
                  debugging Blue Pill programs. For completeness <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/cdc.c"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">I added the implementation of
                  </a><code class="dj ku kv kw kx b">USB_CDC_REQ_GET_LINE_CODING</code> just to satisfy Windows when it
                  asks for the serial port parameters (e.g. 9600 bps, 1 stop bit, 8 data bits).</p>
                <p id="6ef3" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">USB Serial is more complex than
                  USB Storage because we need to implement not one but two interfaces from the <a
                    href="https://en.wikipedia.org/wiki/USB_communications_device_class"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow"><strong class="gg kt">USB
                      Communications Device Class (CDC)</strong></a><strong class="gg kt"> </strong>spec:</p>
                <ol class="">
                  <li id="541c" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr lf lg lh"><strong
                      class="gg kt">Data Model</strong> for sending and receiving data over the serial port</li>
                  <li id="1a60" class="ge gf dz bk gg b gh li gj lj gl lk gn ll gp lm gr lf lg lh"><strong
                      class="gg kt">Abstract Control Model (ACM)</strong> for getting and setting the serial connection
                    parameters, like 9600 bps, 1 stop bit, 8 data bits. <code
                      class="dj ku kv kw kx b">USB_CDC_REQ_GET_LINE_CODING</code> is part of the ACM interface. <a
                      href="https://cscott.net/usb_dev/data/devclass/usbcdc11.pdf"
                      class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">More details here</a>.</li>
                </ol>
                <p id="fd80" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">We are stacking up multiple
                  interfaces — USB MSC (for storage) and USB CDC (for serial comms). And within USB CDC interface we are
                  stacking up the CDC Data and CDC ACM sub-interfaces.</p>
                <p id="ee2f" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">How does USB support this
                  stacking? With a USB Composite Device and multiple USB Descriptors.</p>
                <div class="gw gx gy gz ha hb"><a
                    href="https://www.linkedin.com/feed/update/urn:li:activity:6479715878161223680?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; &quot;Supercomplicated USB
                            Descriptors for #STM32 Blue Pill UF2 Bootloader…</div>
                          <p></p>
                          </div>
                      <div class="ib r">
                        <div class="ln r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
              </div>
            </div>
          </section>
          <hr class="ij dv ik il im ds in io ip iq ir" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <h1 id="339b" class="is it dz bk bj hx iu iv iw ix iy iz ja jb jc jd je">USB Descriptors</h1>
                <p id="2c5e" class="ge gf dz bk gg b gh jf gj jg gl jh gn ji gp jj gr">The Blue Pill Bootloader is a
                  <strong class="gg kt">USB Composite Device</strong>, meaning that it supports <strong
                    class="gg kt">multiple USB interfaces</strong> (storage, serial, DFU). When we connect the Blue Pill
                  to a computer, Windows (or Mac or Linux) will query the Blue Pill for the USB interfaces that it
                  supports. In the USB world, <a
                    href="https://docs.microsoft.com/en-us/windows-hardware/drivers/usbcon/standard-usb-descriptors"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">everything is defined through
                    “Descriptors”.</a> Descriptors are very important for getting our Blue Pill to function as a proper
                  USB device under Windows, Mac AND Linux. So pay attention…</p>
                <div class="figure jn jo jp jq jr cz cl cm paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/o7.png" /></p>
  
  
               
                  <figcaption><p><em>Hierarchy of USB Descriptors. From <a
                      href="https://docs.microsoft.com/en-us/windows-hardware/drivers/usbcon/standard-usb-descriptors"
                      class="at cg gs gt gu gv" target="_blank"
                      rel="noopener nofollow">"Standard USB descriptors"</a>
                  </em></p></figcaption>
                </div>
                <p id="872f" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Our Blue Pill USB Descriptors <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/usb_conf.c#L51-L336"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">are defined here</a>. As shown in
                  the diagram above, the USB Descriptors are defined in a hierarchy…</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km lq lr ls lt kr">
              
                  <p><script src="https://gist.github.com/lupyuen/ac26b8a2148a20de9c367c0b7b745560.js"></script></p>


                  <figcaption><p><em>USB Device Descriptor</em></p></figcaption>
                </div>
                <p id="14fc" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr"><strong class="gg kt">1️⃣ Device
                    Descriptor</strong>: At the top level we define the USB Device.</p>
                <p id="be99" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">The Device Descriptor includes
                  the USB Vendor ID and Product ID (the official designation of the device), plus the manufacturer and
                  product names (defined as String Descriptors, explained below).</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km lq lr ls lt kr">
             
                  <p><script src="https://gist.github.com/lupyuen/43b7b4e2f0d50d39c2fb891da96292d7.js"></script></p>


                  <figcaption><p><em>USB Configuration Descriptor</em></p></figcaption>
                </div>
                <p id="e025" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">2️⃣ <strong
                    class="gg kt">Configuration Descriptor</strong>: At the next level we define the device
                  configuration, which includes the list of interfaces and the expected power to be supplied to the
                  device.</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km lq lr ls lt kr">
              
                  <p><script src="https://gist.github.com/lupyuen/b55577706b3fdc84d03075118f6006cf.js"></script></p>


                  <figcaption><p><em>USB Interface Descriptor for USB Storage (MSC)
                    interface</em></p></figcaption>
                </div>
                <p id="08e0" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">3️⃣ <strong
                    class="gg kt">Interface Descriptor</strong>: Defines the interfaces implemented by the device, like
                  MSC for USB Storage and CDC for USB Serial.</p>
                <p id="4727" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Each interface includes a list of
                  USB endpoints (usually 0, 1 or 2 endpoints).</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km lq lr ls lt kr">
             
                  <p><script src="https://gist.github.com/lupyuen/d05e224595516b2773840302a29fe1f6.js"></script></p>


                  <figcaption><p><em>USB Endpoint Descriptors for USB Storage (MSC)
                    interface</em></p></figcaption>
                </div>
                <p id="d8dc" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">4️⃣ <strong
                    class="gg kt">Endpoint Descriptor</strong>: What’s a USB endpoint? It works like a TCP socket. When
                  our Windows / Mac / Linux computer wishes to send a storage or serial request to the Blue Pill, the
                  computer needs to send the request to a USB endpoint (or address) for the USB interface (storage or
                  serial).</p>
                <p id="5c64" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">OUT endpoints are used by the
                  computer to send data to our Blue Pill. OUT endpoints are numbered <code
                    class="dj ku kv kw kx b">0x01, 0x02, … 0x0F</code>.</p>
                <p id="e516" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">IN endpoints are used by the Blue
                  Pill to send data to the computer. IN endpoints are numbered <code
                    class="dj ku kv kw kx b">0x81, 0x82, … 0x8F</code>.</p>
                <p id="d9e4" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Endpoints <code
                    class="dj ku kv kw kx b">0x00</code> and <code class="dj ku kv kw kx b">0x80</code> are reserved for
                  USB device control messages. They are used by the computer to fetch the Blue Pill’s USB descriptors
                  and to control the Blue Pill.</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km lq lr ls lt kr">
           
                  <p><script src="https://gist.github.com/lupyuen/073984471bc064216995d0a6b18c0b95.js"></script></p>


                  <figcaption><p><em>USB Interface Association Descriptor for USB
                    Serial (CDC) interface</em></p></figcaption>
                </div>
                <p id="1b5d" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">5️⃣ <strong
                    class="gg kt">Interface Association Descriptor</strong>: Remember that the USB Serial CDC interface
                  requires two sub-interfaces — CDC ACM and CDC Data?</p>
                <p id="ed4b" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">To do this we need to define the
                  parent interface for CDC and define ACM and Data as the child interfaces. The parent interface is
                  defined using the Interface Association Descriptor.</p>
                <p id="20e4" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Check out the sample code, which
                  defines <code class="dj ku kv kw kx b">cdc_iface_assoc</code> as the parent Interface Association
                  Descriptor, and <code class="dj ku kv kw kx b">comm_iface, data_iface</code> as the child interfaces.
                </p>
                <p id="6ee3" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">How did I discover this obscure
                  descriptor? By using Wireshark to capture the USB traffic from BBC micro:bit! The micro:bit runs a UF2
                  Bootloader that’s as complex as ours, so it’s a good reference for our Blue Pill bootloader.</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km lq lr ls lt kr">
            
                  <p><script src="https://gist.github.com/lupyuen/b80d5c0a647bed6bc67f8d2f9570d68a.js"></script></p>


                  <figcaption><p><em>USB String Descriptor</em></p></figcaption>
                </div>
                <p id="b06a" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">6️⃣ <strong class="gg kt">String
                    Descriptor</strong>: The last descriptor defines all the text strings referenced by the other
                  descriptors, like the interface names. Each string is assigned a running sequence number 1, 2, 3, …
                </p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km kn ko kp kq kr paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/o8.png" /></p>
  
  
                  <figcaption><p><em>String Descriptor 0 returns the supported
                    Language ID (0x0409). From the Wireshark log <a
                      href="https://github.com/lupyuen/bluepill-bootloader/blob/master/logs/usb-windows.pcapng.gz"
                      class="at cg gs gt gu gv" target="_blank"
                      rel="noopener nofollow">usb-windows.pcapng.gz</a>
                  </em></p></figcaption>
                </div>
                <p id="edbe" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">In the Wireshark capture logs we
                  may see the computer requesting for String Descriptor with index 0.</p>
                <p id="8c07" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">This is actually a request for
                  the Language ID that our device supports. By default the Blue Pill returns <code
                    class="dj ku kv kw kx b">0x0409</code>, the Language ID for US English.</p>
                <p id="4a8c" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">The above USB descriptors are
                  standard and we don’t need to write any code to handle the descriptor processing — libopencm3 handles
                  the requests for all these descriptors automagically.</p>
              </div>
            </div>
            <div class="cz">
              <div class="n p">
                <div class="lw lx ly lz ma mb ag mc ah md aj ak">
                  <div class="figure jn jo jp jq jr cz mf mg paragraph-image">
                
                    <p><img src="https://lupyuen.github.io/images/legacy2/o9.png" /></p>
    
    
                  
                    <figcaption><p><em>Long list of USB Descriptors used by our
                      Blue Pill bootloader. From <a
                        href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/usb_conf.c"
                        class="at cg gs gt gu gv" target="_blank"
                        rel="noopener nofollow">bluepill-bootloader/usb_conf.c</a>
                    </em></p></figcaption>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <p id="9845" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">The complete list of USB
                  descriptors for our Blue Pill bootloader is rather long, and it’s amazing that they all work for
                  Windows, Mac AND Linux! It’s unlikely that you’ll work on something this complex, but if you’re stuck,
                  do what I did… use Wireshark to sniff out another device that works!</p>
                <h1 id="15b1" class="is it dz bk bj hx iu jt iw ju iy jv ja jw jc jx je">USB 2.1 Descriptors</h1>
                <p id="4b7a" class="ge gf dz bk gg b gh jf gj jg gl jh gn ji gp jj gr">Ready for more USB descriptors?
                  Here’s a long and powerful one— the <strong class="gg kt">Binary Device Object Store (BOS)
                    Descriptor.</strong> The BOS Descriptor allows us to define USB descriptors that for non-standard
                  platforms, like Windows.</p>
                <p id="817c" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Remember that we defined in the
                  USB Device Descriptor that we support USB 2.1 instead of the usual USB 2.0? <strong class="gg kt">USB
                    2.1 devices are required to support BOS Descriptors</strong>, which are not implemented in
                  libopencm3, so we have to <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/usb21_standard.c#L61-L87"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">handle them in
                    usb21_standard.c</a>.</p>
                <p id="adb7" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Why did we choose to implement
                  USB 2.1 and BOS Descriptors? So that we could implement WebUSB and USB DFU (we’ll meet them later).
                  The two BOS Descriptors we have <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/webusb.c"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">implemented in webusb.c</a> are…
                </p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km lq lr ls lt kr">
             
                  <p><script src="https://gist.github.com/lupyuen/637665dd6e4a31b28633e99c1c5eb556.js"></script></p>


                </div>
                <p id="6ec6" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">1️⃣ <strong class="gg kt">WebUSB
                    Descriptor</strong>: Here we declare that our Blue Pill bootloader supports the WebUSB standard,
                  implemented by Google Chrome web browsers.</p>
                <p id="cf25" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">When the Chrome browser detects
                  that our device supports WebUSB, it will send our device a USB request to fetch the landing page URL
                  for our device.</p>
                <div class="figure jn jo jp jq jr cz cl cm paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/o10.png" /></p>
  
  
                  
                  <figcaption><p><em>On macOS, the landing page URL is displayed as
                    a Chrome notification. On Windows the notification seems to be disabled.</em></p></figcaption>
                </div>
                <p id="5139" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">This WebUSB request is <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/webusb.c#L74-L118"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">implemented in webusb.c</a> since
                  it’s not a standard USB request handled by libopencm3. Chrome transmits the vendor code <code
                    class="dj ku kv kw kx b">0x22</code> in the request so that we know the request is from Chrome
                  WebUSB.</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km lq lr ls lt kr">
             
                  <p><script src="https://gist.github.com/lupyuen/8bc3e97a903d320a19f6a6abf9289b45.js"></script></p>


                </div>
                <p id="8ffb" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">2️⃣ <strong
                    class="gg kt">Microsoft OS 2.0 Descriptor</strong>: This defines a set of descriptors specific to
                  Windows that we’ll cover in the next section.</p>
                <p id="e77a" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Windows will send our device a
                  USB request to fetch the set of Windows-specific descriptors.</p>
                <p id="46fe" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">This Windows descriptor request
                  is <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/winusb.c#L159-L185"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">implemented in winusb.c</a> since
                  it’s not a standard USB request handled by libopencm3. Windows transmits the vendor code <code
                    class="dj ku kv kw kx b">0x21</code> in the request so that we know the request is from Windows.</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km kn ko kp kq kr paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/o11.png" /></p>
  
  
                 
                  <figcaption><p><em>Windows requesting the BOS Descriptor from
                    Blue Pill. From the Wireshark log <a
                      href="https://github.com/lupyuen/bluepill-bootloader/blob/master/logs/usb-windows.pcapng.gz"
                      class="at cg gs gt gu gv" target="_blank"
                      rel="noopener nofollow">usb-windows.pcapng.gz</a>
                  </em></p></figcaption>
                </div>
                <p id="e432" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">The Microsoft OS 2.0 Descriptor
                  implementation is not part of the original bootloader source code. I added this code as a replacement
                  for the older Microsoft OS 1.0 Descriptor implementation. The older implementation is <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/winusb.c#L186-L213"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">still in winusb.c</a>.</p>
                <p id="3ea5" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">For details of the BOS Descriptor
                  format, see the official <a
                    href="https://www.usb.org/document-library/usb-32-specification-released-september-22-2017-and-ecns"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">USB 3.2 Specification</a><strong
                    class="gg kt">, </strong>Section 9.6.2 “Binary Device Object Store (BOS)”. If you’re looking for the
                  official USB 2.1 Specs… Don’t! Technically USB 2.1 doesn’t exist as a standard.</p>
                <p id="2fec" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">BOS is actually part of the USB
                  3.0 specs, but our Blue Pill bootloader doesn’t implement the entire USB 3.0 specs. The industry has
                  adopted the name “USB 2.1” to refer to a USB 2.0 device that supports BOS. Which fits our purpose
                  perfectly.</p>
              </div>
            </div>
          </section>
          <hr class="ij dv ik il im ds in io ip iq ir" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <div class="jn jo jp jq jr hb"><a
                    href="https://msdn.microsoft.com/en-us/library/windows/hardware/dn385747.aspx?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; Microsoft OS 2.0 Descriptors Specification</div>
                          <p></p>
                      </div>
                    </section>
                  </a></div>
                <h1 id="eb4a" class="is it dz bk bj hx iu jt iw ju iy jv ja jw jc jx je">Windows USB Descriptors</h1>
                <p id="437c" class="ge gf dz bk gg b gh jf gj jg gl jh gn ji gp jj gr">Because of the BOS Descriptor,
                  Windows will query our Blue Pill bootloader for the Microsoft OS 2.0 Descriptors documented above. The
                  long list of Windows descriptors for Blue Pill is <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/winusb.c#L33-L91"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">defined in winusb.c</a> (obtained
                  <a href="https://github.com/intel/zephyr.js/blob/master/src/zjs_webusb.c"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">from here</a>). We’ll look at two
                  interesting descriptors…</p>
                <div class="figure jn jo jp jq jr cz do kg cd kh ki kj kk kl ba km lq lr ls lt kr">
             
                  <p><script src="https://gist.github.com/lupyuen/ee03e3593aaecb4b01abbeb35783e006.js"></script></p>


                  <figcaption><p><em>Compatible ID Descriptor</em></p></figcaption>
                </div>
                <div class="figure da cz do kg cd kh ki kj kk kl ba km lq lr ls lt kr">
             
                  <p><script src="https://gist.github.com/lupyuen/361240afd2ed9b902ed0881c0360808b.js"></script></p>


                  <figcaption><p><em>Registry Property Descriptor</em></p></figcaption>
                </div>
                <p id="d533" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">1️⃣ <strong
                    class="gg kt">Compatible ID Descriptor</strong>: This declares to Windows that the first USB
                  interface (DFU) of our Blue Pill bootloader is compatible with WinUSB.</p>
                <p id="58f8" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Windows will then use the
                  standard <code class="dj ku kv kw kx b">WinUSB.sys</code> driver for the DFU interface.</p>
                <p id="8db4" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">2️⃣ <strong
                    class="gg kt">Registry Property Descriptor</strong>: This declares to Windows that it should create
                  a Windows registry setting named <code class="dj ku kv kw kx b">DeviceInterfaceGUIDs</code> with value
                  <code class="dj ku kv kw kx b">{9D32F82C-1FB2–4486–8501-B6145B5BA336}</code></p>
                <p id="1846" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Creating this registry setting is
                  mandatory when using the WinUSB driver for a USB interface.</p>
                <p id="d413" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr"><strong class="gg kt">Why use
                    WinUSB for the DFU interface?</strong></p>
                <p id="87f5" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">The <a
                    href="https://www.st.com/content/ccc/resource/technical/document/application_note/6a/17/92/02/58/98/45/0c/CD00264379.pdf/files/CD00264379.pdf/jcr:content/translations/en.CD00264379.pdf"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">STM32 DFU</a> USB Interface <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/dfu.c"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">implemented in dfu.c</a> is meant
                  to allow us to flash the Blue Pill through the Chrome browser, without the installation of any
                  drivers. The WinUSB driver is preloaded with Windows, so it doesn’t need any installation.</p>
                <p id="8468" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">WinUSB exposes a low-level data
                  transfer interface that WebUSB applications may call to <a
                    href="https://developer.mozilla.org/en-US/docs/Web/API/USBDevice/controlTransferOut"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">transfer data to the DFU
                    interface</a>. So WinUSB is the right Windows USB driver for supporting the DFU interface. For more
                  details, check this article…</p>
                <div class="gw gx gy gz ha hb"><a
                    href="https://docs.microsoft.com/en-us/windows-hardware/drivers/usbcon/automatic-installation-of-winusb?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; WinUSB Device - Windows drivers</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="mm r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="1cfa" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">When you’re changing the Blue
                  Pill bootloader code and testing it, make sure you run <code class="dj ku kv kw kx b">regedit</code>
                  and delete the Windows registry key...
                  
                  <pre>HLKM\SYSTEM\CurrentControlSet\Control\UsbFlags\vvvvpppprrrrr</pre>
                    
                  <em class="kz"> </em>where <code class="dj ku kv kw kx b">vvvv</code> is the vendor ID, <code
                    class="dj ku kv kw kx b">pppp</code> is the product ID and <code
                    class="dj ku kv kw kx b">rrrrr</code> is the device revision number. If the key exists, Windows will
                  skip the querying of descriptors from the Blue Pill bootloader, and use the old descriptors values
                  instead. This is mentioned here…</p>
                <div class="gw gx gy gz ha hb"><a
                    href="https://docs.microsoft.com/en-us/windows-hardware/drivers/usbcon/microsoft-defined-usb-descriptors?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; Microsoft OS Descriptors for USB Devices - Windows drivers
                          </div>
                      </div>
                      <div class="ib r">
                        <div class="mn r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
              </div>
            </div>
          </section>
          <hr class="ij dv ik il im ds in io ip iq ir" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <div class="jn jo jp jq jr hb"><a
                    href="https://devanlai.github.io/webdfu/dfu-util/?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; WebUSB DFU</div>
                          <p></p>
                      </div>
                    </section>
                  </a></div>
                <h1 id="1171" class="is it dz bk bj hx iu jt iw ju iy jv ja jw jc jx je">WebUSB</h1>
                <p id="a0c3" class="ge gf dz bk gg b gh jf gj jg gl jh gn ji gp jj gr">Now that WebUSB and WinUSB have
                  been configured for our Blue Pill’s DFU interface, click the link above to test them. We should be
                  able to communicate with the Blue Pill bootloader through the Chrome browser and prepare to flash the
                  ROM (set the Transfer Size to 256 bytes) with the <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/firmware.bin"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">firmware.bin file</a>. (But don’t
                  run the flash command yet because the bootloader has exceeded the 16K limit and will clash with the
                  flashed firmware.)</p>
              </div>
            </div>
            <div class="cz">
              <div class="n p">
                <div class="lw lx ly lz ma mb ag mc ah md aj ak">
                  <div class="figure jn jo jp jq jr cz">
                    <div class="dh r di">
                      <div class="mo r"><iframe
                          src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2FsrSTTt1fTeI%3Ffeature%3Doembed&amp;url=http%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DsrSTTt1fTeI&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2FsrSTTt1fTeI%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube"
                          allowfullscreen="" frameborder="0" height="300" width="400"
                          title="STM32 Blue Pill Bootloader with WebUSB DFU" class="cp t u dd ak"
                          scrolling="auto"></iframe></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <p id="a9ee" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">To experiment with WebUSB, open a
                  Chrome console and enter this…</p>
                <pre
                  class="jn jo jp jq jr mp mq mr"><span id="261f" class="ms it dz bk kx b dp mt mu r mv">await navigator.usb.requestDevice({ filters: [] })</span></pre>
                <p id="6315" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">This lets us browse the Blue Pill
                  bootloader descriptors through the JavaScript console in Chrome. If we sniff the USB data with
                  Wireshark while this is running, we’ll see that the Chrome browser actually sends its own queries to
                  refetch the USB descriptors.</p>
              </div>
            </div>
            <div class="cz">
              <div class="n p">
                <div class="lw lx ly lz ma mb ag mc ah md aj ak">
                  <div class="figure jn jo jp jq jr cz">
                    <div class="dh r di">
                      <div class="mo r"><iframe
                          src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2FJbwl7g-jMIw%3Ffeature%3Doembed&amp;url=http%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DJbwl7g-jMIw&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2FJbwl7g-jMIw%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube"
                          allowfullscreen="" frameborder="0" height="300" width="400"
                          title="STM32 Blue Pill Bootloader with WebUSB" class="cp t u dd ak" scrolling="auto"></iframe>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <p id="ae89" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">I have tested the Blue Pill
                  bootloader’s WebUSB support on Chrome for <strong class="gg kt">Windows, Mac and Ubuntu</strong>
                  (requires root privilege). To troubleshoot the WebUSB interface, use the <strong class="gg kt">Chrome
                    Device Log</strong>:</p>
                <pre
                  class="jn jo jp jq jr mp mq mr"><span id="d16d" class="ms it dz bk kx b dp mt mu r mv">chrome://device-log/</span></pre>
                <p id="2de7" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">For details of the WebUSB
                  JavaScript API, refer to these docs…</p>
                <div class="gw gx gy gz ha hb"><a
                    href="https://developer.mozilla.org/en-US/docs/Web/API/USB?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; USB</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="mw r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
                <div class="gw gx gy gz ha hb"><a
                    href="https://developer.mozilla.org/en-US/docs/Web/API/USBDevice?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; USBDevice</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="mx r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
              </div>
            </div>
          </section>
          <hr class="ij dv ik il im ds in io ip iq ir" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <div class="jn jo jp jq jr hb"><a
                    href="https://www.linkedin.com/feed/update/urn:li:activity:6479571365698605056?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; &quot;Quiz for #libopencm3 hackers...
                            What&#x27;s wrong with this sample code…</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="my r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
                <h1 id="e170" class="is it dz bk bj hx iu jt iw ju iy jv ja jw jc jx je">USB Callbacks</h1>
                <p id="267c" class="ge gf dz bk gg b gh jf gj jg gl jh gn ji gp jj gr">The sample USB programs for
                  libopencm3 look like this…</p>
                <div class="figure jn jo jp jq jr cz">
                
                  <p><script src="https://gist.github.com/lupyuen/aa2a674563793789f5bb25165a4bdf5276aaa.js"></script></p>


                  <figcaption><p><em>Sample USB code from <a
                      href="https://github.com/libopencm3/libopencm3-examples/blob/master/examples/stm32/f3/stm32f3-discovery/usb_cdcacm/cdcacm.c"
                      class="at cg gs gt gu gv" target="_blank"
                      rel="noopener nofollow">libopencm3/cdcacm.c</a>
                  </em></p></figcaption>
                </div>
                <p id="b377" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">There are 2 functions used to
                  register callbacks in USB programs…</p>
                <ol class="">
                  <li id="c30f" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr lf lg lh"><code
                      class="dj ku kv kw kx b">usbd_register_set_config_callback()</code>: This registers a callback
                    function that is called when the USB device has set its configuration.</li>
                  <li id="a34d" class="ge gf dz bk gg b gh li gj lj gl lk gn ll gp lm gr lf lg lh"><code
                      class="dj ku kv kw kx b">usbd_register_control_callback()</code>: This registers a callback
                    function that is called when the USB device receives a request on the control channel.</li>
                </ol>
                <p id="b7b2" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Each of these functions support
                  up to maximum of 4 callbacks. Since our Blue Pill bootloader has 4 USB interfaces + BOS Interface +
                  WinUSB + WebUSB, we would have exceeded the limit. So I wrote <a
                    href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/usb_conf.c#L407-L532"
                    class="at cg gs gt gu gv" target="_blank" rel="noopener nofollow">my own code to aggregate the
                    callbacks</a>, supporting up to 10 callbacks.</p>
                <p id="0794" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">To use the aggregated callbacks,
                  we change the code as follows…</p>
                <ol class="">
                  <li id="e3ad" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr lf lg lh">Change<em class="kz">
                    </em><code class="dj ku kv kw kx b"><em class="kz">usbd_register_set_config_callback</em></code>
                    <br />to <strong class="gg kt">aggregate_register_config_callback</strong></li>
                  <li id="21c1" class="ge gf dz bk gg b gh li gj lj gl lk gn ll gp lm gr lf lg lh">Change <code
                      class="dj ku kv kw kx b"><em class="kz">usbd_register_control_callback</em></code><em class="kz">
                      <br /></em>to<strong class="gg kt"> aggregate_register_callback</strong></li>
                </ol>
                <p id="1276" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">We should always check the status
                  of the callback registration like this…</p>
                <div class="figure jn jo jp jq jr cz">
              
                  <p><script src="https://gist.github.com/lupyuen/7bf824d65ad4c065f41fa96352fdcdae.js"></script></p>


                  <figcaption><p><em>Aggregating USB callbacks, from <a
                      href="https://github.com/lupyuen/bluepill-bootloader/blob/master/src/cdc.c"
                      class="at cg gs gt gu gv" target="_blank"
                      rel="noopener nofollow">bluepill-bootloader/cdc.c</a>
                  </em></p></figcaption>
                </div>
              </div>
            </div>
          </section>
          <hr class="ij dv ik il im ds in io ip iq ir" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <div class="jn jo jp jq jr hb"><a
                    href="https://www.linkedin.com/feed/update/urn:li:activity:6480260050907693056?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp;  &quot;#STM32 Blue Pill Bootloader now
                            runs great... Supports USB Storage, USB…</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="mz r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
                <h1 id="6c25" class="is it dz bk bj hx iu jt iw ju iy jv ja jw jc jx je">Finally It Works!</h1>
                <p id="405c" class="ge gf dz bk gg b gh jf gj jg gl jh gn ji gp jj gr">This version of the Blue Pill
                  Bootloader worked successfully on Windows, Mac and Linux after lots of experimenting. It’s my first
                  time working on USB firmware and I wished there were more articles explaining what’s really happening
                  in the USB realm. I hope this article, source code and captured USB logs will get you started on USB
                  firmware programming a lot faster.</p>
              </div>
            </div>
            <div class="cz ak">
              <div class="figure jn jo jp jq jr cz ak paragraph-image">
                
                <p><img src="https://lupyuen.github.io/images/legacy2/o12.png" /></p>


            
              </div>
            </div>
          </section>
          <hr class="ij dv ik il im ds in io ip iq ir" />
          <section class="cu cv cw cx cy">
            <div class="n p">
              <div class="ac ae af ag ah dw aj ak">
                <div class="jn jo jp jq jr hb"><a
                    href="https://www.linkedin.com/feed/update/urn:li:activity:6481124238043504640?source=post_page-----36d7fe245b5c----------------------"
                    rel="noopener nofollow">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; &quot;#STM32 Blue Pill Bootloader now
                            supports ROM flashing via Chrome…</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="na r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
                <h1 id="171d" class="is it dz bk bj hx iu jt iw ju iy jv ja jw jc jx je">And the work goes on…</h1>
                <p id="771d" class="ge gf dz bk gg b gh jf gj jg gl jh gn ji gp jj gr">I have started working on a new
                  branch that supports WebUSB flashing using MakeCode’s HF2 protocol. Check out my updates here…</p>
                <div class="gw gx gy gz ha hb"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-dissecting-the-webusb-bootloader-for-makecode">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; STM32 Blue Pill — Dissecting the WebUSB Bootloader for MakeCode
                          </div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="nb r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="c3ce" class="ge gf dz bk gg b gh gi gj gk gl gm gn go gp gq gr">Is it possible to upgrade the
                  Bootloader through another Bootloader? Yes we can! Check this article…</p>
                <div class="gw gx gy gz ha hb"><a rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-bootloading-the-webusb-bootloader">
                    <section class="he cl cm ak ce n ar hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht">
                      <div class="hu n co p hv hw">
                          <div class="de hc fb fc hd fe">&bull;&nbsp;&nbsp; STM32 Blue Pill — Bootloading the WebUSB Bootloader</div>
                          <p></p>
                      </div>
                      <div class="ib r">
                        <div class="nc r id ie if ib ig ih ii"></div>
                      </div>
                    </section>
                  </a></div>
              </div>
            </div>
            <div class="cz ak">
              <div class="figure jn jo jp jq jr cz">
                <div class="dh r di">
                  <div class="mo r"><iframe
                      src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2Ff3inYvl6j4E%3Ffeature%3Doembed&amp;url=http%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3Df3inYvl6j4E&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2Ff3inYvl6j4E%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube"
                      allowfullscreen="" frameborder="0" height="300" width="400"
                      title="STM32 Blue Pill and MakeCode flashing with HF2 over WebUSB" class="cp t u dd ak"
                      scrolling="auto"></iframe></div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </article>
    </div>
  </div>

  <ul>
    <li>
    <p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io">Check out my articles</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
    </li>
  </ul>
    
</body>

</html>
<!--
     FILE ARCHIVED ON 19:42:48 Dec 04, 2019 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 01:30:37 Feb 23, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 351.768
  exclusion.robots: 0.209
  exclusion.robots.policy: 0.202
  RedisCDXSource: 1.556
  esindex: 0.009
  LoadShardBlock: 325.298 (3)
  PetaboxLoader3.datanode: 115.218 (4)
  CDXLines.iter: 21.705 (3)
  load_resource: 76.421
  PetaboxLoader3.resolve: 44.493
-->