<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>PineDio Stack BL604 runs Apache NuttX RTOS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="PineDio Stack BL604 runs Apache NuttX RTOS" 
    data-rh="true">
<meta property="og:description" 
    content="Running Apache NuttX RTOS on PineDio Stack BL604 RISC-V board... With ST7789 Display, LVGL Graphics and LoRaWAN"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/pinedio2-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">PineDio Stack BL604 runs Apache NuttX RTOS</h1>
    <nav id="rustdoc"><ul>
<li><a href="#what-is-nuttx" title="What is NuttX?">1 What is NuttX?</a><ul></ul></li>
<li><a href="#build-nuttx" title="Build NuttX">2 Build NuttX</a><ul></ul></li>
<li><a href="#prepare-pinedio-stack" title="Prepare PineDio Stack">3 Prepare PineDio Stack</a><ul></ul></li>
<li><a href="#flash-pinedio-stack" title="Flash PineDio Stack">4 Flash PineDio Stack</a><ul></ul></li>
<li><a href="#boot-pinedio-stack" title="Boot PineDio Stack">5 Boot PineDio Stack</a><ul></ul></li>
<li><a href="#run-nuttx" title="Run NuttX">6 Run NuttX</a><ul></ul></li>
<li><a href="#nuttx-apps" title="NuttX Apps">7 NuttX Apps</a><ul></ul></li>
<li><a href="#more-apps" title="More Apps">8 More Apps</a><ul></ul></li>
<li><a href="#upcoming-features" title="Upcoming Features">9 Upcoming Features</a><ul></ul></li>
<li><a href="#whats-next" title="What‚Äôs Next">10 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes" title="Notes">11 Notes</a><ul></ul></li>
<li><a href="#appendix-gpio-assignment" title="Appendix: GPIO Assignment">12 Appendix: GPIO Assignment</a><ul></ul></li>
<li><a href="#appendix-bundled-features" title="Appendix: Bundled Features">13 Appendix: Bundled Features</a><ul></ul></li>
<li><a href="#appendix-upcoming-features" title="Appendix: Upcoming Features">14 Appendix: Upcoming Features</a><ul>
<li><a href="#gpio-expander" title="GPIO Expander">14.1 GPIO Expander</a><ul></ul></li>
<li><a href="#push-button" title="Push Button">14.2 Push Button</a><ul></ul></li>
<li><a href="#touch-panel" title="Touch Panel">14.3 Touch Panel</a><ul></ul></li>
<li><a href="#accelerometer" title="Accelerometer">14.4 Accelerometer</a><ul></ul></li>
<li><a href="#power-management" title="Power Management">14.5 Power Management</a><ul></ul></li>
<li><a href="#gps" title="GPS">14.6 GPS</a><ul></ul></li>
<li><a href="#spi-flash" title="SPI Flash">14.7 SPI Flash</a><ul></ul></li>
<li><a href="#spi-direct-memory-access" title="SPI Direct Memory Access">14.8 SPI Direct Memory Access</a><ul></ul></li>
<li><a href="#automated-testing" title="Automated Testing">14.9 Automated Testing</a><ul></ul></li></ul></li>
<li><a href="#appendix-sx1262-lora-transceiver" title="Appendix: SX1262 LoRa Transceiver">15 Appendix: SX1262 LoRa Transceiver</a><ul>
<li><a href="#test-lora" title="Test LoRa">15.1 Test LoRa</a><ul></ul></li>
<li><a href="#test-lorawan" title="Test LoRaWAN">15.2 Test LoRaWAN</a><ul></ul></li>
<li><a href="#test-cbor-encoder" title="Test CBOR Encoder">15.3 Test CBOR Encoder</a><ul></ul></li></ul></li>
<li><a href="#appendix-shared-spi-bus" title="Appendix: Shared SPI Bus">16 Appendix: Shared SPI Bus</a><ul>
<li><a href="#spi-device-id" title="SPI Device ID">16.1 SPI Device ID</a><ul></ul></li>
<li><a href="#swap-miso--mosi" title="Swap MISO / MOSI">16.2 Swap MISO / MOSI</a><ul></ul></li>
<li><a href="#spi-device-table" title="SPI Device Table">16.3 SPI Device Table</a><ul></ul></li>
<li><a href="#pin-definitions" title="Pin Definitions">16.4 Pin Definitions</a><ul></ul></li>
<li><a href="#select--deselect-spi-device" title="Select / Deselect SPI Device">16.5 Select / Deselect SPI Device</a><ul></ul></li>
<li><a href="#spi-command--data" title="SPI Command / Data">16.6 SPI Command / Data</a><ul></ul></li>
<li><a href="#deselect-all-spi-devices" title="Deselect All SPI Devices">16.7 Deselect All SPI Devices</a><ul></ul></li>
<li><a href="#test-shared-spi-bus" title="Test Shared SPI Bus">16.8 Test Shared SPI Bus</a><ul></ul></li>
<li><a href="#st7789-spi-mode" title="ST7789 SPI Mode">16.9 ST7789 SPI Mode</a><ul></ul></li>
<li><a href="#st7789-spi-frequency" title="ST7789 SPI Frequency">16.10 ST7789 SPI Frequency</a><ul></ul></li>
<li><a href="#sx1262-chip-select" title="SX1262 Chip Select">16.11 SX1262 Chip Select</a><ul></ul></li></ul></li></ul></nav><p>üìù <em>12 Apr 2022</em></p>
<p><img src="https://lupyuen.github.io/images/pinedio2-title.jpg" alt="Pine64 PineDio Stack BL604 RISC-V Board" /></p>
<p><em>Pine64 PineDio Stack BL604 RISC-V Board</em></p>
<p><strong>PineDio Stack BL604</strong> is Pine64‚Äôs newest microcontroller board, based on <a href="https://lupyuen.github.io/articles/pinecone"><strong>Bouffalo Lab‚Äôs BL604</strong></a> RISC-V + WiFi + Bluetooth LE SoC.</p>
<p>(Available any day now!)</p>
<p>PineDio Stack is packed <strong>chock-full of features</strong>‚Ä¶</p>
<ul>
<li>
<p>ST7789 <strong>Colour LCD Display</strong></p>
<p>(240 x 240 pixels)</p>
</li>
<li>
<p>CST816S <strong>Touch Panel</strong></p>
<p>(Connected on I2C)</p>
</li>
<li>
<p>Semtech SX1262 <strong>LoRa Transceiver</strong></p>
<p>(Works with LoRaWAN wireless networks)</p>
</li>
<li>
<p>AT6558 <strong>GPS / GNSS Receiver</strong></p>
</li>
<li>
<p>SGM40561 <strong>Power Management Unit</strong></p>
</li>
<li>
<p><strong>Heart Rate Sensor, Accelerometer, Compass, Vibrator</strong></p>
</li>
<li>
<p><strong>SPI Flash, JTAG Debugging Port, Push Button</strong></p>
</li>
<li>
<p><strong>2.4 GHz WiFi, Bluetooth LE</strong></p>
<p>(Thanks to BL604)</p>
</li>
</ul>
<p>Which makes it an awesome gadget for <strong>IoT Education</strong>!</p>
<p>(It looks like a <strong>‚ÄúChonky PineTime‚Äù</strong>‚Ä¶ It has the same display and touch panel as PineTime)</p>
<p>Today we shall build, flash and run the open-source, community-supported <a href="https://lupyuen.github.io/articles/nuttx"><strong>Apache NuttX RTOS</strong></a> (Real-Time Operating System) on PineDio Stack‚Ä¶</p>
<p>And get started on creating <strong>our own IoT Apps</strong>!</p>
<p><img src="https://lupyuen.github.io/images/spi2-pinedio2a.jpg" alt="Pine64 PineDio Stack BL604 RISC-V Board" /></p>
<p><em>Pine64 PineDio Stack BL604 RISC-V Board</em></p>
<h1 id="what-is-nuttx"><a class="doc-anchor" href="#what-is-nuttx">¬ß</a>1 What is NuttX?</h1>
<p><a href="https://nuttx.apache.org/docs/latest/"><strong>Apache NuttX</strong></a> is a popular Real-Time Operating System (RTOS) for microcontrollers (8-bit to 64-bit). It runs on all kinds of hardware: <strong>Arm, ESP32, RISC-V,</strong> ‚Ä¶ Even <a href="https://docs.px4.io/master/en/"><strong>flying drones</strong></a>!</p>
<p>NuttX feels like a <strong>lighter version of Linux</strong> because it uses familiar functions to access the microcontroller hardware:  <em>open(), read(), write(), ioctl(), ‚Ä¶</em></p>
<p>(NuttX is <a href="https://nuttx.apache.org/docs/latest/introduction/inviolables.html#strict-posix-compliance"><strong>POSIX Compliant</strong></a>)</p>
<p>We‚Äôve done many fun experiments with NuttX on BL602 and BL604: <a href="https://lupyuen.github.io/articles/st7789"><strong>ST7789 Display</strong></a>, <a href="https://lupyuen.github.io/articles/bme280"><strong>BME280 Sensor</strong></a>, <a href="https://lupyuen.github.io/articles/ikea"><strong>IKEA Air Quality Sensor</strong></a>, <a href="https://github.com/lupyuen/bl602_adc_test"><strong>Internal Temperature Sensor</strong></a>, <a href="https://lupyuen.github.io/articles/sx1262"><strong>LoRa</strong></a>, <a href="https://lupyuen.github.io/articles/lorawan3"><strong>LoRaWAN</strong></a>, <a href="https://lupyuen.github.io/articles/rusti2c"><strong>Rust</strong></a>, <a href="https://lupyuen.github.io/articles/nuttx#basic-interpreter"><strong>BASIC</strong></a>, <a href="https://lupyuen.github.io/articles/cbor2"><strong>CBOR</strong></a>, ‚Ä¶ And now PineDio Stack.</p>
<p>The source code for <strong>NuttX on PineDio Stack</strong> is here‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/nuttx/tree/pinedio"><strong>lupyuen/nuttx</strong> (pinedio branch)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-apps/tree/pinedio"><strong>lupyuen/nuttx-apps</strong> (pinedio branch)</a></p>
<p><a href="https://github.com/apache/nuttx/pulls?q=is%3Apr+author%3Alupyuen+is%3Aclosed">(Yep I‚Äôm a NuttX Contributor)</a></p>
</li>
</ul>
<p>Let‚Äôs go hands-on with NuttX!</p>
<p><img src="https://lupyuen.github.io/images/nuttx-build2.png" alt="Building NuttX" /></p>
<h1 id="build-nuttx"><a class="doc-anchor" href="#build-nuttx">¬ß</a>2 Build NuttX</h1>
<p>NuttX builds fine on <strong>Linux</strong> (x64), <strong>macOS</strong> and <strong>Windows Subsystem for Linux</strong> (WSL).</p>
<p>Here are the steps to build NuttX for PineDio Stack‚Ä¶</p>
<ol>
<li>
<p>Install the <strong>build prerequisites</strong>‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/nuttx#install-prerequisites"><strong>‚ÄúInstall Prerequisites‚Äù</strong></a></p>
</li>
<li>
<p>Enter these commands to <strong>download, configure and build</strong> NuttX‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>##  Download NuttX for PineDio Stack
mkdir nuttx
cd nuttx
git clone --recursive --branch pinedio https://github.com/lupyuen/nuttx nuttx
git clone --recursive --branch pinedio https://github.com/lupyuen/nuttx-apps apps

##  Configure NuttX for PineDio Stack
cd nuttx
./tools/configure.sh bl602evb:pinedio

##  Build NuttX for PineDio Stack
make</code></pre></div></li>
<li>
<p>We should see‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>LD: nuttx
CP: nuttx.hex
CP: nuttx.bin</code></pre></div>
<p>We have successfully built the NuttX Firmware for PineDio Stack!</p>
<p><a href="https://gist.github.com/lupyuen/3ff5b3a5b6c160c76d56e33c35745ef7">(See the WSL Build Log)</a></p>
<p><a href="https://gist.github.com/lupyuen/5a043443b58447e7a2ec6e8832ee1310">(See the macOS Build Log)</a></p>
</li>
<li>
<p><strong>For WSL:</strong> Copy the NuttX Firmware to the <strong>c:\blflash</strong> directory in the Windows File System‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>##  /mnt/c/blflash refers to c:\blflash in Windows
mkdir /mnt/c/blflash
cp nuttx.bin /mnt/c/blflash</code></pre></div>
<p>We‚Äôll flash PineDio Stack with Windows Command Prompt (CMD) because we need the COM port.</p>
</li>
</ol>
<p><em>What‚Äôs ‚Äúbl602evb:pinedio‚Äù?</em></p>
<p>That‚Äôs the <strong>NuttX Build Configuration</strong> for PineDio Stack. It selects the Build Options, NuttX Drivers and NuttX Apps that will run on PineDio Stack.</p>
<p><a href="https://lupyuen.github.io/articles/pinedio2#appendix-bundled-features">(See the bundled features)</a></p>
<p><img src="https://lupyuen.github.io/images/pinedio2-test1.jpg" alt="PineDio Stack Self-Test" /></p>
<h1 id="prepare-pinedio-stack"><a class="doc-anchor" href="#prepare-pinedio-stack">¬ß</a>3 Prepare PineDio Stack</h1>
<p>Let‚Äôs get ready to flash the NuttX Firmware to PineDio Stack!</p>
<ul>
<li>
<p>Connect PineDio Stack to our computer‚Äôs <strong>USB Port</strong>.</p>
<p>The <strong>Self Test</strong> screen appears. (Pic above)</p>
<p><strong>Tap each button</strong> to verify that PineDio Stack is OK.</p>
<p><a href="https://lupyuen.github.io/images/pinedio2-test.jpg">(We should see this)</a></p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/pinedio2-back.jpg" alt="PineDio Stack Back Cover" /></p>
<ul>
<li>
<p>Disconnect PineDio Stack from the USB Port.</p>
<p>Carefully open the <strong>Back Cover</strong> of PineDio Stack. (Pic above)</p>
<p>(Don‚Äôt remove the display!)</p>
<p>We‚Äôll see the <strong>PineDio Stack Baseboard</strong>‚Ä¶</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/pinedio2-inside7.jpg" alt="PineDio Stack Baseboard" /></p>
<ul>
<li>
<p>Carefully <strong>remove the PineDio Stack Baseboard</strong>.</p>
<p>We‚Äôll see the <strong>Main Board</strong>‚Ä¶</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/pinedio2-inside5.jpg" alt="Inside PineDio Stack" /></p>
<p><em>What‚Äôs on the Main Board?</em></p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/images/pinedio2-jumper.jpg"><strong>GPIO 8 Jumper</strong></a> (top right): Set PineDio Stack to Flashing Mode or Normal Mode</p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio#appendix-improvised-reset-button-for-pinedio-stack"><strong>Improvised Reset Button</strong></a> (lower left): We connect a Jumper Cable (to the I2C Port) to restart PineDio Stack during flashing and testing</p>
</li>
<li>
<p><strong>LoRa Antenna</strong> (bottom): Connect an antenna here if we‚Äôre testing LoRa</p>
</li>
<li>
<p><strong>WiFi / Bluetooth LE Antenna</strong> (right): Connect an antenna here if we‚Äôre testing WiFi or Bluetooth LE</p>
</li>
<li>
<p><strong>JTAG Port</strong> (top left): For debugging (but not flashing)</p>
</li>
<li>
<p><strong>GPIO Port</strong> (lower right): Connects the baseboard</p>
</li>
<li>
<p><strong>Push Button</strong> (just below the jumper): Works like a watch button</p>
</li>
</ul>
<p>Check out the <strong>PineDio Stack Schematics</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/pinedio_stack_v1_0-2021_09_15-a.pdf"><strong>PineDio Stack Schematic</strong> (2021-09-15)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/PINEDIO_STACK_BASEBOARD_V1_0-SCH-2021-09-27.pdf"><strong>PineDio Stack Baseboard Schematic</strong> (2021-09-27)</a></p>
</li>
</ul>
<p>We‚Äôre ready to flash PineDio Stack!</p>
<p><img src="https://lupyuen.github.io/images/nuttx-flash2.png" alt="Flashing NuttX" /></p>
<p><a href="https://gist.github.com/lupyuen/9c0dbd75bb6b8e810939a36ffb5c399f">(Source)</a></p>
<h1 id="flash-pinedio-stack"><a class="doc-anchor" href="#flash-pinedio-stack">¬ß</a>4 Flash PineDio Stack</h1>
<p>Let‚Äôs flash the NuttX Firmware to PineDio Stack.  Follow these steps to install <strong>blflash</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/flash#install-rustup"><strong>‚ÄúInstall rustup‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/flash#download-and-build-blflash"><strong>‚ÄúDownload blflash‚Äù</strong></a></p>
</li>
</ul>
<p>Set PineDio Stack to <strong>Flashing Mode</strong> and restart the board‚Ä¶</p>
<ol>
<li>
<p>Set the <strong>GPIO 8 Jumper</strong> to <strong>High</strong> <a href="https://lupyuen.github.io/images/pinedio-high.jpg">(Like this)</a></p>
</li>
<li>
<p>Disconnect the USB cable and reconnect</p>
<p>Or use the Improvised Reset Button <a href="https://lupyuen.github.io/articles/pinedio#appendix-improvised-reset-button-for-pinedio-stack">(Here‚Äôs how)</a></p>
</li>
</ol>
<p>Enter these commands to flash <strong>nuttx.bin</strong> to PineDio Stack‚Ä¶</p>
<p>(<strong>For WSL:</strong> Do this in Windows Command Prompt CMD instead of WSL. blflash needs to access the COM port)</p>
<div class="example-wrap"><pre class="language-bash"><code>## For Linux: Change &quot;/dev/ttyUSB0&quot; to the PineDio Stack Serial Port
blflash flash nuttx.bin \
  --port /dev/ttyUSB0 

## For macOS: Change &quot;/dev/tty.usbserial-1410&quot; to the PineDio Stack Serial Port
blflash flash nuttx.bin \
  --port /dev/tty.usbserial-1410 \
  --initial-baud-rate 230400 \
  --baud-rate 230400

## For Windows: Change &quot;COM5&quot; to the PineDio Serial Port
blflash flash c:\blflash\nuttx.bin --port COM5</code></pre></div>
<p>We should see‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Sending eflash_loader...
Erase flash addr: 10000 size: 565200
Program flash...
Program done 27.434715128s 20.12KiB/s
Success</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/9c0dbd75bb6b8e810939a36ffb5c399f">(See the Flash Log)</a></p>
<p>NuttX has been flashed to PineDio Stack!</p>
<p><em>Will PineDio Stack get bricked if we flash bad firmware?</em></p>
<p>After using BL602 and BL604 for 1.5 years, I‚Äôve never bricked a single BL602 or BL604 board.</p>
<p>So go ahead and create your own PineDio Stack firmware, it‚Äôs all OK!</p>
<p><a href="https://github.com/apache/nuttx/issues/4336">(Flashing WiFi apps? See this)</a></p>
<p><img src="https://lupyuen.github.io/images/nuttx-boot2.png" alt="Running NuttX" /></p>
<h1 id="boot-pinedio-stack"><a class="doc-anchor" href="#boot-pinedio-stack">¬ß</a>5 Boot PineDio Stack</h1>
<p>Like Linux, NuttX provides a <strong>Command-Line Interface</strong> for controlling our gadget. This is how we access the <strong>NuttX Shell</strong>‚Ä¶</p>
<p>Set PineDio Stack to <strong>Normal Mode</strong> (Non-Flashing) and restart the board‚Ä¶</p>
<ol>
<li>
<p>Set the <strong>GPIO 8 Jumper</strong> to <strong>Low</strong> <a href="https://lupyuen.github.io/images/pinedio-low.jpg">(Like this)</a></p>
</li>
<li>
<p>Disconnect the USB cable and reconnect</p>
<p>Or use the Improvised Reset Button <a href="https://lupyuen.github.io/articles/pinedio#appendix-improvised-reset-button-for-pinedio-stack">(Here‚Äôs how)</a></p>
</li>
</ol>
<p>After restarting, connect a <strong>Serial Terminal</strong> to PineDio Stack at <strong>2 Mbps</strong>‚Ä¶</p>
<p><strong>For Linux:</strong> Use <strong>screen</strong></p>
<div class="example-wrap"><pre class="language-bash"><code>screen /dev/ttyUSB0 2000000</code></pre></div>
<p><strong>For macOS:</strong> Use CoolTerm <a href="https://lupyuen.github.io/articles/flash#watch-the-firmware-run">(See this)</a></p>
<p><strong>For Windows:</strong> Use putty <a href="https://lupyuen.github.io/articles/flash#watch-the-firmware-run">(See this)</a></p>
<p><strong>Alternatively:</strong> Use the Web Serial Terminal <a href="https://lupyuen.github.io/articles/flash#watch-the-firmware-run">(See this)</a></p>
<p>Press Enter to reveal the <strong>NuttX Shell</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-10.2.0-RC0
nsh&gt;</code></pre></div>
<p>Congratulations NuttX is now running on PineDio Stack!</p>
<p><img src="https://lupyuen.github.io/images/pinedio2-boot4.jpg" alt="PineDio Stack boots with Pink Screen" /></p>
<h1 id="run-nuttx"><a class="doc-anchor" href="#run-nuttx">¬ß</a>6 Run NuttX</h1>
<p>NuttX boots with a <a href="https://lupyuen.github.io/articles/st7789#render-pink-screen"><strong>Pink Screen</strong></a>. (Pic above)</p>
<p>In the NuttX Shell, enter this command‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>ls /dev</code></pre></div>
<p>We see a list of <strong>Device Drivers</strong> that were loaded by NuttX. (Pic below)</p>
<p>Now that NuttX is up, let‚Äôs run some NuttX Apps!</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/pinedio2-run4a.png" alt="Device Drivers loaded by NuttX" /></p>
</blockquote>
<blockquote>
<p><a href="https://gist.github.com/lupyuen/80f3bc431c9e5aa93d429809c9554629">(Source)</a></p>
</blockquote>
<blockquote>
<p><a href="https://lupyuen.github.io/articles/expander">(<strong>UPDATE:</strong> We have renumbered the GPIOs)</a></p>
</blockquote>
<h1 id="nuttx-apps"><a class="doc-anchor" href="#nuttx-apps">¬ß</a>7 NuttX Apps</h1>
<p>In the NuttX Shell, enter this command‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>help</code></pre></div>
<p>(‚Äú<strong><code>?</code></strong>‚Äù works too)</p>
<p>We see a list of <strong>NuttX Apps</strong> that have been installed‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Builtin Apps:
  bas             lorawan_test  spi_test2
  bl602_adc_test  lvgltest      sx1262_test
  getprime        nsh           timer
  gpio            sensortest    tinycbor_test
  hello           spi
  i2c             spi_test
  ikea_air_quality_sensor</code></pre></div>
<p>Enter this to run the <strong>LVGL Test App</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>lvgltest</code></pre></div>
<p>Follow the prompts to tap the screen and calibrate the Touch Panel.</p>
<p>After calibrating, this appears on the screen: <em>‚ÄúHello PineDio Stack!‚Äù</em> with a funky blue-green box‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pinedio2-title.jpg" alt="LVGL Test App on PineDio Stack" /></p>
<p><em>Can we render our own text and graphics?</em></p>
<p>Sure can! Below is the code that renders the screen, by calling the <a href="https://docs.lvgl.io/7.11/get-started/quick-overview.html#learn-the-basics"><strong>LVGL Graphics Library</strong></a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>//  Create the LVGL Widgets that will be rendered on the display
static void create_widgets(void) {
  //  Get the Active Screen
  lv_obj_t *screen = lv_scr_act();

  //  Create a Label Widget
  lv_obj_t *label = lv_label_create(screen, NULL);

  //  Wrap long lines in the label text
  lv_label_set_long_mode(label, LV_LABEL_LONG_BREAK);

  //  Interpret color codes in the label text
  lv_label_set_recolor(label, true);

  //  Center align the label text
  lv_label_set_align(label, LV_LABEL_ALIGN_CENTER);

  //  Set the label text and colors
  lv_label_set_text(
    label, 
    &quot;#ff0000 HELLO# &quot;    //  Red Text
    &quot;#00ff00 PINEDIO# &quot;  //  Green Text
    &quot;#0000ff STACK!# &quot;   //  Blue Text
  );

  //  Set the label width
  lv_obj_set_width(label, 200);

  //  Align the label to the center of the screen, shift 30 pixels up
  lv_obj_align(label, NULL, LV_ALIGN_CENTER, 0, -30);

  //  Omitted: Render a rounded rectangle with LVGL Canvas</code></pre></div>
<p><a href="https://github.com/lupyuen/lvgltest-nuttx/blob/main/lvgltest.c#L110-L198">(Source)</a></p>
<p>To render our own text and graphics, edit this source file and change the code above‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>apps/examples/lvgltest/lvgltest.c</code></pre></div>
<p>Then rebuild (‚Äú<code>make</code>‚Äù) and reflash (‚Äú<code>blflash</code>‚Äù) NuttX to PineDio Stack.</p>
<p><a href="https://docs.lvgl.io/7.11/get-started/quick-overview.html#learn-the-basics">(More about LVGL)</a></p>
<p><em>So touchscreen apps are supported on PineDio Stack?</em></p>
<p>Yep! See this for the details‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/pinedio2#touch-panel"><strong>‚ÄúPineDio Stack Touch Panel‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/pinedio2-run5.png" alt="bl602_adc_test: Shows the Internal Temperature of BL604" /></p>
<p><a href="https://gist.github.com/lupyuen/deb752ac79c7b0ad51c6da6889660c27">(Source)</a></p>
<h1 id="more-apps"><a class="doc-anchor" href="#more-apps">¬ß</a>8 More Apps</h1>
<p><em>What other NuttX Apps can we try?</em></p>
<ul>
<li>
<p><strong>hello</strong>: Prints <em>‚ÄúHello World‚Äù</em></p>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/pinedio/examples/hello/hello_main.c">(Source code)</a></p>
</li>
<li>
<p><strong>bl602_adc_test</strong>: Shows the Internal Temperature of BL604</p>
<p><a href="https://github.com/lupyuen/bl602_adc_test">(See this)</a></p>
</li>
<li>
<p><strong>bas</strong>: BASIC Interpreter (Ctrl-D to quit)</p>
<p><a href="https://lupyuen.github.io/articles/nuttx#run-basic">(See this)</a></p>
</li>
</ul>
<p><a href="https://gist.github.com/lupyuen/deb752ac79c7b0ad51c6da6889660c27">(Here‚Äôs a demo of the apps)</a></p>
<p><em>What about LoRa on PineDio Stack?</em></p>
<p>We have NuttX Apps for testing <strong>LoRa and LoRaWAN</strong> wireless networking.</p>
<p>See the Appendix for details‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/pinedio2#appendix-sx1262-lora-transceiver"><strong>‚ÄúSX1262 LoRa Transceiver‚Äù</strong></a></li>
</ul>
<p><em>If we wish to create our own NuttX Apps?</em></p>
<p>Refer to the docs for the steps to create our own <strong>NuttX Apps, Libraries and Drivers</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/spi2#appendix-create-a-nuttx-app"><strong>‚ÄúHow To Create NuttX Apps‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/sx1262#appendix-create-a-nuttx-library"><strong>‚ÄúHow To Create NuttX Libraries‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/spi2#appendix-create-a-nuttx-device-driver"><strong>‚ÄúHow To Create NuttX Device Drivers‚Äù</strong></a></p>
</li>
</ul>
<p>Here are some <strong>Troubleshooting Tips</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/nuttx#appendix-nuttx-logging"><strong>‚ÄúNuttX Logging‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/auto#nuttx-crash-analysis"><strong>‚ÄúNuttX Crash Analysis‚Äù</strong></a></p>
</li>
</ul>
<p>Also check out the <strong>NuttX Articles</strong> on all kinds of topics‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/book#nuttx-on-bl602"><strong>‚ÄúNuttX on BL602 / BL604‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/pinedio-spi2.jpg" alt="Shared SPI Bus on PineDio Stack" /></p>
<p><em>Shared SPI Bus on PineDio Stack</em></p>
<h1 id="upcoming-features"><a class="doc-anchor" href="#upcoming-features">¬ß</a>9 Upcoming Features</h1>
<p><em>So PineDio Stack runs all hunky dory on NuttX?</em></p>
<p>Not completely. PineDio Stack‚Äôs <strong>Shared SPI Bus</strong> works great on NuttX after we modded the SPI Driver‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/pinedio2#appendix-shared-spi-bus"><strong>‚ÄúShared SPI Bus‚Äù</strong></a></li>
</ul>
<p>The <strong>ST7789 Display</strong> runs well with NuttX‚Äôs ST7789 Driver and LVGL Library right out of the box, with one tweak‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/pinedio2#st7789-spi-mode"><strong>‚ÄúST7789 SPI Mode‚Äù</strong></a></li>
</ul>
<p>And the <strong>SX1262 LoRa Transceiver</strong> works fine with Semtech‚Äôs Reference Drivers for LoRa and LoRaWAN‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/pinedio2#appendix-sx1262-lora-transceiver"><strong>‚ÄúSX1262 LoRa Transceiver‚Äù</strong></a></li>
</ul>
<p>But there‚Äôs <a href="https://lupyuen.github.io/articles/pinedio2#appendix-upcoming-features"><strong>plenty more porting work</strong></a> to be done!</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio2#gpio-expander"><strong>GPIO Expander</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio2#push-button"><strong>Push Button</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio2#accelerometer"><strong>Accelerometer</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio2#power-management"><strong>Power Management</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio2#gps"><strong>GPS</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio2#spi-flash"><strong>SPI Flash</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio2#spi-direct-memory-access"><strong>SPI Direct Memory Access</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio2#automated-testing"><strong>Automated Testing</strong></a></p>
</li>
</ul>
<p>If you‚Äôre keen to help, please lemme know! üôè</p>
<p><img src="https://lupyuen.github.io/images/pinedio2-title4.jpg" alt="Pine64 PineDio Stack BL604 RISC-V Board" /></p>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>10 What‚Äôs Next</h1>
<p>I hope this article has provided everything you need to get started on creating <strong>your own IoT App</strong>.</p>
<p>Lemme know what you‚Äôre building with PineDio Stack!</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/RISCV/comments/u0wwez/pinedio_stack_bl604_runs_apache_nuttx_rtos/"><strong>Discuss this article on Reddit</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/pinedio2.md"><strong>lupyuen.github.io/src/pinedio2.md</strong></a></p>
<h1 id="notes"><a class="doc-anchor" href="#notes">¬ß</a>11 Notes</h1>
<ol>
<li>
<p>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1510406086326513668"><strong>this Twitter Thread</strong></a></p>
</li>
<li>
<p>Got a question for Bouffalo Lab? Check out their <strong>Developer Forum</strong>‚Ä¶</p>
<p><a href="https://bbs.bouffalolab.com/"><strong>‚ÄúBouffalo Lab Developer Forum‚Äù</strong></a></p>
</li>
<li>
<p>Also check out the <strong>Nutcracker Channel</strong> on Matrix, Telegram, Discord or IRC‚Ä¶</p>
<p><a href="https://wiki.pine64.org/wiki/Main_Page#Chat_Platforms"><strong>‚ÄúPine64 Chat Platforms‚Äù</strong></a></p>
</li>
<li>
<p>Besides NuttX, there are two other ways to code firmware for PineDio Stack‚Ä¶</p>
<p><a href="https://github.com/bouffalolab/bl_iot_sdk"><strong>BL IoT SDL</strong></a>: Supports WiFi and is based on FreeRTOS</p>
<p><a href="https://github.com/bouffalolab/bl_mcu_sdk"><strong>BL MCU SDK</strong></a>: Doesn‚Äôt support WiFi, also based on FreeRTOS)</p>
</li>
<li>
<p>The PineDio Stack <strong>Self-Test Firmware</strong> was created by JF with BL MCU SDK‚Ä¶</p>
<p><a href="https://codeberg.org/JF002/pinedio-stack-selftest"><strong>JF002/pinedio-stack-selftest</strong></a></p>
</li>
<li>
<p><strong>LVGL Canvas</strong> consumes a lot of RAM! Disable it if we don‚Äôt really need it, we‚Äôll save 7 KB of RAM‚Ä¶</p>
<p>Configure NuttX with ‚Äú<code>make menuconfig</code>‚Äù</p>
<p>Select ‚ÄúApplication Configuration ‚Üí Graphics Support ‚Üí Light and Versatile Graphic Library (LVGL) ‚Üí Object Type Usage Settings‚Äù</p>
<p>Uncheck ‚ÄúCanvas Usage‚Äù</p>
<p>Save and exit menuconfig, then rebuild NuttX (<code>make</code>)</p>
</li>
<li>
<p>The <a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/PINEDIO_STACK_BASEBOARD_V1_0-SCH-2021-09-27.pdf"><strong>Baseboard Schematic</strong></a>
includes a <strong>Secure Chip ATECC608A</strong>. We talk about it here‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/lorawan2#cryptographic-co-processor"><strong>‚ÄúCryptographic Co-Processor‚Äù</strong></a></p>
</li>
<li>
<p>What‚Äôs it like to test the <strong>First (Buggy) Prototype</strong> of PineDio Stack? Find out here‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/pinedio"><strong>‚ÄúPineDio Stack BL604 RISC-V Board: Testing The Prototype‚Äù</strong></a></p>
</li>
</ol>
<h1 id="appendix-gpio-assignment"><a class="doc-anchor" href="#appendix-gpio-assignment">¬ß</a>12 Appendix: GPIO Assignment</h1>
<p>Acording to the PineDio Stack Schematics‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/pinedio_stack_v1_0-2021_09_15-a.pdf"><strong>PineDio Stack Schematic</strong> (2021-09-15)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/PINEDIO_STACK_BASEBOARD_V1_0-SCH-2021-09-27.pdf"><strong>PineDio Stack Baseboard Schematic</strong> (2021-09-27)</a></p>
</li>
</ul>
<p>These are the <strong>BL604 GPIOs</strong> used by PineDio Stack‚Ä¶</p>
<div><table><thead><tr><th style="text-align: center">GPIO</th><th style="text-align: left">Port</th><th style="text-align: left">Function</th><th style="text-align: left">Other Functions</th></tr></thead><tbody>
<tr><td style="text-align: center"><strong><code>0</code></strong></td><td style="text-align: left">SPI</td><td style="text-align: left">MISO</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><strong><code>1</code></strong></td><td style="text-align: left">Int I2C</td><td style="text-align: left">SDA</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><strong><code>2</code></strong></td><td style="text-align: left">Int I2C</td><td style="text-align: left">SCL</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><strong><code>3</code></strong></td><td style="text-align: left">Ext I2C</td><td style="text-align: left">SDA</td><td style="text-align: left">ST7789 Reset, <br>Compass Interrupt</td></tr>
<tr><td style="text-align: center"><strong><code>4</code></strong></td><td style="text-align: left">Ext I2C</td><td style="text-align: left">SCL</td><td style="text-align: left">GPS Reset</td></tr>
<tr><td style="text-align: center"><strong><code>5</code></strong></td><td style="text-align: left">Ext I2C</td><td style="text-align: left"></td><td style="text-align: left">Accelerometer Interrupt, <br>GPS On/Off</td></tr>
<tr><td style="text-align: center"><strong><code>6</code></strong></td><td style="text-align: left">Power Mgmt</td><td style="text-align: left">VBAT</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><strong><code>7</code></strong></td><td style="text-align: left">UART</td><td style="text-align: left">RX</td><td style="text-align: left">GPS RX</td></tr>
<tr><td style="text-align: center"><strong><code>8</code></strong></td><td style="text-align: left">Flashing Mode</td><td style="text-align: left"></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><strong><code>9</code></strong></td><td style="text-align: left">Touch Panel</td><td style="text-align: left">Interrupt</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><strong><code>10</code></strong></td><td style="text-align: left">SX1262</td><td style="text-align: left">Busy</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><strong><code>11</code></strong></td><td style="text-align: left">SPI</td><td style="text-align: left">SCK</td><td style="text-align: left">JTAG TDO</td></tr>
<tr><td style="text-align: center"><strong><code>12</code></strong></td><td style="text-align: left">Vibrator</td><td style="text-align: left"></td><td style="text-align: left">JTAG TMS, <br>Push Button</td></tr>
<tr><td style="text-align: center"><strong><code>13</code></strong></td><td style="text-align: left">SPI</td><td style="text-align: left">MOSI</td><td style="text-align: left">JTAG TDI</td></tr>
<tr><td style="text-align: center"><strong><code>14</code></strong></td><td style="text-align: left">SPI Flash</td><td style="text-align: left">CS</td><td style="text-align: left">JTAG TCK</td></tr>
<tr><td style="text-align: center"><strong><code>15</code></strong></td><td style="text-align: left">SX1262</td><td style="text-align: left">CS</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><strong><code>16</code></strong></td><td style="text-align: left">UART</td><td style="text-align: left">TX</td><td style="text-align: left">GPS TX</td></tr>
<tr><td style="text-align: center"><strong><code>17</code></strong></td><td style="text-align: left">Power Mgmt</td><td style="text-align: left">CHG</td><td style="text-align: left">Red LED</td></tr>
<tr><td style="text-align: center"><strong><code>18</code></strong></td><td style="text-align: left">SX1262</td><td style="text-align: left">Reset</td><td style="text-align: left">Touch Panel Reset</td></tr>
<tr><td style="text-align: center"><strong><code>19</code></strong></td><td style="text-align: left">SX1262</td><td style="text-align: left">Interrupt</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><strong><code>20</code></strong></td><td style="text-align: left">ST7789</td><td style="text-align: left">CS</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><strong><code>21</code></strong></td><td style="text-align: left">ST7789</td><td style="text-align: left">Backlight</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><strong><code>22</code></strong></td><td style="text-align: left">Heart Rate</td><td style="text-align: left">Interrupt</td><td style="text-align: left"></td></tr>
</tbody></table>
</div>
<ul>
<li>
<p><strong>SPI Bus ‚Äú/dev/spi0‚Äù</strong> is shared by ST7789 Display, SX1262 LoRa Transceiver and SPI Flash</p>
</li>
<li>
<p><strong>Internal I2C Bus ‚Äú/dev/i2c0‚Äù</strong> is shared by Accelerometer, Touch Panel, Heart Rate Sensor and Compass</p>
</li>
<li>
<p><strong>UART Port ‚Äú/dev/console‚Äù</strong> is shared by Serial Console and GPS</p>
<p>(This will be a problem, in spite of their different baud rates)</p>
</li>
<li>
<p><strong>GPIO Ports ‚Äú/dev/gpio0‚Äù to ‚Äú/dev/gpio22‚Äù</strong> are mapped to GPIO Pins 0 to 22</p>
<p>(Except the pins reserved for the UART, I2C and SPI Ports)</p>
</li>
</ul>
<p>The <strong>NuttX Pin Definitions</strong> for PineDio Stack are at‚Ä¶</p>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L43-L127">boards/risc-v/bl602/bl602evb/include/board.h</a></p>
<h1 id="appendix-bundled-features"><a class="doc-anchor" href="#appendix-bundled-features">¬ß</a>13 Appendix: Bundled Features</h1>
<p>Earlier we ran this command to <strong>configure the NuttX Build</strong> for PineDio Stack BL604‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>./tools/configure.sh bl602evb:pinedio</code></pre></div>
<p>The above command bundles the following <strong>NuttX Drivers, Libraries and Apps</strong> into NuttX for PineDio Stack‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/bl602_adc"><strong>BL602 ADC Library</strong></a></p>
<p><a href="https://github.com/lupyuen/lorawan_test">(Used by LoRaWAN Test App)</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/bme280"><strong>I2C Driver ‚Äú/dev/i2c0‚Äù</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/bme280">(Used by I2C Sensors)</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/st7789#lcd-driver"><strong>LCD Driver ‚Äú/dev/lcd0‚Äù</strong></a></p>
<p><a href="https://github.com/lupyuen/lvgltest-nuttx">(Used by LVGL Test App)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/lora-sx1262/tree/lorawan"><strong>LoRa SX1262 Library</strong></a></p>
<p><a href="https://github.com/lupyuen/LoRaMac-node-nuttx">(Used by LoRaWAN Library)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/LoRaMac-node-nuttx"><strong>LoRaWAN Library</strong></a></p>
<p><a href="https://github.com/lupyuen/lorawan_test">(Used by LoRaWAN Test App)</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/st7789#lvgl-demo-app"><strong>LVGL Graphics Library</strong></a></p>
<p><a href="https://github.com/lupyuen/lvgltest-nuttx">(Used by LVGL Test App)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nimble-porting-nuttx"><strong>NimBLE Porting Layer</strong></a></p>
<p><a href="https://github.com/lupyuen/lora-sx1262/tree/nuttx">(Used by LoRa SX1262 Library)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/rust-nuttx"><strong>Rust Stub Library</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/rusti2c">(Used by Rust Apps)</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/bme280#run-sensor-test-app"><strong>Sensor Test App</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/bme280">(For testing I2C Sensors)</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/spi2#file-descriptor"><strong>SPI Driver ‚Äú/dev/spi0‚Äù</strong></a></p>
<p><a href="https://github.com/lupyuen/nuttx/tree/pinedio/drivers/rf">(Used by SPI Test Driver)</a></p>
<p><a href="https://lupyuen.github.io/articles/st7789#load-st7789-driver">(And ST7789 Display Driver)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/tree/pinedio/drivers/rf"><strong>SPI Test Driver ‚Äú/dev/spitest0‚Äù</strong></a></p>
<p><a href="https://github.com/lupyuen/lora-sx1262/tree/lorawan">(Used by LoRa SX1262 Library)</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/st7789#load-st7789-driver"><strong>ST7789 Display Driver</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/st7789#lcd-driver">(Used by the LCD Driver)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen2/tinycbor-nuttx"><strong>TinyCBOR Library</strong></a></p>
<p><a href="https://github.com/lupyuen/tinycbor_test">(Used by TinyCBOR Test App)</a></p>
</li>
</ul>
<p>The <strong>NuttX Configuration File</strong> for PineDio Stack is at‚Ä¶</p>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/configs/pinedio/defconfig">boards/risc-v/bl602/bl602evb/configs/pinedio/defconfig</a></p>
<h1 id="appendix-upcoming-features"><a class="doc-anchor" href="#appendix-upcoming-features">¬ß</a>14 Appendix: Upcoming Features</h1>
<p>This section discusses the <strong>upcoming features</strong> that we‚Äôll implement with NuttX on PineDio Stack BL604.</p>
<p>If you‚Äôre keen to help, please lemme know! üôè</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/pinedio2-bl604.png" alt="PineDio Stack BL604" /></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/pinedio_stack_v1_0-2021_09_15-a.pdf">(Schematic)</a></p>
</blockquote>
<h2 id="gpio-expander"><a class="doc-anchor" href="#gpio-expander">¬ß</a>14.1 GPIO Expander</h2>
<p><a href="https://github.com/lupyuen/bl602_expander"><strong>UPDATE</strong>: We have implemented the GPIO Expander, so we‚Äôre no longer stuck with 3 GPIOs</a></p>
<p><em>BL604 has 23 GPIOs. Can we use all of them in NuttX Apps?</em></p>
<p>Some of the GPIOs will be used for <a href="https://lupyuen.github.io/articles/pinedio2#appendix-gpio-assignment"><strong>SPI, I2C and UART</strong></a>. But we still have <strong>a lot of remaining GPIOs</strong> to manage!</p>
<p>NuttX allows apps to access to a total of <strong>3 GPIOs</strong> on BL604‚Ä¶</p>
<ul>
<li>
<p><strong>/dev/gpio0</strong>: GPIO Input</p>
<p>(Configured as <a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L49-L53"><strong>GPIO 10</strong></a>)</p>
</li>
<li>
<p><strong>/dev/gpio1</strong>: GPIO Output</p>
<p>(Configured as <a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L54-L58"><strong>GPIO 15</strong></a>)</p>
</li>
<li>
<p><strong>/dev/gpio2</strong>: GPIO Interrupt</p>
<p>(Configured as <a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L59-L63"><strong>GPIO 19</strong></a>)</p>
</li>
</ul>
<p>(All 3 GPIOs are already used by the SX1262 Library. <a href="https://lupyuen.github.io/articles/sx1262#gpio-interface">See this</a>)</p>
<p>Adding the remaining GPIOs to the <a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_gpio.c#L106-L137"><strong>BL604 GPIO Driver</strong></a> at compile-time will be cumbersome. <a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_gpio.c#L106-L137">(See this)</a></p>
<p>We need a flexible way to manage many GPIOs at runtime, as we build new apps and drivers for PineDio Stack.</p>
<p><em>Is there a way to aggregate the GPIOs without defining them at compile-time?</em></p>
<p>NuttX supports <strong>GPIO Expanders</strong> that will aggregate multiple GPIOs‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/ioexpander/ioe_dummy.c"><strong>Sample I/O Expander</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/ioexpander/skeleton.c"><strong>Skeleton I/O Expander</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/ioexpander/gpio_lower_half.c"><strong>Lower Half of I/O Expander</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/sim/sim/sim/src/sim_ioexpander.c"><strong>Usage of I/O Expander</strong></a></p>
</li>
</ul>
<p>We shall implement a <strong>GPIO Expander for BL604</strong> that will handle multiple GPIOs by calling <a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_gpio.c#L58-L140"><strong>bl602_configgpio</strong></a>, <a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_gpio.c#L218-L230"><strong>bl602_gpioread</strong></a> and <a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_gpio.c#L197-L216"><strong>bl602_gpiowrite</strong></a>.</p>
<p>The GPIO Expander will expose GPIOs 0 to 22 as ‚Äú<strong>/dev/gpio0</strong>‚Äù to ‚Äú<strong>/dev/gpio22</strong>‚Äù.</p>
<p><em>Won‚Äôt this break the existing GPIOs that are in use?</em></p>
<p>We‚Äôll skip ‚Äú<strong>/dev/gpio0</strong>‚Äù to ‚Äú<strong>/dev/gpio2</strong>‚Äù because they are already used by the SX1262 Driver. <a href="https://lupyuen.github.io/articles/sx1262#gpio-interface">(See this)</a></p>
<p>(On PineDio Stack: GPIO 0 is MISO, GPIO 1 is SDA, GPIO 2 is SCL. So we shouldn‚Äôt touch GPIOs 0, 1 and 2 anyway. <a href="https://lupyuen.github.io/articles/pinedio2#appendix-gpio-assignment">See this</a>)</p>
<p><em>Wow this sounds messy?</em></p>
<p>But it might be the most productive way (for now) to handle so many GPIOs while multiple devs are <strong>building apps and drivers</strong> for PineDio Stack.</p>
<p>Perhaps the GPIO Expander can <strong>enforce checks at runtime</strong> to be sure that NuttX Apps don‚Äôt tamper with the GPIOs used by SPI, I2C and UART.</p>
<p>(And eventually the SX1262 Library will simply access <em>‚Äú/dev/gpio10‚Äù</em>, <em>‚Äú/dev/gpio15‚Äù</em> and <em>‚Äú/dev/gpio19‚Äù</em>)</p>
<p>More details on the GPIO Expander‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/bl602_expander"><strong>BL602 / BL604 GPIO Expander</strong></a></li>
</ul>
<p>The GPIO Expander shall also manage <strong>GPIO Interrupts</strong> for the Touch Panel, SX1262 Transceiver, Push Button, Compass, Accelerometer, Heart Rate Sensor, ‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/touch#appendix-gpio-interrupt"><strong>‚ÄúGPIO Interrupt‚Äù</strong></a></li>
</ul>
<p>There‚Äôs a discussion about <strong>GPIOs on BL604</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/apache/nuttx/issues/5810"><strong>‚ÄúGPIO issues on BL602‚Äù</strong></a></li>
</ul>
<p><em>NuttX Apps vs NuttX Drivers‚Ä¶ Do they handle GPIOs differently?</em></p>
<ul>
<li>
<p><strong>NuttX Drivers</strong> run in Kernel Mode and can access the GPIO Hardware directly by calling <a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_gpio.c#L58-L140"><strong>bl602_configgpio</strong></a>, <a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_gpio.c#L218-L230"><strong>bl602_gpioread</strong></a> and <a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_gpio.c#L197-L216"><strong>bl602_gpiowrite</strong></a>.</p>
<p>(So no problems handling many GPIOs)</p>
</li>
<li>
<p><strong>NuttX Apps</strong> run in User Mode and can only access GPIOs through ‚Äú<strong>/dev/gpioN</strong>‚Äù</p>
<p>(Which becomes a problem when we have many GPIOs)</p>
</li>
</ul>
<p><strong>NuttX Apps are easier to code</strong> than NuttX Drivers.</p>
<p><a href="https://lupyuen.github.io/articles/sx1262#small-steps">(That‚Äôs our experience with LoRa)</a></p>
<p>Thus we expect most PineDio Stack devs to <strong>create NuttX Apps first</strong> before moving the code into NuttX Drivers.</p>
<p>That‚Äôs why we need to handle GPIOs the messy (but productive) way for now.</p>
<p><a href="https://lupyuen.github.io/articles/nuttx#gpio-demo">(More about NuttX GPIO)</a></p>
<h2 id="push-button"><a class="doc-anchor" href="#push-button">¬ß</a>14.2 Push Button</h2>
<p>Robert Lipe has an excellent article on PineDio Stack‚Äôs Push Button‚Ä¶</p>
<ul>
<li><a href="https://www.robertlipe.com/buttons-on-bl602-nuttx/"><strong>‚ÄúButtons on BL602 NuttX‚Äù</strong></a></li>
</ul>
<p>To support the <strong>Push Button</strong> (GPIO 12) on PineDio Stack, we shall implement these <strong>Board Button Functions</strong> for PineDio Stack‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/input/button_lower.c#L91-L102"><strong>board_buttons</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/input/button_lower.c#L156-L182"><strong>board_button_irq</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/input/button_lower.c#L208-L221"><strong>board_button_initialize</strong></a></p>
</li>
</ul>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/xtensa/esp32/esp32-devkitc/src/esp32_buttons.c">(Here‚Äôs the implementation for ESP32)</a></p>
<p>They will be called by the <strong>Button Lower Half Driver</strong> in NuttX‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/input/button_lower.c"><strong>Button Lower Half Driver</strong></a></li>
</ul>
<p>Which is wrapped inside the <strong>Button Upper Half Driver</strong> and exposed to apps as ‚Äú<strong>/dev/buttons</strong>‚Äù‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/input/button_upper.c"><strong>Button Upper Half Driver</strong></a></li>
</ul>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/pinedio/examples/chrono/chrono_main.c">(Here‚Äôs how we access ‚Äú<strong>/dev/buttons</strong>‚Äù in NuttX Apps)</a></p>
<p>Note that the Push Button shares GPIO 12 with the Vibrator.</p>
<p>(Which is missing from the current PineDio Stack)</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/pinedio2-touch.png" alt="PineDio Stack Touch Panel" /></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/pinedio_stack_v1_0-2021_09_15-a.pdf">(Schematic)</a></p>
</blockquote>
<h2 id="touch-panel"><a class="doc-anchor" href="#touch-panel">¬ß</a>14.3 Touch Panel</h2>
<p>JF has created a <strong>CST816S I2C Touch Panel Driver</strong> for PineDio Stack‚Ä¶ (Thanks JF!)</p>
<ul>
<li><a href="https://codeberg.org/JF002/pinedio-stack-selftest/src/branch/master/drivers/cst816s.c"><strong>pinedio-stack-selftest/drivers/cst816s.c</strong></a></li>
</ul>
<p>We have ported this driver to NuttX and exposed it to apps as a NuttX Touchscreen Device ‚Äú<strong>/dev/input0</strong>‚Äù‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/cst816s-nuttx"><strong>lupyuen/cst816s-nuttx</strong></a></li>
</ul>
<p><a href="https://github.com/lupyuen/lvgltest-nuttx/blob/main/tp.c#L100-L132">(Here‚Äôs how we access ‚Äú<strong>/dev/input0</strong>‚Äù in our LVGL Test App)</a></p>
<p>More about the NuttX Touch Panel Driver for PineDio Stack‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/touch"><strong>‚ÄúNuttX Touch Panel Driver for PineDio Stack BL604‚Äù</strong></a></li>
</ul>
<p>(PineDio Stack uses the same Touch Panel as PineTime)</p>
<p><a href="https://nuttx.apache.org/docs/latest/components/drivers/character/touchscreen.html">(More about NuttX Touchscreen Drivers)</a></p>
<p><img src="https://lupyuen.github.io/images/pinedio2-accel.png" alt="PineDio Stack Accelerometer" /></p>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/pinedio_stack_v1_0-2021_09_15-a.pdf">(Schematic)</a></p>
<h2 id="accelerometer"><a class="doc-anchor" href="#accelerometer">¬ß</a>14.4 Accelerometer</h2>
<p>To create the I2C <strong>Accelerometer Sensor Driver ‚Äú/dev/accel0‚Äù</strong> for PineDio Stack, we could port JF‚Äôs simple driver‚Ä¶</p>
<ul>
<li><a href="https://codeberg.org/JF002/pinedio-stack-selftest/src/branch/master/accelerometer.c"><strong>pinedio-stack-selftest/accelerometer.c</strong></a></li>
</ul>
<p>Or the <strong>Reference Driver for MC3416</strong>‚Ä¶</p>
<ul>
<li><a href="https://mcubemems.com/product/mc3416-3-axis-accelerometer/"><strong>MC3416 Driver Source Code</strong></a></li>
</ul>
<p>The <a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/sensors/wtgahrs2.c"><strong>NuttX Driver for WTGAHRS2 Accelerometer</strong></a> might be a good guide for porting the driver.</p>
<p>We have an article that explains the innards of <strong>NuttX Sensor Drivers</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/bme280"><strong>‚ÄúApache NuttX Driver for BME280 Sensor: Ported from Zephyr OS‚Äù</strong></a></li>
</ul>
<p>NuttX‚Äôs <a href="https://github.com/lupyuen/nuttx-apps/tree/pinedio/system/i2c"><strong>I2C Tool</strong></a> might be helpful for troubleshooting I2C Drivers.</p>
<p><img src="https://lupyuen.github.io/images/pinedio2-power.png" alt="PineDio Stack Power Management Unit" /></p>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/pinedio_stack_v1_0-2021_09_15-a.pdf">(Schematic)</a></p>
<h2 id="power-management"><a class="doc-anchor" href="#power-management">¬ß</a>14.5 Power Management</h2>
<p>Check out JF‚Äôs driver for <strong>SGM40561 Power Management Unit</strong>‚Ä¶</p>
<ul>
<li><a href="https://codeberg.org/JF002/pinedio-stack-selftest/src/branch/master/battery.c"><strong>pinedio-stack-selftest/battery.c</strong></a></li>
</ul>
<p>(This is the same Power Management Unit used in PineTime)</p>
<p>To port this to NuttX, we‚Äôll call the <strong>BL604 ADC Library</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/bl602_adc_test"><strong>‚ÄúADC and Internal Temperature Sensor Library‚Äù</strong></a></li>
</ul>
<p>(Because BL604 ADC is not supported yet on NuttX)</p>
<p>Refer to the <strong>Power Management Drivers</strong> for NuttX‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/nuttx/tree/pinedio/drivers/power"><strong>nuttx/drivers/power</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/pinedio2-gps.png" alt="PineDio Stack GPS" /></p>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/PINEDIO_STACK_BASEBOARD_V1_0-SCH-2021-09-27.pdf">(Schematic)</a></p>
<h2 id="gps"><a class="doc-anchor" href="#gps">¬ß</a>14.6 GPS</h2>
<p>NuttX has a <strong>GPS Demo App</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/nuttx-apps/blob/pinedio/examples/gps/gps_main.c"><strong>apps/examples/gps</strong></a></li>
</ul>
<p>And a <strong>GPS Parser Library</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/nuttx-apps/tree/pinedio/gpsutils"><strong>apps/gpsutils</strong></a></li>
</ul>
<p>These might be helpful for creating the <strong>GPS Driver</strong> (UART) for PineDio Stack.</p>
<p><img src="https://lupyuen.github.io/images/pinedio2-flash.png" alt="PineDio Stack SPI Flash" /></p>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/pinedio_stack_v1_0-2021_09_15-a.pdf">(Schematic)</a></p>
<h2 id="spi-flash"><a class="doc-anchor" href="#spi-flash">¬ß</a>14.7 SPI Flash</h2>
<p>The PineDio Stack Schematics refer to 2 kinds of <strong>SPI Flash</strong>‚Ä¶ (Why?)</p>
<ul>
<li>
<p><strong>MX25R1635FZUIL0</strong> (Main Board)</p>
</li>
<li>
<p><strong>W25Q128FV / W25Q256FV</strong> (Baseboard)</p>
</li>
</ul>
<p>Both kinds of SPI Flash seem to be supported by NuttX‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/mtd/mx25rxx.c"><strong>NuttX MX25RXX Driver</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/mtd/w25.c"><strong>NuttX W25 Driver</strong></a></p>
</li>
</ul>
<p>We need to test the drivers.</p>
<p>NuttX‚Äôs <a href="https://github.com/lupyuen/nuttx-apps/tree/pinedio/system/spi"><strong>SPI Tool</strong></a> might be helpful for troubleshooting SPI Drivers.</p>
<h2 id="spi-direct-memory-access"><a class="doc-anchor" href="#spi-direct-memory-access">¬ß</a>14.8 SPI Direct Memory Access</h2>
<p><em>ST7789 Display receives plenty of data on the SPI Bus (for screen updates). Will there be contention with other SPI Devices? (Like SX1262 Transceiver)</em></p>
<p>Most definitely. That‚Äôs why we need to implement <a href="https://lupyuen.github.io/articles/spi#spi-with-direct-memory-access"><strong>SPI Direct Memory Access (DMA)</strong></a> so that PineDio Stack can do other tasks while painting the ST7789 Display.</p>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L805-L855">(Right now the SPI Driver polls the SPI Port when transferring SPI data)</a></p>
<p>We‚Äôll port to NuttX this implementation of SPI DMA from <strong>BL MCU SDK</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/bouffalolab/bl_mcu_sdk/blob/master/drivers/bl602_driver/std_drv/src/bl602_dma.c"><strong>bl602_dma.c</strong></a></li>
</ul>
<p>More about SPI DMA on BL602 / BL604‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/spi#spi-with-direct-memory-access"><strong>‚ÄúSPI with Direct Memory Access‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/spi#lli_list_init-create-dma-linked-list"><strong>‚ÄúCreate DMA Linked List‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/spi#hal_spi_dma_trans-execute-spi-transfer-with-dma"><strong>‚ÄúExecute DMA Linked List‚Äù</strong></a></p>
</li>
</ul>
<p><strong>UPDATE:</strong> SPI DMA is now supported on BL602 / BL604 NuttX‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/spi2#appendix-spi-dma-on-bl602-nuttx"><strong>‚ÄúSPI DMA on BL602 NuttX‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/auto-title.jpg" alt="PineCone BL602 RISC-V Board (bottom) connected to Single-Board Computer (top) for Auto Flash and Test" /></p>
<p><em>PineCone BL602 RISC-V Board (bottom) connected to Single-Board Computer (top) for Auto Flash and Test</em></p>
<h2 id="automated-testing"><a class="doc-anchor" href="#automated-testing">¬ß</a>14.9 Automated Testing</h2>
<p><strong>UPDATE:</strong> Automated Testing for PineDio Stack is explained in this article‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/auto2"><strong>‚Äú(Mostly) Automated Testing of Apache NuttX RTOS on PineDio Stack BL604 RISC-V Board‚Äù</strong></a></li>
</ul>
<p>When we have multiple devs creating NuttX Apps and Drivers for PineDio Stack, it might be good to run some <strong>Automated Testing</strong> (to be sure that nothing‚Äôs broken).</p>
<p>Today we run a <strong>Daily Automated Test</strong> on the NuttX Mainline Branch for PineCone BL602‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/auto"><strong>‚ÄúAuto Flash and Test NuttX on RISC-V BL602‚Äù</strong></a></p>
<p><a href="https://github.com/lupyuen/nuttx/releases">(See the Automated Test Logs)</a></p>
</li>
</ul>
<p>Now we need to <strong>connect an SBC to PineDio Stack</strong> and auto-run these tests‚Ä¶</p>
<ul>
<li>
<p><strong>SPI Test App (spi_test2)</strong>: Verify that the SPI Driver can talk to SX1262</p>
</li>
<li>
<p><strong>LoRaWAN Test App (lorawan_test)</strong>: Verify that SX1262 can join a LoRaWAN Network (ChirpStack) and transmit Data Packets</p>
</li>
<li>
<p><strong>LVGL Test App (lvgltest)</strong>: Verify that ST7789 can render an LVGL Screen (over SPI) and read the CST816S Touch Panel (over I2C)</p>
</li>
<li>
<p><strong>GPIO Command (gpio)</strong>: Verify that the BL604 GPIO Expander correctly triggers an interrupt when the Push Button is pressed‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; gpio -t 8 -w 1 /dev/gpio12
Driver: /dev/gpio12
  Interrupt pin: Value=1
  Verify:        Value=1</code></pre></div>
<p><a href="https://github.com/lupyuen/bl602_expander#test-push-button">(Source)</a></p>
</li>
</ul>
<p>Right now we run these tests manually on PineDio Stack when we update the <a href="https://github.com/lupyuen/nuttx/tree/pinedio"><strong><code>pinedio</code> branch</strong></a>.</p>
<p>We record the <strong>Manual Test Logs</strong> in the Pull Requests‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/nuttx/pulls?q=is%3Aclosed+base%3Apinedio"><strong>Pull Requests and Manual Test Logs for PineDio Stack</strong></a></li>
</ul>
<p><em>So we‚Äôll run Automated Tests on PineCone BL602 AND PineDio Stack BL604?</em></p>
<p>Yep we shall test and maintain two <strong>Stable Branches</strong> of NuttX for public consumption‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/nuttx"><strong><code>master</code> branch</strong></a> for PineCone BL602</p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/tree/pinedio"><strong><code>pinedio</code> branch</strong></a> for PineDio Stack BL604</p>
</li>
</ul>
<p>(Same for NuttX Apps)</p>
<p><em>Are the branches any different?</em></p>
<p>The code should be identical, though‚Ä¶</p>
<ul>
<li>
<p>PineCone BL602 won‚Äôt use the <a href="https://lupyuen.github.io/articles/pinedio2#appendix-shared-spi-bus"><strong>Shared SPI Bus</strong></a> that we have created for PineDio Stack BL604</p>
</li>
<li>
<p>PineCone BL602 won‚Äôt use the <a href="https://github.com/lupyuen/bl602_expander"><strong>GPIO Expander</strong></a> either</p>
</li>
</ul>
<p>We control the options through the <strong>NuttX Build Configuration</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Configure build for PineDio Stack BL604
./tools/configure.sh bl602evb:pinedio

## Configure build for PineCone BL602
./tools/configure.sh bl602evb:pinecone</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/configs/pinedio/defconfig">(See the PineDio Stack config)</a></p>
<p><a href="https://github.com/lupyuen/nuttx/blob/master/boards/risc-v/bl602/bl602evb/configs/pinecone/defconfig">(See the PineCone config)</a></p>
<p>This check for PineDio Stack should probably be improved: <a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L147-L151">board.h</a></p>
<div class="example-wrap"><pre class="language-c"><code>/* Identify as PineDio Stack if both ST7789 and CST816S are present */
#if defined(CONFIG_LCD_ST7789) &amp;&amp; defined(CONFIG_INPUT_CST816S)
#define PINEDIO_STACK_BL604
#endif /* CONFIG_LCD_ST7789 &amp;&amp; CONFIG_INPUT_CST816S */</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c">(<strong>PINEDIO_STACK_BL604</strong> enables the SPI Device Table in the SPI Driver)</a></p>
<p><img src="https://lupyuen.github.io/images/auto-merge.jpg" alt="Merge Updates From NuttX" /></p>
<p><a href="https://lupyuen.github.io/articles/auto#merge-updates-from-nuttx">(Source)</a></p>
<p><em>What about upstream updates from NuttX Mainline Branch?</em></p>
<ul>
<li>
<p>Upstream updates from NuttX Mainline will first be merged and auto-tested in the <a href="https://github.com/lupyuen/nuttx/tree/downstream"><strong><code>downstream</code> branch</strong></a></p>
<p>(Every 2 weeks, depends on my writing mood)</p>
</li>
<li>
<p>Then merged and auto-tested in the <a href="https://github.com/lupyuen/nuttx"><strong><code>master</code> (release) branch</strong></a></p>
<p>(For PineCone BL602)</p>
</li>
<li>
<p>Which gets merged and manually tested in the <a href="https://github.com/lupyuen/nuttx/tree/pinedio"><strong><code>pinedio</code> branch</strong></a></p>
<p>(For PineDio Stack BL604)</p>
</li>
<li>
<p>Updates in the <code>pinedio</code> branch are merged back to the <code>master</code> and the <code>downstream</code> branches and auto-tested on PineCone BL602</p>
</li>
<li>
<p>Thus ultimately the <code>pinedio</code>, <code>master</code> and <code>downstream</code> branches will all have the <strong>exact same code</strong>, tested OK on PineCone BL602 and PineDio Stack BL604</p>
<p>(And lagging behind NuttX Mainline by 2 weeks)</p>
</li>
</ul>
<p>This is an extension of our original grand plan‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/auto#merge-updates-from-nuttx"><strong>‚ÄúMerge Updates From NuttX‚Äù</strong></a></li>
</ul>
<p><em>But how will we auto-test the Touch Panel on PineDio Stack?</em></p>
<p>With a <strong>Robot Finger</strong>?</p>
<p>Or let our SBC <strong>actuate a Motor</strong> that‚Äôs wrapped in an <strong>Anti-Static Bag</strong>?</p>
<ul>
<li><a href="https://www.youtube.com/shorts/hGSwetNr87o"><strong>Watch the video on YouTube</strong></a></li>
</ul>
<p>I‚Äôm open to ideas, please lemme know! üôè</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-title.jpg" alt="PineDio Stack BL604 RISC-V Board (left) talking LoRaWAN to RAKwireless WisGate LoRaWAN Gateway (right)" /></p>
<p><em>PineDio Stack BL604 RISC-V Board (left) talking LoRaWAN to RAKwireless WisGate LoRaWAN Gateway (right)</em></p>
<h1 id="appendix-sx1262-lora-transceiver"><a class="doc-anchor" href="#appendix-sx1262-lora-transceiver">¬ß</a>15 Appendix: SX1262 LoRa Transceiver</h1>
<p>PineDio Stack BL604 includes a <a href="https://www.semtech.com/products/wireless-rf/lora-core/sx1262"><strong>Semtech SX1262 LoRa Transceiver</strong></a> for wireless networking.</p>
<p>This section explains how we may test <strong>LoRa and LoRaWAN Wireless Networking</strong> on PineDio Stack.</p>
<p><a href="https://electronics.stackexchange.com/questions/335912/can-i-break-a-radio-tranceiving-device-by-operating-it-with-no-antenna-connected"><strong>CAUTION</strong>: Always connect the LoRa Antenna before testing LoRa or LoRaWAN‚Ä¶ Or the LoRa Transceiver may get damaged! (Pic above)</a></p>
<p><em>Why LoRa?</em></p>
<p><a href="https://makezine.com/2021/05/24/go-long-with-lora-radio/"><strong>LoRa</strong></a> is a <strong>Low-Power, Long-Range, Low-Bandwidth</strong> wireless network.</p>
<p>LoRa is perfect for <strong>IoT Sensor Devices</strong> that run on Battery Power. (Or Solar Power)</p>
<p><em>Will LoRa support all kinds of messages?</em></p>
<p>Not quite. LoRa only supports <strong>Short Messages</strong> of up to <a href="https://lora-developers.semtech.com/documentation/tech-papers-and-guides/lora-and-lorawan"><strong>242 Bytes</strong></a>.</p>
<p>And because LoRa is a Low Power (best effort) network, <strong>messages may get dropped.</strong> Which is probably OK for sensor devices that send data periodically.</p>
<p>(But not for texting your friends)</p>
<p><em>Is LoRa secure?</em></p>
<p>LoRa messages are delivered securely when we join a <strong>LoRaWAN Network</strong>.</p>
<p>Today we shall test both <strong>LoRa and LoRaWAN</strong> on PineDio Stack‚Ä¶</p>
<ul>
<li>
<p>Transmit and receive raw <strong>LoRa Messages</strong></p>
</li>
<li>
<p>Join a LoRaWAN Network and transmit a <strong>LoRaWAN Message</strong> to a LoRaWAN Gateway (like ChirpStack or The Things Network)</p>
</li>
</ul>
<p><a href="https://makezine.com/2021/05/24/go-long-with-lora-radio/">(More about LoRa and LoRaWAN)</a></p>
<h2 id="test-lora"><a class="doc-anchor" href="#test-lora">¬ß</a>15.1 Test LoRa</h2>
<p>The <strong>LoRa Library for Semtech SX1262</strong> is explained in this article‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/sx1262"><strong>‚ÄúLoRa SX1262 on Apache NuttX OS‚Äù</strong></a></li>
</ul>
<p>To test LoRa on PineDio Stack, edit <a href="https://github.com/lupyuen/nuttx-apps/blob/sx1262/examples/sx1262_test/sx1262_test_main.c#L30-L72"><strong>sx1262_test_main.c</strong></a> at‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>apps/examples/sx1262_test/sx1262_test_main.c</code></pre></div>
<p>And update the <strong>LoRa Parameters</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>/// TODO: We are using LoRa Frequency 923 MHz 
/// for Singapore. Change this for your region.
#define USE_BAND_923
...

/// LoRa Parameters
#define LORAPING_TX_OUTPUT_POWER            14        /* dBm */

#define LORAPING_BANDWIDTH                  0         /* [0: 125 kHz, */
                                                      /*  1: 250 kHz, */
                                                      /*  2: 500 kHz, */
                                                      /*  3: Reserved] */
#define LORAPING_SPREADING_FACTOR           7         /* [SF7..SF12] */
#define LORAPING_CODINGRATE                 1         /* [1: 4/5, */
                                                      /*  2: 4/6, */
                                                      /*  3: 4/7, */
                                                      /*  4: 4/8] */
#define LORAPING_PREAMBLE_LENGTH            8         /* Same for Tx and Rx */
#define LORAPING_SYMBOL_TIMEOUT             5         /* Symbols */
#define LORAPING_FIX_LENGTH_PAYLOAD_ON      false
#define LORAPING_IQ_INVERSION_ON            false

#define LORAPING_TX_TIMEOUT_MS              3000    /* ms */
#define LORAPING_RX_TIMEOUT_MS              10000    /* ms */
#define LORAPING_BUFFER_SIZE                64      /* LoRa message size */</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/sx1262/examples/sx1262_test/sx1262_test_main.c#L30-L72">(Source)</a></p>
<p>The parameters are explained here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/sx1262#lora-parameters"><strong>‚ÄúLoRa Parameters‚Äù</strong></a></li>
</ul>
<p>Then uncomment <strong>SEND_MESSAGE</strong> or <strong>RECEIVE_MESSAGE</strong> to send or receive a LoRa Message‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>int main(int argc, FAR char *argv[]) {
...
//  Uncomment to send a LoRa message
#define SEND_MESSAGE
...
//  Uncomment to receive a LoRa message
#define RECEIVE_MESSAGE</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/sx1262/examples/sx1262_test/sx1262_test_main.c#L94-L143">(Source)</a></p>
<p>Rebuild (‚Äú<code>make</code>‚Äù) and reflash (‚Äú<code>blflash</code>‚Äù) NuttX to PineDio Stack.</p>
<p>In the NuttX Shell, enter this to run the <strong>LoRa Test App</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>sx1262_test</code></pre></div>
<p>If we‚Äôre sending a LoRa Message on PineDio Stack, we‚Äôll see the message received by the <strong>LoRa Receiver Device</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/sx1262#run-the-firmware-1"><strong>‚ÄúRun the Firmware‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/sx1262-send2.jpg" alt="Our SX1262 Library transmits a LoRa Message to RAKwireless WisBlock" /></p>
<p>To troubleshoot LoRa, we could use a <strong>Spectrum Analyser (Software-Defined Radio)</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/sx1262#spectrum-analysis-with-sdr"><strong>‚ÄúSpectrum Analysis with SDR‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/sx1262-sdr.jpg" alt="Spectrum Analysis of LoRa Message with SDR" /></p>
<h2 id="test-lorawan"><a class="doc-anchor" href="#test-lorawan">¬ß</a>15.2 Test LoRaWAN</h2>
<p>The <strong>LoRaWAN Library</strong> is explained in this article‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/lorawan3"><strong>‚ÄúLoRaWAN on Apache NuttX OS‚Äù</strong></a></li>
</ul>
<p>To test LoRaWAN on PineDio Stack, we edit <a href="https://github.com/lupyuen/LoRaMac-node-nuttx/blob/master/src/peripherals/soft-se/se-identity.h#L65-L115"><strong>se-identity.h</strong></a> at‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>nuttx/libs/liblorawan/src/peripherals/soft-se/se-identity.h</code></pre></div>
<p>And update the <strong>LoRaWAN Parameters</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>//  End-device IEEE EUI (big endian)
#define LORAWAN_DEVICE_EUI { 0x4b, 0xc1, 0x5e, 0xe7, 0x37, 0x7b, 0xb1, 0x5b }

//  App/Join server IEEE EUI (big endian)
#define LORAWAN_JOIN_EUI { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }
...
#define SOFT_SE_KEY_LIST \
  { \
    { \
      /*! \
       * Application root key \
       * WARNING: FOR 1.0.x DEVICES IT IS THE \ref LORAWAN_GEN_APP_KEY \
       */ \
      .KeyID    = APP_KEY, \
      .KeyValue = { 0xaa, 0xff, 0xad, 0x5c, 0x7e, 0x87, 0xf6, 0x4d, 0xe3, 0xf0, 0x87, 0x32, 0xfc, 0x1d, 0xd2, 0x5d }, \
    }, \
    { \
      /*! \
       * Network root key \
       * WARNING: FOR 1.0.x DEVICES IT IS THE \ref LORAWAN_APP_KEY \
       */ \
      .KeyID    = NWK_KEY, \
      .KeyValue = { 0xaa, 0xff, 0xad, 0x5c, 0x7e, 0x87, 0xf6, 0x4d, 0xe3, 0xf0, 0x87, 0x32, 0xfc, 0x1d, 0xd2, 0x5d }, \
    }, \</code></pre></div>
<p><a href="https://github.com/lupyuen/LoRaMac-node-nuttx/blob/master/src/peripherals/soft-se/se-identity.h#L65-L115">(Source)</a></p>
<p>The parameters are explained here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/lorawan3#device-eui-join-eui-and-app-key"><strong>‚ÄúDevice EUI, Join EUI and App Key‚Äù</strong></a></li>
</ul>
<p>Then edit <a href="https://github.com/lupyuen/lorawan_test/blob/main/lorawan_test_main.c#L39-L45"><strong>lorawan_test_main.c</strong></a> at‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>apps/examples/lorawan_test/lorawan_test_main.c</code></pre></div>
<p>And set the <strong>LoRaWAN Frequency</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>#ifndef ACTIVE_REGION
  #warning &quot;No active region defined, LORAMAC_REGION_AS923 will be used as default.&quot;
  #define ACTIVE_REGION LORAMAC_REGION_AS923
#endif</code></pre></div>
<p><a href="https://github.com/lupyuen/lorawan_test/blob/main/lorawan_test_main.c#L39-L45">(Source)</a></p>
<p>Which is explained here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/lorawan3#lorawan-frequency"><strong>‚ÄúLoRaWAN Frequency‚Äù</strong></a></li>
</ul>
<p>Remember to <strong>disable all Info Logging</strong> because it affects the LoRaWAN Timers.</p>
<p>Rebuild (‚Äú<code>make</code>‚Äù) and reflash (‚Äú<code>blflash</code>‚Äù) NuttX to PineDio Stack.</p>
<p>In the NuttX Shell, enter this to run the <strong>LoRaWAN Test App</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>lorawan_test</code></pre></div>
<p>We should see this‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>init_entropy_pool
temperature = 31.600670 Celsius</code></pre></div>
<p>The app begins by reading BL604‚Äôs <strong>Internal Temperature Sensor</strong> to seed the Entropy Pool for the Random Number Generator. <a href="https://lupyuen.github.io/articles/lorawan3#lorawan-nonce">(Here‚Äôs why)</a></p>
<p>Next it sends a <strong>Join Network Request</strong> to the LoRaWAN Gateway (like ChirpStack)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>=========== MLME-Request ============
              MLME_JOIN              
=====================================
STATUS      : OK</code></pre></div>
<p>Then the app receives the <strong>Join Accept Response</strong> from the LoRaWAN Gateway‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>=========== MLME-Confirm ============
STATUS      : OK
===========   JOINED     ============
DevAddr     :  01097710
DATA RATE   : DR_2</code></pre></div>
<p>After joining the network, the app sends a <strong>Data Packet</strong> <em>(‚ÄúHi NuttX‚Äù)</em> to the LoRaWAN Gateway‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>=========== MCPS-Confirm ============
STATUS      : OK
=====   UPLINK FRAME        1   =====
CLASS       : A
TX PORT     : 1
TX DATA     : UNCONFIRMED
48 69 20 4E 75 74 74 58 00
DATA RATE   : DR_3
U/L FREQ    : 923200000
TX POWER    : 0
CHANNEL MASK: 0003</code></pre></div>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx#test-lorawan">(See the complete log)</a></p>
<p>We should see <strong>‚ÄúHi NuttX‚Äù</strong> at the LoRaWAN Gateway (like ChirpStack)‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/lorawan3#check-lorawan-gateway-1"><strong>‚ÄúCheck LoRaWAN Gateway‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/lorawan3-chirpstack6.png" alt="Decoded Payload" /></p>
<p>For troubleshooting tips, see this‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/lorawan3#troubleshoot-lorawan"><strong>‚ÄúTroubleshoot LoRaWAN‚Äù</strong></a></li>
</ul>
<p><em>Will PineDio Stack connect to The Things Network?</em></p>
<p>Yes just set the LoRaWAN Parameters like so‚Ä¶</p>
<ul>
<li>
<p><strong>LORAWAN_DEVICE_EUI</strong>: Set this to the <strong>DevEUI</strong> from The Things Network</p>
</li>
<li>
<p><strong>LORAWAN_JOIN_EUI</strong>: Set this to <code>{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }</code></p>
</li>
<li>
<p><strong>APP_KEY, NWK_KEY</strong>: Set both to the <strong>AppKey</strong> from The Things Network</p>
</li>
</ul>
<p>To get the <strong>DevEUI</strong> and <strong>AppKey</strong> from The Things Network‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/ttn#add-device-to-the-things-network"><strong>‚ÄúAdd Device to The Things Network‚Äù</strong></a></li>
</ul>
<p>(I don‚Äôt think <strong>NWK_KEY</strong> is used)</p>
<p><img src="https://lupyuen.github.io/images/lorawan3-ttn.png" alt="NuttX transmits a CBOR Payload to The Things Network Over LoRaWAN" /></p>
<p><em>NuttX transmits a CBOR Payload to The Things Network Over LoRaWAN</em></p>
<h2 id="test-cbor-encoder"><a class="doc-anchor" href="#test-cbor-encoder">¬ß</a>15.3 Test CBOR Encoder</h2>
<p>Suppose we‚Äôre creating an app that transmits <strong>Sensor Data</strong> over LoRa (or LoRaWAN) from two sensors: <strong>Temperature Sensor and Light Sensor</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{ 
  &quot;t&quot;: 1234, 
  &quot;l&quot;: 2345 
}</code></pre></div>
<p>(Located in a Greenhouse perhaps)</p>
<p>We could transmit <strong>19 bytes of JSON</strong>. But there‚Äôs a more compact way to do it‚Ä¶.</p>
<p><a href="https://en.wikipedia.org/wiki/CBOR"><strong>Concise Binary Object Representation (CBOR)</strong></a>, which works like a binary, compressed form of JSON.</p>
<p>And we need only <strong>11 bytes of CBOR</strong>!</p>
<p><img src="https://lupyuen.github.io/images/cbor2-title.jpg" alt="Encoding Sensor Data with CBOR" /></p>
<p>To watch CBOR in action, enter this in the NuttX Shell‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>tinycbor_test</code></pre></div>
<p>We‚Äôll see the <strong>encoded CBOR data</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>test_cbor2: Encoding { &quot;t&quot;: 1234, &quot;l&quot;: 2345 }
CBOR Output: 11 bytes
  0xa2
  0x61
  0x74
  0x19
  0x04
  0xd2
  0x61
  0x6c
  0x19
  0x09
  0x29</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/deb752ac79c7b0ad51c6da6889660c27">(See the complete log)</a></p>
<p>To <strong>encode CBOR data</strong> in our own apps, check out this article‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/cbor2"><strong>‚ÄúEncode Sensor Data with CBOR on Apache NuttX OS‚Äù</strong></a></li>
</ul>
<p>CBOR Decoding can be done automatically in <strong>The Things Network</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/payload"><strong>‚ÄúCBOR Payload Formatter for The Things Network‚Äù</strong></a></li>
</ul>
<p>We can visualise the Sensor Data with open-source <strong>Grafana and Prometheus</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/prometheus">‚ÄúMonitor IoT Devices in The Things Network with Prometheus and Grafana‚Äù</a></li>
</ul>
<h1 id="appendix-shared-spi-bus"><a class="doc-anchor" href="#appendix-shared-spi-bus">¬ß</a>16 Appendix: Shared SPI Bus</h1>
<p>This section explains how we modified NuttX to handle the <strong>Shared SPI Bus</strong> on PineDio Stack BL604.</p>
<p>Acording to the PineDio Stack Schematics‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/pinedio_stack_v1_0-2021_09_15-a.pdf"><strong>PineDio Stack Schematic</strong> (2021-09-15)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx/blob/main/PINEDIO_STACK_BASEBOARD_V1_0-SCH-2021-09-27.pdf"><strong>PineDio Stack Baseboard Schematic</strong> (2021-09-27)</a></p>
</li>
</ul>
<p>The SPI Bus is shared by‚Ä¶</p>
<ul>
<li>
<p>ST7789 Display Controller</p>
</li>
<li>
<p>Semtech SX1262 LoRa Transceiver</p>
</li>
<li>
<p>SPI Flash</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/pinedio-spi2.jpg" alt="Shared SPI Bus on PineDio Stack BL604" /></p>
<p>Here are the BL604 GPIO Numbers for the shared SPI Bus‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">Function</th><th style="text-align: center">GPIO</th></tr></thead><tbody>
<tr><td style="text-align: left">SPI MOSI</td><td style="text-align: center">13</td></tr>
<tr><td style="text-align: left">SPI MISO</td><td style="text-align: center">0</td></tr>
<tr><td style="text-align: left">SPI SCK</td><td style="text-align: center">11</td></tr>
<tr><td style="text-align: left">SPI CS <em>(Unused)</em></td><td style="text-align: center">8</td></tr>
</tbody></table>
</div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L99-L105">(Source)</a></p>
<p><a href="https://lupyuen.github.io/articles/pinedio2#appendix-gpio-assignment">(See the GPIO Assignment)</a></p>
<p>To prevent crosstalk, we select each SPI Device by flipping its <strong>Chip Select Pin</strong> from High to Low‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">SPI Device</th><th style="text-align: center">Device ID</th><th style="text-align: center">Swap MISO/MOSI</th><th style="text-align: center">Chip Select</th></tr></thead><tbody>
<tr><td style="text-align: left">ST7789 Display</td><td style="text-align: center">0x40000</td><td style="text-align: center">No</td><td style="text-align: center">20</td></tr>
<tr><td style="text-align: left">SX1262 Transceiver</td><td style="text-align: center">1</td><td style="text-align: center">Yes</td><td style="text-align: center">15</td></tr>
<tr><td style="text-align: left">SPI Flash</td><td style="text-align: center">2</td><td style="text-align: center">Yes</td><td style="text-align: center">14</td></tr>
<tr><td style="text-align: left"><em>(Default Device)</em></td><td style="text-align: center">-1</td><td style="text-align: center">Yes</td><td style="text-align: center">8 <em>(Unused)</em></td></tr>
</tbody></table>
</div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L106-L127">(Source)</a></p>
<p><em>How is Chip Select implemented in NuttX?</em></p>
<p>To select (or deselect) an SPI Device, NuttX calls these functions provided by the <strong>BL602 / BL604 SPI Driver</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L384-L414"><strong>bl602_spi_lock</strong></a>: Lock (or unlock) the SPI Bus with a Semaphore</p>
</li>
<li>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/risc-v/src/bl602/bl602_spi.c#L415-L453"><strong>bl602_spi_select</strong></a>: Flip the Chip Select Pin to Low (or High)</p>
</li>
</ul>
<p>However the SPI Driver doesn‚Äôt support multiple Chip Select Pins. <a href="https://github.com/apache/nuttx/blob/master/arch/risc-v/src/bl602/bl602_spi.c#L415-L453">(See this)</a></p>
<p>Here‚Äôs how we modded the SPI Driver for PineDio Stack‚Ä¶</p>
<h2 id="spi-device-id"><a class="doc-anchor" href="#spi-device-id">¬ß</a>16.1 SPI Device ID</h2>
<p><em>What‚Äôs the SPI Device ID in the table above?</em></p>
<p>We identify each SPI Device with a unique <strong>SPI Device ID</strong>.</p>
<p>NuttX passes the Device ID when it calls <a href="https://github.com/apache/nuttx/blob/master/arch/risc-v/src/bl602/bl602_spi.c#L415-L453"><strong>bl602_spi_select</strong></a>. We‚Äôll use this to flip the right Chip Select Pin for the SPI Device.</p>
<p><em>How did we get the SPI Device IDs?</em></p>
<p>NuttX auto-assigns <code>0x40000</code> as the SPI Device ID for the ST7789 Display. <a href="https://github.com/lupyuen/nuttx/blob/pinedio/include/nuttx/spi/spi.h#L459">(See this)</a></p>
<p>We assigned the other SPI Device IDs ourselves.</p>
<p>Device ID <code>-1</code> is meant as a fallthrough to catch all SPI Devices that don‚Äôt match the Device IDs. This also works for simple SPI setups where the Device ID is not needed.</p>
<h2 id="swap-miso--mosi"><a class="doc-anchor" href="#swap-miso--mosi">¬ß</a>16.2 Swap MISO / MOSI</h2>
<p><em>What‚Äôs the Swap MISO / MOSI column in the table above?</em></p>
<p>According to the <a href="https://github.com/bouffalolab/bl_docs/blob/main/BL602_RM/en/BL602_BL604_RM_1.2_en.pdf"><strong>BL602 / BL604 Reference Manual</strong></a> (Table 3.1 ‚ÄúPin Description‚Äù, Page 26)‚Ä¶</p>
<ul>
<li>
<p><strong>GPIO 13</strong> is designated as <strong>MOSI</strong></p>
</li>
<li>
<p><strong>GPIO 0</strong> is designed as <strong>MISO</strong></p>
</li>
</ul>
<p>But due to a BL602 / BL604 SPI quirk we need to <strong>swap MISO and MOSI</strong> to get this behaviour. <a href="https://lupyuen.github.io/articles/spi2#appendix-miso-and-mosi-are-swapped">(See this)</a></p>
<p>That‚Äôs why the ‚ÄúSwap MISO / MOSI‚Äù column is marked ‚ÄúYes‚Äù for <strong>SX1262 Transceiver and SPI Flash</strong>.</p>
<p><em>But ST7789 doesn‚Äôt swap MISO and MOSI?</em></p>
<p>The <strong>ST7789 Display Controller</strong> is wired differently on PineDio Stack‚Ä¶</p>
<ul>
<li>
<p>ST7789 receives SPI Data on <strong>GPIO 0</strong></p>
</li>
<li>
<p>ST7789 Data / Command Pin is connected on <strong>GPIO 13</strong></p>
<p>(High for ST7789 Data, Low for ST7789 Commands)</p>
</li>
</ul>
<p>The direction of <strong>SPI Data is flipped for ST7789</strong>.</p>
<p>That‚Äôs why the ‚ÄúSwap MISO / MOSI‚Äù column is marked ‚ÄúNo‚Äù for the ST7789 Display Controller.</p>
<p><em>So we will swap and unswap MISO / MOSI on the fly?</em></p>
<p>Yep since we‚Äôll run the ST7789, SX1262 and SPI Flash drivers concurrently, we‚Äôll need to <strong>swap and unswap MISO / MOSI before every SPI operation</strong>.</p>
<p>We‚Äôll do this in <a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L439-L471"><strong>bl602_spi_select</strong></a>.</p>
<h2 id="spi-device-table"><a class="doc-anchor" href="#spi-device-table">¬ß</a>16.3 SPI Device Table</h2>
<p><em>How do we store the SPI Device Table in NuttX?</em></p>
<p>We represent the above SPI Device Table in NuttX as a <strong>flat <code>int</code> array</strong>‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">SPI Device</th><th style="text-align: center">Device ID</th><th style="text-align: center">Swap MISO/MOSI</th><th style="text-align: center">Chip Select</th></tr></thead><tbody>
<tr><td style="text-align: left"><em>ST7789 Display</em></td><td style="text-align: center">0x40000</td><td style="text-align: center">0</td><td style="text-align: center">20</td></tr>
<tr><td style="text-align: left"><em>SX1262 Transceiver</em></td><td style="text-align: center">1</td><td style="text-align: center">1</td><td style="text-align: center">15</td></tr>
<tr><td style="text-align: left"><em>SPI Flash</em></td><td style="text-align: center">2</td><td style="text-align: center">1</td><td style="text-align: center">14</td></tr>
<tr><td style="text-align: left"><em>(Default Device)</em></td><td style="text-align: center">-1</td><td style="text-align: center">1</td><td style="text-align: center">8</td></tr>
</tbody></table>
</div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L112-L133">(Source)</a></p>
<p>Here‚Äôs the source code for the <strong>SPI Device Table</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>#ifdef CONFIG_BL602_SPI0
/* SPI Device Table: SPI Device ID, Swap MISO/MOSI, Chip Select */

static const int32_t bl602_spi_device_table[] =
{
#ifdef BOARD_LCD_DEVID  /* ST7789 Display */
  BOARD_LCD_DEVID, BOARD_LCD_SWAP, BOARD_LCD_CS,
#endif  /* BOARD_LCD_DEVID */

#ifdef BOARD_SX1262_DEVID  /* LoRa SX1262 */
  BOARD_SX1262_DEVID, BOARD_SX1262_SWAP, BOARD_SX1262_CS,
#endif  /* BOARD_SX1262_DEVID */

#ifdef BOARD_FLASH_DEVID  /* SPI Flash */
  BOARD_FLASH_DEVID, BOARD_FLASH_SWAP, BOARD_FLASH_CS,
#endif  /* BOARD_FLASH_DEVID */

  /* Must end with Default SPI Device */

  -1, 1, BOARD_SPI_CS,  /* Swap MISO/MOSI */
};
#endif  /* CONFIG_BL602_SPI0 */</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L112-L133">(Source)</a></p>
<p>We‚Äôll see the <code>BOARD_*</code> constants in the next section.</p>
<p>The columns of the SPI Device Table are defined like so‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>/* Columns in the SPI Device Table */

#define DEVID_COL 0  /* SPI Device ID */
#define SWAP_COL  1  /* 1 if MISO/MOSI should be swapped, else 0 */
#define CS_COL    2  /* SPI Chip Select Pin */
#define NUM_COLS  3  /* Number of columns in SPI Device Table */</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L36-L41">(Source)</a></p>
<p>We created these functions for <strong>accessing the SPI Device Table</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L210-L239"><strong>bl602_spi_get_device</strong></a>: Lookup a device in the SPI Device Table</p>
<p>(Called when selecting and deselecting devices)</p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L178-L208"><strong>bl602_spi_deselect_devices</strong></a>: Deselect all devices in the SPI Device Table</p>
<p>(Called during startup)</p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L140-L176"><strong>bl602_spi_validate_devices</strong></a>: Validate the devices in the SPI Device Table</p>
<p>(In case of coding errors)</p>
</li>
</ul>
<p>Let‚Äôs look at the <code>BOARD_*</code> definitions.</p>
<h2 id="pin-definitions"><a class="doc-anchor" href="#pin-definitions">¬ß</a>16.4 Pin Definitions</h2>
<p><em>Where are the SPI Pins defined?</em></p>
<p>The SPI Device Table above refers to the following <strong>Pin Definitions</strong> at <a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/include/board.h#L99-L128">boards/risc-v/bl602/bl602evb/include/board.h</a></p>
<div class="example-wrap"><pre class="language-c"><code>/* SPI for PineDio Stack: Chip Select (unused), MOSI, MISO, SCK */

#define BOARD_SPI_CS   (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN8)  /* Unused */
#define BOARD_SPI_MOSI (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN13)
#define BOARD_SPI_MISO (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN0)
#define BOARD_SPI_CLK  (GPIO_INPUT | GPIO_PULLUP | GPIO_FUNC_SPI | GPIO_PIN11)

#ifdef CONFIG_LCD_ST7789
/* ST7789 for PineDio Stack: Chip Select, Reset and Backlight */

#define BOARD_LCD_DEVID SPIDEV_DISPLAY(0)  /* SPI Device ID: 0x40000 */
#define BOARD_LCD_SWAP  0    /* Don&#39;t swap MISO/MOSI */
#define BOARD_LCD_BL_INVERT  /* Backlight is active when Low */
#define BOARD_LCD_CS  (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN20)
#define BOARD_LCD_RST (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN3)
#define BOARD_LCD_BL  (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN21)
#endif  /* CONFIG_LCD_ST7789 */

/* SX1262 for PineDio Stack: Chip Select */

#define BOARD_SX1262_DEVID 1  /* SPI Device ID */
#define BOARD_SX1262_SWAP  1  /* Swap MISO/MOSI */
#define BOARD_SX1262_CS (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN15)

/* SPI Flash for PineDio Stack: Chip Select */

#define BOARD_FLASH_DEVID 2  /* SPI Device ID */
#define BOARD_FLASH_SWAP  1  /* Swap MISO/MOSI */
#define BOARD_FLASH_CS (GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO | GPIO_PIN14)</code></pre></div>
<p>(GPIO, UART and I2C Pins are also defined in the file)</p>
<p><a href="https://lupyuen.github.io/articles/pinedio2#appendix-gpio-assignment">(See the GPIO Assignment)</a></p>
<p>Now that we have defined the SPI Device Table in NuttX, let‚Äôs use it.</p>
<h2 id="select--deselect-spi-device"><a class="doc-anchor" href="#select--deselect-spi-device">¬ß</a>16.5 Select / Deselect SPI Device</h2>
<p>Remember that NuttX calls <a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L439-L471"><strong>bl602_spi_select</strong></a> to select (or deselect) an SPI Device.</p>
<p>For PineDio Stack, these are the changes we made to <a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L439-L471"><strong>bl602_spi_select</strong></a>‚Ä¶</p>
<ul>
<li>
<p>NuttX already passes the <strong>SPI Device ID</strong> when it calls <a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L439-L471"><strong>bl602_spi_select</strong></a></p>
</li>
<li>
<p>Based on the SPI Device ID, we look up the <strong>SPI Device Table</strong></p>
</li>
<li>
<p>We <strong>swap MISO and MOSI</strong> as specified by the SPI Device Table</p>
</li>
<li>
<p>We <strong>flip the Chip Select Pin</strong> specified in the SPI Device Table</p>
</li>
</ul>
<p>Here‚Äôs the implementation‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>//  Enable/disable the SPI chip select
static void bl602_spi_select(struct spi_dev_s *dev, uint32_t devid,
                             bool selected)
{
  const int32_t *spidev;

  spiinfo(&quot;devid: %lu, CS: %s\n&quot;, devid, selected ? &quot;select&quot; : &quot;free&quot;);

  /* get device from SPI Device Table */

  spidev = bl602_spi_get_device(devid);
  DEBUGASSERT(spidev != NULL);

  /* swap MISO and MOSI if needed */

  if (selected)
    {
      bl602_swap_spi_0_mosi_with_miso(spidev[SWAP_COL]);
    }

  /* set Chip Select */

  bl602_gpiowrite(spidev[CS_COL], !selected);

#ifdef CONFIG_SPI_CMDDATA
  /* revert MISO and MOSI from GPIO Pins to SPI Pins */

  if (!selected)
    {
      bl602_configgpio(BOARD_SPI_MISO);
      bl602_configgpio(BOARD_SPI_MOSI);
    }
#endif
}</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L439-L471">(Source)</a></p>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_gpio.c#L197-L216">(<strong>bl602_gpiowrite</strong> is defined in the BL602 GPIO Driver)</a></p>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_gpio.c#L58-L140">(<strong>bl602_configgpio</strong> also comes from the BL602 GPIO Driver)</a></p>
<p>Let‚Äôs talk about <code>CONFIG_SPI_CMDDATA</code>‚Ä¶</p>
<h2 id="spi-command--data"><a class="doc-anchor" href="#spi-command--data">¬ß</a>16.6 SPI Command / Data</h2>
<p>NuttX RTOS uses MISO as the <strong>ST7789 Data / Command Pin</strong>. <a href="https://lupyuen.github.io/articles/st7789#appendix-spi-cmddata-on-bl602">(See this)</a></p>
<p>(We flip the pin High for ST7789 Data, Low for ST7789 Commands)</p>
<p>But ST7789 is wired ‚Äúbackwards‚Äù on PineDio Stack BL604! We use <strong>MOSI as the ST7789 Data / Command Pin</strong> instead.</p>
<p>Here‚Äôs how we flip the ST7789 Data / Command pin depending on the ‚ÄúSwap MISO / MOSI‚Äù indicator in the SPI Device Table‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>#ifdef CONFIG_SPI_CMDDATA
//  Called by NuttX to flip the ST7789 Data / Command Pin
static int bl602_spi_cmddata(struct spi_dev_s *dev,
                              uint32_t devid, bool cmd)
{
  spiinfo(&quot;devid: %&quot; PRIu32 &quot; CMD: %s\n&quot;, devid, cmd ? &quot;command&quot; :
          &quot;data&quot;);

  if (devid == SPIDEV_DISPLAY(0))
    {
      const int32_t *spidev;
      gpio_pinset_t dc;
      gpio_pinset_t gpio;
      int ret;

      /* get device from SPI Device Table */

      spidev = bl602_spi_get_device(devid);
      DEBUGASSERT(spidev != NULL);

      /* if MISO/MOSI are swapped, DC is MISO, else MOSI */

      dc = spidev[SWAP_COL] ? BOARD_SPI_MISO : BOARD_SPI_MOSI;

      /* reconfigure DC from SPI Pin to GPIO Pin */

      gpio = (dc &amp; GPIO_PIN_MASK)
             | GPIO_OUTPUT | GPIO_PULLUP | GPIO_FUNC_SWGPIO;
      ret = bl602_configgpio(gpio);
      if (ret &lt; 0)
        {
          spierr(&quot;Failed to configure MISO as GPIO\n&quot;);
          DEBUGPANIC();

          return ret;
        }

      /* set DC to high (data) or low (command) */

      bl602_gpiowrite(gpio, !cmd);

      return OK;
    }

  spierr(&quot;SPI cmddata not supported\n&quot;);
  DEBUGPANIC();

  return -ENODEV;
}
#endif</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L726-L774">(Source)</a></p>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_gpio.c#L58-L140">(<strong>bl602_configgpio</strong> is defined in the BL602 GPIO Driver)</a></p>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_gpio.c#L197-L216">(<strong>bl602_gpiowrite</strong> also comes from the BL602 GPIO Driver)</a></p>
<p>Note that we reconfigure MISO / MOSI from SPI Pins to GPIO Pins.</p>
<p>We revert MISO / MOSI back to SPI Pins when the SPI Device is deselected in <a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L462-L470"><strong>bl602_spi_select</strong></a>.</p>
<h2 id="deselect-all-spi-devices"><a class="doc-anchor" href="#deselect-all-spi-devices">¬ß</a>16.7 Deselect All SPI Devices</h2>
<p>At NuttX Startup, we <strong>deselect all SPI Devices</strong> by flipping their Chip Select Pins high (after validating the SPI Device Table)‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>//  Called by NuttX to initialise the SPI Driver
static void bl602_spi_init(struct spi_dev_s *dev)
{
  /* Omitted: Init SPI port */
  ...
  /* spi fifo clear */

  modifyreg32(BL602_SPI_FIFO_CFG_0, SPI_FIFO_CFG_0_RX_CLR
              | SPI_FIFO_CFG_0_TX_CLR, 0);

  /* deselect all spi devices */

  bl602_spi_deselect_devices();
}</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/arch/risc-v/src/bl602/bl602_spi.c#L1191-L1240">(Source)</a></p>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/src/bl602_bringup.c#L178-L208">(<strong>bl602_spi_deselect_devices</strong> is defined here)</a></p>
<h2 id="test-shared-spi-bus"><a class="doc-anchor" href="#test-shared-spi-bus">¬ß</a>16.8 Test Shared SPI Bus</h2>
<p><em>But will this Shared SPI Bus work? Swapping MISO / MOSI on the fly while flipping multiple Chip Select Pins?</em></p>
<p>Yes the Shared SPI Bus works beautifully on PineDio Stack! This is how we tested with <strong>ST7789 Display</strong> and <strong>SX1262 Transceiver</strong>‚Ä¶</p>
<ol>
<li>
<p>We boot PineDio Stack, which calls the ST7789 Driver to render a Pink Screen‚Ä¶</p>
<p><em>(Our SPI Driver unswaps MISO / MOSI, flips ST7789 Chip Select)</em></p>
<div class="example-wrap"><pre class="language-text"><code>board_lcd_getdev: SPI port 0 bound to LCD 0
st7789_getplaneinfo: planeno: 0 bpp: 16</code></pre></div>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx#test-shared-spi-bus">(See the complete log)</a></p>
</li>
<li>
<p>Then we run the <code>spi_test2</code> app to read a SX1262 Register over SPI‚Ä¶</p>
<p><em>(Our SPI Driver swaps MISO / MOSI, flips SX1262 Chip Select)</em></p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; spi_test2
...
Read Register 8: received
a2 a2 a2 a2 80
SX1262 Register 8 is 0x80</code></pre></div>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx#test-shared-spi-bus">(See the complete log)</a></p>
<p>SX1262 returns Register Value <code>0x80</code>, which is correct!</p>
</li>
<li>
<p>Finally we run the <a href="https://lupyuen.github.io/articles/st7789#lvgl-demo-app"><strong>LVGL Demo App</strong></a> to access the ST7789 Display‚Ä¶</p>
<p><em>(Our SPI Driver unswaps MISO / MOSI, flips ST7789 Chip Select)</em></p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; lvgldemo
st7789_getvideoinfo: fmt: 11 xres: 240 yres: 240 nplanes: 1
lcddev_init: VideoInfo:
  fmt: 11
  xres: 240
  yres: 240
  nplanes: 1
...
monitor_cb: 57600 px refreshed in 1110 ms</code></pre></div>
<p><a href="https://github.com/lupyuen/pinedio-stack-nuttx#test-shared-spi-bus">(See the complete log)</a></p>
<p>Which renders the LVGL Demo Screen correctly!</p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/pinedio2-dark2.jpg" alt="LVGL Demo App" /></p>
<h2 id="st7789-spi-mode"><a class="doc-anchor" href="#st7789-spi-mode">¬ß</a>16.9 ST7789 SPI Mode</h2>
<p>BL602 / BL604 has another SPI Quirk that affects ST7789 on PineDio Stack‚Ä¶</p>
<p>BL602 / BL604 talks to ST7789 Display at <strong>SPI Mode 1 or Mode 3</strong>, depending on whether <strong>MISO / MOSI are swapped</strong>‚Ä¶</p>
<ul>
<li>
<p>If MISO / MOSI are <strong>NOT Swapped</strong>:</p>
<p>Use <strong>SPI Mode 1</strong></p>
</li>
<li>
<p>If MISO / MOSI are <strong>Swapped</strong>:</p>
<p>Use <strong>SPI Mode 3</strong></p>
</li>
</ul>
<p>Since MISO / MOSI are not swapped for ST7789 on PineDio Stack, we use <strong>SPI Mode 1</strong>. Here‚Äôs the implementation‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>#ifdef CONFIG_BL602_SPI0
#include &quot;../boards/risc-v/bl602/bl602evb/include/board.h&quot;
#endif  /* CONFIG_BL602_SPI0 */

//  If ST7789 is enabled...
#ifdef CONFIG_LCD_ST7789

//  If this is BL602...
#ifdef CONFIG_BL602_SPI0

  //  If MISO/MOSI are not swapped...
  #if defined(BOARD_LCD_SWAP) &amp;&amp; BOARD_LCD_SWAP == 0
    //  Use SPI Mode 1 as workaround for BL602
    #warning Using SPI Mode 1 for ST7789 on BL602 (MISO/MOSI not swapped)
    #define CONFIG_LCD_ST7789_SPIMODE SPIDEV_MODE1

  //  If MISO/MOSI are swapped...
  #else
    //  Use SPI Mode 3 as workaround for BL602
    #warning Using SPI Mode 3 for ST7789 on BL602 (MISO/MOSI swapped)
    #define CONFIG_LCD_ST7789_SPIMODE SPIDEV_MODE3
  #endif /* BOARD_LCD_SWAP */

//  If this is not BL602...
#else

  //  Use the SPI Mode specified in menuconfig
  #ifndef CONFIG_LCD_ST7789_SPIMODE
  #define CONFIG_LCD_ST7789_SPIMODE SPIDEV_MODE0
  #endif   /* CONFIG_LCD_ST7789_SPIMODE */

#endif   /* CONFIG_BL602_SPI0 */</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/lcd/st7789.c#L42-L66">(Source)</a></p>
<p>Note that we have configured PineDio Stack to talk to SX1262 at <strong>SPI Mode 1</strong> via the SPI Test Driver ‚Äú<strong>/dev/spitest0</strong>‚Äù. <a href="https://lupyuen.github.io/articles/spi2#appendix-spi-mode-quirk">(See this)</a></p>
<h2 id="st7789-spi-frequency"><a class="doc-anchor" href="#st7789-spi-frequency">¬ß</a>16.10 ST7789 SPI Frequency</h2>
<p>We have configured the <strong>SPI Frequency</strong> of the ST7789 Display to <strong>40 MHz</strong>, the maximum supported by BL604‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>CONFIG_LCD_ST7789_FREQUENCY=4000000</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/boards/risc-v/bl602/bl602evb/configs/pinedio/defconfig#L580">(Source)</a></p>
<p>We configured the SPI Frequency in menuconfig at‚Ä¶</p>
<ul>
<li>Device Drivers ‚Üí LCD Driver Support ‚Üí Graphic LCD Driver Support ‚Üí LCD Driver Selection ‚Üí Sitronix ST7789 ‚Üí SPI Frequency</li>
</ul>
<p>In future we should implement SPI with <strong>Direct Memory Access</strong> (DMA) to avoid busy-polling the SPI Bus. <a href="https://lupyuen.github.io/articles/pinedio2#spi-direct-memory-access">(See this)</a></p>
<p>Hopefully this will improve the responsiveness of the touchscreen.</p>
<p><strong>UPDATE:</strong> SPI DMA is now supported on BL602 / BL604 NuttX‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/spi2#appendix-spi-dma-on-bl602-nuttx"><strong>‚ÄúSPI DMA on BL602 NuttX‚Äù</strong></a></li>
</ul>
<h2 id="sx1262-chip-select"><a class="doc-anchor" href="#sx1262-chip-select">¬ß</a>16.11 SX1262 Chip Select</h2>
<p>There‚Äôs a potential Race Condition if we use the SX1262 Driver concurrently with the ST7789 Driver‚Ä¶</p>
<ul>
<li>
<p>During LoRa Transmission, SX1262 Driver calls <strong>ioctl()</strong> to flip SX1262 Chip Select to Low</p>
<p><a href="https://github.com/lupyuen/lora-sx1262/blob/lorawan/src/sx126x-nuttx.c#L806-L832">(See this)</a></p>
</li>
<li>
<p>SX1262 Driver calls SPI Test Driver ‚Äú<strong>/dev/spitest0</strong>‚Äù, which locks (<strong>SPI_LOCK</strong>) and selects (<strong>SPI_SELECT</strong>) the SPI Bus (with SPI Device ID 0)</p>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinedio/drivers/rf/spi_test_driver.c#L161-L208">(See this)</a></p>
</li>
<li>
<p>Note that the calls to <strong>ioctl()</strong> and <strong>SPI_LOCK</strong> / <strong>SPI_SELECT</strong> are NOT Atomic</p>
</li>
<li>
<p>If the ST7789 Driver is active between the calls to <strong>ioctl()</strong> and <strong>SPI_LOCK</strong> / <strong>SPI_SELECT</strong>, both SX1262 Chip Select and ST7789 Chip Select will be flipped to Low</p>
</li>
<li>
<p>This might transmit garbage to SX1262</p>
</li>
</ul>
<p>To solve this problem, we will register a new SPI Test Driver ‚Äú<strong>/dev/spitest1</strong>‚Äù with SPI Device ID 1. (With some tweaks to the driver code)</p>
<p>The LoRa Driver will be modified to access ‚Äú<strong>/dev/spitest1</strong>‚Äù, which will call <strong>SPI_LOCK</strong> and <strong>SPI_SELECT</strong> with SPI Device ID 1.</p>
<p>Since the SPI Device ID is 1, <strong>SPI_SELECT</strong> will flip the SX1262 Chip Select to Low.</p>
<p><img src="https://lupyuen.github.io/images/pinedio2-inside9.jpg" alt="Inside PineDio Stack" /></p>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>