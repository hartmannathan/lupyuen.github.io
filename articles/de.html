<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Rendering PinePhone&#39;s Display (DE and TCON0)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Rendering PinePhone's Display (DE and TCON0)" 
    data-rh="true">
<meta property="og:description" 
    content="How does Pine64 PinePhone render graphics on its LCD Display? Let's find out about the Allwinner A64 SoC's Display Engine (DE) and Timing Controller (TCON0)."
    data-rh="true">
<meta name="description" 
    content="How does Pine64 PinePhone render graphics on its LCD Display? Let's find out about the Allwinner A64 SoC's Display Engine (DE) and Timing Controller (TCON0).">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/de-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Rendering PinePhone&#39;s Display (DE and TCON0)</h1>
    <nav id="TOC"><ul>
<li><a href="#display-rendering-on-pinephone">1 Display Rendering on PinePhone</a><ul></ul></li>
<li><a href="#display-engine-in-allwinner-a64">2 Display Engine in Allwinner A64</a><ul></ul></li>
<li><a href="#render-colours">3 Render Colours</a><ul></ul></li>
<li><a href="#render-mandelbrot-set">4 Render Mandelbrot Set</a><ul></ul></li>
<li><a href="#animate-madelbrot-set">5 Animate Madelbrot Set</a><ul></ul></li>
<li><a href="#render-square-overlay">6 Render Square Overlay</a><ul></ul></li>
<li><a href="#render-circle-overlay">7 Render Circle Overlay</a><ul></ul></li>
<li><a href="#test-pinephone-display-engine">8 Test PinePhone Display Engine</a><ul></ul></li>
<li><a href="#p-boot-display-code">9 p-boot Display Code</a><ul></ul></li>
<li><a href="#nuttx-display-driver-for-pinephone">10 NuttX Display Driver for PinePhone</a><ul></ul></li>
<li><a href="#whats-next">11 What‚Äôs Next</a><ul></ul></li>
<li><a href="#appendix-overview-of-allwinner-a64-display-engine">12 Appendix: Overview of Allwinner A64 Display Engine</a><ul></ul></li>
<li><a href="#appendix-initialising-the-allwinner-a64-display-engine">13 Appendix: Initialising the Allwinner A64 Display Engine</a><ul></ul></li>
<li><a href="#appendix-programming-the-allwinner-a64-display-engine">14 Appendix: Programming the Allwinner A64 Display Engine</a><ul></ul></li>
<li><a href="#appendix-timing-controller-tcon0">15 Appendix: Timing Controller (TCON0)</a><ul></ul></li>
<li><a href="#appendix-display-backlight">16 Appendix: Display Backlight</a><ul></ul></li>
<li><a href="#appendix-power-management-integrated-circuit">17 Appendix: Power Management Integrated Circuit</a><ul></ul></li>
<li><a href="#appendix-reset-lcd-panel">18 Appendix: Reset LCD Panel</a><ul></ul></li>
<li><a href="#appendix-reduced-serial-bus">19 Appendix: Reduced Serial Bus</a><ul>
<li><a href="#read-from-rsb">19.1 Read from RSB</a><ul></ul></li>
<li><a href="#write-to-rsb">19.2 Write to RSB</a><ul></ul></li>
<li><a href="#wait-for-rsb-status">19.3 Wait for RSB Status</a><ul></ul></li>
<li><a href="#wait-for-rsb-transaction">19.4 Wait for RSB Transaction</a><ul></ul></li></ul></li></ul></nav><p>üìù <em>30 Oct 2022</em></p>
<p><img src="https://lupyuen.github.io/images/de-title.jpg" alt="PinePhone rendering Mandelbrot Set on Apache NuttX RTOS" /></p>
<p><em>PinePhone rendering Mandelbrot Set on Apache NuttX RTOS</em></p>
<p><strong>UPDATE:</strong> PinePhone is now officially supported by Apache NuttX RTOS <a href="https://lupyuen.github.io/articles/uboot#appendix-pinephone-is-now-supported-by-apache-nuttx-rtos">(See this)</a></p>
<p>In the last 2 articles we talked about <a href="https://wiki.pine64.org/index.php/PinePhone"><strong>Pine64 PinePhone</strong></a> (pic above) and how we built a <strong>Display Driver</strong> for PinePhone‚Äôs MIPI Display Serial Interface‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi"><strong>‚ÄúUnderstanding PinePhone‚Äôs Display (MIPI DSI)‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi2"><strong>‚ÄúNuttX RTOS for PinePhone: Display Driver in Zig‚Äù</strong></a></p>
</li>
</ul>
<p>But our PinePhone Display Driver <strong>isn‚Äôt complete</strong>‚Ä¶ It won‚Äôt render any graphics!</p>
<p>Today we‚Äôll learn about the missing bits in our Display Driver‚Ä¶</p>
<ul>
<li>
<p>What‚Äôs the <strong>Display Engine (DE)</strong> inside PinePhone</p>
</li>
<li>
<p>How the <strong>Timing Controller (TCON0)</strong> controls PinePhone‚Äôs LCD Display</p>
</li>
<li>
<p>How we call DE and TCON0 to <strong>render graphics</strong></p>
</li>
<li>
<p>How our new <strong>PinePhone Display Driver</strong> will support DE and TCON0</p>
</li>
</ul>
<p><em>Why are we doing this?</em></p>
<p>We‚Äôre now porting <a href="https://lupyuen.github.io/articles/uboot"><strong>Apache NuttX RTOS</strong></a> to PinePhone and we have created a (barebones) <a href="https://lupyuen.github.io/articles/dsi2"><strong>Display Driver in Zig</strong></a> that initialises the LCD Display.</p>
<p>To finish the driver, we need to understand what‚Äôs inside PinePhone‚Äôs Display Engine and Timing Controller.</p>
<p>Let‚Äôs dive in and continue the journey from our (super long) <strong>NuttX Porting Journal</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>lupyuen/pinephone-nuttx</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/de-block1a.jpg" alt="Display Engine (DE) and Timing Controller (TCON0) from A64 User Manual (Page 498)" /></p>
<p><a href="https://dl.linux-sunxi.org/A64/A64_Datasheet_V1.1.pdf"><em>Display Engine (DE) and Timing Controller (TCON0) from A64 User Manual (Page 498)</em></a></p>
<h1 id="display-rendering-on-pinephone"><a href="#display-rendering-on-pinephone">1 Display Rendering on PinePhone</a></h1>
<p><em>Suppose we‚Äôre building our own Operating System for PinePhone‚Ä¶</em></p>
<p><em>How do we render graphics on the LCD Display?</em></p>
<p>Rendering graphics directly to PinePhone Hardware (‚ÄúBare Metal‚Äù) is more complicated than we expect!</p>
<p>Let‚Äôs walk through the steps (pic above)‚Ä¶</p>
<ol>
<li>
<p>Inside PinePhone‚Äôs <a href="https://linux-sunxi.org/A64"><strong>Allwinner A64 SoC</strong></a> is a <strong>Display Engine</strong> that combines and transforms Pixel Data for display</p>
</li>
<li>
<p>The Display Engine reads the Pixel Data from <strong>Framebuffers in RAM</strong> via <strong>Direct Memory Access (DMA)</strong></p>
<p>(Up to 3 Framebuffers)</p>
</li>
<li>
<p>Inside the Display Engine is a <strong>Real-Time Mixer</strong> (RT Mixer Core 0) that handles real-time <strong>DMA, Overlay, Scaling and Blending</strong> of the Pixel Data (from the Framebuffers)</p>
<p>(We won‚Äôt need RT Mixer Core 1 today, it‚Äôs a smaller version of Core 0)</p>
</li>
<li>
<p>The Real-Time Mixer supports <strong>3 UI Channels</strong> (for graphics), all mixed together into a <strong>Single Image Frame</strong> in real time</p>
<p>(The Mixer supports Video, but we won‚Äôt use it today)</p>
</li>
<li>
<p>The successive Image Frames (generated by the Display Engine) are pumped in real time to the <a href="https://lupyuen.github.io/articles/pio#lcd-controller-tcon0"><strong>Timing Controller (TCON0)</strong></a></p>
</li>
<li>
<p>The Timing Controller pushes the Image Frames to <strong>PinePhone‚Äôs LCD Controller</strong> as a stream of pixels (over MIPI Display Serial Interface)</p>
</li>
</ol>
<p>All this happens in <strong>Real Time</strong>‚Ä¶ Any updates to the Framebuffers in RAM are <strong>pushed out instantly</strong> to the LCD Display.</p>
<p>(Super efficiently thanks to DMA!)</p>
<p><em>Why so complicated?</em></p>
<p>PinePhone‚Äôs ST7703 LCD Controller <strong>doesn‚Äôt have any RAM</strong> inside‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#sitronix-st7703-lcd-controller"><strong>‚ÄúSitronix ST7703 LCD Controller‚Äù</strong></a></li>
</ul>
<p>That‚Äôs why we need to <strong>pump a constant stream of pixels</strong> to the LCD Display via DMA, Display Engine and Timing Controller‚Ä¶ Otherwise the display stays blank!</p>
<p><a href="https://en.wikipedia.org/wiki/Video_Toaster">(Sounds a bit like the Amiga Video Toaster)</a></p>
<p>Let‚Äôs look inside the Display Engine‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/de-mixer1a.jpg" alt="Real-Time Mixer in A64 Display Engine (Page 22)" /></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf"><em>Real-Time Mixer in A64 Display Engine (Page 22)</em></a></p>
<h1 id="display-engine-in-allwinner-a64"><a href="#display-engine-in-allwinner-a64">2 Display Engine in Allwinner A64</a></h1>
<p>Recall that Allwinner A64‚Äôs Display Engine is a <strong>Real-Time Mixer</strong> that handles real-time <strong>DMA, Overlay, Scaling and Blending</strong> of the Framebuffers‚Ä¶</p>
<p>And the Display Engine pushes the output pixels to the <a href="https://lupyuen.github.io/articles/pio#lcd-controller-tcon0"><strong>Timing Controller (TCON0)</strong></a> for display on PinePhone‚Äôs LCD Display.</p>
<p>The pic above shows how the Display Engine mixes together <strong>3 UI Channels (Framebuffers)</strong> via DMA1, 2 and 3.</p>
<p>(Plus a Video Channel on DMA0, but we won‚Äôt use it today)</p>
<p><em>Is the Display Engine documented?</em></p>
<p>The official doc for the A64 Display Engine is here‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf"><strong>Allwinner Display Engine 2.0 Specifications</strong></a></li>
</ul>
<p>Though it doesn‚Äôt describe the actual steps for programming the Display Engine.</p>
<p>In a while we‚Äôll boot <a href="https://lupyuen.github.io/articles/uboot"><strong>Apache NuttX RTOS</strong></a> on PinePhone and experiment with the Display Engine, to understand it better.</p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-overview-of-allwinner-a64-display-engine">(Overview of A64 Display Engine)</a></p>
<p><em>But the Display Engine doc doesn‚Äôt mention A64?</em></p>
<p>PinePhone‚Äôs A64 Display Engine is hidden under <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf"><strong>Allwinner H3 (page 22)</strong></a>, because Allwinner A64 is actually a H3 upgraded with 64-bit Arm Cores‚Ä¶</p>
<blockquote>
<p>‚ÄúThe A64 is basically an Allwinner H3 with the Cortex-A7 cores replaced with Cortex-A53 cores (ARM64 architecture). They share most of the memory map, clocks, interrupts and also uses the same IP blocks.‚Äù</p>
</blockquote>
<blockquote>
<p><a href="https://linux-sunxi.org/A64">(Source)</a></p>
</blockquote>
<p><em>Why are there 2 Mixers in the A64 Display Engine?</em></p>
<p>Maybe because A64 (or H3) was designed for <a href="https://linux-sunxi.org/H3"><strong>OTT Set-Top Boxes</strong></a> with Picture-In-Picture Overlay Video?</p>
<p>The 3 UI Overlay Channels would be super helpful for overlaying an OTT Graphical UI on top of a Video Channel.</p>
<p><a href="https://en.wikipedia.org/wiki/Pine64#History">(Wait‚Ä¶ Wasn‚Äôt Pine64 created thanks to OTT Boxes? ü§î)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(<strong>DE2TCON_MUX</strong> at Page 26 says that Mixer 0 is for TCON0 MIPI DSI, Mixer 1 for TCON1 HDMI Output)</a></p>
<p><img src="https://lupyuen.github.io/images/de-code1a.png" alt="Rendering simple Colour Blocks on the PinePhone Display" /></p>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L201-L214">(Source)</a></p>
<h1 id="render-colours"><a href="#render-colours">3 Render Colours</a></h1>
<p><em>How do we program the A64 Display Engine to render graphics?</em></p>
<p>Let‚Äôs begin by rendering simple <strong>Colour Blocks</strong> on the PinePhone Display‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/de-rgb.jpg" alt="Blue, Green, Red Blocks on PinePhone" /></p>
<p>First we <strong>allocate the Framebuffer</strong>: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L170-L175">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Init Framebuffer 0:
// Fullscreen 720 x 1440 (4 bytes per ARGB pixel)
// fb0_len is 720 * 1440
static uint32_t fb0[720 * 1440];
int fb0_len = sizeof(fb0) / sizeof(fb0[0]);</code></pre></div>
<p><a href="https://en.wikipedia.org/wiki/PinePhone">(PinePhone‚Äôs display resolution is 720 x 1440)</a></p>
<p>Each Pixel occupies <strong>4 bytes</strong>. (ARGB 8888 Format)</p>
<p>Then we <strong>fill the Framebuffer</strong> with Blue, Green and Red: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L201-L214">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Fill with Blue, Green and Red
for (int i = 0; i &lt; fb0_len; i++) {
  // Colours are in ARGB format
  if (i &lt; fb0_len / 4) {
    // Blue for top quarter
    fb0[i] = 0x80000080;
  } else if (i &lt; fb0_len / 2) {
    // Green for next quarter
    fb0[i] = 0x80008000;
  } else {
    // Red for lower half
    fb0[i] = 0x80800000;
  }
}</code></pre></div>
<p>Each Pixel in the Framebuffer is stored as <strong>32-bit ARGB 8888</strong>.</p>
<p>Thus <strong><code>0x8000</code> <code>8000</code></strong> means Semi-Transparent Green‚Ä¶</p>
<div><table><thead><tr><th style="text-align: left">Channel</th><th>Value</th></tr></thead><tbody>
<tr><td style="text-align: left">Alpha</td><td><code>0x80</code></td></tr>
<tr><td style="text-align: left">Red</td><td><code>0x00</code></td></tr>
<tr><td style="text-align: left">Green</td><td><code>0x80</code></td></tr>
<tr><td style="text-align: left">Blue</td><td><code>0x00</code></td></tr>
</tbody></table>
</div>
<p>A64 Display Engine lets us render 3 Framebuffers as <strong>3 UI Channels</strong>.</p>
<p>This is how we allocate the 3 UI Channels: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L257-L262">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Allocate 3 UI Channels
static struct display disp;
memset(&amp;disp, 0, sizeof(disp));
struct display *d = &amp;disp;</code></pre></div>
<p><a href="https://megous.com/git/p-boot/tree/src/display.h#n28">(<strong><code>display</code></strong> struct is defined here)</a></p>
<p>We point the <strong>First UI Channel</strong> to our Framebuffer: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L262-L271">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Init UI Channel 1: (Base Channel)
// Fullscreen 720 x 1440
d-&gt;planes[0].fb_start = (uintptr_t) fb0;  // Framebuffer Address
d-&gt;planes[0].fb_pitch = 720 * 4;  // Framebuffer Pitch
d-&gt;planes[0].src_w    = 720;   // Source Width
d-&gt;planes[0].src_h    = 1440;  // Source Height
d-&gt;planes[0].dst_w    = 720;   // Dest Width
d-&gt;planes[0].dst_h    = 1440;  // Dest Height</code></pre></div>
<p>(<strong><code>fb_pitch</code></strong> is the number of bytes per row of pixels)</p>
<p>We disable the <strong>Second and Third UI Channels</strong> for now: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L271-L299">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Init UI Channel 2: (First Overlay)
// Disable Channel for now
d-&gt;planes[1].fb_start = 0;

// Init UI Channel 3: (Second Overlay)
// Disable Channel for now
d-&gt;planes[2].fb_start = 0;

// Render the UI Channels over DMA
display_commit(d);</code></pre></div>
<p>And we <strong>render the 3 UI Channels</strong>.</p>
<p>(<a href="https://megous.com/git/p-boot/tree/src/display.c#n2017"><strong><code>display_commit</code></strong></a> is defined in the p-boot Display Code, we‚Äôll come back to this)</p>
<p>That‚Äôs all! We should see the <a href="https://lupyuen.github.io/images/de-rgb.jpg"><strong>Blue, Green and Red Blocks</strong></a> like in the pic above.</p>
<p>(Not sure why there are black lines, needs investigation)</p>
<p><em>Didn‚Äôt we set the Alpha Channel to <code>0x80</code>?</em></p>
<p><strong>UI Channel 1</strong> is the Base UI Channel, so the Alpha Channel has no effect.</p>
<p>(Actually UI Channel 1 is configured as <a href="https://lupyuen.github.io/articles/de#appendix-overview-of-allwinner-a64-display-engine"><strong>XRGB 8888</strong></a>)</p>
<p>In a while we‚Äôll set the Alpha Channels for UI Channels 2 and 3. And the UI Channels will appear as semi-transparent overlays.</p>
<p><img src="https://lupyuen.github.io/images/de-code3a.png" alt="Rendering Mandelbrot Set on PinePhone" /></p>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L175-L200">(Source)</a></p>
<h1 id="render-mandelbrot-set"><a href="#render-mandelbrot-set">4 Render Mandelbrot Set</a></h1>
<p><em>Colour Blocks are so blah. Are we sure we can render every single pixel correctly?</em></p>
<p>Let‚Äôs render something infinitely more detailed and sophisticated‚Ä¶ <a href="https://en.wikipedia.org/wiki/Mandelbrot_set"><strong>Mandelbrot Set</strong></a>!</p>
<p><img src="https://lupyuen.github.io/images/de-title.jpg" alt="Mandelbrot Set on PinePhone" /></p>
<p>Earlier we created a <strong>Fullscreen Framebuffer</strong>: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L170-L175">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Init Framebuffer 0:
// Fullscreen 720 x 1440 (4 bytes per ARGB pixel)
// fb0_len is 720 * 1440
static uint32_t fb0[720 * 1440];
int fb0_len = sizeof(fb0) / sizeof(fb0[0]);</code></pre></div>
<p>Now we fill the Framebuffer with the <strong>Mandelbrot Set</strong>, pixel by pixel: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L175-L200">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Fill with Mandelbrot Set.
// For every pixel row...
for (int y = 0; y &lt; 1440; y++) {

  // For every pixel column...
  for (int x = 0; x &lt; 720; x++) {

    // Convert Pixel Coordinates to a Complex Number
    float cx = x_start + (y / 1440.0) * (x_end - x_start);
    float cy = y_start + (x / 720.0)  * (y_end - y_start);

    // Compute Manelbrot Set
    int m = mandelbrot(cx, cy);

    // Color depends on the number of iterations.
    // MAX_ITER is 80
    uint8_t hue = 255.0 * m / MAX_ITER;
    uint8_t saturation = 255;
    uint8_t value = (m &lt; MAX_ITER) ? 255 : 0;

    // Convert Hue / Saturation / Value to RGB
    uint32_t rgb = hsvToRgb(hue, saturation, value);

    // Set the Pixel Colour (ARGB Format)
    int p = (y * 720) + x;
    assert(p &lt; fb0_len);
    fb0[p] = 0x80000000 | rgb;
  }
}</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L335-L432">(<strong><code>mandelbrot</code></strong> and <strong><code>hsvToRgb</code></strong> are defined here)</a></p>
<p>Then we initialise the <strong>3 UI Channels</strong> and render them. <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L257-L299">(Like this)</a></p>
<p>The <a href="https://lupyuen.github.io/images/de-title.jpg"><strong>Mandelbrot Set</strong></a> appears on PinePhone, like in the pic above.</p>
<p>Yep we can render every single pixel precisely on PinePhone!</p>
<p><img src="https://lupyuen.github.io/images/de-code4a.png" alt="Animating the Madelbrot Set" /></p>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L299-L334">(Source)</a></p>
<h1 id="animate-madelbrot-set"><a href="#animate-madelbrot-set">5 Animate Madelbrot Set</a></h1>
<p><em>Earlier we said that updates to the Framebuffer are instantly pushed to PinePhone‚Äôs Display via DMA‚Ä¶</em></p>
<p><em>Can we prove it?</em></p>
<p>Yep let‚Äôs <strong>animate the Mandelbrot Set</strong> in our Framebuffer. And watch the updates appear instantly on PinePhone‚Äôs Display, thanks to <strong>Direct Memory Access (DMA)</strong>!</p>
<p>This is how we animate the Mandelbrot Set: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L257-L334">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Omitted: Init UI Channels 1, 2 and 3
d-&gt;planes[0].fb_start = ...
d-&gt;planes[1].fb_start = ...
d-&gt;planes[2].fb_start = ...
...

// Render the UI Channels over DMA
display_commit(d);

// Animate the Mandelbrot Set forever.
// For every frame of animation...
for (;;) {

  // Fill with Mandelbrot Set.
  // For every pixel row...
  for (int y = 0; y &lt; 1440; y++) {

    // For every pixel column...
    for (int x = 0; x &lt; 720; x++) {</code></pre></div>
<p>In the code above, we <strong>repeatly render</strong> the Mandelbrot Set for every frame of animation.</p>
<p>We <strong>render each frame</strong> the exact same way as before‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>      // Convert Pixel Coordinates to a Complex Number
      float cx = x_start + (y / 1440.0) * (x_end - x_start);
      float cy = y_start + (x / 720.0)  * (y_end - y_start);

      // Compute Manelbrot Set
      int m = mandelbrot(cx, cy);

      // Color depends on the number of iterations
      // MAX_ITER is 80
      uint8_t hue = 255.0 * m / MAX_ITER;
      uint8_t saturation = 255;
      uint8_t value = (m &lt; MAX_ITER) ? 255 : 0;

      // Convert Hue / Saturation / Value to RGB
      uint32_t rgb = hsvToRgb(hue, saturation, value);

      // Set the Pixel Colour (ARGB Format)
      int p = (y * 720) + x;
      assert(p &lt; fb0_len);
      fb0[p] = 0x80000000 | rgb;
    }
  }</code></pre></div>
<p>But now we <strong>tweak slightly the position</strong> of the Mandelbrot Set‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>  // Zoom in to (-1.4, 0)
  float x_dest = -1.4;
  float y_dest = 0;
  x_start += (x_dest - x_start) * 0.05;
  x_end   -= (x_end  - x_dest)  * 0.05;
  y_start += (y_dest - y_start) * 0.05;
  y_end   -= (y_end  - y_dest)  * 0.05;
}</code></pre></div>
<p>Before looping back to render the next frame.</p>
<p>We should see this Animated Mandelbrot Set‚Ä¶</p>
<ul>
<li><a href="https://youtu.be/toC9iiPRwRI"><strong>Demo Video on YouTube</strong></a></li>
</ul>
<p>Thus DMA works correctly for rendering our Framebuffers on the fly!</p>
<p><em>We don‚Äôt call <code>display_commit</code> after every frame?</em></p>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L296-L299"><strong><code>display_commit</code></strong></a> only needs to be called once. It configures the Display Engine to read our Framebuffer directly via DMA.</p>
<p>Subsequent updates to the Framebuffer will be automatically pushed to the display over DMA.</p>
<p><img src="https://lupyuen.github.io/images/de-code5b.png" alt="Rendering a Square Overlay on PinePhone" /></p>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L215-L226">(Source)</a></p>
<h1 id="render-square-overlay"><a href="#render-square-overlay">6 Render Square Overlay</a></h1>
<p><em>Earlier we said that A64 Display Engine can render Framebuffers as Overlays. How can we do it?</em></p>
<p>The pic below shows that A64 Display Engine can render <strong>3 Framebuffers (UI Channels)</strong> as overlays, via DMA1, 2 and 3‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/de-mixer1a.jpg" alt="Real-Time Mixer in A64 Display Engine (Page 22)" /></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf"><em>Real-Time Mixer in A64 Display Engine (Page 22)</em></a></p>
<p>(Skipping DMA0 because it‚Äôs for Video only)</p>
<p>The UI Channels are rendered as overlays in a specific sequence (pic above)‚Ä¶</p>
<ul>
<li>
<p><strong>UI Channel 2</strong> (DMA2) is rendered on top of <strong>UI Channel 1</strong> (DMA1), then‚Ä¶</p>
</li>
<li>
<p><strong>UI Channel 3</strong> (DMA3) is rendered on top of <strong>UI Channel 2</strong> (DMA2)</p>
</li>
</ul>
<p>Our Mandelbrot Set is rendered on <strong>UI Channel 1</strong> (DMA1), which is the Base Channel.</p>
<p>Let‚Äôs overlay a <strong>Blue Square</strong> on <strong>UI Channel 2</strong> (DMA2).</p>
<p>First we prepare a <strong>600 x 600 Framebuffer</strong> that contains a Semi-Transparent Blue Square: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L215-L226">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Init Framebuffer 1:
// Square 600 x 600 (4 bytes per ARGB pixel)
// fb1_len is 600 * 600
static uint32_t fb1[600 * 600];
int fb1_len = sizeof(fb1) / sizeof(fb1[0]);

// Fill with Semi-Transparent Blue
for (int i = 0; i &lt; fb1_len; i++) {
  // Colours are in ARGB format
  fb1[i] = 0x80000080;
}</code></pre></div>
<p>The new Framebuffer is a little <strong>smaller than the Screen Width</strong>. (600 pixels vs 720 pixels)</p>
<p>Thanks to <strong>Framebuffer Blending</strong> in A64 Display Engine, it‚Äôs perfectly OK to render the new Framebuffer at 600 x 600. (As a partial screen region).</p>
<p>This is how we set <strong>UI Channel 2</strong> to the 600 x 600 Framebuffer: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L271-L283">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Init UI Channel 2: (First Overlay)
// Square 600 x 600
d-&gt;planes[1].fb_start = (uintptr_t) fb1;  // Framebuffer Address
d-&gt;planes[1].fb_pitch = 600 * 4;  // Framebuffer Pitch
d-&gt;planes[1].src_w    = 600;  // Source Width
d-&gt;planes[1].src_h    = 600;  // Source Height
d-&gt;planes[1].dst_w    = 600;  // Dest Width
d-&gt;planes[1].dst_h    = 600;  // Dest Height
d-&gt;planes[1].dst_x    = 52;   // Dest X Offset
d-&gt;planes[1].dst_y    = 52;   // Dest Y Offset</code></pre></div>
<p><em>Can the Dest Width / Height be different from the Source Width / Height?</em></p>
<p>Yes, because the Display Engine supports Scaling. But we won‚Äôt do that today, to simplify our discussion.</p>
<p>Before we watch the outcome, let‚Äôs render another overlay‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/de-code5c.png" alt="Rendering a Circle Overlay on PinePhone" /></p>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L226-L251">(Source)</a></p>
<h1 id="render-circle-overlay"><a href="#render-circle-overlay">7 Render Circle Overlay</a></h1>
<p>Our PinePhone UI Overlay Sandwich has these goodies inside‚Ä¶</p>
<ul>
<li>
<p><strong>UI Channel 1</strong>: Mandelbrot Set (Base Channel)</p>
</li>
<li>
<p><strong>UI Channel 2</strong>: Semi-Transparent Blue Square</p>
</li>
</ul>
<p>Let‚Äôs top off our Cucumber Sandwich‚Ä¶</p>
<ul>
<li><strong>UI Channel 3</strong>: Semi-Transparent Green Circle</li>
</ul>
<p>First we fill a Fullscreen Framebuffer with a <strong>Semi-Transparent Green Circle</strong>: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L226-L251">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Init Framebuffer 2:
// Fullscreen 720 x 1440 (4 bytes per ARGB pixel)
// fb2_len is 720 * 1440
static uint32_t fb2[720 * 1440];
int fb2_len = sizeof(fb2) / sizeof(fb2[0]);

// Fill with Semi-Transparent Green Circle.
// For every pixel row...
for (int y = 0; y &lt; 1440; y++) {

  // For every pixel column...
  for (int x = 0; x &lt; 720; x++) {

    // Get pixel index
    int p = (y * 720) + x;
    assert(p &lt; fb2_len);

    // Shift coordinates so that centre of screen is (0,0)
    int x_shift = x - 360;
    int y_shift = y - 720;

    // If pixel is inside circle (x^2 + y^2 &lt; radius^2)...
    // Set the pixel to Semi-Transparent Green
    if (x_shift*x_shift + y_shift*y_shift &lt; 360*360) {
      fb2[p] = 0x80008000;  // Semi-Transparent Green in ARGB Format
    } else {  // Otherwise set to Transparent Black
      fb2[p] = 0x00000000;  // Transparent Black in ARGB Format
    }
  }
}</code></pre></div>
<p>Note that pixels outside the circle are set to <strong>Transparent Black</strong>.</p>
<p>(Which makes them invisible)</p>
<p>Next we point <strong>UI Channel 3</strong> to the Fullscreen Framebuffer: <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L283-L296">test_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Init UI Channel 3: (Second Overlay)
// Fullscreen 720 x 1440 with Alpha Blending
d-&gt;planes[2].fb_start = (uintptr_t) fb2;  // Framebuffer Address
d-&gt;planes[2].fb_pitch = 720 * 4;  // Framebuffer Pitch
d-&gt;planes[2].src_w    = 720;   // Source Width
d-&gt;planes[2].src_h    = 1440;  // Source Height
d-&gt;planes[2].dst_w    = 720;   // Dest Width
d-&gt;planes[2].dst_h    = 1440;  // Dest Height
d-&gt;planes[2].dst_x    = 0;     // Dest X
d-&gt;planes[2].dst_y    = 0;     // Dest Y
d-&gt;planes[2].alpha    = 128;   // Dest Alpha</code></pre></div>
<p>Note that we set the <strong>Destination Alpha</strong> for the entire UI Channel. So our Green Circle will appear super transparent.</p>
<p>Finally we render the 3 UI Channels‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>// Render the UI Channels over DMA
display_commit(d);</code></pre></div>
<p>We should see the Animated Mandelbrot Set, with Blue Square and (very faint) Green Circle as Overlays. (Pic below)</p>
<p>That‚Äôs how we render 3 UI Channels (with overlay blending) on PinePhone‚Äôs Display Engine!</p>
<p>(Why the horizontal lines in the Blue Square and Green Circle?)</p>
<p><img src="https://lupyuen.github.io/images/de-overlay.jpg" alt="Mandelbrot Set with Blue Square and Green Circle as Overlays" /></p>
<p><em>Mandelbrot Set with Blue Square and Green Circle as Overlays</em></p>
<h1 id="test-pinephone-display-engine"><a href="#test-pinephone-display-engine">8 Test PinePhone Display Engine</a></h1>
<p><em>We‚Äôve seen the Test Code for Display Engine‚Ä¶ How do we run the code?</em></p>
<p>To test the A64 Display Engine, we‚Äôll boot <strong>Apache NuttX RTOS</strong> on PinePhone and run our Test App‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c"><strong>test_display.c</strong></a></li>
</ul>
<p>Follow these steps to <strong>download NuttX RTOS</strong> (with our Test App inside) to a microSD Card‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx#test-pinephone-display-engine"><strong>‚ÄúTest PinePhone Display Engine‚Äù</strong></a></li>
</ul>
<p>Connect our computer to PinePhone via a <a href="https://wiki.pine64.org/index.php/PinePhone#Serial_console"><strong>USB Serial Debug Cable</strong></a>. (At 115.2 kbps)</p>
<p>Boot PinePhone with NuttX RTOS in the microSD Card.</p>
<p>(NuttX won‚Äôt disturb the eMMC Flash Memory)</p>
<p>At the NuttX Shell, enter this command to run our <strong>Test App</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>hello</code></pre></div>
<p>Our Test App controls the A64 Display Engine by setting the Hardware Registers (for the 3 UI Channels)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>HELLO NUTTX ON PINEPHONE!
...
Shell (NSH) NuttX-11.0.0-RC2
nsh&gt; hello
...
display_commit
Configure Blender
  BLD BkColor:     0x1101088 = 0xff000000
  BLD Premultiply: 0x1101084 = 0x0
Channel 1: Set Overlay ...
Channel 1: Set Blender Output ...
Channel 1: Set Blender Input Pipe 0 ...
Channel 1: Disable Scaler ...
Channel 2: Set Overlay ...
Channel 2: Set Blender Input Pipe 1 ...
Channel 2: Disable Scaler ...
Channel 3: Set Overlay ...
Channel 3: Set Blender Input Pipe 2 ...
Channel 3: Disable Scaler ...
Set BLD Route and BLD FColor Control
  BLD Route:          0x1101080 = 0x321
  BLD FColor Control: 0x1101000 = 0x701
Apply Settings
  GLB DBuff: 0x1100008 = 0x1</code></pre></div>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#testing-p-boot-display-engine-on-pinephone">(See the Complete Log)</a></p>
<p>And the Mandelbrot Set appears on PinePhone, together with the Blue Square and Green Circle as overlays. (Pic above)</p>
<p>Yep we have successfully tested the A64 Display Engine on PinePhone! üéâ</p>
<p><em>Hmmm building the Test Code looks complicated‚Ä¶</em></p>
<p>Yeah we need a few steps to build the Test Code because we patched together a few programs to make it work‚Ä¶</p>
<ul>
<li>
<p><strong>Apache NuttX RTOS</strong> for PinePhone</p>
<p><a href="https://lupyuen.github.io/articles/uboot">(See this)</a></p>
</li>
<li>
<p><strong>Zig Driver</strong> for MIPI Display Serial Interface</p>
<p><a href="https://lupyuen.github.io/articles/dsi2">(More about this)</a></p>
</li>
<li>
<p><strong>p-boot Display Code</strong></p>
<p><a href="https://lupyuen.github.io/articles/de#p-boot-display-code">(See the next chapter)</a></p>
</li>
</ul>
<p>The steps will be a lot simpler when we have completed the  Display Engine Driver for NuttX.</p>
<p>Let‚Äôs talk about the p-boot Display Code‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/de-run.png" alt="Running p-boot Display Code on Apache NuttX RTOS with logging" /></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#testing-p-boot-display-engine-on-pinephone"><em>Running p-boot Display Code on Apache NuttX RTOS with logging</em></a></p>
<h1 id="p-boot-display-code"><a href="#p-boot-display-code">9 p-boot Display Code</a></h1>
<p><em>About the code that controls A64 Display Engine‚Ä¶ Where is <code>display_commit</code> defined?</em></p>
<p><a href="https://megous.com/git/p-boot/tree/src/display.c#n2017"><strong><code>display_commit</code></strong></a> comes from the super-helpful <a href="https://xnux.eu/p-boot/"><strong>p-boot PinePhone Bootloader</strong></a> project, which runs directly on PinePhone Hardware. (‚ÄúBare Metal‚Äù)</p>
<p>To test the A64 Display Engine on Apache NuttX RTOS, we borrowed these <a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L135-L142"><strong>Source Files</strong></a> (relevant to the Display Engine) from p-boot‚Ä¶</p>
<ul>
<li><a href="https://megous.com/git/p-boot/tree/src/display.c"><strong>display.c</strong></a></li>
<li><a href="https://megous.com/git/p-boot/tree/src/pmic.c"><strong>pmic.c</strong></a></li>
<li><a href="https://megous.com/git/p-boot/tree/src/uboot/arch/arm/mach-sunxi/clock_sun6i.c"><strong>clock_sun6i.c</strong></a></li>
<li><a href="https://megous.com/git/p-boot/tree/src/uboot/drivers/gpio/sunxi_gpio.c"><strong>sunxi_gpio.c</strong></a></li>
<li><a href="https://megous.com/git/p-boot/tree/src/uboot/arch/arm/mach-sunxi/pinmux.c"><strong>pinmux.c</strong></a></li>
</ul>
<p><a href="https://github.com/lupyuen/nuttx-apps/blob/de2/examples/hello/test_display.c#L115-L135">(Plus a whole bunch of Header Files)</a></p>
<p>Then we modified the above files to compile on NuttX‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/pboot6/p-boot.6.zip"><strong>Modified p-boot Display Code</strong></a></li>
</ul>
<p>Which lets us experiment with the A64 Display Engine on NuttX.</p>
<p><em>How does it control the A64 Display Engine?</em></p>
<p><a href="https://megous.com/git/p-boot/tree/src/display.c#n2017"><strong><code>display_commit</code></strong></a> controls the A64 Display Engine by writing to the <strong>Hardware Registers</strong> for the Display Engine.</p>
<p>The Display Engine‚Äôs Hardware Registers are described here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/de#appendix-overview-of-allwinner-a64-display-engine"><strong>‚ÄúOverview of Allwinner A64 Display Engine‚Äù</strong></a></li>
</ul>
<p><em>But what values does <code>display_commit</code> write to the Hardware Registers?</em></p>
<p>To find out how <a href="https://megous.com/git/p-boot/tree/src/display.c#n2017"><strong><code>display_commit</code></strong></a> updates the Hardware Registers (while rendering the UI Channels), we modded the p-boot Display Code to <strong>log all Register Writes</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/pboot6/p-boot.6.zip"><strong>Modified p-boot Display Code</strong></a></li>
</ul>
<p>Which tells us all the <strong>Hardware Registers and their values</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Configure Blender
  BLD BkColor:     0x1101088 = 0xff000000
  BLD Premultiply: 0x1101084 = 0x0

Channel 1: Set Overlay
  UI Config Attr:      0x1103000 = 0xff000405
  UI Config Top LAddr: 0x1103010 = 0x4064a6ac
  UI Config Pitch:     0x110300c = 0xb40
  UI Config Size:      0x1103004 = 0x59f02cf
  UI Overlay Size:     0x1103088 = 0x59f02cf
  IO Config Coord:     0x1103008 = 0x0

Channel 1: Set Blender Output
  BLD Output Size: 0x110108c = 0x59f02cf
  GLB Size:        0x110000c = 0x59f02cf

Channel 1: Set Blender Input Pipe 0
  BLD Pipe InSize: 0x1101008 = 0x59f02cf
  BLD Pipe FColor: 0x1101004 = 0xff000000
  BLD Pipe Offset: 0x110100c = 0x0
  BLD Pipe Mode:   0x1101090 = 0x3010301

Channel 1: Disable Scaler
  Mixer: 0x1140000 = 0x0

Channel 2: ...</code></pre></div>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#testing-p-boot-display-engine-on-pinephone">(See the Complete Log)</a></p>
<p>When we study the log, we‚Äôll understand how we should <strong>program the A64 Display Engine</strong> to render the 3 UI Channels.</p>
<p>Our findings are documented here‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/de#appendix-initialising-the-allwinner-a64-display-engine"><strong>‚ÄúInitialising the Allwinner A64 Display Engine‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de#appendix-programming-the-allwinner-a64-display-engine"><strong>‚ÄúProgramming the Allwinner A64 Display Engine‚Äù</strong></a></p>
</li>
</ul>
<p>This is very helpful as we create the NuttX Display Driver for PinePhone‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi2-title.jpg" alt="Testing the NuttX Display Driver for PinePhone" /></p>
<p><a href="https://lupyuen.github.io/articles/dsi2"><em>Testing the NuttX Display Driver for PinePhone</em></a></p>
<h1 id="nuttx-display-driver-for-pinephone"><a href="#nuttx-display-driver-for-pinephone">10 NuttX Display Driver for PinePhone</a></h1>
<p><em>Once again, why are we doing all this?</em></p>
<p>We‚Äôre now porting <a href="https://lupyuen.github.io/articles/uboot"><strong>Apache NuttX RTOS</strong></a> to PinePhone.</p>
<p>Someday we hope to have a <strong>fully-functional PinePhone</strong> running on NuttX RTOS‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/arm#pinephone-on-rtos"><strong>‚ÄúPinePhone on RTOS‚Äù</strong></a></li>
</ul>
<p>(Or maybe just run PinePhone on NuttX as a simple touchscreen gadget)</p>
<p>To do that, we need a <strong>NuttX Display Driver</strong>.</p>
<p>That‚Äôs why we‚Äôre probing the internals of PinePhone, to learn everything we need to build the driver.</p>
<p>We‚Äôve documented our earlier research on PinePhone‚Äôs <strong>MIPI Display Serial Interface</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi"><strong>‚ÄúUnderstanding PinePhone‚Äôs Display (MIPI DSI)‚Äù</strong></a></li>
</ul>
<p>Today we learnt so much about PinePhone‚Äôs <strong>A64 Display Engine</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/de#appendix-initialising-the-allwinner-a64-display-engine"><strong>‚ÄúInitialising the Allwinner A64 Display Engine‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de#appendix-programming-the-allwinner-a64-display-engine"><strong>‚ÄúProgramming the Allwinner A64 Display Engine‚Äù</strong></a></p>
</li>
</ul>
<p>We‚Äôre all set to build the NuttX Display Driver for PinePhone!</p>
<p><em>Is there a specific sequence of steps for calling the Display Serial Interface, Display Engine and Timing Controller?</em></p>
<p>To render graphics on PinePhone‚Äôs LCD Display, our Display Driver needs to follow these steps‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-sequence-of-steps-for-pinephone-display-driver"><strong>‚ÄúSequence of Steps for PinePhone Display Driver‚Äù</strong></a></li>
</ul>
<p><em>How shall we build the PinePhone Display Driver?</em></p>
<p>We‚Äôll create the PinePhone Display Driver based on the <strong>NuttX Driver for Sitronix ST7789</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/nuttx/blob/master/drivers/lcd/st7789.c"><strong>nuttx/drivers/lcd/st7789.c</strong></a></li>
</ul>
<p>That‚Äôs because ST7789 is somewhat similar to PinePhone‚Äôs ST7703 LCD Controller.</p>
<p><em>But ST7789 doesn‚Äôt support Framebuffers?</em></p>
<p>Yeah for PinePhone we‚Äôll wrap the A64 DMA Framebuffers with this interface for <strong>NuttX Framebuffers</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/master/include/nuttx/video/fb.h"><strong>nuttx/include/nuttx/video/fb.h</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/master/drivers/video/fb.c"><strong>nuttx/drivers/video/fb.c</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx/blob/master/drivers/lcd/lcd_framebuffer.c"><strong>nuttx/drivers/lcd/lcd_framebuffer.c</strong></a></p>
</li>
</ul>
<p>And we might get inspired by this implementation of <strong>Display Overlays</strong> in the STM32 LCD TFT Display Controller (LTDC)‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/nuttx/blob/master/arch/arm/src/stm32/stm32_ltdc.c"><strong>nuttx/arch/arm/src/stm32/stm32_ltdc.c</strong></a></li>
</ul>
<p>We have started the <strong>Zig Implementation</strong> of the NuttX Driver (for MIPI Display Serial Interface)‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi2"><strong>‚ÄúNuttX RTOS for PinePhone: Display Driver in Zig‚Äù</strong></a></li>
</ul>
<p>We‚Äôll add the A64 Display Engine in the next article!</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/de2"><strong>‚ÄúNuttX RTOS for PinePhone: Render Graphics in Zig‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/de-test.jpg" alt="Testing the A64 Display Engine on PinePhone" /></p>
<h1 id="whats-next"><a href="#whats-next">11 What‚Äôs Next</a></h1>
<p>I hope we learnt lots today about <strong>Display Rendering on PinePhone</strong>‚Ä¶</p>
<ul>
<li>
<p>What‚Äôs the <a href="https://lupyuen.github.io/articles/de#display-rendering-on-pinephone"><strong>Display Engine (DE)</strong></a> inside PinePhone</p>
</li>
<li>
<p>How the <a href="https://lupyuen.github.io/articles/pio#lcd-controller-tcon0"><strong>Timing Controller (TCON0)</strong></a> controls PinePhone‚Äôs LCD Display</p>
</li>
<li>
<p>How we call DE and TCON0 to <a href="https://lupyuen.github.io/articles/de#render-colours"><strong>render graphics</strong></a></p>
</li>
<li>
<p>How our new <a href="https://lupyuen.github.io/articles/de#nuttx-display-driver-for-pinephone"><strong>PinePhone Display Driver</strong></a> will support DE and TCON0</p>
</li>
</ul>
<p>Please join me in the next article as we create the PinePhone Display Engine Driver for <a href="https://lupyuen.github.io/articles/uboot"><strong>Apache NuttX RTOS</strong></a>!</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/de2"><strong>‚ÄúNuttX RTOS for PinePhone: Render Graphics in Zig‚Äù</strong></a></li>
</ul>
<p>Check out the other articles on <strong>NuttX RTOS for PinePhone</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/arm"><strong>‚ÄúApache NuttX RTOS on Arm Cortex-A53: How it might run on PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/uboot"><strong>‚ÄúPinePhone boots Apache NuttX RTOS‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/interrupt"><strong>‚ÄúNuttX RTOS for PinePhone: Fixing the Interrupts‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/serial"><strong>‚ÄúNuttX RTOS for PinePhone: UART Driver‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pio"><strong>‚ÄúNuttX RTOS for PinePhone: Blinking the LEDs‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi"><strong>‚ÄúUnderstanding PinePhone‚Äôs Display (MIPI DSI)‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi2"><strong>‚ÄúNuttX RTOS for PinePhone: Display Driver in Zig‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de2"><strong>‚ÄúNuttX RTOS for PinePhone: Render Graphics in Zig‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi3"><strong>‚ÄúNuttX RTOS for PinePhone: MIPI Display Serial Interface‚Äù</strong></a></p>
</li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/PINE64official/comments/ygz5kt/rendering_pinephones_display_de_and_tcon0/"><strong>Discuss this article on Reddit</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>My Current Project: ‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>My Other Project: ‚ÄúThe RISC-V BL602 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/de.md"><strong>lupyuen.github.io/src/de.md</strong></a></p>
<p><img src="https://lupyuen.github.io/images/de-block1a.jpg" alt="Display Engine (DE) and Timing Controller (TCON0) from A64 User Manual (Page 498)" /></p>
<p><a href="https://dl.linux-sunxi.org/A64/A64_Datasheet_V1.1.pdf"><em>Display Engine (DE) and Timing Controller (TCON0) from A64 User Manual (Page 498)</em></a></p>
<h1 id="appendix-overview-of-allwinner-a64-display-engine"><a href="#appendix-overview-of-allwinner-a64-display-engine">12 Appendix: Overview of Allwinner A64 Display Engine</a></h1>
<p>The official doc for the <strong>Allwinner A64 Display Engine</strong> is here‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf"><strong>Allwinner Display Engine 2.0 Specifications</strong></a></li>
</ul>
<p>PinePhone‚Äôs A64 Display Engine is hidden under <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf"><strong>Allwinner H3 (page 22)</strong></a>, because Allwinner A64 is actually a H3 upgraded with <a href="https://linux-sunxi.org/A64"><strong>64-bit Arm Cores</strong></a>.</p>
<p>(Also check out this <a href="https://linux-sunxi.org/DE2_Register_Guide"><strong>DE2 Register Guide</strong></a>)</p>
<p>Earlier we said that Allwinner A64‚Äôs Display Engine is a <strong>Real-Time Mixer</strong> that handles real-time <strong>DMA, Overlay, Scaling and Blending</strong> of the Framebuffers‚Ä¶</p>
<p>And the Display Engine pushes the output pixels to the <a href="https://lupyuen.github.io/articles/pio#lcd-controller-tcon0"><strong>Timing Controller (TCON0)</strong></a> for display on PinePhone‚Äôs LCD Display‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/de#display-rendering-on-pinephone"><strong>‚ÄúDisplay Rendering on PinePhone‚Äù</strong></a></li>
</ul>
<p>According to the doc, the <strong>Display Engine Base Address</strong> is <strong><code>0x0100</code> <code>0000</code></strong> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24)</a></p>
<p><em>What‚Äôs a Display Engine Mixer?</em></p>
<p><strong>DE RT-MIXER:</strong> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 87)</a></p>
<blockquote>
<p>‚ÄúThe RT-mixer Core consist of dma, overlay, scaler and blender block. It supports 4 layers overlay in one pipe, and its result can scaler up or down to blender in the next processing.‚Äù</p>
</blockquote>
<p>The Display Engine has 2 Mixers: RT-MIXER0 and RT-MIXER1.</p>
<p><strong>DE RT-MIXER0</strong> has 4 Channels (DE Offset <strong><code>0x10</code> <code>0000</code></strong>, <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">DE Page 87</a>)</p>
<ul>
<li>
<p><strong>Channel 0</strong> for Video</p>
<p>(DMA0, Video Overlay, Video Scaler)</p>
</li>
<li>
<p><strong>Channels 1, 2 and 3</strong> for UI</p>
<p>(DMA1 / 2 / 3, 3 x UI Overlays, 3 x UI Scalers, 3 x UI Blenders)</p>
</li>
<li>
<p><strong>4 Overlay Layers</strong> per Channel</p>
<p>(We only use 1 Overlay Layer per Channel)</p>
</li>
<li>
<p><strong>Layer Priority</strong> is Layer 3 &gt; Layer2 &gt; Layer 1 &gt; Layer 0 <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 89)</a></p>
</li>
</ul>
<p>Our Display Engine Demo <strong>configures the 4 Channels</strong> as follows‚Ä¶</p>
<ul>
<li>
<p><strong>Channel 0</strong> is unused</p>
<p>(No video right now)</p>
</li>
<li>
<p><strong>Channel 1</strong> has Pixel Format XRGB 8888</p>
<p>(Alpha Channel is disabled)</p>
</li>
<li>
<p><strong>Channels 2 and 3</strong> have Pixel Format ARGB 8888</p>
<p>(Alpha Channel is enabled)</p>
</li>
</ul>
<p><strong>Hardware Registers</strong> for RT-MIXER0 <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 90)</a>‚Ä¶</p>
<div><table><thead><tr><th>Hardware Register</th><th>RT-MIXER0 Offset</th></tr></thead><tbody>
<tr><td><strong>GLB</strong> (Global Registers)</td><td><strong><code>0x00</code> <code>0000</code></strong></td></tr>
<tr><td><strong>BLD</strong> (Blender)</td><td><strong><code>0x00</code> <code>1000</code></strong></td></tr>
<tr><td><strong>OVL_V(CH0)</strong> (Video Overlay / Channel 0)</td><td><strong><code>0x00</code> <code>2000</code></strong></td></tr>
<tr><td><strong>OVL_UI(CH1)</strong> (UI Overlay / Channel 1)</td><td><strong><code>0x00</code> <code>3000</code></strong></td></tr>
<tr><td><strong>OVL_UI(CH2)</strong> (UI Overlay / Channel 2)</td><td><strong><code>0x00</code> <code>4000</code></strong></td></tr>
<tr><td><strong>OVL_UI(CH3)</strong> (UI Overlay / Channel 3)</td><td><strong><code>0x00</code> <code>5000</code></strong></td></tr>
<tr><td><strong>VIDEO_SCALER(CH0)</strong> (Video Scaler / Channel 0)</td><td><strong><code>0x02</code> <code>0000</code></strong></td></tr>
<tr><td><strong>UI_SCALER1(CH1)</strong> (UI Scaler / Channel 1)</td><td><strong><code>0x04</code> <code>0000</code></strong></td></tr>
<tr><td><strong>UI_SCALER2(CH2)</strong> (UI Scaler / Channel 2)</td><td><strong><code> 0x05</code> <code>0000</code></strong></td></tr>
<tr><td><strong>UI_SCALER3(CH3)</strong> (UI Scaler / Channel 3)</td><td><strong><code> 0x06</code> <code>0000</code></strong></td></tr>
<tr><td><strong>POST_PROC1</strong> (Post Processor 1)</td><td><strong><code>0x0A</code> <code>0000</code></strong></td></tr>
<tr><td><strong>POST_PROC2</strong> (Post Processor 2)</td><td><strong><code>0x0B</code> <code>0000</code></strong></td></tr>
<tr><td><strong>DMA</strong> (Direct Memory Access)</td><td><strong><code>0x0C</code> <code>0000</code></strong></td></tr>
</tbody></table>
</div>
<p>The pic below shows how DE RT-MIXER0 mixes together <strong>3 UI Channels (Framebuffers)</strong> via DMA1, 2 and 3 (plus a Video Channel on DMA0)‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/de-mixer1a.jpg" alt="Real-Time Mixer in A64 Display Engine (Page 22)" /></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf"><em>Real-Time Mixer in A64 Display Engine (Page 22)</em></a></p>
<p><strong>DE RT-MIXER1</strong> has 2 Channels (DE Offset <strong><code>0x20</code> <code>0000</code></strong>, <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">DE Page 23</a>)</p>
<ul>
<li>
<p><strong>Channel 0</strong> for Video </p>
<p>(DMA0, Video Overlay, Video Scaler)</p>
</li>
<li>
<p><strong>Channel 1</strong> for UI </p>
<p>(DMA1, UI Overlay, UI Scaler, UI Blender)</p>
</li>
</ul>
<p>(We don‚Äôt use RT-MIXER1 right now)</p>
<p>RT-MIXER0 and RT-MIXER1 are multiplexed to <strong>Timing Controller TCON0</strong>. <a href="https://lupyuen.github.io/images/de-block1a.jpg">(Like this)</a></p>
<p>TCON0 is connected to PinePhone‚Äôs <strong>ST7703 LCD Controller</strong> over MIPI Display Serial Interface. <a href="https://lupyuen.github.io/articles/dsi">(See this)</a></p>
<p>Hence RT-MIXER0 <strong>mixes 1 Video Channel with 3 UI Channels</strong> over DMA. And pumps the pixels continuously to ST7703 LCD Controller. (Via the Timing Controller TCON0)</p>
<p>In today‚Äôs demo we used the 3 UI Channels to render (pic below)‚Ä¶</p>
<ol>
<li>Mandelbrot Set</li>
<li>Blue Square</li>
<li>Green Circle</li>
</ol>
<p>In the following chapters we explain how the 3 UI Channels were initialised and rendered by setting the Hardware Registers for A64 Display Engine‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/de#appendix-initialising-the-allwinner-a64-display-engine"><strong>‚ÄúInitialising the Allwinner A64 Display Engine‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de#appendix-programming-the-allwinner-a64-display-engine"><strong>‚ÄúProgramming the Allwinner A64 Display Engine‚Äù</strong></a></p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/de-overlay.jpg" alt="Mandelbrot Set with Blue Square and Green Circle as Overlays" /></p>
<p><a href="https://lupyuen.github.io/articles/de#test-pinephone-display-engine"><em>Mandelbrot Set with Blue Square and Green Circle as Overlays</em></a></p>
<p>We won‚Äôt use these Display Engine Features today‚Ä¶</p>
<p><strong>DE RT-WB (Write-Back Controller):</strong> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 116)</a></p>
<blockquote>
<p>‚ÄúThe Real-time write-back controller (RT-WB) provides data capture function for display engine. It captures data from RT-mixer module, performs the image resizing function, and then write-back to SDRAM.‚Äù</p>
</blockquote>
<p>(For screen capture?)</p>
<p><strong>DE VSU (Video Scaler):</strong> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 128)</a></p>
<blockquote>
<p>‚ÄúThe Video Scaler (VS) provides YUV format image resizing function for display engine. It receives data from overlay module, performs the image resizing function, and outputs to video post-processing modules.‚Äù</p>
</blockquote>
<p><strong>DE Rotation:</strong> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 137)</a></p>
<blockquote>
<p>‚ÄúThere are several types of rotation: clockwise 0/90/180/270 degree Rotation and H-Flip/V-Flip. Operation of Copy is the same as a 0 degree rotation.‚Äù</p>
</blockquote>
<p>Nope to these too‚Ä¶</p>
<ul>
<li>Fresh and Contrast Enhancement (FCE)</li>
<li>Black and White Stetch (BWS)</li>
<li>Luminance Transient Improvement (LTI)</li>
<li>Luma Peaking (PEAKING)</li>
<li>Adaptive Saturation Enhancement (ASE)</li>
<li>Fancy Color Curvature Change (FCC)</li>
<li>Dynamic Range Controller (DRC)</li>
</ul>
<h1 id="appendix-initialising-the-allwinner-a64-display-engine"><a href="#appendix-initialising-the-allwinner-a64-display-engine">13 Appendix: Initialising the Allwinner A64 Display Engine</a></h1>
<p><em>How do we initialise PinePhone‚Äôs Allwinner A64 Display Engine at startup?</em></p>
<p>As deciphered from the following logs‚Ä¶</p>
<ul>
<li>
<p><a href="https://gist.github.com/lupyuen/c12f64cf03d3a81e9c69f9fef49d9b70#de2_init"><strong><code>de2_init</code> Log</strong></a> </p>
<p>(Captured from <a href="https://megous.com/git/p-boot/tree/src/display.c#n1871"><strong>p-boot <code>de2_init</code></strong></a>)</p>
</li>
<li>
<p><a href="https://gist.github.com/lupyuen/c12f64cf03d3a81e9c69f9fef49d9b70#clock_set_pll_de"><strong><code>clock_set_pll_de</code> Log</strong></a></p>
<p>(Captured from <a href="https://megous.com/git/p-boot/tree/src/uboot/arch/arm/mach-sunxi/clock_sun6i.c#n260"><strong>p-boot <code>clock_set_pll_de</code></strong></a>)</p>
</li>
</ul>
<p>Below are the steps to <strong>initialise the Allwinner A64 Display Engine</strong> at startup‚Ä¶</p>
<ol>
<li>
<p>Set <strong>High Speed SRAM</strong> to DMA Mode</p>
<ul>
<li>
<p>Set <strong>BIST_DMA_CTRL_SEL</strong> to <strong>0</strong> for DMA <a href="https://developer.arm.com/documentation/dui0489/c/arm-and-thumb-instructions/miscellaneous-instructions/dmb--dsb--and-isb"><strong>(DMB)</strong></a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 191, <code>0x1C0</code> <code>0004</code>)</a></p>
</li>
<li>
<p><strong>BIST_DMA_CTRL_SEL</strong> (Bist and DMA Control Select) is <strong>Bit 0</strong> of SRAM_CTRL_REG1</p>
</li>
<li>
<p><strong>SRAM_CTRL_REG1</strong> (SRAM Control Register 1) is at SRAM Registers Offset <strong><code>0x4</code></strong></p>
</li>
<li>
<p><strong>SRAM Registers</strong> Base Address is <strong><code>0x01C0</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 191)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Set SRAM for video use
  0x1c0 0004 = 0x0 (DMB)</code></pre></div></li>
<li>
<p>Set <strong>Display Engine PLL</strong> to 297 MHz</p>
<ul>
<li>
<p>Set <strong>PLL_DE_CTRL_REG</strong> to <strong><code>0x8100</code> <code>1701</code></strong> <a href="https://developer.arm.com/documentation/dui0489/c/arm-and-thumb-instructions/miscellaneous-instructions/dmb--dsb--and-isb"><strong>(DMB)</strong></a></p>
<p><strong>PLL_ENABLE</strong> (Bit 31) = 1 (Enable PLL)</p>
<p><strong>PLL_MODE_SEL</strong> (Bit 24) = 1 (Integer Mode)</p>
<p><strong>PLL_FACTOR_N</strong> (Bits 8 to 14) = 23 (N = 24)</p>
<p><strong>PLL_PRE_DIV_M</strong> (Bits 0 to 3) = 1 (M = 2)</p>
<p>Actual PLL Output = 24 MHz * N / M = 288 MHz</p>
<p>(Slighltly below 297 MHz due to truncation)</p>
</li>
<li>
<p><strong>PLL_DE_CTRL_REG</strong> (PLL Display Engine Control Register) is at CCU Offset <strong><code>0x0048</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 96, <code>0x1C2</code> <code>0048</code>)</a></p>
</li>
<li>
<p><strong>CCU</strong> (Clock Control Unit) Base Address is <strong><code>0x01C2</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 81)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Setup DE2 PLL
  clock_set_pll_de: clk=297000000
  PLL10 rate = 24000000 * n / m
  0x1c2 0048 = 0x8100 1701 (DMB)</code></pre></div></li>
<li>
<p>Wait for <strong>Display Engine PLL</strong> to be stable</p>
<ul>
<li>
<p>Poll <strong>PLL_DE_CTRL_REG</strong> (from above) until <strong>LOCK</strong> (Bit 28) is 1</p>
<p>(PLL is Locked and Stable)</p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Setup DE2 PLL
  while (!(readl(0x1c2 0048) &amp; 0x1000 0000))</code></pre></div></li>
<li>
<p>Set <strong>Special Clock</strong> to Display Engine PLL</p>
<ul>
<li>
<p>Clear <strong>DE_CLK_REG</strong> bits <strong><code>0x0300</code> <code>0000</code></strong></p>
<p>Set <strong>DE_CLK_REG</strong>   bits <strong><code>0x8100</code> <code>0000</code></strong></p>
<p><strong>SCLK_GATING</strong> (Bit 31) = 1 (Enable Special Clock)</p>
<p><strong>CLK_SRC_SEL</strong> (Bits 24 to 26) = 1 (Clock Source is Display Engine PLL)</p>
</li>
<li>
<p><strong>DE_CLK_REG</strong> (Display Engine Clock Register) is at CCU Offset <strong><code>0x0104</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 117, <code>0x1C2</code> <code>0104</code>)</a></p>
</li>
<li>
<p><strong>CCU</strong> (Clock Control Unit) Base Address is <strong><code>0x01C2</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 81)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Enable DE2 special clock
  clrsetbits 0x1c2 0104, 0x300 0000, 0x8100 0000</code></pre></div></li>
<li>
<p>Enable <strong>AHB (AMBA High-speed Bus)</strong> for Display Engine: De-Assert Display Engine</p>
<ul>
<li>
<p>Set <strong>BUS_SOFT_RST_REG1</strong> bits <strong><code>0x1000</code></strong></p>
<p><strong>DE_RST</strong> (Bit 12) = 1 (De-Assert Display Engine)</p>
</li>
<li>
<p><strong>BUS_SOFT_RST_REG1</strong> (Bus Software Reset Register 1) is at CCU Offset <code>0x02C4</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 140, <code>0x1C2</code> <code>02C4</code>)</a></p>
</li>
<li>
<p><strong>CCU</strong> (Clock Control Unit) Base Address is <strong><code>0x01C2</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 81)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Enable DE2 ahb
  setbits 0x1c2 02c4, 0x1000</code></pre></div></li>
<li>
<p>Enable <strong>AHB (AMBA High-speed Bus)</strong> for Display Engine: Pass Display Engine</p>
<ul>
<li>
<p>Set <strong>BUS_CLK_GATING_REG1</strong> bits <strong><code>0x1000</code></strong></p>
<p><strong>DE_GATING</strong> (Bit 12) = 1 (Pass Display Engine)</p>
</li>
<li>
<p><strong>BUS_CLK_GATING_REG1</strong> (Bus Clock Gating Register 1) is at CCU Offset <strong><code>0x0064</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 102, <code>0x1C2</code> <code>0064</code>)</a></p>
</li>
<li>
<p><strong>CCU</strong> (Clock Control Unit) Base Address is <strong><code>0x01C2</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 81)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Enable DE2 ahb
  setbits 0x1c2 0064, 0x1000</code></pre></div></li>
<li>
<p>Enable <strong>Clock for MIXER0</strong>: SCLK Clock Pass</p>
<ul>
<li>
<p>Set <strong>SCLK_GATE</strong> bits <strong><code>0x1</code></strong></p>
<p><strong>CORE0_SCLK_GATE</strong> (Bit 0) = 1 (Clock Pass)</p>
</li>
<li>
<p><strong>SCLK_GATE</strong> is at DE Offset <strong><code>0x000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 25, <code>0x100</code> <code>0000</code>)</a></p>
</li>
<li>
<p><strong>Display Engine (DE)</strong> Base Address is <strong><code>0x0100</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Enable clock for mixer 0, set route MIXER0-&gt;TCON0
  setbits 0x100 0000, 0x1</code></pre></div></li>
<li>
<p>Enable <strong>Clock for MIXER0</strong>: HCLK Clock Reset Off</p>
<ul>
<li>
<p>Set <strong>AHB_RESET</strong> bits <strong><code>0x1</code></strong></p>
<p><strong>CORE0_HCLK_RESET</strong> (Bit 0) = 1 (Reset Off)</p>
</li>
<li>
<p><strong>AHB_RESET</strong> is at DE Offset <strong><code>0x008</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 25, <code>0x100</code> <code>0008</code>)</a></p>
</li>
<li>
<p><strong>Display Engine (DE)</strong> Base Address is <strong><code>0x0100</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Enable clock for mixer 0, set route MIXER0-&gt;TCON0
  setbits 0x100 0008, 0x1</code></pre></div></li>
<li>
<p>Enable <strong>Clock for MIXER0</strong>: HCLK Clock Pass</p>
<ul>
<li>
<p>Set <strong>HCLK_GATE</strong> bits <strong><code>0x1</code></strong></p>
<p><strong>CORE0_HCLK_GATE</strong> (Bit 0) = 1 (Clock Pass)</p>
</li>
<li>
<p><strong>HCLK_GATE</strong> is at DE Offset <strong><code>0x004</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 25, <code>0x100</code> <code>0004</code>)</a></p>
</li>
<li>
<p><strong>Display Engine (DE)</strong> Base Address is <strong><code>0x0100</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Enable clock for mixer 0, set route MIXER0-&gt;TCON0
  setbits 0x100 0004, 0x1</code></pre></div></li>
<li>
<p>Route <strong>MIXER0 to TCON0</strong></p>
<ul>
<li>
<p>Clear <strong>DE2TCON_MUX</strong> bits <strong><code>0x1</code></strong></p>
<p><strong>DE2TCON_MUX</strong> (Bit 0) = 0</p>
<p>(Route MIXER0 to TCON0; Route MIXER1 to TCON1)</p>
</li>
<li>
<p><strong>DE2TCON_MUX</strong> is at DE Offset <strong><code>0x010</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 26, <code>0x100</code> <code>0010</code>)</a></p>
</li>
<li>
<p><strong>Display Engine (DE)</strong> Base Address is <strong><code>0x0100</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Enable clock for mixer 0, set route MIXER0-&gt;TCON0
  clrbits 0x100 0010, 0x1</code></pre></div></li>
<li>
<p>Clear <strong>MIXER0 Registers</strong>: Global Registers (GLB), Blender (BLD), Video Overlay (OVL_V), UI Overlay (OVL_UI)</p>
<ul>
<li>
<p>Set <strong>MIXER0</strong> Offsets <strong><code>0x0000</code></strong> - <strong><code>0x5FFF</code></strong> to 0</p>
<p>Which covers‚Ä¶</p>
<p><strong>GLB</strong> (Global Regisers) at MIXER0 Offset <strong><code>0x0000</code></strong></p>
<p><strong>BLD</strong> (Blender) at MIXER0 Offset <strong><code>0x1000</code></strong></p>
<p><strong>OVL_V(CH0)</strong> (Video Overlay) at MIXER0 Offset <strong><code>0x2000</code></strong></p>
<p><strong>OVL_UI(CH1)</strong> (UI Overlay 1) at MIXER0 Offset <strong><code>0x3000</code></strong></p>
<p><strong>OVL_UI(CH2)</strong> (UI Overlay 2) at MIXER0 Offset <strong><code>0x4000</code></strong></p>
<p><strong>OVL_UI(CH3)</strong> (UI Overlay 3) at MIXER0 Offset <strong><code>0x5000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 90, <code>0x110</code> <code>0000</code> - <code>0x110</code> <code>5FFF</code>)</a></p>
</li>
<li>
<p><strong>MIXER0</strong> is at DE Offset <strong><code>0x0010</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24)</a></p>
</li>
<li>
<p><strong>Display Engine (DE)</strong> Base Address is <strong><code>0x0100</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Clear all registers
  0x110 0000 to 0x110 5fff = 0x0</code></pre></div></li>
<li>
<p>Disable <strong>MIXER0 Modules</strong>‚Ä¶</p>
<ul>
<li>Video Scaler (VSU)</li>
<li>UI Scaler (UIS)</li>
<li>Fresh and Contrast Enhancement (FCE)</li>
<li>Black and White Stetch (BWS)</li>
<li>Luminance Transient Improvement (LTI)</li>
<li>Luma Peaking (PEAKING)</li>
<li>Adaptive Saturation Enhancement (ASE)</li>
<li>Fancy Color Curvature Change (FCC)</li>
<li>Dynamic Range Controller (DRC)</li>
</ul>
<p>Set to <strong><code>0</code></strong> the following registers‚Ä¶</p>
<ul>
<li>
<p><strong>VS_CTRL_REG</strong> at VIDEO_SCALER(CH0) Offset 0</p>
<p>EN (Bit 0) = 0 (Disable Video Scaler)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 130, <code>0x112</code> <code>0000</code>)</a></p>
</li>
<li>
<p>TODO: <strong><code>0x113</code> <code>0000</code></strong> is Undocumented</p>
<p>(Is there a mixup with UI_SCALER3?)</p>
</li>
<li>
<p><strong>UIS_CTRL_REG</strong> at UI_SCALER1(CH1) Offset 0</p>
<p>EN (Bit 0) = 0 (Disable UI Scaler) </p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 66, <code>0x114</code> <code>0000</code>)</a></p>
</li>
<li>
<p><strong>UIS_CTRL_REG</strong> at UI_SCALER2(CH2) Offset 0</p>
<p>EN (Bit 0) = 0 (Disable UI Scaler)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 66, <code>0x115</code> <code>0000</code>)</a></p>
</li>
<li>
<p>TODO: Missing <strong>UI_SCALER3(CH3)</strong> at MIXER0 Offset <code>0x06</code> <code>0000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 90, <code>0x116</code> <code>0000</code>)</a></p>
<p>(Is there a mixup with <code>0x113</code> <code>0000</code> above?)</p>
</li>
<li>
<p><strong>GCTRL_REG(FCE)</strong> at FCE Offset 0</p>
<p>EN (Bit 0) = 0 (Disable FCE)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 62, <code>0x11A</code> <code>0000</code>)</a></p>
</li>
<li>
<p><strong>GCTRL_REG(BWS)</strong> at BWS Offset 0</p>
<p>EN (Bit 0) = 0 (Disable BWS)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 42, <code>0x11A</code> <code>2000</code>)</a></p>
</li>
<li>
<p><strong>LTI_CTL</strong> at LTI Offset 0</p>
<p>LTI_EN (Bit 0) = 0 (Close LTI)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 72, <code>0x11A</code> <code>4000</code>)</a></p>
</li>
<li>
<p><strong>LP_CTRL_REG</strong> at PEAKING Offset 0</p>
<p>EN (Bit 0) = 0 (Disable PEAKING)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 80, <code>0x11A</code> <code>6000</code>)</a></p>
</li>
<li>
<p><strong>ASE_CTL_REG</strong> at ASE Offset 0</p>
<p>ASE_EN (Bit 0) = 0 (Disable ASE)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 40, <code>0x11A</code> <code>8000</code>)</a></p>
</li>
<li>
<p><strong>FCC_CTL_REG</strong> at FCC Offset 0</p>
<p>Enable (Bit 0) = 0 (Disable FCC)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 56, <code>0x11A</code> <code>A000</code>)</a></p>
</li>
<li>
<p><strong>GNECTL_REG</strong> at DRC Offset 0</p>
<p>BIST_EN (Bit 0) = 0 (Disable BIST)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 49, <code>0x11B</code> <code>0000</code>)</a></p>
</li>
</ul>
<p>Offsets of the above registers‚Ä¶</p>
<ul>
<li>
<p><strong>VIDEO_SCALER(CH0)</strong> is at MIXER0 Offset <code>0x02</code> <code>0000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 90, <code>0x112</code> <code>0000</code>)</a></p>
</li>
<li>
<p><strong>UI_SCALER1(CH1)</strong> is at MIXER0 Offset <code>0x04</code> <code>0000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 90, <code>0x114</code> <code>0000</code>)</a></p>
</li>
<li>
<p><strong>UI_SCALER2(CH2)</strong> is at MIXER0 Offset <code>0x05</code> <code>0000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 90, <code>0x115</code> <code>0000</code>)</a></p>
</li>
<li>
<p><strong>FCE</strong> is at MIXER0 Offset <code>0x0A</code> <code>0000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 61, <code>0x11A</code> <code>0000</code>)</a></p>
</li>
<li>
<p><strong>BWS</strong> is at MIXER0 Offset <code>0x0A</code> <code>2000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 42, <code>0x11A</code> <code>2000</code>)</a></p>
</li>
<li>
<p><strong>LTI</strong> is at MIXER0 Offset <code>0x0A</code> <code>4000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 71, <code>0x11A</code> <code>4000</code>)</a></p>
</li>
<li>
<p><strong>PEAKING</strong> is at MIXER0 Offset <code>0x0A</code> <code>6000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 80, <code>0x11A</code> <code>6000</code>)</a></p>
</li>
<li>
<p><strong>ASE</strong> is at MIXER0 Offset <code>0x0A</code> <code>8000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 40, <code>0x11A</code> <code>8000</code>)</a></p>
</li>
<li>
<p><strong>FCC</strong> is at MIXER0 Offset <code>0x0A</code> <code>A000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 56, <code>0x11A</code> <code>A000</code>)</a></p>
</li>
<li>
<p><strong>DRC</strong> is at Address <code>0x011B</code> <code>0000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 48, <code>0x11B</code> <code>0000</code>)</a></p>
</li>
<li>
<p><strong>MIXER0</strong> is at DE Offset <strong><code>0x0010</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24)</a></p>
</li>
<li>
<p><strong>Display Engine (DE)</strong> Base Address is <strong><code>0x0100</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Clear all registers
  0x112 0000 = 0x0
  0x113 0000 = 0x0
  0x114 0000 = 0x0
  0x115 0000 = 0x0
  0x11a 0000 = 0x0
  0x11a 2000 = 0x0
  0x11a 4000 = 0x0
  0x11a 6000 = 0x0
  0x11a 8000 = 0x0
  0x11a a000 = 0x0
  0x11b 0000 = 0x0</code></pre></div></li>
<li>
<p>Enable <strong>MIXER0</strong></p>
<ul>
<li>
<p>Set <strong>GLB_CTL</strong> to 1 <a href="https://developer.arm.com/documentation/dui0489/c/arm-and-thumb-instructions/miscellaneous-instructions/dmb--dsb--and-isb"><strong>(DMB)</strong></a></p>
<p>EN (Bit 0) = 1 (Enable Mixer)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 92)</a></p>
</li>
<li>
<p><strong>GLB_CTL</strong> is at MIXER0 Offset 0</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 90, <code>0x110</code> <code>0000</code>)</a></p>
</li>
<li>
<p><strong>MIXER0</strong> is at DE Offset <strong><code>0x0010</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24, <code>0x110</code> <code>0000</code>)</a></p>
</li>
<li>
<p><strong>Display Engine (DE)</strong> Base Address is <strong><code>0x0100</code> <code>0000</code></strong></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Enable mixer
  0x110 0000 = 0x1 (DMB)</code></pre></div></li>
</ol>
<p>We have <strong>implemented in Zig</strong> the above A64 Display Engine Initialisation‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/render.zig"><strong>pinephone-nuttx/render.zig</strong></a></p>
</li>
<li>
<p><a href="https://gist.github.com/lupyuen/2df0f8c016dae54f4e4210866a7cd118"><strong>Output Log for render.zig</strong></a></p>
</li>
</ul>
<p>We have converted the above Zig Driver to C and added to NuttX Kernel‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/de3"><strong>‚ÄúNuttX RTOS for PinePhone: Display Engine‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/de-run.png" alt="Running p-boot Display Code on Apache NuttX RTOS with logging" /></p>
<p><a href="https://lupyuen.github.io/articles/de#p-boot-display-code"><em>Running p-boot Display Code on Apache NuttX RTOS with logging</em></a></p>
<h1 id="appendix-programming-the-allwinner-a64-display-engine"><a href="#appendix-programming-the-allwinner-a64-display-engine">14 Appendix: Programming the Allwinner A64 Display Engine</a></h1>
<p>We‚Äôve seen the <strong>Hardware Registers</strong> for the Allwinner A64 Display Engine‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/de#appendix-overview-of-allwinner-a64-display-engine"><strong>‚ÄúOverview of Allwinner A64 Display Engine‚Äù</strong></a></li>
</ul>
<p>And we need to program the Hardware Registers to create the <strong>NuttX Display Driver</strong> for PinePhone‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/de#nuttx-display-driver-for-pinephone"><strong>‚ÄúNuttX Display Driver for PinePhone‚Äù</strong></a></li>
</ul>
<p><em>How will we program the Hardware Registers to render the UI Channels?</em></p>
<p>To find out how <a href="https://megous.com/git/p-boot/tree/src/display.c#n2017"><strong><code>display_commit</code></strong></a> updates the Hardware Registers (while rendering the UI Channels), we modded the p-boot Display Code to <strong>log all Register Writes</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/pboot6/p-boot.6.zip"><strong>Modified p-boot Display Code</strong></a></li>
</ul>
<p>Which produces a log that tells us all the <strong>Hardware Registers and their values</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx#testing-p-boot-display-engine-on-pinephone"><strong>‚ÄúTesting p-boot Display Engine on PinePhone‚Äù</strong></a></li>
</ul>
<p>After studying the log, we have identified the steps to render the 3 UI Channels with the Display Engine.</p>
<p>This is how we‚Äôll create a NuttX Driver for PinePhone‚Äôs A64 Display Engine that implements Display Rendering‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(Refer to <strong>Memory Mapping List</strong> and <strong>Register List</strong> at DE Page 90)</a></p>
<ol>
<li>
<p>Set <strong>Blender Background and Pre-Multiply‚Ä¶</strong></p>
<ul>
<li>
<p><strong>BLD_BK_COLOR</strong> (Blender Background Color) at BLD Offset <code>0x88</code></p>
<p>Set to <code>0xFF00</code> <code>0000</code> (Black Background Color)</p>
<p>RESERVED (Bits 24 to 31) = 0xFF (Undocumented)</p>
<p>RED (Bits 16 to 23) = 0</p>
<p>GREEN (Bits 8 to 15) = 0</p>
<p>BLUE (Bits 0 to 7) = 0</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 109, <code>0x110</code> <code>1088</code>)</a></p>
</li>
<li>
<p><strong>BLD_PREMUL_CTL</strong> (Blender Pre-Multiply Control) at BLD Offset <code>0x84</code></p>
<p>Set to 0 (No Pre-Multiply for Alpha, Pipes 0 to 3)</p>
<p>P3_ALPHA_MODE (Bit 3) = 0 (Pipe 3: No Pre-Multiply)</p>
<p>P2_ALPHA_MODE (Bit 2) = 0 (Pipe 2: No Pre-Multiply)</p>
<p>P1_ALPHA_MODE (Bit 1) = 0 (Pipe 1: No Pre-Multiply)</p>
<p>P0_ALPHA_MODE (Bit 0) = 0 (Pipe 0: No Pre-Multiply)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 109, <code>0x110</code> <code>1084</code>)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Configure Blender
BLD BkColor:     0x110 1088 = 0xff00 0000
BLD Premultiply: 0x110 1084 = 0x0</code></pre></div></li>
<li>
<p><strong>For Channels 1 to 3‚Ä¶</strong></p>
<ol>
<li>
<p><strong>If Channel is unused,</strong> disable Overlay, Pipe and Scaler. Skip to next Channel</p>
<ul>
<li>
<p><strong>OVL_UI_ATTR_CTL</strong> (UI Overlay Attribute Control) at OVL_UI Offset <code>0x00</code></p>
<p>Set to 0 (Disable UI Overlay Channel)</p>
<p>LAY_EN (Bit 0) = 0 (Disable Layer)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 102, <code>0x110</code> <code>3000</code> / <code>0x110</code> <code>4000</code> / <code>0x110</code> <code>5000</code>)</a></p>
</li>
<li>
<p><strong>UIS_CTRL_REG</strong> at Offset 0 of UI_SCALER1(CH1) or UI_SCALER2(CH2) or UI_SCALER3(CH3)</p>
<p>Set to 0 (Disable UI Scaler)</p>
<p>EN (Bit 0) = 0 (Disable UI Scaler) </p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 66, <code>0x114</code> <code>0000</code> / <code>0x115</code> <code>0000</code> / <code>0x116</code> <code>0000</code>)</a></p>
</li>
<li>
<p><strong>OVL_UI(CH1)</strong> (UI Overlay 1) is at MIXER0 Offset <code>0x3000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 102, <code>0x110</code> <code>3000</code>)</a></p>
<p><strong>OVL_UI(CH2)</strong> (UI Overlay 2) is at MIXER0 Offset <code>0x4000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 102, <code>0x110</code> <code>4000</code>)</a></p>
<p><strong>OVL_UI(CH3)</strong> (UI Overlay 3) is at MIXER0 Offset <code>0x5000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 102, <code>0x110</code> <code>5000</code>)</a></p>
<p><strong>UI_SCALER1(CH1)</strong> is at MIXER0 Offset <code>0x04</code> <code>0000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 90, <code>0x114</code> <code>0000</code>)</a></p>
<p><strong>UI_SCALER2(CH2)</strong> is at MIXER0 Offset <code>0x05</code> <code>0000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 90, <code>0x115</code> <code>0000</code>)</a></p>
<p><strong>UI_SCALER3(CH3)</strong> is at MIXER0 Offset <code>0x06</code> <code>0000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 90, <code>0x116</code> <code>0000</code>)</a></p>
<p><strong>MIXER0</strong> is at DE Offset <code>0x0010</code> <code>0000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24, <code>0x110</code> <code>0000</code>)</a></p>
<p><strong>Display Engine (DE)</strong> Base Address is <code>0x0100</code> <code>0000</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 24)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Channel 2: Disable Overlay and Pipe
UI Config Attr: 0x110 4000 = 0x0

Channel 3: Disable Overlay and Pipe
UI Config Attr: 0x110 5000 = 0x0

Channel 2: Disable Scaler
Mixer: 0x115 0000 = 0x0

Channel 3: Disable Scaler
Mixer: 0x116 0000 = 0x0</code></pre></div></li>
<li>
<p>Channel 1 has Pixel Format <strong>XRGB 8888</strong>:</p>
<p><strong>OVL_UI_ATTR_CTL ‚Üí LAY_FBFMT</strong> = 4</p>
<p>Channels 2 and 3 have Pixel Format <strong>ARGB 8888</strong>:</p>
<p><strong>OVL_UI_ATTR_CTL ‚Üí LAY_FBFMT</strong> = 0</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 94)</a></p>
</li>
<li>
<p><strong>Set Overlay</strong> (Assume Layer = 0)</p>
<ul>
<li>
<p><strong>OVL_UI_ATTR_CTL</strong> (UI Overlay Attribute Control) at OVL_UI Offset <code>0x00</code></p>
<p><strong>For Channel 1:</strong> Set to <code>0xFF00</code> <code>0405</code></p>
<p><strong>For Channel 2:</strong> Set to <code>0xFF00</code> <code>0005</code></p>
<p><strong>For Channel 3:</strong> Set to <code>0x7F00</code> <code>0005</code></p>
<p>LAY_GLBALPHA (Bits 24 to 31) = <code>0xFF</code> or <code>0x7F</code></p>
<p>(Global Alpha Value is Opaque or Semi-Transparent)</p>
<p>LAY_FBFMT (Bits 8 to 12) = 4 or 0</p>
<p>(Input Data Format is XRGB 8888 or ARGB 8888)</p>
<p>LAY_ALPHA_MODE (Bits 1 to 2) = 2</p>
<p>(Global Alpha is mixed with Pixel Alpha)</p>
<p>(Input Alpha Value = Global Alpha Value * Pixel‚Äôs Alpha Value)</p>
<p>LAY_EN (Bit 0) = 1 (Enable Layer)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 102, <code>0x110</code> <code>3000</code> / <code>0x110</code> <code>4000</code> / <code>0x110</code> <code>5000</code>)</a></p>
</li>
<li>
<p><strong>OVL_UI_TOP_LADD</strong> (UI Overlay Top Field Memory Block Low Address) at OVL_UI Offset <code>0x10</code></p>
<p>Set to Framebuffer Address: <code>fb0</code>, <code>fb1</code> or <code>fb2</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 104, <code>0x110</code> <code>3010</code> / <code>0x110</code> <code>4010</code> / <code>0x110</code> <code>5010</code>)</a></p>
</li>
<li>
<p><strong>OVL_UI_PITCH</strong> (UI Overlay Memory Pitch) at OVL_UI Offset <code>0x0C</code></p>
<p>Set to <code>(width * 4)</code>, number of bytes per row</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 104, <code>0x110</code> <code>300C</code> / <code>0x110</code> <code>400C</code> / <code>0x110</code> <code>500C</code>)</a></p>
</li>
<li>
<p><strong>OVL_UI_MBSIZE</strong> (UI Overlay Memory Block Size) at OVL_UI Offset <code>0x04</code></p>
<p>Set to <code>(height-1) &lt;&lt; 16 + (width-1)</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 104, <code>0x110</code> <code>3004</code> / <code>0x110</code> <code>4004</code> / <code>0x110</code> <code>5004</code>)</a></p>
</li>
<li>
<p><strong>OVL_UI_SIZE</strong> (UI Overlay Overlay Window Size) at OVL_UI Offset <code>0x88</code></p>
<p>Set to <code>(height-1) &lt;&lt; 16 + (width-1)</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 106, <code>0x110</code> <code>3088</code> / <code>0x110</code> <code>4088</code> / <code>0x110</code> <code>5088</code>)</a></p>
</li>
<li>
<p><strong>OVL_UI_COOR</strong> (UI Overlay Memory Block Coordinate) at OVL_UI Offset <code>0x08</code></p>
<p>Set to 0 (Overlay at X=0, Y=0)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 104, <code>0x110</code> <code>3008</code> / <code>0x110</code> <code>4008</code> / <code>0x110</code> <code>5008</code>)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Channel 1: Set Overlay (fb0 is 720 x 1440)
UI Config Attr:      0x110 3000 = 0xff00 0405
UI Config Top LAddr: 0x110 3010 = 0x4064 a6ac (Address of fb0)
UI Config Pitch:     0x110 300c = 0xb40 (720 * 4)
UI Config Size:      0x110 3004 = 0x59f 02cf (1439 &lt;&lt; 16 + 719)
UI Overlay Size:     0x110 3088 = 0x59f 02cf (1439 &lt;&lt; 16 + 719)
IO Config Coord:     0x110 3008 = 0x0

Channel 2: Set Overlay (fb1 is 600 x 600)
UI Config Attr:      0x110 4000 = 0xff00 0005
UI Config Top LAddr: 0x110 4010 = 0x404e adac (Address of fb1)
UI Config Pitch:     0x110 400c = 0x960 (600 * 4)
UI Config Size:      0x110 4004 = 0x257 0257 (599 &lt;&lt; 16 + 599)
UI Overlay Size:     0x110 4088 = 0x257 0257 (599 &lt;&lt; 16 + 599)
IO Config Coord:     0x110 4008 = 0x0

Channel 3: Set Overlay (fb2 is 720 x 1440)
UI Config Attr:      0x110 5000 = 0x7f00 0005
UI Config Top LAddr: 0x110 5010 = 0x400f 65ac (Address of fb2)
UI Config Pitch:     0x110 500c = 0xb40 (720 * 4)
UI Config Size:      0x110 5004 = 0x59f 02cf (1439 &lt;&lt; 16 + 719)
UI Overlay Size:     0x110 5088 = 0x59f 02cf (1439 &lt;&lt; 16 + 719)
IO Config Coord:     0x110 5008 = 0x0</code></pre></div></li>
<li>
<p><strong>For Channel 1:</strong> Set Blender Output</p>
<ul>
<li>
<p><strong>BLD_SIZE</strong> (Blender Output Size Setting) at BLD Offset <code>0x08C</code></p>
<p>Set to <code>(height-1) &lt;&lt; 16 + (width-1)</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 110, <code>0x110</code> <code>108C</code>)</a></p>
</li>
<li>
<p><strong>GLB_SIZE</strong> (Global Size) at GLB Offset <code>0x00C</code></p>
<p>Set to <code>(height-1) &lt;&lt; 16 + (width-1)</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 93, <code>0x110</code> <code>000C</code>)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Channel 1: Set Blender Output
BLD Output Size: 0x110 108c = 0x59f 02cf (1439 * 16 + 719)
GLB Size:        0x110 000c = 0x59f 02cf (1439 * 16 + 719)</code></pre></div></li>
<li>
<p><strong>Set Blender Input Pipe</strong> (N = Pipe Number, from 0 to 2 for Channels 1 to 3)</p>
<ul>
<li>
<p><strong>BLD_CH_ISIZE</strong> (Blender Input Memory Size) at BLD Offset <code>0x008</code> + <code>N*0x10</code> (N=0,1,2,3,4) </p>
<p>Set to <code>(height-1) &lt;&lt; 16 + (width-1)</code></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 108, <code>0x110 1008</code> / <code>0x110 1018</code> / <code>0x110 1028</code>)</a></p>
</li>
<li>
<p><strong>BLD_FILL_COLOR</strong> (Blender Fill Color) at BLD Offset <code>0x004</code> + <code>N*0x10</code> (N=0,1,2,3,4)</p>
<p>Set to <code>0xFF00</code> <code>0000</code> (Opaque Black)</p>
<p>ALPHA (Bits 24 to 31) = <code>0xFF</code></p>
<p>RED (Bits 16 to 23) = 0</p>
<p>GREEN (Bits 8 to 15) = 0</p>
<p>BLUE (Bits 0 to 7) = 0</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 107, <code>0x110 1004</code> / <code>0x110</code> <code>1014</code> / <code>0x110</code> <code>1024</code>)</a></p>
</li>
<li>
<p><strong>BLD_CH_OFFSET</strong> (Blender Input Memory Offset) at BLD Offset <code>0x00C</code> + <code>N*0x10</code> (N=0,1,2,3,4)</p>
<p>Set to <code>y_offset &lt;&lt; 16 + x_offset</code></p>
<p><strong>For Channel 1:</strong> Set to 0</p>
<p><strong>For Channel 2:</strong> Set to <code>0x34</code> <code>0034</code></p>
<p><strong>For Channel 3:</strong> Set to 0</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 108, <code>0x110</code> <code>100C</code> / <code>0x110</code> <code>101C</code> / <code>0x110</code> <code>102C</code>)</a></p>
</li>
<li>
<p><strong>BLD_CTL</strong> (Blender Control) at BLD Offset <code>0x090</code> + <code>N*4</code></p>
<p>Set to <code>0x301</code> <code>0301</code></p>
<p>BLEND_AFD (Bits 24 to 27) = 3</p>
<p>(Coefficient for destination alpha data Q[d] is 1-A[s])</p>
<p>BLEND_AFS (Bits 16 to 19) = 1</p>
<p>(Coefficient for source alpha data Q[s] is 1)</p>
<p>BLEND_PFD (Bits 8 to 11) = 3</p>
<p>(Coefficient for destination pixel data F[d] is 1-A[s])</p>
<p>BLEND_PFS (Bits 0 to 3) = 1</p>
<p>(Coefficient for source pixel data F[s] is 1)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 110, <code>0x110</code> <code>1090</code> / <code>0x110</code> <code>1094</code> / <code>0x110</code> <code>1098</code>)</a></p>
</li>
</ul>
<p><strong>Note:</strong> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">DE Page 91</a> shows incorrect offset <code>N*0x14</code> for <strong>BLD_CH_ISIZE</strong>, <strong>BLD_FILL_COLOR</strong> and <strong>BLD_CH_OFFSET</strong>. Correct offset is <code>N*0x10</code>, see <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">DE Page 108</a></p>
<div class="example-wrap"><pre class="language-text"><code>Channel 1: Set Blender Input Pipe 0 (fb0 is 720 x 1440)
BLD Pipe InSize: 0x110 1008 = 0x59f 02cf (1439 * 16 + 719)
BLD Pipe FColor: 0x110 1004 = 0xff00 0000
BLD Pipe Offset: 0x110 100c = 0x0
BLD Pipe Mode:   0x110 1090 = 0x301 0301

Channel 2: Set Blender Input Pipe 1 (fb1 is 600 x 600)
BLD Pipe InSize: 0x110 1018 = 0x257 0257 (599 &lt;&lt; 16 + 599)
BLD Pipe FColor: 0x110 1014 = 0xff00 0000
BLD Pipe Offset: 0x110 101c = 0x34 0034
BLD Pipe Mode:   0x110 1094 = 0x301 0301

Channel 3: Set Blender Input Pipe 2 (fb2 is 720 x 1440)
BLD Pipe InSize: 0x110 1028 = 0x59f 02cf (1439 * 16 + 719)
BLD Pipe FColor: 0x110 1024 = 0xff00 0000
BLD Pipe Offset: 0x110 102c = 0x0
BLD Pipe Mode:   0x110 1098 = 0x301 0301</code></pre></div></li>
<li>
<p><strong>Disable Scaler</strong> (Assume we‚Äôre not scaling)</p>
<ul>
<li>
<p><strong>UIS_CTRL_REG</strong> at Offset 0 of UI_SCALER1(CH1) or UI_SCALER2(CH2) or UI_SCALER3(CH3)</p>
<p>Set to 0 (Disable UI Scaler)</p>
<p>EN (Bit 0) = 0 (Disable UI Scaler) </p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 66, <code>0x114</code> <code>0000</code> / <code>0x115</code> <code>0000</code> / <code>0x116</code> <code>0000</code>)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Channel 1: Disable Scaler
Mixer: 0x114 0000 = 0x0

Channel 2: Disable Scaler
Mixer: 0x115 0000 = 0x0

Channel 3: Disable Scaler
Mixer: 0x116 0000 = 0x0</code></pre></div></li>
</ol>
</li>
<li>
<p><strong>Set Blender Route and Enable Blender Pipes</strong></p>
<ul>
<li>
<p><strong>BLD_CH_RTCTL</strong> (Blender Routing Control) at BLD Offset <code>0x080</code></p>
<p><strong>If Rendering 3 UI Channels:</strong> Set to <code>0x321</code> <a href="https://developer.arm.com/documentation/dui0489/c/arm-and-thumb-instructions/miscellaneous-instructions/dmb--dsb--and-isb"><strong>(DMB)</strong></a></p>
<p>P2_RTCTL (Bits 8 to 11) = 3 (Pipe 2 from Channel 3)</p>
<p>P1_RTCTL (Bits 4 to 7) = 2 (Pipe 1 from Channel 2)</p>
<p>P0_RTCTL (Bits 0 to 3) = 1 (Pipe 0 from Channel 1)</p>
<p><strong>If Rendering 1 UI Channel:</strong> Set to <code>1</code> <a href="https://developer.arm.com/documentation/dui0489/c/arm-and-thumb-instructions/miscellaneous-instructions/dmb--dsb--and-isb"><strong>(DMB)</strong></a></p>
<p>P0_RTCTL (Bits 0 to 3) = 1 (Pipe 0 from Channel 1)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 108, <code>0x110</code> <code>1080</code>)</a></p>
</li>
<li>
<p><strong>BLD_FILL_COLOR_CTL</strong> (Blender Fill Color Control) at BLD Offset <code>0x000</code></p>
<p><strong>If Rendering 3 UI Channels:</strong> Set to <code>0x701</code> <a href="https://developer.arm.com/documentation/dui0489/c/arm-and-thumb-instructions/miscellaneous-instructions/dmb--dsb--and-isb"><strong>(DMB)</strong></a></p>
<p>P2_EN (Bit 10) = 1 (Enable Pipe 2)</p>
<p>P1_EN (Bit 9) = 1 (Enable Pipe 1)</p>
<p>P0_EN (Bit 8) = 1 (Enable Pipe 0)</p>
<p>P0_FCEN (Bit 0) = 1 (Enable Pipe 0 Fill Color)</p>
<p><strong>If Rendering 1 UI Channel:</strong> Set to <code>0x101</code> <a href="https://developer.arm.com/documentation/dui0489/c/arm-and-thumb-instructions/miscellaneous-instructions/dmb--dsb--and-isb"><strong>(DMB)</strong></a></p>
<p>P0_EN (Bit 8) = 1 (Enable Pipe 0)</p>
<p>P0_FCEN (Bit 0) = 1 (Enable Pipe 0 Fill Color)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 106, <code>0x110</code> <code>1000</code>)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>For 3 UI Channels: Set BLD Route and BLD FColor Control
BLD Route:          0x110 1080 = 0x321 (DMB)
BLD FColor Control: 0x110 1000 = 0x701 (DMB)

For 1 UI Channel: Set BLD Route and BLD FColor Control
BLD Route:          0x110 1080 = 0x1   (DMB)
BLD FColor Control: 0x110 1000 = 0x101 (DMB)</code></pre></div></li>
<li>
<p><strong>Apply Settings</strong></p>
<ul>
<li>
<p><strong>GLB_DBUFFER</strong> (Global Double Buffer Control) at GLB Offset <code>0x008</code></p>
<p>Set to 1 <a href="https://developer.arm.com/documentation/dui0489/c/arm-and-thumb-instructions/miscellaneous-instructions/dmb--dsb--and-isb"><strong>(DMB)</strong></a></p>
<p>DOUBLE_BUFFER_RDY (Bit 0) = 1</p>
<p>(Register Value is ready for update)</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_DE2.0_Spec_V1.0.pdf">(DE Page 93, <code>0x110</code> <code>0008</code>)</a></p>
</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Apply Settings
GLB DBuff: 0x110 0008 = 0x1 (DMB)</code></pre></div></li>
</ol>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#testing-p-boot-display-engine-on-pinephone">(See the Complete Log)</a></p>
<p><a href="https://megous.com/git/p-boot/tree/src/display.c#n2017">(Captured from p-boot <code>display_commit</code>)</a></p>
<p>Based on the above steps, we have <strong>implemented in Zig</strong> the A64 Display Engine Rendering‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/render.zig"><strong>pinephone-nuttx/render.zig</strong></a></p>
</li>
<li>
<p><a href="https://gist.github.com/lupyuen/2df0f8c016dae54f4e4210866a7cd118"><strong>Output Log for render.zig</strong></a></p>
</li>
</ul>
<p>We have converted the above Zig Driver to C and added to NuttX Kernel‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/de3"><strong>‚ÄúNuttX RTOS for PinePhone: Display Engine‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/de-block1a.jpg" alt="Allwinner A64 Timing Controller (TCON0)" /></p>
<p><a href="https://lupyuen.github.io/articles/de#display-rendering-on-pinephone"><em>Allwinner A64 Timing Controller (TCON0)</em></a></p>
<h1 id="appendix-timing-controller-tcon0"><a href="#appendix-timing-controller-tcon0">15 Appendix: Timing Controller (TCON0)</a></h1>
<p>Earlier we talked about the sequence of steps that our Display Driver needs to follow‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-sequence-of-steps-for-pinephone-display-driver"><strong>‚ÄúSequence of Steps for PinePhone Display Driver‚Äù</strong></a></li>
</ul>
<p>This section explains how we <strong>initialise the Allwinner A64 Timing Controller (TCON0)</strong>.</p>
<p>We captured the log from <a href="https://megous.com/git/p-boot/tree/src/display.c#n1567"><strong>p-boot tcon0_init</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/c12f64cf03d3a81e9c69f9fef49d9b70#tcon0_init"><strong>Log from tcon0_init</strong></a></li>
</ul>
<p>By decoding the captured addresses and values, we decipher the following steps to <strong>initialise the Allwinner A64 Timing Controller (TCON0)</strong>‚Ä¶</p>
<ol>
<li>
<p>Configure PLL_VIDEO0</p>
<p><strong>PLL_VIDEO0_CTRL_REG</strong>: CCU Offset <code>0x10</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 86)</a></p>
<ul>
<li>Set <strong>PLL_ENABLE</strong> (Bit 31) to 1 (Enable PLL)</li>
<li>Set <strong>PLL_MODE</strong> (Bit 30) to 0 (Manual Mode)</li>
<li>Set <strong>LOCK</strong> (Bit 28) to 0 (Unlocked)</li>
<li>Set <strong>FRAC_CLK_OUT</strong> (Bit 25) to 0</li>
<li>Set <strong>PLL_MODE_SEL</strong> (Bit 24) to 1 (Integer Mode)</li>
<li>Set <strong>PLL_SDM_EN</strong> (Bit 20) to 0 (Disable)</li>
<li>Set <strong>PLL_FACTOR_N</strong> (Bits 8 to 14) to <code>0x62</code> (PLL Factor N)</li>
<li>Set <strong>PLL_PREDIV_M</strong> (Bits 0 to 3) to 7 (PLL Pre Divider)</li>
</ul>
<p><strong>CCU Base Address</strong>: <code>0x01C2</code> <code>0000</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 82)</a></p>
<div class="example-wrap"><pre class="language-text"><code>PLL_VIDEO0
0x1c20010 = 0x81006207 (DMB)</code></pre></div></li>
<li>
<p>Enable LDO1 and LDO2</p>
<p><strong>PLL_MIPI_CTRL_REG</strong>: CCU Offset <code>0x40</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 94)</a></p>
<ul>
<li>Set <strong>LDO1_EN</strong> (Bit 23) to 1 (Enable On-chip LDO1)</li>
<li>Set <strong>LDO2_EN</strong> (Bit 22) to 1 (Enable On-chip LDO2)</li>
</ul>
<p>Wait 100 microseconds</p>
<div class="example-wrap"><pre class="language-text"><code>PLL_MIPI
0x1c20040 = 0xc00000 (DMB)
udelay 100</code></pre></div></li>
<li>
<p>Configure MIPI PLL</p>
<p><strong>PLL_MIPI_CTRL_REG</strong>: CCU Offset <code>0x40</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 94)</a></p>
<ul>
<li>Set <strong>PLL_ENABLE</strong> (Bit 31) to 1 (Enable MIPI PLL)</li>
<li>Set <strong>LOCK</strong> (Bit 28) to 0 (Unlocked)</li>
<li>Set <strong>SINT_FRAC</strong> (Bit 27) to 0 (Integer Mode)</li>
<li>Set <strong>SDIV2</strong> (Bit 26) to 0 (PLL Output)</li>
<li>Set <strong>S6P25_7P5</strong> (Bit 25) to 0 (PLL Output=PLL Input*6.25)</li>
<li>Set <strong>LDO1_EN</strong> (Bit 23) to 1 (Enable On-chip LDO1)</li>
<li>Set <strong>LDO2_EN</strong> (Bit 22) to 1 (Enable On-chip LDO2)</li>
<li>Set <strong>PLL_SRC</strong> (Bit 21) to 0 (PLL Source is VIDEO0 PLL)</li>
<li>Set <strong>PLL_SDM_EN</strong> (Bit 20) to 0 (Disable SDM PLL)</li>
<li>Set <strong>PLL_FEEDBACK_DIV</strong> (Bit 17) to 0 (PLL Feedback Divider Control: Divide by 5)</li>
<li>Set <strong>VFB_SEL</strong> (Bit 16) to 0 (MIPI Mode)</li>
<li>Set <strong>PLL_FACTOR_N</strong> (Bits 8 to 11) to 7 (PLL Factor N)</li>
<li>Set <strong>PLL_FACTOR_K</strong> (Bits 4 to 5) to 1 (PLL Factor K)</li>
<li>Set <strong>PLL_PRE_DIV_M</strong> (Bits 0 to 3) to 10 (PLL Pre Divider)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>0x1c20040 = 0x80c0071a (DMB)</code></pre></div></li>
<li>
<p>Set TCON0 Clock Source to MIPI PLL</p>
<p><strong>TCON0_CLK_REG</strong>: CCU Offset <code>0x118</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 117)</a></p>
<ul>
<li>Set <strong>SCLK_GATING</strong> (Bit 31) to 1 (Special Clock is On)</li>
<li>Set <strong>CLK_SRC_SEL</strong> (Bits 24 to 26) to 0 (Clock Source is MIPI PLL)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>TCON0 source MIPI_PLL
0x1c20118 = 0x80000000 (DMB)</code></pre></div></li>
<li>
<p>Enable TCON0 Clock</p>
<p><strong>BUS_CLK_GATING_REG1</strong>: CCU Offset <code>0x64</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 102)</a></p>
<ul>
<li>Set <strong>TCON0_GATING</strong> (Bit 3) to 1 (Pass Clock for TCON0)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Clock on
0x1c20064 = 0x8 (DMB)</code></pre></div></li>
<li>
<p>Deassert TCON0 Reset</p>
<p><strong>BUS_SOFT_RST_REG1</strong>: CCU Offset <code>0x2c4</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 140)</a></p>
<ul>
<li>Set <strong>TCON0_RST</strong> (Bit 3) to 1 (Deassert TCON0 Reset)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Reset off
0x1c202c4 = 0x8 (DMB)</code></pre></div></li>
<li>
<p>Disable TCON0 and Interrupts</p>
<p><strong>TCON_GCTL_REG</strong>: TCON0 Offset <code>0x00</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 508)</a></p>
<ul>
<li>Set <strong>TCON_En</strong> (Bit 31) to 0 (Disable TCON0)</li>
</ul>
<p><strong>TCON_GINT0_REG</strong>: TCON0 Offset 0x04 <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 509)</a></p>
<ul>
<li>Set to 0 (Disable TCON0 Interrupts)</li>
</ul>
<p><strong>TCON_GINT1_REG</strong>: TCON0 Offset 0x08 <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 510)</a></p>
<ul>
<li>Set to 0 (Disable TCON0 Interrupts)</li>
</ul>
<p><strong>TCON0 Base Address</strong>: <code>0x01C0</code> <code>C000</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 507)</a></p>
<div class="example-wrap"><pre class="language-text"><code>Init lcdc: Disable tcon, Disable all interrupts
0x1c0c000 = 0x0 (DMB)
0x1c0c004 = 0x0
0x1c0c008 = 0x0</code></pre></div></li>
<li>
<p>Enable Tristate Output</p>
<p><strong>TCON0_IO_TRI_REG</strong>: TCON0 Offset <code>0x8c</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 520)</a></p>
<ul>
<li>Set to <code>0xffff</code> <code>ffff</code> to Enable TCON0 Tristate Output</li>
</ul>
<p><strong>TCON1_IO_TRI_REG</strong>: TCON0 Offset <code>0xf4</code></p>
<ul>
<li>Set to <code>0xffff</code> <code>ffff</code> to Enable TCON1 Tristate Output </li>
</ul>
<p>Note: <strong>TCON1_IO_TRI_REG</strong> is actually in TCON0 Address Range, not in TCON1 Address Range as stated in A64 User Manual</p>
<div class="example-wrap"><pre class="language-text"><code>Set all io lines to tristate
0x1c0c08c = 0xffffffff
0x1c0c0f4 = 0xffffffff</code></pre></div></li>
<li>
<p>Set DCLK to MIPI PLL / 6</p>
<p><strong>TCON0_DCLK_REG</strong>: TCON0 Offset <code>0x44</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 513)</a></p>
<ul>
<li>Set <strong>TCON0_Dclk_En</strong> (Bits 28 to 31) to 8 (Enable TCON0 Clocks: DCLK, DCLK1, DCLK2, DCLKM2)</li>
<li>Set <strong>TCON0_Dclk_Div</strong> (Bits 0 to 6) to 6 (DCLK Divisor)</li>
</ul>
<p><strong>TCON0_CTL_REG</strong>: TCON0 Offset <code>0x40</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 512)</a></p>
<ul>
<li>Set <strong>TCON0_En</strong> (Bit 31) to 1 (Enable TCON0)</li>
<li>Set <strong>TCON0_Work_Mode</strong> (Bit 28) to 0 (Normal Work Mode)</li>
<li>Set <strong>TCON0_IF</strong> (Bits 24 to 25) to 1 (8080 Interface)</li>
<li>Set <strong>TCON0_RB_Swap</strong> (Bit 23) to 0 (No Red/Blue Swap)</li>
<li>Set <strong>TCON0_FIFO1_Rst</strong> (Bit 21) to 0 (No FIFO1 Reset)</li>
<li>Set <strong>TCON0_Start_Delay</strong> (Bits 4 to 8) to 0 (No STA Delay)</li>
<li>Set <strong>TCON0_SRC_SEL</strong> (Bits 0 to 2) to 0 (TCON0 Source is DE0)</li>
</ul>
<p><strong>TCON0_BASIC0_REG</strong>: TCON0 Offset <code>0x48</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 514)</a></p>
<ul>
<li>Set <strong>TCON0_X</strong> (Bits 16 to 27) to 719 (Panel Width - 1)</li>
<li>Set <strong>TCON0_Y</strong> (Bits 0 to 11) to 1439 (Panel Height - 1)</li>
</ul>
<p><strong>TCON0_ECC_FIFO</strong>: TCON0 Offset <code>0xf8</code> (Undocumented)</p>
<ul>
<li>Set to 8</li>
</ul>
<p><strong>TCON0_CPU_IF_REG</strong>: TCON0 Offset <code>0x60</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 516)</a></p>
<ul>
<li>Set <strong>CPU_Mode</strong> (Bits 28 to 31) to 1 (24-bit DSI)</li>
<li>Set <strong>AUTO</strong> (Bit 17) to 0 (Disable Auto Transfer Mode)</li>
<li>Set <strong>FLUSH</strong> (Bit 16) to 1 (Enable Direct Transfer Mode)</li>
<li>Set <strong>Trigger_FIFO_Bist_En</strong> (Bit 3) to 0 (Disable FIFO Bist Trigger)</li>
<li>Set <strong>Trigger_FIFO_En</strong> (Bit 2) to 1 (Enable FIFO Trigger)</li>
<li>Set <strong>Trigger_En</strong> (Bit 0) to 1 (Enable Trigger Mode)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>mode set: DCLK = MIPI_PLL / 6
0x1c0c044 = 0x80000006
0x1c0c040 = 0x81000000
0x1c0c048 = 0x2cf059f
0x1c0c0f8 = 0x8
0x1c0c060 = 0x10010005</code></pre></div></li>
<li>
<p>Set CPU Panel Trigger</p>
<p><strong>TCON0_CPU_TRI0_REG</strong>: TCON0 Offset <code>0x160</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 521)</a></p>
<ul>
<li>Set <strong>Block_Space</strong> (Bits 16 to 27) to 47 (Block Space)</li>
<li>Set <strong>Block_Size</strong> (Bits 0 to 11) to 719 (Panel Width - 1)</li>
</ul>
<p><strong>TCON0_CPU_TRI1_REG</strong>: TCON0 Offset <code>0x164</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 522)</a></p>
<ul>
<li>Set <strong>Block_Current_Num</strong> (Bits 16 to 31) to 0 (Block Current Number)</li>
<li>Set <strong>Block_Num</strong> (Bits 0 to 15) to 1439 (Panel Height - 1)</li>
</ul>
<p><strong>TCON0_CPU_TRI2_REG</strong>: TCON0 Offset <code>0x168</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 522)</a></p>
<ul>
<li>Set <strong>Start_Delay</strong> (Bits 16 to 31) to 7106 (Start Delay)</li>
<li>Set <strong>Trans_Start_Mode</strong> (Bit 15) to 0 (Trans Start Mode is ECC FIFO + TRI FIFO)</li>
<li>Set <strong>Sync_Mode</strong> (Bits 13 to 14) to 0 (Sync Mode is Auto)</li>
<li>Set <strong>Trans_Start_Set</strong> (Bits 0 to 12) to 10 (Trans Start Set)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>The datasheet says that this should be set higher than 20 * pixel cycle, but it&#39;s not clear what a pixel cycle is.
0x1c0c160 = 0x2f02cf
0x1c0c164 = 0x59f
0x1c0c168 = 0x1bc2000a</code></pre></div></li>
<li>
<p>Set Safe Period</p>
<p><strong>TCON_SAFE_PERIOD_REG</strong>: TCON0 Offset <code>0x1f0</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 525)</a></p>
<ul>
<li>Set <strong>Safe_Period_FIFO_Num</strong> (Bits 16 to 28) to 3000</li>
<li>Set <strong>Safe_Period_Line</strong> (Bits 4 to 15) to 0</li>
<li>Set <strong>Safe_Period_Mode</strong> (Bits 0 to 2) to 3 (Safe Period Mode: Safe at 2 and safe at sync active)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>The Allwinner BSP has a comment that the period should be the display clock * 15, but uses an hardcoded 3000
0x1c0c1f0 = 0xbb80003</code></pre></div></li>
<li>
<p>Enable Output Triggers</p>
<p><strong>TCON0_IO_TRI_REG</strong>: TCON0 Offset <code>0x8c</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 520)</a></p>
<ul>
<li>Set <strong>Reserved</strong> (Bits 29 to 31) to <code>0b111</code></li>
<li>Set <strong>RGB_Endian</strong> (Bit 28) to 0 (Normal RGB Endian)</li>
<li>Set <strong>IO3_Output_Tri_En</strong> (Bit 27) to 0 (Enable IO3 Output Tri)</li>
<li>Set <strong>IO2_Output_Tri_En</strong> (Bit 26) to 0 (Enable IO2 Output Tri)</li>
<li>Set <strong>IO1_Output_Tri_En</strong> (Bit 25) to 0 (Enable IO1 Output Tri)</li>
<li>Set <strong>IO0_Output_Tri_En</strong> (Bit 24) to 0 (Enable IO0 Output Tri)</li>
<li>Set <strong>Data_Output_Tri_En</strong> (Bits 0 to 23) to 0 (Enable TCON0 Output Port)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>Enable the output on the pins
0x1c0c08c = 0xe0000000 (DMB)</code></pre></div></li>
<li>
<p>Enable TCON0</p>
<p><strong>TCON_GCTL_REG</strong>: TCON0 Offset <code>0x00</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 508)</a></p>
<ul>
<li>Set <strong>TCON_En</strong> (Bit 31) to 1 (Enable TCON0)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>enable tcon as a whole
setbits 0x1c0c000, 0x80000000 (DMB)</code></pre></div></li>
</ol>
<p>Based on the above steps, we have <strong>implemented in Zig</strong> the PinePhone Driver for Allwinner A64 Timing Controller (TCON0)‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/tcon.zig"><strong>pinephone-nuttx/tcon.zig</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#testing-zig-backlight-driver-on-pinephone"><strong>Output Log for tcon.zig</strong></a></p>
</li>
</ul>
<p>We have converted the above TCON0 Driver from Zig to C and added it to NuttX Mainline‚Ä¶</p>
<ul>
<li><a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/a64/a64_tcon0.c"><strong>a64_tcon0.c</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/pio-backlight.png" alt="PinePhone Display Backlight" /></p>
<p><a href="https://lupyuen.github.io/articles/pio#pinephone-backlight"><em>PinePhone Display Backlight</em></a></p>
<h1 id="appendix-display-backlight"><a href="#appendix-display-backlight">16 Appendix: Display Backlight</a></h1>
<p>Earlier we talked about the sequence of steps that our Display Driver needs to follow‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-sequence-of-steps-for-pinephone-display-driver"><strong>‚ÄúSequence of Steps for PinePhone Display Driver‚Äù</strong></a></li>
</ul>
<p>This section explains how we turn on <strong>PinePhone‚Äôs Display Backlight</strong>.</p>
<p>We captured the log from <a href="https://megous.com/git/p-boot/tree/src/display.c#n1929"><strong>p-boot backlight_enable</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/c12f64cf03d3a81e9c69f9fef49d9b70#backlight_enable"><strong>Log from backlight_enable</strong></a></li>
</ul>
<p>By decoding the captured addresses and values, we decipher the following steps for turning on <strong>PinePhone‚Äôs Display Backlight</strong>‚Ä¶</p>
<ol>
<li>
<p>Configure PL10 for PWM</p>
<p>Register <strong>PL_CFG1</strong> (Port L Configure Register 1)</p>
<ul>
<li>At R_PIO Offset 4 <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 412)</a></li>
<li>Set <strong>PL10_SELECT</strong> (Bits 8 to 10) to 2 (S_PWM)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>backlight_enable: pct=0x5a
1.0 has incorrectly documented non-presence of PH10, the circuit is in fact the same as on 1.1+
configure pwm: GPL(10), GPL_R_PWM
sunxi_gpio_set_cfgpin: pin=0x16a, val=2
sunxi_gpio_set_cfgbank: bank_offset=362, val=2
clrsetbits 0x1f02c04, 0xf00, 0x200
TODO: Should 0xf00 be 0x700 instead?</code></pre></div></li>
<li>
<p>Disable R_PWM (Undocumented)</p>
<p>Register <strong>R_PWM_CTRL_REG</strong>? (R_PWM Control Register?)</p>
<ul>
<li>At R_PWM Offset 0 <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 194)</a></li>
<li>Set <strong>SCLK_CH0_GATING</strong> (Bit 6) to 0 (Mask)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>clrbits 0x1f03800, 0x40</code></pre></div></li>
<li>
<p>Configure R_PWM Period (Undocumented)</p>
<ul>
<li>Register <strong>R_PWM_CH0_PERIOD</strong>? (R_PWM Channel 0 Period Register?)</li>
<li>At R_PWM Offset 4 <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 195)</a></li>
<li>Set <strong>PWM_CH0_ENTIRE_CYS</strong> (Upper 16 Bits) to Period (<code>0x4af</code>)</li>
<li>Set <strong>PWM_CH0_ENTIRE_ACT_CYS</strong> (Lower 16 Bits) to Period * Percent / 100 (<code>0x0437</code>)</li>
<li><strong>Period</strong> = 1199 (Cycles of PWM Clock)</li>
<li><strong>Percent</strong> = 90 (90% Brightness)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>0x1f03804 = 0x4af0437</code></pre></div></li>
<li>
<p>Enable R_PWM (Undocumented)</p>
<ul>
<li>Register <strong>R_PWM_CTRL_REG</strong>? (R_PWM Control Register?)</li>
<li>At R_PWM Offset 0 <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 194)</a></li>
<li>Set <strong>SCLK_CH0_GATING</strong> (Bit 6) to 1 (Pass)</li>
<li>Set <strong>PWM_CH0_EN</strong> (Bit 4) to 1 (Enable)</li>
<li>Set <strong>PWM_CH0_PRESCAL</strong> (Bits 0 to 3) to 0b1111 (Prescaler is 1)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>0x1f03800 = 0x5f</code></pre></div></li>
<li>
<p>Configure PH10 for Output</p>
<ul>
<li>Register <strong>PH_CFG1</strong> (PH Configure Register 1)</li>
<li>At PIO Offset <code>0x100</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 401)</a></li>
<li>Set <strong>PH10_SELECT</strong> (Bits 8 to 10) to 1 (Output)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>enable backlight: GPH(10), 1
sunxi_gpio_set_cfgpin: pin=0xea, val=1
sunxi_gpio_set_cfgbank: bank_offset=234, val=1
clrsetbits 0x1c20900, 0xf00, 0x100
TODO: Should 0xf00 be 0x700 instead?</code></pre></div></li>
<li>
<p>Set PH10 to High</p>
<ul>
<li>Register <strong>PH_DATA</strong> (PH Data Register)</li>
<li>At PIO Offset <code>0x10C</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 403)</a></li>
<li>Set <strong>PH10</strong> (Bit 10) to 1 (High)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>sunxi_gpio_output: pin=0xea, val=1
TODO: Set Bit 10 of PH_DATA (0x1c2090c)</code></pre></div></li>
</ol>
<p><a href="https://gist.github.com/lupyuen/c12f64cf03d3a81e9c69f9fef49d9b70#backlight_enable">(See the Complete Log)</a></p>
<p>The Base Addresses above are‚Ä¶</p>
<ul>
<li>
<p><strong>PIO Base Address</strong> (CPUx-PORT): <code>0x01C2</code> <code>0800</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 376)</a></p>
</li>
<li>
<p><strong>PWM Base Address</strong> (CPUx-PWM?): <code>0x01C2</code> <code>1400</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 194)</a></p>
</li>
<li>
<p><strong>R_PIO Base Address</strong> (CPUs-PORT): <code>0x01F0</code> <code>2C00</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 410)</a></p>
</li>
<li>
<p><strong>R_PWM Base Address</strong> (CPUs-PWM?): <code>0x01F0</code> <code>3800</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(CPUs Domain, A64 Page 256)</a></p>
</li>
</ul>
<p>Based on the above steps, we have <strong>implemented in Zig</strong> the Display Backlight Driver‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/backlight.zig"><strong>pinephone-nuttx/backlight.zig</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#testing-zig-backlight-driver-on-pinephone"><strong>Output Log for backlight.zig</strong></a></p>
</li>
</ul>
<p>We‚Äôre now porting the above driver from Zig to C. Work-in-progress‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/rsb2/boards/arm64/a64/pinephone/src/pinephone_lcd.c"><strong>boards/arm64/a64/pinephone/src/pinephone_lcd.c</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/de-pmic.png" alt="AXP803 PMIC on PinePhone Schematic (Page 3)" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>AXP803 PMIC on PinePhone Schematic (Page 3)</em></a></p>
<h1 id="appendix-power-management-integrated-circuit"><a href="#appendix-power-management-integrated-circuit">17 Appendix: Power Management Integrated Circuit</a></h1>
<p>Earlier we talked about the sequence of steps that our Display Driver needs to follow‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-sequence-of-steps-for-pinephone-display-driver"><strong>‚ÄúSequence of Steps for PinePhone Display Driver‚Äù</strong></a></li>
</ul>
<p>This section explains how we <strong>initialise PinePhone‚Äôs Power Management Integrated Circuit (PMIC)</strong>, before accessing PinePhone‚Äôs LCD Display.</p>
<p>To power on the LCD Display, we need to program PinePhone‚Äôs <strong>Power Management Integrated Circuit (PMIC)</strong>‚Ä¶</p>
<ul>
<li><a href="https://files.pine64.org/doc/datasheet/pine64/AXP803_Datasheet_V1.0.pdf"><strong>X-Powers AXP803 PMIC Datasheet</strong></a></li>
</ul>
<p>The <strong>AXP803 PMIC</strong> (pic above) is connected on Allwinner A64‚Äôs <strong>Reduced Serial Bus (RSB)</strong> (works like I2C) at RSB Address <code>0x2D</code>: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/pmic.zig#L48-L66">pmic.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// Address of AXP803 PMIC on Reduced Serial Bus
const AXP803_RT_ADDR = 0x2d;</code></pre></div>
<p>A64‚Äôs Reduced Serial Bus is explained here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/de#appendix-reduced-serial-bus"><strong>‚ÄúReduced Serial Bus‚Äù</strong></a></li>
</ul>
<p>We captured the log from <a href="https://megous.com/git/p-boot/tree/src/display.c#n1947"><strong>p-boot display_board_init</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/c12f64cf03d3a81e9c69f9fef49d9b70#display_board_init"><strong>Log from display_board_init</strong></a></li>
</ul>
<p>By decoding the captured addresses and values, we decipher the following steps to <strong>initialise PinePhone‚Äôs Power Management Integrated Circuit (PMIC)</strong>‚Ä¶</p>
<ol>
<li>
<p>Configure PD23 for Output</p>
<p>Register <strong>PD_CFG2_REG</strong> (PD Configure Register 2)</p>
<ul>
<li>At PIO Offset <code>0x74</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 387)</a></li>
<li>Set <strong>PD23_SELECT</strong> (Bits 28 to 30) to 1 (Output)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>assert reset: GPD(23), 0  // PD23 - LCD-RST (active low)
sunxi_gpio_set_cfgpin: pin=0x77, val=1
sunxi_gpio_set_cfgbank: bank_offset=119, val=1
clrsetbits 0x1c20874, 0xf0000000, 0x10000000</code></pre></div></li>
<li>
<p>Set PD23 to Low</p>
<p>Register <strong>PD_DATA_REG</strong> (PD Data Register)</p>
<ul>
<li>At PIO Offset <code>0x7C</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 388)</a></li>
<li>Set <strong>PD23</strong> (Bit 23) to 0 (Low)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>sunxi_gpio_output: pin=0x77, val=0
before: 0x1c2087c = 0x1c0000
after: 0x1c2087c = 0x1c0000 (DMB)</code></pre></div></li>
<li>
<p>Set DLDO1 Voltage to 3.3V</p>
<p>(DLDO1 powers the Front Camera / USB HSIC / I2C Sensors)</p>
<p>Register <code>0x15</code>: <strong>DLDO1 Voltage Control</strong> (AXP803 Page 52)</p>
<ul>
<li>Set <strong>Voltage</strong> (Bits 0 to 4) to 26 (2.6V + 0.7V = 3.3V)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>dldo1 3.3V
pmic_write: reg=0x15, val=0x1a
rsb_write: rt_addr=0x2d, reg_addr=0x15, value=0x1a</code></pre></div></li>
<li>
<p>Power on DLDO1</p>
<p>Register <code>0x12</code>: <strong>Output Power On-Off Control 2</strong> (AXP803 Page 51)</p>
<ul>
<li>Set <strong>DLDO1 On-Off Control</strong> (Bit 3) to 1 (Power On)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>pmic_clrsetbits: reg=0x12, clr_mask=0x0, set_mask=0x8
rsb_read: rt_addr=0x2d, reg_addr=0x12
rsb_write: rt_addr=0x2d, reg_addr=0x12, value=0xd9</code></pre></div></li>
<li>
<p>Set LDO Voltage to 3.3V</p>
<p>(GPIO0LDO powers the <strong>Capacitive Touch Panel</strong>)</p>
<p>Register <code>0x91</code>: <strong>GPIO0LDO and GPIO0 High Level Voltage Setting</strong> (AXP803 Page 77)</p>
<ul>
<li>Set <strong>GPIO0LDO and GPIO0 High Level Voltage</strong> (Bits 0 to 4) to 26 (2.6V + 0.7V = 3.3V)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>ldo_io0 3.3V
pmic_write: reg=0x91, val=0x1a
rsb_write: rt_addr=0x2d, reg_addr=0x91, value=0x1a</code></pre></div></li>
<li>
<p>Enable LDO Mode on GPIO0</p>
<p>Register <code>0x90</code>: <strong>GPIO0 (GPADC) Control</strong> (AXP803 Page 76)</p>
<ul>
<li>Set <strong>GPIO0 Pin Function Control</strong> (Bits 0 to 2) to 0b11 (Low Noise LDO on)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>pmic_write: reg=0x90, val=0x3
rsb_write: rt_addr=0x2d, reg_addr=0x90, value=0x3</code></pre></div></li>
<li>
<p>Set DLDO2 Voltage to 1.8V</p>
<p>(DLDO2 powers the <strong>MIPI DSI Connector</strong>)</p>
<p>Register <code>0x16</code>: <strong>DLDO2 Voltage Control</strong> (AXP803 Page 52)</p>
<ul>
<li>Set <strong>Voltage</strong> (Bits 0 to 4) to 11 (1.1V + 0.7V = 1.8V)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>dldo2 1.8V
pmic_write: reg=0x16, val=0xb
rsb_write: rt_addr=0x2d, reg_addr=0x16, value=0xb</code></pre></div></li>
<li>
<p>Power on DLDO2</p>
<p>Register <code>0x12</code>: <strong>Output Power On-Off Control 2</strong> (AXP803 Page 51)</p>
<ul>
<li>Set <strong>DLDO2 On-Off Control</strong> (Bit 4) to 1 (Power On)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>pmic_clrsetbits: reg=0x12, clr_mask=0x0, set_mask=0x10
rsb_read: rt_addr=0x2d, reg_addr=0x12
rsb_write: rt_addr=0x2d, reg_addr=0x12, value=0xd9</code></pre></div></li>
<li>
<p>Wait for power supply and power-on init</p>
<p>(15,000 microseconds)</p>
<div class="example-wrap"><pre class="language-text"><code>wait for power supplies and power-on init
udelay 15000</code></pre></div></li>
</ol>
<p>Based on the above steps, we have <strong>implemented in Zig</strong> the PinePhone Driver for Power Management Integrated Circuit (PMIC)‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/pmic.zig"><strong>pinephone-nuttx/pmic.zig</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#testing-zig-backlight-driver-on-pinephone"><strong>Output Log for pmic.zig</strong></a></p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/de-reset.jpg" alt="LCD Panel Reset (PD23) on PinePhone Schematic (Page 11)" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>LCD Panel Reset (PD23) on PinePhone Schematic (Page 11)</em></a></p>
<h1 id="appendix-reset-lcd-panel"><a href="#appendix-reset-lcd-panel">18 Appendix: Reset LCD Panel</a></h1>
<p>Earlier we talked about the sequence of steps that our Display Driver needs to follow‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-sequence-of-steps-for-pinephone-display-driver"><strong>‚ÄúSequence of Steps for PinePhone Display Driver‚Äù</strong></a></li>
</ul>
<p>This section explains how we <strong>reset PinePhone‚Äôs LCD Panel</strong>, before sending Initialisation Commands to the ST7703 LCD Controller.</p>
<p>Allwinner A64 is connected to <strong>LCD Panel Reset on PD23</strong> (pic above). We toggle PD23 <strong>Low and High like</strong> so‚Ä¶</p>
<ol>
<li>
<p><strong>Set PD23 to Low</strong> before initialising the Power Management Integrated Circuit (PMIC)</p>
</li>
<li>
<p><strong>Set PD23 to High</strong> (and wait 15 milliseconds) before initialising the ST7703 LCD Controller</p>
</li>
</ol>
<p>The complete flow for our PinePhone Display Driver looks like this: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/rsb2/boards/arm64/a64/pinephone/src/pinephone_display.c">pinephone_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Turn on Display Backlight
pinephone_lcd_backlight_enable(90);

// Init Timing Controller TCON0
a64_tcon0_init(PANEL_WIDTH, PANEL_HEIGHT);

// Reset LCD Panel to Low (PD23)
pinephone_lcd_panel_reset(false);

// Init PMIC
pinephone_pmic_init();

// Wait 15 milliseconds for power supply and power-on init
up_mdelay(15);

// Enable MIPI DSI Block
a64_mipi_dsi_enable();

// Enable MIPI Display Physical Layer (DPHY)
a64_mipi_dphy_enable();

// Reset LCD Panel to High (PD23)
pinephone_lcd_panel_reset(true);

// Wait 15 milliseconds for LCD Panel
up_mdelay(15);

// Initialise LCD Controller (ST7703)
pinephone_lcd_panel_init();

// Omitted: Start MIPI DSI, init Display Engine and enable Display Engine</code></pre></div>
<p>We captured the log from <a href="https://megous.com/git/p-boot/tree/src/display.c#n1236"><strong>p-boot dsi_init</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/c12f64cf03d3a81e9c69f9fef49d9b70#panel_reset"><strong>Log from dsi_init</strong></a></li>
</ul>
<p>By decoding the captured addresses and values, we decipher the following steps to <strong>reset PinePhone‚Äôs LCD Panel</strong>‚Ä¶</p>
<ol>
<li>
<p>Configure PD23 for Output</p>
<p>Register <strong>PD_CFG2_REG</strong> (PD Configure Register 2)</p>
<ul>
<li>At PIO Offset <code>0x74</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 387)</a></li>
<li>Set <strong>PD23_SELECT</strong> (Bits 28 to 30) to 1 (Output)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>deassert reset: GPD(23), 1  // PD23 - LCD-RST (active low)
sunxi_gpio_set_cfgpin: pin=0x77, val=1
sunxi_gpio_set_cfgbank: bank_offset=119, val=1
clrsetbits 0x1c20874, 0xf0000000, 0x10000000</code></pre></div></li>
<li>
<p>Set PD23 to High or Low</p>
<p>Register <strong>PD_DATA_REG</strong> (PD Data Register)</p>
<ul>
<li>At PIO Offset <code>0x7C</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 388)</a></li>
<li>Set <strong>PD23</strong> (Bit 23) to 1 (High) or 0 (Low)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>sunxi_gpio_output: pin=0x77, val=1
before: 0x1c2087c = 0x1c0000
after: 0x1c2087c = 0x9c0000 (DMB)</code></pre></div></li>
<li>
<p>Wait for initialization</p>
<p>(15 milliseconds)</p>
<div class="example-wrap"><pre class="language-text"><code>wait for initialization
udelay 15000</code></pre></div></li>
</ol>
<p>Based on the above steps, we have <strong>implemented in Zig</strong> the PinePhone Driver that resets the LCD Panel‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/panel.zig"><strong>pinephone-nuttx/panel.zig</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#testing-zig-backlight-driver-on-pinephone"><strong>Output Log for panel.zig</strong></a></p>
</li>
</ul>
<p>We‚Äôre now porting the above driver from Zig to C. Work-in-progress‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/rsb2/boards/arm64/a64/pinephone/src/pinephone_lcd.c"><strong>boards/arm64/a64/pinephone/src/pinephone_lcd.c</strong></a></li>
</ul>
<h1 id="appendix-reduced-serial-bus"><a href="#appendix-reduced-serial-bus">19 Appendix: Reduced Serial Bus</a></h1>
<p>PinePhone‚Äôs <strong>AXP803 Power Management Integrated Circuit</strong> (PMIC) is connected to Allwinner A64 via the <strong>Reduced Serial Bus</strong> (RSB)‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/de#appendix-power-management-integrated-circuit"><strong>‚ÄúPower Management Integrated Circuit‚Äù</strong></a></li>
</ul>
<p>A64‚Äôs Reduced Serial Bus is documented in the <strong>Allwinner A80 User Manual</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf"><strong>‚ÄúAllwinner A80 User Manual‚Äù (Page 918)</strong></a></li>
</ul>
<blockquote>
<p>‚ÄúThe RSB (reduced serial bus) Host Controller is designed to communicate with RSB Device using two push-pull wires.‚Äù</p>
</blockquote>
<blockquote>
<p>‚ÄúIt supports a simplified two wire protocol (RSB) on a push-pull bus. The transfer speed can be up to 20MHz and the performance will be improved much.‚Äù</p>
</blockquote>
<p>Reduced Serial Bus seems to work like I2C, specifically for PMIC.</p>
<p>We‚Äôre now converting the Reduced Serial Bus Driver from Zig to C. Work-in-progress‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/rsb/arch/arm64/src/a64/a64_rsb.c"><strong>arch/arm64/src/a64/a64_rsb.c</strong></a></li>
</ul>
<p><strong>Base Address of Reduced Serial Bus</strong> (R_RSB) is <strong><code>0x01F</code> <code>03400</code></strong> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 75)</a></p>
<p>The <strong>Reduced Serial Bus Registers</strong> are <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 922)</a>‚Ä¶</p>
<ul>
<li>
<p><strong>RSB Control Register</strong> (RSB_CTRL)</p>
<p>(RSB Offset <strong><code>0x0000</code></strong>)</p>
</li>
<li>
<p><strong>RSB Clock Control Register</strong> (RSB_CCR)</p>
<p>(RSB Offset <strong><code>0x0004</code></strong>) </p>
</li>
<li>
<p><strong>RSB Interrupt Enable Register</strong> (RSB_INTE)</p>
<p>(RSB Offset <strong><code>0x0008</code></strong>) </p>
</li>
<li>
<p><strong>RSB Status Register</strong> (RSB_STAT)</p>
<p>(RSB Offset <strong><code>0x000c</code></strong>) </p>
</li>
<li>
<p><strong>RSB Address Register</strong> (RSB_AR)</p>
<p>(RSB Offset <strong><code>0x0010</code></strong>) </p>
</li>
<li>
<p><strong>RSB Data Buffer Register</strong> (RSB_DATA)</p>
<p>(RSB Offset <strong><code>0x001c</code></strong>) </p>
</li>
<li>
<p><strong>RSB Line Control register</strong> (RSB_LCR)</p>
<p>(RSB Offset <strong><code>0x0024</code></strong>) </p>
</li>
<li>
<p><strong>RSB Device Mode Control Register</strong> (RSB_DMCR)</p>
<p>(RSB Offset <strong><code>0x0028</code></strong>) </p>
</li>
<li>
<p><strong>RSB Command Register</strong> (RSB_CMD)</p>
<p>(RSB Offset <strong><code>0x002C</code></strong>) </p>
</li>
<li>
<p><strong>RSB Device Address Register</strong> (RSB_DAR)</p>
<p>(RSB Offset <strong><code>0x0030</code></strong>) </p>
</li>
</ul>
<p>Here‚Äôs our implementation in Zig: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/pmic.zig#L48-L68">pmic.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// Reduced Serial Bus Offsets (A80 Page 922)
const RSB_CTRL   = 0x00;  // RSB Control Register
const RSB_STAT   = 0x0c;  // RSB Status Register
const RSB_AR     = 0x10;  // RSB Address Register
const RSB_DATA   = 0x1c;  // RSB Data Buffer Register
const RSB_CMD    = 0x2c;  // RSB Command Register
const RSB_DAR    = 0x30;  // RSB Device Address Register</code></pre></div>
<p>The bus supports this <strong>Reduced Serial Bus Command Set</strong> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 918)</a>‚Ä¶</p>
<ul>
<li>
<p><strong>Set Run-Time-Address</strong> (SRTA)</p>
<p>(RBS Command <code>0xE8</code>)</p>
</li>
<li>
<p><strong>Read one byte</strong> from Device (RD8)</p>
<p>(RBS Command <code>0x8B</code>)</p>
</li>
<li>
<p><strong>Read two bytes</strong> from Device (RD16)</p>
<p>(RBS Command <code>0x9C</code>)</p>
</li>
<li>
<p><strong>Read four bytes</strong> from Device (RD32)</p>
<p>(RBS Command <code>0xA6</code>)</p>
</li>
<li>
<p><strong>Write one byte</strong> to Device (WR8)</p>
<p>(RBS Command <code>0x4E</code>)</p>
</li>
<li>
<p><strong>Write two bytes</strong> to Device (WR16)</p>
<p>(RBS Command <code>0x59</code>)</p>
</li>
<li>
<p><strong>Write four bytes</strong> to Device (WR32)</p>
<p>(RBS Command <code>0x63</code>)</p>
</li>
</ul>
<p>Here‚Äôs our implementation in Zig: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/pmic.zig#L48-L66">pmic.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// Read a byte from Reduced Serial Bus (A80 Page 918)
const RSBCMD_RD8 = 0x8B;

/// Write a byte to Reduced Serial Bus (A80 Page 918)
const RSBCMD_WR8 = 0x4E;</code></pre></div>
<p>Let‚Äôs walk through the steps to‚Ä¶</p>
<ul>
<li>
<p>Read a byte from RSB</p>
</li>
<li>
<p>Write a byte to RSB</p>
</li>
<li>
<p>Wait for RSB Status</p>
</li>
<li>
<p>Wait for RSB Transaction</p>
</li>
</ul>
<h2 id="read-from-rsb"><a href="#read-from-rsb">19.1 Read from RSB</a></h2>
<p><strong>To read a byte</strong> from Reduced Serial Bus‚Ä¶</p>
<ol>
<li>
<p><strong>RSB Command Register</strong> (RSB_CMD) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 928)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x002C</code></strong></li>
<li>Set to <strong><code>0x8B</code></strong> (RD8) to read one byte</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>putreg32(RSBCMD_RD8, R_RSB_BASE_ADDRESS + RSB_CMD);</code></pre></div></li>
<li>
<p><strong>RSB Device Address Register</strong> (RSB_DAR) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 928)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x0030</code></strong></li>
<li>Set <strong>RTA</strong> (Bits 16 to 23) to the Run-Time Address (<code>0x2D</code> for AXP803 PMIC)</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>const rt_addr_shift: u32 = @intCast(u32, rt_addr) &lt;&lt; 16;
putreg32(rt_addr_shift, R_RSB_BASE_ADDRESS + RSB_DAR);</code></pre></div></li>
<li>
<p><strong>RSB Address Register</strong> (RSB_AR) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 926)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x0010</code></strong></li>
<li>Set to the <strong>Register Address</strong> that we‚Äôll read from AXP803 PMIC</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>putreg32(reg_addr, R_RSB_BASE_ADDRESS + RSB_AR);</code></pre></div></li>
<li>
<p><strong>RSB Control Register</strong> (RSB_CTRL) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 923)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x0000</code></strong></li>
<li>Set <strong>START_TRANS</strong> (Bit 7) to 1 (Start Transaction)</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>putreg32(0x80, R_RSB_BASE_ADDRESS + RSB_CTRL);</code></pre></div></li>
<li>
<p>Wait for <strong>RSB Status</strong></p>
<p><a href="https://lupyuen.github.io/articles/de#wait-for-rsb-status">(See this)</a></p>
<div class="example-wrap"><pre class="language-zig"><code>const ret = rsb_wait_stat(&quot;Read RSB&quot;);
if (ret != 0) { return ret; }</code></pre></div></li>
<li>
<p><strong>RSB Data Buffer Register</strong> (RSB_DATA) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 926)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x001c</code></strong></li>
<li>Contains the <strong>Register Value</strong> read from AXP803 PMIC</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>return getreg8(R_RSB_BASE_ADDRESS + RSB_DATA);</code></pre></div></li>
</ol>
<p>Here‚Äôs our implementation in Zig: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/pmic.zig#L206-L244">pmic.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// Read a byte from Reduced Serial Bus.
/// Returns -1 on error.
fn rsb_read(
  rt_addr: u8,
  reg_addr: u8
) i32 {
  // Read a byte
  debug(&quot;  rsb_read: rt_addr=0x{x}, reg_addr=0x{x}&quot;, .{ rt_addr, reg_addr });
  const rt_addr_shift: u32 = @intCast(u32, rt_addr) &lt;&lt; 16;
  putreg32(RSBCMD_RD8,    R_RSB_BASE_ADDRESS + RSB_CMD);   // TODO: DMB
  putreg32(rt_addr_shift, R_RSB_BASE_ADDRESS + RSB_DAR);   // TODO: DMB
  putreg32(reg_addr,      R_RSB_BASE_ADDRESS + RSB_AR);    // TODO: DMB

  // Start transaction
  putreg32(0x80,          R_RSB_BASE_ADDRESS + RSB_CTRL);  // TODO: DMB
  const ret = rsb_wait_stat(&quot;Read RSB&quot;);
  if (ret != 0) { return ret; }
  return getreg8(R_RSB_BASE_ADDRESS + RSB_DATA);
}</code></pre></div><h2 id="write-to-rsb"><a href="#write-to-rsb">19.2 Write to RSB</a></h2>
<p><strong>To write a byte</strong> to Reduced Serial Bus‚Ä¶</p>
<ol>
<li>
<p><strong>RSB Command Register</strong> (RSB_CMD) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 928)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x002C</code></strong></li>
<li>Set to <strong><code>0x4E</code></strong> (WR8) to write one byte</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>putreg32(RSBCMD_WR8, R_RSB_BASE_ADDRESS + RSB_CMD);</code></pre></div></li>
<li>
<p><strong>RSB Device Address Register</strong> (RSB_DAR) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 928)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x0030</code></strong></li>
<li>Set <strong>RTA</strong> (Bits 16 to 23) to the Run-Time Address (<code>0x2D</code> for AXP803 PMIC)</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>const rt_addr_shift: u32 = @intCast(u32, rt_addr) &lt;&lt; 16;
putreg32(rt_addr_shift, R_RSB_BASE_ADDRESS + RSB_DAR);</code></pre></div></li>
<li>
<p><strong>RSB Address Register</strong> (RSB_AR) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 926)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x0010</code></strong></li>
<li>Set to the <strong>Register Address</strong> that we‚Äôll write to AXP803 PMIC</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>putreg32(reg_addr, R_RSB_BASE_ADDRESS + RSB_AR);</code></pre></div></li>
<li>
<p><strong>RSB Data Buffer Register</strong> (RSB_DATA) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 926)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x001c</code></strong></li>
<li>Set to the <strong>Register Value</strong> that will be written to AXP803 PMIC</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>putreg32(value, R_RSB_BASE_ADDRESS + RSB_DATA);</code></pre></div></li>
<li>
<p><strong>RSB Control Register</strong> (RSB_CTRL) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 923)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x0000</code></strong></li>
<li>Set <strong>START_TRANS</strong> (Bit 7) to 1 (Start Transaction)</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>putreg32(0x80, R_RSB_BASE_ADDRESS + RSB_CTRL);</code></pre></div></li>
<li>
<p>Wait for <strong>RSB Status</strong></p>
<p><a href="https://lupyuen.github.io/articles/de#wait-for-rsb-status">(See this)</a></p>
<div class="example-wrap"><pre class="language-zig"><code>return rsb_wait_stat(&quot;Write RSB&quot;);</code></pre></div></li>
</ol>
<p>Here‚Äôs our implementation in Zig: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/pmic.zig#L244-L282">pmic.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// Write a byte to Reduced Serial Bus.
/// Returns -1 on error.
fn rsb_write(
  rt_addr: u8, 
  reg_addr: u8, 
  value: u8
) i32 {
  // Write a byte
  debug(&quot;  rsb_write: rt_addr=0x{x}, reg_addr=0x{x}, value=0x{x}&quot;, .{ rt_addr, reg_addr, value });
  const rt_addr_shift: u32 = @intCast(u32, rt_addr) &lt;&lt; 16;
  putreg32(RSBCMD_WR8,    R_RSB_BASE_ADDRESS + RSB_CMD);   // TODO: DMB
  putreg32(rt_addr_shift, R_RSB_BASE_ADDRESS + RSB_DAR);   // TODO: DMB
  putreg32(reg_addr,      R_RSB_BASE_ADDRESS + RSB_AR);    // TODO: DMB
  putreg32(value,         R_RSB_BASE_ADDRESS + RSB_DATA);  // TODO: DMB

  // Start transaction
  putreg32(0x80,          R_RSB_BASE_ADDRESS + RSB_CTRL);  // TODO: DMB
  return rsb_wait_stat(&quot;Write RSB&quot;);
}</code></pre></div><h2 id="wait-for-rsb-status"><a href="#wait-for-rsb-status">19.3 Wait for RSB Status</a></h2>
<p><strong>To wait for status</strong> of Reduced Serial Bus‚Ä¶</p>
<ol>
<li>
<p><strong>RSB Control Register</strong> (RSB_CTRL) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 923)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x0000</code></strong></li>
<li>Wait for <strong>START_TRANS</strong> (Bit 7) to be 0 (Transaction Completed or Error)</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>const ret = rsb_wait_bit(desc, RSB_CTRL, 1 &lt;&lt; 7);
if (ret != 0) {
  debug(&quot;rsb_wait_stat Timeout ({s})&quot;, .{ desc });
  return ret;
}</code></pre></div></li>
<li>
<p><strong>RSB Status Register</strong> (RSB_STAT) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 924)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x000c</code></strong> </li>
<li>If <strong>TRANS_OVER</strong> (Bit 0) is 1, then RSB Transfer has completed without error</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>const reg = getreg32(R_RSB_BASE_ADDRESS + RSB_STAT);
if (reg == 0x01) { return 0; }
return -1;</code></pre></div></li>
</ol>
<p>Here‚Äôs our implementation in Zig: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/pmic.zig#L282-L306">pmic.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// Wait for Reduced Serial Bus and read Status.
/// Returns -1 on error.
fn rsb_wait_stat(
  desc: []const u8
) i32 {
  const ret = rsb_wait_bit(desc, RSB_CTRL, 1 &lt;&lt; 7);
  if (ret != 0) {
    debug(&quot;rsb_wait_stat Timeout ({s})&quot;, .{ desc });
    return ret;
  }

  const reg = getreg32(R_RSB_BASE_ADDRESS + RSB_STAT);
  if (reg == 0x01) { return 0; }

  debug(&quot;rsb_wait_stat Error ({s}): 0x{x}&quot;, .{ desc, reg });
  return -1;
}</code></pre></div><h2 id="wait-for-rsb-transaction"><a href="#wait-for-rsb-transaction">19.4 Wait for RSB Transaction</a></h2>
<p><strong>To wait for completion</strong> of Reduced Serial Bus Transaction‚Ä¶</p>
<ol>
<li>
<p><strong>RSB Control Register</strong> (RSB_CTRL) <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A80_User_Manual_v1.3.1_20150513.pdf">(A80 Page 923)</a></p>
<ul>
<li>At RSB Offset <strong><code>0x0000</code></strong></li>
<li>Wait for <strong>START_TRANS</strong> (Bit 7) to be 0 (Transaction Completed or Error)</li>
</ul>
<div class="example-wrap"><pre class="language-zig"><code>// `offset` is RSB_CTRL
// `mask`   is 1 &lt;&lt; 7
const reg = getreg32(R_RSB_BASE_ADDRESS + offset); 
if (reg &amp; mask == 0) { break; }  // Return 0</code></pre></div></li>
</ol>
<p>Here‚Äôs our implementation in Zig: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/pmic.zig#L306-L336">pmic.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>/// Wait for Reduced Serial Bus Transaction to complete
/// Returns -1 on error.
/// `offset` is RSB_CTRL
/// `mask`   is 1 &lt;&lt; 7
fn rsb_wait_bit(
  desc: []const u8,
  offset: u32, 
  mask: u32
) i32 {
  // Wait for transaction to complete
  var tries: u32 = 100000;
  while (true) {
    // `offset` is RSB_CTRL
    // `mask`   is 1 &lt;&lt; 7
    const reg = getreg32(R_RSB_BASE_ADDRESS + offset); 
    if (reg &amp; mask == 0) { break; }

    // Check for transaction timeout
    tries -= 1;
    if (tries == 0) {
      debug(&quot;rsb_wait_bit Timeout ({s})&quot;, .{ desc });
      return -1;
    }
  }
  return 0;
}</code></pre></div>
<p>Check out the <a href="https://forum.pine64.org/showthread.php?tid=406&amp;pid=3160"><strong>Notes on PinePhone‚Äôs Reduced Serial Bus</strong></a>.</p>

    
</body>
</html>