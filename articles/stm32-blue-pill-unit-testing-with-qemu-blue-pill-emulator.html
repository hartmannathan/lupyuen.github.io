<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="/_static/css/banner-styles.css?v=bsmaklHF" />
  <link rel="stylesheet" type="text/css" href="/_static/css/iconochive.css?v=qtvMKcIJ" />
  <link rel="canonical" href="https://lupyuen.org/articles/stm32-blue-pill-unit-testing-with-qemu-blue-pill-emulator.html" />
  <!-- End Wayback Rewrite JS Include -->
  <title data-rh="true">STM32 Blue Pill — Unit Testing with Qemu Blue Pill Emulator | by Lup Yuen Lee 李立源 | Medium
  </title>
  <meta data-rh="true" charset="utf-8" />
  <meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
  <meta data-rh="true" name="theme-color" content="#000000" />
  <meta data-rh="true" property="og:type" content="article" />
  <meta data-rh="true" property="article:published_time" content="2019-02-10T10:16:11.646Z" />
  <meta data-rh="true" name="title"
    content="STM32 Blue Pill — Unit Testing with Qemu Blue Pill Emulator | by Lup Yuen Lee 李立源 | Medium" />
  <meta data-rh="true" property="og:title" content="STM32 Blue Pill — Unit Testing with Qemu Blue Pill Emulator" />
  <meta data-rh="true" property="twitter:title" content="STM32 Blue Pill — Unit Testing with Qemu Blue Pill Emulator" />
  <meta data-rh="true" name="description"
    content="Unit Testing can help to stop bugs before they pollute the entire IoT chain" />
  <meta data-rh="true" property="og:description"
    content="Unit Testing can help to stop bugs before they pollute the entire IoT chain" />
  <meta data-rh="true" property="twitter:description"
    content="Unit Testing can help to stop bugs before they pollute the entire IoT chain" />
  <meta data-rh="true" name="twitter:card" content="summary_large_image" />
  <meta data-rh="true" name="twitter:creator" content="@MisterTechBlog" />
  <meta data-rh="true" name="author" content="Lup Yuen Lee 李立源" />
  <meta data-rh="true" name="robots" content="index,follow,max-image-preview:large" />
  <meta data-rh="true" name="referrer" content="unsafe-url" />
  <meta data-rh="true" name="twitter:label1" value="Reading time" />
  <meta data-rh="true" name="twitter:data1" value="12 min read" />
  <meta property="og:image" 
  content="https://lupyuen.github.io/images/legacy2/l1.png">

<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">

<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->

</head>

<body>
  <div id="root">
    <div class="a b c">
      <article class="meteredContent">
        <section class="cl cm cn co ai cp cq r"></section><span class="r"></span>
        <div>
          <div class="s u cr cs ct cu"></div>
          <section class="cv cw cx cy cz">
            <div class="da ai">
              <div class="figure db da ai paragraph-image">

                
                <p><img src="https://lupyuen.github.io/images/legacy2/l1.png" /></p>


               
              </div>
            </div>
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <div>
                  <h1 id="f9cc" class="du dv cd dw b dx dy dz ea eb ec ed ee ef eg eh ei ej ek el em ap">STM32 Blue Pill
                    — Unit Testing with Qemu Blue Pill Emulator</h1>
                  <div class="en">
                    <div class="n eo ep eq er">
                      <div class="o n">
                        <div><a rel="noopener"
                            href="https://lupyuen.github.io">
                            <div class="de es et">
                              <div class="bf n eu o p s ev ew ex ey ez cu"></div>
                              
                            </div>
                          </a></div>
                        <div class="fb ai r">
                          <div class="n">
                            <div style="flex:1"><span class="cc b cd ce cf cg r ap q">
                                <div class="fc n o fd"><span class="cc fe ff ce av fg fh as at au ap"><a
                                      class="bw bx bg bh bi bj bk bl bm bn fi bq ca cb" rel="noopener"
                                      href="https://lupyuen.github.io">Lup
                                      Yuen Lee 李立源</a></span>
                               
                                </div>
                              </span></div>
                          </div><span class="cc b cd ce cf cg r ch ci"><span class="cc fe ff ce av fg fh as at au ch">
                              <div><a class="bw bx bg bh bi bj bk bl bm bn fi bq ca cb" rel="noopener"
                                  href="https://lupyuen.github.io/articles/stm32-blue-pill-unit-testing-with-qemu-blue-pill-emulator">
                                  7 Feb 2019</a> <!-- -->·
                                <!-- -->
                                <!-- -->12
                                <!-- --> min read<span style="padding-left:4px"></span>
                              </div>
                            </span></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <blockquote class="gu gv gw">
                  <p id="a41e" class="gx gy gz ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">The year is
                    2029. Humans are populating the Moon, starting at Moon Base One. Two Moon Base Operators observe
                    something highly unusual in the crop garden of beautiful red tomatoes…</p>
                  <p id="3d94" class="gx gy gz ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Operator 1:
                    WHAT’S WITH THE SPRINKLERS !!! They were working fine a moment ago… if the sprinklers keep spraying
                    like this, our tomato crop will be ruined!</p>
                  <p id="588f" class="gx gy gz ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Operator 2:
                    You know there’s something strange going on… I can feel it… Some alien presence controlling our
                    sprinklers…</p>
                  <p id="8556" class="gx gy gz ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Operator 1:
                    Our IoT Dashboards have gone nuts! Why are we getting negative values for some Humidity Sensors?
                    Wait… did you roll out firmware updates for our STM32-BLUER-PILL Monitoring Devices?</p>
                  <p id="84ac" class="gx gy gz ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Operator 2:
                    We replaced a thousand BLUER-PILL devices by STM32-BLUEST-PILL just now. We flashed the <strong
                      class="ha hr">old BLUER-PILL firmware onto the new BLUEST-PILL devices</strong>. I’m 100% certain
                    it works!</p>
                  <p id="8bb3" class="gx gy gz ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Operator 1: I
                    don’t see any records of Unit Testing…<strong class="ha hr"> Didn’t you run the Embedded Unit Tests
                      after flashing?</strong></p>
                  <p id="47ca" class="gx gy gz ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Operator 2:
                    Uh what’s Embedded Unit Testing? They never taught that in school… oh wait I remember now… <strong
                      class="ha hr">BLUEST-PILL comes with a new BME281 Humidity Sensor that works a little differently
                      from the old BME280 sensor</strong>… Yep our firmware is bad…</p>
                  <p id="95b6" class="gx gy gz ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Operator 1:
                    NOOOOOOO! Our tomatoes are turning to MUSH !!!</p>
                </blockquote>
              </div>
            </div>
          </section>
          <hr class="hs fe ht hu hv hw hx hy hz ia ib ic" />
          <section class="cv cw cx cy cz">
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <p id="e44d" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Computing
                  sensor values in IoT devices can be prone to bugs… And <strong class="ha hr">Unit Testing</strong> can
                  help to stop the bugs before they pollute the entire IoT chain. Check out <a
                    href="https://github.com/finitespace/BME280/blob/master/src/BME280.cpp"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">this complicated computation</a>…
                </p>
                <div class="figure ii ij ik il im da cn co paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/l2.jpeg" /></p>
  
  
               
                  <figcaption><p><em>BME280 Humidity Sensor Computation. From <a
                      href="https://github.com/finitespace/BME280/blob/master/src/BME280.cpp"
                      class="bw gc id ie if ig" target="_blank"
                      rel="noopener nofollow">https://github.com/finitespace/BME280/blob/master/src/BME280.cpp</a>
                  </em></p></figcaption>
                </div>
                <p id="2e24" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">This is the
                  actual function used to compute the ambient humidity for the <a
                    href="https://cdn-shop.adafruit.com/datasheets/BST-BMP280-DS001-11.pdf"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow"><strong class="ha hr">BME280
                      Humidity Sensor</strong></a><strong class="ha hr"> </strong>(just like the story). It’s hard to
                  figure out whether this function computes the humidity correctly given the sensor’s register values
                  (<code class="dm ir is it iu b">m_dig[]</code>).</p>
                <p id="e40b" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">With Unit
                  Testing we can <strong class="ha hr">plug in specific input values and verify that the output value is
                    correct</strong>. When we repeat this verification for many sets of input and output values (called
                  <strong class="ha hr">Test Cases</strong>), we will be <strong class="ha hr">more confident that the
                    function is correct</strong>. Say farewell to Mushy Moon Tomatoes as we learn…</p>
                <ol class="">
                  <li id="5b8d" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq iv iw ix ap">What’s
                    a <strong class="ha hr">Test Case</strong> and <strong class="ha hr">Test Suite</strong></li>
                  <li id="8db4" class="gx gy cd ha b hb iy hd he iz hg hh ja hj hk jb hm hn jc hp hq iv iw ix ap">
                    <strong class="ha hr">Qemu</strong>, the Blue Pill Emulator</li>
                  <li id="8a87" class="gx gy cd ha b hb iy hd he iz hg hh ja hj hk jb hm hn jc hp hq iv iw ix ap">How I
                    used Qemu for <strong class="ha hr">Automated Unit Testing</strong></li>
                  <li id="d439" class="gx gy cd ha b hb iy hd he iz hg hh ja hj hk jb hm hn jc hp hq iv iw ix ap">
                    <strong class="ha hr">Side Effects</strong> in Unit Testing</li>
                  <li id="b222" class="gx gy cd ha b hb iy hd he iz hg hh ja hj hk jb hm hn jc hp hq iv iw ix ap">
                    <strong class="ha hr">Floating-point precision</strong> in Unit Testing and <strong
                      class="ha hr">Test Coverage</strong></li>
                </ol>
              </div>
            </div>
          </section>
          <hr class="hs fe ht hu hv hw hx hy hz ia ib ic" />
          <section class="cv cw cx cy cz">
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <div class="ii ij ik il im jd"><a
                    href="http://www.throwtheswitch.org/unity"
                    target="_blank" rel="noopener nofollow">
                    <div class="je n bv">
                      <div class="jf n jg p jh ji">
                        <h2 class="cc jj jk jl av jm fh as jn au ap">Unity - Throw The Switch</h2>
                      </div>
                    </div>
                  </a></div>
                <h1 id="667d" class="jr js cd cc jj jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ap">What’s A Test
                  Case?</h1>
                <p id="543f" class="gx gy cd ha b hb kj hd he kk hg hh kl hj hk km hm hn kn hp hq cv ap">We’ll use the
                  <a href="http://www.throwtheswitch.org/unity"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">Unity Unit Test Library</a> (not
                  the game toolkit). Here’s a <a
                    href="https://github.com/lupyuen/stm32bluepill-unittest/blob/master/lib/nano-float/test/test.c#L66"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">simple<strong class="ha hr"> Test
                      Case</strong></a> that divides two numbers and verifies the result…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="fbed" class="ap kr js cd iu b ff ks kt r ku">x = 2205.1969;  <br/>y = 270.8886;   <br/>r = x / y;                       <br/>TEST_ASSERT_EQUAL_DOUBLE( 8.140604292687105, r );</span></pre>
                <p id="bba9" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap"><code
                    class="dm ir is it iu b">TEST_ASSERT_EQUAL_DOUBLE()</code> is a macro from the Unity library that
                  compares the <strong class="ha hr">Expected Result</strong> <code
                    class="dm ir is it iu b">8.14…</code> with the <strong class="ha hr">Actual Result</strong> <code
                    class="dm ir is it iu b">r</code>. If the Expected and Actual Results (of type <code
                    class="dm ir is it iu b">double</code>) are not the same, the Unity library flags the Test Case as
                  <code class="dm ir is it iu b"><strong class="ha hr">FAILED</strong></code>. So that we can
                  troubleshoot and fix the problem.</p>
                <p id="86bc" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">We have just
                  seen a trivial Test Case. Usually we’ll be verifying the <strong class="ha hr">output of a function
                    given some inputs</strong> like this…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="1d62" class="ap kr js cd iu b ff ks kt r ku">x = 2205.1969;  <br/>y = 270.8886;   <br/>r = <strong class="iu hr">__wrap___aeabi_ddiv</strong>(x, y);   <br/>TEST_ASSERT_EQUAL_DOUBLE( 8.140604292687105  , r );</span></pre>
                <p id="ff51" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Here we are
                  testing a function <code class="dm ir is it iu b">__wrap___aeabi_ddiv()</code>. We don’t really know
                  what the function does, but we expect it to behave like the division of two <code
                    class="dm ir is it iu b">doubles</code>. So we can call Unity to verify the same Expected and Actual
                  Results.</p>
                <p id="dbc6" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Besides
                  comparing doubles, <a
                    href="http://www.throwtheswitch.org/unity"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">Unity supports other types</a> as
                  well, like…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="6159" class="ap kr js cd iu b ff ks kt r ku">TEST_ASSERT_EQUAL_INT(    a,        2 );<br/>TEST_ASSERT_EQUAL_FLOAT(  pi,       3.45 );<br/>TEST_ASSERT_EQUAL_STRING( greeting, &quot;Attention, Dr. Surly&quot; );</span></pre>
              </div>
            </div>
          </section>
          <hr class="hs fe ht hu hv hw hx hy hz ia ib ic" />
          <section class="cv cw cx cy cz">
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <h1 id="8b83" class="jr js cd cc jj jt kv jv jw kw jy jz kx kb kc ky ke kf kz kh ki ap">What’s A Test
                  Suite?</h1>
                <p id="d069" class="gx gy cd ha b hb kj hd he kk hg hh kl hj hk km hm hn kn hp hq cv ap">The more Test
                  Cases we write, the more confident we’ll be that the tested function works correctly. When we group
                  the related Test Cases into a function, we get a <strong class="ha hr">Test Suite</strong> like this…
                </p>
                <div class="figure ii ij ik il im da">
              
                  <p><script src="https://gist.github.com/lupyuen/6668e8d5dbd714d3174e9864c5fdfced.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-unittest/blob/master/lib/nano-float/test/test.c#L64-L71"
                      class="bw gc id ie if ig" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-unittest/blob/master/lib/nano-float/test/test.c#L64-L71</a>
                  </em></p></figcaption>
                </div>
                <p id="b71b" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">To run the Test
                  Suites, we call their functions <a
                    href="https://github.com/lupyuen/stm32bluepill-unittest/blob/master/lib/nano-float/test/test.c#L428-L481"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">like this</a>…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="b4dc" class="ap kr js cd iu b ff ks kt r ku">int test_nanofloat(void) {<br/>    //  Run unit tests.<br/>    UNITY_BEGIN();<br/>    RUN_TEST(test_aeabi_ddiv);<br/>    RUN_TEST(test_aeabi_dmul);<br/>    RUN_TEST(test_aeabi_dadd);<br/>    RUN_TEST(test_aeabi_dsub);<br/>    ...<br/>    UNITY_END();</span></pre>
                <p id="74c7" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Calling <code
                    class="dm ir is it iu b">test_nanofloat()</code> will execute all the Test Suites for our <code
                    class="dm ir is it iu b">nano-float</code> library. Where do we call <code
                    class="dm ir is it iu b">test_nanofloat()</code>?</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="a122" class="ap kr js cd iu b ff ks kt r ku">#include &lt;logger.h&gt;<br/>#ifdef UNIT_TEST<br/>extern int test_nanofloat(void);<br/>#endif</span><span id="7c53" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">int main(void)<br/>{ <br/> enable_log(); //  Enable logging via Arm Semihosting. <br/>               //  Note: ST Link must be connected.</span><span id="c737" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">#ifdef UNIT_TEST<br/> test_nanofloat();<br/>#endif</span><span id="a034" class="ap kr js cd iu b ff lb lc ld le lf kt r ku"> debug_force_flush();   //  Flush the debug buffer before we halt.<br/> for (;;) {}            //  Loop forever.<br/>}</span><span id="7028" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">#ifdef UNIT_TEST<br/>#include &quot;../lib/nano-float/test/test.c&quot;<br/>#endif</span></pre>
                <p id="f0be" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">I prefer to
                  call <code class="dm ir is it iu b">test_nanofloat()</code> <a
                    href="https://github.com/lupyuen/stm32bluepill-unittest/blob/master/src/main.c"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">from the </a><code
                    class="dm ir is it iu b"><a href="https://github.com/lupyuen/stm32bluepill-unittest/blob/master/src/main.c" class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">main()</a></code><a
                    href="https://github.com/lupyuen/stm32bluepill-unittest/blob/master/src/main.c"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow"> function</a>, surrounded by <code
                    class="dm ir is it iu b">#ifdef UNIT_TEST</code>. So the unit test code will not be compiled into
                  the embedded program unless we define <code class="dm ir is it iu b">UNIT_TEST</code>.</p>
                <p id="b288" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap"><code
                    class="dm ir is it iu b">UNIT_TEST</code> is defined as a compiler option in <code
                    class="dm ir is it iu b"><a href="https://github.com/lupyuen/stm32bluepill-unittest/blob/master/platformio.ini" class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">platformio.ini</a></code>…
                </p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="0ba4" class="ap kr js cd iu b ff ks kt r ku">[env:bluepill_f103c8]<br/>...<br/>build_flags = <br/><strong class="iu hr">    ; Enable unit test. Comment this line to disable unit test.<br/>    -D UNIT_TEST</strong><br/>    -D UNITY_FLOAT_PRECISION=0.000001 <br/>    -D UNITY_DOUBLE_PRECISION=0.000001<br/>    -D UNITY_OUTPUT_CHAR=unity_output_char <br/>    -D UNITY_INCLUDE_DOUBLE <br/>    -D UNITY_EXCLUDE_SETJMP_H <br/>    -D UNITY_EXCLUDE_MATH_H</span></pre>
                <p id="a427" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">And that’s how
                  the <code class="dm ir is it iu b">main()</code> function executes all our Test Cases. We’ll cover the
                  <code class="dm ir is it iu b">UNITY_FLOAT_PRECISION</code> and <code
                    class="dm ir is it iu b">UNITY_DOUBLE_PRECISION</code> options in a while.</p>
                <p id="2ae5" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">When we run the
                  complete Unit Test it looks like this… (Click “CC” to view the annotations)</p>
              </div>
            </div>
            <div class="da ai">
              <div class="figure ii ij ik il im da">
              
                <p><a href="https://youtu.be/Vt8TcZCljWU">[Watch video on YouTube]</a></p>


                <figcaption><p><em>Running Blue Pill Unit Tests. Click “CC” to view
                  the annotations.</em></p></figcaption>
              </div>
            </div>
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <p id="f321" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">If any of the
                  Test Cases failed, you’ll see a <code class="dm ir is it iu b">FAILED</code> message. Control-click
                  the failed Test Case to jump to the line that failed… (Click “CC” to view the annotations)</p>
              </div>
            </div>
            <div class="da ai">
              <div class="figure ii ij ik il im da">
             
                <p><a href="https://youtu.be/EHjKaW9eTuo">[Watch video on YouTube]</a></p>


                <figcaption><p><em>Failed Blue Pill Unit Test. Click “CC” to view
                  the annotations.</em></p></figcaption>
              </div>
            </div>
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <h1 id="f777" class="jr js cd cc jj jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ap">Automated Unit
                  Tests</h1>
                <p id="ed6b" class="gx gy cd ha b hb kj hd he kk hg hh kl hj hk km hm hn kn hp hq cv ap">The code above
                  includes over 200 Test Cases. Which is typical for Unit Testing because we try to be thorough in our
                  testing with all kinds of inputs. But running a few hundred Test Cases on a real microcontroller (like
                  Blue Pill) may slow down our embedded development.</p>
                <p id="2942" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">What if we
                  could have a “Virtual” Blue Pill that’s emulated on Windows or macOS? A Windows or macOS program that
                  pretends to be a real Blue Pill, runs the same programs as a real Blue Pill, even pretends to have the
                  same LED, Timers, GPIO, … like a real Blue Pill?</p>
                <p id="289a" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Because it
                  emulates a Blue Pill, we could use it to run Unit Tests again and again. We could run the Unit Tests
                  automatically whenever we update our Blue Pill program… That would be really helpful right?</p>
                <p id="9cb9" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Fortunately the
                  “Virtual” Blue Pill actually exists: It’s called the <a
                    href="http://beckus.github.io/qemu_stm32/"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow"><strong class="ha hr">Qemu Blue
                      Pill Emulator</strong></a>. That’s what we saw in the videos above. There was no physical Blue
                  Pill connected in the demos that we saw. The installation requires a few steps so let’s walk through
                  the steps…</p>
              </div>
            </div>
          </section>
          <hr class="hs fe ht hu hv hw hx hy hz ia ib ic" />
          <section class="cv cw cx cy cz">
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <h1 id="4970" class="jr js cd cc jj jt kv jv jw kw jy jz kx kb kc ky ke kf kz kh ki ap">Install Qemu
                  Blue Pill Emulator</h1>
                <blockquote class="lh">
                  <p id="3714" class="li lj cd dw b lk ll lm ln lo lp hq ch">For Windows:</p>
                </blockquote>
                <p id="a653" class="gx gy cd ha b hb lq hd he lr hg hh ls hj hk lt hm hn lu hp hq cv ap">1️⃣ Install <a
                    href="https://docs.microsoft.com/en-us/windows/wsl/install-win10"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">Windows Subsystem for Linux</a>.
                  Choose Ubuntu.</p>
                <p id="da39" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">2️⃣ Click <code
                    class="dm ir is it iu b">Start → Bash on Ubuntu on Windows</code></p>
                <p id="dc63" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">3️⃣ At the
                  <code class="dm ir is it iu b">bash</code> command prompt, enter these commands…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="b313" class="ap kr js cd iu b ff ks kt r ku">cd /mnt/c</span><span id="b9ff" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">git clone <!-- -->https://github.com/beckus/qemu_stm32.git</span><span id="18d4" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">cd <!-- -->qemu_stm32</span><span id="8bc9" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">sudo apt install libglib2.0-dev</span><span id="6383" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">git submodule update --init pixman</span><span id="5c44" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">git submodule update --init dtc</span><span id="e96f" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">./configure --enable-debug --target-list=&quot;arm-softmmu&quot;</span><span id="5aab" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">make</span></pre>
                <p id="57f5" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">This installs
                  Qemu into the folder <code class="dm ir is it iu b">C:\qemu_stm32</code></p>
                <blockquote class="lh">
                  <p id="1661" class="li lj cd dw b lk lv lw lx ly lz hq ch">For macOS:</p>
                </blockquote>
                <p id="913b" class="gx gy cd ha b hb lq hd he lr hg hh ls hj hk lt hm hn lu hp hq cv ap">1️⃣ I<a
                    href="https://www.macports.org/"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">nstall MacPorts</a></p>
                <p id="025e" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">2️⃣ Open a
                  command prompt and enter these commands…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="490d" class="ap kr js cd iu b ff ks kt r ku">cd ~</span><span id="f26d" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">git clone <a href="https://github.com/beckus/qemu_stm32.git" class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">https://github.com/beckus/qemu_stm32.git</a></span><span id="6aa4" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">cd <!-- -->qemu_stm32</span><span id="ffad" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">sudo port install glib2-devel</span><span id="4007" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">git submodule update --init pixman</span><span id="ce72" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">git submodule update --init dtc</span><span id="e8a7" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">./configure --enable-debug \<br/>  --target-list=”arm-softmmu” \<br/>  --python=python2 \<br/>  --disable-cocoa</span><span id="cffe" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">make<!-- --> </span></pre>
                <p id="9a7d" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">For the <code
                    class="dm ir is it iu b">configure</code> step we assume Python version 2 is installed as <code
                    class="dm ir is it iu b">python2</code></p>
                <p id="77c9" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">This installs
                  Qemu into the folder <code class="dm ir is it iu b">qemu_stm32</code> located at your Home folder.</p>
              </div>
            </div>
          </section>
          <hr class="hs fe ht hu hv hw hx hy hz ia ib ic" />
          <section class="cv cw cx cy cz">
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <h1 id="e561" class="jr js cd cc jj jt kv jv jw kw jy jz kx kb kc ky ke kf kz kh ki ap">Run Unit Tests
                  With Qemu Emulator</h1>
                <p id="1ff0" class="gx gy cd ha b hb kj hd he kk hg hh kl hj hk km hm hn kn hp hq cv ap">The easiest way
                  to compile a Blue Pill program and start it with the Qemu Blue Pill Emulator is to use Visual Studio
                  Code with the PlatformIO Extension. We’ll now download the Test Cases shown in the demo and run them
                  with Qemu…</p>
                <p id="c5a5" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">1️⃣ <strong
                    class="ha hr">For Windows only</strong>: Click <code
                    class="dm ir is it iu b"><strong class="ha hr">Start → Bash on Ubuntu on Windows</strong></code>.
                  Enter…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="c1cd" class="ap kr js cd iu b ff ks kt r ku">cd /mnt/c<br/>git clone https://github.com/lupyuen/stm32bluepill-unittest</span></pre>
                <p id="3a2a" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">2️⃣ <strong
                    class="ha hr">For macOS only</strong>: Open a macOS command prompt. Enter…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="e57b" class="ap kr js cd iu b ff ks kt r ku">cd ~<br/>git clone https://github.com/lupyuen/stm32bluepill-unittest</span></pre>
                <p id="b0de" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">3️⃣ Install
                  <strong class="ha hr">Visual Studio Code</strong> for Windows or macOS from <code
                    class="dm ir is it iu b"><a href="https://code.visualstudio.com/Download" class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">https://code.visualstudio.com/Download</a></code>
                </p>
                <p id="b365" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">4️⃣ Launch
                  <strong class="ha hr">Visual Studio Code</strong>. <br />Install the <strong class="ha hr">PlatformIO
                    Extension</strong>.<br /><a
                    href="https://web.archive.org/web/20200717195257/https://youtu.be/hgS7ysuAiHc"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">Check this video</a> for the
                  PlatformIO installation. Click “CC” to view the instructions.</p>
                <p id="9a1b" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">5️⃣ Click <code
                    class="dm ir is it iu b"><strong class="ha hr">File → Open</strong><br/></code>Browse to the <code
                    class="dm ir is it iu b">C:\</code> folder (for Windows) or the Home folder (for macOS)<br />Select
                  the folder<code class="dm ir is it iu b"><strong class="ha hr">stm32bluepill-unittest</strong></code>
                </p>
                <p id="dc46" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">6️⃣ Click the
                  “<strong class="ha hr">PlaformIO Build</strong>” command (the ☑️ button at the lower left)</p>
                <div class="figure ii ij ik il im da cn co paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/l3.png" /></p>
  
                  <figcaption><p><em>Command buttons in the status bar</em></p></figcaption>
                </div>
                <p id="d693" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">7️⃣ Click <code
                    class="dm ir is it iu b"><strong class="ha hr">Tasks → Run Task → 🔗 Emulate STM32 Blue Pill</strong></code>
                </p>
                <p id="5838" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">This starts the
                  Qemu emulator and executes the Blue Pill program, which contains our Test Cases. We should see a log
                  like this to indicate that the Qemu Blue Pill Emulator has executed all the Test Cases successfully…
                </p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="202c" class="ap kr js cd iu b ff ks kt r ku">&gt; Executing task: bash -c &#x27;../qemu_stm32/arm-softmmu/qemu-system-arm<br/>-M stm32-f103c8 -semihosting <br/>-kernel .pioenvs/bluepill_f103c8/firmware.bin&#x27; &lt;<br/>Starting...<br/>src\../lib/nano-float/test/test.c:433:test_aeabi_ddiv:PASS<br/>src\../lib/nano-float/test/test.c:434:test_aeabi_dmul:PASS<br/>src\../lib/nano-float/test/test.c:435:test_aeabi_dadd:PASS<br/>src\../lib/nano-float/test/test.c:436:test_aeabi_dsub:PASS<br/>...<br/>45 Tests 0 Failures 0 Ignored<br/>All functions called<br/>Usage: 01 &gt; 04 / 02 &gt; 04 / 03 &gt; 04 / 04 &gt; 04 ...<br/>Done</span></pre>
              </div>
            </div>
          </section>
          <hr class="hs fe ht hu hv hw hx hy hz ia ib ic" />
          <section class="cv cw cx cy cz">
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <h1 id="3908" class="jr js cd cc jj jt kv jv jw kw jy jz kx kb kc ky ke kf kz kh ki ap">How Does Qemu
                  Emulator Work?</h1>
                <p id="2b59" class="gx gy cd ha b hb kj hd he kk hg hh kl hj hk km hm hn kn hp hq cv ap">How did the
                  Qemu Emulator get started in Visual Studio Code? We clicked the <code
                    class="dm ir is it iu b">🔗 Emulate STM32 Blue Pill</code> Task, which is defined in the
                  configuration file <code
                    class="dm ir is it iu b"><a href="https://web.archive.org/web/20200717195257/https://github.com/lupyuen/stm32bluepill-unittest/blob/master/.vscode/tasks.json" class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">.vscode/tasks.json</a></code>…
                </p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="ec0c" class="ap kr js cd iu b ff ks kt r ku">&quot;label&quot;: &quot;🔗 Emulate STM32 Blue Pill&quot;,<br/>&quot;type&quot;: &quot;shell&quot;,<br/>&quot;options&quot;: {<br/>  &quot;cwd&quot;: &quot;${workspaceFolder}&quot;<br/>},<br/>&quot;windows&quot;: {<br/>  &quot;command&quot;: &quot;bash&quot;,<br/>  &quot;args&quot;: [<br/>    &quot;-c&quot;,<br/>    &quot;../qemu_stm32/arm-softmmu/qemu-system-arm -M stm32-f103c8 -semihosting -kernel .pioenvs/bluepill_f103c8/firmware.bin&quot;<br/>  ]<br/>},<br/>&quot;osx&quot;: {<br/>  &quot;command&quot;: &quot;../qemu_stm32/arm-softmmu/qemu-system-arm -M stm32-f103c8 -semihosting -kernel .pioenvs/bluepill_f103c8/firmware.bin&quot;<br/>}</span></pre>
                <p id="fd64" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">From the Task
                  definition, we see that the command line for starting Qemu looks like this…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="404d" class="ap kr js cd iu b ff ks kt r ku">../qemu_stm32/arm-softmmu/qemu-system-arm \<br/>    -M stm32-f103c8 \<br/>    -semihosting \<br/>    -kernel .pioenvs/bluepill_f103c8/firmware.bin</span></pre>
                <p id="bf83" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">1️⃣ <code
                    class="dm ir is it iu b"><strong class="ha hr">qemu-system-arm</strong></code>: This is the Windows
                  or macOS executable that emulates the Blue Pill. It’s a highly complex Windows or macOS program that
                  can execute Blue Pill machine code (Arm Cortex-M3), read and write to simulated RAM and ROM, and
                  access Blue Pill peripherals (like the Blue Pill onboard LED) simulated in software.</p>
                <p id="e85e" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">2️⃣ <code
                    class="dm ir is it iu b"><strong class="ha hr">-M stm32-f103c8</strong></code>: Emulate the Blue
                  Pill microcontroller (STM32F103C8)</p>
                <p id="599c" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">3️⃣ <code
                    class="dm ir is it iu b"><strong class="ha hr">-semihosting</strong></code>: The Logging library in
                  our program uses Arm Semihosting to display console messages. This option enables the display of Arm
                  Semihosting messages.</p>
                <p id="4027" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">4️⃣ <code
                    class="dm ir is it iu b"><strong class="ha hr">-kernel .pioenvs/bluepill_f103c8/firmware.bin</strong></code>:
                  Specifies the Blue Pill ROM image that will be “flashed” into the emulated Blue Pill ROM for
                  execution. The <code class="dm ir is it iu b">firmware.bin</code> file contains the executable code
                  and data of our Blue Pill program, produced by the <code class="dm ir is it iu b">gcc</code> compiler
                  during the PlatformIO Build step<strong class="ha hr">.</strong></p>
                <p id="8a8f" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Qemu Blue Pill
                  Emulator is still under development but it’s already great for running computation-based Unit Tests.
                  What about other types of Unit Tests with sensors and actuators?</p>
              </div>
            </div>
          </section>
          <hr class="hs fe ht hu hv hw hx hy hz ia ib ic" />
          <section class="cv cw cx cy cz">
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <h1 id="da8d" class="jr js cd cc jj jt kv jv jw kw jy jz kx kb kc ky ke kf kz kh ki ap">Beware Of Side
                  Effects</h1>
                <p id="08a1" class="gx gy cd ha b hb kj hd he kk hg hh kl hj hk km hm hn kn hp hq cv ap">When a Blue
                  Pill program accesses some sensor or actuator, we say that the program causes a <a
                    href="https://web.archive.org/web/20200717195257/https://en.wikipedia.org/wiki/Side_effect_(computer_science)"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow"><strong class="ha hr">Side
                      Effect</strong></a>. Programs with Side Effects are <strong class="ha hr">harder to test</strong>
                  because we need to reset the sensor and actuator back to their original states before starting the
                  test.</p>
                <p id="27d7" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Just imagine
                  how we would test a program that uses a real BME280 Humidity Sensor… Before every test we would have
                  to <strong class="ha hr">reset the Humidity Sensor to a fixed value</strong>, because it affects the
                  outcome of the test. Automating a test that causes Side Effects is no longer possible if somebody
                  needs to tweak the sensor or actuator by hand.</p>
                <p id="17aa" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Qemu Blue Pill
                  Emulator <strong class="ha hr">may not be 100% accurate when emulating Timers, GPIOs, UART, I2C,
                    SPI,</strong> … So beware if we’re using these in our Unit Test. If our Unit Test is simply based on
                  some computation without Side Effects, it should run fine on the Qemu Emulator.</p>
              </div>
            </div>
          </section>
          <hr class="hs fe ht hu hv hw hx hy hz ia ib ic" />
          <section class="cv cw cx cy cz">
            <div class="da ai">
              <div class="figure ii ij ik il im da ai paragraph-image">
                
                <p><img src="https://lupyuen.github.io/images/legacy2/l4.png" /></p>


              
                <figcaption><p><em>nano-float unit tests automatically extracted
                  from the nano-float source code. From <a
                    href="https://docs.google.com/spreadsheets/d/1Uogm7SpgWVA4AiP6gqFkluaozFtlaEGMc4K2Mbfee7U/edit#gid=1740497564"
                    class="bw gc id ie if ig" target="_blank"
                    rel="noopener nofollow">https://docs.google.com/spreadsheets/d/1Uogm7SpgWVA4AiP6gqFkluaozFtlaEGMc4K2Mbfee7U/edit#gid=1740497564</a>
                </em></p></figcaption>
              </div>
            </div>
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <h1 id="dbbe" class="jr js cd cc jj jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ap">How I used Qemu
                  Emulator for Unit Testing</h1>
                <p id="13e9" class="gx gy cd ha b hb kj hd he kk hg hh kl hj hk km hm hn kn hp hq cv ap">The Test Cases
                  we have seen in the demo above are the real-life Test Cases I used for testing <code
                    class="dm ir is it iu b">nano-float</code>, a floating-point math library that’s optimised for Blue
                  Pill, taking up only a tiny fraction of the ROM space compared with the standard math library. I wrote
                  about <code class="dm ir is it iu b">nano-float</code> in <a class="bw gc id ie if ig" target="_blank"
                    rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-shrink-your-math-libraries-with-qfplib">my
                    previous article</a>.</p>
                <p id="da45" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">With over 200
                  Test Cases, writing the Unit Test code by hand will be tedious and hard to maintain. That’s why I
                  created a Google Sheets spreadsheet that generates the Unit Test code…</p>
                <div class="mc md me mf mg jd"><a
                    href="https://docs.google.com/spreadsheets/d/1Uogm7SpgWVA4AiP6gqFkluaozFtlaEGMc4K2Mbfee7U/edit#gid=1740497564"
                    target="_blank" rel="noopener nofollow">
                    <div class="je n bv">
                      <div class="jf n jg p jh ji">
                        <h2 class="cc jj jk jl av jm fh as jn au ap">nano-float Unit Test</h2>
                      </div>
                      <div class="mh r">
                        <div class="mi r mj mk ml mh mm ma jd"></div>
                      </div>
                    </div>
                  </a></div>
                <p id="747b" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">The spreadsheet
                  automatically extracts the Test Cases that I have embedded inside the <code
                    class="dm ir is it iu b">nano-float</code> library source code like this…</p>
                <div class="figure ii ij ik il im da cn co paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/l5.png" /></p>
  
  
                  <figcaption><p><em>nano-float library source code and the unit
                    test cases below. From <a
                      href="https://github.com/lupyuen/codal-libopencm3/blob/master/lib/nano-float/src/functions.c#L555-L585"
                      class="bw gc id ie if ig" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/codal-libopencm3/blob/master/lib/nano-float/src/functions.c#L555-L585</a>
                  </em></p></figcaption>
                </div>
                <p id="0f23" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">The spreadsheet
                  parses the Test Cases and generates Test Suites in this familiar format…</p>
                <div class="figure ii ij ik il im da cn co paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/l6.png" /></p>
  
  
               
                  <figcaption><p><em>Test Suite generated by the spreadsheet. From
                    <a href="https://github.com/lupyuen/stm32bluepill-unittest/blob/master/lib/nano-float/test/test.c#L332-L336"
                      class="bw gc id ie if ig" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-unittest/blob/master/lib/nano-float/test/test.c#L332-L336</a>
                  </em></p></figcaption>
                </div>
              </div>
            </div>
          </section>
          <hr class="hs fe ht hu hv hw hx hy hz ia ib ic" />
          <section class="cv cw cx cy cz">
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <pre
                  class="ii ij ik il im ko kp kq"><span id="5a12" class="ap kr js cd iu b ff ks kt r ku">[env:bluepill_f103c8]<br/>...<br/>build_flags = <br/>    ; Enable unit test. Comment this line to disable unit test.<br/>    -D UNIT_TEST<br/><strong class="iu hr">    -D UNITY_FLOAT_PRECISION=0.000001 <br/>    -D UNITY_DOUBLE_PRECISION=0.000001</strong><br/>    -D UNITY_OUTPUT_CHAR=unity_output_char <br/>    -D UNITY_INCLUDE_DOUBLE <br/>    -D UNITY_EXCLUDE_SETJMP_H <br/>    -D UNITY_EXCLUDE_MATH_H</span></pre>
                <h1 id="5e60" class="jr js cd cc jj jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ap">Floating Point
                  Precision</h1>
                <p id="174a" class="gx gy cd ha b hb kj hd he kk hg hh kl hj hk km hm hn kn hp hq cv ap">The above <code
                    class="dm ir is it iu b">gcc</code> compiler options were configured in <code
                    class="dm ir is it iu b"><a href="https://github.com/lupyuen/stm32bluepill-unittest/blob/master/platformio.ini" class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">platformio.ini</a></code>.
                  Note that we defined <code class="dm ir is it iu b">UNITY_FLOAT_PRECISION</code> and <code
                    class="dm ir is it iu b">UNITY_DOUBLE_PRECISION</code> as <code
                    class="dm ir is it iu b">0.000001</code>. How do they affect the Unit Testing? If you remember this
                  test case…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="1602" class="ap kr js cd iu b ff ks kt r ku">x = 2205.1969;  <br/>y = 270.8886;   <br/>r = __wrap___aeabi_ddiv(x, y);   <br/><strong class="iu hr">TEST_ASSERT_EQUAL_DOUBLE( 8.140604292687105  , r );</strong></span></pre>
                <p id="91d0" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">It divides two
                  <code class="dm ir is it iu b">doubles</code> and compares the result of the division to <code
                    class="dm ir is it iu b">8.140604292687105</code><strong class="ha hr">. </strong>But<strong
                    class="ha hr"> i</strong>n reality, there will be some loss of precision when we store a
                  floating-point number as <code class="dm ir is it iu b">float</code> or <code
                    class="dm ir is it iu b">double</code>.</p>
                <p id="d4d1" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap"><a
                    class="bw gc id ie if ig" target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-shrink-your-math-libraries-with-qfplib">As
                    we have seen in our previous article</a>, <code class="dm ir is it iu b">floats</code> can store up
                  to <strong class="ha hr">6 significant decimal digits</strong> and <code
                    class="dm ir is it iu b">doubles</code> can store up to <strong class="ha hr">15 significant decimal
                    digits</strong>. So the result of our division may actually be <code
                    class="dm ir is it iu b">8.14060</code> if we store the result as a <code
                    class="dm ir is it iu b">float</code>.</p>
                <p id="c9cf" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">That’s why we
                  have defined <code class="dm ir is it iu b">UNITY_FLOAT_PRECISION</code> and <code
                    class="dm ir is it iu b">UNITY_DOUBLE_PRECISION</code> as <code
                    class="dm ir is it iu b">0.000001</code>… It means that we are only interested in comparing the
                  first 6 decimal places for <code class="dm ir is it iu b">floats</code> and <code
                    class="dm ir is it iu b">doubles</code>. Any discrepancy beyond the 6th decimal place should be
                  ignored.</p>
                <p id="65ea" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">Why have we set
                  <code class="dm ir is it iu b">UNITY_FLOAT_PRECISION</code> and <code
                    class="dm ir is it iu b">UNITY_DOUBLE_PRECISION</code> to the same precision? The <code
                    class="dm ir is it iu b">nano-float</code> library downscales the precision of all math computations
                  from <code class="dm ir is it iu b">double</code> to <code class="dm ir is it iu b">single</code>.
                  This was done to reduce the math library code size to fit on Blue Pill. So for this specific library
                  it makes sense to set both precisions to be the same. For other libraries, probably not.</p>
              </div>
            </div>
          </section>
          <hr class="hs fe ht hu hv hw hx hy hz ia ib ic" />
          <section class="cv cw cx cy cz">
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <h1 id="435a" class="jr js cd cc jj jt kv jv jw kw jy jz kx kb kc ky ke kf kz kh ki ap">Test Coverage
                </h1>
                <p id="cf9e" class="gx gy cd ha b hb kj hd he kk hg hh kl hj hk km hm hn kn hp hq cv ap">At the end of
                  the Unit Testing, we saw the message <code class="dm ir is it iu b">All Functions Called</code>
                  followed by a list of numbers…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="5918" class="ap kr js cd iu b ff ks kt r ku">&gt; Executing task: bash -c &#x27;../qemu_stm32/arm-softmmu/qemu-system-arm<br/>-M stm32-f103c8 -semihosting <br/>-kernel .pioenvs/bluepill_f103c8/firmware.bin&#x27; &lt;<br/>Starting...<br/>src\../lib/nano-float/test/test.c:433:test_aeabi_ddiv:PASS<br/>src\../lib/nano-float/test/test.c:434:test_aeabi_dmul:PASS<br/>src\../lib/nano-float/test/test.c:435:test_aeabi_dadd:PASS<br/>src\../lib/nano-float/test/test.c:436:test_aeabi_dsub:PASS<br/>...<br/>45 Tests 0 Failures 0 Ignored<br/><strong class="iu hr">All functions called<br/>Usage: 01 &gt; 04 / 02 &gt; 04 / 03 &gt; 04 / 04 &gt; 04 ...</strong><br/>Done</span></pre>
                <p id="2e51" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">When we run
                  Unit Tests, we should ensure that <strong class="ha hr">all the functions that we’re testing
                    (</strong><code
                    class="dm ir is it iu b"><strong class="ha hr">aeabi_ddiv, aeabi_dmul</strong></code><strong
                    class="ha hr">) are actually called</strong>. It’s possible that we may have omitted some compiler
                  option (like <code class="dm ir is it iu b">wrap</code>) or preprocessor symbols (like <code
                    class="dm ir is it iu b">UNIT_TEST</code>) that could cause the functions being tested to be called
                  incorrectly.</p>
                <p id="95c8" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">In Unit
                  Testing, the <a
                    href="https://en.wikipedia.org/wiki/Code_coverage"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow"><strong class="ha hr">Test
                      Coverage</strong></a> info tells us the functions that have been called when we run Unit Tests.
                  For our simplified Test Coverage, we used an array of counters to <a
                    href="https://github.com/lupyuen/stm32bluepill-unittest/blob/master/lib/nano-float/src/functions.c"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">track the functions called</a>…
                </p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="7e42" class="ap kr js cd iu b ff ks kt r ku">//  We count the number of times each function was called. <br/>//  So we can check whether our unit tests cover all functions.<br/>enum float_usage_index {<br/>    USAGE_AEABI_DDIV,<br/>    USAGE_AEABI_DMUL,<br/>    USAGE_AEABI_DADD,<br/>    USAGE_AEABI_DSUB,<br/>    ...</span><span id="a614" class="ap kr js cd iu b ff lb lc ld le lf kt r ku">static uint8_t float_usage[LAST_FLOAT_USAGE_INDEX];<br/><br/>double __wrap___aeabi_ddiv(double n, double d) { <br/>    float_usage[USAGE_AEABI_DDIV]++;<br/>    return qfp_fdiv_fast(n, d); <br/>}</span></pre>
                <p id="e81b" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap"><code
                    class="dm ir is it iu b">float_usage_index</code> is an array of counters that count how many times
                  each function was called. When our <a
                    href="https://github.com/lupyuen/stm32bluepill-unittest/blob/master/lib/nano-float/test/test.c#L483-L504"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">Unit Test code</a> shows the
                  message…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="a03e" class="ap kr js cd iu b ff ks kt r ku">All functions called</span></pre>
                <p id="81e4" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">…It means that
                  the code has verified that every counter in the <code
                    class="dm ir is it iu b">float_usage_index</code> array was one (or greater). So all our functions
                  have indeed been called and we have 100% Test Coverage. Below that we see…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="937f" class="ap kr js cd iu b ff ks kt r ku">Usage: 01 &gt; 04 / 02 &gt; 04 / 03 &gt; 04 / 04 &gt; 04 ...</span></pre>
                <p id="4d1d" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">This is a
                  diagnostic message for Test Coverage that says…</p>
                <pre
                  class="ii ij ik il im ko kp kq"><span id="a680" class="ap kr js cd iu b ff ks kt r ku">Function 01 (aeabi_ddiv): Called 04 times<br/>Function 02 (aeabi_dmul): Called 04 times<br/>Function 03 (aeabi_dadd): Called 04 times<br/>Function 04 (aeabi_dsub): Called 04 times<br/>...</span></pre>
                <p id="a21f" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">And that’s all
                  you need to get your Unit Tests running on Blue Pill. Build your Unit Tests early, and run them often!
                </p>
              </div>
            </div>
          </section>
          <hr class="hs fe ht hu hv hw hx hy hz ia ib ic" />
          <section class="cv cw cx cy cz">
            <div class="n p">
              <div class="z ab ac ae af dt ah ai">
                <h1 id="e155" class="jr js cd cc jj jt kv jv jw kw jy jz kx kb kc ky ke kf kz kh ki ap">The Big Picture
                </h1>
                <p id="5ae5" class="gx gy cd ha b hb kj hd he kk hg hh kl hj hk km hm hn kn hp hq cv ap">This is the
                  third article in a series of articles that explain how I ported and optimised the <a
                    href="https://makecode.com/docs"
                    class="bw gc id ie if ig" target="_blank" rel="noopener nofollow">MakeCode visual programming
                    tool</a> for Blue Pill…</p>
                <p id="bb72" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">1️⃣ The first
                  article explains RAM and ROM memory optimisation…</p>
                <div class="mc md me mf mg jd"><a target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-analyse-and-optimise-your-ram-and-rom">
                    <div class="je n bv">
                      <div class="jf n jg p jh ji">
                        <h2 class="cc jj jk jl av jm fh as jn au ap">STM32 Blue Pill — Analyse and Optimise Your RAM and
                          ROM</h2>
                      </div>
                      <div class="mh r">
                        <div class="mr r mj mk ml mh mm ma jd"></div>
                      </div>
                    </div>
                  </a></div>
                <p id="1fb2" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">2️⃣ The second
                  article explains floating-point math optimisation…</p>
                <div class="mc md me mf mg jd"><a target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/stm32-blue-pill-shrink-your-math-libraries-with-qfplib">
                    <div class="je n bv">
                      <div class="jf n jg p jh ji">
                        <h2 class="cc jj jk jl av jm fh as jn au ap">STM32 Blue Pill – Shrink your math libraries with
                          Qfplib</h2>
                      </div>
                      <div class="mh r">
                        <div class="ms r mj mk ml mh mm ma jd"></div>
                      </div>
                    </div>
                  </a></div>
                <p id="7005" class="gx gy cd ha b hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq cv ap">In the next
                  article we’ll finally integrate all the tools and techniques from the three articles and learn about
                  the <strong class="ha hr">MakeCode Bootloader</strong>, an incredibly complex Blue Pill program that
                  does so much and still fits in 64 KB ROM!</p>
              </div>
            </div>
          </section>
        </div>
      </article>
    </div>
  </div>

  <ul>
    <li>
    <p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io">Check out my articles</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
    </li>
  </ul>
    
</body>

</html>
<!--
     FILE ARCHIVED ON 19:52:57 Jul 17, 2020 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 01:46:08 Feb 23, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  exclusion.robots: 0.24
  esindex: 0.093
  load_resource: 452.008
  captures_list: 239.955
  PetaboxLoader3.resolve: 421.147 (2)
  exclusion.robots.policy: 0.23
  PetaboxLoader3.datanode: 143.662 (4)
  RedisCDXSource: 1.777
  LoadShardBlock: 206.393 (3)
  CDXLines.iter: 27.013 (3)
-->