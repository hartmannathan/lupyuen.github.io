<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>NuttX RTOS for PinePhone: MIPI Display Serial Interface</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="NuttX RTOS for PinePhone: MIPI Display Serial Interface" 
    data-rh="true">
<meta property="og:description" 
    content="Apache NuttX Kernel has a driver for MIPI Display Interface... Here's how it will be called for rendering PinePhone's LCD Display"
    data-rh="true">
<meta name="description" 
    content="Apache NuttX Kernel has a driver for MIPI Display Interface... Here's how it will be called for rendering PinePhone's LCD Display">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/dsi3-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">NuttX RTOS for PinePhone: MIPI Display Serial Interface</h1>
    <nav id="TOC"><ul>
<li><a href="#complete-display-driver-for-pinephone">1 Complete Display Driver for PinePhone</a><ul></ul></li>
<li><a href="#nuttx-driver-for-mipi-display-serial-interface">2 NuttX Driver for MIPI Display Serial Interface</a><ul></ul></li>
<li><a href="#send-mipi-dsi-packet">3 Send MIPI DSI Packet</a><ul></ul></li>
<li><a href="#enable-mipi-dsi-and-d-phy">4 Enable MIPI DSI and D-PHY</a><ul></ul></li>
<li><a href="#convert-zig-to-c">5 Convert Zig to C</a><ul></ul></li>
<li><a href="#test-mipi-dsi-driver">6 Test MIPI DSI Driver</a><ul></ul></li>
<li><a href="#nuttx-driver-for-timing-controller-tcon0">7 NuttX Driver for Timing Controller (TCON0)</a><ul></ul></li>
<li><a href="#nuttx-driver-for-display-engine">8 NuttX Driver for Display Engine</a><ul></ul></li>
<li><a href="#nuttx-driver-for-backlight">9 NuttX Driver for Backlight</a><ul></ul></li>
<li><a href="#nuttx-driver-for-lcd-panel-driver">10 NuttX Driver for LCD Panel Driver</a><ul></ul></li>
<li><a href="#nuttx-driver-for-power-management-integrated-circuit">11 NuttX Driver for Power Management Integrated Circuit</a><ul></ul></li>
<li><a href="#why-zig">12 Why Zig</a><ul></ul></li>
<li><a href="#whats-next">13 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>18 Dec 2022</em></p>
<p><img src="https://lupyuen.github.io/images/dsi3-title.jpg" alt="Rendering graphics on PinePhone with Apache NuttX RTOS" /></p>
<p><a href="https://wiki.pine64.org/index.php/PinePhone"><strong>Pine64 PinePhone</strong></a> (pic above) will soon support the rendering of graphics on the LCD Display‚Ä¶ When we boot the official release of <a href="https://nuttx.apache.org/docs/latest/"><strong>Apache NuttX RTOS</strong></a>!</p>
<p>We‚Äôre building the <strong>NuttX Display Driver</strong> for PinePhone in small chunks, starting with the driver for <a href="https://lupyuen.github.io/articles/dsi"><strong>MIPI Display Serial Interface</strong></a>.</p>
<p>In this article we‚Äôll learn‚Ä¶</p>
<ul>
<li>
<p>What‚Äôs needed to create a <strong>Complete Display Driver</strong> for PinePhone</p>
</li>
<li>
<p>How our driver for <strong>MIPI Display Serial Interface</strong> fits into the grand plan</p>
</li>
<li>
<p>How we‚Äôre building the <strong>missing pieces</strong> of the PinePhone Display Driver</p>
</li>
<li>
<p>Why most of the Display Driver is in the <a href="https://ziglang.org/"><strong>Zig Programming Language</strong></a></p>
</li>
</ul>
<p>Let‚Äôs continue the (super looong) journey from our <strong>NuttX Porting Journal</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>lupyuen/pinephone-nuttx</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/dsi3-steps.jpg" alt="Steps needed to create a Complete Display Driver for PinePhone" /></p>
<h1 id="complete-display-driver-for-pinephone"><a href="#complete-display-driver-for-pinephone">1 Complete Display Driver for PinePhone</a></h1>
<p><em>NuttX will render graphics on PinePhone‚Äôs LCD Display‚Ä¶</em></p>
<p><em>What‚Äôs inside the Display Driver for PinePhone?</em></p>
<p>Through <strong>Reverse Engineering</strong> (and plenty of experimenting), we discovered that these steps are needed to create a <strong>Complete Display Driver</strong> for PinePhone (pic above)‚Ä¶</p>
<ol>
<li>
<p>Turn on PinePhone‚Äôs <strong>Display Backlight</strong></p>
<p>(Through Programmable I/O and Pulse-Width Modulation)</p>
</li>
<li>
<p>Initialise Allwinner A64‚Äôs <strong>Timing Controller (TCON0)</strong></p>
<p>(Which will pump pixels continuously to the LCD Display)</p>
</li>
<li>
<p>Initialise PinePhone‚Äôs <strong>Power Management Integrated Circuit (PMIC)</strong></p>
<p>(To power on PinePhone‚Äôs LCD Panel)</p>
</li>
<li>
<p>Enable Allwinner A64‚Äôs <strong>MIPI Display Serial Interface (DSI)</strong></p>
<p>(So we can send MIPI DSI commands to the LCD Panel)</p>
</li>
<li>
<p>Enable Allwinner A64‚Äôs <strong>MIPI Display Physical Layer (D-PHY)</strong></p>
<p>(Which is the communications layer inside MIPI DSI)</p>
</li>
<li>
<p>Reset PinePhone‚Äôs <strong>LCD Panel</strong></p>
<p>(Prep it to receive MIPI DSI Commands)</p>
</li>
<li>
<p>Initialise PinePhone‚Äôs <strong>LCD Controller (Sitronix ST7703)</strong></p>
<p>(Send the Initialisation Commands over MIPI DSI)</p>
</li>
<li>
<p>Start Allwinner A64‚Äôs <strong>MIPI DSI in HSC and HSD Mode</strong></p>
<p>(High Speed Clock Mode with High Speed Data Transmission)</p>
</li>
<li>
<p>Initialise Allwinner A64‚Äôs <strong>Display Engine (DE)</strong></p>
<p>(Start pumping pixels from DE to Timing Controller TCON0)</p>
</li>
<li>
<p>Wait a while</p>
<p>(160 milliseconds)</p>
</li>
<li>
<p>Render Graphics with Allwinner A64‚Äôs <strong>Display Engine (DE)</strong></p>
<p>(Start pumping pixels from RAM Framebuffers via Direct Memory Access)</p>
</li>
</ol>
<p>Let‚Äôs talk about each step and their NuttX Drivers‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-title.jpg" alt="LCD Display on PinePhone Schematic (Page 2)" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>LCD Display on PinePhone Schematic (Page 2)</em></a></p>
<h1 id="nuttx-driver-for-mipi-display-serial-interface"><a href="#nuttx-driver-for-mipi-display-serial-interface">2 NuttX Driver for MIPI Display Serial Interface</a></h1>
<p>The very first NuttX Driver we‚Äôve implemented is for <strong>MIPI Display Serial Interface (DSI)</strong>.</p>
<p><em>Why is MIPI DSI needed in PinePhone?</em></p>
<p>PinePhone talks to its LCD Panel (<a href="https://lupyuen.github.io/articles/dsi#xingbangda-xbd599-lcd-panel"><strong>Xingbangda XBD599</strong></a>) via the <strong>MIPI DSI Bus</strong> on Allwinner A64 SoC.</p>
<p>That‚Äôs why we need a MIPI DSI Driver in the NuttX Kernel.</p>
<p><em>So our MIPI DSI Driver will render graphics on PinePhone‚Äôs LCD Display?</em></p>
<p>It gets complicated‚Ä¶</p>
<ul>
<li>
<p><strong>At Startup:</strong> Our driver sends MIPI DSI Commands to initialise PinePhone‚Äôs LCD Controller: <a href="https://lupyuen.github.io/articles/dsi#sitronix-st7703-lcd-controller"><strong>Sitronix ST7703</strong></a></p>
<p>(ST7703 is inside the Xingbangda XBD599 LCD Panel)</p>
</li>
<li>
<p><strong>After Startup:</strong> Allwinner A64‚Äôs <a href="https://lupyuen.github.io/articles/de"><strong>Display Engine</strong></a> and <a href="https://lupyuen.github.io/articles/de#display-rendering-on-pinephone"><strong>Timing Controller (TCON0)</strong></a> pumps pixels continuously to the LCD Panel over MIPI DSI.</p>
<p>(Bypassing our MIPI DSI Driver)</p>
</li>
</ul>
<p>Thus our MIPI DSI Driver is called <strong>only at startup</strong> to initialise the LCD Controller (ST7703).</p>
<p><em>Sounds super complicated‚Ä¶</em></p>
<p>Yep but this rendering design is <strong>super efficient</strong>!</p>
<p>PinePhone doesn‚Äôt need to handle Interrupts while rendering the display‚Ä¶ Everything is <strong>done in Hardware!</strong> (Allwinner A64 SoC)</p>
<p>The pixel data is pumped from RAM Framebuffers via Direct Memory Access (DMA). Which is also done in Hardware.</p>
<p>Let‚Äôs dive inside our MIPI DSI Driver‚Ä¶</p>
<h1 id="send-mipi-dsi-packet"><a href="#send-mipi-dsi-packet">3 Send MIPI DSI Packet</a></h1>
<p><em>How do we send MIPI DSI Commands to initialise PinePhone‚Äôs LCD Controller?</em></p>
<p>Let‚Äôs take one MIPI DSI Command that initialises the ST7703 LCD Controller: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/test/test_a64_mipi_dsi.c#L52-L60">test_a64_mipi_dsi.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Command #1 to init ST7703
const uint8_t cmd1[] = { 
  0xB9,  // SETEXTC (Page 131): Enable USER Command
  0xF1,  // Enable User command
  0x12,  // (Continued)
  0x83   // (Continued)
};

// Send the command to ST7703 over MIPI DSI
write_dcs(cmd1, sizeof(cmd1));</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-initialise-lcd-controller">(ST7703 needs 20 Initialisation Commands)</a></p>
<p><strong>write_dcs</strong> sends our command to the MIPI DSI Bus in 3 <strong>DCS Formats</strong>‚Ä¶</p>
<ul>
<li>
<p><strong>DCS Short Write:</strong> For commands with 1 Byte</p>
</li>
<li>
<p><strong>DCS Short Write with Parameter:</strong> For commands with 2 Bytes</p>
</li>
<li>
<p><strong>DCS Long Write:</strong> For commands with 3 Bytes or more</p>
</li>
</ul>
<p>(DCS means Display Command Set)</p>
<div class="example-wrap"><pre class="language-c"><code>/// Write the DCS Command to MIPI DSI
static int write_dcs(FAR const uint8_t *buf, size_t len) {
  // Do DCS Short Write or Long Write depending on command length.
  // A64_MIPI_DSI_VIRTUAL_CHANNEL is 0.
  switch (len) {
    // DCS Short Write (without parameter)
    case 1:
      a64_mipi_dsi_write(A64_MIPI_DSI_VIRTUAL_CHANNEL, 
        MIPI_DSI_DCS_SHORT_WRITE, 
        buf, len);
      break;

    // DCS Short Write (with parameter)
    case 2:
      a64_mipi_dsi_write(A64_MIPI_DSI_VIRTUAL_CHANNEL, 
        MIPI_DSI_DCS_SHORT_WRITE_PARAM, 
        buf, len);
      break;

    // DCS Long Write
    default:
      a64_mipi_dsi_write(A64_MIPI_DSI_VIRTUAL_CHANNEL, 
        MIPI_DSI_DCS_LONG_WRITE, 
        buf, len);
      break;
  };</code></pre></div>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/test/test_a64_mipi_dsi.c#L5-L41">(Source)</a></p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/a64_mipi_dsi.h#L35-L39">(We talk to MIPI DSI Bus on Virtual Channel 0)</a></p>
<p><strong>a64_mipi_dsi_write</strong> comes from our NuttX MIPI DSI Driver: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/a64_mipi_dsi.c#L332-L498">arch/arm64/src/a64/a64_mipi_dsi.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Transmit the payload data to the MIPI DSI Bus as a MIPI DSI Short or
// Long Packet. This function is called to initialize the LCD Controller.
// Assumes that the MIPI DSI Block has been enabled on the SoC.
// Returns the number of bytes transmitted.
ssize_t a64_mipi_dsi_write(
  uint8_t channel,  // Virtual Channel (0)
  enum mipi_dsi_e cmd,  // DCS Command (Data Type)
  FAR const uint8_t *txbuf,  // Payload data for the packet
  size_t txlen)  // Length of payload data (Max 65541 bytes)
{
  ...
  // Compose Short or Long Packet depending on DCS Command
  switch (cmd) {
    // For DCS Long Write:
    // Compose Long Packet
    case MIPI_DSI_DCS_LONG_WRITE:
      pktlen = mipi_dsi_long_packet(pkt, sizeof(pkt), channel, cmd, txbuf, txlen);
      break;

    // For DCS Short Write (with and without parameter):
    // Compose Short Packet
    case MIPI_DSI_DCS_SHORT_WRITE:
      pktlen = mipi_dsi_short_packet(pkt, sizeof(pkt), channel, cmd, txbuf, txlen);
      break;

    case MIPI_DSI_DCS_SHORT_WRITE_PARAM:
      pktlen = mipi_dsi_short_packet(pkt, sizeof(pkt), channel, cmd, txbuf, txlen);
      break;
  };</code></pre></div>
<p>Our NuttX Driver calls‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/mipi_dsi.c#L369-L484"><strong>mipi_dsi_short_packet</strong></a>: Compose a MIPI DSI <a href="https://lupyuen.github.io/articles/dsi#appendix-short-packet-for-mipi-dsi"><strong>Short Packet</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-short-packet-for-mipi-dsi">(More about this)</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/mipi_dsi.c#L230-L368"><strong>mipi_dsi_long_packet</strong></a>: Compose a MIPI DSI <a href="https://lupyuen.github.io/articles/dsi#long-packet-for-mipi-dsi"><strong>Long Packet</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/dsi#long-packet-for-mipi-dsi">(More about this)</a></p>
</li>
</ul>
<p>Then our NuttX Driver writes the Short or Long Packet to the <strong>MIPI DSI Registers</strong> of Allwinner A64: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/a64_mipi_dsi.c#L332-L498">arch/arm64/src/a64/a64_mipi_dsi.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  // Write the packet to DSI Low Power Transmit Package Register
  // at DSI Offset 0x300 (A31 Page 856)
  addr = A64_DSI_ADDR + 0x300;
  for (i = 0; i &lt; pktlen; i += 4) {

    // Fetch the next 4 bytes, fill with 0 if not available
    const uint32_t b[4] = {
      pkt[i],
      (i + 1 &lt; pktlen) ? pkt[i + 1] : 0,
      (i + 2 &lt; pktlen) ? pkt[i + 2] : 0,
      (i + 3 &lt; pktlen) ? pkt[i + 3] : 0
    };

    // Merge the next 4 bytes into a 32-bit value
    const uint32_t v = b[0] + (b[1] &lt;&lt; 8) + (b[2] &lt;&lt; 16) + (b[3] &lt;&lt; 24);

    // Write the 32-bit value to DSI Low Power Transmit Package Register
    modreg32(v, 0xffffffff, addr);
    addr += 4;
  }

  // Omitted: Wait for DSI Transmission to complete</code></pre></div>
<p>And that‚Äôs how our MIPI DSI Packet gets transmitted to the ST7703 LCD Controller, over the MIPI DSI Bus!</p>
<p>We do this 20 times, to send 20 <strong>Initialisation Commands</strong> to the ST7703 LCD Controller‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-initialise-lcd-controller"><strong>‚ÄúInitialise LCD Controller‚Äù</strong></a></li>
</ul>
<p>But wait‚Ä¶ We haven‚Äôt enabled the MIPI DSI Hardware yet!</p>
<h1 id="enable-mipi-dsi-and-d-phy"><a href="#enable-mipi-dsi-and-d-phy">4 Enable MIPI DSI and D-PHY</a></h1>
<p><em>What about the other MIPI DSI Operations?</em></p>
<p>Before sending MIPI DSI Packets, our NuttX Driver needs to enable 2 chunks of hardware on Allwinner A64 SoC‚Ä¶</p>
<ul>
<li>
<p>Enable Allwinner A64‚Äôs <strong>MIPI Display Serial Interface (DSI)</strong></p>
<p>So we can send MIPI DSI commands to the LCD Panel.</p>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-enable-mipi-dsi-block">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/a64_mipi_dsi.c#L499-L901">(Implemented as <strong>a64_mipi_dsi_enable</strong>)</a></p>
</li>
<li>
<p>Enable Allwinner A64‚Äôs <strong>MIPI Display Physical Layer (D-PHY)</strong></p>
<p>Which is the communications layer inside MIPI DSI.</p>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-enable-mipi-display-physical-layer-dphy">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/a64_mipi_dphy.c#L85-L161">(Implemented as <strong>a64_mipi_dphy_enable</strong>)</a></p>
</li>
</ul>
<p>And after sending the MIPI DSI Packets to initialise our LCD Controller, we need to‚Ä¶</p>
<ul>
<li>
<p>Start Allwinner A64‚Äôs <strong>MIPI DSI in HSC and HSD Mode</strong></p>
<p>That‚Äôs High Speed Clock Mode with High Speed Data Transmission.</p>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-start-mipi-dsi-hsc-and-hsd">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/a64_mipi_dsi.c#L901-L984">(Implemented as <strong>a64_mipi_dsi_start</strong>)</a></p>
</li>
</ul>
<p><em>How did we create all this code for our NuttX Driver?</em></p>
<p>Our <strong>NuttX Driver for MIPI DSI</strong> (and MIPI D-PHY) lives in the NuttX Kernel as‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/mipi_dsi.c"><strong>mipi_dsi.c</strong></a>: Compose MIPI DSI Packets (Long, Short, Short with Parameter)</p>
</li>
<li>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/a64_mipi_dsi.c"><strong>a64_mipi_dsi.c</strong></a>: MIPI Display Serial Interface (DSI) for Allwinner A64</p>
</li>
<li>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/a64_mipi_dphy.c"><strong>a64_mipi_dphy.c</strong></a>: MIPI Display Physical Layer (D-PHY) for Allwinner A64</p>
</li>
</ul>
<p>We created the above NuttX Source Files by converting our <strong>Zig MIPI DSI Driver</strong> to C‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig"><strong>display.zig</strong></a>: Zig Driver for MIPI DSI</p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/dphy.zig"><strong>dphy.zig</strong></a>: Zig Driver for MIPI D-PHY</p>
</li>
</ul>
<p>(Why Zig? We‚Äôll explain below)</p>
<p>We created the Zig Drivers by <strong>Reverse-Engineering</strong> the logs that we captured from PinePhone‚Äôs p-boot Bootloader‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi"><strong>‚ÄúUnderstanding PinePhone‚Äôs Display (MIPI DSI)‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi2"><strong>‚ÄúNuttX RTOS for PinePhone: Display Driver in Zig‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de"><strong>‚ÄúRendering PinePhone‚Äôs Display (DE and TCON0)‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de2"><strong>‚ÄúNuttX RTOS for PinePhone: Render Graphics in Zig‚Äù</strong></a></p>
</li>
</ul>
<p>Why Reverse Engineer? Because a lot of details are missing from the official docs for Allwinner A64‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf"><strong>‚ÄúAllwinner A64 User Manual‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf"><strong>‚ÄúAllwinner A31 User Manual‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://linux-sunxi.org/images/7/7b/Allwinner_DE2.0_Spec_V1.0.pdf"><strong>‚ÄúAllwinner Display Engine 2.0 Specification‚Äù</strong></a></p>
</li>
</ul>
<h1 id="convert-zig-to-c"><a href="#convert-zig-to-c">5 Convert Zig to C</a></h1>
<p><em>Was it difficult to convert Zig to C?</em></p>
<p>Not at all!</p>
<p>Here‚Äôs the Zig code for our MIPI DSI Driver‚Ä¶</p>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/3d33e5a49a5a3857c39fe8aa79af60902a70088e/display.zig#L115-L170">https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig</a></p>
<p>And here‚Äôs the converted C code for NuttX: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi2/arch/arm64/src/a64/mipi_dsi.c#L392-L484">mipi_dsi.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>ssize_t mipi_dsi_short_packet(FAR uint8_t *pktbuf,
                              size_t pktlen,
                              uint8_t channel,
                              enum mipi_dsi_e cmd,
                              FAR const uint8_t *txbuf,
                              size_t txlen)
{
  /* Data Identifier (DI) (1 byte):
   * Virtual Channel Identifier (Bits 6 to 7)
   * Data Type (Bits 0 to 5) */
  const uint8_t vc = channel;
  const uint8_t dt = cmd;
  const uint8_t di = (vc &lt;&lt; 6) |
                     dt;

  /* Data (2 bytes): Fill with 0 if Second Byte is missing */
  const uint8_t data[2] =
    {
      txbuf[0],                     /* First Byte */
      (txlen == 2) ? txbuf[1] : 0,  /* Second Byte */
    };

  /* Data Identifier + Data (3 bytes):
   * For computing Error Correction Code (ECC) */
  const uint8_t di_data[3] =
    {
      di,
      data[0],
      data[1]
    };

  /* Compute ECC for Data Identifier + Word Count */
  const uint8_t ecc = compute_ecc(di_data,
                                  sizeof(di_data));

  /* Packet Header (4 bytes):
   * Data Identifier + Data + Error Correction Code */
  const uint8_t header[4] =
    {
      di_data[0],
      di_data[1],
      di_data[2],
      ecc
    };

  /* Packet Length is Packet Header Size (4 bytes) */
  const size_t len = sizeof(header);

  ginfo(&quot;channel=%d, cmd=0x%x, txlen=%ld\n&quot;, channel, cmd, txlen);
  DEBUGASSERT(pktbuf != NULL &amp;&amp; txbuf != NULL);
  DEBUGASSERT(channel &lt; 4);
  DEBUGASSERT(cmd &lt; (1 &lt;&lt; 6));

  if (txlen &lt; 1 || txlen &gt; 2) { DEBUGPANIC(); return ERROR; }
  if (len &gt; pktlen) { DEBUGPANIC(); return ERROR; }

  /* Copy Packet Header to Packet Buffer */
  memcpy(pktbuf,
         header,
         sizeof(header));  /* 4 bytes */

  /* Return the Packet Length */
  return len;
}</code></pre></div>
<p>The code looks highly similar!</p>
<h1 id="test-mipi-dsi-driver"><a href="#test-mipi-dsi-driver">6 Test MIPI DSI Driver</a></h1>
<p>TODO</p>
<p><em>How do we test the MIPI DSI Driver in the NuttX Kernel?</em></p>
<p>Right now we have implemented the following in the NuttX Kernel‚Ä¶</p>
<ul>
<li>Driver for MIPI Display Serial Interface (DSI)</li>
<li>Driver for MIPI Display Physical Layer (D-PHY)</li>
</ul>
<p>But to render graphics on PinePhone we need the following drivers, which are still in Zig, pending conversion to C‚Ä¶</p>
<ul>
<li>Driver for Display Backlight</li>
<li>Driver for Timing Controller TCON0</li>
<li>Driver for Power Mgmt IC</li>
<li>Driver for LCD Panel</li>
<li>Driver for Display Engine</li>
</ul>
<p>Running an Integration Test across the C and Zig Drivers will be a little interesting. Here‚Äôs how we run the Integration Test‚Ä¶</p>
<p>We created this program in Zig that calls the C and Zig Drivers, in the right sequence‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/bc560cea04f601542eb1d3d71fb00dbc647d982d/render.zig#L1143-L1176">render.zig</a></p>
<p>Then we compile the Zig Test Program targeting PinePhone‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>  #  Configure NuttX
  cd nuttx
  ./tools/configure.sh pinephone:nsh
  make menuconfig

  #  Select &quot;System Type &gt; Allwinner A64 Peripheral Selection &gt; MIPI DSI&quot;
  #  Select &quot;Build Setup &gt; Debug Options &gt; Graphics Debug Features &gt; Graphics Errors / Warnings / Informational Output&quot;
  #  Save and exit menuconfig

  #  Build NuttX
  make

  #  Download the Zig Test Program
  git clone https://github.com/lupyuen/pinephone-nuttx
  pushd ../pinephone-nuttx

  #  Compile the Zig App for PinePhone 
  #  (armv8-a with cortex-a53)
  #  TODO: Change &quot;..&quot; to your NuttX Project Directory
  zig build-obj \
    --verbose-cimport \
    -target aarch64-freestanding-none \
    -mcpu cortex_a53 \
    -isystem &quot;../nuttx/include&quot; \
    -I &quot;../apps/include&quot; \
    render.zig

  #  Copy the compiled app to NuttX and overwrite `hello.o`
  #  TODO: Change &quot;..&quot; to your NuttX Project Directory
  cp render.o \
    ../apps/examples/hello/*hello.o  

  #  Return to the NuttX Folder
  popd

  #  Link the Compiled Zig App with NuttX
  make</code></pre></div>
<p>We boot NuttX on PinePhone and run the Zig Test Program‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-11.0.0-pinephone

nsh&gt; uname -a
NuttX 11.0.0-pinephone 2a1577a-dirty Dec  9 2022 13:57:47 arm64 pinephone

nsh&gt; hello 0</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/f1a02068aeb0785278c482116a4eedc7">(Source)</a></p>
<p>Yep our Zig Test Program renders graphics successfully on PinePhone!</p>
<p>Which means the NuttX Kernel Drivers for MIPI DSI are working OK!</p>
<p>Here‚Äôs the Test Log for our Zig Test Program running on NuttX and PinePhone‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/f1a02068aeb0785278c482116a4eedc7">Test Log for NuttX MIPI DSI on PinePhone</a></li>
</ul>
<p><em>What about Unit Testing? Can we test the MIPI DSI / D-PHY Driver without other drivers?</em></p>
<p>Yep! Our MIPI DSI Driver simply writes values to a bunch of A64 Hardware Registers, like so: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi/arch/arm64/src/a64/a64_mipi_dsi.c#L633-L646">a64_mipi_dsi.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  /* DSI Configuration Register 1 (A31 Page 846)
   * Set Video_Start_Delay (Bits 4 to 16) to 1468 (Line Delay)
   * Set Video_Precision_Mode_Align (Bit 2) to 1 (Fill Mode)
   * Set Video_Frame_Start (Bit 1) to 1 (Precision Mode)
   * Set DSI_Mode (Bit 0) to 1 (Video Mode)
   * Note: Video_Start_Delay is actually 13 bits, not 8 bits as stated
   * in A31 User Manual
   */

  #define DSI_BASIC_CTL1_REG (A64_DSI_ADDR + 0x14)
  #define DSI_MODE                   (1 &lt;&lt; 0)
  #define VIDEO_FRAME_START          (1 &lt;&lt; 1)
  #define VIDEO_PRECISION_MODE_ALIGN (1 &lt;&lt; 2)
  #define VIDEO_START_DELAY(n)       (n &lt;&lt; 4)

  dsi_basic_ctl1 = VIDEO_START_DELAY(1468) |
                   VIDEO_PRECISION_MODE_ALIGN |
                   VIDEO_FRAME_START |
                   DSI_MODE;
  putreg32(dsi_basic_ctl1, DSI_BASIC_CTL1_REG);

  // Include Test Code
  #include &quot;../../pinephone-nuttx/test/test_a64_mipi_dsi2.c&quot;</code></pre></div>
<p>So we only need to ensure that the Hardware Addresses and the Written Values are correct.</p>
<p>To do that, we use Assertion Checks to verify the Addresses and Values: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/test/test_a64_mipi_dsi2.c#L34-L35">test_a64_mipi_dsi2.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  // Test Code
  DEBUGASSERT(DSI_BASIC_CTL1_REG == 0x1ca0014);
  DEBUGASSERT(dsi_basic_ctl1 == 0x5bc7);</code></pre></div>
<p>If the Addresses or Values are incorrect, our MIPI DSI Driver halts with an Assertion Failure.</p>
<p>(We remove the Assertion Checks in the final version of our driver)</p>
<p><em>What about a smaller, self-contained Unit Test for MIPI DSI?</em></p>
<p>Here‚Äôs the Unit Test that verifies MIPI DSI Packets (Long / Short  / Short with Parameter) are composed correctly‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/46f055eceae268fa7ba20d69c12d4823491a89b9/test/test_mipi_dsi.c#L1-L109">test_mipi_dsi.c</a></p>
<p><em>Can we test the MIPI DSI Driver on our Local Computer? Without running on PinePhone?</em></p>
<p>Most certainly! In fact we test the MIPI DSI Driver on our Local Computer first before testing on PinePhone. Here‚Äôs how‚Ä¶</p>
<p>Remember that our MIPI DSI Driver simply writes values to a bunch of A64 Hardware Registers. So we only need to ensure that the Hardware Addresses and the Written Values are correct.</p>
<p>We created a Test Scaffold that simulates the NuttX Build Environment‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/44167d81edbd054d3285ca3a6087926e6fc9ce79/test/test.c#L7-L51">test.c</a></p>
<p>Then we compile the Test Scaffold and run it on our Local Computer‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/cdb6bbc8e57ef02104bdbde721f8ff6787d74efc/test/run.sh#L9-L36">run.sh</a></p>
<p>Note that we capture the <a href="test/test.log">Actual Test Log</a> and we <code>diff</code> it with the <a href="test/expected.log">Expected Test Log</a>. That‚Äôs how we detect discrepancies in the Hardware Addresses and the Written Values‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/c04f1447933665df207a42f626c726ef7a7def65/test/test.log#L4-L20">test.log</a></p>
<h1 id="nuttx-driver-for-timing-controller-tcon0"><a href="#nuttx-driver-for-timing-controller-tcon0">7 NuttX Driver for Timing Controller (TCON0)</a></h1>
<p>TODO</p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-timing-controller-tcon0">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/tcon.zig">(Implemented here)</a></p>
<p>TODO: Allwinner A64 Timing Controller TCON0 Driver, convert from Zig to C</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/tcon.zig">tcon.zig</a></li>
</ul>
<h1 id="nuttx-driver-for-display-engine"><a href="#nuttx-driver-for-display-engine">8 NuttX Driver for Display Engine</a></h1>
<p>TODO: Initialise <strong>Display Engine (DE)</strong></p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-initialising-the-allwinner-a64-display-engine">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/render.zig#L710-L1011">(Implemented here)</a></p>
<p>TODO: Render Graphics with <strong>Display Engine (DE)</strong></p>
<p><a href="https://lupyuen.github.io/articles/de">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/render.zig#L69-L175">(Implemented here)</a></p>
<p>TODO: Allwinner A64 Display Engine Driver, convert from Zig to C</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/render.zig">render.zig</a></li>
</ul>
<p>Our Display Engine Driver will follow the design of STM32F7 Display Driver‚Ä¶</p>
<ol>
<li>
<p><code>stm32_bringup</code> calls <code>fb_register</code>‚Ä¶</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi/boards/arm/stm32f7/stm32f746g-disco/src/stm32_bringup.c#L100">boards/arm/stm32f7/stm32f746g-disco/src/stm32_bringup.c</a></p>
</li>
<li>
<p><code>fb_register</code> calls <code>up_fbinitialize</code>‚Ä¶</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi/drivers/video/fb.c#L664">drivers/video/fb.c</a></p>
</li>
<li>
<p><code>up_fbinitialize</code> calls <code>stm32_ltdcinitialize</code>‚Ä¶</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi/boards/arm/stm32f7/stm32f746g-disco/src/stm32_lcd.c#L72">boards/arm/stm32f7/stm32f746g-disco/src/stm32_lcd.c</a></p>
</li>
<li>
<p><code>stm32_ltdcinitialize</code> creates the NuttX Framebuffer‚Ä¶</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi/arch/arm/src/stm32f7/stm32_ltdc.c#L2971">arch/arm/src/stm32f7/stm32_ltdc.c</a></p>
</li>
<li>
<p>NuttX Framebuffer is here‚Ä¶</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi/arch/arm/src/stm32f7/stm32_ltdc.c#L864">arch/arm/src/stm32f7/stm32_ltdc.c</a></p>
</li>
</ol>
<h1 id="nuttx-driver-for-backlight"><a href="#nuttx-driver-for-backlight">9 NuttX Driver for Backlight</a></h1>
<p>TODO</p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-display-backlight">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/backlight.zig">(Implemented here)</a></p>
<p>TODO: PinePhone Backlight Driver, convert from Zig to C</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/backlight.zig">backlight.zig</a></li>
</ul>
<p>Our Backlight Driver will follow the design of the STM32 Backlight Driver: <code>stm32_backlight</code>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi/boards/arm/stm32/hymini-stm32v/src/stm32_ssd1289.c#L230">boards/arm/stm32/hymini-stm32v/src/stm32_ssd1289.c</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi/boards/arm/stm32/viewtool-stm32f107/src/stm32_ssd1289.c#L298">boards/arm/stm32/viewtool-stm32f107/src/stm32_ssd1289.c</a></p>
</li>
</ul>
<p>The code will go inside our Board LCD Source File, similar to this‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi/boards/arm/stm32f7/stm32f746g-disco/src/stm32_lcd.c">boards/arm/stm32f7/stm32f746g-disco/src/stm32_lcd.c</a></li>
</ul>
<p>TODO: PinePhone PIO and LEDs are now supported in NuttX Mainline‚Ä¶</p>
<p><a href="https://github.com/apache/nuttx/pull/7796">apache/nuttx/pull/7796</a></p>
<h1 id="nuttx-driver-for-lcd-panel-driver"><a href="#nuttx-driver-for-lcd-panel-driver">10 NuttX Driver for LCD Panel Driver</a></h1>
<p>TODO</p>
<p>Reset LCD Panel</p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-reset-lcd-panel">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/panel.zig">(Implemented here)</a></p>
<p>Initialise LCD Controller</p>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-initialise-lcd-controller">(Explained here)</a></p>
<p><a href="https://lupyuen.github.io/articles/dsi2#initialise-st7703-lcd-controller">(Implemented here)</a></p>
<p>TODO: PinePhone LCD Panel Driver, convert from Zig to C</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/panel.zig">panel.zig</a></li>
</ul>
<p>The code will go inside our Board LCD Source File, similar to this‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi/boards/arm/stm32f7/stm32f746g-disco/src/stm32_lcd.c">boards/arm/stm32f7/stm32f746g-disco/src/stm32_lcd.c</a></li>
</ul>
<h1 id="nuttx-driver-for-power-management-integrated-circuit"><a href="#nuttx-driver-for-power-management-integrated-circuit">11 NuttX Driver for Power Management Integrated Circuit</a></h1>
<p>TODO</p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-power-management-integrated-circuit">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/pmic.zig">(Implemented here)</a></p>
<p>TODO: PinePhone PMIC, convert from Zig to C, needs more reverse engineering</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/pmic.zig">pmic.zig</a></li>
</ul>
<p>The code will go inside our Board LCD Source File, similar to this‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/dsi/boards/arm/stm32f7/stm32f746g-disco/src/stm32_lcd.c">boards/arm/stm32f7/stm32f746g-disco/src/stm32_lcd.c</a></li>
</ul>
<h1 id="why-zig"><a href="#why-zig">12 Why Zig</a></h1>
<p>TODO: Prototype in zig</p>
<p>Concise executable specification</p>
<p>Easy to convert to C</p>
<p>Was it worth the effort?</p>
<h1 id="whats-next"><a href="#whats-next">13 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Check out the other articles on <strong>NuttX RTOS for PinePhone</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/arm"><strong>‚ÄúApache NuttX RTOS on Arm Cortex-A53: How it might run on PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/uboot"><strong>‚ÄúPinePhone boots Apache NuttX RTOS‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/interrupt"><strong>‚ÄúNuttX RTOS for PinePhone: Fixing the Interrupts‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/serial"><strong>‚ÄúNuttX RTOS for PinePhone: UART Driver‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pio"><strong>‚ÄúNuttX RTOS for PinePhone: Blinking the LEDs‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi"><strong>‚ÄúUnderstanding PinePhone‚Äôs Display (MIPI DSI)‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi2"><strong>‚ÄúNuttX RTOS for PinePhone: Display Driver in Zig‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de"><strong>‚ÄúRendering PinePhone‚Äôs Display (DE and TCON0)‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de2"><strong>‚ÄúNuttX RTOS for PinePhone: Render Graphics in Zig‚Äù</strong></a></p>
</li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>My Current Project: ‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>My Other Project: ‚ÄúThe RISC-V BL602 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/dsi3.md"><strong>lupyuen.github.io/src/dsi3.md</strong></a></p>

    
</body>
</html>