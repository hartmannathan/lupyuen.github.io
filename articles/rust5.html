<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Rust Apps on Ox64 BL808 RISC-V SBC and Apache NuttX RTOS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Rust Apps on Ox64 BL808 RISC-V SBC and Apache NuttX RTOS" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/rust5-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.codeberg.page/articles/rust5.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Rust Apps on Ox64 BL808 RISC-V SBC and Apache NuttX RTOS</h1>
    <nav id="TOC"><ul>
<li><a href="#rust-app-for-nuttx">1 Rust App for NuttX</a><ul></ul></li>
<li><a href="#compile-for-qemu-64-bit-risc-v">2 Compile for QEMU 64-bit RISC-V</a><ul></ul></li>
<li><a href="#test-on-qemu-64-bit-risc-v">3 Test on QEMU 64-bit RISC-V</a><ul></ul></li>
<li><a href="#rust-target-is-incorrect">4 Rust Target is Incorrect</a><ul></ul></li>
<li><a href="#compile-rust-app-for-ox64-sbc">5 Compile Rust App for Ox64 SBC</a><ul></ul></li>
<li><a href="#run-rust-app-on-ox64-sbc">6 Run Rust App on Ox64 SBC</a><ul></ul></li>
<li><a href="#nuttx-flat-mode-vs-kernel-mode">7 NuttX Flat Mode vs Kernel Mode</a><ul></ul></li>
<li><a href="#whats-next">8 What‚Äôs Next</a><ul></ul></li>
<li><a href="#appendix-build-nuttx-for-qemu">9 Appendix: Build NuttX for QEMU</a><ul></ul></li>
<li><a href="#appendix-build-nuttx-for-ox64-sbc">10 Appendix: Build NuttX for Ox64 SBC</a><ul></ul></li>
<li><a href="#appendix-run-nuttx-on-ox64-emulator">11 Appendix: Run NuttX on Ox64 Emulator</a><ul></ul></li>
<li><a href="#appendix-main-function-is-missing">12 Appendix: Main Function is Missing</a><ul></ul></li>
<li><a href="#appendix-makefile-target-is-missing">13 Appendix: Makefile Target is Missing</a><ul></ul></li></ul></nav><p>üìù <em>7 May 2024</em></p>
<p><img src="https://lupyuen.github.io/images/rust5-title.jpg" alt="Rust App on Ox64 BL808 RISC-V SBC and Apache NuttX RTOS" /></p>
<div style="text-align: center">
<p><a href="https://github.com/Swordfish90/cool-retro-term"><em>Thanks to cool-retro-term!</em></a></p>
</div>
<p>TODO: Will Rust Apps run on a 64-bit RISC-V SBC, like Ox64 BL808? Let‚Äôs find out!</p>
<p>TODO: Bare Metal?</p>
<p>TODO: Pic of Ox64 Board</p>
<h1 id="rust-app-for-nuttx"><a class="doc-anchor" href="#rust-app-for-nuttx">¬ß</a>1 Rust App for NuttX</h1>
<p>Below is the <strong>Simplest Rust App</strong> that will run on Apache NuttX RTOS. We‚Äôll test it on Ox64 BL808 SBC.</p>
<p>We begin with the <strong>Rust Declarations</strong>: <a href="https://github.com/apache/nuttx-apps/blob/master/examples/hello_rust/hello_rust_main.rs#L20-L41">hello_rust_main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// main() function not needed
</span><span class="attr">#![no_main]

</span><span class="comment">// Use Rust Core Library (instead of Rust Standard Library)
</span><span class="attr">#![no_std]

</span><span class="comment">// Import printf() from C into Rust
</span><span class="kw">extern </span><span class="string">"C" </span>{
  <span class="kw">pub fn </span>printf(
    format: <span class="kw-2">*const </span>u8,  <span class="comment">// Equivalent to `const char *`
    </span>...                 <span class="comment">// Optional Arguments
  </span>) -&gt; i32;             <span class="comment">// Returns `int`
</span>}                       <span class="comment">// TODO: Standardise `i32` as `c_int`</span></code></pre></div>
<p><a href="TODO">(Why we use <strong><code>[no_std]</code></strong>)</a></p>
<p>The code above imports the <em>printf()</em> function from C into Rust.</p>
<p>This is how we call it in Rust: <a href="https://github.com/apache/nuttx-apps/blob/master/examples/hello_rust/hello_rust_main.rs#L54-L74">hello_rust_main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// Main Function exported by Rust to C.
// Don't mangle the Function Name.
</span><span class="attr">#[no_mangle]
</span><span class="kw">pub extern </span><span class="string">"C" </span><span class="kw">fn </span>hello_rust_main(
  _argc: i32,              <span class="comment">// Equivalent to `int argc`
  </span>_argv: <span class="kw-2">*const *const </span>u8  <span class="comment">// Equivalent to `char **argv`
</span>) -&gt; i32 {                 <span class="comment">// Returns `int`

  // Calling a C Function might have Unsafe consequences
  </span><span class="kw">unsafe </span>{
    printf(                 <span class="comment">// Call printf() with...
      </span><span class="string">b"Hello, Rust!!\n\0"  </span><span class="comment">// Byte String terminated by null
        </span><span class="kw">as </span><span class="kw-2">*const </span>u8        <span class="comment">// Cast as `const char *`
    </span>);
  }

  <span class="comment">// Exit with status 0
  </span><span class="number">0
</span>}</code></pre></div>
<p>Rust expects us to provide a <strong>Panic Handler</strong>. We write a simple one: <a href="https://github.com/apache/nuttx-apps/blob/master/examples/hello_rust/hello_rust_main.rs#L27-L54">hello_rust_main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// Import the Panic Info for our Panic Handler
</span><span class="kw">use </span>core::panic::PanicInfo;

<span class="comment">// Handle a Rust Panic. Needed for [no_std]
</span><span class="attr">#[panic_handler]
</span><span class="kw">fn </span>panic(
  _panic: <span class="kw-2">&amp;</span>PanicInfo&lt;<span class="lifetime">'_</span>&gt;  <span class="comment">// Receives the Panic Info and Stack Trace
</span>) -&gt; ! {                  <span class="comment">// Never returns

  // TODO: Print the Panic Info and Stack Trace
  // For now, we loop forever
  </span><span class="kw">loop </span>{}
}</code></pre></div>
<h1 id="compile-for-qemu-64-bit-risc-v"><a class="doc-anchor" href="#compile-for-qemu-64-bit-risc-v">¬ß</a>2 Compile for QEMU 64-bit RISC-V</h1>
<p>Before testing on a Real RISC-V SBC, let‚Äôs test on <strong>QEMU Emulator for RISC-V</strong>‚Ä¶</p>
<ol>
<li>
<p>Follow these steps to build <strong>NuttX for QEMU Emulator</strong> (64-bit RISC-V)‚Ä¶</p>
<p>TODO</p>
</li>
<li>
<p><strong>If we Enable Build Tracing:</strong> We‚Äôll see‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Build NuttX with Tracing Enabled
$ make --trace

## Compile &quot;hello_main.c&quot; with GCC Compiler
riscv64-unknown-elf-gcc \
  -march=rv64imafdc \
  -mabi=lp64d \
  -c \
  -fno-common \
  -Wall \
  -Wstrict-prototypes \
  -Wshadow \
  -Wundef \
  -Wno-attributes \
  -Wno-unknown-pragmas \
  -Wno-psabi \
  -Os \
  -fno-strict-aliasing \
  -fomit-frame-pointer \
  -ffunction-sections \
  -fdata-sections \
  -g \
  -mcmodel=medany \
  -isystem /Users/Luppy/riscv/nuttx/include \
  -D__NuttX__ \
  -DNDEBUG  \
  -pipe \
  -I &quot;/Users/Luppy/riscv/apps/include&quot; \
  -Dmain=hello_main \
  hello_main.c \
  -o hello_main.c.Users.Luppy.riscv.apps.examples.hello.o

## Compile &quot;hello_rust_main.rs&quot; with Rust Compiler
rustc \
  --target riscv64i-unknown-none-elf \
  --edition 2021 \
  --emit obj \
  -g \
  -C panic=abort \
  -O \
  hello_rust_main.rs \
  -o hello_rust_main.rs.Users.Luppy.riscv.apps.examples.hello_rust.o
</code></pre></div></li>
<li>
<p><strong>If the Build Fails:</strong></p>
<p><em>‚ÄúCould not find specification for target riscv64i-unknown-none-elf‚Äù</em></p>
<p>Then our <strong>Rust Target</strong> is incorrect. We run this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>$ rustup target add riscv64gc-unknown-none-elf
$ pushd ../apps/examples/hello_rust 
$ rustc \
  --target riscv64gc-unknown-none-elf \
  --edition 2021 \
  --emit obj \
  -g \
  -C panic=abort \
  -O \
  hello_rust_main.rs \
  -o hello_rust_main.rs.Users.Luppy.riscv.apps.examples.hello_rust.o
$ popd
$ make
</code></pre></div>
<p>TODO: Fix the path of hello_rust.o</p>
<p>TODO: Test on Linux</p>
<div class="example-wrap"><pre class="language-bash"><code>$ a=$(basename ~/ox64/apps/examples/hello/*.o)
$ b=`
  echo $a \
  | sed &quot;s/hello_main.c/hello_rust_main.rs/&quot; \
  | sed &quot;s/hello.o/hello_rust.o/&quot;
  `
$ echo $b
hello_rust_main.rs.Users.Luppy.ox64.apps.examples.hello_rust.o
</code></pre></div>
<p>(We‚Äôll come back to this)</p>
</li>
<li>
<p>This produces the NuttX ELF Image <strong>nuttx</strong> that we may boot on QEMU RISC-V Emulator.</p>
</li>
</ol>
<p>TODO: Pic of QEMU</p>
<h1 id="test-on-qemu-64-bit-risc-v"><a class="doc-anchor" href="#test-on-qemu-64-bit-risc-v">¬ß</a>3 Test on QEMU 64-bit RISC-V</h1>
<p>We‚Äôre ready to <strong>boot NuttX on QEMU Emulator</strong> and run our Rust App!</p>
<ol>
<li>
<p>Download and install <a href="https://www.qemu.org/download/"><strong>QEMU Emulator</strong></a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## For macOS:
brew install qemu

## For Debian and Ubuntu:
sudo apt install qemu-system-riscv64
</code></pre></div></li>
<li>
<p>Start the <strong>QEMU RISC-V Emulator</strong> (64-bit) with the NuttX ELF Image <strong>nuttx</strong> from the previous section‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>qemu-system-riscv64 \
  -semihosting \
  -M virt,aclint=on \
  -cpu rv64 \
  -smp 8 \
  -bios none \
  -kernel nuttx \
  -nographic
</code></pre></div></li>
<li>
<p>NuttX is now running in the QEMU Emulator! (Pic above)</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-12.4.0-RC0
nsh&gt;
</code></pre></div></li>
<li>
<p>Enter ‚Äú<strong>hello_rust</strong>‚Äù to run our Rust Demo App (which will print something)</p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; hello_rust
Hello, Rust!!
</code></pre></div>
<p>TODO: <a href="https://gist.github.com/lupyuen/31c78de72ade71bbdf63372b44749cd4#file-rust-on-nuttx-build-log-L356-L384">(See the <strong>NuttX Log</strong>)</a></p>
</li>
<li>
<p>Enter ‚Äú<strong>help</strong>‚Äù to see the available commands‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; help
help usage:  help [-v] [&lt;cmd&gt;]

    .           cp          exit        mkdir       rmdir       umount      
    [           cmp         expr        mkrd        set         unset       
    ?           dirname     false       mount       sleep       uptime      
    alias       dd          fdinfo      mv          source      usleep      
    unalias     df          free        pidof       test        xd          
    basename    dmesg       help        printf      time        
    break       echo        hexdump     ps          true        
    cat         env         kill        pwd         truncate    
    cd          exec        ls          rm          uname       

Builtin Apps:
    hello         hello_rust    nsh           ostest        sh       
</code></pre></div></li>
<li>
<p>To Exit QEMU: Press <strong><code>Ctrl-A</code></strong> then <strong><code>x</code></strong></p>
</li>
</ol>
<p>TODO</p>
<div class="example-wrap"><pre class="language-bash"><code>$ qemu-system-riscv64 -semihosting -M virt,aclint=on -cpu rv64 -smp 8 -bios none -kernel nuttx -nographic
ABCnx_start: Entry
uart_register: Registering /dev/console
uart_register: Registering /dev/ttyS0
nx_start_application: Starting init thread
task_spawn: name=nsh_main entry=0x8000745c file_actions=0 attr=0x8003d798 argv=0x8003d790
nxtask_activate: nsh_main pid=1,TCB=0x8003e820

NuttShell (NSH) NuttX-12.4.0-RC0
nsh&gt; nx_start: CPU0: Beginning Idle Loop

nsh&gt; hello_rust
posix_spawn: pid=0x8003f734 path=hello_rust file_actions=0x8003f738 attr=0x8003f740 argv=0x8003f838
nxposix_spawn_exec: ERROR: exec failed: 2
task_spawn: name=hello_rust entry=0x80018622 file_actions=0x8003f738 attr=0x8003f740 argv=0x8003f840
spawn_execattrs: Setting policy=2 priority=100 for pid=2
nxtask_activate: hello_rust pid=2,TCB=0x8003fda0
Hello, Rust!!
abcd
You entered...
abcd

nxtask_exit: hello_rust pid=2,TCB=0x8003fda0
nsh&gt; 
</code></pre></div>
<p><img src="https://lupyuen.github.io/images/rust5-flow3.jpg" alt="TODO" /></p>
<h1 id="rust-target-is-incorrect"><a class="doc-anchor" href="#rust-target-is-incorrect">¬ß</a>4 Rust Target is Incorrect</h1>
<p><em>Why did our Rust Build fail with this error?</em></p>
<div class="example-wrap"><pre class="language-bash"><code>$ rustc hello_rust_main.rs --target riscv64i-unknown-none-elf ...

Could not find specification for target
  &quot;riscv64i-unknown-none-elf&quot;
Run `rustc --print target-list`
  for a list of built-in targets
</code></pre></div>
<p>Rust Compiler doesn‚Äôt recognise <a href="https://en.wikipedia.org/wiki/RISC-V#ISA_base_and_extensions"><strong><code>riscv64i</code></strong></a> as a valid <strong>Rust Target</strong> for 64-bit RISC-V‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## List the Built-In Rust Targets for RISC-V
$ rustup target list | grep riscv

## Nope no riscv64i!
riscv32i-unknown-none-elf
riscv32imac-unknown-none-elf
riscv32imc-unknown-none-elf
riscv64gc-unknown-linux-gnu
riscv64gc-unknown-none-elf
riscv64imac-unknown-none-elf
</code></pre></div>
<p><em>Is riscv64i the correct target for QEMU?</em></p>
<p>Remember earlier we saw <strong>GCC Compiler</strong> and <strong>Rust Compiler</strong>‚Ä¶</p>
<span style="font-size:90%">
<div><table><thead><tr><th style="text-align: left">GCC Compiler</th><th style="text-align: left">Rust Compiler</th></tr></thead><tbody>
<tr><td style="text-align: left"><em>riscv64-unknown-elf-gcc</em> <br> ¬†¬†¬†¬† <em>hello_main.c</em></td><td style="text-align: left"><em>rustc</em> <br> ¬†¬†¬†¬† <em>hello_rust_main.rs</em></td></tr>
<tr><td style="text-align: left"><em>-march</em> <br> ¬†¬†¬†¬†<strong>rv64imafdc</strong></td><td style="text-align: left"><em>‚Äìtarget</em> <br> ¬†¬†¬†<strong>riscv64i-unknown-none-elf</strong></td></tr>
<tr><td style="text-align: left"><em>-mabi</em> <br> ¬†¬†¬†¬†<strong>lp64d</strong></td><td style="text-align: left"></td></tr>
</tbody></table>
</div></span>
<p>From above we see that GCC Compiler uses <strong>Hardware Floating-Point</strong>, but Rust Compiler somehow selected <strong>Software Floating-Point</strong>! (Pic above)</p>
<span style="font-size:90%">
<div><table><thead><tr><th style="text-align: left">GCC Compiler</th><th style="text-align: left">Rust Compiler</th></tr></thead><tbody>
<tr><td style="text-align: left"><strong>rv64imafdc</strong></td><td style="text-align: left"><strong>riscv64i</strong></td></tr>
<tr><td style="text-align: left">- <strong>I</strong>: Integer</td><td style="text-align: left">- <strong>I</strong>: Integer</td></tr>
<tr><td style="text-align: left">- <strong>F</strong>: Single Hard-Float</td><td style="text-align: left"><em>(Default is Soft-Float)</em></td></tr>
<tr><td style="text-align: left">- <strong>D</strong>: Double Hard-Float</td><td style="text-align: left"><em>(Default is Soft-Float)</em></td></tr>
</tbody></table>
</div></span>
<p>Let‚Äôs harmonise Rust Compiler with GCC Compiler: We select <a href="https://en.wikipedia.org/wiki/RISC-V#ISA_base_and_extensions"><strong><code>rv64gc</code></strong></a>, since it‚Äôs closest to <a href="https://en.wikipedia.org/wiki/RISC-V#ISA_base_and_extensions"><strong>Hardware Floating-Point</strong></a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>$ rustup target add riscv64gc-unknown-none-elf
$ pushd ../apps/examples/hello_rust 
$ rustc \
  --target riscv64gc-unknown-none-elf \
  --edition 2021 \
  --emit obj \
  -g \
  -C panic=abort \
  -O \
  hello_rust_main.rs \
  -o hello_rust_main.rs.Users.Luppy.riscv.apps.examples.hello_rust.o
$ popd
$ make
</code></pre></div>
<p>TODO: Fix the path of hello_rust.o</p>
<p>This fixes our build. For now! (Pic below)</p>
<p>(<a href="https://www.qemu.org/docs/master/system/riscv/virt.html#supported-devices"><strong>QEMU</strong></a> officially supports <a href="https://www.qemu.org/docs/master/system/riscv/virt.html#supported-devices"><strong><code>rv64gc</code></strong></a>)</p>
<p>(‚Äú<strong><code>gc</code></strong>‚Äù in ‚Äú<strong><code>rv64gc</code></strong>‚Äù denotes <a href="https://en.wikipedia.org/wiki/RISC-V#ISA_base_and_extensions"><strong>IMAFDC</strong></a>)</p>
<p><img src="https://lupyuen.github.io/images/rust5-flow.jpg" alt="TODO" /></p>
<h1 id="compile-rust-app-for-ox64-sbc"><a class="doc-anchor" href="#compile-rust-app-for-ox64-sbc">¬ß</a>5 Compile Rust App for Ox64 SBC</h1>
<p><em>Our Rust App runs OK on QEMU RISC-V. What about Ox64 BL808 SBC?</em></p>
<p>Let‚Äôs compile our Rust App for <strong>Ox64 BL808 RISC-V SBC</strong> (also 64-bit)‚Ä¶</p>
<ol>
<li>
<p>Follow these steps to build <strong>NuttX for Ox64</strong>‚Ä¶</p>
<p>TODO</p>
</li>
<li>
<p>Remember to <strong>Rename the Main Function</strong>.</p>
<p>Look for this line in <a href="TODO"><strong>hello_rust_main.rs</strong></a>‚Ä¶</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">pub extern </span><span class="string">"C" </span><span class="kw">fn </span>hello_rust_main(...)</code></pre></div>
<p>And rename the function to this‚Ä¶</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">pub extern </span><span class="string">"C" </span><span class="kw">fn </span>main(...)</code></pre></div>
<p>(We‚Äôll see why)</p>
</li>
<li>
<p><strong>If we Enable Build Tracing:</strong> We‚Äôll see‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Build NuttX with Tracing Enabled
$ make --trace import

riscv64-unknown-elf-gcc \
  -march=rv64imafdc \
  -mabi=lp64d \
  -c \
  -fno-common \
  -Wall \
  -Wstrict-prototypes \
  -Wshadow \
  -Wundef \
  -Wno-attributes \
  -Wno-unknown-pragmas \
  -Wno-psabi \
  -fno-common \
  -pipe  \
  -Os \
  -fno-strict-aliasing \
  -fomit-frame-pointer \
  -ffunction-sections \
  -fdata-sections \
  -g \
  -mcmodel=medany \
  -isystem /Users/Luppy/ox64/apps/import/include \
  -isystem /Users/Luppy/ox64/apps/import/include \
  -D__NuttX__  \
  -I &quot;/Users/Luppy/ox64/apps/include&quot;   hello_main.c \
  -o  hello_main.c.Users.Luppy.ox64.apps.examples.hello.o
</code></pre></div></li>
<li>
<p><strong>If the Build Fails:</strong></p>
<p><em>‚Äútarget hello_rust_install does not exist‚Äù</em></p>
<p>Then our <strong>Makefile Target</strong> is missing. We run this‚Ä¶</p>
<p>TODO</p>
<div class="example-wrap"><pre class="language-bash"><code>$ rustup target add riscv64gc-unknown-none-elf
$ pushd ../apps/examples/hello_rust 
$ rustc \
  --target riscv64gc-unknown-none-elf \
  --edition 2021 \
  --emit obj \
  -g \
  -C panic=abort \
  -O \
  hello_rust_main.rs \
  -o hello_rust_main.rs.Users.Luppy.ox64.apps.examples.hello_rust.o
$ popd
$ make import
</code></pre></div>
<p>TODO: Fix the path of hello_rust.o</p>
<p>(We‚Äôll come back to this)</p>
</li>
<li>
<p>This produces the NuttX <strong>Image</strong> that we may boot on Ox64 SBC.</p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/rust5-title.jpg" alt="Rust App on Ox64 BL808 RISC-V SBC and Apache NuttX RTOS" /></p>
<h1 id="run-rust-app-on-ox64-sbc"><a class="doc-anchor" href="#run-rust-app-on-ox64-sbc">¬ß</a>6 Run Rust App on Ox64 SBC</h1>
<p>Follow these steps to boot NuttX on Ox64 SBC and run our Rust App‚Ä¶</p>
<p>TODO</p>
<ol>
<li>
<p>NuttX is now running on Ox64 SBC! (Pic above)</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-12.4.0-RC0
nsh&gt;
</code></pre></div></li>
<li>
<p>Enter ‚Äú<strong>hello_rust</strong>‚Äù to run our Rust Demo App (which will print something)</p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; hello_rust
Hello, Rust!!
</code></pre></div>
<p>TODO: <a href="https://gist.github.com/lupyuen/31c78de72ade71bbdf63372b44749cd4#file-rust-on-nuttx-build-log-L356-L384">(See the <strong>NuttX Log</strong>)</a></p>
</li>
</ol>
<p>Yep Rust Apps will run OK on Ox64 BL808 RISC-V SBC!</p>
<p>TODO</p>
<div class="example-wrap"><pre class="language-bash"><code>Enter choice: 1:.Pine64 0X64 Kernel
Retrieving file: /extlinux/../Image
append: root=PARTLABEL=rootfs rootwait rw rootfstype=ext4 console=ttyS0,2000000 loglevel=8 earlyextlinux/../bl808-pine64-ox64.dt## Flattened Device Tree blob at 51ff8000
   Booting using the fdt blob at 0x51ff8000
Working  51ff8000
   Loading Device Tree to 0000000053f22000, end 0000000053f25fab ... OK
Working FDT set to 53f22000

Starting kernel ...

ABCnx_start: Entry
uart_register: Registering /dev/console
work_start_lowpri: Starting low-priority kernel worker thread(s)
nxtask_activate: lpwork pid=1,TCB=0x50409110
nxtask_activate: AppBringUp pid=2,TCB=0x50409710
nx_start_application: Starting init task: /system/bin/init
elf_symname: Symbol has no name
elf_symvalue: SHN_UNDEF: Failed to get symbol name: -3
elf_relocateadd: Section 2 reloc 2: Undefined symbol[0] has no name: -3
nxtask_activate: /system/bin/init pid=3,TCB=0x5040b730
nxtask_exit: AppBringUp pid=2,TCB=0x50409710

NuttShell (NSH) NuttX-12.4.0-RC0
nsh&gt; nx_start: CPU0: Beginning Idle Loop

nsh&gt; 
nsh&gt; hello_rust
posix_spawn: pid=0x80202968 path=hello_rust file_actions=0x80202970 attr=0x80202978 argv=0x80202a18
elf_symname: Symbol has no name
elf_symvalue: SHN_UNDEF: Failed to get symbol name: -3
elf_relocateadd: Section 2 reloc 1: Undefined symbol[0] has no name: -3
nxtask_activate: hello_rust pid=6,TCB=0x50409790
Hello, Rust!!

You entered...


nxtask_exit: hello_rust pid=6,TCB=0x50409790
nsh&gt; 
</code></pre></div>
<p><img src="https://lupyuen.github.io/images/rust5-flat.jpg" alt="NuttX Flat Mode" /></p>
<h1 id="nuttx-flat-mode-vs-kernel-mode"><a class="doc-anchor" href="#nuttx-flat-mode-vs-kernel-mode">¬ß</a>7 NuttX Flat Mode vs Kernel Mode</h1>
<p><em>Why the funny fixes for NuttX Ox64?</em></p>
<p>Earlier we saw 2 workarounds for our Ox64 NuttX Build‚Ä¶</p>
<ul>
<li>
<p>We renamed the <strong>Main Function</strong></p>
</li>
<li>
<p>We fixed the <strong>Makefile Target</strong></p>
</li>
</ul>
<p>That‚Äôs because <strong>Ox64 Apps</strong> are a little more complicated than <strong>QEMU Apps</strong>‚Ä¶</p>
<p><strong>NuttX QEMU</strong> runs in <strong>Flat Mode</strong> (pic above)</p>
<ul>
<li>
<p>NuttX Apps are <strong>Statically Linked</strong> into NuttX Kernel</p>
</li>
<li>
<p><strong>Main Functions</strong> for Apps are named <em>hello_main()</em>, <em>hello_rust_main()</em>, ‚Ä¶</p>
</li>
<li>
<p><strong>No Memory Protection</strong> between Apps and Kernel</p>
</li>
<li>
<p>Everything runs in <strong>RISC-V Machine Mode</strong></p>
</li>
<li>
<p>A little easier to troubleshoot</p>
</li>
</ul>
<p><strong>NuttX Ox64</strong> runs in <strong>Kernel Mode</strong> (pic below)</p>
<ul>
<li>
<p>NuttX Apps are <strong>Separate ELF Files</strong></p>
</li>
<li>
<p><strong>Main Functions</strong> for Apps are all named <em>main()</em></p>
</li>
<li>
<p>Apps and Kernel live in <strong>Protected Memory Regions</strong></p>
</li>
<li>
<p>Kernel runs in <strong>RISC-V Supervisor Mode</strong></p>
</li>
<li>
<p>Apps run in <strong>RISC-V User Mode</strong></p>
</li>
<li>
<p>More realistic for Actual Hardware</p>
</li>
</ul>
<p>TODO: (More about Kernel Mode)</p>
<p><img src="https://lupyuen.github.io/images/rust5-kernel.jpg" alt="NuttX Kernel Mode" /></p>
<p>That‚Äôs why the fixes for Ox64 are more complex than QEMU.</p>
<p>Fix them in GSoC</p>
<p>TODO: Appendix</p>
<p>-Dmain=hello_main</p>
<p><em>Can we run NuttX QEMU in Kernel Mode?</em></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/rust5-flow.jpg" alt="TODO" /></p>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>8 What‚Äôs Next</h1>
<p>TODO</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> (and the awesome NuttX Community) for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-ox64"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-star64"><strong>My Other Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>Older Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/rust5.md"><strong>lupyuen.github.io/src/rust5.md</strong></a></p>
<p><img src="https://lupyuen.github.io/images/rust5-flow.jpg" alt="TODO" /></p>
<h1 id="appendix-build-nuttx-for-qemu"><a class="doc-anchor" href="#appendix-build-nuttx-for-qemu">¬ß</a>9 Appendix: Build NuttX for QEMU</h1>
<p>Follow these steps to build <strong>NuttX for QEMU Emulator</strong> (64-bit RISC-V)‚Ä¶</p>
<p>TODO</p>
<div class="example-wrap"><pre class="language-bash"><code>TODO: git clone
$ tools/configure.sh rv-virt:nsh64
$ make menuconfig
## TODO: Enable &quot;Hello Rust&quot; Example App
## https://github.com/lupyuen2/wip-nuttx/blob/rust/boards/risc-v/qemu-rv/rv-virt/configs/nsh64/defconfig

## Build NuttX with Tracing Enabled
$ make --trace

## Compile &quot;hello_main.c&quot; with GCC Compiler
riscv64-unknown-elf-gcc \
  -march=rv64imafdc \
  -mabi=lp64d \
  -c \
  -fno-common \
  -Wall \
  -Wstrict-prototypes \
  -Wshadow \
  -Wundef \
  -Wno-attributes \
  -Wno-unknown-pragmas \
  -Wno-psabi \
  -Os \
  -fno-strict-aliasing \
  -fomit-frame-pointer \
  -ffunction-sections \
  -fdata-sections \
  -g \
  -mcmodel=medany \
  -isystem /Users/Luppy/riscv/nuttx/include \
  -D__NuttX__ \
  -DNDEBUG  \
  -pipe \
  -I &quot;/Users/Luppy/riscv/apps/include&quot; \
  -Dmain=hello_main  hello_main.c \
  -o  hello_main.c.Users.Luppy.riscv.apps.examples.hello.o

## Compile &quot;hello_rust_main.rs&quot; with Rust Compiler
rustc \
  --target riscv64i-unknown-none-elf \
  --edition 2021 \
  --emit obj \
  -g \
  -C panic=abort \
  -O \
  hello_rust_main.rs \
  -o hello_rust_main.rs.Users.Luppy.riscv.apps.examples.hello_rust.o

error: Error loading target specification: Could not find specification for target &quot;riscv64i-unknown-none-elf&quot;. Run `rustc --print target-list` for a list of built-in targets

make[2]: *** [/Users/Luppy/riscv/apps/Application.mk:275: hello_rust_main.rs.Users.Luppy.riscv.apps.examples.hello_rust.o] Error 1
make[1]: *** [Makefile:51: /Users/Luppy/riscv/apps/examples/hello_rust_all] Error 2
make: *** [tools/LibTargets.mk:232: /Users/Luppy/riscv/apps/libapps.a] Error 2
</code></pre></div><h1 id="appendix-build-nuttx-for-ox64-sbc"><a class="doc-anchor" href="#appendix-build-nuttx-for-ox64-sbc">¬ß</a>10 Appendix: Build NuttX for Ox64 SBC</h1>
<p>Follow these steps to build <strong>NuttX for Ox64 BL808 SBC</strong>‚Ä¶</p>
<p>TODO</p>
<div class="example-wrap"><pre class="language-bash"><code>TODO: git clone
$ tools/configure.sh ox64:nsh
$ make menuconfig
## TODO: Enable &quot;Hello Rust&quot; Example App
## https://github.com/lupyuen2/wip-nuttx/blob/rust/boards/risc-v/bl808/ox64/configs/nsh/defconfig
$ make

## Build NuttX with Tracing Enabled
$ make --trace export
$ pushd ../apps

## Build NuttX with Tracing Enabled
$ make --trace import

riscv64-unknown-elf-gcc \
  -march=rv64imafdc \
  -mabi=lp64d \
  -c \
  -fno-common \
  -Wall \
  -Wstrict-prototypes \
  -Wshadow \
  -Wundef \
  -Wno-attributes \
  -Wno-unknown-pragmas \
  -Wno-psabi \
  -fno-common \
  -pipe  \
  -Os \
  -fno-strict-aliasing \
  -fomit-frame-pointer \
  -ffunction-sections \
  -fdata-sections \
  -g \
  -mcmodel=medany \
  -isystem /Users/Luppy/ox64/apps/import/include \
  -isystem /Users/Luppy/ox64/apps/import/include \
  -D__NuttX__  \
  -I &quot;/Users/Luppy/ox64/apps/include&quot; \
  hello_main.c \
  -o  hello_main.c.Users.Luppy.ox64.apps.examples.hello.o

Makefile:52: target &#39;/Users/Luppy/ox64/apps/examples/hello_rust_install&#39; does not exist
make -C /Users/Luppy/ox64/apps/examples/hello_rust install APPDIR=&quot;/Users/Luppy/ox64/apps&quot;
make[3]: Entering directory &#39;/Users/Luppy/ox64/apps/examples/hello_rust&#39;
make[3]: *** No rule to make target &#39;hello_rust_main.rs.Users.Luppy.ox64.apps.examples.hello_rust.o&#39;, needed by &#39;/Users/Luppy/ox64/apps/bin/hello_rust&#39;.  Stop.
make[3]: Leaving directory &#39;/Users/Luppy/ox64/apps/examples/hello_rust&#39;
make[2]: *** [Makefile:52: /Users/Luppy/ox64/apps/examples/hello_rust_install] Error 2
make[2]: Leaving directory &#39;/Users/Luppy/ox64/apps&#39;
make[1]: *** [Makefile:78: .import] Error 2
make[1]: Leaving directory &#39;/Users/Luppy/ox64/apps&#39;
make: *** [Makefile:84: import] Error 2
</code></pre></div>
<p>Like QEMU, we change riscv64i to riscv64gc‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>$ rustup target add riscv64gc-unknown-none-elf
$ pushd ../apps/examples/hello_rust 
$ rustc \
  --target riscv64gc-unknown-none-elf \
  --edition 2021 \
  --emit obj \
  -g \
  -C panic=abort \
  -O \
  hello_rust_main.rs \
  -o hello_rust_main.rs.Users.Luppy.ox64.apps.examples.hello_rust.o
$ popd
$ make import
</code></pre></div><h1 id="appendix-run-nuttx-on-ox64-emulator"><a class="doc-anchor" href="#appendix-run-nuttx-on-ox64-emulator">¬ß</a>11 Appendix: Run NuttX on Ox64 Emulator</h1>
<p>Our Rust App runs OK on Ox64 BL808 Emulator, here‚Äôs how‚Ä¶</p>
<p>TODO: Build Ox64 Emulator</p>
<div class="example-wrap"><pre class="language-bash"><code>+ cp /Users/Luppy/riscv/nuttx-tinyemu/docs/quickjs/root-riscv64.cfg .
+ /Users/Luppy/riscv/ox64-tinyemu/temu root-riscv64.cfg
TinyEMU Emulator for Ox64 BL808 RISC-V SBC
virtio_console_init
Patched DCACHE.IALL (Invalidate all Page Table Entries in the D-Cache) at 0x5020099a
Patched SYNC.S (Ensure that all Cache Operations are completed) at 0x5020099e
Found ECALL (Start System Timer) at 0x5020bfac
Patched RDTIME (Read System Time) at 0x5020bfb2
elf_len=0
virtio_console_resize_event
ABCnx_start: Entry
uart_register: Registering /dev/console
work_start_lowpri: Starting low-priority kernel worker thread(s)
nxtask_activate: lpwork pid=1,TCB=0x50409110
nxtask_activate: AppBringUp pid=2,TCB=0x50409710
nx_start_application: Starting init task: /system/bin/init
elf_symname: Symbol has no name
elf_symvalue: SHN_UNDEF: Failed to get symbol name: -3
elf_relocateadd: Section 2 reloc 2: Undefined symbol[0] has no name: -3
nxtask_activate: /system/bin/init pid=3,TCB=0x5040b730
nxtask_exit: AppBringUp pid=2,TCB=0x50409710

NuttShell (NSH) NuttX-12.4.0-RC0
nsh&gt; nx_start: CPU0: Beginning Idle Loop

nsh&gt; hello_rust
posix_spawn: pid=0x80202968 path=hello_rust file_actions=0x80202970 attr=0x80202978 argv=0x80202a18
elf_symname: Symbol has no name
elf_symvalue: SHN_UNDEF: Failed to get symbol name: -3
elf_relocateadd: Section 2 reloc 1: Undefined symbol[0] has no name: -3
nxtask_activate: hello_rust pid=6,TCB=0x50409790
Hello, Rust!!
Hello Ox64!
You entered...
Hello Ox64!

nxtask_exit: hello_rust pid=6,TCB=0x50409790
nsh&gt; 
</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx-ox64/raw/main/nuttx.cfg">(root-riscv64.cfg is here)</a></p>
<h1 id="appendix-main-function-is-missing"><a class="doc-anchor" href="#appendix-main-function-is-missing">¬ß</a>12 Appendix: Main Function is Missing</h1>
<p>TODO</p>
<p>We test it with <a href="https://lupyuen.github.io/articles/tinyemu3">Ox64 BL808 Emulator</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>+ riscv64-unknown-elf-objdump --syms --source --reloc --demangle --line-numbers --wide --debugging nuttx
+ cp /Users/Luppy/riscv/nuttx-tinyemu/docs/quickjs/root-riscv64.cfg .
+ /Users/Luppy/riscv/ox64-tinyemu/temu root-riscv64.cfg
TinyEMU Emulator for Ox64 BL808 RISC-V SBC

NuttShell (NSH) NuttX-12.4.0-RC0
nsh&gt; hello_rust
nsh: hello_rust: command not found
</code></pre></div>
<p><em>Huh? Why is hello_rust not found?</em></p>
<p>To find out, we <a href="https://github.com/lupyuen2/wip-nuttx/commit/dca29d561f44c4749c067b8304dc898b1c6c6e0c">Enable Logging for Binary Loader and Scheduler</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>CONFIG_DEBUG_BINFMT=y
CONFIG_DEBUG_BINFMT_ERROR=y
CONFIG_DEBUG_BINFMT_WARN=y
CONFIG_DEBUG_SCHED=y
CONFIG_DEBUG_SCHED_ERROR=y
CONFIG_DEBUG_SCHED_INFO=y
CONFIG_DEBUG_SCHED_WARN=y
</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx-ox64/raw/main/nuttx.cfg">(root-riscv64.cfg is here)</a></p>
<p>Now it tells us why it failed‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>+ riscv64-unknown-elf-objdump --syms --source --reloc --demangle --line-numbers --wide --debugging nuttx
+ cp /Users/Luppy/riscv/nuttx-tinyemu/docs/quickjs/root-riscv64.cfg .
+ /Users/Luppy/riscv/ox64-tinyemu/temu root-riscv64.cfg
TinyEMU Emulator for Ox64 BL808 RISC-V SBC
virtio_console_init
Patched DCACHE.IALL (Invalidate all Page Table Entries in the D-Cache) at 0x5020099a
Patched SYNC.S (Ensure that all Cache Operations are completed) at 0x5020099e
Found ECALL (Start System Timer) at 0x5020bfac
Patched RDTIME (Read System Time) at 0x5020bfb2
elf_len=0
virtio_console_resize_event
ABCnx_start: Entry
uart_register: Registering /dev/console
work_start_lowpri: Starting low-priority kernel worker thread(s)
nxtask_activate: lpwork pid=1,TCB=0x50409110
nxtask_activate: AppBringUp pid=2,TCB=0x50409710
nx_start_application: Starting init task: /system/bin/init
elf_symname: Symbol has no name
elf_symvalue: SHN_UNDEF: Failed to get symbol name: -3
elf_relocateadd: Section 2 reloc 2: Undefined symbol[0] has no name: -3
nxtask_activate: /system/bin/init pid=3,TCB=0x5040b730
nxtask_exit: AppBringUp pid=2,TCB=0x50409710

NuttShell (NSH) NuttX-12.4.0-RC0
nsh&gt; nx_start: CPU0: Beginning Idle Loop

nsh&gt; 
nsh&gt; hello_rust
posix_spawn: pid=0x80202968 path=hello_rust file_actions=0x80202970 attr=0x80202978 argv=0x80202a18
elf_symname: Symbol has no name
elf_symvalue: SHN_UNDEF: Failed to get symbol name: -3
elf_relocateadd: Section 2 reloc 1: Undefined symbol[0] has no name: -3
elf_symvalue: SHN_UNDEF: Exported symbol &quot;main&quot; not found
elf_relocateadd: Section 2 reloc 4: Failed to get value of symbol[7684]: -2
elf_loadbinary: Failed to bind symbols program binary: -2
exec_internal: ERROR: Failed to load program &#39;hello_rust&#39;: -2
nxposix_spawn_exec: ERROR: exec failed: 2
nsh: hello_rust: command not found
nsh&gt; 
</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx-ox64/raw/main/nuttx.cfg">(root-riscv64.cfg is here)</a></p>
<p>Which fails because the main() function is missing!</p>
<p>TODO: Why?</p>
<p>So we change this in hello_rust_main.rs‚Ä¶</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">pub extern </span><span class="string">"C" </span><span class="kw">fn </span>hello_rust_main(...)</code></pre></div>
<p>To this‚Ä¶</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">pub extern </span><span class="string">"C" </span><span class="kw">fn </span>main(...)</code></pre></div>
<p><em>What happens if we don‚Äôt change it?</em></p>
<p>TODO</p>
<h1 id="appendix-makefile-target-is-missing"><a class="doc-anchor" href="#appendix-makefile-target-is-missing">¬ß</a>13 Appendix: Makefile Target is Missing</h1>
<p>TODO</p>
<div class="example-wrap"><pre class="language-bash"><code>Makefile:52: target &#39;/Users/Luppy/ox64/apps/examples/hello_rust_install&#39; does not exist
make -C /Users/Luppy/ox64/apps/examples/hello_rust install APPDIR=&quot;/Users/Luppy/ox64/apps&quot;
make[3]: Entering directory &#39;/Users/Luppy/ox64/apps/examples/hello_rust&#39;
make[3]: *** No rule to make target &#39;hello_rust_main.rs.Users.Luppy.ox64.apps.examples.hello_rust.o&#39;, needed by &#39;/Users/Luppy/ox64/apps/bin/hello_rust&#39;.  Stop.
make[3]: Leaving directory &#39;/Users/Luppy/ox64/apps/examples/hello_rust&#39;
make[2]: *** [Makefile:52: /Users/Luppy/ox64/apps/examples/hello_rust_install] Error 2
make[2]: Leaving directory &#39;/Users/Luppy/ox64/apps&#39;
make[1]: *** [Makefile:78: .import] Error 2
make[1]: Leaving directory &#39;/Users/Luppy/ox64/apps&#39;
make: *** [Makefile:84: import] Error 2
</code></pre></div>
<p>Like QEMU, we change riscv64i to riscv64gc‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>$ rustup target add riscv64gc-unknown-none-elf
$ pushd ../apps/examples/hello_rust 
$ rustc \
  --target riscv64gc-unknown-none-elf \
  --edition 2021 \
  --emit obj \
  -g \
  -C panic=abort \
  -O \
  hello_rust_main.rs \
  -o hello_rust_main.rs.Users.Luppy.ox64.apps.examples.hello_rust.o
$ popd
$ make import
</code></pre></div>
<p>TODO: Fix the path of hello_rust.o</p>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>