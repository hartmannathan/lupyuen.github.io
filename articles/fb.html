<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>NuttX RTOS for PinePhone: Framebuffer</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="NuttX RTOS for PinePhone: Framebuffer" 
    data-rh="true">
<meta property="og:description" 
    content="How NuttX Apps call the NuttX Framebuffer Interface to render graphics... And what's inside the Framebuffer Driver for Pine64 PinePhone"
    data-rh="true">
<meta name="description" 
    content="How NuttX Apps call the NuttX Framebuffer Interface to render graphics... And what's inside the Framebuffer Driver for Pine64 PinePhone">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/fb-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">NuttX RTOS for PinePhone: Framebuffer</h1>
    <nav id="TOC"><ul>
<li><a href="#framebuffer-interface">1 Framebuffer Interface</a><ul></ul></li>
<li><a href="#render-grey-screen">2 Render Grey Screen</a><ul></ul></li>
<li><a href="#render-blocks">3 Render Blocks</a><ul></ul></li>
<li><a href="#render-circle">4 Render Circle</a><ul></ul></li>
<li><a href="#render-rectangle">5 Render Rectangle</a><ul></ul></li>
<li><a href="#pinephone-framebuffer-driver">6 PinePhone Framebuffer Driver</a><ul></ul></li>
<li><a href="#missing-pixels-in-pinephone-image">7 Missing Pixels in PinePhone Image</a><ul></ul></li>
<li><a href="#fix-missing-pixels-in-pinephone-image">8 Fix Missing Pixels in PinePhone Image</a><ul></ul></li>
<li><a href="#lvgl-on-nuttx-on-pinephone">9 LVGL on NuttX on PinePhone</a><ul></ul></li>
<li><a href="#whats-next">10 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>7 Jan 2023</em></p>
<p><img src="https://lupyuen.github.io/images/fb-title.jpg" alt="TODO" /></p>
<p>TODO: How NuttX Apps call the NuttX Framebuffer Interface to render graphics‚Ä¶ And what‚Äôs inside the Framebuffer Driver for Pine64 PinePhone</p>
<p>TODO: Missing pixels</p>
<p><a href="https://nuttx.apache.org/docs/latest/"><strong>Apache NuttX RTOS</strong></a> now boots on <a href="https://wiki.pine64.org/index.php/PinePhone"><strong>Pine64 PinePhone</strong></a></p>
<h1 id="framebuffer-interface"><a href="#framebuffer-interface">1 Framebuffer Interface</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/fb/examples/fb/fb_main.c#L332-L353">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  /* Open the framebuffer driver */

  state.fd = open(fbdev, O_RDWR);
  if (state.fd &lt; 0)
    {
      int errcode = errno;
      fprintf(stderr, &quot;ERROR: Failed to open %s: %d\n&quot;, fbdev, errcode);
      return EXIT_FAILURE;
    }

  /* Get the characteristics of the framebuffer */

  ret = ioctl(state.fd, FBIOGET_VIDEOINFO,
              (unsigned long)((uintptr_t)&amp;state.vinfo));
  if (ret &lt; 0)
    {
      int errcode = errno;
      fprintf(stderr, &quot;ERROR: ioctl(FBIOGET_VIDEOINFO) failed: %d\n&quot;,
              errcode);
      close(state.fd);
      return EXIT_FAILURE;
    }</code></pre></div>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/fb/examples/fb/fb_main.c#L438-L456">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  /* mmap() the framebuffer.
   *
   * NOTE: In the FLAT build the frame buffer address returned by the
   * FBIOGET_PLANEINFO IOCTL command will be the same as the framebuffer
   * address.  mmap(), however, is the preferred way to get the framebuffer
   * address because in the KERNEL build, it will perform the necessary
   * address mapping to make the memory accessible to the application.
   */

  state.fbmem = mmap(NULL, state.pinfo.fblen, PROT_READ | PROT_WRITE,
                     MAP_SHARED | MAP_FILE, state.fd, 0);
  if (state.fbmem == MAP_FAILED)
    {
      int errcode = errno;
      fprintf(stderr, &quot;ERROR: ioctl(FBIOGET_PLANEINFO) failed: %d\n&quot;,
              errcode);
      close(state.fd);
      return EXIT_FAILURE;
    }
</code></pre></div><h1 id="render-grey-screen"><a href="#render-grey-screen">2 Render Grey Screen</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/fb/examples/fb/fb_main.c#L541-L562">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>static void render_grey(struct fb_state_s *state) {
  // Fill entire framebuffer with grey
  memset(
    state-&gt;pinfo.fbmem,
    0x80,
    state-&gt;pinfo.fblen
  );

#ifdef CONFIG_FB_UPDATE
  // Update the framebuffer
  struct fb_area_s area =
  {
    .x = 0,
    .y = 0,
    .w = state-&gt;pinfo.xres_virtual,
    .h = state-&gt;pinfo.yres_virtual
  };
  int ret = ioctl(state-&gt;fd, FBIO_UPDATE,
                  (unsigned long)((uintptr_t)&amp;area));
  DEBUGASSERT(ret == OK);
#endif
}</code></pre></div>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/fb/examples/fb/fb_main.c#L508-L509">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>  munmap(state.fbmem, state.pinfo.fblen);
  close(state.fd);</code></pre></div><h1 id="render-blocks"><a href="#render-blocks">3 Render Blocks</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/fb/examples/fb/fb_main.c#L564-L601">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>static void render_blocks(struct fb_state_s *state) {
  // Fill framebuffer with Blue, Green and Red Blocks
  uint32_t *fbmem = state-&gt;pinfo.fbmem;
  const size_t fblen = state-&gt;pinfo.fblen / 4;  // 4 bytes per pixel

  // For every pixel...
  for (int i = 0; i &lt; fblen; i++) {

    // Colors are in XRGB 8888 format
    if (i &lt; fblen / 4) {
      // Blue for top quarter.
      // RGB24_BLUE is 0x0000 00FF
      fbmem[i] = RGB24_BLUE;
    } else if (i &lt; fblen / 2) {
      // Green for next quarter.
      // RGB24_GREEN is 0x0000 FF00
      fbmem[i] = RGB24_GREEN;
    } else {
      // Red for lower half.
      // RGB24_RED is 0x00FF 0000
      fbmem[i] = RGB24_RED;
    }
  }

#ifdef CONFIG_FB_UPDATE
  // Update the framebuffer
  struct fb_area_s area =
  {
    .x = 0,
    .y = 0,
    .w = state-&gt;pinfo.xres_virtual,
    .h = state-&gt;pinfo.yres_virtual
  };
  int ret = ioctl(state-&gt;fd, FBIO_UPDATE,
                  (unsigned long)((uintptr_t)&amp;area));
  DEBUGASSERT(ret == OK);
#endif
}</code></pre></div><h1 id="render-circle"><a href="#render-circle">4 Render Circle</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/fb/examples/fb/fb_main.c#L603-L651">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>static void render_circle(struct fb_state_s *state) {
  // Fill framebuffer with Green Circle
  uint32_t *fbmem = state-&gt;pinfo.fbmem;
  const size_t fblen = state-&gt;pinfo.fblen / 4;  // 4 bytes per pixel
  const uint32_t width = state-&gt;pinfo.xres_virtual;
  const uint32_t height = state-&gt;pinfo.yres_virtual;

  // For every pixel row...
  for (int y = 0; y &lt; height; y++) {

    // For every pixel column...
    for (int x = 0; x &lt; width; x++) {

      // Get pixel index
      const int p = (y * width) + x;
      DEBUGASSERT(p &lt; fblen);

      // Shift coordinates so that centre of screen is (0,0)
      const int half_width  = width  / 2;
      const int half_height = height / 2;
      const int x_shift = x - half_width;
      const int y_shift = y - half_height;

      // If x^2 + y^2 &lt; radius^2, set the pixel to Green.
      // Colors are in XRGB 8888 format.
      if (x_shift*x_shift + y_shift*y_shift &lt; half_width*half_width) {
        // RGB24_GREEN is 0x0000 FF00
        fbmem[p] = RGB24_GREEN;
      } else {  // Otherwise set to Transparent Black
        // RGB24_BLACK is 0x0000 0000
        fbmem[p] = RGB24_BLACK;
      }
    }
  }

#ifdef CONFIG_FB_UPDATE
  // Update the framebuffer
  struct fb_area_s area =
  {
    .x = 0,
    .y = 0,
    .w = state-&gt;pinfo.xres_virtual,
    .h = state-&gt;pinfo.yres_virtual
  };
  int ret = ioctl(state-&gt;fd, FBIO_UPDATE,
                  (unsigned long)((uintptr_t)&amp;area));
  DEBUGASSERT(ret == OK);
#endif
}</code></pre></div><h1 id="render-rectangle"><a href="#render-rectangle">5 Render Rectangle</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/fb/examples/fb/fb_main.c#L472-L480">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>area.x = x;
area.y = y;
area.w = width;
area.h = height;
draw_rect(&amp;state, &amp;area, color);</code></pre></div><h1 id="pinephone-framebuffer-driver"><a href="#pinephone-framebuffer-driver">6 PinePhone Framebuffer Driver</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L117-L241">pinephone_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>/* Vtable for Frame Buffer Operations */

static struct fb_vtable_s g_pinephone_vtable =
{
  .getvideoinfo    = pinephone_getvideoinfo,
  .getplaneinfo    = pinephone_getplaneinfo,
  .updatearea      = pinephone_updatearea,
  .getoverlayinfo  = pinephone_getoverlayinfo,
  .settransp       = pinephone_settransp,
  .setchromakey    = pinephone_setchromakey,
  .setcolor        = pinephone_setcolor,
  .setblank        = pinephone_setblank,
  .setarea         = pinephone_setarea
};

/* Frame Buffers for Display Engine *****************************************/

/* Frame Buffer 0: (Base UI Channel)
 * Fullscreen 720 x 1440 (4 bytes per XRGB 8888 pixel)
 */

static uint32_t g_pinephone_fb0[PANEL_WIDTH * PANEL_HEIGHT];

/* Frame Buffer 1: (First Overlay UI Channel)
 * Square 600 x 600 (4 bytes per ARGB 8888 pixel)
 */

static uint32_t g_pinephone_fb1[FB1_WIDTH * FB1_HEIGHT];

/* Frame Buffer 2: (Second Overlay UI Channel)
 * Fullscreen 720 x 1440 (4 bytes per ARGB 8888 pixel)
 */

static uint32_t g_pinephone_fb2[PANEL_WIDTH * PANEL_HEIGHT];

/* Video Controller for 3 UI Channels:
 * Fullscreen 720 x 1440 (4 bytes per ARGB 8888 pixel)
 */

static struct fb_videoinfo_s g_pinephone_video =
{
  .fmt       = FB_FMT_RGBA32,  /* Pixel format (XRGB 8888) */
  .xres      = PANEL_WIDTH,    /* Horizontal resolution in pixel columns */
  .yres      = PANEL_HEIGHT,   /* Vertical resolution in pixel rows */
  .nplanes   = 1,              /* Color planes: Base UI Channel */
  .noverlays = 2               /* Overlays: 2 Overlay UI Channels) */
};

/* Color Plane for Base UI Channel:
 * Fullscreen 720 x 1440 (4 bytes per XRGB 8888 pixel)
 */

static struct fb_planeinfo_s g_pinephone_plane =
{
  .fbmem        = &amp;g_pinephone_fb0,
  .fblen        = sizeof(g_pinephone_fb0),
  .stride       = PANEL_WIDTH * 4,  /* Length of a line (4-byte pixel) */
  .display      = 0,                /* Display number (Unused) */
  .bpp          = 32,               /* Bits per pixel (XRGB 8888) */
  .xres_virtual = PANEL_WIDTH,      /* Virtual Horizontal resolution */
  .yres_virtual = PANEL_HEIGHT,     /* Virtual Vertical resolution */
  .xoffset      = 0,                /* Offset from virtual to visible */
  .yoffset      = 0                 /* Offset from virtual to visible */
};

/* Overlays for 2 Overlay UI Channels */

static struct fb_overlayinfo_s g_pinephone_overlays[2] =
{
  /* First Overlay UI Channel:
   * Square 600 x 600 (4 bytes per ARGB 8888 pixel)
   */

  {
    .fbmem     = &amp;g_pinephone_fb1,
    .fblen     = sizeof(g_pinephone_fb1),
    .stride    = FB1_WIDTH * 4,    /* Length of a line (4-byte pixel) */
    .overlay   = 0,                /* Overlay number (First Overlay) */
    .bpp       = 32,               /* Bits per pixel (ARGB 8888) */
    .blank     = 0,                /* TODO: Blank or unblank */
    .chromakey = 0,                /* TODO: Chroma key argb8888 formatted */
    .color     = 0,                /* TODO: Color argb8888 formatted */
    .transp    =                   /* TODO: Transparency */
    {
      .transp      = 0,
      .transp_mode = 0
    },
    .sarea     =                   /* Selected area within the overlay */
    {
      .x = 52,
      .y = 52,
      .w = FB1_WIDTH,
      .h = FB1_HEIGHT
    },
    .accl      = 0                 /* TODO: Supported hardware acceleration */
  },

  /* Second Overlay UI Channel:
   * Fullscreen 720 x 1440 (4 bytes per ARGB 8888 pixel)
   */

  {
    .fbmem     = &amp;g_pinephone_fb2,
    .fblen     = sizeof(g_pinephone_fb2),
    .stride    = PANEL_WIDTH * 4,  /* Length of a line (4-byte pixel) */
    .overlay   = 1,                /* Overlay number (First Overlay) */
    .bpp       = 32,               /* Bits per pixel (ARGB 8888) */
    .blank     = 0,                /* TODO: Blank or unblank */
    .chromakey = 0,                /* TODO: Chroma key argb8888 formatted */
    .color     = 0,                /* TODO: Color argb8888 formatted */
    .transp    =                   /* TODO: Transparency */
    {
      .transp      = 0,
      .transp_mode = 0
    },
    .sarea     =                   /* Selected area within the overlay */
    {
      .x = 0,
      .y = 0,
      .w = PANEL_WIDTH,
      .h = PANEL_HEIGHT
    },
    .accl      = 0                 /* TODO: Supported hardware acceleration */
  }
};</code></pre></div>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L349-L395">pinephone_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>/****************************************************************************
 * Name: pinephone_getvideoinfo
 *
 * Description:
 *   Get the videoinfo for the framebuffer. (ioctl Entrypoint:
 *   FBIOGET_VIDEOINFO)
 *
 * Input Parameters:
 *   vtable - Framebuffer driver object
 *   vinfo  - Returned videoinfo object
 *
 * Returned Value:
 *   Zero (OK) on success; a negated errno value is returned on any failure.
 *
 ****************************************************************************/

static int pinephone_getvideoinfo(struct fb_vtable_s *vtable,
                                  struct fb_videoinfo_s *vinfo)
{
  static int stage = 0;

  ginfo(&quot;vtable=%p vinfo=%p\n&quot;, vtable, vinfo);
  DEBUGASSERT(vtable != NULL &amp;&amp; vtable == &amp;g_pinephone_vtable &amp;&amp;
              vinfo != NULL);

  /* Copy and return the videoinfo object */

  memcpy(vinfo, &amp;g_pinephone_video, sizeof(struct fb_videoinfo_s));

  /* Keep track of the stages during startup:
   * Stage 0: Initialize driver at startup
   * Stage 1: First call by apps
   * Stage 2: Subsequent calls by apps
   * We erase the framebuffers at stages 0 and 1. This allows the
   * Test Pattern to be displayed for as long as possible before erasure.
   */

  if (stage &lt; 2)
    {
      stage++;
      memset(g_pinephone_fb0, 0, sizeof(g_pinephone_fb0));
      memset(g_pinephone_fb1, 0, sizeof(g_pinephone_fb1));
      memset(g_pinephone_fb2, 0, sizeof(g_pinephone_fb2));
    }

  return OK;
}</code></pre></div>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L397-L429">pinephone_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>/****************************************************************************
 * Name: pinephone_getplaneinfo
 *
 * Description:
 *   Get the planeinfo for the framebuffer. (ioctl Entrypoint:
 *   FBIOGET_PLANEINFO)
 *
 * Input Parameters:
 *   vtable - Framebuffer driver object
 *   pinfo  - Returned planeinfo object
 *
 * Returned Value:
 *   Zero (OK) on success; a negated errno value is returned on any failure.
 *
 ****************************************************************************/

static int pinephone_getplaneinfo(struct fb_vtable_s *vtable, int planeno,
                                  struct fb_planeinfo_s *pinfo)
{
  DEBUGASSERT(vtable != NULL &amp;&amp; vtable == &amp;g_pinephone_vtable);
  ginfo(&quot;vtable=%p planeno=%d pinfo=%p\n&quot;, vtable, planeno, pinfo);

  /* Copy and return the planeinfo object */

  if (planeno == 0)
    {
      memcpy(pinfo, &amp;g_pinephone_plane, sizeof(struct fb_planeinfo_s));
      return OK;
    }

  gerr(&quot;ERROR: Returning EINVAL\n&quot;);
  return -EINVAL;
}</code></pre></div>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L431-L470">pinephone_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>/****************************************************************************
 * Name: pinephone_getoverlayinfo
 *
 * Description:
 *   Get the overlayinfo for the framebuffer. (ioctl Entrypoint:
 *   FBIOGET_OVERLAYINFO)
 *
 * Input Parameters:
 *   vtable    - Framebuffer driver object
 *   overlayno - Overlay number
 *   oinfo     - Returned overlayinfo object
 *
 * Returned Value:
 *   Zero (OK) on success; a negated errno value is returned on any failure.
 *
 ****************************************************************************/

static int pinephone_getoverlayinfo(struct fb_vtable_s *vtable,
                                    int overlayno,
                                    struct fb_overlayinfo_s *oinfo)
{
  const int overlay_len = sizeof(g_pinephone_overlays) /
                          sizeof(g_pinephone_overlays[0]);

  ginfo(&quot;vtable=%p overlay=%d oinfo=%p\n&quot;, vtable, overlayno, oinfo);
  DEBUGASSERT(vtable != NULL &amp;&amp; vtable == &amp;g_pinephone_vtable);

  /* Copy and return the overlayinfo object */

  if (overlayno &gt;= 0 &amp;&amp; overlayno &lt; overlay_len)
    {
      struct fb_overlayinfo_s *overlay = &amp;g_pinephone_overlays[overlayno];

      memcpy(oinfo, overlay, sizeof(struct fb_overlayinfo_s));
      return OK;
    }

  gerr(&quot;ERROR: Returning EINVAL\n&quot;);
  return -EINVAL;
}</code></pre></div>
<p>TODO: pinephone_settransp</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L515-L539">pinephone_display.c</a></p>
<p>TODO: pinephone_setchromakey</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L541-L566">pinephone_display.c</a></p>
<p>TODO: pinephone_setcolor</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L568-L593">pinephone_display.c</a></p>
<p>TODO: pinephone_setblank</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L595-L619">pinephone_display.c</a></p>
<p>TODO: pinephone_setarea</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L621-L647">pinephone_display.c</a></p>
<h1 id="missing-pixels-in-pinephone-image"><a href="#missing-pixels-in-pinephone-image">7 Missing Pixels in PinePhone Image</a></h1>
<p>TODO</p>
<p>We‚Äôve just implemented the NuttX Kernel Drivers for MIPI Display Serial Interface, Timing Controller TCON0, Display Engine, Reduced Serial Bus, Power Management Integrated Circuit and LCD Panel‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi3">‚ÄúNuttX RTOS for PinePhone: MIPI Display Serial Interface‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de3">‚ÄúNuttX RTOS for PinePhone: Display Engine‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/lcd">‚ÄúNuttX RTOS for PinePhone: LCD Panel‚Äù</a></p>
</li>
</ul>
<p>And we‚Äôre adding the Framebuffer Driver to NuttX Kernel‚Ä¶</p>
<p>https://github.com/apache/nuttx/pull/7988</p>
<p>When we run the <code>fb</code> NuttX Example App, we see missing pixels in the rendered image‚Ä¶</p>
<ul>
<li>
<p>Inside the Yellow Box is supposed to be an Orange Box</p>
</li>
<li>
<p>Inside the Orange Box is supposed to be a Red Box</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/fb-test2.jpg" alt="Missing Pixels in PinePhone Image" /></p>
<p>The missing pixels magically appear later in a curious pattern‚Ä¶</p>
<ul>
<li><a href="https://www.youtube.com/shorts/WD5AJj7Rz5U">Watch the Demo on YouTube</a></li>
</ul>
<p>There seems to be a problem with Framebuffer DMA / Display Engine / Timing Controller TCON0?</p>
<p>According to the video, the pixels are actually written to correctly to the RAM Framebuffer. But the pixels at the lower half don‚Äôt get pushed to the display until the next screen refresh.</p>
<p>There seems to be a lag between the writing of pixels to framebuffer, and the pushing of pixels to the display over DMA / Display Engine / Timing Controller TCON0.</p>
<p>Here‚Äôs the fix for this lag‚Ä¶</p>
<h1 id="fix-missing-pixels-in-pinephone-image"><a href="#fix-missing-pixels-in-pinephone-image">8 Fix Missing Pixels in PinePhone Image</a></h1>
<p>TODO</p>
<p>In the previous section we saw that there was a lag pushing pixels from the RAM Framebuffer to the PinePhone Display (over DMA / Display Engine / Timing Controller TCON0).</p>
<p>Can we overcome this lag by copying the RAM Framebuffer to itself, forcing the display to refresh? This sounds very strange, but yes it works! </p>
<p>From <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/pixel/boards/arm64/a64/pinephone/src/pinephone_display.c#L472-L513">pinephone_display.c</a>:</p>
<div class="example-wrap"><pre class="language-c"><code>// Update the display when there is a change to the framebuffer.
// (ioctl Entrypoint: FBIO_UPDATE)
static int pinephone_updatearea(
  struct fb_vtable_s *vtable,   // Framebuffer driver object
  const struct fb_area_s *area  // Updated area of framebuffer
) {
  uint8_t *fb = (uint8_t *)g_pinephone_fb0;
  const size_t fbsize = sizeof(g_pinephone_fb0);

  // Copy the entire framebuffer to itself,
  // to fix the missing pixels.
  // Not sure why this works.
  for (int i = 0; i &lt; fbsize; i++) {

    // Declare as volatile to prevent compiler optimization
    volatile uint8_t v = fb[i];
    fb[i] = v;
  }
  return OK;
}</code></pre></div>
<p>With the code above, the Red, Orange and Yellow Boxes are now rendered correctly in our NuttX Framebuffer Driver for PinePhone. (Pic below)</p>
<p><em>Who calls pinephone_updatearea?</em></p>
<p>After writing the pixels to the RAM Framebuffer, NuttX Apps will call <code>ioctl(FBIO_UPDATE)</code> to update the display.</p>
<p>This triggers <code>pinephone_updatearea</code> in our NuttX Framebuffer Driver: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/pixel/examples/fb/fb_main.c#L265-L274">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Omitted: NuttX App writes pixels to RAM Framebuffer

// Update the Framebuffer
#ifdef CONFIG_FB_UPDATE
  ret = ioctl(    // I/O Command
    state-&gt;fd,    // Framebuffer File Descriptor
    FBIO_UPDATE,  // Update the Framebuffer
    (unsigned long)((uintptr_t)area)  // Updated area
  );
#endif</code></pre></div>
<p><img src="https://lupyuen.github.io/images/fb-test3.jpg" alt="Fixed Missing Pixels in PinePhone Image" /></p>
<p><em>How do other PinePhone operating systems handle this?</em></p>
<p>We might need to handle TCON0 Vertical Blanking (<code>TCON0_Vb_Int_En</code> / <code>TCON0_Vb_Int_Flag</code>) and TCON0 CPU Trigger Mode Finish (<code>TCON0_Tri_Finish_Int_En</code> / <code>TCON0_Tri_Finish_Int_Flag</code>) like this‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun4i_tcon.c#L225-L242">sun4i_tcon_enable_vblank</a></p>
</li>
<li>
<p><a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun4i_tcon.c#L746-L777">sun4i_tcon_handler</a></p>
<p><a href="https://gist.github.com/lupyuen/214788deabdb37659e806a463f8acc50">(More about sun4i_tcon_handler)</a></p>
</li>
</ul>
<p>p-boot Bootloader seems to handle every TCON0 CPU Trigger Mode Finish (<code>TCON0_Tri_Finish_Int_En</code> / <code>TCON0_Tri_Finish_Int_Flag</code>) by updating the Display Engine Registers. Which sounds odd‚Ä¶</p>
<ol>
<li>
<p>Render Loop waits forever for <code>EV_VBLANK</code>: <a href="https://megous.com/git/p-boot/tree/src/dtest.c#n327">dtest.c</a></p>
</li>
<li>
<p><code>EV_VBLANK</code> is triggered by <code>display_frame_done</code>: <a href="https://megous.com/git/p-boot/tree/src/gui.c#n64">gui.c</a></p>
</li>
<li>
<p><code>display_frame_done</code> is triggered by TCON0 CPU Trigger Mode Finish: <a href="https://megous.com/git/p-boot/tree/src/display.c#n2005">display.c</a></p>
</li>
<li>
<p>Render Loop handles <code>EV_VBLANK</code> by redrawing and calling <code>display_commit</code>:  <a href="https://megous.com/git/p-boot/tree/src/dtest.c#n338">dtest.c</a></p>
</li>
<li>
<p><code>display_commit</code> updates the Display Engine Registers, including the Framebuffer Addresses: <a href="https://megous.com/git/p-boot/tree/src/display.c#n2017">display.c</a></p>
</li>
</ol>
<p>Can we handle TCON0 CPU Trigger Mode Finish without refreshing the Display Engine Registers?</p>
<h1 id="lvgl-on-nuttx-on-pinephone"><a href="#lvgl-on-nuttx-on-pinephone">9 LVGL on NuttX on PinePhone</a></h1>
<p>TODO</p>
<p>LVGL on NuttX renders correctly on PinePhone! (Pic below)</p>
<p>Here are the settings in <code>make menuconfig</code>‚Ä¶</p>
<ul>
<li>
<p>Enable ‚ÄúApplication Configuration &gt; Examples &gt; LVGL Demo‚Äù</p>
</li>
<li>
<p>Enable ‚ÄúApplication Configuration &gt; Graphics Support &gt; Light and Versatile Graphic Library (LVGL)‚Äù</p>
</li>
<li>
<p>Under ‚ÄúLVGL &gt; Graphics settings‚Äù‚Ä¶</p>
<ul>
<li>Set ‚ÄúHorizontal resolution‚Äù to 720</li>
<li>Set ‚ÄúVertical resolution‚Äù to 1440</li>
<li>Set ‚ÄúDPI (px/inch)‚Äù to 200</li>
</ul>
</li>
<li>
<p>Under ‚ÄúLVGL &gt; Color settings‚Äù‚Ä¶</p>
<ul>
<li>Set ‚ÄúColor depth (8/16/32)‚Äù to 32</li>
</ul>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/fb-lvgl.jpg" alt="LVGL on NuttX on PinePhone" /></p>
<h1 id="whats-next"><a href="#whats-next">10 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Check out the other articles on <strong>NuttX RTOS for PinePhone</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/arm"><strong>‚ÄúApache NuttX RTOS on Arm Cortex-A53: How it might run on PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/uboot"><strong>‚ÄúPinePhone boots Apache NuttX RTOS‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/interrupt"><strong>‚ÄúNuttX RTOS for PinePhone: Fixing the Interrupts‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/serial"><strong>‚ÄúNuttX RTOS for PinePhone: UART Driver‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pio"><strong>‚ÄúNuttX RTOS for PinePhone: Blinking the LEDs‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi"><strong>‚ÄúUnderstanding PinePhone‚Äôs Display (MIPI DSI)‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi2"><strong>‚ÄúNuttX RTOS for PinePhone: Display Driver in Zig‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de"><strong>‚ÄúRendering PinePhone‚Äôs Display (DE and TCON0)‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de2"><strong>‚ÄúNuttX RTOS for PinePhone: Render Graphics in Zig‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi3"><strong>‚ÄúNuttX RTOS for PinePhone: MIPI Display Serial Interface‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de3"><strong>‚ÄúNuttX RTOS for PinePhone: Display Engine‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/lcd"><strong>‚ÄúNuttX RTOS for PinePhone: LCD Panel‚Äù</strong></a></p>
</li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>My Current Project: ‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>My Other Project: ‚ÄúThe RISC-V BL602 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/fb.md"><strong>lupyuen.github.io/src/fb.md</strong></a></p>

    
</body>
</html>