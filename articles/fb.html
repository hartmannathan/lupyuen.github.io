<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>NuttX RTOS for PinePhone: Framebuffer</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="NuttX RTOS for PinePhone: Framebuffer" 
    data-rh="true">
<meta property="og:description" 
    content="How NuttX Apps call the NuttX Framebuffer Interface to render graphics... And what's inside the Framebuffer Driver for Pine64 PinePhone"
    data-rh="true">
<meta name="description" 
    content="How NuttX Apps call the NuttX Framebuffer Interface to render graphics... And what's inside the Framebuffer Driver for Pine64 PinePhone">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/fb-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">NuttX RTOS for PinePhone: Framebuffer</h1>
    <nav id="TOC"><ul>
<li><a href="#framebuffer-interface">1 Framebuffer Interface</a><ul></ul></li>
<li><a href="#render-grey-screen">2 Render Grey Screen</a><ul></ul></li>
<li><a href="#render-blocks">3 Render Blocks</a><ul></ul></li>
<li><a href="#render-circle">4 Render Circle</a><ul></ul></li>
<li><a href="#render-rectangle">5 Render Rectangle</a><ul></ul></li>
<li><a href="#pinephone-framebuffer-driver">6 PinePhone Framebuffer Driver</a><ul>
<li><a href="#ram-framebuffer">6.1 RAM Framebuffer</a><ul></ul></li>
<li><a href="#framebuffer-operations">6.2 Framebuffer Operations</a><ul></ul></li>
<li><a href="#get-video-info">6.3 Get Video Info</a><ul></ul></li>
<li><a href="#get-plane-info">6.4 Get Plane Info</a><ul></ul></li></ul></li>
<li><a href="#missing-pixels-in-pinephone-image">7 Missing Pixels in PinePhone Image</a><ul></ul></li>
<li><a href="#fix-missing-pixels-in-pinephone-image">8 Fix Missing Pixels in PinePhone Image</a><ul></ul></li>
<li><a href="#lvgl-on-nuttx-on-pinephone">9 LVGL on NuttX on PinePhone</a><ul></ul></li>
<li><a href="#whats-next">10 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>7 Jan 2023</em></p>
<p><img src="https://lupyuen.github.io/images/fb-title.jpg" alt="Apache NuttX Framebuffer App on Pine64 PinePhone" /></p>
<p>Suppose we‚Äôre running <a href="https://nuttx.apache.org/docs/latest/"><strong>Apache NuttX RTOS</strong></a> on <a href="https://wiki.pine64.org/index.php/PinePhone"><strong>Pine64 PinePhone</strong></a>‚Ä¶</p>
<p>How do we create <strong>Graphical Apps</strong> for NuttX? (Pic above)</p>
<p>Today we‚Äôll learn about the‚Ä¶</p>
<ul>
<li>
<p><strong>Framebuffer Interface</strong> that NuttX provides to our apps for rendering graphics</p>
</li>
<li>
<p>What‚Äôs inside the <strong>Framebuffer Driver</strong> for PinePhone</p>
</li>
<li>
<p>Mystery of the <strong>Missing Framebuffer Pixels</strong> and how we solved it</p>
</li>
<li>
<p>Creating NuttX Apps with the <strong>LVGL Graphics Library</strong></p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/fb-run.png" alt="NuttX Framebuffer App running on PinePhone" /></p>
<p><a href="https://gist.github.com/lupyuen/474b0546f213c25947105b6a0daa7c5b"><em>NuttX Framebuffer App running on PinePhone</em></a></p>
<h1 id="framebuffer-interface"><a href="#framebuffer-interface">1 Framebuffer Interface</a></h1>
<p>We begin with the <strong>Framebuffer Interface</strong> that NuttX provides to our apps for rendering graphics.</p>
<p>Our <strong>Demo Code</strong> for today comes (mostly) from this Example App‚Ä¶</p>
<ul>
<li><a href="https://github.com/apache/nuttx-apps/blob/master/examples/fb/fb_main.c"><strong>NuttX Framebuffer Driver Example</strong></a></li>
</ul>
<p><em>How do we build the app?</em></p>
<p>To enable the app in our NuttX Project‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>make menuconfig</code></pre></div>
<p>And select‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Application Configuration &gt; Examples &gt; Framebuffer Driver Example</code></pre></div>
<p>Before building NuttX with <code>make</code>, look for this line: <a href="https://github.com/apache/nuttx-apps/blob/master/examples/fb/fb_main.c#L343-L346">apps/examples/fb/fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>#ifdef CONFIG_FB_OVERLAY</code></pre></div>
<p>And change it to‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>#ifdef NOTUSED</code></pre></div>
<p>Because our PinePhone Framebuffer Driver doesn‚Äôt support overlays yet.</p>
<p><em>What‚Äôs inside the app?</em></p>
<p>To call the <strong>Framebuffer Interface</strong>, our app opens the Framebuffer Driver at <strong>‚Äú/dev/fb0‚Äù</strong>: <a href="https://github.com/apache/nuttx-apps/blob/master/examples/fb/fb_main.c#L314-L337">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>#include &lt;nuttx/video/fb.h&gt;
#include &lt;nuttx/video/rgbcolors.h&gt;

// Open the Framebuffer Driver
int fd = open(&quot;/dev/fb0&quot;, O_RDWR);

// Quit if we failed to open &quot;/dev/fb0&quot;
if (fd &lt; 0) { return; }</code></pre></div>
<p>Next we fetch the <strong>Framebuffer Characteristics</strong>, which will tell us the Screen Size‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>// Get the Characteristics of the Framebuffer
struct fb_videoinfo_s vinfo;
int ret = ioctl(          // Do I/O Control...
  fd,                     // File Descriptor of Framebuffer Driver
  FBIOGET_VIDEOINFO,      // Get Characteristics
  (unsigned long) &amp;vinfo  // Framebuffer Characteristics
);

// Quit if FBIOGET_VIDEOINFO failed
if (ret &lt; 0) { return; }</code></pre></div>
<p>TODO</p>
<p><a href="https://github.com/apache/nuttx-apps/blob/master/examples/fb/fb_main.c#L391-L400">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Get the Plane Info
struct fb_planeinfo_s pinfo;
ret = ioctl(
  fd,
  FBIOGET_PLANEINFO,
  (unsigned long) &amp;pinfo
);

// Quit if FBIOGET_PLANEINFO failed
if (ret &lt; 0) { return; }</code></pre></div>
<p>TODO</p>
<p><a href="https://github.com/apache/nuttx-apps/blob/master/examples/fb/fb_main.c#L420-L440">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Map the Framebuffer Address
void *fbmem = mmap(
  NULL, 
  pinfo.fblen, 
  PROT_READ | PROT_WRITE,
  MAP_SHARED | MAP_FILE,
  fd,
  0
);

// Quit if we failed to map the Framebuffer Address
if (fbmem == MAP_FAILED) { return; }</code></pre></div>
<p><img src="https://lupyuen.github.io/images/fb-demo2.jpg" alt="Render Grey Screen" /></p>
<h1 id="render-grey-screen"><a href="#render-grey-screen">2 Render Grey Screen</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/fb/examples/fb/fb_main.c#L541-L562">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Fill entire framebuffer with grey
memset(
  fbmem,
  0x80,
  pinfo.fblen
);

// Area to be refreshed
struct fb_area_s area = {
  .x = 0,
  .y = 0,
  .w = pinfo.xres_virtual,
  .h = pinfo.yres_virtual
};

// Refresh the display
ioctl(
  fd,
  FBIO_UPDATE,
  (unsigned long) &amp;area
);</code></pre></div>
<p>TODO: #ifdef CONFIG_FB_UPDATE</p>
<p><a href="https://github.com/apache/nuttx-apps/blob/master/examples/fb/fb_main.c#L469-L474">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Unmap the Framebuffer Address
munmap(
  fbmem,
  pinfo.fblen
);

// Close the Framebuffer Driver
close(fd);</code></pre></div>
<p><img src="https://lupyuen.github.io/images/fb-demo3.jpg" alt="Render Blocks" /></p>
<h1 id="render-blocks"><a href="#render-blocks">3 Render Blocks</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/fb/examples/fb/fb_main.c#L564-L601">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Fill framebuffer with Blue, Green and Red Blocks
uint32_t *fb = fbmem;
const size_t fblen = pinfo.fblen / 4;  // 4 bytes per pixel

// For every pixel...
for (int i = 0; i &lt; fblen; i++) {

  // Colors are in XRGB 8888 format
  if (i &lt; fblen / 4) {
    // Blue for top quarter.
    // RGB24_BLUE is 0x0000 00FF
    fb[i] = RGB24_BLUE;
  } else if (i &lt; fblen / 2) {
    // Green for next quarter.
    // RGB24_GREEN is 0x0000 FF00
    fb[i] = RGB24_GREEN;
  } else {
    // Red for lower half.
    // RGB24_RED is 0x00FF 0000
    fb[i] = RGB24_RED;
  }
}

// Omitted: Refresh the display with ioctl(FBIO_UPDATE)</code></pre></div>
<p><img src="https://lupyuen.github.io/images/fb-demo4.jpg" alt="Render Circle" /></p>
<h1 id="render-circle"><a href="#render-circle">4 Render Circle</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/fb/examples/fb/fb_main.c#L603-L651">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Fill framebuffer with Green Circle
uint32_t *fb = fbmem;
const size_t fblen = pinfo.fblen / 4;  // 4 bytes per pixel
const uint32_t width = pinfo.xres_virtual;
const uint32_t height = pinfo.yres_virtual;

// For every pixel row...
for (int y = 0; y &lt; height; y++) {

  // For every pixel column...
  for (int x = 0; x &lt; width; x++) {

    // Get pixel index
    const int p = (y * width) + x;

    // Shift coordinates so that centre of screen is (0,0)
    const int half_width  = width  / 2;
    const int half_height = height / 2;
    const int x_shift = x - half_width;
    const int y_shift = y - half_height;

    // If x^2 + y^2 &lt; radius^2, set the pixel to Green.
    // Colors are in XRGB 8888 format.
    if (x_shift*x_shift + y_shift*y_shift &lt; half_width*half_width) {
      // RGB24_GREEN is 0x0000 FF00
      fb[p] = RGB24_GREEN;
    } else {  // Otherwise set to Transparent Black
      // RGB24_BLACK is 0x0000 0000
      fb[p] = RGB24_BLACK;
    }
  }
}

// Omitted: Refresh the display with ioctl(FBIO_UPDATE)</code></pre></div>
<p><img src="https://lupyuen.github.io/images/fb-demo1.jpg" alt="Render Rectangles" /></p>
<h1 id="render-rectangle"><a href="#render-rectangle">5 Render Rectangle</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/fb/examples/fb/fb_main.c#L472-L480">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>area.x = x;
area.y = y;
area.w = width;
area.h = height;
draw_rect(&amp;state, &amp;area, color);</code></pre></div><h1 id="pinephone-framebuffer-driver"><a href="#pinephone-framebuffer-driver">6 PinePhone Framebuffer Driver</a></h1>
<p>TODO</p>
<h2 id="ram-framebuffer"><a href="#ram-framebuffer">6.1 RAM Framebuffer</a></h2>
<p>TODO</p>
<div class="example-wrap"><pre class="language-c"><code>// Frame Buffer for Display Engine 
// Fullscreen 720 x 1440 (4 bytes per XRGB 8888 pixel)
// PANEL_WIDTH is 720
// PANEL_HEIGHT is 1440
static uint32_t g_pinephone_fb0[PANEL_WIDTH * PANEL_HEIGHT];

static struct fb_videoinfo_s g_pinephone_video =
{
  .fmt       = FB_FMT_RGBA32,  /* Pixel format (XRGB 8888) */
  .xres      = PANEL_WIDTH,    /* Horizontal resolution in pixel columns */
  .yres      = PANEL_HEIGHT,   /* Vertical resolution in pixel rows */
  .nplanes   = 1,              /* Color planes: Base UI Channel */
  .noverlays = 2               /* Overlays: 2 Overlay UI Channels) */
};

/* Color Plane for Base UI Channel:
 * Fullscreen 720 x 1440 (4 bytes per XRGB 8888 pixel)
 */

static struct fb_planeinfo_s g_pinephone_plane =
{
  .fbmem        = &amp;g_pinephone_fb0,
  .fblen        = sizeof(g_pinephone_fb0),
  .stride       = PANEL_WIDTH * 4,  /* Length of a line (4-byte pixel) */
  .display      = 0,                /* Display number (Unused) */
  .bpp          = 32,               /* Bits per pixel (XRGB 8888) */
  .xres_virtual = PANEL_WIDTH,      /* Virtual Horizontal resolution */
  .yres_virtual = PANEL_HEIGHT,     /* Virtual Vertical resolution */
  .xoffset      = 0,                /* Offset from virtual to visible */
  .yoffset      = 0                 /* Offset from virtual to visible */
};</code></pre></div><h2 id="framebuffer-operations"><a href="#framebuffer-operations">6.2 Framebuffer Operations</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L117-L241">pinephone_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>/* Vtable for Frame Buffer Operations */

static struct fb_vtable_s g_pinephone_vtable =
{
  .getvideoinfo    = pinephone_getvideoinfo,
  .getplaneinfo    = pinephone_getplaneinfo,
  .updatearea      = pinephone_updatearea,
  .getoverlayinfo  = pinephone_getoverlayinfo,
  .settransp       = pinephone_settransp,
  .setchromakey    = pinephone_setchromakey,
  .setcolor        = pinephone_setcolor,
  .setblank        = pinephone_setblank,
  .setarea         = pinephone_setarea
};</code></pre></div><h2 id="get-video-info"><a href="#get-video-info">6.3 Get Video Info</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L349-L395">pinephone_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>/****************************************************************************
 * Name: pinephone_getvideoinfo
 *
 * Description:
 *   Get the videoinfo for the framebuffer. (ioctl Entrypoint:
 *   FBIOGET_VIDEOINFO)
 *
 * Input Parameters:
 *   vtable - Framebuffer driver object
 *   vinfo  - Returned videoinfo object
 *
 * Returned Value:
 *   Zero (OK) on success; a negated errno value is returned on any failure.
 *
 ****************************************************************************/

static int pinephone_getvideoinfo(struct fb_vtable_s *vtable,
                                  struct fb_videoinfo_s *vinfo)
{
  static int stage = 0;

  ginfo(&quot;vtable=%p vinfo=%p\n&quot;, vtable, vinfo);
  DEBUGASSERT(vtable != NULL &amp;&amp; vtable == &amp;g_pinephone_vtable &amp;&amp;
              vinfo != NULL);

  /* Copy and return the videoinfo object */

  memcpy(vinfo, &amp;g_pinephone_video, sizeof(struct fb_videoinfo_s));

  /* Keep track of the stages during startup:
   * Stage 0: Initialize driver at startup
   * Stage 1: First call by apps
   * Stage 2: Subsequent calls by apps
   * We erase the framebuffers at stages 0 and 1. This allows the
   * Test Pattern to be displayed for as long as possible before erasure.
   */

  if (stage &lt; 2)
    {
      stage++;
      memset(g_pinephone_fb0, 0, sizeof(g_pinephone_fb0));
      memset(g_pinephone_fb1, 0, sizeof(g_pinephone_fb1));
      memset(g_pinephone_fb2, 0, sizeof(g_pinephone_fb2));
    }

  return OK;
}</code></pre></div><h2 id="get-plane-info"><a href="#get-plane-info">6.4 Get Plane Info</a></h2>
<p>TODO</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/fb2/boards/arm64/a64/pinephone/src/pinephone_display.c#L397-L429">pinephone_display.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>/****************************************************************************
 * Name: pinephone_getplaneinfo
 *
 * Description:
 *   Get the planeinfo for the framebuffer. (ioctl Entrypoint:
 *   FBIOGET_PLANEINFO)
 *
 * Input Parameters:
 *   vtable - Framebuffer driver object
 *   pinfo  - Returned planeinfo object
 *
 * Returned Value:
 *   Zero (OK) on success; a negated errno value is returned on any failure.
 *
 ****************************************************************************/

static int pinephone_getplaneinfo(struct fb_vtable_s *vtable, int planeno,
                                  struct fb_planeinfo_s *pinfo)
{
  DEBUGASSERT(vtable != NULL &amp;&amp; vtable == &amp;g_pinephone_vtable);
  ginfo(&quot;vtable=%p planeno=%d pinfo=%p\n&quot;, vtable, planeno, pinfo);

  /* Copy and return the planeinfo object */

  if (planeno == 0)
    {
      memcpy(pinfo, &amp;g_pinephone_plane, sizeof(struct fb_planeinfo_s));
      return OK;
    }

  gerr(&quot;ERROR: Returning EINVAL\n&quot;);
  return -EINVAL;
}</code></pre></div><h1 id="missing-pixels-in-pinephone-image"><a href="#missing-pixels-in-pinephone-image">7 Missing Pixels in PinePhone Image</a></h1>
<p>TODO</p>
<p>We‚Äôve just implemented the NuttX Kernel Drivers for MIPI Display Serial Interface, Timing Controller TCON0, Display Engine, Reduced Serial Bus, Power Management Integrated Circuit and LCD Panel‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi3">‚ÄúNuttX RTOS for PinePhone: MIPI Display Serial Interface‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de3">‚ÄúNuttX RTOS for PinePhone: Display Engine‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/lcd">‚ÄúNuttX RTOS for PinePhone: LCD Panel‚Äù</a></p>
</li>
</ul>
<p>And we‚Äôre adding the Framebuffer Driver to NuttX Kernel‚Ä¶</p>
<p>https://github.com/apache/nuttx/pull/7988</p>
<p>When we run the <code>fb</code> NuttX Example App, we see missing pixels in the rendered image‚Ä¶</p>
<ul>
<li>
<p>Inside the Yellow Box is supposed to be an Orange Box</p>
</li>
<li>
<p>Inside the Orange Box is supposed to be a Red Box</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/fb-test2.jpg" alt="Missing Pixels in PinePhone Image" /></p>
<p>The missing pixels magically appear later in a curious pattern‚Ä¶</p>
<ul>
<li><a href="https://www.youtube.com/shorts/WD5AJj7Rz5U">Watch the Demo on YouTube</a></li>
</ul>
<p>There seems to be a problem with Framebuffer DMA / Display Engine / Timing Controller TCON0?</p>
<p>According to the video, the pixels are actually written to correctly to the RAM Framebuffer. But the pixels at the lower half don‚Äôt get pushed to the display until the next screen refresh.</p>
<p>There seems to be a lag between the writing of pixels to framebuffer, and the pushing of pixels to the display over DMA / Display Engine / Timing Controller TCON0.</p>
<p>Here‚Äôs the fix for this lag‚Ä¶</p>
<h1 id="fix-missing-pixels-in-pinephone-image"><a href="#fix-missing-pixels-in-pinephone-image">8 Fix Missing Pixels in PinePhone Image</a></h1>
<p>TODO</p>
<p>In the previous section we saw that there was a lag pushing pixels from the RAM Framebuffer to the PinePhone Display (over DMA / Display Engine / Timing Controller TCON0).</p>
<p>Can we overcome this lag by copying the RAM Framebuffer to itself, forcing the display to refresh? This sounds very strange, but yes it works! </p>
<p>From <a href="https://github.com/lupyuen2/wip-pinephone-nuttx/blob/pixel/boards/arm64/a64/pinephone/src/pinephone_display.c#L472-L513">pinephone_display.c</a>:</p>
<div class="example-wrap"><pre class="language-c"><code>// Update the display when there is a change to the framebuffer.
// (ioctl Entrypoint: FBIO_UPDATE)
static int pinephone_updatearea(
  struct fb_vtable_s *vtable,   // Framebuffer driver object
  const struct fb_area_s *area  // Updated area of framebuffer
) {
  uint8_t *fb = (uint8_t *)g_pinephone_fb0;
  const size_t fbsize = sizeof(g_pinephone_fb0);

  // Copy the entire framebuffer to itself,
  // to fix the missing pixels.
  // Not sure why this works.
  for (int i = 0; i &lt; fbsize; i++) {

    // Declare as volatile to prevent compiler optimization
    volatile uint8_t v = fb[i];
    fb[i] = v;
  }
  return OK;
}</code></pre></div>
<p>With the code above, the Red, Orange and Yellow Boxes are now rendered correctly in our NuttX Framebuffer Driver for PinePhone. (Pic below)</p>
<p><em>Who calls pinephone_updatearea?</em></p>
<p>After writing the pixels to the RAM Framebuffer, NuttX Apps will call <code>ioctl(FBIO_UPDATE)</code> to update the display.</p>
<p>This triggers <code>pinephone_updatearea</code> in our NuttX Framebuffer Driver: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/pixel/examples/fb/fb_main.c#L265-L274">fb_main.c</a></p>
<div class="example-wrap"><pre class="language-c"><code>// Omitted: NuttX App writes pixels to RAM Framebuffer

// Update the Framebuffer
#ifdef CONFIG_FB_UPDATE
  ret = ioctl(    // I/O Command
    state-&gt;fd,    // Framebuffer File Descriptor
    FBIO_UPDATE,  // Update the Framebuffer
    (unsigned long)((uintptr_t)area)  // Updated area
  );
#endif</code></pre></div>
<p><img src="https://lupyuen.github.io/images/fb-test3.jpg" alt="Fixed Missing Pixels in PinePhone Image" /></p>
<p><em>How do other PinePhone operating systems handle this?</em></p>
<p>We might need to handle TCON0 Vertical Blanking (<code>TCON0_Vb_Int_En</code> / <code>TCON0_Vb_Int_Flag</code>) and TCON0 CPU Trigger Mode Finish (<code>TCON0_Tri_Finish_Int_En</code> / <code>TCON0_Tri_Finish_Int_Flag</code>) like this‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun4i_tcon.c#L225-L242">sun4i_tcon_enable_vblank</a></p>
</li>
<li>
<p><a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun4i_tcon.c#L746-L777">sun4i_tcon_handler</a></p>
<p><a href="https://gist.github.com/lupyuen/214788deabdb37659e806a463f8acc50">(More about sun4i_tcon_handler)</a></p>
</li>
</ul>
<p>p-boot Bootloader seems to handle every TCON0 CPU Trigger Mode Finish (<code>TCON0_Tri_Finish_Int_En</code> / <code>TCON0_Tri_Finish_Int_Flag</code>) by updating the Display Engine Registers. Which sounds odd‚Ä¶</p>
<ol>
<li>
<p>Render Loop waits forever for <code>EV_VBLANK</code>: <a href="https://megous.com/git/p-boot/tree/src/dtest.c#n327">dtest.c</a></p>
</li>
<li>
<p><code>EV_VBLANK</code> is triggered by <code>display_frame_done</code>: <a href="https://megous.com/git/p-boot/tree/src/gui.c#n64">gui.c</a></p>
</li>
<li>
<p><code>display_frame_done</code> is triggered by TCON0 CPU Trigger Mode Finish: <a href="https://megous.com/git/p-boot/tree/src/display.c#n2005">display.c</a></p>
</li>
<li>
<p>Render Loop handles <code>EV_VBLANK</code> by redrawing and calling <code>display_commit</code>:  <a href="https://megous.com/git/p-boot/tree/src/dtest.c#n338">dtest.c</a></p>
</li>
<li>
<p><code>display_commit</code> updates the Display Engine Registers, including the Framebuffer Addresses: <a href="https://megous.com/git/p-boot/tree/src/display.c#n2017">display.c</a></p>
</li>
</ol>
<p>Can we handle TCON0 CPU Trigger Mode Finish without refreshing the Display Engine Registers?</p>
<h1 id="lvgl-on-nuttx-on-pinephone"><a href="#lvgl-on-nuttx-on-pinephone">9 LVGL on NuttX on PinePhone</a></h1>
<p>TODO</p>
<p>LVGL on NuttX renders correctly on PinePhone! (Pic below)</p>
<p>Here are the settings in <code>make menuconfig</code>‚Ä¶</p>
<ul>
<li>
<p>Enable ‚ÄúApplication Configuration &gt; Examples &gt; LVGL Demo‚Äù</p>
</li>
<li>
<p>Enable ‚ÄúApplication Configuration &gt; Graphics Support &gt; Light and Versatile Graphic Library (LVGL)‚Äù</p>
</li>
<li>
<p>Under ‚ÄúLVGL &gt; Graphics settings‚Äù‚Ä¶</p>
<ul>
<li>Set ‚ÄúHorizontal resolution‚Äù to 720</li>
<li>Set ‚ÄúVertical resolution‚Äù to 1440</li>
<li>Set ‚ÄúDPI (px/inch)‚Äù to 200</li>
</ul>
</li>
<li>
<p>Under ‚ÄúLVGL &gt; Color settings‚Äù‚Ä¶</p>
<ul>
<li>Set ‚ÄúColor depth (8/16/32)‚Äù to 32</li>
</ul>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/fb-lvgl.jpg" alt="LVGL on NuttX on PinePhone" /></p>
<h1 id="whats-next"><a href="#whats-next">10 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Check out the other articles on <strong>NuttX RTOS for PinePhone</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/arm"><strong>‚ÄúApache NuttX RTOS on Arm Cortex-A53: How it might run on PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/uboot"><strong>‚ÄúPinePhone boots Apache NuttX RTOS‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/interrupt"><strong>‚ÄúNuttX RTOS for PinePhone: Fixing the Interrupts‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/serial"><strong>‚ÄúNuttX RTOS for PinePhone: UART Driver‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pio"><strong>‚ÄúNuttX RTOS for PinePhone: Blinking the LEDs‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi"><strong>‚ÄúUnderstanding PinePhone‚Äôs Display (MIPI DSI)‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi2"><strong>‚ÄúNuttX RTOS for PinePhone: Display Driver in Zig‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de"><strong>‚ÄúRendering PinePhone‚Äôs Display (DE and TCON0)‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de2"><strong>‚ÄúNuttX RTOS for PinePhone: Render Graphics in Zig‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi3"><strong>‚ÄúNuttX RTOS for PinePhone: MIPI Display Serial Interface‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de3"><strong>‚ÄúNuttX RTOS for PinePhone: Display Engine‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/lcd"><strong>‚ÄúNuttX RTOS for PinePhone: LCD Panel‚Äù</strong></a></p>
</li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>My Current Project: ‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>My Other Project: ‚ÄúThe RISC-V BL602 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/fb.md"><strong>lupyuen.github.io/src/fb.md</strong></a></p>

    
</body>
</html>