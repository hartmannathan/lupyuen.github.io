<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Understanding PinePhone&#39;s Display (MIPI DSI)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Understanding PinePhone's Display (MIPI DSI)" 
    data-rh="true">
<meta property="og:description" 
    content="How does Pine64 PinePhone control its LCD Display over MIPI Display Serial Interface? Let's find out!"
    data-rh="true">
<meta name="description" 
    content="How does Pine64 PinePhone control its LCD Display over MIPI Display Serial Interface? Let's find out!">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/dsi-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Understanding PinePhone&#39;s Display (MIPI DSI)</h1>
    <nav id="TOC"><ul>
<li><a href="#from-pinetime-to-pinephone">1 From PineTime To PinePhone</a><ul></ul></li>
<li><a href="#pinephone-schematic">2 PinePhone Schematic</a><ul></ul></li>
<li><a href="#connector-for-mipi-dsi">3 Connector for MIPI DSI</a><ul></ul></li>
<li><a href="#xingbangda-xbd599-lcd-panel">4 Xingbangda XBD599 LCD Panel</a><ul></ul></li>
<li><a href="#sitronix-st7703-lcd-controller">5 Sitronix ST7703 LCD Controller</a><ul></ul></li>
<li><a href="#initialise-lcd-controller">6 Initialise LCD Controller</a><ul></ul></li>
<li><a href="#display-command-set-for-mipi-dsi">7 Display Command Set for MIPI DSI</a><ul></ul></li>
<li><a href="#video-mode-only-for-mipi-dsi">8 Video Mode Only for MIPI DSI</a><ul></ul></li>
<li><a href="#a64-registers-for-mipi-dsi">9 A64 Registers for MIPI DSI</a><ul></ul></li>
<li><a href="#initialise-mipi-dsi">10 Initialise MIPI DSI</a><ul></ul></li>
<li><a href="#long-packet-for-mipi-dsi">11 Long Packet for MIPI DSI</a><ul></ul></li>
<li><a href="#transmit-packet-over-mipi-dsi">12 Transmit Packet over MIPI DSI</a><ul></ul></li>
<li><a href="#render-display">13 Render Display</a><ul></ul></li>
<li><a href="#nuttx-display-driver-for-pinephone">14 NuttX Display Driver for PinePhone</a><ul></ul></li>
<li><a href="#whats-next">15 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">16 Notes</a><ul></ul></li>
<li><a href="#appendix-sequence-of-steps-for-pinephone-display-driver">17 Appendix: Sequence of Steps for PinePhone Display Driver</a><ul></ul></li>
<li><a href="#appendix-enable-mipi-dsi-block">18 Appendix: Enable MIPI DSI Block</a><ul></ul></li>
<li><a href="#appendix-start-mipi-dsi-hsc-and-hsd">19 Appendix: Start MIPI DSI HSC and HSD</a><ul></ul></li>
<li><a href="#appendix-enable-mipi-display-physical-layer-dphy">20 Appendix: Enable MIPI Display Physical Layer (DPHY)</a><ul></ul></li>
<li><a href="#appendix-short-packet-for-mipi-dsi">21 Appendix: Short Packet for MIPI DSI</a><ul></ul></li>
<li><a href="#appendix-initialise-lcd-controller">22 Appendix: Initialise LCD Controller</a><ul></ul></li></ul></nav><p>üìù <em>2 Oct 2022</em></p>
<p><img src="https://lupyuen.github.io/images/dsi-title.jpg" alt="PinePhone‚Äôs LCD Display in the PinePhone Block Diagram" /></p>
<p><strong>UPDATE:</strong> Apache NuttX RTOS now supports MIPI DSI! <a href="https://lupyuen.github.io/articles/dsi3">(See this)</a></p>
<p>How does <a href="https://wiki.pine64.org/index.php/PinePhone"><strong>Pine64 PinePhone</strong></a> control its <strong>LCD Display</strong>?</p>
<p>Let‚Äôs uncover all the secrets about PinePhone‚Äôs mysterious LCD Display and its <strong>MIPI Display Serial Interface</strong>‚Ä¶</p>
<ul>
<li>
<p>What‚Äôs a MIPI Display Serial Interface (DSI)</p>
</li>
<li>
<p>What‚Äôs inside PinePhone‚Äôs LCD Display</p>
</li>
<li>
<p>How it‚Äôs similar to PineTime‚Äôs ST7789 Display Controller</p>
</li>
<li>
<p>One lane for Commands, but 4 lanes for Data!</p>
</li>
<li>
<p>Implications of a RAM-less Display Controller</p>
</li>
<li>
<p>What are PinePhone‚Äôs Display Engine (DE) and Timing Controller (TCON)</p>
</li>
</ul>
<p><em>Why are we doing this?</em></p>
<p>We‚Äôre now porting <a href="https://lupyuen.github.io/articles/uboot"><strong>Apache NuttX RTOS</strong></a> to PinePhone.</p>
<p>But it will look awfully dull until we <strong>render something</strong> on PinePhone‚Äôs LCD Display!</p>
<p>That‚Äôs why we‚Äôre probing the internals of PinePhone to create a <strong>NuttX Display Driver</strong>.</p>
<p>We‚Äôll come back to this. Let‚Äôs continue the journey from our <strong>NuttX Porting Journal</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>lupyuen/pinephone-nuttx</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/dsi-pinetime.jpg" alt="PineTime Smartwatch" /></p>
<p><em>PineTime Smartwatch with ST7789 Display Controller</em></p>
<h1 id="from-pinetime-to-pinephone"><a class="doc-anchor" href="#from-pinetime-to-pinephone">¬ß</a>1 From PineTime To PinePhone</h1>
<p><em>Why PineTime Smartwatch? Is it really similar to PinePhone‚Äôs Display?</em></p>
<p>Sounds unbelievable, but PineTime‚Äôs <strong>ST7789 Display Controller</strong> has plenty in common with PinePhone‚Äôs Display!</p>
<p>(Think of PinePhone as a Super-Sized PineTime)</p>
<p>In this article we shall explain PinePhone‚Äôs Display by <strong>comparing it with PineTime</strong>.</p>
<p>A quick recap of <strong>PineTime‚Äôs ST7789 Display</strong>‚Ä¶</p>
<ul>
<li>
<p>PineTime talks to its display over SPI (single data lane)‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/st7789#connect-st7789-display"><strong>‚ÄúConnect ST7789 Display‚Äù</strong></a></p>
<p>(We‚Äôll soon see that PinePhone talks to its display over 4 data lanes)</p>
</li>
<li>
<p>PineTime uses an extra pin to indicate whether it‚Äôs sending Commands or Pixel Data</p>
<p><a href="https://lupyuen.github.io/articles/st7789#st7789-data--command-pin"><strong>‚ÄúST7789 Data / Command Pin‚Äù</strong></a></p>
<p>(PinePhone won‚Äôt need this, we‚Äôll learn why)</p>
</li>
<li>
<p>At startup, PineTime sends an Initialisation Sequence of Commands to initialise the display‚Ä¶</p>
<p><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/mcuboot#initialise-the-display"><strong>‚ÄúInitialise The Display‚Äù</strong></a></p>
<p>(PinePhone will send a similar Initialisation Sequence, but much longer)</p>
</li>
<li>
<p>PineTime renders a rectangular chunk of the display at a time‚Ä¶</p>
<p><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/mcuboot#draw-a-line"><strong>‚ÄúDraw A Line‚Äù</strong></a></p>
<p>(PinePhone will refresh its entire display continously)</p>
</li>
</ul>
<p>If we‚Äôre not familiar with PineTime‚Äôs ST7789 Display, please read the docs above!</p>
<p><em>We‚Äôve read the docs, can we move on?</em></p>
<p>OK great! To understand how PinePhone‚Äôs Display differs from PineTime, we begin with the schematic‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-title.jpg" alt="LCD Display on PinePhone Schematic (Page 2)" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>LCD Display on PinePhone Schematic (Page 2)</em></a></p>
<h1 id="pinephone-schematic"><a class="doc-anchor" href="#pinephone-schematic">¬ß</a>2 PinePhone Schematic</h1>
<p>Let‚Äôs turn to Page 2 of the <strong>PinePhone Schematic</strong> to understand how PinePhone‚Äôs Display is connected‚Ä¶</p>
<ul>
<li><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><strong>PinePhone Schematic</strong></a></li>
</ul>
<p>From the pic above, we see that the LCD Display is connected to the <a href="https://linux-sunxi.org/A64"><strong>Allwinner A64 SoC</strong></a> via a <strong>MIPI Display Serial Interface (DSI)</strong>.</p>
<p><a href="https://en.wikipedia.org/wiki/MIPI_Alliance">(MIPI is the <strong>Mobile Industry Processor Interface Alliance</strong>)</a></p>
<p><em>What‚Äôs a MIPI Display Serial Interface?</em></p>
<p>Think of it as SPI, but supercharged with <strong>Multiple Data Lanes</strong>!</p>
<p>The (dull) technical details of DSI are covered here‚Ä¶</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Display_Serial_Interface"><strong>‚ÄúDisplay Serial Interface (DSI)‚Äù</strong></a></li>
</ul>
<p>But if we‚Äôre seeking a gentler intro to DSI, please follow me to the next section‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-connector.png" alt="MIPI DSI Connector on PinePhone Schematic (Page 11)" /></p>
<p><a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><em>MIPI DSI Connector on PinePhone Schematic (Page 11)</em></a></p>
<h1 id="connector-for-mipi-dsi"><a class="doc-anchor" href="#connector-for-mipi-dsi">¬ß</a>3 Connector for MIPI DSI</h1>
<p><em>How shall we learn about MIPI DSI?</em></p>
<p>We‚Äôll learn plenty about MIPI DSI (Display Serial Interface)‚Ä¶ Just by looking at <strong>PinePhone‚Äôs Connector for the LCD Display</strong>!</p>
<p>Flip to Page 11 of the <a href="https://files.pine64.org/doc/PinePhone/PinePhone%20v1.2b%20Released%20Schematic.pdf"><strong>PinePhone Schematic</strong></a> and we‚Äôll see the <strong>MIPI DSI Connector</strong>. (Pic above)</p>
<p>The MIPI DSI Connector connects PinePhone‚Äôs <strong>Allwinner A64 SoC</strong> directly to the LCD Display. In the pic above we see these connections‚Ä¶</p>
<ul>
<li>
<p><strong>CKN and CKP</strong> are the DSI Clock Lines</p>
<p>(Similar to SPI Clock)</p>
</li>
<li>
<p><strong>D0N and D0P</strong> for DSI Data Lane 0</p>
<p>(Similar to SPI MISO / MOSI)</p>
</li>
<li>
<p><strong>D1N and D1P</strong> for DSI Data Lane 1</p>
<p>(Yep DSI has more data lanes than SPI)</p>
</li>
<li>
<p><strong>D2N and D2P</strong> for DSI Data Lane 2</p>
</li>
<li>
<p><strong>D3N and D3P</strong> for DSI Data Lane 3</p>
<p>(MIPI DSI has 4 data lanes!)</p>
</li>
</ul>
<p><em>Why the N and P?</em></p>
<p>Because P=NP‚Ä¶ Kidding!</p>
<p><strong>N</strong> means Negative, <strong>P</strong> means Positive.</p>
<p>This means that MIPI DSI uses <a href="https://en.wikipedia.org/wiki/Differential_signalling"><strong>Differential Signalling</strong></a> for high-speed data transfers. (4.5 Gbps per lane)</p>
<p>(Differential Signalling is also used in <a href="https://en.wikipedia.org/wiki/HDMI"><strong>HDMI</strong></a> and <a href="https://en.wikipedia.org/wiki/USB#Signaling"><strong>USB</strong></a>)</p>
<p><em>Are all 4 DSI Data Lanes identical?</em></p>
<p>For sending commands to the Display Controller, only <strong>DSI Lane 0</strong> is used.</p>
<p>(Lane 0 is Bidirectional, it supports Direction Turnaround)</p>
<p>For sending pixel data, <strong>all 4 DSI Lanes</strong> will be used. (Unidirectional)</p>
<p>Let‚Äôs dig deeper into MIPI DSI‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-lcd.png" alt="Xingbangda XBD599 in PinePhone‚Äôs Linux Device Tree" /></p>
<p><a href="https://lupyuen.github.io/articles/pio#mipi-dsi-interface"><em>Xingbangda XBD599 in PinePhone‚Äôs Linux Device Tree</em></a></p>
<h1 id="xingbangda-xbd599-lcd-panel"><a class="doc-anchor" href="#xingbangda-xbd599-lcd-panel">¬ß</a>4 Xingbangda XBD599 LCD Panel</h1>
<p><em>What‚Äôs connected to this MIPI DSI Connector?</em></p>
<p>The <a href="https://lupyuen.github.io/articles/pio#appendix-pinephone-device-tree"><strong>Linux Device Tree</strong></a> describes everything about PinePhone Hardware in a single text file. Let‚Äôs snoop around the Device Tree!</p>
<p>First we follow these steps to dump PinePhone‚Äôs Linux Device Tree in text format‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/pio#appendix-pinephone-device-tree"><strong>‚ÄúPinePhone Device Tree‚Äù</strong></a></li>
</ul>
<p>Then we search for <strong>MIPI DSI</strong> in the Device Tree‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/sun50i-a64-pinephone-1.2.dts#L1327-L1356"><strong>sun50i-a64-pinephone-1.2.dts</strong></a></li>
</ul>
<p>From the pic above we see that PinePhone‚Äôs MIPI DSI Connector is connected to <a href="https://patchwork.kernel.org/project/dri-devel/patch/20200311163329.221840-4-icenowy@aosc.io/"><strong>Xingbangda XBD599</strong></a>.</p>
<p>This is a 5.99-inch 720x1440 MIPI DSI IPS LCD Panel.</p>
<p>But what‚Äôs super interesting is that Xingbangda XBD599 has a <strong>Sitronix ST7703 LCD Controller</strong> inside!</p>
<ul>
<li><a href="https://files.pine64.org/doc/datasheet/pinephone/ST7703_DS_v01_20160128.pdf"><strong>Sitronix ST7703 LCD Controller Datasheet</strong></a></li>
</ul>
<p>Let‚Äôs probe deeper‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-sitronix2.png" alt="PineTime (ST7789) vs PinePhone (ST7703)" /></p>
<p><a href="https://www.sitronix.com.tw/en/products/aiot-device-ddi/"><em>PineTime (ST7789) vs PinePhone (ST7703)</em></a></p>
<h1 id="sitronix-st7703-lcd-controller"><a class="doc-anchor" href="#sitronix-st7703-lcd-controller">¬ß</a>5 Sitronix ST7703 LCD Controller</h1>
<p><em>Sitronix ST7703 sounds familiar?</em></p>
<p>Yep Sitronix makes the LCD Controllers for BOTH PineTime and PinePhone!</p>
<p>In fact they‚Äôre from the <a href="https://www.sitronix.com.tw/en/products/aiot-device-ddi/"><strong>same family</strong></a> of LCD Controllers. (ST7789 vs ST7703)</p>
<p>Just that PineTime uses an SPI Interface while PinePhone uses a <strong>MIPI DSI Interface</strong>. (Pic above)</p>
<p>The resolutions are different too. PinePhone has a <strong>huge display</strong> with more colours‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-sitronix1.png" alt="PineTime (ST7789) vs PinePhone (ST7703)" /></p>
<p><a href="https://www.sitronix.com.tw/en/products/aiot-device-ddi/">(Source)</a></p>
<p>Which means that PinePhone‚Äôs LCD Controller is <strong>RAM-less</strong>‚Ä¶</p>
<p>It <strong>doesn‚Äôt have any RAM</strong> inside to remember the pixels. (Unlike PineTime)</p>
<p><em>What‚Äôs the implication of a RAM-less display?</em></p>
<p>Because PinePhone‚Äôs LCD Controller doesn‚Äôt have any RAM inside to remember the pixels drawn‚Ä¶</p>
<p>PinePhone‚Äôs A64 SoC will <strong>pump a constant stream of pixels</strong> to refresh the display.</p>
<p>(Just like an old CRT TV!)</p>
<p>This pixel pumping is done by A64‚Äôs <a href="https://lupyuen.github.io/articles/pio#display-engine"><strong>Display Engine (DE)</strong></a> and <a href="https://lupyuen.github.io/articles/pio#lcd-controller-tcon0"><strong>Timing Controller (TCON0)</strong></a>. We‚Äôll come back to this.</p>
<h1 id="initialise-lcd-controller"><a class="doc-anchor" href="#initialise-lcd-controller">¬ß</a>6 Initialise LCD Controller</h1>
<p><em>What happens inside PinePhone‚Äôs ST7703 LCD Controller?</em></p>
<p>Let‚Äôs figure out by looking at the initialisation of PinePhone‚Äôs ST7703 LCD Controller.</p>
<p>Xingbangda has provided an <a href="https://lupyuen.github.io/articles/dsi#appendix-initialise-lcd-controller"><strong>Initialisation Sequence</strong></a> of (magical) ST7703 Commands that we should send to the LCD Controller at startup‚Ä¶</p>
<div><table><thead><tr><th style="text-align: center">Byte</th><th style="text-align: left">Purpose</th></tr></thead><tbody>
<tr><td style="text-align: center"><code>B9</code></td><td style="text-align: left"><strong>SETEXTC:</strong> Enable USER Command (Page 131)</td></tr>
<tr><td style="text-align: center"><code>F1</code></td><td style="text-align: left">- Enable USER Command</td></tr>
<tr><td style="text-align: center"><code>12</code></td><td style="text-align: left">- (Continued)</td></tr>
<tr><td style="text-align: center"><code>83</code></td><td style="text-align: left">- (Continued)</td></tr>
<tr><td style="text-align: center"><code>BA</code></td><td style="text-align: left"><strong>SETMIPI:</strong> Set MIPI Registers (Page 144)</td></tr>
<tr><td style="text-align: center"><code>33</code></td><td style="text-align: left">- Virtual Channel (0), Number of Lanes (4)</td></tr>
<tr><td style="text-align: center"><code>81</code></td><td style="text-align: left">- LDO Voltage, Terminal Resistance</td></tr>
<tr><td style="text-align: center"><code>05</code></td><td style="text-align: left">- MIPI Low High Speed driving ability</td></tr>
<tr><td style="text-align: center"><code>F9</code></td><td style="text-align: left">- TXCLK speed in DSI LP mode</td></tr>
<tr><td style="text-align: center"><code>0E</code></td><td style="text-align: left">- Minimum HFP number</td></tr>
<tr><td style="text-align: center"><code>0E</code></td><td style="text-align: left">- Minimum HBP number</td></tr>
<tr><td style="text-align: center">‚Ä¶</td><td style="text-align: left"><a href="https://lupyuen.github.io/articles/dsi#appendix-initialise-lcd-controller">(And many more commands, see this list)</a></td></tr>
</tbody></table>
</div>
<p>The above commands are (mostly) documented in the ST7703 Datasheet‚Ä¶</p>
<ul>
<li><a href="https://files.pine64.org/doc/datasheet/pinephone/ST7703_DS_v01_20160128.pdf"><strong>Sitronix ST7703 LCD Controller Datasheet</strong></a></li>
</ul>
<p><em>How to send the Init Sequence to ST7703?</em></p>
<p>We‚Äôll send the above commands to ST7703 via a MIPI DSI Display Command: <strong>DCS Long Write</strong>.</p>
<p>Which we‚Äôll explain next‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-datatype.png" alt="MIPI DSI Display Command Set from A31 User Manual (Page 837)" /></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf"><em>MIPI DSI Display Command Set from A31 User Manual (Page 837)</em></a></p>
<h1 id="display-command-set-for-mipi-dsi"><a class="doc-anchor" href="#display-command-set-for-mipi-dsi">¬ß</a>7 Display Command Set for MIPI DSI</h1>
<p>MIPI Display Serial Interface (DSI) defines a standard list of commands for controlling the display: <strong>DSI Display Command Set (DCS)</strong>. (Pic above)</p>
<p>To send the Initialisation Sequence to ST7703, we shall transmit the <strong>DCS Long Write</strong> command. (Data Type <code>0x39</code>)</p>
<p>Which is described in the <a href="https://files.pine64.org/doc/datasheet/pinephone/ST7703_DS_v01_20160128.pdf"><strong>ST7703 Datasheet</strong></a> (page 19)‚Ä¶</p>
<blockquote>
<p><strong>Display Command Set (DCS) Long Write</strong> is always using a Long Packet from the HOST to the driver IC.</p>
</blockquote>
<blockquote>
<p>The content can include Command (No Parameters) or Command with 1 or more parameters.</p>
</blockquote>
<p>(More about ‚ÄúLong Packet‚Äù in a while)</p>
<p>And we shall transmit the DCS Long Write command in <strong>DSI Video Mode</strong>.</p>
<p>Let‚Äôs talk about DSI Video Mode‚Ä¶</p>
<p>(Note: We might need to use <strong>DCS Short Write No Parameters</strong> <code>0x05</code> for single-byte ST7703 Commands, <strong>DCS Short Write 1 Parameter</strong> <code>0x15</code> for 2-byte ST7703 Commands. See the Appendix for details)</p>
<p><img src="https://lupyuen.github.io/images/dsi-modes2.png" alt="DSI Video Mode from A31 User Manual (Page 841)" /></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf"><em>DSI Video Mode from A31 User Manual (Page 841)</em></a></p>
<h1 id="video-mode-only-for-mipi-dsi"><a class="doc-anchor" href="#video-mode-only-for-mipi-dsi">¬ß</a>8 Video Mode Only for MIPI DSI</h1>
<p><em>What‚Äôs MIPI DSI Video Mode?</em></p>
<p>MIPI Display Serial Interface (DSI) supports 2 modes of operation (pic above)‚Ä¶</p>
<ul>
<li>
<p><strong>DSI Command Mode</strong>: For sending DCS Commands to the display</p>
<p>(DCS is the <a href="https://lupyuen.github.io/articles/dsi#display-command-set-for-mipi-dsi"><strong>Display Command Set</strong></a>)</p>
</li>
<li>
<p><strong>DSI Video Mode</strong>: For blasting pixels to the display</p>
</li>
</ul>
<p>But the <a href="https://files.pine64.org/doc/datasheet/pinephone/ST7703_DS_v01_20160128.pdf"><strong>ST7703 Datasheet</strong></a> (page 19) says that DSI Command Mode is NOT supported‚Ä¶</p>
<blockquote>
<p>ST7703 only support <strong>Video mode</strong>. Video Mode refers to operation in which transfers from the host processor to the peripheral take the form of a real-time pixel stream.</p>
</blockquote>
<p>And while we‚Äôre in DSI Video Mode, PinePhone needs to <strong>pump pixels continuously</strong> to ST7703 (or the display goes blank)‚Ä¶</p>
<blockquote>
<p>In normal operation, the driver IC relies on the host processor to provide image data at sufficient bandwidth to avoid flicker or other visible artifacts in the displayed image. Video information should only be transmitted using High Speed Mode.</p>
</blockquote>
<p><em>So we‚Äôll transmit our DCS Commands in DSI Video Mode? Even though it‚Äôs meant for blasting pixels?</em></p>
<p>Yeah earlier we talked about sending the <strong>DCS Long Write</strong> command for initialising PinePhone‚Äôs ST7703 LCD Controller‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#initialise-lcd-controller"><strong>‚ÄúInitialise LCD Controller‚Äù</strong></a></li>
</ul>
<p>We‚Äôll have to transmit the command in <strong>DSI Video Mode</strong>. (Instead of DSI Command Mode)</p>
<p>It sounds odd, but that‚Äôs how ST7703 works!</p>
<p><em>Wait we‚Äôre mixing DCS Commands and Pixel Data in the same mode? Won‚Äôt ST7703 LCD Controller get confused?</em></p>
<p>If we flip back to the Display Command Set‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi#display-command-set-for-mipi-dsi"><strong>‚ÄúDisplay Command Set for MIPI DSI‚Äù</strong></a></p>
<p>(Also in the <a href="https://files.pine64.org/doc/datasheet/pinephone/ST7703_DS_v01_20160128.pdf"><strong>ST7703 Datasheet</strong></a>, page 34)</p>
</li>
</ul>
<p>We see that the <strong>DCS Long Write</strong> command has a different <strong>Data Type</strong> (<code>0x39</code>) from the other Pixel Stream commands.</p>
<p>(Like ‚ÄúPacked Pixel Stream, 24-bit RGB, 8-8-8 Format‚Äù, Data Type <code>0x3E</code>)</p>
<p>That‚Äôs why PinePhone‚Äôs Display doesn‚Äôt need a Data / Command Pin like PineTime.</p>
<p><img src="https://lupyuen.github.io/images/dsi-registers2.png" alt="MIPI DSI Registers from A31 User Manual (Page 842)" /></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf"><em>MIPI DSI Registers from A31 User Manual (Page 842)</em></a></p>
<h1 id="a64-registers-for-mipi-dsi"><a class="doc-anchor" href="#a64-registers-for-mipi-dsi">¬ß</a>9 A64 Registers for MIPI DSI</h1>
<p><em>How shall we send a DCS Long Write command to PinePhone‚Äôs Display?</em></p>
<p>To send a DCS Long Write command, we‚Äôll set some Hardware Registers in A64‚Äôs <strong>MIPI DSI Controller</strong>.</p>
<p><em>The MIPI DSI Registers are missing from the A64 docs!</em></p>
<p>Yep it‚Äôs totally odd, but the A64 MIPI DSI Registers are actually documented in the <a href="https://linux-sunxi.org/A31"><strong>Allwinner A31 SoC</strong></a>, which is a 32-bit SoC!</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf"><strong>Allwinner A31 User Manual (Page 842)</strong></a></li>
</ul>
<p>(A64 is actually an Allwinner H3 upgraded with <a href="https://linux-sunxi.org/A64"><strong>64-bit Arm Cores</strong></a>)</p>
<p>A64‚Äôs MIPI DSI Hardware is identical to A31 because both SoCs use the <strong>same MIPI DSI Driver</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>static const struct of_device_id sun6i_dsi_of_table[] = {
  { .compatible = &quot;allwinner,sun6i-a31-mipi-dsi&quot; },
  { .compatible = &quot;allwinner,sun50i-a64-mipi-dsi&quot; },
</code></pre></div>
<p><a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/sun4i/sun6i_mipi_dsi.c#L1215-L1219">(Source)</a></p>
<p>The <strong>Base Address</strong> of A64‚Äôs MIPI DSI Controller is <strong><code>0x01CA</code> <code>0000</code></strong>. (Pic above)</p>
<p>Also in the pic above is list of <strong>MIPI DSI Registers</strong> for A64 SoC.</p>
<p>For today we shall study 2 of the above registers‚Ä¶</p>
<ul>
<li>
<p><strong>DSI_BASIC_CTL1_REG</strong> (Offset <code>0x14</code>)</p>
<p>DSI Configuration Register 1</p>
</li>
<li>
<p><strong>DSI_CMD_TX_REG</strong> (Offset <code>0x300</code> to <code>0x3FC</code>):</p>
<p>DSI Low Power Transmit Package Register</p>
</li>
</ul>
<p>Though eventually we shall use these too‚Ä¶</p>
<ul>
<li>
<p><strong>DSI_CTL_REG</strong> (Offset <code>0x00</code>)</p>
<p>DSI Control Register</p>
</li>
<li>
<p><strong>DSI_BASIC_CTL0_REG</strong> (Offset <code>0x10</code>)</p>
<p>DSI Configuration Register 0</p>
</li>
<li>
<p><strong>DSI_CMD_CTL_REG</strong> (Offset <code>0x200</code>)</p>
<p>DSI Low Power Control Register</p>
</li>
<li>
<p><strong>DSI_CMD_RX_REG</strong> (Offset <code>0x240</code> to <code>0x25C</code>)</p>
<p>DSI Low Power Receive Package Register</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/dsi-control.png" alt="MIPI DSI Configuration Register 1 from A31 User Manual (Page 846)" /></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf"><em>MIPI DSI Configuration Register 1 from A31 User Manual (Page 846)</em></a></p>
<h1 id="initialise-mipi-dsi"><a class="doc-anchor" href="#initialise-mipi-dsi">¬ß</a>10 Initialise MIPI DSI</h1>
<p>We said earlier that PinePhone‚Äôs ST7789 LCD Controller needs to run in <strong>DSI Video Mode</strong> (instead of DSI Command Mode)‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#video-mode-only-for-mipi-dsi"><strong>‚ÄúVideo Mode Only for MIPI DSI‚Äù</strong></a></li>
</ul>
<p>At startup, our PinePhone Display Driver shall set <strong>DSI_Mode</strong> to 1. (Pic above)</p>
<p>That‚Äôs <strong>Bit 0</strong> of <strong>DSI_BASIC_CTL1_REG</strong> (DSI Configuration Register 1) at Offset <code>0x14</code>.</p>
<p>Our driver shall also set <strong>Video_Precision_Mode_Align</strong> to 1, <strong>Video_Frame_Start</strong> to 1 and <strong>Video_Start_Delay</strong>. (What‚Äôs the delay value?)</p>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-enable-mipi-dsi-block">(Here‚Äôs how we set <strong>DSI_BASIC_CTL1_REG</strong>)</a></p>
<p><em>Anything else we should init at startup?</em></p>
<p>Actually we should turn on the MIPI DSI Controller BEFORE setting the Video Mode. At startup our driver shall set these registers‚Ä¶</p>
<ul>
<li>
<p><strong>DSI_CTL_REG</strong> (Offset <code>0x00</code>):</p>
<p>Enable MIPI DSI (Bit 0)</p>
</li>
<li>
<p><strong>DSI_BASIC_CTL0_REG</strong> (Offset <code>0x10</code>):</p>
<p>Enable Error Correction Code (Bit 16)</p>
<p>Enable Cyclic Redundancy Check (Bit 17)</p>
</li>
<li>
<p><strong>DSI_TRANS_START_REG</strong> (Offset <code>0x60</code>, undocumented):</p>
<p>Set to 10 (Why?)</p>
</li>
<li>
<p><strong>DSI_TRANS_ZERO_REG</strong> (Offset <code>0x78</code>, undocumented):</p>
<p>Set to 0 (Why?)</p>
</li>
<li>
<p><strong>DSI_DEBUG_DATA_REG</strong> (Offset <code>0x2f8</code>, undocumented):</p>
<p>Set to <code>0xFF</code> (Why?)</p>
</li>
</ul>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-enable-mipi-dsi-block">(Here‚Äôs how we set the registers)</a></p>
<p><em>Is that all?</em></p>
<p>There‚Äôs something else that needs to be initialised: <strong>MIPI DPHY</strong>, the Display Physical Layer for MIPI DSI.</p>
<p>Sadly A64‚Äôs MIPI DPHY doesn‚Äôt seem to be documented, so we might need to do Reverse Engineering. See this‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-enable-mipi-display-physical-layer-dphy"><strong>‚ÄúEnable MIPI Display Physical Layer (DPHY)‚Äù</strong></a></li>
</ul>
<p>Don‚Äôt forget to switch on the <strong>Display Backlight</strong>!</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/pio#pinephone-backlight"><strong>‚ÄúPinePhone Backlight‚Äù</strong></a></li>
</ul>
<p>Now that we have initialised A64 MIPI DSI, we‚Äôre ready to send our DCS Command‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/dsi-packet.png" alt="MIPI DSI Long Packet (Page 203)" /></p>
<p><a href="https://files.pine64.org/doc/datasheet/ox64/BL808_RM_en_1.0(open).pdf"><em>MIPI DSI Long Packet (Page 203)</em></a></p>
<h1 id="long-packet-for-mipi-dsi"><a class="doc-anchor" href="#long-packet-for-mipi-dsi">¬ß</a>11 Long Packet for MIPI DSI</h1>
<p>Earlier we talked about transmitting a <strong>DCS Long Write</strong> command (Data Type <code>0x39</code>) to ST7703 LCD Controller‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#display-command-set-for-mipi-dsi"><strong>‚ÄúDisplay Command Set for MIPI DSI‚Äù</strong></a></li>
</ul>
<p>Page 32 of the <a href="https://files.pine64.org/doc/datasheet/pinephone/ST7703_DS_v01_20160128.pdf"><strong>ST7703 Datasheet</strong></a> says that we need to transmit a <strong>Long Packet</strong> in this format‚Ä¶</p>
<p><strong>Packet Header</strong> (4 bytes):</p>
<ul>
<li>
<p><strong>Data Identifier (DI)</strong> (1 byte):</p>
<p>Virtual Channel Identifier (Bits 6 to 7)</p>
<p>Data Type (Bits 0 to 5)</p>
<p><a href="https://lupyuen.github.io/articles/dsi#initialise-lcd-controller">(Virtual Channel should be 0, I think)</a></p>
</li>
<li>
<p><strong>Word Count (WC)</strong> (2 bytes)Ôºö</p>
<p>Number of bytes in the Packet Payload</p>
</li>
<li>
<p><strong>Error Correction Code (ECC)</strong> (1 byte):</p>
<p>Allow single-bit errors to be corrected and 2-bit errors to be detected in the Packet Header</p>
<p><a href="https://files.pine64.org/doc/datasheet/ox64/BL808_RM_en_1.0(open).pdf">(See ‚Äú12.3.6.12: Error Correction Code‚Äù, Page 208)</a></p>
<p><a href="https://lupyuen.github.io/articles/dsi2#packet-header">(How we compose the Packet Header)</a></p>
</li>
</ul>
<p><strong>Packet Payload:</strong></p>
<ul>
<li>
<p><strong>Data</strong> (0 to 65,541 bytes):</p>
<p>Number of data bytes should match the Word Count (WC)</p>
</li>
</ul>
<p><strong>Packet Footer:</strong></p>
<ul>
<li>
<p><strong>Checksum (CS)</strong> (2 bytes):</p>
<p>16-bit Cyclic Redundancy Check (CRC)</p>
<p><a href="https://files.pine64.org/doc/datasheet/ox64/BL808_RM_en_1.0(open).pdf">(See ‚Äú12.3.6.13: Packet Footer‚Äù, Page 210)</a></p>
<p><a href="https://lupyuen.github.io/articles/dsi2#appendix-cyclic-redundancy-check">(How we compute the CRC)</a></p>
</li>
</ul>
<p>We have implemented MIPI DSI Long Packets in <strong>Apache NuttX Kernel</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi3#send-mipi-dsi-packet"><strong>‚ÄúSend MIPI DSI Packet‚Äù</strong></a></li>
</ul>
<p>Let‚Äôs program A64 to send this Long Packet.</p>
<p>(Page 32 of the <a href="https://files.pine64.org/doc/datasheet/pinephone/ST7703_DS_v01_20160128.pdf"><strong>ST7703 Datasheet</strong></a> also defines a <strong>Short Packet</strong> format, which is explained in the Appendix)</p>
<p><img src="https://lupyuen.github.io/images/dsi-tx.png" alt="MIPI DSI Low Power Transmit Package Register from A31 User Manual (Page 856)" /></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf"><em>MIPI DSI Low Power Transmit Package Register from A31 User Manual (Page 856)</em></a></p>
<h1 id="transmit-packet-over-mipi-dsi"><a class="doc-anchor" href="#transmit-packet-over-mipi-dsi">¬ß</a>12 Transmit Packet over MIPI DSI</h1>
<p>We‚Äôre finally ready to transmit the <strong>DCS Long Write</strong> command to ST7703 LCD Controller!</p>
<p>We begin by setting the following bits to 1 in <strong>DSI_CMD_CTL_REG</strong> (DSI Low Power Control Register) at Offset <code>0x200</code>‚Ä¶</p>
<ul>
<li>
<p><strong>RX_Overflow</strong> (Bit 26): Clear flag for ‚ÄúReceive overflow‚Äù</p>
</li>
<li>
<p><strong>RX_Flag</strong> (Bit 25): Clear flag for ‚ÄúReceive has started‚Äù</p>
</li>
<li>
<p><strong>TX_Flag</strong> (Bit 9): Clear flag for ‚ÄúTransmit has started‚Äù</p>
</li>
</ul>
<p>All other bits must be set to 0. <a href="https://lupyuen.github.io/articles/dsi2#send-mipi-dsi-packet">(Like this)</a></p>
<p>We compose a <strong>Long Packet</strong> (or Short Packet) containing the DCS Long Write (or DCS Short Write) command‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi#long-packet-for-mipi-dsi"><strong>‚ÄúLong Packet for MIPI DSI‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-short-packet-for-mipi-dsi"><strong>‚ÄúShort Packet for MIPI DSI‚Äù</strong></a></p>
</li>
</ul>
<p>The packet contains‚Ä¶</p>
<ul>
<li>
<p>Packet Header</p>
</li>
<li>
<p>Packet Payload <em>(only for Long Packet)</em></p>
</li>
<li>
<p>Packet Footer <em>(only for Long Packet)</em></p>
</li>
</ul>
<p>Now we write the packet to <strong>DSI_CMD_TX_REG</strong> (DSI Low Power Transmit Package Register) at Offset <code>0x300</code> to <code>0x3FC</code>. (Pic above)</p>
<p><em>What‚Äôs N in the table above?</em></p>
<p>We may rewrite the table without N like so‚Ä¶</p>
<div><table><thead><tr><th>Offset</th><th style="text-align: center">Bits 31 to 24</th><th style="text-align: center">23 to 16</th><th style="text-align: center">15 to 8</th><th style="text-align: center">7 to 0</th></tr></thead><tbody>
<tr><td><code>0x300</code></td><td style="text-align: center">Byte 3</td><td style="text-align: center">Byte 2</td><td style="text-align: center">Byte 1</td><td style="text-align: center">Byte 0</td></tr>
<tr><td><code>0x304</code></td><td style="text-align: center">Byte 7</td><td style="text-align: center">Byte 6</td><td style="text-align: center">Byte 5</td><td style="text-align: center">Byte 4</td></tr>
<tr><td><code>0x308</code></td><td style="text-align: center">Byte 11</td><td style="text-align: center">Byte 10</td><td style="text-align: center">Byte 9</td><td style="text-align: center">Byte 8</td></tr>
<tr><td>‚Ä¶</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<p>Thus <strong>DSI_CMD_TX_REG</strong> works like a Packet Buffer that will contain the data to be transmitted over MIPI DSI.</p>
<p>Then we set <strong>Packet Length - 1</strong> in Bits 0 to 7 <strong>(TX_Size)</strong> of <strong>DSI_CMD_CTL_REG</strong> (DSI Low Power Control Register) at Offset <code>0x200</code>.</p>
<p>Finally we set <strong>DSI_INST_JUMP_SEL_REG</strong> (Offset <code>0x48</code>, undocumented) to begin the Low Power Transmission.</p>
<p><a href="https://lupyuen.github.io/articles/dsi2#send-mipi-dsi-packet">(How we write the packet to <strong>DSI_CMD_TX_REG</strong>)</a></p>
<p>We also need to‚Ä¶</p>
<ul>
<li>
<p>Disable DSI Processing:</p>
<p>Set <strong>Instru_En</strong> to 0 <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L458-L464">(Like this)</a></p>
</li>
<li>
<p>Then Enable DSI Processing:</p>
<p>Set <strong>Instru_En</strong> to 1 <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L464-L470">(Like this)</a></p>
</li>
</ul>
<p><strong>Instru_En</strong> is Bit 0 of <strong>DSI_BASIC_CTL0_REG</strong> (DSI Configuration Register 0) at Offset <code>0x10</code>.</p>
<p><em>How will we know when the transmission is complete?</em></p>
<p>To check whether the transmission is complete, we poll on <strong>Instru_En</strong>.</p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L439-L458">(Like this)</a></p>
<p><em>Wow this looks super complicated!</em></p>
<p>Yeah. The complete steps to initialise the ST7703 LCD Controller will look like this‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi2#initialise-st7703-lcd-controller"><strong>‚ÄúInitialise ST7703 LCD Controller‚Äù</strong></a></li>
</ul>
<p>We have implemented the sending of MIPI DSI Packets in <strong>Apache NuttX Kernel</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi3#send-mipi-dsi-packet"><strong>‚ÄúSend MIPI DSI Packet‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/pio-display.png" alt="Display Engine (DE) and Timing Controller (TCON0) from A64 User Manual (Page 498)" /></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf"><em>Display Engine (DE) and Timing Controller (TCON0) from A64 User Manual (Page 498)</em></a></p>
<h1 id="render-display"><a class="doc-anchor" href="#render-display">¬ß</a>13 Render Display</h1>
<p><em>OK we have initialised the ST7703 display‚Ä¶</em></p>
<p><em>What about rendering the display?</em></p>
<p>Remember we said that the ST7703 LCD Controller is RAM-less? And thus we need to <strong>pump a constant stream of pixels</strong> to the display?</p>
<p>To do this, we program two controllers in Allwinner A64‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/pio#display-engine"><strong>Display Engine (DE)</strong></a>: Execute the Rendering Pipeline to generate the pixels for display</p>
<p>(Handles image buffering, scaling, mixing, ‚Ä¶)</p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pio#lcd-controller-tcon0"><strong>Timing Controller (TCON0)</strong></a>: Pump the generated pixels at the right clock frequency to the MIPI DSI display</p>
<p>(Pic above)</p>
</li>
</ul>
<p><em>Is there a specific sequence of steps for calling the Display Serial Interface, Display Engine and Timing Controller?</em></p>
<p>To render graphics on PinePhone‚Äôs LCD Display, our Display Driver needs to follow these steps‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-sequence-of-steps-for-pinephone-display-driver"><strong>‚ÄúSequence of Steps for PinePhone Display Driver‚Äù</strong></a></li>
</ul>
<p>We‚Äôll explain all these in the next article!</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/de"><strong>‚ÄúRendering PinePhone‚Äôs Display (DE and TCON0)‚Äù</strong></a></li>
</ul>
<p><a href="https://www.reddit.com/r/PINE64official/comments/xjzack/comment/ipd6fsy/?utm_source=share&amp;utm_medium=web2x&amp;context=3"><strong>u/immibis on Reddit</strong></a> has shared some helpful tips‚Ä¶</p>
<blockquote>
<p>‚ÄúTo actually display pixels on the screen you also need to program DE and TCON. I saw something somewhere about a test pattern that might be able to bypass this, and a framebuffer mode that bypasses the mixing IIRC.‚Äù</p>
</blockquote>
<p>And we might hit some <strong>undocumented A64 Registers</strong>‚Ä¶</p>
<blockquote>
<p>‚Äúseveral important registers used by the driver aren‚Äôt documented (the command registers) but the basic format is shown in the driver source code‚Äù</p>
</blockquote>
<blockquote>
<p>‚Äú‚Ä¶the module is running a little instruction set and the manual conspicuously omits any description of the instructions or even the registers where you put the instructions.‚Äù</p>
</blockquote>
<p>We‚Äôll find out soon in the next article!</p>
<p><img src="https://lupyuen.github.io/images/serial-title.jpg" alt="Apache NuttX RTOS booting on PinePhone" /></p>
<p><a href="https://lupyuen.github.io/articles/uboot"><em>Apache NuttX RTOS booting on PinePhone</em></a></p>
<h1 id="nuttx-display-driver-for-pinephone"><a class="doc-anchor" href="#nuttx-display-driver-for-pinephone">¬ß</a>14 NuttX Display Driver for PinePhone</h1>
<p><em>Once again, why are we doing all this?</em></p>
<p>We‚Äôre now porting <a href="https://lupyuen.github.io/articles/uboot"><strong>Apache NuttX RTOS</strong></a> to PinePhone.</p>
<p>But it will look awfully dull until we <strong>render something</strong> on PinePhone‚Äôs LCD Display!</p>
<p>That‚Äôs why we‚Äôre probing the internals of PinePhone to create a <strong>NuttX Display Driver</strong>.</p>
<p><em>How shall we build the NuttX Driver for PinePhone‚Äôs Display?</em></p>
<p>Our <strong>NuttX Display Driver</strong> for PinePhone shall implement these functions (pic below)‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi3#complete-display-driver-for-pinephone"><strong>‚ÄúComplete Display Driver for PinePhone‚Äù</strong></a></li>
</ul>
<p>We have completed the <strong>Zig Implementation</strong> of the NuttX Driver‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi2"><strong>‚ÄúNuttX RTOS for PinePhone: Display Driver in Zig‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de2"><strong>‚ÄúNuttX RTOS for PinePhone: Render Graphics in Zig‚Äù</strong></a></p>
</li>
</ul>
<p>We‚Äôre porting the <strong>Zig Driver to C</strong> and adding to NuttX Kernel‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi3#upcoming-nuttx-drivers"><strong>‚ÄúUpcoming NuttX Drivers‚Äù</strong></a></li>
</ul>
<p>Stay Tuned for Updates!</p>
<p><img src="https://lupyuen.github.io/images/dsi3-steps.jpg" alt="Inside our Complete Display Driver for PinePhone" /></p>
<p><a href="https://lupyuen.github.io/articles/dsi3#complete-display-driver-for-pinephone"><em>Inside our Complete Display Driver for PinePhone</em></a></p>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>15 What‚Äôs Next</h1>
<p>I hope we learnt lots about PinePhone‚Äôs Display‚Ä¶</p>
<ul>
<li>
<p>What‚Äôs a <a href="https://lupyuen.github.io/articles/dsi#connector-for-mipi-dsi"><strong>MIPI Display Serial Interface (DSI)</strong></a></p>
</li>
<li>
<p>What‚Äôs inside <a href="https://lupyuen.github.io/articles/dsi#xingbangda-xbd599-lcd-panel"><strong>PinePhone‚Äôs LCD Display</strong></a></p>
</li>
<li>
<p>How it‚Äôs similar to <a href="https://lupyuen.github.io/articles/dsi#sitronix-st7703-lcd-controller"><strong>PineTime‚Äôs Display Controller</strong></a></p>
</li>
<li>
<p>Implications of a <a href="https://lupyuen.github.io/articles/dsi#render-display"><strong>RAM-less Display Controller</strong></a></p>
</li>
<li>
<p>What are PinePhone‚Äôs <a href="https://lupyuen.github.io/articles/dsi#render-display"><strong>Display Engine (DE)</strong></a> and <a href="https://lupyuen.github.io/articles/dsi#render-display"><strong>Timing Controller (TCON)</strong></a></p>
</li>
</ul>
<p>Please join me in the next article when we‚Äôll build a PinePhone Display Driver in Zig!</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/dsi2"><strong>‚ÄúNuttX RTOS for PinePhone: Display Driver in Zig‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/de2"><strong>‚ÄúNuttX RTOS for PinePhone: Render Graphics in Zig‚Äù</strong></a></p>
</li>
</ul>
<p>Please check out the other articles on NuttX for PinePhone‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/PINE64official/comments/xsteb3/understanding_pinephones_display_mipi_dsi/"><strong>Discuss this article on Reddit</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-ox64"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-star64"><strong>My Other Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>Older Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/dsi.md"><strong>lupyuen.github.io/src/dsi.md</strong></a></p>
<h1 id="notes"><a class="doc-anchor" href="#notes">¬ß</a>16 Notes</h1>
<ol>
<li>
<p>All writes to MIPI DSI Hardware Registers must use <a href="https://developer.arm.com/documentation/dui0489/c/arm-and-thumb-instructions/miscellaneous-instructions/dmb--dsb--and-isb"><strong>Data Memory Barrier (DMB)</strong></a></p>
<p><a href="https://megous.com/git/p-boot/tree/src/display.c#n756">(According to this)</a></p>
</li>
<li>
<p>How did we find the Reference Code for the MIPI DSI Driver? We used GitHub Code Search‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/pio#lcd-controller-tcon0"><strong>‚ÄúSearching online for the driver‚Äù</strong></a></p>
</li>
<li>
<p>This doc explains MIPI DSI rather well‚Ä¶</p>
<p><a href="https://files.pine64.org/doc/datasheet/ox64/BL808_RM_en_1.0(open).pdf"><strong>‚ÄúBL808 Reference Manual‚Äù</strong></a></p>
<p>(Page 181, Chapter 12: ‚ÄúDSI‚Äù)</p>
</li>
<li>
<p>ST7703 always runs in <strong>DSI Video Mode</strong> (instead of Command Mode).</p>
<p>Does this mean that all DCS Commands are sent over all 4 DSI Data Lanes? (Instead of DSI Lane 0 only)</p>
<p><strong>UPDATE:</strong> At Startup, DCS Commands are sent over DSI Lane 0. After Startup, Pixel Data is sent over Multiple DSI Data Lanes in Video Mode. Which means the Pixel Data is pushed as a continuous stream of Video Pixels, instead of plotting every pixel command by command.</p>
</li>
<li>
<p>Can we <strong>receive data</strong> from ST7703?</p>
<p><a href="https://www.reddit.com/r/PINE64official/comments/xsteb3/comment/iqostm5/?utm_source=share&amp;utm_medium=web2x&amp;context=3">(See this)</a></p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/dsi3-steps.jpg" alt="Inside our Complete Display Driver for PinePhone" /></p>
<p><a href="https://lupyuen.github.io/articles/dsi3#complete-display-driver-for-pinephone"><em>Inside our Complete Display Driver for PinePhone</em></a></p>
<h1 id="appendix-sequence-of-steps-for-pinephone-display-driver"><a class="doc-anchor" href="#appendix-sequence-of-steps-for-pinephone-display-driver">¬ß</a>17 Appendix: Sequence of Steps for PinePhone Display Driver</h1>
<p><em>Is there a specific sequence of steps for calling the Display Serial Interface, Display Engine and Timing Controller?</em></p>
<p>To render graphics on PinePhone‚Äôs LCD Display, our Display Driver needs to follow these steps: <a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/render.zig#L175-L226">render.zig</a></p>
<ol>
<li>
<p>Turn on <strong>Display Backlight</strong></p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-display-backlight">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/backlight.zig">(Implemented here)</a></p>
</li>
<li>
<p>Initialise <strong>Timing Controller (TCON0)</strong></p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-timing-controller-tcon0">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/tcon.zig">(Implemented here)</a></p>
</li>
<li>
<p>Initialise <strong>Power Management Integrated Circuit (PMIC)</strong> and wait 15 milliseconds</p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-power-management-integrated-circuit">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/pmic.zig">(Implemented here)</a></p>
</li>
<li>
<p>Enable <strong>MIPI DSI Block</strong></p>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-enable-mipi-dsi-block">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L874-L1365">(Implemented here)</a></p>
</li>
<li>
<p>Enable <strong>MIPI Display Physical Layer (DPHY)</strong></p>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-enable-mipi-display-physical-layer-dphy">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/dphy.zig">(Implemented here)</a></p>
</li>
<li>
<p>Reset <strong>LCD Panel</strong> and wait 15 milliseconds</p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-reset-lcd-panel">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/panel.zig">(Implemented here)</a></p>
</li>
<li>
<p>Initialise <strong>LCD Controller (ST7703)</strong></p>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-initialise-lcd-controller">(Explained here)</a></p>
<p><a href="https://lupyuen.github.io/articles/dsi2#initialise-st7703-lcd-controller">(Implemented here)</a></p>
</li>
<li>
<p>Start <strong>MIPI DSI HSC and HSD</strong></p>
<p>(High Speed Clock Mode and High Speed Data Transmission)</p>
<p><a href="https://lupyuen.github.io/articles/dsi#appendix-start-mipi-dsi-hsc-and-hsd">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L1365-L1423">(Implemented here)</a></p>
</li>
<li>
<p>Initialise <strong>Display Engine (DE)</strong></p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-initialising-the-allwinner-a64-display-engine">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/render.zig#L710-L1011">(Implemented here)</a></p>
</li>
<li>
<p>Wait 160 milliseconds</p>
</li>
<li>
<p>Render Graphics with <strong>Display Engine (DE)</strong></p>
<p><a href="https://lupyuen.github.io/articles/de#appendix-programming-the-allwinner-a64-display-engine">(Explained here)</a></p>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/render.zig#L69-L175">(Implemented here)</a></p>
</li>
</ol>
<h1 id="appendix-enable-mipi-dsi-block"><a class="doc-anchor" href="#appendix-enable-mipi-dsi-block">¬ß</a>18 Appendix: Enable MIPI DSI Block</h1>
<p>Earlier we talked about the sequence of steps that our Display Driver needs to follow‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-sequence-of-steps-for-pinephone-display-driver"><strong>‚ÄúSequence of Steps for PinePhone Display Driver‚Äù</strong></a></li>
</ul>
<p>This section explains how we <strong>enable the Allwinner A64 MIPI DSI Block</strong>, before calling it to transmit MIPI DSI Commands to the ST7703 LCD Controller.</p>
<p>We captured the log from <a href="https://megous.com/git/p-boot/tree/src/display.c#n1236"><strong>p-boot dsi_init</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/c12f64cf03d3a81e9c69f9fef49d9b70#enable_dsi_block"><strong>Log from dsi_init</strong></a></li>
</ul>
<p>By decoding the captured addresses and values, we decipher the following steps to <strong>enable the Allwinner A64 MIPI DSI Block</strong>‚Ä¶</p>
<ol>
<li>
<p>Enable MIPI DSI Bus</p>
<p><strong>BUS_CLK_GATING_REG0</strong>: CCU Offset <code>0x60</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 100)</a></p>
<ul>
<li>Set <strong>MIPIDSI_GATING</strong> (Bit 1) to 1 (Pass Gating Clock for MIPI DSI)</li>
</ul>
<p><strong>BUS_SOFT_RST_REG0</strong>: CCU Offset <code>0x2C0</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 138)</a></p>
<ul>
<li><strong>Set MIPI_DSI_RST</strong> (Bit 1) to 1 (Deassert MIPI DSI Reset)</li>
</ul>
<p><strong>CCU Base Address</strong>: <code>0x01C2</code> <code>0000</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 82)</a></p>
<div class="example-wrap"><pre class="language-text"><code>mipi dsi bus enable
setbits 0x1c20060, 0x2 (DMB)
setbits 0x1c202c0, 0x2 (DMB)
</code></pre></div></li>
<li>
<p>Enable DSI Block</p>
<p><strong>DSI_CTL_REG</strong>: DSI Offset <code>0x0</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 843)</a></p>
<ul>
<li>Set <strong>DSI_En</strong> (Bit 0) to 1 (Enable DSI)</li>
</ul>
<p><strong>DSI_BASIC_CTL0_REG</strong>: DSI Offset <code>0x10</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 845)</a></p>
<ul>
<li>Set <strong>CRC_En</strong> (Bit 17) to 1 (Enable CRC)</li>
<li>Set <strong>ECC_En</strong> (Bit 16) to 1 (Enable ECC)</li>
</ul>
<p><strong>DSI_TRANS_START_REG</strong>: DSI Offset <code>0x60</code> (Undocumented)</p>
<ul>
<li>Set to 10</li>
</ul>
<p><strong>DSI_TRANS_ZERO_REG</strong>: DSI Offset <code>0x78</code> (Undocumented)</p>
<ul>
<li>Set to 0</li>
</ul>
<p>DSI Base Address: <code>0x01CA</code> <code>0000</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 842)</a></p>
<div class="example-wrap"><pre class="language-text"><code>Enable the DSI block
0x1ca0000 = 0x1 (DMB)
0x1ca0010 = 0x30000 (DMB)
0x1ca0060 = 0xa (DMB)
0x1ca0078 = 0x0 (DMB)
</code></pre></div></li>
<li>
<p>Set Instructions (Undocumented)</p>
<p><strong>DSI_INST_FUNC_REG(0)</strong>: DSI Offset <code>0x20</code></p>
<ul>
<li>Set to <code>0x1f</code></li>
<li>Index 0 is DSI_INST_ID_LP11</li>
</ul>
<p><strong>DSI_INST_FUNC_REG(1)</strong>: DSI Offset <code>0x24</code></p>
<ul>
<li>Set to <code>0x1000</code> <code>0001</code></li>
<li>Index 1 is DSI_INST_ID_TBA</li>
</ul>
<p><strong>DSI_INST_FUNC_REG(2)</strong>: DSI Offset <code>0x28</code></p>
<ul>
<li>Set to <code>0x2000</code> <code>0010</code></li>
<li>Index 2 is DSI_INST_ID_HSC</li>
</ul>
<p><strong>DSI_INST_FUNC_REG(3)</strong>: DSI Offset <code>0x2c</code></p>
<ul>
<li>Set to <code>0x2000</code> <code>000f</code></li>
<li>Index 3 is DSI_INST_ID_HSD</li>
</ul>
<p><strong>DSI_INST_FUNC_REG(4)</strong>: DSI Offset <code>0x30</code></p>
<ul>
<li>Set to <code>0x3010</code> <code>0001</code></li>
<li>Index 4 is DSI_INST_ID_LPDT</li>
</ul>
<p><strong>DSI_INST_FUNC_REG(5)</strong>: DSI Offset <code>0x34</code></p>
<ul>
<li>Set to <code>0x4000</code> <code>0010</code></li>
<li>Index 5 is DSI_INST_ID_HSCEXIT</li>
</ul>
<p><strong>DSI_INST_FUNC_REG(6)</strong>: DSI Offset <code>0x38</code></p>
<ul>
<li>Set to <code>0xf</code></li>
<li>Index 6 is DSI_INST_ID_NOP</li>
</ul>
<p><strong>DSI_INST_FUNC_REG(7)</strong>: DSI Offset <code>0x3c</code></p>
<ul>
<li>Set to <code>0x5000</code> <code>001f</code></li>
<li>Index 7 is DSI_INST_ID_DLY</li>
</ul>
<p>(DSI_INST_FUNC_REG(n) is <code>(0x020 + (n) * 0x04)</code>)</p>
<div class="example-wrap"><pre class="language-text"><code>inst_init
0x1ca0020 = 0x1f (DMB)
0x1ca0024 = 0x10000001 (DMB)
0x1ca0028 = 0x20000010 (DMB)
0x1ca002c = 0x2000000f (DMB)
0x1ca0030 = 0x30100001 (DMB)
0x1ca0034 = 0x40000010 (DMB)
0x1ca0038 = 0xf (DMB)
0x1ca003c = 0x5000001f (DMB)
</code></pre></div></li>
<li>
<p>Configure Jump Instructions (Undocumented)</p>
<p><strong>DSI_INST_JUMP_CFG_REG(0)</strong>: DSI Offset <code>0x4c</code></p>
<ul>
<li>Set to <code>0x56</code> <code>0001</code></li>
<li>Index 0 is DSI_INST_JUMP_CFG</li>
</ul>
<p>(DSI_INST_JUMP_CFG_REG(n) is <code>(0x04c + (n) * 0x04)</code>)</p>
<p><strong>DSI_DEBUG_DATA_REG</strong>: DSI Offset <code>0x2f8</code></p>
<ul>
<li>Set to <code>0xff</code></li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>0x1ca004c = 0x560001 (DMB)
0x1ca02f8 = 0xff (DMB)
</code></pre></div></li>
<li>
<p>Set Video Start Delay</p>
<p><strong>DSI_BASIC_CTL1_REG</strong>: DSI Offset <code>0x14</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 846)</a></p>
<ul>
<li>Set <strong>Video_Start_Delay</strong> (Bits 4 to 16) to 1468 (Line Delay)</li>
<li>Set <strong>Video_Precision_Mode_Align</strong> (Bit 2) to 1 (Fill Mode)</li>
<li>Set <strong>Video_Frame_Start</strong> (Bit 1) to 1 (Precision Mode)</li>
<li>Set <strong>DSI_Mode</strong> (Bit 0) to 1 (Video Mode)</li>
</ul>
<p>Note: Video_Start_Delay is actually 13 bits, not 8 bits as stated in the A31 User Manual</p>
<div class="example-wrap"><pre class="language-text"><code>get_video_start_delay
0x1ca0014 = 0x5bc7 (DMB)
</code></pre></div></li>
<li>
<p>Set Burst (Undocumented)</p>
<p><strong>DSI_TCON_DRQ_REG</strong>: DSI Offset 0x7c</p>
<ul>
<li>Set to <code>0x1000</code> <code>0007</code></li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>setup_burst
0x1ca007c = 0x10000007 (DMB)
</code></pre></div></li>
<li>
<p>Set Instruction Loop (Undocumented)</p>
<p><strong>DSI_INST_LOOP_SEL_REG</strong>: DSI Offset <code>0x40</code></p>
<ul>
<li>Set to <code>0x3000</code> <code>0002</code></li>
</ul>
<p><strong>DSI_INST_LOOP_NUM_REG(0)</strong>: DSI Offset <code>0x44</code></p>
<ul>
<li>Set to <code>0x31</code> <code>0031</code></li>
</ul>
<p><strong>DSI_INST_LOOP_NUM_REG(1)</strong>: DSI Offset <code>0x54</code></p>
<ul>
<li>Set to <code>0x31</code> <code>0031</code></li>
</ul>
<p>(DSI_INST_LOOP_NUM_REG(n) is <code>(0x044 + (n) * 0x10)</code>)</p>
<div class="example-wrap"><pre class="language-text"><code>setup_inst_loop
0x1ca0040 = 0x30000002 (DMB)
0x1ca0044 = 0x310031 (DMB)
0x1ca0054 = 0x310031 (DMB)
</code></pre></div></li>
<li>
<p>Set Pixel Format</p>
<p><strong>DSI_PIXEL_PH_REG</strong>: DSI Offset <code>0x90</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 848)</a></p>
<ul>
<li>Set <strong>ECC</strong> (Bits 24 to 31) to 19</li>
<li>Set <strong>WC</strong> (Bits 8 to 23) to 2160 (Byte Numbers of PD in a Pixel Packet)</li>
<li>Set <strong>VC</strong> (Bits 6 to 7) to 0 (Virtual Channel)</li>
<li>Set <strong>DT</strong> (Bits 0 to 5) to <code>0x3E</code> (24-bit Video Mode)</li>
</ul>
<p><strong>DSI_PIXEL_PF0_REG</strong>: DSI Offset <code>0x98</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 849)</a></p>
<ul>
<li>Set <strong>CRC_Force</strong> (Bits 0 to 15) to <code>0xffff</code> (Force CRC to this value)</li>
</ul>
<p><strong>DSI_PIXEL_PF1_REG</strong>: DSI Offset <code>0x9c</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 849)</a></p>
<ul>
<li>Set <strong>CRC_Init_LineN</strong> (Bits 16 to 31) to <code>0xffff</code> (CRC initial to this value in transmitions except 1st one)</li>
<li>Set <strong>CRC_Init_Line0</strong> (Bits 0 to 15) to <code>0xffff</code> (CRC initial to this value in 1st transmition every frame)</li>
</ul>
<p><strong>DSI_PIXEL_CTL0_REG</strong>: DSI Offset <code>0x80</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 847)</a></p>
<ul>
<li>Set <strong>PD_Plug_Dis</strong> (Bit 16) to 1 (Disable PD plug before pixel bytes)</li>
<li>Set <strong>Pixel_Endian</strong> (Bit 4) to 0 (LSB first)</li>
<li>Set <strong>Pixel_Format</strong> (Bits 0 to 3) to 8 (24-bit RGB888)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>setup_format
0x1ca0090 = 0x1308703e (DMB)
0x1ca0098 = 0xffff (DMB)
0x1ca009c = 0xffffffff (DMB)
0x1ca0080 = 0x10008 (DMB)
</code></pre></div></li>
<li>
<p>Set Sync Timings</p>
<p><strong>DSI_BASIC_CTL_REG</strong>: DSI Offset <code>0x0c</code> (Undocumented)</p>
<ul>
<li>Set to 0</li>
</ul>
<p><strong>DSI_SYNC_HSS_REG</strong>: DSI Offset <code>0xb0</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 850)</a></p>
<ul>
<li>Set <strong>ECC</strong> (Bits 24 to 31) to <code>0x12</code></li>
<li>Set <strong>D1</strong> (Bits 16 to 23) to 0</li>
<li>Set <strong>D0</strong> (Bits 8 to 15) to 0</li>
<li>Set <strong>VC</strong> (Bits 6 to 7) to 0 (Virtual Channel)</li>
<li>Set <strong>DT</strong> (Bits 0 to 5) to <code>0x21</code> (HSS)</li>
</ul>
<p><strong>DSI_SYNC_HSE_REG</strong>: DSI Offset <code>0xb4</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 850)</a></p>
<ul>
<li>Set <strong>ECC</strong> (Bits 24 to 31) to 1</li>
<li>Set <strong>D1</strong> (Bits 16 to 23) to 0</li>
<li>Set <strong>D0</strong> (Bits 8 to 15) to 0</li>
<li>Set <strong>VC</strong> (Bits 6 to 7) to 0 (Virtual Channel)</li>
<li>Set <strong>DT</strong> (Bits 0 to 5) to <code>0x31</code> (HSE)</li>
</ul>
<p><strong>DSI_SYNC_VSS_REG</strong>: DSI Offset <code>0xb8</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 851)</a></p>
<ul>
<li>Set <strong>ECC</strong> (Bits 24 to 31) to 7</li>
<li>Set <strong>D1</strong> (Bits 16 to 23) to 0</li>
<li>Set <strong>D0</strong> (Bits 8 to 15) to 0</li>
<li>Set <strong>VC</strong> (Bits 6 to 7) to 0 (Virtual Channel)</li>
<li>Set <strong>DT</strong> (Bits 0 to 5) to 1 (VSS)</li>
</ul>
<p><strong>DSI_SYNC_VSE_REG</strong>: DSI Offset <code>0xbc</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 851)</a></p>
<ul>
<li>Set <strong>ECC</strong> (Bits 24 to 31) to <code>0x14</code></li>
<li>Set <strong>D1</strong> (Bits 16 to 23) to 0</li>
<li>Set <strong>D0</strong> (Bits 8 to 15) to 0</li>
<li>Set <strong>VC</strong> (Bits 6 to 7) to 0 (Virtual Channel)</li>
<li>Set <strong>DT</strong> (Bits 0 to 5) to <code>0x11</code> (VSE)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>setup_timings
0x1ca000c = 0x0 (DMB)
0x1ca00b0 = 0x12000021 (DMB)
0x1ca00b4 = 0x1000031 (DMB)
0x1ca00b8 = 0x7000001 (DMB)
0x1ca00bc = 0x14000011 (DMB)
</code></pre></div></li>
<li>
<p>Set Basic Size (Undocumented)</p>
<p><strong>DSI_BASIC_SIZE0_REG</strong>: DSI Offset <code>0x18</code></p>
<ul>
<li>Set <strong>Video_VBP</strong> (Bits 16 to 27) to 17</li>
<li>Set <strong>Video_VSA</strong> (Bits 0 to 11) to 10</li>
</ul>
<p><strong>DSI_BASIC_SIZE1_REG</strong>: DSI Offset <code>0x1c</code></p>
<ul>
<li>Set <strong>Video_VT</strong> (Bits 16 to 28) to 1485</li>
<li>Set <strong>Video_VACT</strong> (Bits 0 to 11) to 1440</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>0x1ca0018 = 0x11000a (DMB)
0x1ca001c = 0x5cd05a0 (DMB)
</code></pre></div></li>
<li>
<p>Set Horizontal Blanking</p>
<p><strong>DSI_BLK_HSA0_REG</strong>: DSI Offset <code>0xc0</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 852)</a></p>
<ul>
<li>Set <strong>HSA_PH</strong> (Bits 0 to 31) to <code>0x900</code> <code>4a19</code></li>
</ul>
<p><strong>DSI_BLK_HSA1_REG</strong>: DSI Offset <code>0xc4</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 852)</a></p>
<ul>
<li>Set <strong>HSA_PF</strong> (Bits 16 to 31) to <code>0x50b4</code></li>
<li>Set <strong>HSA_PD</strong> (Bits 0 to 7) to 0</li>
</ul>
<p><strong>DSI_BLK_HBP0_REG</strong>: DSI Offset <code>0xc8</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 852)</a></p>
<ul>
<li>Set <strong>HBP_PH</strong> (Bits 0 to 31) to <code>0x3500</code> <code>5419</code></li>
</ul>
<p><strong>DSI_BLK_HBP1_REG</strong>: DSI Offset <code>0xcc</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 852)</a></p>
<ul>
<li>Set <strong>HBP_PF</strong> (Bits 16 to 31) to <code>0x757a</code></li>
<li>Set <strong>HBP_PD</strong> (Bits 0 to 7) to 0</li>
</ul>
<p><strong>DSI_BLK_HFP0_REG</strong>: DSI Offset <code>0xd0</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 852)</a></p>
<ul>
<li>Set <strong>HFP_PH</strong> (Bits 0 to 31) to <code>0x900</code> <code>4a19</code></li>
</ul>
<p><strong>DSI_BLK_HFP1_REG</strong>: DSI Offset <code>0xd4</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 853)</a></p>
<ul>
<li>Set <strong>HFP_PF</strong> (Bits 16 to 31) to <code>0x50b4</code></li>
<li>Set <strong>HFP_PD</strong> (Bits 0 to 7) to 0</li>
</ul>
<p><strong>DSI_BLK_HBLK0_REG</strong>: DSI Offset <code>0xe0</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 853)</a></p>
<ul>
<li>Set <strong>HBLK_PH</strong> (Bits 0 to 31) to <code>0xc09</code> <code>1a19</code></li>
</ul>
<p><strong>DSI_BLK_HBLK1_REG</strong>: DSI Offset <code>0xe4</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 853)</a></p>
<ul>
<li>Set <strong>HBLK_PF</strong> (Bits 16 to 31) to <code>0x72bd</code></li>
<li>Set <strong>HBLK_PD</strong> (Bits 0 to 7) to 0</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>0x1ca00c0 = 0x9004a19 (DMB)
0x1ca00c4 = 0x50b40000 (DMB)
0x1ca00c8 = 0x35005419 (DMB)
0x1ca00cc = 0x757a0000 (DMB)
0x1ca00d0 = 0x9004a19 (DMB)
0x1ca00d4 = 0x50b40000 (DMB)
0x1ca00e0 = 0xc091a19 (DMB)
0x1ca00e4 = 0x72bd0000 (DMB)
</code></pre></div></li>
<li>
<p>Set Vertical Blanking</p>
<p><strong>DSI_BLK_VBLK0_REG</strong>: DSI Offset <code>0xe8</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 854)</a></p>
<ul>
<li>Set <strong>VBLK_PH</strong> (Bits 0 to 31) to <code>0x1a00</code> <code>0019</code></li>
</ul>
<p><strong>DSI_BLK_VBLK1_REG</strong>: DSI Offset <code>0xec</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 854)</a></p>
<ul>
<li>Set <strong>VBLK_PF</strong> (Bits 16 to 31) to <code>0xffff</code></li>
<li>Set <strong>VBLK_PD</strong> (Bits 0 to 7) to 0</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>0x1ca00e8 = 0x1a000019 (DMB)
0x1ca00ec = 0xffff0000 (DMB)
</code></pre></div></li>
</ol>
<p>Based on the above steps, we have <strong>implemented in Zig</strong> the PinePhone Driver that enables the Allwinner A64 MIPI DSI Block‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L874-L1365"><strong>pinephone-nuttx/display.zig</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#testing-zig-backlight-driver-on-pinephone"><strong>Output Log for display.zig</strong></a></p>
</li>
</ul>
<p>We have implemented the driver in <strong>Apache NuttX Kernel</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi3#enable-mipi-dsi-and-d-phy"><strong>‚ÄúEnable MIPI DSI and D-PHY‚Äù</strong></a></li>
</ul>
<h1 id="appendix-start-mipi-dsi-hsc-and-hsd"><a class="doc-anchor" href="#appendix-start-mipi-dsi-hsc-and-hsd">¬ß</a>19 Appendix: Start MIPI DSI HSC and HSD</h1>
<p>Earlier we talked about the sequence of steps that our Display Driver needs to follow‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-sequence-of-steps-for-pinephone-display-driver"><strong>‚ÄúSequence of Steps for PinePhone Display Driver‚Äù</strong></a></li>
</ul>
<p>This section explains how we <strong>start Allwinner A64 MIPI DSI in HSC and HSD Modes</strong>, before calling it to transmit MIPI DSI Commands to the ST7703 LCD Controller.</p>
<p>(High Speed Clock Mode and High Speed Data Transmission)</p>
<p>We captured the log from <a href="https://megous.com/git/p-boot/tree/src/display.c#n1236"><strong>p-boot dsi_init</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/c12f64cf03d3a81e9c69f9fef49d9b70#start_dsi"><strong>Log from dsi_init</strong></a></li>
</ul>
<p>By decoding the captured addresses and values, we decipher the following steps to <strong>start Allwinner A64 MIPI DSI in HSC and HSD Modes</strong>‚Ä¶</p>
<ol>
<li>
<p>Start HSC (Undocumented)</p>
<p><strong>DSI_INST_JUMP_SEL_REG</strong>: DSI Offset <code>0x48</code></p>
<ul>
<li>Set to <code>0xf02</code></li>
</ul>
<p><strong>DSI Base Address</strong>: <code>0x01CA</code> <code>0000</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 842)</a></p>
<div class="example-wrap"><pre class="language-text"><code>dsi_start DSI_START_HSC
0x1ca0048 = 0xf02 (DMB)
</code></pre></div></li>
<li>
<p>Commit</p>
<p><strong>DSI_BASIC_CTL0_REG</strong>: DSI Offset <code>0x10</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 845)</a></p>
<ul>
<li>Set <strong>Instru_En</strong> (Bit 0) to 1 (Enable DSI Processing from Instruction 0)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>dsi_update_bits: 0x01ca0010 : 00030000 -&gt; (00000001) 00000001 (DMB)
addr=0x1ca0010, mask=0x1, val=0x1 (DMB)
</code></pre></div></li>
<li>
<p>Instruction Function Lane (Undocumented)</p>
<p><strong>DSI_INST_FUNC_REG(0)</strong>: DSI Offset <code>0x20</code></p>
<ul>
<li>Set <strong>DSI_INST_FUNC_LANE_CEN</strong> (Bit 4) to 0</li>
<li>Index 0 is DSI_INST_ID_LP11</li>
</ul>
<p>(DSI_INST_FUNC_REG(n) is <code>(0x020 + (n) * 0x04)</code>)</p>
<div class="example-wrap"><pre class="language-text"><code>dsi_update_bits: 0x01ca0020 : 0000001f -&gt; (00000010) 00000000 (DMB)
addr=0x1ca0020, mask=0x10, val=0x0 (DMB)
</code></pre></div></li>
<li>
<p>Wait 1,000 microseconds</p>
<div class="example-wrap"><pre class="language-text"><code>udelay 1000
</code></pre></div></li>
<li>
<p>Start HSD (Undocumented)</p>
<p><strong>DSI_INST_JUMP_SEL_REG</strong>: DSI Offset <code>0x48</code></p>
<ul>
<li>Set to <code>0x63f0</code> <code>7006</code></li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>dsi_start DSI_START_HSD
0x1ca0048 = 0x63f07006 (DMB)
</code></pre></div></li>
<li>
<p>Commit</p>
<p><strong>DSI_BASIC_CTL0_REG</strong>: DSI Offset <code>0x10</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/A31_User_Manual_v1.3_20150510.pdf">(A31 Page 845)</a></p>
<ul>
<li>Set <strong>Instru_En</strong> (Bit 0) to 1 (Enable DSI Processing from Instruction 0)</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>dsi_update_bits: 0x01ca0010 : 00030000 -&gt; (00000001) 00000001 (DMB)
addr=0x1ca0010, mask=0x1, val=0x1 (DMB)
</code></pre></div></li>
</ol>
<p>Based on the above steps, we have <strong>implemented in Zig</strong> the PinePhone Driver that starts Allwinner A64 MIPI DSI (in HSC and HSD Modes)‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/display.zig#L1365-L1423"><strong>pinephone-nuttx/display.zig</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#testing-zig-backlight-driver-on-pinephone"><strong>Output Log for display.zig</strong></a></p>
</li>
</ul>
<p>We have implemented the driver in <strong>Apache NuttX Kernel</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi3#enable-mipi-dsi-and-d-phy"><strong>‚ÄúEnable MIPI DSI and D-PHY‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/dsi-layer.png" alt="MIPI DSI Protocol Layers (Page 183)" /></p>
<p><a href="https://files.pine64.org/doc/datasheet/ox64/BL808_RM_en_1.0(open).pdf"><em>MIPI DSI Protocol Layers (Page 183)</em></a></p>
<h1 id="appendix-enable-mipi-display-physical-layer-dphy"><a class="doc-anchor" href="#appendix-enable-mipi-display-physical-layer-dphy">¬ß</a>20 Appendix: Enable MIPI Display Physical Layer (DPHY)</h1>
<p>Earlier we talked about initialising the MIPI DSI Controller‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#initialise-mipi-dsi"><strong>‚ÄúInitialise MIPI DSI‚Äù</strong></a></li>
</ul>
<p>There‚Äôs something else that needs to be initialised: <strong>MIPI DPHY</strong>, the <strong>Display Physical Layer</strong> for MIPI DSI‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/pio#display-phy"><strong>‚ÄúA64 MIPI DPHY‚Äù</strong></a></li>
</ul>
<p>MIPI DPHY is the <strong>‚ÄúPhysical Layer‚Äù</strong> in the pic above.</p>
<p>(MIPI DSI runs in the layers above MIPI DPHY)</p>
<p>Sadly Allwinner A64‚Äôs MIPI DPHY doesn‚Äôt seem to be documented, so we might need to do Reverse Engineering.</p>
<p><em>How do we implement MIPI DPHY if it‚Äôs undocumented?</em></p>
<p>We captured the log from <a href="https://megous.com/git/p-boot/tree/src/display.c#n331"><strong>p-boot dphy_enable</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/c12f64cf03d3a81e9c69f9fef49d9b70#dphy_enable"><strong>Log from dphy_enable</strong></a></li>
</ul>
<p>By decoding the captured addresses and values, we decipher the following steps to <strong>enable the Allwinner A64 MIPI Display Physical Layer (DPHY)</strong>‚Ä¶</p>
<ol>
<li>
<p>Set DSI Clock to 150 MHz (600 MHz / 4)</p>
<p><strong>MIPI_DSI_CLK_REG</strong>: CCU Offset <code>0x168</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 122)</a></p>
<ul>
<li>Set <strong>DSI_DPHY_GATING</strong> (Bit 15) to 1 (DSI DPHY Clock is On)</li>
<li>Set <strong>DSI_DPHY_SRC_SEL</strong> (Bits 8 to 9) to <code>0b10</code> (DSI DPHY Clock Source is PLL_PERIPH0(1X))</li>
<li>Set <strong>DPHY_CLK_DIV_M</strong> (Bits 0 to 3) to 3 (DSI DPHY Clock divide ratio - 1)</li>
</ul>
<p><strong>CCU Base Address</strong>: <code>0x01C2</code> <code>0000</code> <a href="https://github.com/lupyuen/pinephone-nuttx/releases/download/doc/Allwinner_A64_User_Manual_V1.1.pdf">(A64 Page 82)</a></p>
<div class="example-wrap"><pre class="language-text"><code>150MHz (600 / 4)
0x1c20168 = 0x8203 (DMB)
</code></pre></div></li>
<li>
<p>Power on DPHY Tx (Undocumented)</p>
<p><strong>DPHY_TX_CTL_REG</strong>: DPHY Offset <code>0x04</code></p>
<ul>
<li>Set to <code>0x1000</code> <code>0000</code></li>
</ul>
<p><strong>DPHY_TX_TIME0_REG</strong>: DPHY Offset <code>0x10</code></p>
<ul>
<li>Set to <code>0xa06</code> <code>000e</code></li>
</ul>
<p><strong>DPHY_TX_TIME1_REG</strong>: DPHY Offset <code>0x14</code></p>
<ul>
<li>Set to <code>0xa03</code> <code>3207</code></li>
</ul>
<p><strong>DPHY_TX_TIME2_REG</strong>: DPHY Offset <code>0x18</code></p>
<ul>
<li>Set to <code>0x1e</code></li>
</ul>
<p><strong>DPHY_TX_TIME3_REG</strong>: DPHY Offset <code>0x1c</code></p>
<ul>
<li>Set to <code>0x0</code></li>
</ul>
<p><strong>DPHY_TX_TIME4_REG</strong>: DPHY Offset <code>0x20</code></p>
<ul>
<li>Set to <code>0x303</code></li>
</ul>
<p><strong>DPHY Base Address</strong>: <code>0x01ca</code> <code>1000</code></p>
<div class="example-wrap"><pre class="language-text"><code>0x1ca1004 = 0x10000000 (DMB)
0x1ca1010 = 0xa06000e (DMB)
0x1ca1014 = 0xa033207 (DMB)
0x1ca1018 = 0x1e (DMB)
0x1ca101c = 0x0 (DMB)
0x1ca1020 = 0x303 (DMB)
</code></pre></div></li>
<li>
<p>Enable DPHY (Undocumented)</p>
<p><strong>DPHY_GCTL_REG</strong>: DPHY Offset <code>0x00</code> (Enable DPHY)</p>
<ul>
<li>Set to <code>0x31</code></li>
</ul>
<p><strong>DPHY_ANA0_REG</strong>: DPHY Offset <code>0x4c</code> (PWS)</p>
<ul>
<li>Set to <code>0x9f00</code> <code>7f00</code></li>
</ul>
<p><strong>DPHY_ANA1_REG</strong>: DPHY Offset <code>0x50</code> (CSMPS)</p>
<ul>
<li>Set to <code>0x1700</code> <code>0000</code></li>
</ul>
<p><strong>DPHY_ANA4_REG</strong>: DPHY Offset <code>0x5c</code> (CKDV)</p>
<ul>
<li>Set to <code>0x1f0</code> <code>1555</code></li>
</ul>
<p><strong>DPHY_ANA2_REG</strong>: DPHY Offset <code>0x54</code> (ENIB)</p>
<ul>
<li>Set to <code>0x2</code></li>
</ul>
<p>Wait 5 microseconds</p>
<div class="example-wrap"><pre class="language-text"><code>0x1ca1000 = 0x31 (DMB)
0x1ca104c = 0x9f007f00 (DMB)
0x1ca1050 = 0x17000000 (DMB)
0x1ca105c = 0x1f01555 (DMB)
0x1ca1054 = 0x2 (DMB)
udelay 5
</code></pre></div></li>
<li>
<p>Enable LDOR, LDOC, LDOD (Undocumented)</p>
<p><strong>DPHY_ANA3_REG</strong>: DPHY Offset <code>0x58</code> (Enable LDOR, LDOC, LDOD)</p>
<ul>
<li>Set to <code>0x304</code> <code>0000</code></li>
</ul>
<p>Wait 1 microsecond</p>
<p><strong>DPHY_ANA3_REG</strong>: DPHY Offset <code>0x58</code> (Enable VTTC, VTTD)</p>
<ul>
<li>Set bits <code>0xf800</code> <code>0000</code></li>
</ul>
<p>Wait 1 microsecond</p>
<p><strong>DPHY_ANA3_REG</strong>: DPHY Offset <code>0x58</code> (Enable DIV)</p>
<ul>
<li>Set bits <code>0x400</code> <code>0000</code></li>
</ul>
<p>Wait 1 microsecond</p>
<p><strong>DPHY_ANA2_REG</strong>: DPHY Offset <code>0x54</code> (Enable CK_CPU)</p>
<ul>
<li>Set bits <code>0x10</code></li>
</ul>
<p>Wait 1 microsecond</p>
<p><strong>DPHY_ANA1_REG</strong>: DPHY Offset <code>0x50</code> (VTT Mode)</p>
<ul>
<li>Set bits <code>0x8000</code> <code>0000</code></li>
</ul>
<p><strong>DPHY_ANA2_REG</strong>: DPHY Offset <code>0x54</code> (Enable P2S CPU)</p>
<ul>
<li>Set bits <code>0xf00</code> <code>0000</code></li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>0x1ca1058 = 0x3040000 (DMB)
udelay 1
update_bits addr=0x1ca1058, mask=0xf8000000, val=0xf8000000 (DMB)
udelay 1
update_bits addr=0x1ca1058, mask=0x4000000, val=0x4000000 (DMB)
udelay 1
update_bits addr=0x1ca1054, mask=0x10, val=0x10 (DMB)
udelay 1
update_bits addr=0x1ca1050, mask=0x80000000, val=0x80000000 (DMB)
update_bits addr=0x1ca1054, mask=0xf000000, val=0xf000000 (DMB)
</code></pre></div></li>
</ol>
<p>Based on the above steps, we have <strong>implemented in Zig</strong> the PinePhone Driver that enables the Allwinner A64 MIPI Display Physical Layer (DPHY)‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx/blob/main/dphy.zig"><strong>pinephone-nuttx/dphy.zig</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx#testing-zig-backlight-driver-on-pinephone"><strong>Output Log for dphy.zig</strong></a></p>
</li>
</ul>
<p>We have implemented the driver in <strong>Apache NuttX Kernel</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi3#enable-mipi-dsi-and-d-phy"><strong>‚ÄúEnable MIPI DSI and D-PHY‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/dsi-short.png" alt="MIPI DSI Short Packet (Page 201)" /></p>
<p><a href="https://files.pine64.org/doc/datasheet/ox64/BL808_RM_en_1.0(open).pdf"><em>MIPI DSI Short Packet (Page 201)</em></a></p>
<h1 id="appendix-short-packet-for-mipi-dsi"><a class="doc-anchor" href="#appendix-short-packet-for-mipi-dsi">¬ß</a>21 Appendix: Short Packet for MIPI DSI</h1>
<p>According to <a href="https://files.pine64.org/doc/datasheet/ox64/BL808_RM_en_1.0(open).pdf"><strong>BL808 Reference Manual</strong></a> (Page 201, pic above)‚Ä¶</p>
<blockquote>
<p>A <strong>Short Packet</strong> consists of 8-bit data identification (DI), two bytes of commands or data, and 8-bit ECC.</p>
</blockquote>
<blockquote>
<p>The length of a short packet is 4 bytes including ECC.</p>
</blockquote>
<p>Thus a MIPI DSI <strong>Short Packet</strong> (compared with Long Packet)‚Ä¶</p>
<ul>
<li>
<p>Doesn‚Äôt have Packet Payload and Packet Footer (CRC)</p>
</li>
<li>
<p>Instead of Word Count (WC), the Packet Header now has 2 bytes of data</p>
</li>
<li>
<p>DCS Command (Data Type) is‚Ä¶</p>
<p><strong>DCS Short Write Without Parameter (<code>0x05</code>)</strong> for sending 1 byte of data</p>
<p><strong>DCS Short Write With Parameter (<code>0x15</code>)</strong> for sending 2 bytes of data</p>
</li>
</ul>
<p>Everything else is the same.</p>
<p>We have implemented MIPI DSI Short Packets in <strong>Apache NuttX Kernel</strong>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi3#send-mipi-dsi-packet"><strong>‚ÄúSend MIPI DSI Packet‚Äù</strong></a></li>
</ul>
<h1 id="appendix-initialise-lcd-controller"><a class="doc-anchor" href="#appendix-initialise-lcd-controller">¬ß</a>22 Appendix: Initialise LCD Controller</h1>
<p>Earlier we talked about the sequence of steps that our Display Driver needs to follow‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/dsi#appendix-sequence-of-steps-for-pinephone-display-driver"><strong>‚ÄúSequence of Steps for PinePhone Display Driver‚Äù</strong></a></li>
</ul>
<p>Xingbangda has provided an <a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/panel/panel-sitronix-st7703.c#L174-L333"><strong>Initialisation Sequence</strong></a> of (magical) ST7703 Commands that we should send to the LCD Controller at startup.</p>
<p>The commands below are (mostly) documented in the ST7703 Datasheet‚Ä¶</p>
<ul>
<li><a href="https://files.pine64.org/doc/datasheet/pinephone/ST7703_DS_v01_20160128.pdf"><strong>Sitronix ST7703 LCD Controller Datasheet</strong></a></li>
</ul>
<p>The Initialisation Sequence consists of the following <strong>20 DCS Commands</strong> that we should send via <a href="https://lupyuen.github.io/articles/dsi#transmit-packet-over-mipi-dsi"><strong>DCS Short Write</strong></a> or <a href="https://lupyuen.github.io/articles/dsi#transmit-packet-over-mipi-dsi"><strong>DCS Long Write</strong></a>‚Ä¶</p>
<div><table><thead><tr><th style="text-align: center">Byte</th><th style="text-align: left">Purpose</th></tr></thead><tbody>
<tr><td style="text-align: center">#1</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: center"><code>0xB9</code></td><td style="text-align: left"><strong>SETEXTC</strong> (Page 131): <br> Enable USER Command</td></tr>
<tr><td style="text-align: center"><code>0xF1</code></td><td style="text-align: left">Enable User command</td></tr>
<tr><td style="text-align: center"><code>0x12</code></td><td style="text-align: left"><em>(Continued)</em></td></tr>
<tr><td style="text-align: center"><code>0x83</code></td><td style="text-align: left"><em>(Continued)</em></td></tr>
</tbody></table>
</div>
<p>|
| #2
| <code>0xBA</code> | <strong>SETMIPI</strong> (Page 144): <br> Set MIPI related register
| <code>0x33</code> | Virtual Channel = 0 <br> <em>(VC_Main = 0)</em> <br> Number of Lanes = 4 <br> <em>(Lane_Number = 3)</em>
| <code>0x81</code> | LDO = 1.7 V <br> <em>(DSI_LDO_SEL = 4)</em> <br> Terminal Resistance = 90 Ohm <br> <em>(RTERM = 1)</em>
| <code>0x05</code> | MIPI Low High Speed driving ability = x6 <br> <em>(IHSRX = 5)</em>
| <code>0xF9</code> | TXCLK speed in DSI LP mode = fDSICLK / 16 <br> <em>(Tx_clk_sel = 2)</em>
| <code>0x0E</code> | Min HFP number in DSI mode = 14 <br> <em>(HFP_OSC = 14)</em>
| <code>0x0E</code> | Min HBP number in DSI mode = 14 <br> <em>(HBP_OSC = 14)</em>
| <code>0x20</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x44</code> | Undocumented
| <code>0x25</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x91</code> | Undocumented
| <code>0x0a</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x02</code> | Undocumented
| <code>0x4F</code> | Undocumented
| <code>0x11</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x37</code> | Undocumented
|
| #3
| <code>0xB8</code> | <strong>SETPOWER_EXT</strong> (Page 142): <br> Set display related register
| <code>0x25</code> | External power IC or PFM: VSP = FL1002, VSN = FL1002 <br> <em>(PCCS = 2)</em> <br> VCSW1 / VCSW2 Frequency for Pumping VSP / VSN = 1/4 Hsync <br> <em>(ECP_DC_DIV = 5)</em>
| <code>0x22</code> | VCSW1/VCSW2 soft start time = 15 ms <br> <em>(DT = 2)</em> <br> Pumping ratio of VSP / VSN with VCI = x2 <br> <em>(XDK_ECP = 1)</em>
| <code>0x20</code> | PFM operation frequency FoscD = Fosc/1 <br> <em>(PFM_DC_DIV = 0)</em>
| <code>0x03</code> | Enable power IC pumping frequency synchronization = Synchronize with external Hsync <br> <em>(ECP_SYNC_EN = 1)</em> <br> Enable VGH/VGL pumping frequency synchronization = Synchronize with external Hsync <br> <em>(VGX_SYNC_EN = 1)</em>
|
| #4
| <code>0xB3</code> | <strong>SETRGBIF</strong> (Page 134): <br> Control RGB I/F porch timing for internal use
| <code>0x10</code> | Vertical back porch HS number in Blank Frame Period  = Hsync number 16 <br> <em>(VBP_RGB_GEN = 16)</em>
| <code>0x10</code> | Vertical front porch HS number in Blank Frame Period = Hsync number 16 <br> <em>(VFP_RGB_GEN = 16)</em>
| <code>0x05</code> | HBP OSC number in Blank Frame Period = OSC number 5 <br> <em>(DE_BP_RGB_GEN = 5)</em>
| <code>0x05</code> | HFP OSC number in Blank Frame Period = OSC number 5 <br> <em>(DE_FP_RGB_GEN = 5)</em>
| <code>0x03</code> | Undocumented
| <code>0xFF</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0x00</code> | Undocumented
|
| #5
| <code>0xC0</code> | <strong>SETSCR</strong> (Page 147): <br> Set related setting of Source driving
| <code>0x73</code> | Source OP Amp driving period for positive polarity in Normal Mode: Source OP Period = 115<em>4/Fosc <br> <em>(N_POPON = 115)</em>
| <code>0x73</code> | Source OP Amp driving period for negative polarity in Normal Mode: Source OP Period = 115</em>4/Fosc <br> <em>(N_NOPON = 115)</em>
| <code>0x50</code> | Source OP Amp driving period for positive polarity in Idle mode: Source OP Period   = 80<em>4/Fosc <br> <em>(I_POPON = 80)</em>
| <code>0x50</code> | Source OP Amp dirivng period for negative polarity in Idle Mode: Source OP Period   = 80</em>4/Fosc <br> <em>(I_NOPON = 80)</em>
| <code>0x00</code> | <em>(SCR Bits 24-31 = <code>0x00</code>)</em>
| <code>0xC0</code> | <em>(SCR Bits 16-23 = <code>0xC0</code>)</em>
| <code>0x08</code> | Gamma bias current fine tune: Current xIbias   = 4 <br> <em>(SCR Bits 9-13 = 4)</em> <br> <em>(SCR Bits  8-15 = <code>0x08</code>)</em>
| <code>0x70</code> | Source and Gamma bias current core tune: Ibias = 1 <br> <em>(SCR Bits 0-3 = 0)</em> <br> Source bias current fine tune: Current xIbias = 7 <br> <em>(SCR Bits 4-8 = 7)</em> <br> <em>(SCR Bits  0-7  = <code>0x70</code>)</em>
| <code>0x00</code> | Undocumented
|
| #6
| <code>0xBC</code> | <strong>SETVDC</strong> (Page 146): <br> Control NVDDD/VDDD Voltage
| <code>0x4E</code> | NVDDD voltage = -1.8 V <br> <em>(NVDDD_SEL = 4)</em> <br> VDDD voltage = 1.9 V <br> <em>(VDDD_SEL = 6)</em>
|
| #7
| <code>0xCC</code> | <strong>SETPANEL</strong> (Page 154): <br> Set display related register
| <code>0x0B</code> | Enable reverse the source scan direction <br> <em>(SS_PANEL = 1)</em> <br> Normal vertical scan direction <br> <em>(GS_PANEL = 0)</em> <br> Normally black panel <br> <em>(REV_PANEL = 1)</em> <br> S1:S2:S3 = B:G:R <br> <em>(BGR_PANEL = 1)</em>
|
| #8
| <code>0xB4</code> | <strong>SETCYC</strong> (Page 135): <br> Control display inversion type
| <code>0x80</code> | Extra source for Zig-Zag Inversion = S2401 <br> <em>(ZINV_S2401_EN = 1)</em> <br> Row source data dislocates = Even row <br> <em>(ZINV_G_EVEN_EN = 0)</em> <br> Disable Zig-Zag Inversion <br> <em>(ZINV_EN = 0)</em> <br> Enable Zig-Zag1 Inversion <br> <em>(ZINV2_EN = 0)</em> <br> Normal mode inversion type = Column inversion <br> <em>(N_NW = 0)</em>
|
| #9
| <code>0xB2</code> | <strong>SETDISP</strong> (Page 132): <br> Control the display resolution
| <code>0xF0</code> | Gate number of vertical direction = 480 + <br> <em>(240*4)</em> <br> <em>(NL = 240)</em>
| <code>0x12</code> | <em>(RES_V_LSB = 0)</em> <br> Non-display area source output control: Source output = VSSD <br> <em>(BLK_CON = 1)</em> <br> Channel number of source direction = 720RGB <br> <em>(RESO_SEL = 2)</em>
| <code>0xF0</code> | Source voltage during Blanking Time when accessing Sleep-Out / Sleep-In = GND <br> <em>(WHITE_GND_EN = 1)</em> <br> Blank timing control when access sleep out command: Blank Frame Period = 7 Frames <br> <em>(WHITE_FRAME_SEL = 7)</em> <br> Source output refresh control: Refresh Period = 0 Frames <br> <em>(ISC = 0)</em>
|
| #10
| <code>0xE3</code> | <strong>SETEQ</strong> (Page 159): <br> Set EQ related register
| <code>0x00</code> | Temporal spacing between HSYNC and PEQGND = 0<em>4/Fosc <br> <em>(PNOEQ = 0)</em>
| <code>0x00</code> | Temporal spacing between HSYNC and NEQGND = 0</em>4/Fosc <br> <em>(NNOEQ = 0)</em>
| <code>0x0B</code> | Source EQ GND period when Source up to positive voltage   = 11<em>4/Fosc <br> <em>(PEQGND = 11)</em>
| <code>0x0B</code> | Source EQ GND period when Source down to negative voltage = 11</em>4/Fosc <br> <em>(NEQGND = 11)</em>
| <code>0x10</code> | Source EQ VCI period when Source up to positive voltage   = 16<em>4/Fosc <br> <em>(PEQVCI = 16)</em>
| <code>0x10</code> | Source EQ VCI period when Source down to negative voltage = 16</em>4/Fosc <br> <em>(NEQVCI = 16)</em>
| <code>0x00</code> | Temporal period of PEQVCI1 = 0<em>4/Fosc <br> <em>(PEQVCI1 = 0)</em>
| <code>0x00</code> | Temporal period of NEQVCI1 = 0</em>4/Fosc <br> <em>(NEQVCI1 = 0)</em>
| <code>0x00</code> | <em>(Reserved)</em>
| <code>0x00</code> | <em>(Reserved)</em>
| <code>0xFF</code> | <em>(Undocumented)</em>
| <code>0x00</code> | <em>(Reserved)</em>
| <code>0xC0</code> | White pattern to protect GOA glass <br> <em>(ESD_DET_DATA_WHITE = 1)</em> <br> Enable ESD detection function to protect GOA glass <br> <em>(ESD_WHITE_EN = 1)</em>
| <code>0x10</code> | No Need VSYNC <br> <em>(additional frame)</em> after Sleep-In to display sleep-in blanking frame then into Sleep-In State <br> <em>(SLPIN_OPTION = 1)</em> <br> Enable video function detection <br> <em>(VEDIO_NO_CHECK_EN = 0)</em> <br> Disable ESD white pattern scanning voltage pull ground <br> <em>(ESD_WHITE_GND_EN = 0)</em> <br> ESD detection function period = 0 Frames <br> <em>(ESD_DET_TIME_SEL = 0)</em>
|
| #11
| <code>0xC6</code> | <strong>Undocumented</strong>
| <code>0x01</code> | Undocumented
| <code>0x00</code> | Undocumented
| <code>0xFF</code> | Undocumented
| <code>0xFF</code> | Undocumented
| <code>0x00</code> | Undocumented
|
| #12
| <code>0xC1</code> | <strong>SETPOWER</strong> (Page 149): <br> Set related setting of power
| <code>0x74</code> | VGH Voltage Adjustment = 17 V <br> <em>(VBTHS = 7)</em> <br> VGL Voltage Adjustment = -11 V <br> <em>(VBTLS = 4)</em>
| <code>0x00</code> | Enable VGH feedback voltage detection. Output voltage = VBTHS <br> <em>(FBOFF_VGH = 0)</em> <br> Enable VGL feedback voltage detection. Output voltage = VBTLS <br> <em>(FBOFF_VGL = 0)</em>
| <code>0x32</code> | VSPROUT Voltage = <br> <em>(VRH[5:0] x 0.05 + 3.3)</em> x <br> <em>(VREF/4.8)</em> if VREF [4]=0 <br> <em>(VRP = 50)</em>
| <code>0x32</code> | VSNROUT Voltage = <br> <em>(VRH[5:0] x 0.05 + 3.3)</em> x <br> <em>(VREF/5.6)</em> if VREF [4]=1 <br> <em>(VRN = 50)</em>
| <code>0x77</code> | Undocumented
| <code>0xF1</code> | Enable VGL voltage Detect Function = VGL voltage Abnormal <br> <em>(VGL_DET_EN = 1)</em> <br> Enable VGH voltage Detect Function = VGH voltage Abnormal <br> <em>(VGH_DET_EN = 1)</em> <br> Enlarge VGL Voltage at ‚ÄúFBOFF_VGL=1‚Äù = ‚ÄúVGL=-15V‚Äù <br> <em>(VGL_TURBO = 1)</em> <br> Enlarge VGH Voltage at ‚ÄúFBOFF_VGH=1‚Äù = ‚ÄúVGH=20V‚Äù <br> <em>(VGH_TURBO = 1)</em> <br> <em>(APS = 1)</em>
| <code>0xFF</code> | Left side VGH stage 1 pumping frequency  = 1.5 MHz <br> <em>(VGH1_L_DIV = 15)</em> <br> Left side VGL stage 1 pumping frequency  = 1.5 MHz <br> <em>(VGL1_L_DIV = 15)</em>
| <code>0xFF</code> | Right side VGH stage 1 pumping frequency = 1.5 MHz <br> <em>(VGH1_R_DIV = 15)</em> <br> Right side VGL stage 1 pumping frequency = 1.5 MHz <br> <em>(VGL1_R_DIV = 15)</em>
| <code>0xCC</code> | Left side VGH stage 2 pumping frequency  = 2.6 MHz <br> <em>(VGH2_L_DIV = 12)</em> <br> Left side VGL stage 2 pumping frequency  = 2.6 MHz <br> <em>(VGL2_L_DIV = 12)</em>
| <code>0xCC</code> | Right side VGH stage 2 pumping frequency = 2.6 MHz <br> <em>(VGH2_R_DIV = 12)</em> <br> Right side VGL stage 2 pumping frequency = 2.6 MHz <br> <em>(VGL2_R_DIV = 12)</em>
| <code>0x77</code> | Left side VGH stage 3 pumping frequency  = 4.5 MHz <br> <em>(VGH3_L_DIV = 7)</em>  <br> Left side VGL stage 3 pumping frequency  = 4.5 MHz <br> <em>(VGL3_L_DIV = 7)</em>
| <code>0x77</code> | Right side VGH stage 3 pumping frequency = 4.5 MHz <br> <em>(VGH3_R_DIV = 7)</em>  <br> Right side VGL stage 3 pumping frequency = 4.5 MHz <br> <em>(VGL3_R_DIV = 7)</em>
|
| #13
| <code>0xB5</code> | <strong>SETBGP</strong> (Page 136): <br> Internal reference voltage setting
| <code>0x07</code> | VREF Voltage: 4.2 V <br> <em>(VREF_SEL = 7)</em>
| <code>0x07</code> | NVREF Voltage: 4.2 V <br> <em>(NVREF_SEL = 7)</em>
|
| #14
| <code>0xB6</code> | <strong>SETVCOM</strong> (Page 137): <br> Set VCOM Voltage
| <code>0x2C</code> | VCOMDC voltage at ‚ÄúGS_PANEL=0‚Äù = -0.67 V <br> <em>(VCOMDC_F = <code>0x2C</code>)</em>
| <code>0x2C</code> | VCOMDC voltage at ‚ÄúGS_PANEL=1‚Äù = -0.67 V <br> <em>(VCOMDC_B = <code>0x2C</code>)</em>
|
| #15
| <code>0xBF</code> | <strong>Undocumented</strong>
| <code>0x02</code> | Undocumented
| <code>0x11</code> | Undocumented
| <code>0x00</code> | Undocumented
|
| #16
| <code>0xE9</code> | <strong>SETGIP1</strong> (Page 163): <br> Set forward GIP timing
| <code>0x82</code> | SHR0, SHR1, CHR, CHR2 refer to Internal DE <br> <em>(REF_EN = 1)</em> <br> <em>(PANEL_SEL = 2)</em>
| <code>0x10</code> | Starting position of GIP STV group 0 = 4102 HSYNC <br> <em>(SHR0 Bits 8-12 = <code>0x10</code>)</em>
| <code>0x06</code> | <em>(SHR0 Bits 0-7  = <code>0x06</code>)</em>
| <code>0x05</code> | Starting position of GIP STV group 1 = 1442 HSYNC <br> <em>(SHR1 Bits 8-12 = <code>0x05</code>)</em>
| <code>0xA2</code> | <em>(SHR1 Bits 0-7  = <code>0xA2</code>)</em>
| <code>0x0A</code> | Distance of STV rising edge and HYSNC  = 10<em>2  Fosc <br> <em>(SPON  Bits 0-7 = <code>0x0A</code>)</em>
| <code>0xA5</code> | Distance of STV falling edge and HYSNC = 165</em>2 Fosc <br> <em>(SPOFF Bits 0-7 = <code>0xA5</code>)</em>
| <code>0x12</code> | STV0_1 distance with STV0_0 = 1 HSYNC <br> <em>(SHR0_1 = 1)</em> <br> STV0_2 distance with STV0_0 = 2 HSYNC <br> <em>(SHR0_2 = 2)</em>
| <code>0x31</code> | STV0_3 distance with STV0_0 = 3 HSYNC <br> <em>(SHR0_3 = 3)</em> <br> STV1_1 distance with STV1_0 = 1 HSYNC <br> <em>(SHR1_1 = 1)</em>
| <code>0x23</code> | STV1_2 distance with STV1_0 = 2 HSYNC <br> <em>(SHR1_2 = 2)</em> <br> STV1_3 distance with STV1_0 = 3 HSYNC <br> <em>(SHR1_3 = 3)</em>
| <code>0x37</code> | STV signal high pulse width = 3 HSYNC <br> <em>(SHP = 3)</em> <br> Total number of STV signal = 7 <br> <em>(SCP = 7)</em>
| <code>0x83</code> | Starting position of GIP CKV group 0 <br> <em>(CKV0_0)</em> = 131 HSYNC <br> <em>(CHR = <code>0x83</code>)</em>
| <code>0x04</code> | Distance of CKV rising edge and HYSNC  = 4<em>2   Fosc <br> <em>(CON  Bits 0-7 = <code>0x04</code>)</em>
| <code>0xBC</code> | Distance of CKV falling edge and HYSNC = 188</em>2 Fosc <br> <em>(COFF Bits 0-7 = <code>0xBC</code>)</em>
| <code>0x27</code> | CKV signal high pulse width = 2 HSYNC <br> <em>(CHP = 2)</em> <br> Total period cycle of CKV signal = 7 HSYNC <br> <em>(CCP = 7)</em>
| <code>0x38</code> | Extra gate counter at blanking area: Gate number = 56 <br> <em>(USER_GIP_GATE = <code>0x38</code>)</em>
| <code>0x0C</code> | Left side GIP output pad signal = ??? <br> <em>(CGTS_L Bits 16-21 = <code>0x0C</code>)</em>
| <code>0x00</code> | <em>(CGTS_L Bits  8-15 = <code>0x00</code>)</em>
| <code>0x03</code> | <em>(CGTS_L Bits  0-7  = <code>0x03</code>)</em>
| <code>0x00</code> | Normal polarity of Left side GIP output pad signal <br> <em>(CGTS_INV_L Bits 16-21 = <code>0x00</code>)</em>
| <code>0x00</code> | <em>(CGTS_INV_L Bits  8-15 = <code>0x00</code>)</em>
| <code>0x00</code> | <em>(CGTS_INV_L Bits  0-7  = <code>0x00</code>)</em>
| <code>0x0C</code> | Right side GIP output pad signal = ??? <br> <em>(CGTS_R Bits 16-21 = <code>0x0C</code>)</em>
| <code>0x00</code> | <em>(CGTS_R Bits  8-15 = <code>0x00</code>)</em>
| <code>0x03</code> | <em>(CGTS_R Bits  0-7  = <code>0x03</code>)</em>
| <code>0x00</code> | Normal polarity of Right side GIP output pad signal <br> <em>(CGTS_INV_R Bits 16-21 = <code>0x00</code>)</em>
| <code>0x00</code> | <em>(CGTS_INV_R Bits  8-15 = <code>0x00</code>)</em>
| <code>0x00</code> | <em>(CGTS_INV_R Bits  0-7  = <code>0x00</code>)</em>
| <code>0x75</code> | Left side GIP output pad signal = ??? <br> <em>(COS1_L = 7)</em> <br> Left side GIP output pad signal = ??? <br> <em>(COS2_L = 5)</em>
| <code>0x75</code> | Left side GIP output pad signal = ??? <br> <em>(COS3_L = 7)</em> <br> <em>(COS4_L = 5)</em>
| <code>0x31</code> | Left side GIP output pad signal = ??? <br> <em>(COS5_L = 3)</em> <br> <em>(COS6_L = 1)</em>
| <code>0x88</code> | Reserved <em>(Parameter 32)</em>
| <code>0x88</code> | Reserved <em>(Parameter 33)</em>
| <code>0x88</code> | Reserved <em>(Parameter 34)</em>
| <code>0x88</code> | Reserved <em>(Parameter 35)</em>
| <code>0x88</code> | Reserved <em>(Parameter 36)</em>
| <code>0x88</code> | Left side GIP output pad signal  = ??? <br> <em>(COS17_L = 8)</em> <br> Left side GIP output pad signal  = ??? <br> <em>(COS18_L = 8)</em>
| <code>0x13</code> | Left side GIP output pad signal  = ??? <br> <em>(COS19_L = 1)</em> <br> Left side GIP output pad signal  = ??? <br> <em>(COS20_L = 3)</em>
| <code>0x88</code> | Left side GIP output pad signal  = ??? <br> <em>(COS21_L = 8)</em> <br> Left side GIP output pad signal  = ??? <br> <em>(COS22_L = 8)</em>
| <code>0x64</code> | Right side GIP output pad signal = ??? <br> <em>(COS1_R  = 6)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS2_R  = 4)</em>
| <code>0x64</code> | Right side GIP output pad signal = ??? <br> <em>(COS3_R  = 6)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS4_R  = 4)</em>
| <code>0x20</code> | Right side GIP output pad signal = ??? <br> <em>(COS5_R  = 2)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS6_R  = 0)</em>
| <code>0x88</code> | Reserved <em>(Parameter 43)</em>
| <code>0x88</code> | Reserved <em>(Parameter 44)</em>
| <code>0x88</code> | Reserved <em>(Parameter 45)</em>
| <code>0x88</code> | Reserved <em>(Parameter 46)</em>
| <code>0x88</code> | Reserved <em>(Parameter 47)</em>
| <code>0x88</code> | Right side GIP output pad signal = ??? <br> <em>(COS17_R = 8)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS18_R = 8)</em>
| <code>0x02</code> | Right side GIP output pad signal = ??? <br> <em>(COS19_R = 0)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS20_R = 2)</em>
| <code>0x88</code> | Right side GIP output pad signal = ??? <br> <em>(COS21_R = 8)</em> <br> Right side GIP output pad signal = ??? <br> <em>(COS22_R = 8)</em>
| <code>0x00</code> | <em>(TCON_OPT = <code>0x00</code>)</em>
| <code>0x00</code> | <em>(GIP_OPT Bits 16-22 = <code>0x00</code>)</em>
| <code>0x00</code> | <em>(GIP_OPT Bits  8-15 = <code>0x00</code>)</em>
| <code>0x00</code> | <em>(GIP_OPT Bits  0-7  = <code>0x00</code>)</em>
| <code>0x00</code> | Starting position of GIP CKV group 1 <br> <em>(CKV1_0)</em> = 0 HSYNC <br> <em>(CHR2 = <code>0x00</code>)</em>
| <code>0x00</code> | Distance of CKV1 rising edge and HYSNC  = 0<em>2 Fosc <br> <em>(CON2  Bits 0-7 = <code>0x00</code>)</em>
| <code>0x00</code> | Distance of CKV1 falling edge and HYSNC = 0</em>2 Fosc <br> <em>(COFF2 Bits 0-7 = <code>0x00</code>)</em>
| <code>0x00</code> | CKV1 signal high pulse width = 0 HSYNC <br> <em>(CHP2 = 0)</em> <br> Total period cycle of CKV1 signal = 0 HSYNC <br> <em>(CCP2 = 0)</em>
| <code>0x00</code> | <em>(CKS Bits 16-21 = <code>0x00</code>)</em>
| <code>0x00</code> | <em>(CKS Bits  8-15 = <code>0x00</code>)</em>
| <code>0x00</code> | <em>(CKS Bits  0-7  = <code>0x00</code>)</em>
| <code>0x00</code> | <em>(COFF Bits 8-9 = 0)</em> <br> <em>(CON Bits 8-9 = 0)</em> <br> <em>(SPOFF Bits 8-9 = 0)</em> <br> <em>(SPON Bits 8-9 = 0)</em>
| <code>0x00</code> | <em>(COFF2 Bits 8-9 = 0)</em> <br> <em>(CON2 Bits 8-9 = 0)</em>
|
| #17
| <code>0xEA</code> | <strong>SETGIP2</strong> (Page 170): <br> Set backward GIP timing
| <code>0x02</code> | YS2 Signal Mode = INYS1/INYS2 <br> <em>(YS2_SEL = 0)</em> <br> YS2 Signal Mode = INYS1/INYS2 <br> <em>(YS1_SEL = 0)</em> <br> Don‚Äôt reverse YS2 signal <br> <em>(YS2_XOR = 0)</em> <br> Don‚Äôt reverse YS1 signal <br> <em>(YS1_XOR = 0)</em> <br> Enable YS signal function <br> <em>(YS_FLAG_EN = 1)</em> <br> Disable ALL ON function <br> <em>(ALL_ON_EN = 0)</em>
| <code>0x21</code> | <em>(GATE = <code>0x21</code>)</em>
| <code>0x00</code> | <em>(CK_ALL_ON_EN = 0)</em> <br> <em>(STV_ALL_ON_EN = 0)</em> <br> Timing of YS1 and YS2 signal = ??? <br> <em>(CK_ALL_ON_WIDTH1 = 0)</em>
| <code>0x00</code> | Timing of YS1 and YS2 signal = ??? <br> <em>(CK_ALL_ON_WIDTH2 = 0)</em>
| <code>0x00</code> | Timing of YS1 and YS2 signal = ??? <br> <em>(CK_ALL_ON_WIDTH3 = 0)</em>
| <code>0x00</code> | <em>(YS_FLAG_PERIOD = 0)</em>
| <code>0x00</code> | <em>(YS2_SEL_2 = 0)</em> <br> <em>(YS1_SEL_2 = 0)</em> <br> <em>(YS2_XOR_2 = 0)</em> <br> <em>(YS_FLAG_EN_2 = 0)</em> <br> <em>(ALL_ON_EN_2 = 0)</em>
| <code>0x00</code> | Distance of GIP ALL On rising edge and DE = ??? <br> <em>(USER_GIP_GATE1_2 = 0)</em>
| <code>0x00</code> | <em>(CK_ALL_ON_EN_2 = 0)</em> <br> <em>(STV_ALL_ON_EN_2 = 0)</em> <br> <em>(CK_ALL_ON_WIDTH1_2 = 0)</em>
| <code>0x00</code> | <em>(CK_ALL_ON_WIDTH2_2 = 0)</em>
| <code>0x00</code> | <em>(CK_ALL_ON_WIDTH3_2 = 0)</em>
| <code>0x00</code> | <em>(YS_FLAG_PERIOD_2 = 0)</em>
| <code>0x02</code> | <em>(COS1_L_GS = 0)</em> <br> <em>(COS2_L_GS = 2)</em>
| <code>0x46</code> | <em>(COS3_L_GS = 4)</em> <br> <em>(COS4_L_GS = 6)</em>
| <code>0x02</code> | <em>(COS5_L_GS = 0)</em> <br> <em>(COS6_L_GS = 2)</em>
| <code>0x88</code> | Reserved <em>(Parameter 16)</em>
| <code>0x88</code> | Reserved <em>(Parameter 17)</em>
| <code>0x88</code> | Reserved <em>(Parameter 18)</em>
| <code>0x88</code> | Reserved <em>(Parameter 19)</em>
| <code>0x88</code> | Reserved <em>(Parameter 20)</em>
| <code>0x88</code> | <em>(COS17_L_GS = 8)</em> <br> <em>(COS18_L_GS = 8)</em>
| <code>0x64</code> | <em>(COS19_L_GS = 6)</em> <br> <em>(COS20_L_GS = 4)</em>
| <code>0x88</code> | <em>(COS21_L_GS = 8)</em> <br> <em>(COS22_L_GS = 8)</em>
| <code>0x13</code> | <em>(COS1_R_GS = 1)</em> <br> <em>(COS2_R_GS = 3)</em>
| <code>0x57</code> | <em>(COS3_R_GS = 5)</em> <br> <em>(COS4_R_GS = 7)</em>
| <code>0x13</code> | <em>(COS5_R_GS = 1)</em> <br> <em>(COS6_R_GS = 3)</em>
| <code>0x88</code> | Reserved <em>(Parameter 27)</em>
| <code>0x88</code> | Reserved <em>(Parameter 28)</em>
| <code>0x88</code> | Reserved <em>(Parameter 29)</em>
| <code>0x88</code> | Reserved <em>(Parameter 30)</em>
| <code>0x88</code> | Reserved <em>(Parameter 31)</em>
| <code>0x88</code> | <em>(COS17_R_GS = 8)</em> <br> <em>(COS18_R_GS = 8)</em>
| <code>0x75</code> | <em>(COS19_R_GS = 7)</em> <br> <em>(COS20_R_GS = 5)</em>
| <code>0x88</code> | <em>(COS21_R_GS = 8)</em> <br> <em>(COS22_R_GS = 8)</em>
| <code>0x23</code> | GIP output EQ signal: P_EQ = Yes, N_EQ = No <br> <em>(EQOPT = 2)</em> <br>  GIP output EQ signal level: P_EQ = GND, N_EQ = GND <br> <em>(EQ_SEL = 3)</em>
| <code>0x14</code> | Distance of EQ rising edge and HYSNC = 20 Fosc <br> <em>(EQ_DELAY = <code>0x14</code>)</em>
| <code>0x00</code> | Distance of EQ rising edge and HYSNC = 0 HSYNC <br> <em>(EQ_DELAY_HSYNC = 0)</em>
| <code>0x00</code> | <em>(HSYNC_TO_CL1_CNT10 Bits 8-9 = 0)</em>
| <code>0x02</code> | GIP reference HSYNC between external HSYNC = 2 Fosc <br> <em>(HSYNC_TO_CL1_CNT10 Bits 0-7 = 2)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 40)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 41)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 42)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 43)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 44)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 45)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 46)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 47)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 48)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 49)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 50)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 51)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 52)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 53)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 54)</em>
| <code>0x03</code> | Undocumented <em>(Parameter 55)</em>
| <code>0x0A</code> | Undocumented <em>(Parameter 56)</em>
| <code>0xA5</code> | Undocumented <em>(Parameter 57)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 58)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 59)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 60)</em>
| <code>0x00</code> | Undocumented <em>(Parameter 61)</em>
|
| #18
| <code>0xE0</code> | <strong>SETGAMMA</strong> (Page 158): <br> Set the gray scale voltage to adjust the gamma characteristics of the TFT panel
| <code>0x00</code> | <em>(PVR0 = <code>0x00</code>)</em>
| <code>0x09</code> | <em>(PVR1 = <code>0x09</code>)</em>
| <code>0x0D</code> | <em>(PVR2 = <code>0x0D</code>)</em>
| <code>0x23</code> | <em>(PVR3 = <code>0x23</code>)</em>
| <code>0x27</code> | <em>(PVR4 = <code>0x27</code>)</em>
| <code>0x3C</code> | <em>(PVR5 = <code>0x3C</code>)</em>
| <code>0x41</code> | <em>(PPR0 = <code>0x41</code>)</em>
| <code>0x35</code> | <em>(PPR1 = <code>0x35</code>)</em>
| <code>0x07</code> | <em>(PPK0 = <code>0x07</code>)</em>
| <code>0x0D</code> | <em>(PPK1 = <code>0x0D</code>)</em>
| <code>0x0E</code> | <em>(PPK2 = <code>0x0E</code>)</em>
| <code>0x12</code> | <em>(PPK3 = <code>0x12</code>)</em>
| <code>0x13</code> | <em>(PPK4 = <code>0x13</code>)</em>
| <code>0x10</code> | <em>(PPK5 = <code>0x10</code>)</em>
| <code>0x12</code> | <em>(PPK6 = <code>0x12</code>)</em>
| <code>0x12</code> | <em>(PPK7 = <code>0x12</code>)</em>
| <code>0x18</code> | <em>(PPK8 = <code>0x18</code>)</em>
| <code>0x00</code> | <em>(NVR0 = <code>0x00</code>)</em>
| <code>0x09</code> | <em>(NVR1 = <code>0x09</code>)</em>
| <code>0x0D</code> | <em>(NVR2 = <code>0x0D</code>)</em>
| <code>0x23</code> | <em>(NVR3 = <code>0x23</code>)</em>
| <code>0x27</code> | <em>(NVR4 = <code>0x27</code>)</em>
| <code>0x3C</code> | <em>(NVR5 = <code>0x3C</code>)</em>
| <code>0x41</code> | <em>(NPR0 = <code>0x41</code>)</em>
| <code>0x35</code> | <em>(NPR1 = <code>0x35</code>)</em>
| <code>0x07</code> | <em>(NPK0 = <code>0x07</code>)</em>
| <code>0x0D</code> | <em>(NPK1 = <code>0x0D</code>)</em>
| <code>0x0E</code> | <em>(NPK2 = <code>0x0E</code>)</em>
| <code>0x12</code> | <em>(NPK3 = <code>0x12</code>)</em>
| <code>0x13</code> | <em>(NPK4 = <code>0x13</code>)</em>
| <code>0x10</code> | <em>(NPK5 = <code>0x10</code>)</em>
| <code>0x12</code> | <em>(NPK6 = <code>0x12</code>)</em>
| <code>0x12</code> | <em>(NPK7 = <code>0x12</code>)</em>
| <code>0x18</code> | <em>(NPK8 = <code>0x18</code>)</em>
|
| #19<br />
| <code>0x11</code> | <strong>SLPOUT</strong> (Page 89): <br> Turns off sleep mode <br> <em>(MIPI_DCS_EXIT_SLEEP_MODE)</em>
|
| <code>!!!</code> | <strong>Insert Delay Here:</strong> <br> Wait 120 milliseconds
|
| #20
| <code>0x29</code> | <strong>Display On</strong> (Page 97): <br> Recover from DISPLAY OFF mode <br> <em>(MIPI_DCS_SET_DISPLAY_ON)</em></p>
<p>The above commands were originally specified here (partially annotated)‚Ä¶</p>
<ul>
<li><a href="https://github.com/torvalds/linux/blob/master/drivers/gpu/drm/panel/panel-sitronix-st7703.c#L174-L333"><strong>Initialisation Sequence</strong></a></li>
</ul>
<p>We added the last 2 commands (<strong>SLPOUT</strong> and <strong>Display On</strong>) to be consistent with the <strong>p-boot Version</strong>, which was tested OK on NuttX‚Ä¶</p>
<ul>
<li><a href="https://megous.com/git/p-boot/tree/src/display.c#n216"><strong>p-boot Initialisation Sequence</strong></a></li>
</ul>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>