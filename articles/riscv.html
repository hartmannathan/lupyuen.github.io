<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>64-bit RISC-V with Apache NuttX RTOS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="64-bit RISC-V with Apache NuttX RTOS" 
    data-rh="true">
<meta property="og:description" 
    content="Let's boot Apache NuttX RTOS on a 64-bit RISC-V Device (QEMU Emulator) and explore the Boot Code inside NuttX"
    data-rh="true">
<meta name="description" 
    content="Let's boot Apache NuttX RTOS on a 64-bit RISC-V Device (QEMU Emulator) and explore the Boot Code inside NuttX">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/riscv-title.png">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">64-bit RISC-V with Apache NuttX RTOS</h1>
    <nav id="TOC"><ul>
<li><a href="#build-nuttx-for-risc-v">1 Build NuttX for RISC-V</a><ul></ul></li>
<li><a href="#boot-nuttx-on-risc-v">2 Boot NuttX on RISC-V</a><ul></ul></li>
<li><a href="#risc-v-boot-code-in-nuttx">3 RISC-V Boot Code in NuttX</a><ul></ul></li>
<li><a href="#whats-next">4 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>1 Jul 2023</em></p>
<p><img src="https://lupyuen.github.io/images/riscv-title.png" alt="Apache NuttX RTOS on 64-bit QEMU RISC-V Emulator" /></p>
<p><a href="https://nuttx.apache.org/docs/latest/index.html"><strong>Apache NuttX</strong></a> is a <strong>Real-Time Operating System (RTOS)</strong> that runs on many kinds of devices, from 8-bit to 64-bit.</p>
<p>(Think Linux, but a lot smaller and simpler)</p>
<p>In this article we‚Äôll‚Ä¶</p>
<ul>
<li>
<p>Boot NuttX RTOS on a <strong>64-bit RISC-V</strong> device</p>
</li>
<li>
<p>Explore the <strong>Boot Code</strong> that starts NuttX on RISC-V</p>
</li>
<li>
<p>And learn a little <strong>RISC-V Assembly</strong>!</p>
</li>
</ul>
<p><em>But we need RISC-V Hardware?</em></p>
<p>No worries! We‚Äôll run NuttX on the <strong>QEMU Emulator</strong> for 64-bit RISC-V.</p>
<p>(Which will work on Linux, macOS and Windows machines)</p>
<h1 id="build-nuttx-for-risc-v"><a href="#build-nuttx-for-risc-v">1 Build NuttX for RISC-V</a></h1>
<p>TODO</p>
<p>https://github.com/lupyuen/lupyuen.github.io/releases/tag/nuttx-riscv64</p>
<p>Toolchain:
Original:
https://static.dev.sifive.com/dev-tools/riscv64-unknown-elf-gcc-8.3.0-2019.08.0-x86_64-linux-ubuntu14.tar.gz</p>
<p>Updated:
https://github.com/sifive/freedom-tools/releases/tag/v2020.12.0</p>
<p>https://static.dev.sifive.com/dev-tools/freedom-tools/v2020.12/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-apple-darwin.tar.gz</p>
<p>https://static.dev.sifive.com/dev-tools/freedom-tools/v2020.12/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-centos6.tar.gz</p>
<p>https://static.dev.sifive.com/dev-tools/freedom-tools/v2020.12/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14.tar.gz</p>
<p>https://static.dev.sifive.com/dev-tools/freedom-tools/v2020.12/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-w64-mingw32.zip</p>
<p>Add to PATH</p>
<p>sudo apt install genromfs
‚Üí brew install genromfs</p>
<p>mkdir ./nuttx; cd ./nuttx
git clone https://github.com/apache/nuttx.git nuttx
git clone https://github.com/apache/nuttx-apps.git apps
cd nuttx
./tools/configure.sh rv-virt:nsh64
make V=1 -j7</p>
<p>riscv64-unknown-elf-objdump <br />
-t -S ‚Äìdemangle ‚Äìline-numbers ‚Äìwide <br />
nuttx <br />
&gt;nuttx.S <br />
2&gt;&amp;1</p>
<p>make menuconfig
Build Setup &gt; Debug Options
‚îÇ ‚îÇ            [<em>] Enable Debug Features                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ                  *** Debug SYSLOG Output Controls ***                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ            [</em>]   Enable Error Output                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ            [<em>]     Enable Warnings Output                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ            [</em>]       Enable Informational Debug Output</p>
<p>‚îÇ ‚îÇ            [<em>]   Scheduler Debug Features                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ            [</em>]     Scheduler Error Output                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ            [<em>]     Scheduler Warnings Output                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ            [</em>]     Scheduler Informational Output</p>
<p>Build Log:
https://gist.github.com/lupyuen/9d9b89dfd91b27f93459828178b83b77</p>
<p>riscv64-unknown-elf-gcc <br />
-c <br />
-fno-common <br />
-Wall <br />
-Wstrict-prototypes <br />
-Wshadow <br />
-Wundef <br />
-Os <br />
-fno-strict-aliasing <br />
-fomit-frame-pointer <br />
-ffunction-sections <br />
-fdata-sections <br />
-g <br />
-march=rv64imac <br />
-mabi=lp64 <br />
-mcmodel=medany <br />
-isystem nuttx/include <br />
-D__NuttX__ <br />
-DNDEBUG <br />
-D__KERNEL__  <br />
-pipe <br />
-I nuttx/arch/risc-v/src/chip <br />
-I nuttx/arch/risc-v/src/common <br />
-I nuttx/sched    chip/qemu_rv_start.c <br />
-o  qemu_rv_start.o</p>
<p>rv64imac: no floating-point</p>
<p>lp64: Long pointers are 64-bit, no floating-point arguments will be passed in registers.
https://gcc.gnu.org/onlinedocs/gcc-9.1.0/gcc/RISC-V-Options.html</p>
<p>-mcmodel=medany
Generate code for the medium-any code model. The program and its statically defined symbols must be within any single 2 GiB address range. Programs can be statically or dynamically linked.
Sounds like a burger (or fast-food AI model?)</p>
<h1 id="boot-nuttx-on-risc-v"><a href="#boot-nuttx-on-risc-v">2 Boot NuttX on RISC-V</a></h1>
<p>TODO</p>
<p>qemu-system-riscv64 <br />
-semihosting <br />
-M virt,aclint=on <br />
-cpu rv64 <br />
-smp 8 <br />
-bios none <br />
-kernel nuttx <br />
-nographic</p>
<h1 id="risc-v-boot-code-in-nuttx"><a href="#risc-v-boot-code-in-nuttx">3 RISC-V Boot Code in NuttX</a></h1>
<p>TODO</p>
<p>https://github.com/apache/nuttx/blob/master/arch/risc-v/src/qemu-rv/qemu_rv_head.S#L41-L120</p>
<p>qemu_rv_start
https://github.com/apache/nuttx/blob/master/arch/risc-v/src/qemu-rv/qemu_rv_start.c#L94-L151
Calls nx_start</p>
<p>qemu-system-riscv64
https://www.qemu.org/docs/master/system/target-riscv.html</p>
<p>-M virt,aclint=on <br />
‚Äòvirt‚Äô Generic Virtual Platform (virt)
https://www.qemu.org/docs/master/system/riscv/virt.html</p>
<p>ACLINT devices will be emulated instead of SiFive CLINT</p>
<p>/* Load mhartid (cpuid) */
csrr a0, mhartid</p>
<p>csrr: Read Control and Status Register
https://five-embeddev.com/riscv-isa-manual/latest/csr.html</p>
<p>a0: x10
Embedded ABI (EABI) vs Unix ABI (UABI)
https://github.com/riscv-non-isa/riscv-eabi-spec/blob/master/EABI.adoc</p>
<p>mhartid: Hart ID Register, ID of the hardware thread running the code.
https://five-embeddev.com/riscv-isa-manual/latest/machine.html#hart-id-register-mhartid</p>
<p>#ifdef CONFIG_ARCH_RV32
slli t1, a0, 2
#else
slli t1, a0, 3
#endif</p>
<p>works with 32-bit and 64-bit modes!
sounds like ‚Äúsilly‚Äù
but it‚Äôs Logical Shift Left
https://five-embeddev.com/riscv-isa-manual/latest/rv64.html#integer-computational-instructions</p>
<p>/* Disable all interrupts (i.e. timer, external) in mie */
csrw	mie, zero</p>
<p>csrw: Write Control and Status Register
https://five-embeddev.com/riscv-isa-manual/latest/csr.html</p>
<p>mie: Machine Interrupt Enable Register
https://five-embeddev.com/riscv-isa-manual/latest/machine.html#machine-interrupt-registers-mip-and-mie</p>
<p>zero: x0 Register, which is always 0
https://five-embeddev.com/quickref/regs_abi.html</p>
<p>csrw mie, zero
wfi</p>
<p>wfi: Wait for Interrupt
which will never happen because we disabled interrupts
https://five-embeddev.com/riscv-isa-manual/latest/machine.html#wfi</p>
<p>la   t0, __trap_vec
csrw mtvec, t0</p>
<p>csrw: Write Control and Status Register
https://five-embeddev.com/riscv-isa-manual/latest/csr.html</p>
<p>mtvec: Machine Trap-Vector Base-Address Register
The mtvec register is an MXLEN-bit WARL read/write register that holds trap vector configuration, consisting of a vector base address (BASE) and a vector mode (MODE).
https://five-embeddev.com/riscv-isa-manual/latest/machine.html#machine-trap-vector-base-address-register-mtvec</p>
<h1 id="whats-next"><a href="#whats-next">4 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>My Current Project: ‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>My Other Project: ‚ÄúThe RISC-V BL602 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/riscv.md"><strong>lupyuen.github.io/src/riscv.md</strong></a></p>

    
</body>
</html>