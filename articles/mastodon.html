<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>(Experimental) Mastodon Server for Apache NuttX Continuous Integration (macOS Rancher Desktop)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="(Experimental) Mastodon Server for Apache NuttX Continuous Integration (macOS Rancher Desktop)" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/mastodon-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.github.io/articles/mastodon" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">(Experimental) Mastodon Server for Apache NuttX Continuous Integration (macOS Rancher Desktop)</h1>
    <nav id="rustdoc"><ul>
<li><a href="#mastodon-for-nuttx-ci" title="Mastodon for NuttX CI">1 Mastodon for NuttX CI</a><ul></ul></li>
<li><a href="#install-our-mastodon-server" title="Install our Mastodon Server">2 Install our Mastodon Server</a><ul></ul></li>
<li><a href="#test-our-mastodon-server" title="Test our Mastodon Server">3 Test our Mastodon Server</a><ul></ul></li>
<li><a href="#post-nuttx-builds-to-mastodon" title="Post NuttX Builds to Mastodon">4 Post NuttX Builds to Mastodon</a><ul></ul></li>
<li><a href="#todo" title="TODO">5 TODO</a><ul></ul></li>
<li><a href="#whats-next" title="What‚Äôs Next">6 What‚Äôs Next</a><ul></ul></li>
<li><a href="#appendix-query-prometheus-for-failed-builds" title="Appendix: Query Prometheus for Failed Builds">7 Appendix: Query Prometheus for Failed Builds</a><ul></ul></li>
<li><a href="#appendix-post-nuttx-builds-to-mastodon" title="Appendix: Post NuttX Builds to Mastodon">8 Appendix: Post NuttX Builds to Mastodon</a><ul></ul></li>
<li><a href="#appendix-install-our-mastodon-server" title="Appendix: Install our Mastodon Server">9 Appendix: Install our Mastodon Server</a><ul></ul></li>
<li><a href="#appendix-test-our-mastodon-server" title="Appendix: Test our Mastodon Server">10 Appendix: Test our Mastodon Server</a><ul></ul></li>
<li><a href="#appendix-create-our-mastodon-account" title="Appendix: Create our Mastodon Account">11 Appendix: Create our Mastodon Account</a><ul></ul></li>
<li><a href="#appendix-create-our-mastodon-app" title="Appendix: Create our Mastodon App">12 Appendix: Create our Mastodon App</a><ul></ul></li>
<li><a href="#appendix-create-a-mastodon-post" title="Appendix: Create a Mastodon Post">13 Appendix: Create a Mastodon Post</a><ul></ul></li>
<li><a href="#appendix-backup-our-mastodon-server" title="Appendix: Backup our Mastodon Server">14 Appendix: Backup our Mastodon Server</a><ul></ul></li>
<li><a href="#appendix-enable-elasticsearch-for-mastodon" title="Appendix: Enable Elasticsearch for Mastodon">15 Appendix: Enable Elasticsearch for Mastodon</a><ul></ul></li>
<li><a href="#appendix-docker-compose-for-mastodon" title="Appendix: Docker Compose for Mastodon">16 Appendix: Docker Compose for Mastodon</a><ul>
<li><a href="#database-server" title="Database Server">16.1 Database Server</a><ul></ul></li>
<li><a href="#web-server" title="Web Server">16.2 Web Server</a><ul></ul></li>
<li><a href="#redis-server" title="Redis Server">16.3 Redis Server</a><ul></ul></li>
<li><a href="#sidekiq-server" title="Sidekiq Server">16.4 Sidekiq Server</a><ul></ul></li>
<li><a href="#streaming-server" title="Streaming Server">16.5 Streaming Server</a><ul></ul></li>
<li><a href="#elasticsearch-server" title="Elasticsearch Server">16.6 Elasticsearch Server</a><ul></ul></li>
<li><a href="#volumes-and-networks" title="Volumes and Networks">16.7 Volumes and Networks</a><ul></ul></li>
<li><a href="#simplest-server-for-mastodon" title="Simplest Server for Mastodon">16.8 Simplest Server for Mastodon</a><ul></ul></li></ul></li></ul></nav><p>üìù <em>30 Dec 2024</em></p>
<p><img src="https://lupyuen.github.io/images/mastodon-title.jpg" alt="TODO" /></p>
<p>TODO</p>
<p>We‚Äôre out for an <a href="TODO"><strong>overnight hike</strong></a>, city to airport. Our <a href="TODO"><strong>Build Farm for Apache NuttX RTOS</strong></a> runs non-stop all day, all night. Continuously compiling over <a href="TODO"><strong>1,000 NuttX Targets</strong></a>.</p>
<p>Can we be 100% sure that <strong>NuttX is OK?</strong> Without getting spammed by <strong>alert emails</strong> all night? (Sorry we got zero budget for <em>‚Äúpaging duty‚Äù</em> services)</p>
<p>TODO: Pic of mobile</p>
<p>TODO: mastodon-mobile3.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-mobile3.png" alt="TODO" /></p>
<p>TODO: mastodon-mobile4.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-mobile4.png" alt="TODO" /></p>
<p>in this article we talk about Mastodon</p>
<h1 id="mastodon-for-nuttx-ci"><a class="doc-anchor" href="#mastodon-for-nuttx-ci">¬ß</a>1 Mastodon for NuttX CI</h1>
<p>TODO</p>
<p>TODO: mastodon-mobile1.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-mobile1.png" alt="TODO" /></p>
<p>TODO: mastodon-mobile2.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-mobile2.png" alt="TODO" /></p>
<p>TODO: mastodon-mobile3.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-mobile3.png" alt="TODO" /></p>
<p>TODO: mastodon-mobile4.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-mobile4.png" alt="TODO" /></p>
<h1 id="install-our-mastodon-server"><a class="doc-anchor" href="#install-our-mastodon-server">¬ß</a>2 Install our Mastodon Server</h1>
<p>TODO: Straightforwrd, thanks to the excellent Mastodon Docs</p>
<p>TODO: SSL / Hosting Provider</p>
<p>We use port 3001 because 3000 is already used by Grafana</p>
<h1 id="test-our-mastodon-server"><a class="doc-anchor" href="#test-our-mastodon-server">¬ß</a>3 Test our Mastodon Server</h1>
<p>TODO: Working without email</p>
<p>Monitor the logs</p>
<div class="example-wrap"><pre class="language-text"><code>Public Timeline: https://docs.joinmastodon.org/client/public/#timelines
curl https://nuttx-feed.org/api/v1/timelines/public | jq</code></pre></div>
<p>TODO: Federation</p>
<h1 id="post-nuttx-builds-to-mastodon"><a class="doc-anchor" href="#post-nuttx-builds-to-mastodon">¬ß</a>4 Post NuttX Builds to Mastodon</h1>
<p>TODO: Prometheus to Mastodon</p>
<p>TODO: <a href="https://prometheus.io/docs/alerting/latest/alertmanager/">Alertmanager</a></p>
<p>TODO: Suppose I‚Äôm interested in only rv-virt:python. Can I subscribe to the alerts via Mastodon / Fediverse / ActivityPub?</p>
<h1 id="todo"><a class="doc-anchor" href="#todo">¬ß</a>5 TODO</h1>
<p>Need moderation?</p>
<p>discussion only</p>
<p>fediverse</p>
<p>Register on qoto home</p>
<p>NuttX Load: Running Jobs and Cost of GitHub Actions</p>
<p>Alert for long-running jobs</p>
<p>Monitor sync-build-ingest</p>
<p>Mastodon could link Failed Builds / Failed Tests to NuttX Issue?</p>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>6 What‚Äôs Next</h1>
<p>TODO</p>
<p>Many Thanks to the awesome <strong>NuttX Admins</strong> and <strong>NuttX Devs</strong>! And my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a>, for sticking with me all these years.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-sg2000"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Sophgo SG2000‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-ox64"><strong>My Other Project: ‚ÄúNuttX for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-star64"><strong>Older Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>Olderer Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/mastodon.md"><strong>lupyuen.github.io/src/mastodon.md</strong></a></p>
<h1 id="appendix-query-prometheus-for-failed-builds"><a class="doc-anchor" href="#appendix-query-prometheus-for-failed-builds">¬ß</a>7 Appendix: Query Prometheus for Failed Builds</h1>
<p>We‚Äôre fetching the <strong>Failed NuttX Builds</strong> from Prometheus. We browse to Prometheus at <em>http://localhost:9090</em> and enter this <strong>Prometheus Query</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Find all Build Scores &lt; 0.5
## But skip these users...
build_score{
  user != &quot;rewind&quot;,     ## Used for Build Rewind only
  user != &quot;nuttxlinux&quot;, ## Retired (Blocked by GitHub)
  user != &quot;nuttxmacos&quot;  ## Retired (Blocked by GitHub)
} &lt; 0.5</code></pre></div>
<p><img src="https://lupyuen.github.io/images/mastodon-prometheus.png" alt="TODO" /></p>
<p><em>Why 0.5?</em></p>
<p>Build Score is 1.0 for Successful Builds, 0.5 for Warnings, 0.0 for Errors. Thus we search for Build Scores &lt; 0.5.</p>
<p>TODO: Table of Build Scores</p>
<p><em>What‚Äôs returned by Prometheus?</em></p>
<p>Plenty of fields, describing every Failed Build in detail‚Ä¶</p>
<p>TODO: Table of Fields</p>
<p>We can do the same with curl and <strong>HTTP POST</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>$ curl -X POST \
  -F &#39;query=
    build_score{
      user != &quot;rewind&quot;,
      user != &quot;nuttxlinux&quot;,
      user != &quot;nuttxmacos&quot;
    } &lt; 0.5
  &#39; \
  http://localhost:9090/api/v1/query

{&quot;status&quot; : &quot;success&quot;, &quot;data&quot; : {&quot;resultType&quot; : &quot;vector&quot;, &quot;result&quot; : [{&quot;metric&quot;{
  &quot;__name__&quot;  : &quot;build_score&quot;,
  &quot;apps_hash&quot; : &quot;b08c29617bbf1f2c6227f74e23ffdd7706997e0c&quot;,
  &quot;arch&quot;      : &quot;risc-v&quot;,
  &quot;board&quot;     : &quot;rv-virt&quot;,
  &quot;config&quot;    : &quot;citest&quot;,
  &quot;msg&quot;       : &quot;virtio/virtio-mmio.c: In function
    &#39;virtio_mmio_config_virtqueue&#39;: \n virtio/virtio-mmio.c:346:14:
    error: cast from pointer to integer of different size ...</code></pre></div>
<p>In the next section: We‚Äôll replicate this with Rust.</p>
<p><em>How did we get the above Prometheus Query?</em></p>
<p>We copied and pasted from our <a href="TODO"><strong>NuttX Dashboard in Grafana</strong></a>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/mastodon-grafana.png" alt="TODO" /></p>
<h1 id="appendix-post-nuttx-builds-to-mastodon"><a class="doc-anchor" href="#appendix-post-nuttx-builds-to-mastodon">¬ß</a>8 Appendix: Post NuttX Builds to Mastodon</h1>
<p>TODO: <a href="https://github.com/lupyuen/nuttx-prometheus-to-mastodon/blob/main/run.sh">run.sh</a></p>
<div class="example-wrap"><pre class="language-bash"><code>#!/usr/bin/env bash
## Post the Failed Jobs from Prometheus to Mastodon

set -e  ## Exit when any command fails
set -x  ## Echo commands

## Set the Access Token for Mastodon
## https://docs.joinmastodon.org/client/authorized/#token
## export MASTODON_TOKEN=...
set +x  ## Disable Echo
. ../mastodon-token.sh
set -x  ## Echo commands

set +e  ## Ignore errors
for (( ; ; )); do
    ## Post the Failed Jobs from Prometheus to Mastodon
    cargo run

    ## Wait a while
    date ; sleep 900
done</code></pre></div>
<p>TODO: <a href="https://github.com/lupyuen/nuttx-prometheus-to-mastodon/blob/main/src/main.rs">main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="doccomment">//! (1) Fetch the Failed NuttX Builds from Prometheus
//! (2) Post to Mastodon

</span><span class="kw">use </span>std::{
    fs::File,
    io::{BufReader, Write},
    thread::sleep,
    time::Duration,
};
<span class="kw">use </span>clap::Parser;
<span class="kw">use </span>serde_json::{
    json,
    to_string_pretty,
    Value,
};

<span class="comment">// Remembers the Mastodon Posts for All Builds:
// {
//   "rv-virt:citest" : {
//     status_id: "12345",
//     users: ["nuttxpr", "NuttX", "lupyuen"]
//   }
//   "rv-virt:citest64" : ...
// }
</span><span class="kw">const </span>ALL_BUILDS_FILENAME: <span class="kw-2">&amp;</span>str = <span class="string">"/tmp/nuttx-prometheus-to-mastodon.json"</span>;

<span class="doccomment">/// Command-Line Arguments
</span><span class="attr">#[derive(Parser, Debug)]
#[command(version, about, long_about = <span class="prelude-val">None</span>)]
</span><span class="kw">struct </span>Args {
}

<span class="attr">#[tokio::main]
</span><span class="kw">async fn </span>main() -&gt; <span class="prelude-ty">Result</span>&lt;(), Box&lt;<span class="kw">dyn </span>std::error::Error&gt;&gt; {
    <span class="comment">// Init the Logger and Command-Line Args
    </span>env_logger::init();
    <span class="comment">// let args = Args::parse();

    // Fetch the Failed Builds from Prometheus
    </span><span class="kw">let </span>query = <span class="string">r##"
        build_score{
            config!="leds64_zig",
            user!="rewind",
            user!="nuttxlinux",
            user!="nuttxmacos",
            user!="jerpelea"
        } &lt; 0.5
    "##</span>;
    <span class="macro">println!</span>(<span class="string">"query={query}"</span>);
    <span class="kw">let </span>params = [(<span class="string">"query"</span>, query)];
    <span class="kw">let </span>client = reqwest::Client::new();
    <span class="kw">let </span>prometheus = <span class="string">"http://localhost:9090/api/v1/query"</span>;
    <span class="kw">let </span>res = client
        .post(prometheus)
        .form(<span class="kw-2">&amp;</span>params)
        .send()
        .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="macro">println!</span>(<span class="string">"res={res:?}"</span>);
    <span class="kw">if </span>!res.status().is_success() {
        <span class="macro">println!</span>(<span class="string">"*** Prometheus Failed"</span>);
        sleep(Duration::from_secs(<span class="number">1</span>));
    }
    <span class="macro">println!</span>(<span class="string">"Status: {}"</span>, res.status());
    <span class="macro">println!</span>(<span class="string">"Headers:\n{:#?}"</span>, res.headers());
    <span class="kw">let </span>body = res.text().<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="macro">println!</span>(<span class="string">"Body: {body}"</span>);
    <span class="kw">let </span>data: Value = serde_json::from_str(<span class="kw-2">&amp;</span>body).unwrap();
    <span class="kw">let </span>builds = <span class="kw-2">&amp;</span>data[<span class="string">"data"</span>][<span class="string">"result"</span>];
    <span class="macro">println!</span>(<span class="string">"\n\nbuilds={builds:?}"</span>);

    <span class="comment">// Load the Mastodon Posts for All Builds
    </span><span class="kw">let </span><span class="kw-2">mut </span>all_builds = <span class="macro">json!</span>({});
    <span class="kw">if let </span><span class="prelude-val">Ok</span>(file) = File::open(ALL_BUILDS_FILENAME) {
        <span class="kw">let </span>reader = BufReader::new(file);
        all_builds = serde_json::from_reader(reader).unwrap();    
    }

    <span class="comment">// For Each Failed Build...
    </span><span class="kw">for </span>build <span class="kw">in </span>builds.as_array().unwrap() {
        <span class="macro">println!</span>(<span class="string">"\n\nbuild={build:?}"</span>);
        <span class="kw">let </span>metric = <span class="kw-2">&amp;</span>build[<span class="string">"metric"</span>];
        <span class="macro">println!</span>(<span class="string">"\n\nmetric={metric:?}"</span>);
        <span class="kw">let </span>board = metric[<span class="string">"board"</span>].as_str().unwrap();
        <span class="kw">let </span>config = metric[<span class="string">"config"</span>].as_str().unwrap();
        <span class="kw">let </span>user = metric[<span class="string">"user"</span>].as_str().unwrap();
        <span class="kw">let </span>msg = metric[<span class="string">"msg"</span>].as_str().unwrap_or(<span class="string">""</span>);
        <span class="kw">let </span>config_upper = config.to_uppercase();
        <span class="kw">let </span>target = <span class="macro">format!</span>(<span class="string">"{board}:{config}"</span>);
        <span class="macro">println!</span>(<span class="string">"\n\nboard={board}"</span>);
        <span class="macro">println!</span>(<span class="string">"config={config}"</span>);
        <span class="macro">println!</span>(<span class="string">"user={user}"</span>);
        <span class="macro">println!</span>(<span class="string">"msg={msg}"</span>);

        <span class="comment">// Compose the Mastodon Post as...
        // rv-virt : CITEST - Build Failed (NuttX)
        // NuttX Dashboard: ...
        // Build History: ...
        // [Error Message]
        </span><span class="kw">let </span><span class="kw-2">mut </span>status = <span class="macro">format!</span>(
            <span class="string">r##"
{board} : {config_upper} - Build Failed ({user})
NuttX Dashboard: https://nuttx-dashboard.org
Build History: https://nuttx-dashboard.org/d/fe2q876wubc3kc/nuttx-build-history?var-board={board}&amp;var-config={config}

{msg}
            "##</span>);
        status.truncate(<span class="number">512</span>);  <span class="comment">// Mastodon allows only 500 chars
        </span><span class="kw">let </span><span class="kw-2">mut </span>params = Vec::new();
        params.push((<span class="string">"status"</span>, status));

        <span class="comment">// If the Mastodon Post already exists for Board and Config:
        // Reply to the Mastodon Post
        </span><span class="kw">if let </span><span class="prelude-val">Some</span>(status_id) = all_builds[<span class="kw-2">&amp;</span>target][<span class="string">"status_id"</span>].as_str() {
            params.push((<span class="string">"in_reply_to_id"</span>, status_id.to_string()));

            <span class="comment">// If the User already exists for the Board and Config:
            // Skip the Mastodon Post
            </span><span class="kw">if let </span><span class="prelude-val">Some</span>(users) = all_builds[<span class="kw-2">&amp;</span>target][<span class="string">"users"</span>].as_array() {
                <span class="kw">if </span>users.contains(<span class="kw-2">&amp;</span><span class="macro">json!</span>(user)) {
                    <span class="macro">println!</span>(<span class="string">"Skipping {user} @ {target}, already exists"</span>);
                    <span class="kw">continue</span>;
                }
            }
        }

        <span class="comment">// Post to Mastodon
        </span><span class="kw">let </span>token = std::env::var(<span class="string">"MASTODON_TOKEN"</span>)
            .expect(<span class="string">"MASTODON_TOKEN env variable is required"</span>);
        <span class="kw">let </span>client = reqwest::Client::new();
        <span class="kw">let </span>mastodon = <span class="string">"https://nuttx-feed.org/api/v1/statuses"</span>;
        <span class="kw">let </span>res = client
            .post(mastodon)
            .header(<span class="string">"Authorization"</span>, <span class="macro">format!</span>(<span class="string">"Bearer {token}"</span>))
            .form(<span class="kw-2">&amp;</span>params)
            .send()
            .<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="macro">println!</span>(<span class="string">"res={res:?}"</span>);
        <span class="kw">if </span>!res.status().is_success() {
            <span class="macro">println!</span>(<span class="string">"*** Mastodon Failed: {user} @ {target}"</span>);
            sleep(Duration::from_secs(<span class="number">30</span>));
            <span class="kw">continue</span>;
        }
        <span class="macro">println!</span>(<span class="string">"Status: {}"</span>, res.status());
        <span class="macro">println!</span>(<span class="string">"Headers:\n{:#?}"</span>, res.headers());
        <span class="kw">let </span>body = res.text().<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="macro">println!</span>(<span class="string">"Body: {body}"</span>);

        <span class="comment">// Remember the Mastodon Post ID (Status ID)
        </span><span class="kw">let </span>status: Value = serde_json::from_str(<span class="kw-2">&amp;</span>body).unwrap();
        <span class="kw">let </span>status_id = status[<span class="string">"id"</span>].as_str().unwrap();
        <span class="macro">println!</span>(<span class="string">"status_id={status_id}"</span>);
        all_builds[<span class="kw-2">&amp;</span>target][<span class="string">"status_id"</span>] = status_id.into();

        <span class="comment">// Append the User to All Builds
        </span><span class="kw">if let </span><span class="prelude-val">Some</span>(users) = all_builds[<span class="kw-2">&amp;</span>target][<span class="string">"users"</span>].as_array() {
            <span class="kw">if </span>!users.contains(<span class="kw-2">&amp;</span><span class="macro">json!</span>(user)) {
                <span class="kw">let </span><span class="kw-2">mut </span>users = users.clone();
                users.push(<span class="macro">json!</span>(user));
                all_builds[<span class="kw-2">&amp;</span>target][<span class="string">"users"</span>] = <span class="macro">json!</span>(users);
            }
        } <span class="kw">else </span>{
            all_builds[<span class="kw-2">&amp;</span>target][<span class="string">"users"</span>] = <span class="macro">json!</span>([user]);
        }

        <span class="comment">// Save the Mastodon Posts for All Builds
        </span><span class="kw">let </span>json = to_string_pretty(<span class="kw-2">&amp;</span>all_builds).unwrap();
        <span class="kw">let </span><span class="kw-2">mut </span>file = File::create(ALL_BUILDS_FILENAME).unwrap();
        file.write_all(json.as_bytes()).unwrap();
        <span class="macro">println!</span>(<span class="string">"\n\nall_builds=\n{json}"</span>);

        <span class="comment">// Wait a while
        </span>sleep(Duration::from_secs(<span class="number">30</span>));
    }

    <span class="comment">// Return OK
    </span><span class="prelude-val">Ok</span>(())
}</code></pre></div>
<h1 id="appendix-install-our-mastodon-server"><a class="doc-anchor" href="#appendix-install-our-mastodon-server">¬ß</a>9 Appendix: Install our Mastodon Server</h1>
<p>TODO: Rancher Desktop on macOS, probably work on Docker Desktop for Linux / macOS / Windows</p>
<p><a href="TODO">(<strong>docker-compose.yml</strong> is explained here)</a></p>
<ol>
<li>
<p>Download the <strong>Mastodon Source Code</strong> and init the Environment Config</p>
<div class="example-wrap"><pre class="language-bash"><code>git clone \
  https://github.com/mastodon/mastodon \
  --branch v4.3.2
cd mastodon
echo &gt;.env.production</code></pre></div></li>
<li>
<p>Replace <strong>docker-compose.yml</strong> with our slightly-tweaked version</p>
<div class="example-wrap"><pre class="language-bash"><code>rm docker-compose.yml
wget https://raw.githubusercontent.com/lupyuen/mastodon/refs/heads/main/docker-compose.yml</code></pre></div>
<p><a href="https://github.com/lupyuen/mastodon/compare/upstream...lupyuen:mastodon:main">(See the <strong>Minor Tweaks</strong>)</a></p>
</li>
<li>
<p>Purge the <strong>Docker Volumes</strong>, if they already exist (see below)</p>
<div class="example-wrap"><pre class="language-bash"><code>docker volume rm postgres-data
docker volume rm redis-data
docker volume rm es-data
docker volume rm lt-data</code></pre></div></li>
<li>
<p>Edit <a href="https://github.com/lupyuen/mastodon/blob/main/docker-compose.yml#L58-L67"><strong>docker-compose.yml</strong></a>. Set ‚Äú<strong>web &gt; command</strong>‚Äù to ‚Äú<strong>sleep infinity</strong>‚Äù</p>
<div class="example-wrap"><pre class="language-yaml"><code>web:
  command: sleep infinity</code></pre></div>
<p>(Why? Because we‚Äôll start the Web Container to Configure Mastodon)</p>
</li>
<li>
<p>Start the <strong>Docker Containers for Mastodon</strong>: Database, Web, Redis (Memory Cache), Streaming (WebSocket), Sidekiq (Batch Jobs), Elasticsearch (Search Engine)</p>
<div class="example-wrap"><pre class="language-bash"><code>## TODO: Is `sudo` needed?
sudo docker compose up

## Ignore the Redis, Streaming, Elasticsearch errors
## redis-1: Memory overcommit must be enabled
## streaming-1: connect ECONNREFUSED 127.0.0.1:6379
## es-1: max virtual memory areas vm.max_map_count is too low

## Press Ctrl-C to quit the log</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/fb086d6f5fe84044c6c8dae1093b0328#file-gistfile1-txt-L226-L789">(See the <strong>Complete Log</strong>)</a></p>
</li>
<li>
<p><strong>Init the Postgres Database:</strong> We create the Mastodon User</p>
<div class="example-wrap"><pre class="language-bash"><code>## From https://docs.joinmastodon.org/admin/install/#creating-a-user
sudo docker exec \
  -it \
  mastodon-db-1 \
  /bin/bash
exec su-exec \
  postgres \
  psql
CREATE USER mastodon CREATEDB;
\q</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/f4f887ccf4ecfda0d5103b834044bd7b#file-gistfile1-txt-L1-L11">(See the <strong>Complete Log</strong>)</a></p>
</li>
<li>
<p><strong>Generate the Mastodon Config:</strong> We connect to Web Container and prep the Mastodon Config</p>
<div class="example-wrap"><pre class="language-bash"><code>## From https://docs.joinmastodon.org/admin/install/#generating-a-configuration
sudo docker exec \
  -it \
  mastodon-web-1 \
  /bin/bash
RAILS_ENV=production \
  bin/rails \
  mastodon:setup
exit</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/f4f887ccf4ecfda0d5103b834044bd7b#file-gistfile1-txt-L11-L95">(See the <strong>Complete Log</strong>)</a></p>
</li>
<li>
<p>Mastodon has <strong>Many Questions</strong>, we answer them</p>
<p>(Change <em>nuttx-feed.org</em> to Your Domain Name)</p>
<div class="example-wrap"><pre class="language-yaml"><code>Domain name: nuttx-feed.org
Enable single user mode?      No
Using Docker to run Mastodon? Yes

PostgreSQL host:     db
PostgreSQL port:     5432
PostgreSQL database: mastodon_production
PostgreSQL user:     mastodon
Password of user:    [ blank ]

Redis host:     redis
Redis port:     6379
Redis password: [ blank ]

Store uploaded files on the cloud? No
Send e-mails from localhost?       Yes
E-mail address: Mastodon &lt;notifications@nuttx-feed.org&gt;
Send a test e-mail? No

Check for important updates? Yes
Save configuration?          Yes
Save it to .env.production outside Docker:
# Generated with mastodon:setup on 2024-12-08 23:40:38 UTC
[ TODO: Please Save Mastodon Config! ]

Prepare the database now?           Yes
Create an admin user straight away? Yes
Username: [ Your Admin Username ]
E-mail:   [ Your Email Address ]
Login with the password:
[ TODO: Please Save Admin Password! ]</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/f4f887ccf4ecfda0d5103b834044bd7b#file-gistfile1-txt-L11-L95">(See the <strong>Complete Log</strong>)</a></p>
<p>(No Email Server? Read on for our workaround)</p>
</li>
<li>
<p>Copy the Mastodon Config from above to <strong><code>.env.production</code></strong></p>
<div class="example-wrap"><pre class="language-text"><code># Generated with mastodon:setup on 2024-12-08 23:40:38 UTC
LOCAL_DOMAIN=nuttx-feed.org
SINGLE_USER_MODE=false
SECRET_KEY_BASE=...
OTP_SECRET=...
ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=...
ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=...
ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=...
VAPID_PRIVATE_KEY=...
VAPID_PUBLIC_KEY=...
DB_HOST=db
DB_PORT=5432
DB_NAME=mastodon_production
DB_USER=mastodon
DB_PASS=
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=
SMTP_SERVER=localhost
SMTP_PORT=25
SMTP_AUTH_METHOD=none
SMTP_OPENSSL_VERIFY_MODE=none
SMTP_ENABLE_STARTTLS=auto
SMTP_FROM_ADDRESS=Mastodon &lt;notifications@nuttx-feed.org&gt;</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/f4f887ccf4ecfda0d5103b834044bd7b#file-gistfile1-txt-L46-L75">(See the <strong>Complete Log</strong>)</a></p>
</li>
<li>
<p>Edit <a href="https://github.com/lupyuen/mastodon/blob/main/docker-compose.yml#L58-L67"><strong>docker-compose.yml</strong></a>. Set ‚Äú<strong>web &gt; command</strong>‚Äù to this‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code>web:
  command: bundle exec puma -C config/puma.rb</code></pre></div>
<p>(Why? Because we‚Äôre done Configuring Mastodon!)</p>
</li>
<li>
<p>Restart the <strong>Docker Containers</strong> for Mastodon</p>
<div class="example-wrap"><pre class="language-bash"><code>## TODO: Is `sudo` needed?
sudo docker compose down
sudo docker compose up</code></pre></div></li>
<li>
<p>And <strong>Mastodon is Up</strong>!</p>
<div class="example-wrap"><pre class="language-bash"><code>redis-1:     Ready to accept connections tcp
db-1:        database system is ready to accept connections
streaming-1: request completed
web-1:       GET /health</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/420540f9157f2702c14944fc47743742">(See the <strong>Complete Log</strong>)</a></p>
<p>(Sidekiq will have errors, we‚Äôll explain why)</p>
</li>
</ol>
<p><em>Why the tweaks to docker-compose.yml?</em></p>
<p>Somehow Rancher Desktop doesn‚Äôt like to <strong>Mount the Local Filesystem</strong>, failing with a permission error‚Ä¶</p>
<div class="example-wrap"><pre class="language-yaml"><code>## Local Filesystem will fail on macOS Rancher Desktop
services:
  db:
    volumes:
      - ./postgres14:/var/lib/postgresql/data</code></pre></div>
<p>Thus we <strong>Mount the Docker Volumes</strong> instead: <a href="https://github.com/lupyuen/mastodon/compare/upstream...lupyuen:mastodon:main">docker-compose.yml</a></p>
<div class="example-wrap"><pre class="language-yaml"><code>## Docker Volumes will mount OK on macOS Rancher Desktop
services:
  db:
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    volumes:
      - redis-data:/data

  sidekiq:
    volumes:
      - lt-data:/mastodon/public/system

## Declare the Docker Volumes
volumes:
  postgres-data:
  redis-data:
  es-data:
  lt-data:</code></pre></div>
<p>Note that Mastodon will appear at <strong>HTTP Port 3001</strong>, because Port 3000 is already taken by Grafana: <a href="https://github.com/lupyuen/mastodon/compare/upstream...lupyuen:mastodon:main">docker-compose.yml</a></p>
<div class="example-wrap"><pre class="language-yaml"><code>web:
  ports:
    - &#39;127.0.0.1:3001:3000&#39;</code></pre></div><h1 id="appendix-test-our-mastodon-server"><a class="doc-anchor" href="#appendix-test-our-mastodon-server">¬ß</a>10 Appendix: Test our Mastodon Server</h1>
<p>We‚Äôre ready to <strong>Test Mastodon</strong>!</p>
<ol>
<li>
<p>Talk to our <strong>Web Hosting Provider</strong> (or Tunnel Provider).</p>
<p>Channel all Incoming Requests for <em>https://nuttx-feed.org</em></p>
<p>To <em>http://YOUR_DOCKER_MACHINE:3001</em></p>
<p>(<strong>HTTPS Port 443</strong> connects to <strong>HTTP Port 3001</strong> via Reverse Proxy)</p>
<p>(For CloudFlare Tunnel: Set <strong>Security &gt; Settings &gt; High</strong>)</p>
<p>(Change <em>nuttx-feed.org</em> to Your Domain Name)</p>
</li>
<li>
<p>Browse to <em>https://nuttx-feed.org</em>. <strong>Mastodon is Up!</strong></p>
<p><img src="https://lupyuen.github.io/images/mastodon-web5.png" alt="TODO" /></p>
</li>
<li>
<p>Log in with the <strong>Admin User and Password</strong></p>
<p>(From previous section)</p>
</li>
<li>
<p>Browse to <strong>Administration &gt; Settings</strong> and fill in‚Ä¶</p>
<ul>
<li><strong>Branding</strong></li>
<li><strong>About</strong></li>
<li><strong>Registrations &gt; Who Can Sign Up <br> &gt; Approval Required &gt; Require A Reason</strong></li>
</ul>
</li>
<li>
<p>Normally we‚Äôll approve New Accounts at <strong>Moderation &gt; Accounts &gt; Approve</strong></p>
<p>But we don‚Äôt have an <strong>Outgoing Mail Server</strong> to validate the email address!</p>
<p>Let‚Äôs work around this‚Ä¶</p>
</li>
</ol>
<h1 id="appendix-create-our-mastodon-account"><a class="doc-anchor" href="#appendix-create-our-mastodon-account">¬ß</a>11 Appendix: Create our Mastodon Account</h1>
<p>Remember that we‚Äôll pretend to be a Regular User <em>(nuttx_build)</em> and post Mastodon Updates? This is how we create the Mastodon User‚Ä¶</p>
<ol>
<li>
<p>Browse to <em>https://YOUR_DOMAIN_NAME.org</em>. Click <strong>‚ÄúCreate Account‚Äù</strong> and fill in the info</p>
<p>TODO: Pics of Register</p>
</li>
<li>
<p>Normally we‚Äôll approve New Accounts at <strong>Moderation &gt; Accounts &gt; Approve</strong></p>
<p>TODO: Pic of Approve</p>
<p>But we don‚Äôt have an <strong>Outgoing Mail Server</strong> to validate the email address!</p>
</li>
<li>
<p>Instead we do this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Approve and Confirm the Email Address
## From https://docs.joinmastodon.org/admin/tootctl/#accounts-approve
sudo docker exec \
  -it \
  mastodon-web-1 \
  /bin/bash
bin/tootctl accounts \
  approve nuttx_build
bin/tootctl accounts \
  modify nuttx_build \
  --confirm
exit</code></pre></div>
<p>(Change <em>nuttx_build</em> to the new username)</p>
</li>
<li>
<p>FYI for a new <strong>Owner Account</strong>, do this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## From https://docs.joinmastodon.org/admin/setup/#admin-cli
sudo docker exec \
  -it \
  mastodon-web-1 \
  /bin/bash
bin/tootctl accounts \
  create YOUR_OWNER_USERNAME \
  --email YOUR_OWNER_EMAIL \
  --confirmed \
  --role Owner
bin/tootctl accounts \
  approve YOUR_OWNER_NAME
exit</code></pre></div></li>
<li>
<p>That‚Äôs why it‚Äôs OK to ignore the <strong>Sidekiq Errors</strong> for sending email‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>TODO
sidekiq-1    | 2024-12-09T00:04:55.035Z pid=6 tid=2ppy class=ActionMailer::MailDeliveryJob jid=8b52310d0afc7d27b0af3d4b elapsed=0.043 INFO: fail
sidekiq-1    | 2024-12-09T00:04:55.036Z pid=6 tid=2ppy WARN: {&quot;context&quot;:&quot;Job raised exception&quot;,&quot;job&quot;:{&quot;retry&quot;:true,&quot;queue&quot;:&quot;mailers&quot;,&quot;wrapped&quot;:&quot;ActionMailer::MailDeliveryJob&quot;,&quot;args&quot;:[{&quot;job_class&quot;:&quot;ActionMailer::MailDeliveryJob&quot;,&quot;job_id&quot;:&quot;a7c8ac28-83bd-42b8-a4de-554f533a01f8&quot;,&quot;provider_job_id&quot;:null,&quot;queue_name&quot;:&quot;mailers&quot;,&quot;priority&quot;:null,&quot;arguments&quot;:[&quot;UserMailer&quot;,&quot;password_change&quot;,&quot;deliver_now&quot;,{&quot;args&quot;:[{&quot;_aj_globalid&quot;:&quot;gid://mastodon/User/1&quot;}],&quot;_aj_ruby2_keywords&quot;:[&quot;args&quot;]}],&quot;executions&quot;:0,&quot;exception_executions&quot;:{},&quot;locale&quot;:&quot;en&quot;,&quot;timezone&quot;:&quot;UTC&quot;,&quot;enqueued_at&quot;:&quot;2024-12-09T00:00:54.250576360Z&quot;,&quot;scheduled_at&quot;:null}],&quot;class&quot;:&quot;ActiveJob::QueueAdapters::SidekiqAdapter::JobWrapper&quot;,&quot;jid&quot;:&quot;8b52310d0afc7d27b0af3d4b&quot;,&quot;created_at&quot;:1733702454.2507422,&quot;enqueued_at&quot;:1733702694.9922712,&quot;error_message&quot;:&quot;Connection refused - connect(2) for \&quot;localhost\&quot; port 25&quot;,&quot;error_class&quot;:&quot;Errno::ECONNREFUSED&quot;,&quot;failed_at&quot;:1733702454.3886917,&quot;retry_count&quot;:3,&quot;retried_at&quot;:1733702562.7745714}}
sidekiq-1    | 2024-12-09T00:04:55.036Z pid=6 tid=2ppy WARN: Errno::ECONNREFUSED: Connection refused - connect(2) for &quot;localhost&quot; port 25
sidekiq-1    | 2024-12-09T00:04:55.036Z pid=6 tid=2ppy WARN: /usr/local/bundle/gems/net-smtp-0.5.0/lib/net/smtp.rb:663:in `initialize&#39;</code></pre></div></li>
</ol>
<p>TODO: mastodon-register1.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-register1.png" alt="TODO" /></p>
<p>TODO: mastodon-register2.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-register2.png" alt="TODO" /></p>
<p>TODO: mastodon-register3.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-register3.png" alt="TODO" /></p>
<p>TODO: mastodon-register4.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-register4.png" alt="TODO" /></p>
<h1 id="appendix-create-our-mastodon-app"><a class="doc-anchor" href="#appendix-create-our-mastodon-app">¬ß</a>12 Appendix: Create our Mastodon App</h1>
<p>TODO</p>
<ol>
<li>
<p>This is how we create a <strong>Mastodon App</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>## Create Our App: https://docs.joinmastodon.org/client/token/#app
curl -X POST \
  -F &#39;client_name=NuttX Dashboard&#39; \
  -F &#39;redirect_uris=urn:ietf:wg:oauth:2.0:oob&#39; \
  -F &#39;scopes=read write push&#39; \
  -F &#39;website=https://nuttx-dashboard.org&#39; \
  https://YOUR_DOMAIN_NAME.org/api/v1/apps</code></pre></div></li>
<li>
<p>We‚Äôll see the <strong>Client ID</strong> and <strong>Client Secret</strong>. Please save them and keep them secret! (Change <em>nuttx-dashboard</em> to your App Name)</p>
<div class="example-wrap"><pre class="language-json"><code>{&quot;id&quot;:&quot;3&quot;,
&quot;name&quot;:&quot;NuttX Dashboard&quot;,
&quot;website&quot;:&quot;https://nuttx-dashboard.org&quot;,
&quot;scopes&quot;:[&quot;read&quot;,&quot;write&quot;,&quot;push&quot;],
&quot;redirect_uris&quot;:[&quot;urn:ietf:wg:oauth:2.0:oob&quot;],
&quot;vapid_key&quot;:&quot;...&quot;,
&quot;redirect_uri&quot;:&quot;urn:ietf:wg:oauth:2.0:oob&quot;,
&quot;client_id&quot;:&quot;...&quot;,
&quot;client_secret&quot;:&quot;...&quot;,
&quot;client_secret_expires_at&quot;:0}</code></pre></div></li>
<li>
<p>Open a Web Browser. Browse to <em>https://YOUR_DOMAIN_NAME.org</em></p>
<p>Log in as Your New User <em>(nuttx_build)</em></p>
</li>
<li>
<p>Paste this URL into the Same Web Browser</p>
<div class="example-wrap"><pre class="language-text"><code>https://YOUR_DOMAIN_NAME.org/oauth/authorize
  ?client_id=YOUR_CLIENT_ID
  &amp;scope=read+write+push
  &amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob
  &amp;response_type=code</code></pre></div>
<p><a href="https://docs.joinmastodon.org/client/authorized/">(Explained here)</a></p>
</li>
<li>
<p>Copy the <strong>Authorization Code</strong>. (It will expire soon!)</p>
</li>
<li>
<p>We transform the Authorization Code into an <strong>Access Token</strong></p>
<div class="example-wrap"><pre class="language-bash"><code>## From https://docs.joinmastodon.org/client/authorized/#token
export CLIENT_ID=...     ## From Above
export CLIENT_SECRET=... ## From Above
export AUTH_CODE=...     ## From Above
curl -X POST \
  -F &quot;client_id=$CLIENT_ID&quot; \
  -F &quot;client_secret=$CLIENT_SECRET&quot; \
  -F &quot;redirect_uri=urn:ietf:wg:oauth:2.0:oob&quot; \
  -F &quot;grant_type=authorization_code&quot; \
  -F &quot;code=$AUTH_CODE&quot; \
  -F &quot;scope=read write push&quot; \
  https://YOUR_DOMAIN_NAME.org/oauth/token</code></pre></div></li>
<li>
<p>We‚Äôll see the <strong>Access Token</strong>. Please save it and keep secret!</p>
<div class="example-wrap"><pre class="language-json"><code>{&quot;access_token&quot;:&quot;...&quot;,
&quot;token_type&quot;:&quot;Bearer&quot;,
&quot;scope&quot;:&quot;read write push&quot;,
&quot;created_at&quot;:1733966892}</code></pre></div></li>
<li>
<p>To test our Access Token‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>export ACCESS_TOKEN=...  ## From Above
curl \
  -H &quot;Authorization: Bearer $ACCESS_TOKEN&quot; \
  https://YOUR_DOMAIN_NAME.org/api/v1/accounts/verify_credentials</code></pre></div></li>
<li>
<p>We‚Äôll see‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{&quot;username&quot;: &quot;nuttx_build&quot;,
&quot;acct&quot;: &quot;nuttx_build&quot;,
&quot;display_name&quot;: &quot;NuttX Build&quot;,
&quot;locked&quot;: false,
&quot;bot&quot;: false,
&quot;discoverable&quot;: null,
&quot;indexable&quot;: false,
...</code></pre></div>
<p>Yep looks hunky dory!</p>
</li>
</ol>
<p>TODO: mastodon-register5.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-register5.png" alt="TODO" /></p>
<p>TODO: mastodon-register6.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-register6.png" alt="TODO" /></p>
<h1 id="appendix-create-a-mastodon-post"><a class="doc-anchor" href="#appendix-create-a-mastodon-post">¬ß</a>13 Appendix: Create a Mastodon Post</h1>
<p>Our Regular Mastondon User is up! Let‚Äôs post something as the user‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Create Status: https://docs.joinmastodon.org/methods/statuses/#create
export ACCESS_TOKEN=...  ## From Above
curl -X POST \
	-H &quot;Authorization: Bearer $ACCESS_TOKEN&quot; \
	-F &quot;status=Posting a status from curl&quot; \
	https://YOUR_DOMAIN_NAME.org/api/v1/statuses</code></pre></div>
<p>And our <strong>Mastodon Post</strong> appears!</p>
<p><img src="https://lupyuen.github.io/images/mastodon-web4.png" alt="TODO" /></p>
<p><strong>ActivityPub</strong> is the Main API for Mastodon and Fediverse. Let‚Äôs make sure that it works on our server‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Install `jq` for Browsing JSON
$ brew install jq      ## For macOS
$ sudo apt install jq  ## For Ubuntu

## Fetch the TODO Activity Feed for nuttx_build at nuttx-feed.org
$ curl \
  -H &#39;Accept: application/activity+json&#39; \
  https://nuttx-feed.org/@nuttx_build \
  | jq

{ ... TODO ... }

## Fetch the above Activity (Post)
$ curl -H \
  &#39;Accept: application/activity+json&#39; \
  https://nuttx-feed.org/@nuttx_build/TODO \
  | jq

{ ... TODO ... }

## Fetch the User nuttx_build at nuttx-feed.org
$ curl \
  https://nuttx-feed.org/.well-known/webfinger\?resource\=acct:nuttx_build@nuttx-feed.org \
  | jq

{ ... &quot;&quot;acct:nuttx_build@nuttx-feed.org&quot; ... }</code></pre></div>
<p><strong>WebFinger</strong> is particularly important, it locates Users within the Fediverse. It should always work!</p>
<p>TODO</p>
<div class="example-wrap"><pre class="language-text"><code>TODO
https://github.com/h3poteto/megalodon-rs

Post With Status: https://github.com/h3poteto/megalodon-rs/blob/master/examples/mastodon_post_with_schedule.rs</code></pre></div>
<p>TODO: mastodon-register7.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-register7.png" alt="TODO" /></p>
<p>TODO: mastodon-log.png</p>
<p><img src="https://lupyuen.github.io/images/mastodon-log.png" alt="TODO" /></p>
<div class="example-wrap"><pre class="language-text"><code>Docker Logs:
https://gist.github.com/lupyuen/fb086d6f5fe84044c6c8dae1093b0328
https://gist.github.com/lupyuen/f4f887ccf4ecfda0d5103b834044bd7b
https://gist.github.com/lupyuen/edbf045433189bebd4ad843608772ce8
https://gist.github.com/lupyuen/420540f9157f2702c14944fc47743742
https://gist.github.com/lupyuen/89eb8fc76ac9342209bb9c0553298d4c
https://gist.github.com/lupyuen/21ad4e38fa00796d132e63d41e4a339f</code></pre></div><h1 id="appendix-backup-our-mastodon-server"><a class="doc-anchor" href="#appendix-backup-our-mastodon-server">¬ß</a>14 Appendix: Backup our Mastodon Server</h1>
<p>TODO</p>
<div class="example-wrap"><pre class="language-bash"><code>## From https://docs.joinmastodon.org/admin/backups/
## Backup Postgres Database (and check for sensible data)
sudo docker exec \
  -it \
  mastodon-db-1 \
  /bin/bash -c \
  &quot;exec su-exec postgres pg_dumpall&quot; \
  &gt;mastodon.sql
head -50 mastodon.sql

## Backup Redis (and check for sensible data)
sudo docker cp \
  mastodon-redis-1:/data/dump.rdb \
  .
strings dump.rdb \
  | tail -50

## Backup User-Uploaded Files
tar cvf \
  mastodon-public-system.tar \
  mastodon/public/system</code></pre></div>
<p>TODO: Is it safe to run Mastodon as Docker? Docker Isolation vs VM</p>
<p>Might be a little different for macOS Rancher Desktop</p>
<h1 id="appendix-enable-elasticsearch-for-mastodon"><a class="doc-anchor" href="#appendix-enable-elasticsearch-for-mastodon">¬ß</a>15 Appendix: Enable Elasticsearch for Mastodon</h1>
<p>Enabling <strong>Elasticsearch</strong> for macOS Rancher Desktop is a little tricky. That‚Äôs why we saved it for last.</p>
<ol>
<li>
<p>In Mastodon Web: Head over to <strong>Administration &gt; Dashboard</strong>. It should say‚Ä¶</p>
<p><em>‚ÄúCould not connect to Elasticsearch. Please check that it is running, or disable full-text search‚Äù</em></p>
</li>
<li>
<p>To Enable Elasticsearch: Edit <strong><code>.env.production</code></strong> and add these lines‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>ES_ENABLED=true
ES_HOST=es
ES_PORT=9200</code></pre></div></li>
<li>
<p>Edit <a href="TODO"><strong>docker-compose.yml</strong></a>.</p>
<p>Uncomment the Section for <strong>‚Äú<code>es</code>‚Äù</strong></p>
<p>Map the Docker Volume <strong>es-data</strong> for Elasticsearch</p>
<p>Web Container should depend on <strong>‚Äú<code>es</code>‚Äù</strong></p>
<div class="example-wrap"><pre class="language-yaml"><code>  es:
    volumes:
      - es-data:/usr/share/elasticsearch/data
  web:
    depends_on:
      - db
      - redis
      - es</code></pre></div></li>
<li>
<p>Restart the Docker Containers</p>
<div class="example-wrap"><pre class="language-bash"><code>sudo docker compose down
sudo docker compose up</code></pre></div></li>
<li>
<p>We‚Äôll see‚Ä¶</p>
<p><em>‚Äúes-1: bootstrap check failure: max virtual memory areas vm.max_map_count 65530 is too low, increase to at least 262144‚Äù</em></p>
</li>
<li>
<p>Here comes the tricky part: <strong>max_map_count</strong> is configured here!</p>
<div class="example-wrap"><pre class="language-text"><code>~/Library/Application\ Support/rancher-desktop/lima/_config/override.yaml</code></pre></div>
<p><a href="https://docs.rancherdesktop.io/how-to-guides/increasing-open-file-limit/"><strong>Follow the Instructions</strong></a> and set‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>sysctl -w vm.max_map_count=262144</code></pre></div></li>
<li>
<p>Restart Docker Desktop</p>
</li>
<li>
<p>Verify that <strong>max_map_count</strong> has increased</p>
<div class="example-wrap"><pre class="language-bash"><code>## Print the Max Virtual Memory Areas
$ sudo docker exec \
  -it \
  mastodon-es-1 \
  /bin/bash -c \
  &quot;sysctl vm.max_map_count&quot;

vm.max_map_count = 262144</code></pre></div></li>
<li>
<p>Head back to Mastodon Web. Click <strong>Administration &gt; Dashboard</strong>. We should see‚Ä¶</p>
<p><em>‚ÄúElasticsearch index mappings are outdated‚Äù</em></p>
</li>
<li>
<p>Finally we <strong>Reindex Elasticsearch</strong></p>
<div class="example-wrap"><pre class="language-bash"><code>sudo docker exec \
  -it \
  mastodon-web-1 \
  /bin/bash
bin/tootctl search \
  deploy --only=instances \
  accounts tags statuses public_statuses
exit</code></pre></div></li>
<li>
<p>At <strong>Administration &gt; Dashboard</strong>: Mastodon complains no more!</p>
</li>
</ol>
<h1 id="appendix-docker-compose-for-mastodon"><a class="doc-anchor" href="#appendix-docker-compose-for-mastodon">¬ß</a>16 Appendix: Docker Compose for Mastodon</h1>
<p><em>What‚Äôs this Docker Compose? Why use it for Mastodon?</em></p>
<p>TODO: Minor Tweaks</p>
<p><a href="https://github.com/lupyuen/mastodon/compare/upstream...lupyuen:mastodon:main">(See the <strong>Minor Tweaks</strong>)</a></p>
<h2 id="database-server"><a class="doc-anchor" href="#database-server">¬ß</a>16.1 Database Server</h2>
<p><a href="TODO"><strong>PostgreSQL</strong></a> is our Database Server for Mastodon: <a href="https://github.com/lupyuen/mastodon/blob/main/docker-compose.yml">docker-compose.yml</a></p>
<div class="example-wrap"><pre class="language-yaml"><code>services:
  db:
    restart: always
    image: postgres:14-alpine
    shm_size: 256mb

    ## Map the Docker Volume &quot;postgres-data&quot;
    ## because macOS Rancher Desktop won&#39;t work correctly with a Local Filesystem
    volumes:
      -  postgres-data:/var/lib/postgresql/data
    
    ## Allow auto-login by all connections from localhost
    environment:
      - &#39;POSTGRES_HOST_AUTH_METHOD=trust&#39;

    ## Database Server is not exposed outside Docker
    networks:
      - internal_network
    healthcheck:
      test: [&#39;CMD&#39;, &#39;pg_isready&#39;, &#39;-U&#39;, &#39;postgres&#39;]</code></pre></div>
<p>Note the last line for <em>POSTGRES_HOST_AUTH_METHOD</em>. It says that our Database Server will allow auto-login by <strong>all connections from localhost</strong>. Even without PostgreSQL Password!</p>
<p>This is probably OK for us, since our Database Server runs in its own Docker Container.</p>
<p>We map the <strong>Docker Volume</strong> <em>postgres-data</em>, because macOS Rancher Desktop won‚Äôt work correctly with a Local Filesystem like <em>./postgres14</em>.</p>
<h2 id="web-server"><a class="doc-anchor" href="#web-server">¬ß</a>16.2 Web Server</h2>
<p>Powered by Ruby-on-Rails, <strong>Puma</strong> is our Web Server: <a href="https://github.com/lupyuen/mastodon/blob/main/docker-compose.yml">docker-compose.yml</a></p>
<div class="example-wrap"><pre class="language-yaml"><code>  web:
    ## You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes
    ## build: .
    image: ghcr.io/mastodon/mastodon:v4.3.2
    restart: always

    ## Read the Mastondon Config from Docker Host
    env_file: .env.production

    ## Start the Puma Web Server
    command: bundle exec puma -C config/puma.rb
    ## When Configuring Mastodon: Change to...
    ## command: sleep infinity

    ## HTTP Port 3000 should always return OK
    healthcheck:
      # prettier-ignore
      test: [&#39;CMD-SHELL&#39;,&quot;curl -s --noproxy localhost localhost:3000/health | grep -q &#39;OK&#39; || exit 1&quot;]

    ## Mastodon will appear outside Docker at HTTP Port 3001
    ## because Port 3000 is already taken by Grafana
    ports:
      - &#39;127.0.0.1:3001:3000&#39;
    networks:
      - external_network
      - internal_network
    depends_on:
      - db
      - redis
      - es
    volumes:
      - ./public/system:/mastodon/public/system</code></pre></div>
<p>Note that Mastodon will appear at <strong>HTTP Port 3001</strong>, because Port 3000 is already taken by Grafana: <a href="https://github.com/lupyuen/mastodon/compare/upstream...lupyuen:mastodon:main">docker-compose.yml</a></p>
<h2 id="redis-server"><a class="doc-anchor" href="#redis-server">¬ß</a>16.3 Redis Server</h2>
<p>Web Server fetching data directly from Database Server will be awfully slow. That‚Äôs why we use Redis as an <strong>In-Memory Caching Database</strong>: <a href="https://github.com/lupyuen/mastodon/blob/main/docker-compose.yml">docker-compose.yml</a></p>
<div class="example-wrap"><pre class="language-yaml"><code>  redis:
    restart: always
    image: redis:7-alpine

    ## Map the Docker Volume &quot;redis-data&quot;
    ## because macOS Rancher Desktop won&#39;t work correctly with a Local Filesystem
    volumes:
      - redis-data:/data

    ## Redis Server is not exposed outside Docker
    networks:
      - internal_network
    healthcheck:
      test: [&#39;CMD&#39;, &#39;redis-cli&#39;, &#39;ping&#39;]</code></pre></div><h2 id="sidekiq-server"><a class="doc-anchor" href="#sidekiq-server">¬ß</a>16.4 Sidekiq Server</h2>
<p>Remember that Emails that Mastodon will send upon User Registration? Mastodon does this with <strong>Sidekiq</strong> for running Background Batch Jobs, so it won‚Äôt hold up the Web Server: <a href="https://github.com/lupyuen/mastodon/blob/main/docker-compose.yml">docker-compose.yml</a></p>
<div class="example-wrap"><pre class="language-yaml"><code>  sidekiq:
    build: .
    image: ghcr.io/mastodon/mastodon:v4.3.2
    restart: always

    ## Read the Mastondon Config from Docker Host
    env_file: .env.production

    ## Start the Sidekiq Batch Job Server
    command: bundle exec sidekiq
    depends_on:
      - db
      - redis
    volumes:
      - ./public/system:/mastodon/public/system

    ## Sidekiq Server is exposed outside Docker
    ## for Outgoing Connections, to deliver emails
    networks:
      - external_network
      - internal_network
    healthcheck:
      test: [&#39;CMD-SHELL&#39;, &quot;ps aux | grep &#39;[s]idekiq\ 6&#39; || false&quot;]</code></pre></div><h2 id="streaming-server"><a class="doc-anchor" href="#streaming-server">¬ß</a>16.5 Streaming Server</h2>
<p><strong>Optional:</strong> Mastodon (and Fediverse) uses <a href="TODO"><strong>ActivityPub</strong></a> for exchanging lots of info about Users and Posts. Our Web Server supports the <strong>HTTP Rest API</strong>, but there‚Äôs a more efficient way: <strong>WebSocket API</strong>.</p>
<p>WebSocket is <strong>totally optional</strong>, Mastodon works fine without it, probably a little less efficient: <a href="https://github.com/lupyuen/mastodon/blob/main/docker-compose.yml">docker-compose.yml</a></p>
<div class="example-wrap"><pre class="language-yaml"><code>  streaming:
    ## You can uncomment the following lines if you want to not use the prebuilt image, for example if you have local code changes
    ## build:
    ##   dockerfile: ./streaming/Dockerfile
    ##   context: .
    image: ghcr.io/mastodon/mastodon-streaming:v4.3.2
    restart: always

    ## Read the Mastondon Config from Docker Host
    env_file: .env.production

    ## Start the Streaming Server (Node.js!)
    command: node ./streaming/index.js
    depends_on:
      - db
      - redis

    ## WebSocket will listen on HTTP Port 4000
    ## for Incoming Connections (totally optional!)
    ports:
      - &#39;127.0.0.1:4000:4000&#39;
    networks:
      - external_network
      - internal_network
    healthcheck:
      # prettier-ignore
      test: [&#39;CMD-SHELL&#39;, &quot;curl -s --noproxy localhost localhost:4000/api/v1/streaming/health | grep -q &#39;OK&#39; || exit 1&quot;]</code></pre></div><h2 id="elasticsearch-server"><a class="doc-anchor" href="#elasticsearch-server">¬ß</a>16.6 Elasticsearch Server</h2>
<p><strong>Optional:</strong> Elasticsearch is for <strong>Full-Text Search</strong>. Also totally optional, unless we require Full-Text Search for Users and Posts: <a href="https://github.com/lupyuen/mastodon/blob/main/docker-compose.yml">docker-compose.yml</a></p>
<div class="example-wrap"><pre class="language-yaml"><code>  es:
    restart: always
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4
    environment:
      - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true&quot;
      - &quot;xpack.license.self_generated.type=basic&quot;
      - &quot;xpack.security.enabled=false&quot;
      - &quot;xpack.watcher.enabled=false&quot;
      - &quot;xpack.graph.enabled=false&quot;
      - &quot;xpack.ml.enabled=false&quot;
      - &quot;bootstrap.memory_lock=true&quot;
      - &quot;cluster.name=es-mastodon&quot;
      - &quot;discovery.type=single-node&quot;
      - &quot;thread_pool.write.queue_size=1000&quot;

    ## Elasticsearch is exposed externally at HTTP Port 9200. (Why?)
    ports:
      - &#39;127.0.0.1:9200:9200&#39;
    networks:
       - external_network
       - internal_network
    healthcheck:
       test: [&quot;CMD-SHELL&quot;, &quot;curl --silent --fail localhost:9200/_cluster/health || exit 1&quot;]

    ## Map the Docker Volume &quot;es-data&quot;
    ## because macOS Rancher Desktop won&#39;t work correctly with a Local Filesystem
    volumes:
       - es-data:/usr/share/elasticsearch/data
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536</code></pre></div><h2 id="volumes-and-networks"><a class="doc-anchor" href="#volumes-and-networks">¬ß</a>16.7 Volumes and Networks</h2>
<p>Finally we declare the <strong>Volumes and Networks</strong> used by our Docker Containers: <a href="https://github.com/lupyuen/mastodon/blob/main/docker-compose.yml">docker-compose.yml</a></p>
<div class="example-wrap"><pre class="language-yaml"><code>volumes:
  postgres-data:
  redis-data:
  es-data:
  lt-data:

networks:
  external_network:
  internal_network:
    internal: true</code></pre></div><h2 id="simplest-server-for-mastodon"><a class="doc-anchor" href="#simplest-server-for-mastodon">¬ß</a>16.8 Simplest Server for Mastodon</h2>
<p><em>Phew that looks might complicated!</em></p>
<p>There‚Äôs a simpler way</p>
<p>TODO: Not recommended for internet hosting!</p>
<div class="example-wrap"><pre class="language-bash"><code>git clone https://github.com/mastodon/mastodon --branch v4.3.2
cd mastodon
sudo docker compose -f .devcontainer/compose.yaml up -d
sudo docker compose -f .devcontainer/compose.yaml exec app bin/setup
sudo docker compose -f .devcontainer/compose.yaml exec app bin/dev

## Browse to Mastodon Web at http://localhost:3000

## TODO: Default Admin ID

## From https://docs.joinmastodon.org/admin/setup/#admin-cli
## And https://docs.joinmastodon.org/admin/tootctl/#accounts-approve
sudo docker exec \
  -it \
  devcontainer-app-1 \
  /bin/bash
bin/tootctl accounts create \
  YOUR_OWNER_USERNAME \
  --email YOUR_OWNER_EMAIL \
  --confirmed \
  --role Owner
bin/tootctl accounts \
  approve YOUR_OWNER_USERNAME
exit

## Reindex Elasticsearch
sudo docker exec \
  -it \
  devcontainer-app-1 \
  /bin/bash
bin/tootctl search \
  deploy --only=tags
exit</code></pre></div>
<p>Optional:</p>
<p>.devcontainer/compose.yaml:</p>
<div class="example-wrap"><pre class="language-yaml"><code>    ports:
      - &#39;127.0.0.1:3001:3000&#39;</code></pre></div>
<p>.env.development:</p>
<div class="example-wrap"><pre class="language-bash"><code>LOCAL_DOMAIN=nuttx-feed.org</code></pre></div>
    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>