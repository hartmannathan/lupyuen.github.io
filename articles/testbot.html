<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Test Bot for Pull Requests ... Tested on Real Hardware (Apache NuttX RTOS / Oz64 SG2000 RISC-V SBC)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Test Bot for Pull Requests ... Tested on Real Hardware (Apache NuttX RTOS)" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/testbot-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.org/articles/testbot.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Test Bot for Pull Requests ... Tested on Real Hardware (Apache NuttX RTOS / Oz64 SG2000 RISC-V SBC)</h1>
    <nav id="rustdoc"><ul>
<li><a href="#connect-our-oz64-sbc" title="Connect our Oz64 SBC">1 Connect our Oz64 SBC</a><ul></ul></li>
<li><a href="#control-our-oz64-sbc" title="Control our Oz64 SBC">2 Control our Oz64 SBC</a><ul></ul></li>
<li><a href="#expect-script" title="Expect Script">3 Expect Script</a><ul></ul></li>
<li><a href="#build-and-test-script" title="Build and Test Script">4 Build and Test Script</a><ul></ul></li>
<li><a href="#test-bot-for-pull-requests" title="Test Bot for Pull Requests">5 Test Bot for Pull Requests</a><ul></ul></li>
<li><a href="#power-up-our-oz64-sbc" title="Power Up our Oz64 SBC">6 Power Up our Oz64 SBC</a><ul></ul></li>
<li><a href="#security-implications" title="Security Implications">7 Security Implications</a><ul></ul></li>
<li><a href="#todo" title="TODO">8 TODO</a><ul></ul></li>
<li><a href="#whats-next" title="What‚Äôs Next">9 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>28 Feb 2025</em></p>
<p><img src="https://lupyuen.org/images/testbot-title.jpg" alt="Test Bot for Pull Requests ‚Ä¶ Tested on Real Hardware (Apache NuttX RTOS / Oz64 SG2000 RISC-V SBC)" /></p>
<p>We‚Äôre <a href="https://lists.apache.org/thread/mn4l1tmr6fj46o2y9vvrmfcrgyo48s5d"><strong>Making Things Better</strong></a> (and making better things) with <a href="TODO"><strong>Apache NuttX RTOS</strong></a>.</p>
<p>Our new <strong>Test Bot for Pull Requests</strong> will allow a <a href="https://github.com/apache/nuttx/pull/15756#issuecomment-2641277894"><strong>Pull Request Comment</strong></a> to trigger a <strong>NuttX Build + Test</strong> on Real Hardware. For example, this PR Comment‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>@nuttxpr test oz64:nsh</code></pre></div>
<p>Will trigger our PR Test Bot to download the PR Code and test it on <a href="TODO"><strong>Oz64 SG2000 RISC-V SBC</strong></a>. (Pic above)</p>
<p>Super helpful for <strong>Testing Pull Requests</strong> before Merging. But might have <a href="https://github.com/apache/nuttx/issues/15731#issuecomment-2628647886"><strong>Security Implications</strong></a>. (We‚Äôll come back to this)</p>
<p><img src="https://lupyuen.org/images/rewind-bot3.jpg" alt="NuttX Bot for Building and Testing Pull Requests" /></p>
<p><em>(Thanks to PINE64 for sponsoring the Oz64 SBC)</em></p>
<p>TODO: Pic of Test Controller + Oz64</p>
<h1 id="connect-our-oz64-sbc"><a class="doc-anchor" href="#connect-our-oz64-sbc">¬ß</a>1 Connect our Oz64 SBC</h1>
<p>Oz64 won‚Äôt boot over USB or Serial. We‚Äôll connect these to control Oz64 (pic above)</p>
<ul>
<li>
<p><strong>Wired Ethernet</strong>: For booting NuttX over TFTP</p>
</li>
<li>
<p><strong>UART0 Port</strong>: For receiving NuttX Shell Commands (Pins TODO)</p>
</li>
<li>
<p>Which connects to our <strong>Test Controller</strong> (Linux SBC) via a USB Serial Dongle</p>
</li>
<li>
<p>Test Controller is also our <strong>TFTP Server</strong> for booting NuttX on Oz64</p>
<p><a href="https://nuttx.apache.org/docs/latest/quickstart/running.html">(What about <strong>Simpler Boards</strong>: STM32 and nRF52? Use <strong>OpenOCD + ST-Link</strong>)</a></p>
</li>
</ul>
<p><em>What commands are tested on Oz64?</em></p>
<p>Test Controller sends these <strong>NuttX Commands</strong> to Oz64 and validates the responses: <a href="https://github.com/lupyuen/nuttx-build-farm/blob/main/oz64.exp">oz64.exp</a></p>
<div class="example-wrap"><pre class="language-bash"><code>nsh&gt; uname -a
TODO

nsh&gt; free
TODO

nsh&gt; ps
TODO

nsh&gt; ls -l /dev
TODO

nsh&gt; hello
TODO

nsh&gt; getprime
TODO

## Omitted: Test `hello` and `getprime` again

nsh&gt; ostest
TODO</code></pre></div>
<p><a href="TODO">(Why we test <strong>hello</strong> and <strong>getprime</strong> twice)</a></p>
<h1 id="control-our-oz64-sbc"><a class="doc-anchor" href="#control-our-oz64-sbc">¬ß</a>2 Control our Oz64 SBC</h1>
<p><em>Who controls our Test Controller?</em></p>
<p>TODO</p>
<h1 id="expect-script"><a class="doc-anchor" href="#expect-script">¬ß</a>3 Expect Script</h1>
<p><em>For Testing NuttX: What does our Bot run on Oz64 SBC?</em></p>
<p><a href="https://github.com/lupyuen/nuttx-build-farm/blob/main/oz64.exp">nuttx-build-farm/oz64.exp</a></p>
<div class="example-wrap"><pre class="language-bash"><code>#!/usr/bin/expect
## Expect Script for Testing NuttX on Oz64 SG2000, over SSH to SBC
puts &quot;Now running https://github.com/lupyuen/nuttx-build-farm/blob/main/oz64.exp&quot;

## For every 1 character sent, wait 0.001 milliseconds
set send_slow {1 0.001}

## Wait at most 60 seconds
set timeout 60

## Connect to SBC over SSH
spawn ssh $::env(OZ64_SERVER)

## Wake up SBC
send -s &quot;\r&quot;

## Connect to SBC over USB Serial Port
expect &quot;$&quot;
send -s &quot;screen -x\r&quot;

## Wait a while
sleep 5

## Terminate the session: Ctrl-A k y
send -s &quot;\x01ky&quot;
send -s &quot;\r&quot;
sleep 5

## Connect to USB Serial Terminal
expect &quot;$&quot;
send -s &quot;screen /dev/ttyUSB0 115200\r&quot;

## Power Off Oz64
puts &quot;Power Off Oz64...&quot;
system &quot;./oz64-power.sh off&quot;
sleep 5

## Power On Oz64
puts &quot;Power On Oz64...&quot;
system &quot;./oz64-power.sh on&quot;

## Wait for the prompt and enter `uname -a`
expect {
  &quot;nsh&gt; &quot; {}

  ## If timeout, exit with an error
  timeout { 
    ## Terminate the session: Ctrl-A k y
    send -s &quot;\x01ky&quot;
    send -s &quot;exit\r&quot;
    system &quot;./oz64-power.sh off&quot;
    puts &quot;\n===== Error: Test Failed\n&quot;
    exit 1 
  }
}
send -s &quot;uname -a\r&quot;

## Wait at most 300 seconds for other commands
set timeout 300

## Wait for the prompt and enter `free`
expect &quot;nsh&gt; &quot;
send -s &quot;free\r&quot;

## Wait for the prompt and enter `ps`
expect &quot;nsh&gt; &quot;
send -s &quot;ps\r&quot;

## Wait for the prompt and enter `ls -l /dev`
expect &quot;nsh&gt; &quot;
send -s &quot;ls -l /dev\r&quot;

## Wait for the prompt and enter `hello`
expect &quot;nsh&gt; &quot;
send -s &quot;hello\r&quot;

## Wait for the prompt and enter `getprime`
expect &quot;nsh&gt; &quot;
send -s &quot;getprime\r&quot;

## Wait for the prompt and enter `hello`
expect &quot;nsh&gt; &quot;
send -s &quot;hello\r&quot;

## Wait for the prompt and enter `getprime`
expect &quot;nsh&gt; &quot;
send -s &quot;getprime\r&quot;

## Wait for the prompt and enter `ostest`
expect &quot;nsh&gt; &quot;
send -s &quot;ostest\r&quot;

## Check the response...
expect {
  ## If we see this message, exit normally
  &quot;ostest_main: Exiting with status 0&quot; { 
    ## Terminate the session: Ctrl-A k y
    send -s &quot;\x01ky&quot;
    send -s &quot;exit\r&quot;
    system &quot;./oz64-power.sh off&quot;
    puts &quot;\n===== Test OK\n&quot;
    exit 0 
  }

  ## If timeout, exit with an error
  timeout { 
    ## Terminate the session: Ctrl-A k y
    send -s &quot;\x01ky&quot;
    send -s &quot;exit\r&quot;
    system &quot;./oz64-power.sh off&quot;
    puts &quot;\n===== Error: Test Failed\n&quot;
    exit 1 
  }
}</code></pre></div><h1 id="build-and-test-script"><a class="doc-anchor" href="#build-and-test-script">¬ß</a>4 Build and Test Script</h1>
<p><em>Who runs the above Expect Script?</em></p>
<p>Build and Test NuttX for Oz64 SG2000 RISC-V SBC</p>
<p><a href="https://github.com/lupyuen/nuttx-build-farm/blob/main/build-test-oz64.sh">nuttx-build-farm/build-test-oz64.sh</a></p>
<div class="example-wrap"><pre class="language-bash"><code>#!/usr/bin/env bash
## Build and Test NuttX for Oz64 SG2000 RISC-V SBC
## ./build-test-oz64.sh
## ./build-test-oz64.sh HEAD HEAD
## ./build-test-oz64.sh HEAD HEAD https://github.com/apache/nuttx master https://github.com/apache/nuttx-apps master
echo &quot;Now running https://github.com/lupyuen/nuttx-build-farm/blob/main/build-test-oz64.sh $1 $2 $3 $4 $5 $6&quot;

set -e  #  Exit when any command fails
set -x  #  Echo commands

## Server that controls Oz64
export OZ64_SERVER=tftpserver

nuttx_hash=$1  ## Optional NuttX Hash (HEAD)
apps_hash=$2   ## Optional Apps Hash (HEAD)
nuttx_url=$3   ## Optional NuttX URL (https://github.com/apache/nuttx)
nuttx_ref=$4   ## Optional NuttX Ref (master)
apps_url=$5    ## Optional Apps URL (https://github.com/apache/nuttx-apps
apps_ref=$6    ## Optional Apps Ref (master)
neofetch

## Set the defaults
if [[ &quot;$nuttx_hash&quot; == &quot;&quot; ]]; then
  nuttx_hash=HEAD
fi
if [[ &quot;$apps_hash&quot; == &quot;&quot; ]]; then
  apps_hash=HEAD
fi
if [[ &quot;$nuttx_url&quot; == &quot;&quot; ]]; then
  nuttx_url=https://github.com/apache/nuttx
fi
if [[ &quot;$nuttx_ref&quot; == &quot;&quot; ]]; then
  nuttx_ref=master
fi
if [[ &quot;$apps_url&quot; == &quot;&quot; ]]; then
  apps_url=https://github.com/apache/nuttx-apps
fi
if [[ &quot;$apps_ref&quot; == &quot;&quot; ]]; then
  apps_ref=master
fi

## Get the Script Directory
script_path=&quot;${BASH_SOURCE}&quot;
script_dir=&quot;$(cd -P &quot;$(dirname -- &quot;${script_path}&quot;)&quot; &gt;/dev/null 2&gt;&amp;1 &amp;&amp; pwd)&quot;

## Run in a Temp Folder
nuttx_ref2=$(echo $nuttx_ref | tr &#39;/&#39; &#39;_&#39;)
apps_ref2=$(echo $apps_ref | tr &#39;/&#39; &#39;_&#39;)
tmp_path=/tmp/build-test-oz64-$nuttx_ref2-$apps_ref2
rm -rf $tmp_path
mkdir $tmp_path
cd $tmp_path

## Download NuttX and Apps
git clone $nuttx_url nuttx --branch $nuttx_ref
git clone $apps_url  apps  --branch $apps_ref

## Switch to this NuttX Commit
if [[ &quot;$nuttx_hash&quot; != &quot;&quot; ]]; then
  pushd nuttx
  git reset --hard $nuttx_hash
  popd
fi

## Switch to this Apps Commit
if [[ &quot;$apps_hash&quot; != &quot;&quot; ]]; then
  pushd apps
  git reset --hard $apps_hash
  popd
fi

## Dump the NuttX and Apps Hash
set +x  ## Disable Echo
pushd nuttx ; echo NuttX Source: https://github.com/apache/nuttx/tree/$(git rev-parse HEAD) ; popd
pushd apps  ; echo NuttX Apps: https://github.com/apache/nuttx-apps/tree/$(git rev-parse HEAD) ; popd
set -x  ## Enable Echo

## Show the GCC and Rust versions
riscv-none-elf-gcc -v
rustup --version || true
rustc  --version || true

## Configure the NuttX Build
cd nuttx
tools/configure.sh milkv_duos:nsh

## Build the NuttX Kernel
make -j
riscv-none-elf-size nuttx

## Build the NuttX Apps
make -j export
pushd ../apps
./tools/mkimport.sh -z -x ../nuttx/nuttx-export-*.tar.gz
make -j import
popd

## Generate Initial RAM Disk
genromfs -f initrd -d ../apps/bin -V &quot;NuttXBootVol&quot;

## Prepare a Padding with 64 KB of zeroes
head -c 65536 /dev/zero &gt;/tmp/nuttx.pad

## Append Padding and Initial RAM Disk to NuttX Kernel
cat nuttx.bin /tmp/nuttx.pad initrd \
  &gt;Image

## Copy the NuttX Image to TFTP Server
scp Image $OZ64_SERVER:/tftpboot/Image-sg2000
ssh $OZ64_SERVER ls -l /tftpboot/Image-sg2000

## Run the NuttX Test
cd $script_dir
expect ./oz64.exp</code></pre></div>
<p>Build and Test NuttX. Called by nuttx-test-bot</p>
<p><a href="https://github.com/lupyuen/nuttx-build-farm/blob/main/build-test.sh">nuttx-build-farm/build-test.sh</a></p>
<div class="example-wrap"><pre class="language-bash"><code>#!/usr/bin/env bash
## Build and Test NuttX. Called by nuttx-test-bot.
## ./build-test.sh knsh64 /tmp/build-test.log
## ./build-test.sh knsh64 /tmp/build-test.log HEAD HEAD
## ./build-test.sh knsh64 /tmp/build-test.log HEAD HEAD https://github.com/apache/nuttx master https://github.com/apache/nuttx-apps master
echo &quot;Now running https://github.com/lupyuen/nuttx-build-farm/blob/main/build-test.sh $1 $2 $3 $4 $5 $6 $7 $8&quot;

set -e  ## Exit when any command fails
set -x  ## Echo commands

## First Parameter is the Build Test Script, like &quot;knsh64&quot;
script=$1
if [[ &quot;$script&quot; == &quot;&quot; ]]; then
  echo &quot;ERROR: Script is missing (e.g. knsh64)&quot;
  exit 1
fi

## Second Parameter is the Log File, like &quot;/tmp/build-test.log&quot;
log=$2
if [[ &quot;$log&quot; == &quot;&quot; ]]; then
  echo &quot;ERROR: Log File is missing (e.g. /tmp/build-test.log)&quot;
  exit 1
fi

## Get the Script Directory
script_path=&quot;${BASH_SOURCE}&quot;
script_dir=&quot;$(cd -P &quot;$(dirname -- &quot;${script_path}&quot;)&quot; &gt;/dev/null 2&gt;&amp;1 &amp;&amp; pwd)&quot;

## Get the `script` option
if [ &quot;`uname`&quot; == &quot;Linux&quot; ]; then
  script_option=-c
else
  script_option=
fi

## Build and Test NuttX
function build_test {
  local script=$1
  local log=$2

  ## Propagate the Return Status from Script
  pushd /tmp
  set +e  ## Ignore errors
  script $log \
    --return \
    $script_option \
    &quot;$script_dir/build-test-$script.sh $3 $4 $5 $6 $7 $8&quot;
  res=$?
  set -e  ## Exit when any command fails
  popd

  ## Find errors and warnings
  clean_log $log
  find_messages $log
}

## Strip the control chars
function clean_log {
  local log_file=$1
  local tmp_file=$log_file.tmp
  cat $log_file \
    | tr -d &#39;\r&#39; \
    | tr -d &#39;\r&#39; \
    | sed &#39;s/\x08/ /g&#39; \
    | sed &#39;s/\x1B(B//g&#39; \
    | sed &#39;s/\x1B\[K//g&#39; \
    | sed &#39;s/\x1B[&lt;=&gt;]//g&#39; \
    | sed &#39;s/\x1B\[[0-9:;&lt;=&gt;?]*[!]*[A-Za-z]//g&#39; \
    | sed &#39;s/\x1B[@A-Z\\\]^_]\|\x1B\[[0-9:;&lt;=&gt;?]*[-!&quot;#$%&amp;&#39;&quot;&#39;&quot;&#39;()*+,.\/]*[][\\@A-Z^_`a-z{|}~]//g&#39; \
    | cat -v \
    &gt;$tmp_file
  mv $tmp_file $log_file
  echo ----- &quot;Done! $log_file&quot;
}

## Search for Errors and Warnings
function find_messages {
  local log_file=$1
  local tmp_file=$log_file.tmp
  local msg_file=$log_file.msg
  local pattern=&#39;^(.*):(\d+):(\d+):\s+(warning|fatal error|error):\s+(.*)$&#39;
  grep &#39;^\*\*\*\*\*&#39; $log_file \
    &gt; $msg_file || true
  grep -P &quot;$pattern&quot; $log_file \
    | uniq \
    &gt;&gt; $msg_file || true
  cat $msg_file $log_file &gt;$tmp_file
  mv $tmp_file $log_file
}

## Build and Test NuttX
build_test \
  $script \
  $log \
  $3 $4 $5 $6 $7 $8

set +x ; echo &quot;***** Done! res=$res&quot; ; set -x
exit $res</code></pre></div><h1 id="test-bot-for-pull-requests"><a class="doc-anchor" href="#test-bot-for-pull-requests">¬ß</a>5 Test Bot for Pull Requests</h1>
<p><em>How will a Pull Request trigger the script above?</em></p>
<p><a href="https://github.com/lupyuen/nuttx-test-bot/blob/main/src/main.rs">nuttx-test-bot/main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="doccomment">//! Fetch the Latest 20 Unread Notifications:
//!   If Mention = "@nuttxpr test rv-virt:knsh64"
//!   - Build and Test NuttX
//!   - Capture the Output Log
//!   - Extract the Log Output and Result
//!   - Post as PR Comment
//!   - Post to Mastodon
//!   - Allow only Specific People</span></code></pre></div>
<p>Fetch all Notifications:</p>
<p><a href="https://github.com/lupyuen/nuttx-test-bot/blob/main/src/main.rs#L43-L111">main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code>    <span class="comment">// Fetch all Notifications
    // TODO: Unread only
    </span><span class="kw">let </span>notifications = octocrab
        .activity()
        .notifications()
        .list()
        .all(<span class="bool-val">true</span>)
        .send()
        .<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="comment">// For Every Notification...
    </span><span class="kw">for </span>n <span class="kw">in </span>notifications {
        <span class="comment">// Handle only Mentions
        </span><span class="kw">let </span>reason = <span class="kw-2">&amp;</span>n.reason;  <span class="comment">// "mention"
        // println!("reason={reason}", );
        </span><span class="kw">if </span>reason != <span class="string">"mention" </span>{ <span class="kw">continue</span>; }
        <span class="comment">// TODO: Mark Notification as Read

        // Fetch the PR from the Notification
        </span><span class="kw">let </span>owner = n.repository.owner.clone().unwrap().login;
        <span class="kw">let </span>repo = n.repository.name.clone();
        <span class="kw">let </span>pr_title = <span class="kw-2">&amp;</span>n.subject.title;  <span class="comment">// "Testing our bot"
        </span><span class="kw">let </span>pr_url = n.subject.url.clone().unwrap();  <span class="comment">// https://api.github.com/repos/lupyuen2/wip-nuttx/pulls/88
        </span><span class="kw">let </span>thread_url = <span class="kw-2">&amp;</span>n.url;  <span class="comment">// https://api.github.com/notifications/threads/14630615157
        </span><span class="macro">println!</span>(<span class="string">"owner={owner}"</span>);
        <span class="macro">println!</span>(<span class="string">"repo={repo}"</span>);
        <span class="macro">println!</span>(<span class="string">"pr_title={pr_title}"</span>);
        <span class="macro">println!</span>(<span class="string">"pr_url={pr_url}"</span>);
        <span class="macro">println!</span>(<span class="string">"thread_url={thread_url}"</span>);
        <span class="kw">if </span>!pr_url.as_str().contains(<span class="string">"/pulls/"</span>) { <span class="macro">error!</span>(<span class="string">"Not a PR: {pr_url}"</span>); <span class="kw">continue</span>; }
        <span class="comment">// println!("n={n:#?}");

        // Extract the PR Number
        </span><span class="kw">let </span>regex = Regex::new(<span class="string">".*/([0-9]+)$"</span>).unwrap();
        <span class="kw">let </span>caps = regex.captures(pr_url.as_str()).unwrap();
        <span class="kw">let </span>pr_id_str = caps.get(<span class="number">1</span>).unwrap().as_str();
        <span class="kw">let </span>pr_id: u64 = pr_id_str.parse().unwrap();
        <span class="macro">println!</span>(<span class="string">"pr_id={pr_id}"</span>);

        <span class="comment">// Allow only Specific Repos: apache/nuttx, apache/nuttx-apps
        </span><span class="kw">if </span>owner != <span class="string">"apache" </span>||
            ![<span class="string">"nuttx"</span>, <span class="string">"nuttx-apps"</span>].contains(<span class="kw-2">&amp;</span>repo.as_str()) {
            <span class="macro">error!</span>(<span class="string">"Disallowed owner/repo: {owner}/{repo}"</span>);
            <span class="kw">continue</span>;
        }

        <span class="comment">// Get the Handlers for GitHub Pull Requests and Issues
        </span><span class="kw">let </span>pulls = octocrab.pulls(<span class="kw-2">&amp;</span>owner, <span class="kw-2">&amp;</span>repo);
        <span class="kw">let </span>issues = octocrab.issues(<span class="kw-2">&amp;</span>owner, <span class="kw-2">&amp;</span>repo);

        <span class="comment">// Post the Result and Log Output as PR Comment
        </span>process_pr(<span class="kw-2">&amp;</span>pulls, <span class="kw-2">&amp;</span>issues, pr_id).<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="comment">// Wait 1 minute
        </span>sleep(Duration::from_secs(<span class="number">60</span>));

        <span class="comment">// TODO: Mark Notification as Read
        // TODO: Continue to Next Notification
        </span><span class="kw">break</span>;

        <span class="comment">// TODO: Allow only Specific People
        // TODO: Post to Mastodon
    </span>}</code></pre></div>
<p>Build and Test the PR. Then post the results as a PR Comment</p>
<p><a href="https://github.com/lupyuen/nuttx-test-bot/blob/main/src/main.rs#L111-L175">main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="doccomment">/// Build and Test the PR. Then post the results as a PR Comment
</span><span class="kw">async fn </span>process_pr(pulls: <span class="kw-2">&amp;</span>PullRequestHandler&lt;<span class="lifetime">'_</span>&gt;, issues: <span class="kw-2">&amp;</span>IssueHandler&lt;<span class="lifetime">'_</span>&gt;, pr_id: u64) -&gt; <span class="prelude-ty">Result</span>&lt;(), Box&lt;<span class="kw">dyn </span>std::error::Error&gt;&gt; {
    <span class="comment">// Get the Command and Args: ["test", "milkv_duos:nsh"]
    </span><span class="kw">let </span>args = get_command(issues, pr_id).<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="kw">if </span>args.is_none() { <span class="macro">warn!</span>(<span class="string">"Missing command"</span>); <span class="kw">return </span><span class="prelude-val">Ok</span>(()); }
    <span class="kw">let </span>args = args.unwrap();
    <span class="kw">let </span>cmd = <span class="kw-2">&amp;</span>args[<span class="number">0</span>];
    <span class="kw">let </span>target = <span class="kw-2">&amp;</span>args[<span class="number">1</span>];
    <span class="kw">if </span>cmd != <span class="string">"test" </span>{ <span class="macro">error!</span>(<span class="string">"Unknown command: {cmd}"</span>); <span class="kw">return </span><span class="prelude-val">Ok</span>(()); }
    <span class="kw">let </span>(script, target) = <span class="kw">match </span>target.as_str() {
        <span class="string">"milkv_duos:nsh" </span>=&gt; (<span class="string">"oz64"</span>, target),
        <span class="string">"oz64:nsh"       </span>=&gt; (<span class="string">"oz64"</span>, <span class="kw-2">&amp;</span><span class="string">"milkv_duos:nsh"</span>.into()),
        <span class="string">"rv-virt:knsh64" </span>=&gt; (<span class="string">"knsh64"</span>, target),
        <span class="kw">_ </span>=&gt; { <span class="macro">error!</span>(<span class="string">"Unknown target: {target}"</span>); <span class="kw">return </span><span class="prelude-val">Ok</span>(()); }
    };
    <span class="macro">println!</span>(<span class="string">"target={target}"</span>);
    <span class="macro">println!</span>(<span class="string">"script={script}"</span>);

    <span class="comment">// Fetch the PR
    </span><span class="kw">let </span>pr = pulls
        .get(pr_id)
        .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="macro">info!</span>(<span class="string">"{:#?}"</span>, pr.url);

    <span class="comment">// Skip if PR State is Not Open
    </span><span class="kw">if </span>pr.state.clone().unwrap() != IssueState::Open {
        <span class="macro">info!</span>(<span class="string">"Skipping Closed PR: {}"</span>, pr_id);
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    }

    <span class="comment">// Fetch the PR Reactions. Quit if Both Reactions are set.
    </span><span class="kw">let </span>reactions = get_reactions(issues, pr_id).<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="kw">if </span>reactions.<span class="number">0</span>.is_some() &amp;&amp; reactions.<span class="number">1</span>.is_some() {
        <span class="macro">info!</span>(<span class="string">"Skipping PR after 3 retries: {}"</span>, pr_id);
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    }

    <span class="comment">// Bump up the PR Reactions: 00 &gt; 01 &gt; 10 &gt; 11
    </span>bump_reactions(issues, pr_id, reactions).<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="comment">// Build and Test the PR
    </span><span class="kw">let </span>response_text = build_test(<span class="kw-2">&amp;</span>pr, target, script).<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="comment">// Header for PR Comment
    </span><span class="kw">let </span>header = <span class="string">"[**\\[Experimental Bot, please feedback here\\]**](https://github.com/search?q=repo%3Aapache%2Fnuttx+15779&amp;type=issues)"</span>;

    <span class="comment">// Compose the PR Comment
    </span><span class="kw">let </span>comment_text =
        header.to_string() + <span class="string">"\n\n" </span>+
        <span class="kw-2">&amp;</span>response_text;

    <span class="comment">// Post the PR Comment
    </span>issues.create_comment(pr_id, comment_text).<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="comment">// If successful, delete the PR Reactions
    </span>delete_reactions(issues, pr_id).<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="macro">info!</span>(<span class="string">"{:#?}"</span>, pr.url);

    <span class="comment">// Wait 1 minute
    </span>sleep(Duration::from_secs(<span class="number">60</span>));

    <span class="comment">// Return OK
    </span><span class="prelude-val">Ok</span>(())
}</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx-test-bot/blob/main/src/main.rs#L203-L278">main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="doccomment">/// Build and Test the PR. Return the Build-Test Result.
</span><span class="kw">async fn </span>build_test(pr: <span class="kw-2">&amp;</span>PullRequest, target: <span class="kw-2">&amp;</span>str, script: <span class="kw-2">&amp;</span>str) -&gt; <span class="prelude-ty">Result</span>&lt;String, Box&lt;<span class="kw">dyn </span>std::error::Error&gt;&gt; {
    <span class="comment">// Get the Head Ref and Head URL from PR
    // let pr: Value = serde_json::from_str(&amp;body).unwrap();
    // let pr_id = pr["number"].as_u64().unwrap();
    </span><span class="kw">let </span>head = <span class="kw-2">&amp;</span>pr.head;
    <span class="kw">let </span>head_ref = <span class="kw-2">&amp;</span>head.ref_field;  <span class="comment">// "test-bot"
    </span><span class="kw">let </span>head_url = head.repo.clone().unwrap().html_url.unwrap();  <span class="comment">// https://github.com/lupyuen2/wip-nuttx
    // println!("head_ref={head_ref}");
    // println!("head_url={head_url}");

    // True if URL is an Apps Repo
    </span><span class="kw">let </span>is_apps =
        <span class="kw">if </span>head_url.as_str().contains(<span class="string">"apps"</span>) { <span class="bool-val">true </span>}
        <span class="kw">else </span>{ <span class="bool-val">false </span>};

    <span class="comment">// Set the URLs and Refs for NuttX and Apps
    </span><span class="kw">let </span>nuttx_hash = <span class="string">"HEAD"</span>;
    <span class="kw">let </span>nuttx_url =
        <span class="kw">if </span>is_apps { <span class="string">"https://github.com/apache/nuttx" </span>}
        <span class="kw">else </span>{ head_url.as_str() };
    <span class="kw">let </span>nuttx_ref =
        <span class="kw">if </span>is_apps { <span class="string">"master" </span>}
        <span class="kw">else </span>{ head_ref };
    <span class="kw">let </span>apps_hash = <span class="string">"HEAD"</span>;
    <span class="kw">let </span>apps_url = 
        <span class="kw">if </span>is_apps { head_url.as_str() }
        <span class="kw">else </span>{ <span class="string">"https://github.com/apache/nuttx-apps" </span>};
    <span class="kw">let </span>apps_ref =
        <span class="kw">if </span>is_apps { head_ref }
        <span class="kw">else </span>{ <span class="string">"master" </span>};

    <span class="comment">// Build and Test NuttX: ./build-test.sh knsh64 /tmp/build-test.log HEAD HEAD https://github.com/apache/nuttx master https://github.com/apache/nuttx-apps master
    // Which calls: ./build-test-knsh64.sh HEAD HEAD https://github.com/apache/nuttx master https://github.com/apache/nuttx-apps master
    </span><span class="kw">let </span>cmd = <span class="macro">format!</span>(<span class="string">"./build-test-{script}.sh \n  {nuttx_hash} {apps_hash} \n  {nuttx_url} {nuttx_ref} \n  {apps_url} {apps_ref}"</span>);
    <span class="macro">println!</span>(<span class="string">"{cmd}"</span>);
    <span class="comment">// std::process::exit(0); ////
    </span><span class="macro">println!</span>(<span class="string">"PLEASE VERIFY"</span>);
    sleep(Duration::from_secs(<span class="number">30</span>));

    <span class="comment">// Start the Build and Test Script
    </span><span class="kw">let </span>log = <span class="string">"/tmp/nuttx-test-bot.log"</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>child = Command
        ::new(<span class="string">"../nuttx-build-farm/build-test.sh"</span>)
        .arg(script).arg(log)
        .arg(nuttx_hash).arg(apps_hash)
        .arg(nuttx_url).arg(nuttx_ref)
        .arg(apps_url).arg(apps_ref)
        .spawn().unwrap();
    <span class="comment">// println!("child={child:?}");

    // Wait for Build and Test to complete
    </span><span class="kw">let </span>status = child.wait().unwrap();  <span class="comment">// 0 if successful
    </span><span class="macro">println!</span>(<span class="string">"status={status:?}"</span>);

    <span class="comment">// Upload the log as GitLab Snippet
    </span><span class="kw">let </span>log_content = fs::read_to_string(log).unwrap();
    <span class="kw">let </span>snippet_url = create_snippet(<span class="kw-2">&amp;</span>log_content).<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="comment">// Extract the Log Output
    </span><span class="kw">let </span>log_extract = extract_log(<span class="kw-2">&amp;</span>snippet_url).<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="kw">let </span>log_content = log_extract.join(<span class="string">"\n"</span>);
    <span class="macro">println!</span>(<span class="string">"log_content=\n{log_content}"</span>);
    <span class="kw">let </span><span class="kw-2">mut </span>result = 
        <span class="kw">if </span>status.success() { <span class="macro">format!</span>(<span class="string">"Build and Test Successful ({target})\n"</span>) }
        <span class="kw">else </span>{ <span class="macro">format!</span>(<span class="string">"Build and Test **FAILED** ({target})\n"</span>) };
    result.push_str(<span class="kw-2">&amp;</span>snippet_url);
    result.push_str(<span class="string">"\n```text\n"</span>);
    result.push_str(<span class="kw-2">&amp;</span>log_content);
    result.push_str(<span class="string">"\n```\n"</span>);
    <span class="macro">println!</span>(<span class="string">"result={result}"</span>);

    <span class="comment">// Return the Result
    </span><span class="prelude-val">Ok</span>(result)
}</code></pre></div>
<h1 id="power-up-our-oz64-sbc"><a class="doc-anchor" href="#power-up-our-oz64-sbc">¬ß</a>6 Power Up our Oz64 SBC</h1>
<p>One Final Step: How we flip the Power, On and Off for our Oz64 SBC.</p>
<p><a href="https://github.com/lupyuen/nuttx-build-farm/blob/main/oz64-power.sh">nuttx-build-farm/oz64-power.sh</a></p>
<div class="example-wrap"><pre class="language-bash"><code>#!/usr/bin/env bash
## Power Oz64 On or Off
## ./oz64-power on
## ./oz64-power off
echo &quot;Now running https://github.com/lupyuen/nuttx-build-farm/blob/main/oz64-power.sh $1&quot;

set -e  ## Exit when any command fails

## First Parameter is on or off
state=$1
if [[ &quot;$state&quot; == &quot;&quot; ]]; then
  echo &quot;ERROR: Specify &#39;on&#39; or &#39;off&#39;&quot;
  exit 1
fi

## Get the Home Assistant Token, copied from http://localhost:8123/profile/security
## export HOME_ASSISTANT_TOKEN=xxxx
. $HOME/home-assistant-token.sh

## Set the Home Assistant Server
export HOME_ASSISTANT_SERVER=luppys-mac-mini.local:8123

echo &quot;----- Power $state Oz64&quot;
curl \
    -X POST \
    -H &quot;Authorization: Bearer $HOME_ASSISTANT_TOKEN&quot; \
    -H &quot;Content-Type: application/json&quot; \
    -d &quot;{\&quot;entity_id\&quot;: \&quot;automation.oz64_power_$state\&quot;}&quot; \
    http://$HOME_ASSISTANT_SERVER/api/services/automation/trigger</code></pre></div>
<p>power3</p>
<p><img src="https://lupyuen.org/images/testbot-power3.png" alt="TODO" /></p>
<p>power4</p>
<p><img src="https://lupyuen.org/images/testbot-power4.png" alt="TODO" /></p>
<p>power1</p>
<p><img src="https://lupyuen.org/images/testbot-power1.png" alt="TODO" /></p>
<p>power2</p>
<p><img src="https://lupyuen.org/images/testbot-power2.png" alt="TODO" /></p>
<h1 id="security-implications"><a class="doc-anchor" href="#security-implications">¬ß</a>7 Security Implications</h1>
<p>TODO</p>
<p>Reminder to myself: Be careful when running Unmerged Code on our Home Computers. In case the PR contains any Scripts or Apps that may cause problems on our Home Computer or Home Network.</p>
<p>Basically we only operate on NuttX repos, so there should be no malware‚Ä¶ but anyone can send PR with anything true!!!</p>
<p>How to prevent problems? Network separation? One time use containers / jails / vm with restricted network access?</p>
<p>I might try a scaled-down simpler implementation that has less security risk. For example, when I post a PR Comment @nuttxpr please test, then our Test Bot will download the PR and run Build + Test on QEMU RISC-V ü§î</p>
<p>5 Years Ago: We had Security Issues with a PineTime Smartwatch that we opened up for Remote Testing :-)</p>
<p>Notify via Mastodon. Click ‚ÄúLike‚Äù on the PR to approve?</p>
<p><a href="https://github.com/lupyuen/remote-pinetime-bot?tab=readme-ov-file#security-issues">Remote PineTime Bot: Security Issues</a></p>
<ol>
<li>
<p>NuttX Scripts</p>
</li>
<li>
<p>Network Access (DMZ / Guest Network)</p>
</li>
<li>
<p>Semihosting: Breaking out from Semihosting Guest to Semihosting Host</p>
</li>
</ol>
<p><em>If we had to do it all again with NuttX on PineTime?</em></p>
<p>Same: SBC with OpenOCD + Semihosting. Send Screenshot in PR Comment</p>
<h1 id="todo"><a class="doc-anchor" href="#todo">¬ß</a>8 TODO</h1>
<p>Combine Build-Test Server with Test Controller</p>
<p>Multiple Test Controllers</p>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>9 What‚Äôs Next</h1>
<p>Special Thanks to <strong>Mr Gregory Nutt</strong> for your guidance and kindness. I‚Äôm also grateful to <a href="https://lupyuen.org/articles/sponsor"><strong>My Sponsors</strong></a>, for supporting my writing.</p>
<ul>
<li>
<p><a href="https://lupyuen.org/articles/sponsor"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/nuttx-sg2000"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Sophgo SG2000‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/nuttx-ox64"><strong>My Other Project: ‚ÄúNuttX for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/nuttx-star64"><strong>Older Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/pinephone-nuttx"><strong>Olderer Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.org"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.org/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://codeberg.org/lupyuen/lupyuen.org/src/branch/master/src/testbot.md"><strong>lupyuen.org/src/testbot.md</strong></a></p>
<p><img src="https://lupyuen.org/images/ci4-thinkstation.jpg" alt="PR Test Bot is hosted on this hefty Ubuntu Xeon Workstation" /></p>
<span style="font-size:80%">
<p><a href="https://qoto.org/@lupyuen/113517788288458811"><em>PR Test Bot is hosted on this hefty Ubuntu Xeon Workstation</em></a></p>
</span>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>