<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>(Clickable) Call Graph for Apache NuttX Real-Time Operating System</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="(Clickable) Call Graph for Apache NuttX Real-Time Operating System"
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/unicorn2-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">(Clickable) Call Graph for Apache NuttX Real-Time Operating System</h1>
    <nav id="TOC"><ul>
<li><a href="#map-address-to-function-with-elf-file">1 Map Address to Function with ELF File</a><ul></ul></li>
<li><a href="#call-graph-for-apache-nuttx-rtos">2 Call Graph for Apache NuttX RTOS</a><ul></ul></li>
<li><a href="#boot-trail">3 Boot Trail</a><ul></ul></li>
<li><a href="#after-mmu-fault">4 After MMU Fault</a><ul></ul></li>
<li><a href="#whats-next">5 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>10 Mar 2023</em></p>
<p><img src="https://lupyuen.github.io/images/unicorn2-title.jpg" alt="TODO" /></p>
<p>TODO</p>
<p>Last week we ran <a href="https://lupyuen.github.io/articles/what"><strong>Apache NuttX Real-Time Operating System</strong></a> (RTOS) on <a href="https://www.unicorn-engine.org/"><strong>Unicorn Emulator</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/unicorn"><strong>‚Äú(Possibly) Emulate PinePhone with Unicorn Emulator‚Äù</strong></a></li>
</ul>
<p>And we hit a baffling <strong>Arm64 Exception</strong> in the (Emulated) <strong>Memory Management Unit</strong>.</p>
<p>TODO</p>
<ul>
<li>
<p>Block Execution Hook</p>
</li>
<li>
<p>Lookup Addresses</p>
</li>
<li>
<p>Call Graph</p>
</li>
<li>
<p>Boot Trail</p>
</li>
<li>
<p>Automated Build and Test</p>
</li>
</ul>
<h1 id="map-address-to-function-with-elf-file"><a href="#map-address-to-function-with-elf-file">1 Map Address to Function with ELF File</a></h1>
<p>TODO</p>
<p>Our <strong>Block Execution Hook</strong> now prints the <strong>Function Name</strong> and the <strong>Filename</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>hook_block:  
  address=0x40080eb0, 
  size=12, 
  setup_page_tables, 
  arch/arm64/src/common/arm64_mmu.c:516:25

hook_block:  
  address=0x40080eec, 
  size=16, 
  enable_mmu_el1, 
  arch/arm64/src/common/arm64_mmu.c:543:11

err=Err(EXCEPTION)
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/f2e883b2b8054d75fbac7de661f0ee5a">(Source)</a></p>
<p>Our Hook Function looks up the Address in the <a href="https://crates.io/crates/gimli"><strong>DWARF Debug Symbols</strong></a> of the <a href="https://github.com/lupyuen/pinephone-emulator/blob/main/nuttx/nuttx"><strong>NuttX ELF File</strong></a>.</p>
<p>This is explained here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/unicorn#appendix-map-address-to-function-with-elf-file">‚ÄúMap Address to Function with ELF File‚Äù</a></li>
</ul>
<h1 id="call-graph-for-apache-nuttx-rtos"><a href="#call-graph-for-apache-nuttx-rtos">2 Call Graph for Apache NuttX RTOS</a></h1>
<p>TODO</p>
<p>To troubleshoot the Apache NuttX MMU Fault on Unicorn Emulator, we auto-generated this Call Graph‚Ä¶</p>
<p>(To see the NuttX Source Code: Right-click the Node and select ‚ÄúOpen Link‚Äù)</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-emulator#call-graph-for-apache-nuttx-rtos"><strong>‚ÄúCall Graph for Apache NuttX RTOS‚Äù</strong></a></li>
</ul>
<p>We generated the Call Graph with this command‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>cargo run | grep call_graph | cut -c 12-
</code></pre></div>
<p>(<code>cut</code> command removes columns 1 to 11)</p>
<p>Which produces this <a href="https://mermaid.js.org/syntax/flowchart.html">Mermaid Flowchart</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>‚Üí cargo run | grep call_graph | cut -c 12- 

  flowchart TD

  arm64_boot_el1_init --&gt; arm64_isb
  click arm64_boot_el1_init href &quot;https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_boot.c#L137&quot; &quot;arch/arm64/src/common/arm64_boot.c &quot;

  arm64_isb --&gt; arm64_boot_el1_init
  click arm64_isb href &quot;https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/barriers.h#L57&quot; &quot;arch/arm64/src/common/barriers.h &quot;
  ...

  setup_page_tables --&gt; enable_mmu_el1
  click setup_page_tables href &quot;https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_mmu.c#L515&quot; &quot;arch/arm64/src/common/arm64_mmu.c &quot;

  enable_mmu_el1 --&gt; ***_HALT_***
  click enable_mmu_el1 href &quot;https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_mmu.c#L542&quot; &quot;arch/arm64/src/common/arm64_mmu.c &quot;
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/b0e4019801aaf9860bcb234c8a9c8584">(Source)</a></p>
<p>The Call Graph is generated by our Block Execution Hook like so‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-emulator/blob/b23c1d251a7fb244f2e396419d12ab532deb3e6b/src/main.rs#L130-L159">main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="doccomment">/// Hook Function for Block Emulation.
/// Called once for each Basic Block of Arm64 Instructions.
</span><span class="kw">fn </span>hook_block(
    <span class="kw">_</span>: <span class="kw-2">&amp;mut </span>Unicorn&lt;()&gt;,  <span class="comment">// Emulator
    </span>address: u64,  <span class="comment">// Block Address
    </span>size: u32      <span class="comment">// Block Size
</span>) {
    <span class="comment">// Ignore the memset() loop. TODO: Read the ELF Symbol Table to get address of memset().
    </span><span class="kw">if </span>address &gt;= <span class="number">0x4008_9328 </span>&amp;&amp; address &lt;= <span class="number">0x4008_933c </span>{ <span class="kw">return</span>; }
    <span class="macro">print!</span>(<span class="string">&quot;hook_block:  address={:#010x}, size={:02}&quot;</span>, address, size);

    <span class="comment">// Print the Function Name
    </span><span class="kw">let </span>function = map_address_to_function(address);
    <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="kw-2">ref </span>name) = function {
        <span class="macro">print!</span>(<span class="string">&quot;, {}&quot;</span>, name);
    }

    <span class="comment">// Print the Source Filename
    </span><span class="kw">let </span>loc = map_address_to_location(address);
    <span class="kw">if let </span><span class="prelude-val">Some</span>((<span class="kw-2">ref </span>file, line, col)) = loc {
        <span class="kw">let </span>file = file.clone().unwrap_or(<span class="string">&quot;&quot;</span>.to_string());
        <span class="kw">let </span>line = line.unwrap_or(<span class="number">0</span>);
        <span class="kw">let </span>col = col.unwrap_or(<span class="number">0</span>);
        <span class="macro">print!</span>(<span class="string">&quot;, {}:{}:{}&quot;</span>, file, line, col);
    }
    <span class="macro">println!</span>();

    <span class="comment">// Print the Call Graph
    </span>call_graph(address, size, function, loc);
}</code></pre></div>
<p><code>call_graph</code> prints the Call Graph by looking up the Block Address in the ELF Context‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-emulator/blob/b23c1d251a7fb244f2e396419d12ab532deb3e6b/src/main.rs#L224-L265">main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="doccomment">/// Print the Mermaid Call Graph for this Function Call:
/// cargo run | grep call_graph | cut -c 12-
</span><span class="kw">fn </span>call_graph(
    _address: u64,  <span class="comment">// Code Address
    </span>_size: u32,     <span class="comment">// Size of Code Block
    </span>function: <span class="prelude-ty">Option</span>&lt;String&gt;,  <span class="comment">// Function Name
    </span>loc: <span class="prelude-ty">Option</span>&lt;(        <span class="comment">// Source Location
        </span><span class="prelude-ty">Option</span>&lt;String&gt;,  <span class="comment">// Filename
        </span><span class="prelude-ty">Option</span>&lt;u32&gt;,     <span class="comment">// Line
        </span><span class="prelude-ty">Option</span>&lt;u32&gt;      <span class="comment">// Column
    </span>)&gt;
) {
    <span class="comment">// Get the Function Name
    </span><span class="kw">let </span><span class="prelude-val">Some</span>(fname) = function
        <span class="kw">else </span>{ <span class="kw">return</span>; };

    <span class="comment">// Unsafe because `LAST_FNAME` is a Static Mutable
    </span><span class="kw">unsafe </span>{
        <span class="comment">// Skip if we are still in the same Function
        </span><span class="kw">static </span><span class="kw-2">mut </span>LAST_FNAME: String = String::new();
        <span class="kw">static </span><span class="kw-2">mut </span>LAST_LOC: <span class="prelude-ty">Option</span>&lt;(<span class="prelude-ty">Option</span>&lt;String&gt;, <span class="prelude-ty">Option</span>&lt;u32&gt;, <span class="prelude-ty">Option</span>&lt;u32&gt;)&gt; = <span class="prelude-val">None</span>;
        <span class="kw">if </span>fname.eq(<span class="kw-2">&amp;</span>LAST_FNAME) { <span class="kw">return</span>; }

        <span class="comment">// If this function has not been shown too often...
        </span><span class="kw">if </span>can_show_function(<span class="kw-2">&amp;</span>fname) {
            <span class="comment">// Print the Call Flow
            </span><span class="kw">if </span>LAST_FNAME.is_empty() {            
                <span class="macro">println!</span>(<span class="string">&quot;call_graph:  flowchart TD&quot;</span>);  <span class="comment">// Top-Down Flowchart
            </span>} <span class="kw">else </span>{
                <span class="comment">// URL looks like https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_mmu.c#L541
                </span><span class="kw">let </span>(file, line, <span class="kw">_</span>) = LAST_LOC.clone().unwrap_or((<span class="prelude-val">Some</span>(<span class="string">&quot;&quot;</span>.to_string()), <span class="prelude-val">None</span>, <span class="prelude-val">None</span>));
                <span class="kw">let </span>file = file.unwrap_or(<span class="string">&quot;&quot;</span>.to_string());
                <span class="kw">let </span>line = line.unwrap_or(<span class="number">1</span>) - <span class="number">1</span>;
                <span class="kw">let </span>url = <span class="macro">format!</span>(<span class="string">&quot;https://github.com/apache/nuttx/blob/master/{file}#L{line}&quot;</span>);
                <span class="macro">println!</span>(<span class="string">&quot;call_graph:  {LAST_FNAME} --&gt; {fname}&quot;</span>);
                <span class="macro">println!</span>(<span class="string">&quot;call_graph:  click {LAST_FNAME} href \&quot;{url}\&quot; \&quot;{file} \&quot;&quot;</span>);
            }
        }
        LAST_FNAME = fname;
        LAST_LOC = loc;
    }
}</code></pre></div>
<p>We map the Block Address to Function Name and Source File in <code>map_address_to_function</code> and <code>map_address_to_location</code>‚Ä¶</p>
<p><a href="https://github.com/lupyuen/pinephone-emulator/blob/b23c1d251a7fb244f2e396419d12ab532deb3e6b/src/main.rs#L175-L222">main.rs</a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="doccomment">/// Map the Arm64 Code Address to the Function Name by looking up the ELF Context
</span><span class="kw">fn </span>map_address_to_function(
    address: u64       <span class="comment">// Code Address
</span>) -&gt; <span class="prelude-ty">Option</span>&lt;String&gt; {  <span class="comment">// Function Name
    // Lookup the Arm64 Code Address in the ELF Context
    </span><span class="kw">let </span>context = ELF_CONTEXT.context.borrow();
    <span class="kw">let </span><span class="kw-2">mut </span>frames = context.find_frames(address)
        .expect(<span class="string">&quot;failed to find frames&quot;</span>);

    <span class="comment">// Return the Function Name
    </span><span class="kw">if let </span><span class="prelude-val">Some</span>(frame) = frames.next().unwrap() {
        <span class="kw">if let </span><span class="prelude-val">Some</span>(func) = frame.function {
            <span class="kw">if let </span><span class="prelude-val">Ok</span>(name) = func.raw_name() {
                <span class="kw">let </span>s = String::from(name);
                <span class="kw">return </span><span class="prelude-val">Some</span>(s);
            }
        }    
    }
    <span class="prelude-val">None
</span>}

<span class="doccomment">/// Map the Arm64 Code Address to the Source Filename, Line and Column
</span><span class="kw">fn </span>map_address_to_location(
    address: u64     <span class="comment">// Code Address
</span>) -&gt; <span class="prelude-ty">Option</span>&lt;(        <span class="comment">// Returns...
    </span><span class="prelude-ty">Option</span>&lt;String&gt;,  <span class="comment">// Filename
    </span><span class="prelude-ty">Option</span>&lt;u32&gt;,     <span class="comment">// Line
    </span><span class="prelude-ty">Option</span>&lt;u32&gt;      <span class="comment">// Column
</span>)&gt; {
    <span class="comment">// Lookup the Arm64 Code Address in the ELF Context
    </span><span class="kw">let </span>context = ELF_CONTEXT.context.borrow();
    <span class="kw">let </span>loc = context.find_location(address)
        .expect(<span class="string">&quot;failed to find location&quot;</span>);

    <span class="comment">// Return the Filename, Line and Column
    </span><span class="kw">if let </span><span class="prelude-val">Some</span>(loc) = loc {
        <span class="kw">if let </span><span class="prelude-val">Some</span>(file) = loc.file {
            <span class="kw">let </span>s = String::from(file)
                .replace(<span class="string">&quot;/private/tmp/nuttx/nuttx/&quot;</span>, <span class="string">&quot;&quot;</span>)
                .replace(<span class="string">&quot;arch/arm64/src/chip&quot;</span>, <span class="string">&quot;arch/arm64/src/a64&quot;</span>);  <span class="comment">// TODO: Handle other chips
            </span><span class="prelude-val">Some</span>((<span class="prelude-val">Some</span>(s), loc.line, loc.column))
        } <span class="kw">else </span>{
            <span class="prelude-val">Some</span>((<span class="prelude-val">None</span>, loc.line, loc.column))
        }
    } <span class="kw">else </span>{
        <span class="prelude-val">None
    </span>}
}</code></pre></div>
<p><code>ELF_CONTEXT</code> is explained here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/unicorn#appendix-map-address-to-function-with-elf-file">‚ÄúMap Address to Function with ELF File‚Äù</a></li>
</ul>
<h1 id="boot-trail"><a href="#boot-trail">3 Boot Trail</a></h1>
<p>TODO</p>
<ul>
<li><a href="https://github.com/lupyuen/pinephone-emulator#call-graph-for-apache-nuttx-rtos"><strong>‚ÄúCall Graph for Apache NuttX RTOS‚Äù</strong></a></li>
</ul>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_head.S#L78-L227">arm64_head</a></p>
<ul>
<li>
<p>Calls <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_boot.c#L132-L162">arm64_boot_el1_init</a></p>
</li>
<li>
<p>And <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_boot.c#L181">arm64_boot_primary_c_routine</a></p>
</li>
</ul>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_boot.c#L132-L162">arm64_boot_el1_init</a></p>
<ul>
<li>
<p>Sets the EL1 Vector Table <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_boot.c#L135-L140">vbar_el1</a></p>
</li>
<li>
<p>Sets <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_boot.c#L140-L147">cpacr_el1</a></p>
</li>
<li>
<p>Sets <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_boot.c#L147-L153">sctlr_el1</a></p>
</li>
<li>
<p>Sets <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_boot.c#L153-L155">cntv_cval_el0</a></p>
</li>
</ul>
<p>TODO</p>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_boot.c#L179-L184">arm64_boot_primary_c_routine</a></p>
<ul>
<li>
<p>Calls <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_boot.c#L164-L177">boot_early_memset</a></p>
<p>And <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/a64/a64_boot.c#L73-L105">arm64_chip_boot</a></p>
</li>
</ul>
<p>TODO</p>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/a64/a64_boot.c#L73-L105">arm64_chip_boot</a></p>
<ul>
<li>
<p>Calls <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_mmu.c#L577-L628">arm64_mmu_init</a></p>
</li>
<li>
<p>Which calls <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_mmu.c#L485-L524">setup_page_tables</a></p>
</li>
<li>
<p>Which calls <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_mmu.c#L526-L552">enable_mmu_el1</a></p>
</li>
<li>
<p>Which fails with MMU Fault</p>
</li>
</ul>
<h1 id="after-mmu-fault"><a href="#after-mmu-fault">4 After MMU Fault</a></h1>
<p>TODO: After fault</p>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/a64/a64_boot.c#L73-L105">arm64_chip_boot</a></p>
<ul>
<li>
<p>Calls <a href="https://github.com/apache/nuttx/blob/master/boards/arm64/a64/pinephone/src/pinephone_boardinit.c#L59-L85">a64_board_initialize</a></p>
</li>
<li>
<p>And <a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/a64/a64_serial.c#L590-L619">a64_earlyserialinit</a></p>
</li>
</ul>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_boot.c#L179-L184">arm64_boot_primary_c_routine</a></p>
<ul>
<li>Calls nx_start</li>
</ul>
<h1 id="whats-next"><a href="#whats-next">5 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>This has been a fun educational exercise. Now we have a way to run <strong>Automated Daily Tests</strong> for Apache NuttX RTOS on PinePhone‚Ä¶ Kudos to the <strong>Maintainers of Unicorn Emulator</strong>!</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>My Current Project: ‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>My Other Project: ‚ÄúThe RISC-V BL602 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/unicorn2.md"><strong>lupyuen.github.io/src/unicorn2.md</strong></a></p>

    
</body>
</html>