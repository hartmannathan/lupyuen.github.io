<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="/_static/css/banner-styles.css?v=bsmaklHF" />
  <link rel="stylesheet" type="text/css" href="/_static/css/iconochive.css?v=qtvMKcIJ" />
  <link rel="canonical" href="https://lupyuen.org/articles/rust-rocks-nb-iot-stm32-blue-pill-with-quectel-bc95-g-on-apache-mynewt.html" />
  <!-- End Wayback Rewrite JS Include -->
  <title data-rh="true">Rust Rocks NB-IoT! STM32 Blue Pill with Quectel BC95-G on Apache Mynewt | by Lup Yuen Lee 李立源 |
    Medium</title>
  <meta data-rh="true" charset="utf-8" />
  <meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
  <meta data-rh="true" name="theme-color" content="#000000" />
  <meta data-rh="true" property="og:type" content="article" />
  <meta data-rh="true" property="article:published_time" content="2020-02-02T09:00:34.688Z" />
  <meta data-rh="true" name="title"
    content="Rust Rocks NB-IoT! STM32 Blue Pill with Quectel BC95-G on Apache Mynewt | by Lup Yuen Lee 李立源 | Medium" />
  <meta data-rh="true" property="og:title"
    content="Rust Rocks NB-IoT! STM32 Blue Pill with Quectel BC95-G on Apache Mynewt" />
  <meta data-rh="true" property="twitter:title"
    content="Rust Rocks NB-IoT! STM32 Blue Pill with Quectel BC95-G on Apache Mynewt" />
  <meta data-rh="true" name="description"
    content="Safer, simpler NB-IoT coding with Embedded Rust and Visual Studio Code" />
  <meta data-rh="true" property="og:description"
    content="Safer, simpler NB-IoT coding with Embedded Rust and Visual Studio Code" />
  <meta data-rh="true" property="twitter:description"
    content="Safer, simpler NB-IoT coding with Embedded Rust and Visual Studio Code" />
  <meta data-rh="true" name="twitter:card" content="summary_large_image" />
  <meta data-rh="true" name="twitter:creator" content="@MisterTechBlog" />
  <meta data-rh="true" name="author" content="Lup Yuen Lee 李立源" />
  <meta data-rh="true" name="robots" content="index,follow,max-image-preview:large" />
  <meta data-rh="true" name="referrer" content="unsafe-url" />
  <meta data-rh="true" name="twitter:label1" value="Reading time" />
  <meta data-rh="true" name="twitter:data1" value="22 min read" />
  <meta property="og:image" 
  content="https://lupyuen.github.io/images/legacy/y1.jpeg">


<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">

<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->

  </head>

<body>
  <div id="root">
    <div class="a b c">
      <article>
        <section class="ds dt du dv t dw bj w"></section><span class="w"></span>
        <div>
          <div class="dx dy dz ea eb ec"></div>
          <section class="dc ed ee cx ef">
            <div class="eg t">
              <div class="figure eh eg t paragraph-image">

                
                
                <p><img src="https://lupyuen.github.io/images/legacy/y1.jpeg" /></p>



            
                <figcaption><p><em>STM32 Blue Pill with Quectel BC95-G Global NB-IoT
                  Module and 18650 lithium ion battery</em></p></figcaption>
              </div>
            </div>
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <div>
                  <h1 id="9d4b"
                    class="fe da ff ap cp fg fh fi fj fk fl fm fn fo fp fq fr fs ft fu fv fw fx fy fz ga dh">Rust Rocks
                    NB-IoT! STM32 Blue Pill with Quectel BC95-G on Apache Mynewt</h1>
                  <div class="gb">
                    <div class="n cd gc gd ge">
                      <div class="o n">
                        <div><a rel="noopener"
                            href="https://lupyuen.github.io">
                            <div class="ab gf gg">
                              <div class="av n am o p dx gh gi gj gk gl ec"></div>
                              
                            </div>
                          </a></div>
                        <div class="di t n">
                          <div class="n">
                            <div style="flex:1"><span class="ap b aq ar dh"><a class="" rel="noopener"
                                  href="https://lupyuen.github.io">
                                  <h4 class="ap b aq ar as">Lup Yuen Lee 李立源</h4>
                                </a></span></div>
                          </div><span class="ap b aq ar br"><a class="" rel="noopener"
                              href="https://lupyuen.github.io/articles/rust-rocks-nb-iot-stm32-blue-pill-with-quectel-bc95-g-on-apache-mynewt">
                              <h4 class="ap b aq ar br"><span class="gn"></span>Aug 4, 2019<span class="go">·</span>22
                                min read</h4>
                            </a></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <p id="3a54" class="hb hc ff hd b he hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht hu dc dh"><em
                    class="hv">The year is 2029. Humans are populating the Moon, starting at </em><a class="dk hw"
                    rel="noopener"
                    href="https://lupyuen.github.io/articles/create-your-iot-gadget-with-apache-mynewt-and-stm32-blue-pill"><em
                      class="hv">Moon Base One</em></a><em class="hv">. Two Moon Base Operators are about to commit
                    another grave mistake in the crop garden of beautiful red tomatoes…</em></p>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik il im in io ip paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy/y2.png" /></p>

               
                  <figcaption><p><em>Tomato Crop and NB-IoT Sensors on Moon Base One
                  </em></p></figcaption>
                </div>
                <p id="0078" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <em class="hv">Operator 1</em>: After the <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/get-started-with-nb-iot-and-quectel-modules">last
                    IoT calamity</a> I’m glad we switched from MQTT to <strong class="hd cp">CoAP Servers connected by
                    NB-IoT</strong>. Now that we have added many sensors to our crop garden, our NB-IoT Sensors need to
                  transmit more efficiently. Can you change the <strong class="hd cp">CoAP payload from JSON to
                  </strong><a href="https://en.wikipedia.org/wiki/CBOR"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">CBOR</strong></a>?</p>
                <p id="8e47" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <em class="hv">Operator 2</em>: Sure th<span id="rmm">i</span>ng! Lemme look at the <a
                    href="https://tools.ietf.org/html/rfc7049" class="dk hw"
                    rel="noopener nofollow">specs of the CBOR binary format</a> and <strong class="hd cp">program the
                  </strong><a href="https://github.com/intel/tinycbor"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">CBOR encoder in C</strong></a>…</p>
                <p id="3ca4" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <em class="hv">Operator 1</em>: It’s already 2029! <strong class="hd cp">Why aren’t you using
                    Rust?</strong> Just call the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/mynewt/src/encoding/macros.rs"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">Rust Macro</strong></a> that encodes
                  CoAP payloads into JSON and CBOR!</p>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik iw ix iy iz ip">
          
                  <p><script src="https://gist.github.com/lupyuen/a9b8a17ea2833e99cfcd3028a74e5dce.js"></script></p>


                  <figcaption><p><em>Encoding CoAP Payloads in JSON and CBOR with a
                    Rust Macro. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_network.rs"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_network.rs</a>
                  </em></p></figcaption>
                </div>
                <p id="a14f" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <em class="hv">Operator 2</em>: <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/safer-simpler-embedded-rust-with-apache-mynewt-on-stm32-blue-pill"><strong
                      class="hd cp">Rust Macros can do so much</strong></a><strong class="hd cp">?</strong> Wow I did
                  not know that! Anyway I have finished the C programming for the new firmware. <strong
                    class="hd cp">I’ll push the new firmware to 1,000 sensors now</strong>…</p>
                <p id="cabb" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <em class="hv">Operator 1</em>: Great! Hold on… <strong class="hd cp">Our IoT Dashboards are going
                    crazy</strong>… <strong class="hd cp">Temperature 80 degrees Celsius? Humidity 25 percent?</strong>
                  WHAT HAPPENED??!!</p>
                <p id="db45" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <em class="hv">Operator 2</em>: OOPS I think the <strong class="hd cp">pointers are corrupted</strong>
                  in my C firmware… The Sensor Data was supposed to point to the string “<code
                    class="et jb jc jd je b">TEMPERATURE</code>”… But it got overwritten by “<code
                    class="et jb jc jd je b">HUMIDITY</code>”… Should have used <strong class="hd cp">safer, simpler
                    Rust</strong> instead of C…</p>
                <p id="5a49" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <em class="hv">Operator 1</em>: The Temperature and Humidity Sensor Data are <strong class="hd cp">ALL
                    MIXED UP</strong>!!! The sprinklers are <strong class="hd cp">spraying water</strong> on our
                  tomatoes! The ventilators are <strong class="hd cp">blowing cold air</strong> on them!</p>
                <p id="7451" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Our beautiful tomatoes are turning into… <strong class="hd cp">ICED TOMATOES</strong>!!! NOOOOO…</p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="3839" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  Why Embedded Rust instead of Embedded C?</h1>
                <p id="a517" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  We’re back in 2019… Hardly anyone writes embedded programs in Rust for microcontrollers (like STM32
                  Blue Pill), we all use C. But we really should switch to Rust! <em class="hv">Moon Base One</em> has
                  given us 2 key reasons…</p>
                <p id="886f" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  1️⃣ <strong class="hd cp">Complexity</strong>: Our gadgets are more powerful than ever before. They
                  can communicate via Bluetooth, WiFi, Zigbee, nRF, LoRa, Sigfox and now NB-IoT. Messaging formats are
                  getting more complicated with CoAP and CBOR. Embedded C wasn’t meant for handling such complexity.
                  <strong class="hd cp"><em class="hv">Rust is!</em></strong></p>
                <p id="d9a5" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  2️⃣ <strong class="hd cp">Safety</strong>: <em class="hv">With great power comes great
                    responsibility</em>… says the Great Arachnid. How do we ensure that our complex gadgets run non-stop
                  without crashing? We need something safer than Embedded C to prevent runaway pointers before they
                  happen… <strong class="hd cp"><em class="hv">Rust can!</em></strong></p>
                <p id="8f73" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <em class="hv">But have our gadgets already become so complex and unsafe and affordable that we need
                    Embedded Rust?</em></p>
                <p id="b509" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Well, take a look at this video demo… <code
                    class="et jb jc jd je b"><a href="https://youtu.be/MgK72dqwDuM" class="dk hw" rel="noopener nofollow">https://youtu.be/MgK72dqwDuM</a></code>
                </p>
              </div>
            </div>
            <div class="eg">
              <div class="n p">
                <div class="km kn ko kp kq kr ah ks ai kt ak t">
                  <div class="figure hy hz ia ib ic eg">

                    <p><a href="https://youtu.be/MgK72dqwDuM">[Watch video on YouTube]</a></p>


                    <figcaption><p><em>Demo of Embedded Rust on STM32 Blue Pill with
                      Quectel BC95-G Global NB-IoT Module</em></p></figcaption>
                  </div>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <p id="cb91" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/super-blue-pill-like-stm32-blue-pill-but-better"><strong
                      class="hd cp">STM32 Blue Pill</strong></a> with <a
                    href="https://www.quectel.com/product/bc95g.htm"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">Quectel BC95-G</strong></a> Global
                  NB-IoT Module… Runs a realtime operating system (<a
                    href="https://mynewt.apache.org/" class="dk hw"
                    rel="noopener nofollow"><strong class="hd cp">Apache Mynewt</strong></a>) that polls the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/rust-nbiot/libs/temp_stm32"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">internal temperature
                      sensor</strong></a><strong class="hd cp"> </strong>every<strong class="hd cp"> 10 seconds</strong>
                  <strong class="hd cp">concurrently</strong> while transmitting <a
                    href="https://rust-lang.github.io/rust-bindgen/"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">CoAP</strong></a> messages over <a
                    href="https://rust-lang.github.io/rust-bindgen/"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">NB-IoT</strong></a>… All built for
                  <strong class="hd cp">under $10</strong>… <strong class="hd cp">And managed flawlessly by </strong><a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/rust-nbiot/rust/app/src"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">Embedded Rust</strong></a>!</p>
                <p id="8e53" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This article uncovers the secrets of the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/rust-nbiot/rust/app/src"
                    class="dk hw" rel="noopener nofollow">Embedded Rust program</a> running on that Blue Pill… And how
                  how you can do the same! <em class="hv">If you’re new to Embedded Rust</em>, no worries, this will be
                  a friendly and gentle introduction to Embedded Rust… I promise!</p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="bc24" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  Overall Program Flow</h1>
                <p id="185c" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  This diagram illustrates the overall flow of the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/rust-nbiot/rust/app/src"
                    class="dk hw" rel="noopener nofollow">Embedded Rust program</a>. We’ll dive into each function now…
                </p>
              </div>
            </div>
            <div class="eg t">
              <div class="figure hy hz ia ib ic eg t paragraph-image">
                
                <p><img src="https://lupyuen.github.io/images/legacy/y3.png" /></p>

              
                <figcaption><p><em>Overall flow of our Embedded Rust program
                </em></p></figcaption>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="768c" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  Main Program: lib.rs</h1>
                <p id="bb17" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  Normally the Rust Compiler builds our Rust Programs starting at <code
                    class="et jb jc jd je b">main.rs</code>. In this case we’re building a Rust Library that will be
                  linked into the Apache Mynewt firmware, so the Rust Compiler starts at <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/lib.rs" class="dk hw" rel="noopener nofollow">lib.rs</a></code>
                  instead.</p>
                <div class="figure hy hz ia ib ic eg">

                  <p><script src="https://gist.github.com/lupyuen/9e687ec97a3d344a8d585115457b6f38.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/lib.rs#L24-L37"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/lib.rs#L24-L37</a>
                  </em></p></figcaption>
                </div>
                <p id="d1af" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  First thing in <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/lib.rs" class="dk hw" rel="noopener nofollow">lib.rs</a></code>…
                  <code class="et jb jc jd je b">#![no_std]</code>. This is absolutely essential for Embedded Rust
                  programs and libraries — it tells the Rust Compiler not to include the <a
                    href="https://doc.rust-lang.org/std/index.html"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">Rust Standard Library</strong></a>,
                  which contains code that is unnecessary for embedded devices. Think of the Rust Standard Library as
                  the C standard libraries <code class="et jb jc jd je b">stdio</code> + <code
                    class="et jb jc jd je b">stdlib</code> + …</p>
                <p id="33d6" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  When we specify <code class="et jb jc jd je b">#![no_std]</code>, the Rust Compiler includes a lighter
                  version of the standard library, known as the <a
                    href="https://doc.rust-lang.org/core/index.html"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">Rust Core Library</strong></a>. It
                  contains the bare minimum needed to run Rust applications.</p>
                <blockquote class="kw">
                  <p id="f850" class="kx ky ff ap kz la lb lc ld le lf hu br">Rust Externs and Modules</p>
                </blockquote>
                <p id="2c22" class="hb hc ff hd b he lg hf hg hh lh hi hj hk li hl hm hn lj ho hp hq lk hr hs hu dc dh">
                  <code class="et jb jc jd je b">extern crate</code> declares the external Rust Libraries (known as
                  Crates) that we’ll be using. External Crates are declared in <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/Cargo.toml" class="dk hw" rel="noopener nofollow">Cargo.toml</a></code>
                  and don’t need to be declared again here… Unless we’re using macros from these crates.</p>
                <p id="2a4f" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code class="et jb jc jd je b">mod app_sensor</code> tells the Rust Compiler that we have a Rust
                  module named <code class="et jb jc jd je b">app_sensor</code>, and the module’s source code may be
                  found in <code class="et jb jc jd je b">app_sensor.rs</code>.</p>
                <p id="1e56" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  If you remember how <code class="et jb jc jd je b">namespace</code> and <code
                    class="et jb jc jd je b">#include “…”</code> work in C++, <code
                    class="et jb jc jd je b">mod app_sensor</code> translates into something like this in C++…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="1bf9" class="dh lo jm ff je b de lp lq w lr">namespace app_sensor {<br/>    #include &quot;app_sensor.rs&quot;<br/>}</span></pre>
                <p id="249f" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Which means that the functions in <code class="et jb jc jd je b">app_sensor.rs</code> will be imported
                  in the module namespace <code class="et jb jc jd je b">app_sensor</code>. (We’ll see this later when
                  we study the macro expansions for our program.)</p>
                <p id="0358" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  We’ll soon discover that in Rust we use <code class="et jb jc jd je b">mod</code> often to pull in
                  Rust source files, which may use <code class="et jb jc jd je b">mod</code> to pull in other source
                  files, … That’s how we assemble a Rust program from a tree of Rust source files, starting at <code
                    class="et jb jc jd je b">lib.rs</code> or <code class="et jb jc jd je b">main.rs</code>.</p>
                <p id="ab6b" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code class="et jb jc jd je b">app_sensor</code> and <code class="et jb jc jd je b">app_network</code>
                  will be covered in the subsequent sections.</p>
                <div class="figure hy hz ia ib ic eg">

                  <p><script src="https://gist.github.com/lupyuen/5fc1e37b7bb8b4246448216ebb85d587.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/lib.rs#L38-L45"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/lib.rs#L38-L45</a>
                  </em></p></figcaption>
                </div>
                <p id="7607" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Next we tell the Rust Compiler which functions and types to import into this code file (lib.rs). We
                  could write <code class="et jb jc jd je b">core::panic::PanicInfo</code> in our code. But when we say
                  <code class="et jb jc jd je b">use core::panic::PanicInfo</code>, we can just refer to it later in our
                  code as <code class="et jb jc jd je b">PanicInfo</code>.</p>
                <p id="eedb" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code class="et jb jc jd je b">core</code> refers to the Rust Core Library. <code
                    class="et jb jc jd je b"><a href="https://docs.rs/cortex-m/0.6.0/cortex_m/" class="dk hw" rel="noopener nofollow">cortex_m</a></code>
                  is an external crate that has useful functions for Arm Cortex-M processors, like triggering debugger
                  breakpoints.</p>
                <p id="f31b" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/rust-nbiot/rust/mynewt" class="dk hw" rel="noopener nofollow">mynewt</a></code>
                  is a crate that contains Rust wrappers for the Mynewt API. That means we can call the Mynewt system
                  functions written in C — just use the Rust wrappers that have been provided. More about Rust safe
                  wrappers in a while.</p>
                <p id="8e49" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  In <code class="et jb jc jd je b">lib.rs</code> we’ll be calling some Mynewt kernel-level functions,
                  as well as the debugging console and the <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/build-your-iot-sensor-network-stm32-blue-pill-nrf24l01-esp8266-apache-mynewt-thethings-io"><strong
                      class="hd cp">Sensor Network Library</strong></a> that provides NB-IoT networking.</p>
                <blockquote class="kw">
                  <p id="6938" class="kx ky ff ap kz la lb lc ld le lf hu br">Rust Main Function</p>
                </blockquote>
                <div class="figure ls lt lu lv lw eg">

                  <p><script src="https://gist.github.com/lupyuen/7a2bb85940e8ec81bf7680872e892b4d.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/lib.rs#L46-L74"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/lib.rs#L46-L74</a>
                  </em></p></figcaption>
                </div>
                <p id="6ac3" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This is the <code class="et jb jc jd je b">main()</code> function — it works just like C.</p>
                <p id="5a43" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/mynewt/src/lib.rs#L36-L41" class="dk hw" rel="noopener nofollow">mynewt::sysinit</a>()</code>
                  is called to start up the Mynewt OS system functions and drivers, like the driver for the Blue Pill
                  internal temperature sensor.</p>
                <p id="a1ed" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code class="et jb jc jd je b">app_sensor::start_sensor_listener()</code> is defined in the <code
                    class="et jb jc jd je b">app_sensor</code> module (explained below). This function tells Mynewt to
                  poll the internal temperature sensor every 10 seconds.</p>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik iw ix iy iz ip">
              
                  <p><script src="https://gist.github.com/lupyuen/2bda837f4ceeb1215cbd082de8b09587.js"></script></p>


                  <figcaption><p><em>Quectel BC95-G driver sends AT commands to
                    connect to NB-IoT. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/standalone-node.log#L90-L100"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/standalone-node.log#L90-L100</a>
                  </em></p></figcaption>
                </div>
                <p id="7f94" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/libs/sensor_network/src/sensor_network.c#L136-L143" class="dk hw" rel="noopener nofollow">sensor_network::start_server_transport</a>()</code>
                  tells the Sensor Network Library to start the NB-IoT network.</p>
                <p id="5576" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/rust-nbiot/libs/bc95g"
                    class="dk hw" rel="noopener nofollow">NB-IoT Driver</a> starts sending <a class="dk hw"
                    rel="noopener"
                    href="https://lupyuen.github.io/articles/get-started-with-nb-iot-and-quectel-modules">AT
                    commands</a> to the NB-IoT Module (Quectel BC95-G), and waits for successful connection to the
                  NB-IoT network.</p>
                <p id="bc68" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This happens in the background, so other functions may continue running, like polling the temperature
                  sensor.</p>
                <blockquote class="kw">
                  <p id="282f" class="kx ky ff ap kz la lb lc ld le lf hu br">Check Rust Errors with Expect</p>
                </blockquote>
                <p id="8ed5" class="hb hc ff hd b he lg hf hg hh lh hi hj hk li hl hm hn lj ho hp hq lk hr hs hu dc dh">
                  Note the curious way that we’re calling the functions followed by <code
                    class="et jb jc jd je b"><a href="https://learning-rust.github.io/docs/e4.unwrap_and_expect.html" class="dk hw" rel="noopener nofollow">expect</a>()</code>…
                </p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="0e2a" class="dh lo jm ff je b de lp lq w lr">app_sensor::start_sensor_listener()<br/>    .expect(&quot;TMP fail&quot;);</span></pre>
                <p id="c5ef" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This actually means “<em class="hv">call the function</em> <code
                    class="et jb jc jd je b">start_sensor_listener()</code>, <em class="hv">and if it</em> <strong
                    class="hd cp">FAILS</strong>, <em class="hv">show the message </em><code
                    class="et jb jc jd je b">TMP fail</code>”. So it certainly doesn’t mean that we <code
                    class="et jb jc jd je b">expect</code> the function to fail!</p>
                <p id="4685" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This is an unusual Rust coding convention. But thankfully we’ll see <code
                    class="et jb jc jd je b">expect</code> only in the <code class="et jb jc jd je b">main()</code>
                  function. In other functions we’ll use a simpler way to check for failures… the question-mark
                  operator: <code class="et jb jc jd je b">?</code></p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="aff2" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  Sensor Functions: app_sensor.rs</h1>
                <div class="figure hy hz ia ib ic eg">
          
                  <p><script src="https://gist.github.com/lupyuen/84dabf772a3cd21bfa14eadde2b9a477.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L37-L45"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L37-L45</a>
                  </em></p></figcaption>
                </div>
                <p id="0424" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs" class="dk hw" rel="noopener nofollow">app_sensor.rs</a></code>
                  configures Mynewt to poll Blue Pill’s internal temperature sensor every 10 seconds. At the top we
                  define the constants…</p>
                <p id="a325" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  ▶️ <code class="et jb jc jd je b">SENSOR_DEVICE</code>: Name of the sensor that we’ll be polling. Each
                  sensor in Mynewt is assigned a name by the sensor’s driver. We’ll be using Blue Pill’s internal
                  temperature sensor, named <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/rust-nbiot/libs/temp_stm32" class="dk hw" rel="noopener nofollow">temp_stm32_0</a></code>
                </p>
                <p id="cf2a" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Note that <code class="et jb jc jd je b">SENSOR_DEVICE</code> has type <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/mynewt/src/lib.rs#L96-L206" class="dk hw" rel="noopener nofollow">Strn</a></code>,
                  which refers to a null-terminated string. Although Rust has two types of strings (<code
                    class="et jb jc jd je b">str</code> and <code class="et jb jc jd je b">String</code>), I created
                  <code class="et jb jc jd je b">Strn</code> because it works more efficiently with Mynewt.</p>
                <p id="f373" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Unlike Rust strings, <code class="et jb jc jd je b">Strn</code> strings are always null-terminated. So
                  we prevent excessive copying of strings when passing <code class="et jb jc jd je b">Strn</code> to
                  Mynewt and back. <code class="et jb jc jd je b">Strn</code> may be passed directly into Mynewt APIs
                  like this…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="5fe0" class="dh lo jm ff je b de lp lq w lr">//  Set the sensor polling time to 10 seconds.<br/>sensor::set_poll_rate_ms(<br/>    &amp;SENSOR_DEVICE, SENSOR_POLL_TIME) ? ;</span></pre>
                <p id="dd68" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/macros/src/lib.rs#L121-L147" class="dk hw" rel="noopener nofollow">init_strn!</a>()</code>
                  is a Rust Macro that initialises a <code class="et jb jc jd je b">Strn</code> and terminates the
                  string with null. How do we know it’s a Rust Macro? Because it has <code
                    class="et jb jc jd je b">!</code> in its name. Rust Macros are similar to C Macros, but much more
                  powerful.</p>
                <p id="07ce" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  ▶️ <code class="et jb jc jd je b">SENSOR_POLL_TIME</code>: How often Mynewt should poll the sensor, in
                  milliseconds. We’ll be polling the temperature sensor every 10 seconds, so we set this value to
                  10,000.</p>
                <p id="e5b9" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  ▶️ <code class="et jb jc jd je b">TEMP_SENSOR_KEY</code>: When transmitting the temperature sensor
                  value to the server, we’ll use <code class="et jb jc jd je b">t</code> as the name of the sensor
                  value.</p>
                <p id="9ffd" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  ▶️ <code class="et jb jc jd je b">TEMP_SENSOR_TYPE</code>: This declares the type of sensor data,
                  which will be a raw temperature value. Although we could transmit the temperature as a decimal or
                  floating-point number like <code class="et jb jc jd je b">28.9</code> degrees Celsius, it’s more
                  efficient to transmit the raw temperature as an integer like <code
                    class="et jb jc jd je b">1925</code>.</p>
                <p id="8e02" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This eliminates the need to install floating-point libraries on the device. We’ll convert the raw
                  temperature into actual temperature at the CoAP Server.</p>
                <blockquote class="kw">
                  <p id="fc3e" class="kx ky ff ap kz la lb lc ld le lf hu br">Poll The Sensor with Mynewt Sensor
                    Framework</p>
                </blockquote>
                <div class="figure ls lt lu lv lw eg">
             
                  <p><script src="https://gist.github.com/lupyuen/010dde316e1eae5df7b5c1aa6d0827db.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L46-L53"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L46-L53</a>
                  </em></p></figcaption>
                </div>
                <p id="7686" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Mynewt provides an elegant way to manage IoT sensors and it truly shines here. Recall that <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L46-L71" class="dk hw" rel="noopener nofollow">start_sensor_listener</a>()</code>
                  is called by <code class="et jb jc jd je b">main()</code> to poll the temperature sensor. How do we
                  instruct Mynewt to poll our temperature sensor every 10 seconds? Easy — just call <code
                    class="et jb jc jd je b"><a href="https://mynewt.apache.org/latest/os/modules/sensor_framework/sensor_mgr_api.html#c.sensor_set_poll_rate_ms" class="dk hw" rel="noopener nofollow">sensor::set_poll_rate_ms</a>()</code>
                  like above.</p>
                <p id="fd82" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  In Mynewt’s <a
                    href="https://mynewt.apache.org/latest/os/modules/sensor_framework/sensor_framework.html"
                    class="dk hw" rel="noopener nofollow">Sensor Framework</a>, Mynewt is aware of all sensors installed
                  (like <code class="et jb jc jd je b">temp_stm32_0</code>, our temperature sensor) and the type of
                  sensor data each sensor will return (like raw temperature). So Mynewt is capable of polling sensors
                  for sensor data on its own… But it needs to know what to do with the polled data.</p>
                <div class="figure hy hz ia ib ic eg">
           
                  <p><script src="https://gist.github.com/lupyuen/adafe34e894ed2dff6cc4fbff2fe0186.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L54-L57"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L54-L57</a>
                  </em></p></figcaption>
                </div>
                <p id="1436" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  To answer that, we call <code
                    class="et jb jc jd je b"><a href="https://mynewt.apache.org/latest/os/modules/sensor_framework/sensor_mgr_api.html#c.sensor_mgr_find_next_bydevname" class="dk hw" rel="noopener nofollow">sensor::mgr_find_next_bydevname</a>()</code>
                  to fetch the sensor object for our temperature sensor. For safety, we check that returned sensor
                  object pointer is not null.</p>
                <blockquote class="kw">
                  <p id="b758" class="kx ky ff ap kz la lb lc ld le lf hu br">Define Sensor Listener with Rust Struct
                  </p>
                </blockquote>
                <div class="figure ls lt lu lv lw eg">
           
                  <p><script src="https://gist.github.com/lupyuen/56e07e285ff87a4548e3fecfb1732f38.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L58-L64"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L58-L64</a>
                  </em></p></figcaption>
                </div>
                <p id="09fe" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Then we define a <code
                    class="et jb jc jd je b"><a href="https://mynewt.apache.org/latest/os/modules/sensor_framework/sensor_listener_api.html#data-structures" class="dk hw" rel="noopener nofollow">sensor_listener</a></code>,
                  the function that Mynewt will call whenever it has fetched the sensor data. We declare to Mynewt that
                  the function (called the <strong class="hd cp">Listener Function</strong>) accepts temperature sensor
                  values (<code class="et jb jc jd je b">TEMP_SENSOR_TYPE</code>).</p>
                <p id="70d7" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The Listener Function is named <code class="et jb jc jd je b">handle_sensor_data()</code> and we’ll
                  see it in a while. We call <code class="et jb jc jd je b">sensor::as_untyped()</code> to do some
                  translation from Rust to C, because callback functions like <code
                    class="et jb jc jd je b">handle_sensor_data()</code> are defined differently in Rust and C.</p>
                <p id="e224" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  If we look at the way <code class="et jb jc jd je b">listener</code> is defined as a <code
                    class="et jb jc jd je b">sensor_listener</code>…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="b925" class="dh lo jm ff je b de lp lq w lr">let listener = <strong class="je cp">sensor_listener</strong> { ... };</span></pre>
                <p id="915f" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Looks familiar? <code class="et jb jc jd je b">sensor_listener</code> is actually a <code
                    class="et jb jc jd je b"><a href="https://doc.rust-lang.org/book/ch05-01-defining-structs.html" class="dk hw" rel="noopener nofollow">struct</a></code>
                  type! In C++ we would write this as…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="c999" class="dh lo jm ff je b de lp lq w lr"><strong class="je cp">sensor_listener</strong> listener = { ... };</span></pre>
                <p id="18de" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code class="et jb jc jd je b">structs</code> in Rust work the same way as <code
                    class="et jb jc jd je b">structs</code> in C and C++. But unlike C and C++, Rust also supports this
                  interesting construct…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="2275" class="dh lo jm ff je b de lp lq w lr">let listener = sensor_listener {<br/>    sl_sensor_type: ... ,<br/>    sl_func:        ... ,</span><span id="4a55" class="dh lo jm ff je b de lx ly lz ma mb lq w lr">    //  Set other fields to 0<br/>    <strong class="je cp">..fill_zero!(sensor_listener)</strong><br/>};</span></pre>
                <p id="cf4e" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code class="et jb jc jd je b">..</code> means “<a
                    href="https://doc.rust-lang.org/book/ch05-01-defining-structs.html"
                    class="dk hw" rel="noopener nofollow"><em class="hv">copy the remaining fields from the following
                      object</em></a>”. The object after <code class="et jb jc jd je b">..</code> happens to be <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/mynewt/src/util/macros.rs#L8-L49" class="dk hw" rel="noopener nofollow">fill_zero!</a>(sensor_listener)</code>,
                  a Rust Macro that generates an empty <code class="et jb jc jd je b">sensor_listener</code> with all
                  fields zeroed out. So the result…</p>
                <p id="05b9" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  1️⃣ We set <code class="et jb jc jd je b">listener</code> to an instance of <code
                    class="et jb jc jd je b">sensor_listener</code>…</p>
                <p id="1814" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  2️⃣ And we set in <code class="et jb jc jd je b">listener</code> the <code
                    class="et jb jc jd je b">sl_sensor_type</code> and <code class="et jb jc jd je b">sl_func</code>
                  fields shown above…</p>
                <p id="576e" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  3️⃣ And we set the remaining fields of <code class="et jb jc jd je b">listener</code> to <code
                    class="et jb jc jd je b">0</code></p>
                <p id="0263" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This is a handy construct (similar to <a
                    href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax"
                    class="dk hw" rel="noopener nofollow">JavaScript’s … operator</a>) to assure ourselves that the
                  remaining fields in the <code class="et jb jc jd je b">struct</code> are initialised to some known
                  value. Otherwise the remaining fields will become assigned to some unknown value from the stack and
                  cause runtime errors. In fact, the Rust Compiler refuses to compile this code…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="ce3f" class="dh lo jm ff je b de lp lq w lr">let listener = sensor_listener {<br/>    sl_sensor_type: ... ,<br/>    sl_func:        ... ,<br/>    <strong class="je cp">//  What about the other fields?</strong><br/>};</span></pre>
                <p id="71aa" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Because the compiler knows that <code class="et jb jc jd je b">sensor_listener</code> contains other
                  fields that we have not initialised. And that’s the really cool thing about Rust — <em class="hv">it
                    genuinely cares about our </em><strong class="hd cp"><em class="hv">Safety</em></strong><em
                    class="hv"> and it will do anything it can to prevent our programs from crashing! </em>We’ll see
                  many examples of Safe Coding in Rust in a while.</p>
                <blockquote class="kw">
                  <p id="a33e" class="kx ky ff ap kz la lb lc ld le lf hu br">Register Sensor Listener with Mynewt
                    Sensor Framework</p>
                </blockquote>
                <div class="figure ls lt lu lv lw eg">
              
                  <p><script src="https://gist.github.com/lupyuen/a8cf138a9d9c755132aaf187501e4a86.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L65-L71"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L65-L71</a>
                  </em></p></figcaption>
                </div>
                <p id="06d8" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Finally we call <code
                    class="et jb jc jd je b"><a href="https://mynewt.apache.org/latest/os/modules/sensor_framework/sensor_listener_api.html#c.sensor_register_listener" class="dk hw" rel="noopener nofollow">sensor::register_listener</a>()</code>
                  to register our Listener Function for the sensor. Mynewt will call our Listener Function <code
                    class="et jb jc jd je b">handle_sensor_data()</code> every 10 seconds after fetching the temperature
                  sensor data.</p>
                <blockquote class="kw">
                  <p id="a171" class="kx ky ff ap kz la lb lc ld le lf hu br">Return Result in Rust</p>
                </blockquote>
                <p id="8018" class="hb hc ff hd b he lg hf hg hh lh hi hj hk li hl hm hn lj ho hp hq lk hr hs hu dc dh">
                  In Rust, functions are expected to return the <code class="et jb jc jd je b">Result</code> type which
                  contains either a result value or a failure code. Hence <code
                    class="et jb jc jd je b">start_sensor_listener()</code> is declared as…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="1cb5" class="dh lo jm ff je b de lp lq w lr">pub fn start_sensor_listener() <br/>    -&gt; <strong class="je cp">MynewtResult&lt;()&gt;</strong>  <br/>    { ... }</span></pre>
                <p id="f933" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Which tells the Rust Compiler that <code class="et jb jc jd je b">start_sensor_listener()</code> will
                  return a <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/mynewt/src/lib.rs#L42-L95" class="dk hw" rel="noopener nofollow">MynewtResult</a></code>
                  type. What’s the result value for this function? <code
                    class="et jb jc jd je b">start_sensor_listener()</code> works like a <code
                    class="et jb jc jd je b">void</code> function in C… it doesn’t return any values. It returns
                  nothing.</p>
                <p id="651b" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  In Rust we write “nothing” as <code class="et jb jc jd je b">()</code>. Therefore the function returns
                  <code class="et jb jc jd je b">MynewtResult&lt;()&gt;</code>, a generic result that contains either
                  “nothing” or an error code. How do we return “nothing” at the end of the function?</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="c8cc" class="dh lo jm ff je b de lp lq w lr">pub fn start_sensor_listener() <br/>    -&gt; <strong class="je cp">MynewtResult&lt;()&gt;</strong> {<br/>    ...<br/>    //  Return `Ok()` to indicate success.  <br/>    //  This line should not end with a semicolon (;).<br/>    Ok(())<br/>}</span></pre>
                <p id="a01c" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  If this function is expected to return <code class="et jb jc jd je b">123</code> we would write it as
                  <code class="et jb jc jd je b">Ok(123)</code>. But since this function returns “nothing”, we write it
                  as <code class="et jb jc jd je b">Ok(())</code>. Which means “<em class="hv">yes this function has
                    completed successfully, but we don’t have a result value</em>”.</p>
                <p id="e9ab" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  When we return <code class="et jb jc jd je b">Ok(...)</code> at the end of a function, make sure that
                  we don’t add a semicolon <code class="et jb jc jd je b">;</code>. That’s because the Rust Compiler
                  treats a block of code like a sushi conveyor belt that unveils statement after statement… separated by
                  a semicolon <code class="et jb jc jd je b">;</code>.</p>
                <p id="5ecd" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The final statement <code class="et jb jc jd je b">Ok(...)</code> is the result value for the entire
                  sushi conveyor belt… er… function. In fact, returning <code class="et jb jc jd je b">Ok(...)</code>
                  like this…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="3d2b" class="dh lo jm ff je b de lp lq w lr">    ...<br/>    <strong class="je cp">Ok(123)</strong><br/>}</span></pre>
                <p id="a252" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  …is actually equivalent to a return statement plus semicolon…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="aeb5" class="dh lo jm ff je b de lp lq w lr">    ...<br/>    <strong class="je cp">return Ok(123);</strong><br/>}</span></pre>
                <p id="a335" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Both are perfectly valid in Rust. But of course I’ll choose the shorter version. When we call
                  functions that return <code class="et jb jc jd je b">Result</code>, we add a question mark <code
                    class="et jb jc jd je b">?</code> like this…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="d310" class="dh lo jm ff je b de lp lq w lr">//  Set the sensor polling time to 10 seconds<br/>sensor::set_poll_rate_ms(&amp;SENSOR_DEVICE, SENSOR_POLL_TIME) <strong class="je cp">?</strong> ;</span></pre>
                <p id="7234" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This means “<em class="hv">check the result of</em> <code
                    class="et jb jc jd je b">sensor::set_poll_rate_ms()</code> <em class="hv">and if it’s an error, stop
                    the current function and return the error code to the caller</em>”. It’s easy to miss the question
                  mark <code class="et jb jc jd je b">?</code> so I make it highly conspicuous by surrounding it with
                  spaces.</p>
                <blockquote class="kw">
                  <p id="c048" class="kx ky ff ap kz la lb lc ld le lf hu br">Handle Sensor Data with Rust Pattern
                    Matching</p>
                </blockquote>
                <div class="figure ls lt lu lv lw eg">
             
                  <p><script src="https://gist.github.com/lupyuen/c2fdaf581bad378233b5b5d3c7e5b6a1.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L72-L103"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L72-L103</a>
                  </em></p></figcaption>
                </div>
                <p id="5fd1" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L72-L103" class="dk hw" rel="noopener nofollow">handle_sensor_data</a>()</code>
                  is the Listener Function that’s called by Mynewt after it has polled the temperature sensor. It calls
                  <code class="et jb jc jd je b">convert_sensor_data()</code> to convert the sensor data from Mynewt’s
                  format to our own transmission format. More about this in a while.</p>
                <p id="4345" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Then it calls <code class="et jb jc jd je b">send_sensor_data()</code> to transmit the converted
                  sensor data. (We’ll learn more in the next section.) <code
                    class="et jb jc jd je b">send_sensor_data()</code> is called like this…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="f5ae" class="dh lo jm ff je b de lp lq w lr">let result = send_sensor_data(&amp;sensor_value);</span><span id="1ee6" class="dh lo jm ff je b de lx ly lz ma mb lq w lr">//  `if let` will assign `<!-- -->error_code<!-- -->` to<br/>//  the error code inside `result`<br/><strong class="je cp">if let Err(</strong><strong class="je cp">error_code</strong><strong class="je cp">) = result</strong> {</span><span id="80f5" class="dh lo jm ff je b de lx ly lz ma mb lq w lr">    //  Check the error code<br/>    if <!-- -->error_code<!-- --> == MynewtError::SYS_EAGAIN {<br/>        ...<br/>    }<br/>}</span></pre>
                <p id="1248" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code class="et jb jc jd je b">send_sensor_data()</code> returns the <code
                    class="et jb jc jd je b">MynewtResult&lt;()&gt;</code> type, which contains…</p>
                <p id="c530" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  1️⃣ Either <code class="et jb jc jd je b">Ok(())</code>, which means no error and nothing to return…
                </p>
                <p id="4ba2" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  2️⃣ Or <code class="et jb jc jd je b">Err(error_code)</code>, which is an error code</p>
                <p id="21a4" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Which is it? Let’s use <strong class="hd cp">Rust </strong><a
                    href="https://doc.rust-lang.org/book/ch06-03-if-let.html"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">Pattern Matching</strong></a>! This
                  <code class="et jb jc jd je b">if let</code> condition…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="8738" class="dh lo jm ff je b de lp lq w lr">if let <strong class="je cp">Err(</strong><strong class="je cp">error_code</strong><strong class="je cp">) = result</strong> { ... }</span></pre>
                <p id="1f6e" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  …will fail if the <code class="et jb jc jd je b">result</code> is <code
                    class="et jb jc jd je b">Ok(())</code>. So that eliminates option 1️⃣. What about the error code for
                  option 2️⃣?</p>
                <p id="adfb" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  When we match the pattern <code class="et jb jc jd je b">Err(error_code)</code> with <code
                    class="et jb jc jd je b">result</code>, we actually bind <code
                    class="et jb jc jd je b">error_code</code> to the error code inside <code
                    class="et jb jc jd je b">result</code>.</p>
                <p id="7aa1" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  So subsequently we may check the value of <code class="et jb jc jd je b">error_code</code> like this…
                </p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="57e5" class="dh lo jm ff je b de lp lq w lr">if <strong class="je cp">error_code</strong> == MynewtError::SYS_EAGAIN { ... }</span></pre>
                <p id="b2d4" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  That’s how we use Rust Pattern Matching to check error codes in <code
                    class="et jb jc jd je b">Results</code>! If we’re not really interested in the error code, just use
                  the question mark <code class="et jb jc jd je b">?</code> to check for success or failure.</p>
                <blockquote class="kw">
                  <p id="062e" class="kx ky ff ap kz la lb lc ld le lf hu br">Convert Sensor Data with Rust Pattern
                    Matching</p>
                </blockquote>
                <div class="figure ls lt lu lv lw eg">
             
                  <p><script src="https://gist.github.com/lupyuen/aa6632ea1f989d7036f9e44d86fb735a.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L104-L127"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L104-L127</a>
                  </em></p></figcaption>
                </div>
                <p id="3670" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L104-L127" class="dk hw" rel="noopener nofollow">convert_sensor_data</a>()</code>
                  is a beautiful function that could only happen in Rust, not C. Recall that it converts sensor data
                  from Mynewt’s format to our own transmission format. The structure of the function looks interesting…
                </p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="c04c" class="dh lo jm ff je b de lp lq w lr">fn convert_sensor_data(...) -&gt; SensorValue {</span><span id="1c94" class="dh lo jm ff je b de lx ly lz ma mb lq w lr">    //  Construct and return a new `SensorValue` (without semicolon)<br/>    SensorValue {<br/>        key: &quot;t&quot;,<br/>        val: ...<br/>    }<br/>}</span></pre>
                <p id="125a" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Remember the <code class="et jb jc jd je b">Ok(...)</code> trick for <strong class="hd cp">returning
                    things without semicolon</strong> from the sushi conveyor belt… er… function? We’re using it here!
                  We construct a <code class="et jb jc jd je b">struct</code> with <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/mynewt/src/hw/sensor.rs#L146-L175" class="dk hw" rel="noopener nofollow">SensorValue</a> { ... }</code>.
                  Then we return the <code class="et jb jc jd je b">struct</code>, semicolon-less!</p>
                <p id="5111" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Now look closely what’s inside <code class="et jb jc jd je b">val</code>…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="1a97" class="dh lo jm ff je b de lp lq w lr">//  Construct and return a new `SensorValue` (without semicolon)<br/>SensorValue {<br/>    key: &quot;t&quot;,<br/>    <strong class="je cp">val: match sensor_type</strong> {<br/>        //  If this is raw temperature...<br/>        SENSOR_TYPE_AMBIENT_TEMPERATURE_RAW =&gt; {  <br/>            //  Get the raw temperature<br/>            let mut raw = fill_zero!(sensor_temp_raw_data);<br/>            let rc = unsafe { <br/>                sensor::get_temp_raw_data(<br/>                    sensor_data, &amp;mut raw) <br/>            };<br/>            //  Return the raw temperature<br/>            <strong class="je cp">SensorValueType::Uint( raw.strd_temp_raw )</strong><br/>        }<br/>        //  Unknown type of sensor value<br/>        //  _ =&gt; { assert!(false, &quot;sensor type&quot;); ... } <br/>    }<br/>}</span></pre>
                <p id="b27a" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Does <code class="et jb jc jd je b">match</code> look familiar? Yes it looks like <code
                    class="et jb jc jd je b">switch ... case</code> in C! But in Rust, <code
                    class="et jb jc jd je b">match</code> can return values like this…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="c9da" class="dh lo jm ff je b de lp lq w lr">    ...<br/>    //  Return the raw temperature<br/>    SensorValueType::Uint( raw.strd_temp_raw )<br/>}</span></pre>
                <p id="e0b5" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Again we used the <strong class="hd cp">disappearing semicolon trick</strong> to return a value inside
                  <code class="et jb jc jd je b">match</code>.</p>
                <p id="af75" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  What’s <code class="et jb jc jd je b">SensorValueType::Uint</code>? That’s an <code
                    class="et jb jc jd je b"><a href="https://doc.rust-lang.org/book/ch06-01-defining-an-enum.html" class="dk hw" rel="noopener nofollow">enum</a></code>.
                  And as expected, Rust <code class="et jb jc jd je b">enums</code> are more powerful than <code
                    class="et jb jc jd je b">enums</code> in C… <strong class="hd cp">Rust </strong><code
                    class="et jb jc jd je b"><strong class="hd cp">enums</strong></code><strong class="hd cp"> can
                    contain values</strong> (like <code class="et jb jc jd je b">raw.strd_temp_raw</code>)!</p>
                <p id="0afe" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Remember our friends <code class="et jb jc jd je b">Ok(...)</code> and <code
                    class="et jb jc jd je b">Err(...)</code>? They are <code class="et jb jc jd je b">enums</code> too!
                  Yes <code class="et jb jc jd je b">enums</code> are shockingly powerful in Rust. (Then again,
                  everything in Rust is shockingly powerful!)</p>
                <p id="27c2" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The pattern <code class="et jb jc jd je b">_ =&gt; ...</code> at the end of <code
                    class="et jb jc jd je b">match</code> is identical to the <code
                    class="et jb jc jd je b">default</code> construct in C’s <code
                    class="et jb jc jd je b">switch ... case</code> statement (it matches everything else).</p>
                <p id="10b9" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  But the Rust Compiler is super intelligent in deducing that <code
                    class="et jb jc jd je b">sensor_type</code> has one and only one possible pattern: <code
                    class="et jb jc jd je b">SENSOR_TYPE_AMBIENT_TEMPERATURE_RAW</code>. So the Rust Compiler refuses to
                  accept the default pattern <code class="et jb jc jd je b">_</code>. (And hence I have commented it
                  out.)</p>
                <blockquote class="kw">
                  <p id="c537" class="kx ky ff ap kz la lb lc ld le lf hu br">Code Safety in Rust</p>
                </blockquote>
                <div class="figure ls lt lu lv lw eg">
               
                  <p><script src="https://gist.github.com/lupyuen/5df3e8f5891f836dbd97d48f8ff8fe02.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L114-L121"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L114-L121</a>
                  </em></p></figcaption>
                </div>
                <p id="b538" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  More reminders from <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_sensor.rs#L104-L127" class="dk hw" rel="noopener nofollow">convert_sensor_data</a>()</code>
                  that the Rust Compiler really cares about our Safety…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="1cc0" class="dh lo jm ff je b de lp lq w lr">let <strong class="je cp">mut</strong> raw = ...</span></pre>
                <p id="c3ae" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code class="et jb jc jd je b">mut</code> (mutable) declares to the Rust Compiler that <code
                    class="et jb jc jd je b">raw</code> is a variable that will be changed. The Rust Compiler assumes
                  that<strong class="hd cp"> all variables are </strong><code
                    class="et jb jc jd je b"><strong class="hd cp">const</strong></code><strong class="hd cp"> and will
                    not be changed</strong>, unless we declare them as <code class="et jb jc jd je b">mut</code>.</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="d241" class="dh lo jm ff je b de lp lq w lr">sensor::get_temp_raw_data(sensor_data, <strong class="je cp">&amp;mut</strong> raw)</span></pre>
                <p id="854b" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  We write <code class="et jb jc jd je b">&amp;mut</code> to pass a variable to a function that’s
                  expected to change the variable. So <code class="et jb jc jd je b">sensor::get_temp_raw_data()</code>
                  is expected to change the value of <code class="et jb jc jd je b">raw</code> above.</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="596f" class="dh lo jm ff je b de lp lq w lr">let rc = <strong class="je cp">unsafe</strong> { <br/>    sensor::get_temp_raw_data( ... ) <br/>};</span></pre>
                <p id="9ba7" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This ought to alarm us… We are calling a function <code
                    class="et jb jc jd je b">sensor::get_temp_raw_data()</code> that’s <strong
                    class="hd cp">Unsafe</strong>! This function is declared <code
                    class="et jb jc jd je b">unsafe</code> because it’s a C function that could cause our program to
                  crash.</p>
                <p id="9bf4" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Unlike the other Mynewt C functions, I haven’t constructed a Safe Wrapper yet for <code
                    class="et jb jc jd je b">sensor::get_temp_raw_data()</code>, so we have to call it the Unsafe way.
                  <code class="et jb jc jd je b">unsafe</code> is a good way to tag C functions that require closer
                  inspection before calling them.</p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="1cfc" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  Network Functions: app_network.rs</h1>
                <p id="843c" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_network.rs" class="dk hw" rel="noopener nofollow">app_network.rs</a></code>
                  contains the functions for transmitting sensor data to the <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/get-started-with-nb-iot-and-quectel-modules">CoAP
                    Server</a> over NB-IoT. We’re using the CoAP Server hosted at thethings.io.</p>
                <div class="figure hy hz ia ib ic eg">
             
                  <p><script src="https://gist.github.com/lupyuen/007cb9ca0764d435ae8875705a2504c9.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_network.rs#L39-L62"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_network.rs#L39-L62</a>
                  </em></p></figcaption>
                </div>
                <p id="2910" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code class="et jb jc jd je b">send_sensor_data()</code> is called by <code
                    class="et jb jc jd je b">handle_sensor_data()</code> to transmit the polled sensor data from the
                  temperature sensor.</p>
                <p id="57d7" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  It calls <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/libs/sensor_network/src/sensor_network.c#L385-L402" class="dk hw" rel="noopener nofollow">sensor_network::get_device_id</a>()</code>
                  to fetch the randomly-generated device ID. This device ID changes each time we restart the device.
                  We’ll transmit the device ID to thethings.io so that we can see the sensor data for our device.</p>
                <p id="5c38" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/libs/sensor_network/src/sensor_network.c#L241-L250" class="dk hw" rel="noopener nofollow">sensor_network::init_server_post</a>()</code>
                  prepares the memory buffers to compose a new CoAP message. In embedded devices like Blue Pill, we have
                  limited RAM so we can’t compose two CoAP messages at the same time. Hence <code
                    class="et jb jc jd je b">init_server_post()</code> uses a locking Mynewt semaphore to ensure that
                  only one task is composing a CoAP message at any time.</p>
                <p id="c4ad" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Remember that the connection to NB-IoT is established by a background task. There’s a chance that the
                  connection isn’t ready yet. If it’s not ready, we return <code
                    class="et jb jc jd je b">Err( MynewtError::SYS_EAGAIN )</code> to ask the Listener Function to retry
                  later. That’s how we return an error code <code class="et jb jc jd je b">SYS_EAGAIN</code> as a <code
                    class="et jb jc jd je b">Result</code> type in Rust.</p>
                <p id="c74b" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Here comes the magical part of the entire program… How we actually compose a CoAP Message containing
                  the sensor data… And how we manage <strong class="hd cp">Intent vs Implementation</strong>…</p>
                <blockquote class="kw">
                  <p id="aaac" class="kx ky ff ap kz la lb lc ld le lf hu br">CoAP Intent vs Implementation</p>
                </blockquote>
                <div class="figure ls lt lu lv lw eg">
              
                  <p><script src="https://gist.github.com/lupyuen/56a093886a41f1fb3040e3dfe717a1a8.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_network.rs#L63-L76"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_network.rs#L63-L76</a>
                  </em></p></figcaption>
                </div>
                <p id="aef5" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The above Rust code shows our <strong class="hd cp">Intent</strong> clearly… We just want to transmit
                  2 items of data to the server:</p>
                <p id="d579" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  1️⃣ <strong class="hd cp">Device ID</strong>, which we’ll be using to view our sensor data. (In case
                  there are other devices transmitting at the same time)</p>
                <p id="ec51" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  2️⃣ <strong class="hd cp">Raw Temperature</strong>, which is a whole number from 0 to 4095</p>
                <p id="b0cb" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  What about the <strong class="hd cp">Implementation</strong>? Well that depends which server we’ll be
                  transmitting the message to. For thethings.io, the server expects a <strong class="hd cp">JSON
                    Payload</strong> in the CoAP Message like this…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="00dd" class="dh lo jm ff je b de lp lq w lr">{&quot;values&quot;:[<br/>    {&quot;key&quot;:&quot;device&quot;,<br/>         &quot;value&quot;:&quot;010203&quot;},<br/>    {&quot;key&quot;:&quot;t&quot;,   <br/>         &quot;value&quot;:1715}<br/>]}</span></pre>
                <p id="ccdd" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  It’s <strong class="hd cp">similar to our Intent</strong>, just that the<strong class="hd cp">
                    Implementation is different</strong>. And the above Rust code handles that! <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/mynewt/src/encoding/macros.rs" class="dk hw" rel="noopener nofollow">coap!</a>()</code>
                  is a Rust Macro I have written that generates the above JSON Payload given the <code
                    class="et jb jc jd je b">device_id</code> and <code class="et jb jc jd je b">val</code> values.</p>
                <p id="36f5" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <em class="hv">Why is this Intent vs Implementation distinction important?</em></p>
                <p id="8cee" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  As I’m writing this, thethings.io is preparing to launch <a
                    href="https://en.wikipedia.org/wiki/CBOR" class="dk hw"
                    rel="noopener nofollow">CBOR</a> support for their CoAP Server. As we have seen on <em
                    class="hv">Moon Base One</em>, CBOR promises to shrink our CoAP Messages because we will no longer
                  use inefficient JSON Payload encoding… we will use compressed, binary CBOR Payload encoding instead!
                </p>
                <p id="407a" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Guess What? The <code class="et jb jc jd je b">coap!()</code> macro is ready to generate CBOR Payloads
                  based on the same code! All we need to do is to replace “<code class="et jb jc jd je b">@json</code>”
                  by “<code class="et jb jc jd je b">@cbor</code>” and the rest happens like magic!</p>
                <p id="6fb8" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Same for your own CoAP Server — you should be able to tweak the <code
                    class="et jb jc jd je b">coap!()</code> macro to support the encoding format required by your
                  server. This level of Intent vs Implementation separation is not possible with C Macros, only with
                  Rust Macros.</p>
                <blockquote class="kw">
                  <p id="b7dc" class="kx ky ff ap kz la lb lc ld le lf hu br">Multitasking with Mynewt</p>
                </blockquote>
                <div class="figure ls lt lu lv lw eg">
               
                  <p><script src="https://gist.github.com/lupyuen/8c24f2f3b38c3b5de1edfc9d6465c449.js"></script></p>


                  <figcaption><p><em>From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_network.rs#L77-L88"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_network.rs#L77-L88</a>
                  </em></p></figcaption>
                </div>
                <p id="21f5" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Finally we call <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/libs/sensor_network/src/sensor_network.c#L307-L316" class="dk hw" rel="noopener nofollow">sensor_network::do_server_post</a>()</code>
                  to transmit our CoAP Message. The actual transmission is done by a background task so that the we
                  won’t get stuck waiting for the transmission to complete. We display the URL for viewing the sensor
                  data. And we return <code class="et jb jc jd je b">Ok(())</code> semicolon-lessly.</p>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik iw ix iy iz ip">
            
                  <p><script src="https://gist.github.com/lupyuen/727403e15f967ca52efd6893ff4e76c5.js"></script></p>


                  <figcaption><p><em>Our Rust program reads the sensor and transmits
                    the sensor data concurrently, managed by Mynewt. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/standalone-node.log#L128-L148"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/standalone-node.log#L128-L148</a>
                  </em></p></figcaption>
                </div>
                <p id="127f" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  We can see that Mynewt plays an important role in managing the realtime tasks on our Blue Pill…</p>
                <p id="e130" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  1️⃣ The temperature sensor is <strong class="hd cp">polled automatically</strong> by Mynewt according
                  to a timer (every 10 seconds)</p>
                <p id="3f11" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  2️⃣ CoAP Messages are transmitted by Mynewt in a <strong class="hd cp">background task</strong></p>
                <p id="7842" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This is possible only because Mynewt is a <strong class="hd cp">realtime operating system</strong>. It
                  would be very difficult for Rust to do this on bare metal.</p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="0c66" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  Install Embedded Rust and Mynewt</h1>
                <p id="14d6" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  Ready to try out the Embedded Rust code for yourself? Follow the instructions below to install the
                  Embedded Rust + Mynewt build and application files on Windows…</p>
                <p id="2acc" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <strong class="hd cp"><em class="hv">“</em></strong><a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/install-embedded-rust-and-apache-mynewt-for-visual-studio-code-on-windows"><strong
                      class="hd cp"><em class="hv">Install Embedded Rust and Apache Mynewt <br />for Visual Studio Code
                        on Windows</em></strong></a><strong class="hd cp"><em class="hv">”</em></strong></p>
                <p id="c3fc" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  🛈 <a
                    href="https://gist.github.com/lupyuen/08e383845d68d3337747e8eb59d0f624"
                    class="dk hw" rel="noopener nofollow"><em class="hv">What is VSCode? Is it related to Visual Studio?
                      How is Microsoft involved? Read this</em></a></p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="b136" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  Hardware Required</h1>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik il im in io ip paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy/y4.png" /></p>

                
                  <figcaption><p><em>STM32 Blue Pill, ST-Link V2, Quectel BC95-G
                    breakout board with antenna, NB-IoT SIM</em></p></figcaption>
                </div>
                <p id="5da9" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  To run the Embedded Rust program and send sensor data over NB-IoT, we’ll need the following hardware…
                </p>
                <p id="ad3b" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  1️⃣ <a
                    href="https://www.aliexpress.com/wholesale?catId=0&amp;initiative_id=SB_20180924131057&amp;SearchText=stm32f103c8t6+development+board"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">STM32 Blue Pill</strong></a></p>
                <p id="27f5" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  2️⃣ <a
                    href="https://www.aliexpress.com/wholesale?catId=0&amp;initiative_id=SB_20180924134644&amp;SearchText=st-link+v2"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">ST-Link V2 USB Adapter</strong></a></p>
                <p id="4881" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  3️⃣ <a
                    href="https://www.aliexpress.com/wholesale?catId=0&amp;initiative_id=SB_20190725022150&amp;SearchText=bc95-g+nb101&amp;switch_new_app=y"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">Quectel BC95-G Global NB-IoT
                      Module</strong></a> (breakout board with antenna). I ordered mine <a
                    href="https://item.taobao.com/item.htm?id=577310122904"
                    class="dk hw" rel="noopener nofollow">here</a>. The manual in Chinese is <a
                    href="http://rs.iotxx.com/uploads/doc/%E8%B0%B7%E9%9B%A8NB10x%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E%E4%B9%A6-V1.3.pdf"
                    class="dk hw" rel="noopener nofollow">here</a>.</p>
                <p id="f24b" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  4️⃣ <strong class="hd cp">NB-IoT SIM</strong> from your local NB-IoT network operator</p>
                <p id="a2f6" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Many thanks to <a href="https://www.starhub.com/"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">StarHub</strong></a> for sponsoring the
                  NB-IoT SIM that I used for this tutorial!</p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="631d" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  Connect The Hardware</h1>
                <p id="d19f" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  To connect Blue Pill to Quectel BC95-G and ST-Link, <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-the-nb-iot-hardware-stm32-blue-pill-and-quectel-bc95-g-module">follow
                    the instructions here</a></p>
              </div>
            </div>
            <div class="eg">
              <div class="n p">
                <div class="km kn ko kp kq kr ah ks ai kt ak t">
                  <div class="figure hy hz ia ib ic eg mf mg paragraph-image">
                
                    <p><img src="https://lupyuen.github.io/images/legacy/y5.jpeg" /></p>

                  
                    <figcaption><p><em>Blue Pill connected to Quectel BC95-G and
                      ST-Link</em></p></figcaption>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="cf92" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  Flash The Firmware To Blue Pill</h1>
                <p id="8bcd" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  The next step is to flash the firmware into Blue Pill’s ROM. We’ll need to connect the Blue Pill to
                  the USB port of our computer via an <a
                    href="https://www.aliexpress.com/wholesale?catId=0&amp;initiative_id=SB_20180924134644&amp;SearchText=st-link+v2&amp;switch_new_app=y"
                    class="dk hw" rel="noopener nofollow">ST-Link V2 adapter</a>.</p>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik il im in io ip paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy/y6.jpeg" /></p>

                 
                  <figcaption><p><em>Blue Pill and ST-Link connected to USB port
                  </em></p></figcaption>
                </div>
                <p id="dee2" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  1️⃣ Check that the Blue Pill is connected to ST-Link…</p>
                <p id="7b56" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  And the ST-Link is connected to your computer’s USB port.</p>
                <p id="e455" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Now let’s head back to Visual Studio Code…</p>
                <div class="figure hy hz ia ib ic eg du dv paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/h0.png" /></p>


                
                </div>
                <p id="b3c2" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  2️⃣ Click <code class="et jb jc jd je b">Terminal → Run Task → [4] Load bluepill_boot</code></p>
                <p id="a933" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This flashes the bootloader to Blue Pill, to start the Apache Mynewt operating system upon startup. If
                  it shows errors, compare with <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/load-bootloader.log"
                    class="dk hw" rel="noopener nofollow">this flash log</a>.</p>
                <p id="4a5f" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  3️⃣ Click <code class="et jb jc jd je b">Terminal → Run Task → [5] Load bluepill_my_sensor</code></p>
                <p id="6784" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This flashes the firmware (containing our Visual Program) to Blue Pill. If it shows errors, compare
                  with <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/load-application.log"
                    class="dk hw" rel="noopener nofollow">this flash log</a>.</p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="bb03" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  Run The Program</h1>
                <p id="aaf6" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  1️⃣ Click <code class="et jb jc jd je b">Debug → Start Debugging</code></p>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik il im in io ip paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy/y7.png" /></p>

               
                </div>
                <p id="05eb" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  2️⃣ Click <code class="et jb jc jd je b">View → Output</code></p>
                <p id="5ec5" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Select <code class="et jb jc jd je b">Adapter Output</code> to see the Blue Pill log</p>
                <div class="figure hy hz ia ib ic eg du dv paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy/a0.png" /></p>

                </div>
                <div class="figure ez eg id ie bi if ig ih ii ij bx ik il im in io ip paragraph-image">                

                  <p><img src="https://lupyuen.github.io/images/legacy/y8.png" /></p>
  
  
              
                </div>
                <p id="91cc" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  3️⃣ The debugger pauses at the line with <code class="et jb jc jd je b">LoopCopyDataInit</code></p>
                <p id="2598" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Click <code class="et jb jc jd je b">Continue</code> or press <code class="et jb jc jd je b">F5</code>
                </p>
                <div class="figure hy hz ia ib ic eg du dv paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy/a0.png" /></p>

                
                </div>
                <div class="figure ez eg id ie bi if ig ih ii ij bx ik il im in io ip paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy/y9.png" /></p>

                 
                </div>
                <p id="cc81" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  4️⃣ The debugger pauses next at the <code class="et jb jc jd je b">main()</code> function.</p>
                <p id="1590" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Click <code class="et jb jc jd je b">Continue</code> or press <code class="et jb jc jd je b">F5</code>
                </p>
                <div class="figure hy hz ia ib ic eg du dv paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy/a0.png" /></p>

               
                </div>
                <p id="3fbf" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The program should now poll the internal temperature sensor every 10 seconds and transmit to
                  thethings.io. Let’s study the Blue Pill execution log…</p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="57b6" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  Check The Log</h1>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik iw ix iy iz ip">
            
                  <p><script src="https://gist.github.com/lupyuen/727403e15f967ca52efd6893ff4e76c5.js"></script></p>


                  <figcaption><p><em>Excerpt from the Blue Pill log: Reading the
                    sensor and transmitting the sensor data over NB-IoT. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/standalone-node.log#L128-L148"
                      class="dk hw"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/standalone-node.log#L128-L148</a>
                  </em></p></figcaption>
                </div>
                <p id="5887" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The log from our Blue Pill should <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/standalone-node.log"
                    class="dk hw" rel="noopener nofollow">look like this</a>.</p>
                <p id="c976" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The contents of the log should be similar to the <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-nb-iot-with-quectel-bc95-g-and-apache-mynewt">previous
                    article</a>. To understand the log messages, refer to the section <em class="hv">“Check The
                    Log”</em> of <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/connect-stm32-blue-pill-to-nb-iot-with-quectel-bc95-g-and-apache-mynewt">this
                    article</a>.</p>
                <p id="b374" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  When we Ctrl-Click the URL in the log…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="901e" class="dh lo jm ff je b de lp lq w lr"><a href="https://blue-pill-geolocate.appspot.com/?device=ac913c504b27e00bc8b68dfe843b297c" class="dk hw" rel="noopener nofollow">https://blue-pill-geolocate.appspot.com?device=ac913c</a>…</span></pre>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik il im in io ip paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy/y10.png" /></p>

                  <figcaption><p><em>Web page with computed temperature</em></p></figcaption>
                </div>
                <p id="f123" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  …We see a web page with the computed temperature value of our temperature sensor in degrees Celsius.
                </p>
                <p id="1d89" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  That’s because <strong class="hd cp">thethings.io has converted the raw temperature into the actual
                    temperature</strong> (in degrees Celsius).</p>
                <p id="bbda" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  We have installed a <a
                    href="https://github.com/lupyuen/thethingsio-wifi-geolocation"
                    class="dk hw" rel="noopener nofollow">script at thethings.io</a> that pushes the computed
                  temperature to <code class="et jb jc jd je b">blue-pill-geolocate.appspot.com</code>, so that we could
                  see the computed temperature.</p>
                <p id="db40" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The URL (and the random number) <strong class="hd cp">changes each time we restart the
                    program</strong>. More details about the setup for thethings.io may be found in an <a class="dk hw"
                    rel="noopener"
                    href="https://lupyuen.github.io/articles/get-started-with-nb-iot-and-quectel-modules">earlier
                    article</a>.</p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="e655" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  What’s Next?</h1>
                <p id="ca66" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/visual-embedded-rust-programming-with-visual-studio-code">Visual
                    Rust</a>, of course! We’ll soon be able to generate the Embedded Rust program in this article by
                  simply dragging and dropping blocks around. Check out the article here…</p>
                <div class="ms mt mu mv mw mx"><a target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/visual-embedded-rust-programming-with-visual-studio-code">
                    <div class="my n dq">
                      <div class="mz n x p na nb">
                        <h2 class="ap cp de ar ep nc nd ne nf ng nh da dh">Visual Embedded Rust Programming with Visual
                          Studio Code</h2>
                      </div>
                      <div class="nl w">
                        <div class="nm w nn no np nl nq nr mx"></div>
                      </div>
                    </div>
                  </a></div>
                <p id="6500" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  I have extended the <a
                    href="https://github.com/lupyuen/blockly-mynewt-rust"
                    class="dk hw" rel="noopener nofollow">Rust Code Generator</a> for Google Blockly to generate Rust
                  code that’s fairly close to the code that we see in this article.</p>
                <p id="d055" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Embedded Rust can clearly harness our powerful gadgets… It handles complex embedded programs well. And
                  it prevents bugs from crashing our gadgets.</p>
                <p id="1e43" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <em class="hv">But will we know how to harness the power of Rust?</em></p>
                <p id="ed2a" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <em class="hv">With great power comes great… </em><strong class="hd cp"><em
                      class="hv">Teaching</em></strong><em class="hv">! (</em>That’s where I fit in…)</p>
                <p id="924d" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Could Rust harness its own power, like with auto-generated Safe Wrappers?</p>
                <p id="488b" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Or could we do it Visually… so we can see in a single glance how Rust is controlling our gadgets?</p>
                <p id="82b6" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  I’m about to find out… Stay tuned!</p>
                <p id="22e5" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <strong class="hd cp">UPDATE</strong>: I have a new article that explains how to reduce the power
                  consumption of our device…</p>
                <div class="ms mt mu mv mw mx"><a target="_blank" rel="noopener"
                    href="https://lupyuen.github.io/articles/low-power-nb-iot-on-stm32-blue-pill-with-apache-mynewt-and-embedded-rust">
                    <div class="my n dq">
                      <div class="mz n x p na nb">
                        <h2 class="ap cp de ar ep nc nd ne nf ng nh da dh">Low Power NB-IoT on STM32 Blue Pill with
                          Apache Mynewt and Embedded Rust</h2>
                      </div>
                      <div class="nl w">
                        <div class="ns w nn no np nl nq nr mx"></div>
                      </div>
                    </div>
                  </a></div>
              </div>
            </div>
            <div class="eg t">
              <div class="figure hy hz ia ib ic eg">
         
                <p><a href="https://youtu.be/jYo8B8c7T3Y">[Watch the video on YouTube]</a></p>


              </div>
              <div class="figure eh eg t paragraph-image">
                
                <p><img src="https://lupyuen.github.io/images/legacy/y11.png" /></p>

           
                <figcaption><p><em>Under Development: Visual Studio Code Extension
                  for Visual Embedded Rust</em></p></figcaption>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="1642" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  💎 Advanced Topic: CoAP Macro</h1>
                <p id="58f3" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  The CoAP Macro is defined in <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/mynewt/src/encoding/macros.rs" class="dk hw" rel="noopener nofollow">rust/mynewt/src/encoding/macros.rs</a></code>
                </p>
                <p id="59c3" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  It’s a <a
                    href="https://danielkeep.github.io/tlborm/book/mbe-README.html"
                    class="dk hw" rel="noopener nofollow"><strong class="hd cp">Rust Declarative Macro</strong></a> that
                  parses the JSON-like input (sensor data fields) and generates Rust code to encode the sensor data in
                  JSON or CBOR format. Given <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/app_network.rs#L63-L75"
                    class="dk hw" rel="noopener nofollow">this input</a>…</p>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik iw ix iy iz ip">
           
                  <p><script src="https://gist.github.com/lupyuen/5392a92bc4c5346c3dc9756201979710.js"></script></p>


                </div>
                <p id="7f84" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  … And depending on the selector “<code class="et jb jc jd je b">@json</code>” or “<code
                    class="et jb jc jd je b">@cbor</code>”, the CoAP Macro expands into the following code…</p>
                <ul class="">
                  <li id="0d4f"
                    class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu nu nv nw dh"><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/libapp-expanded-json.rs#L276-L385"
                      class="dk hw" rel="noopener nofollow">JSON Encoding</a></li>
                  <li id="dbf1"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu nu nv nw dh"><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/libapp-expanded-cbor.rs#L293-L497"
                      class="dk hw" rel="noopener nofollow">CBOR Encoding</a></li>
                </ul>
                <p id="904a" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The CoAP Macro was adapted from the JSON parser in the <code
                    class="et jb jc jd je b"><a href="https://docs.serde.rs/serde_json/" class="dk hw" rel="noopener nofollow">serde_json</a></code>
                  crate.</p>
                <p id="5c8c" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The generated code uses a CoAP Context object to maintain the current JSON and CBOR encoding state:
                  <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/mynewt/src/encoding/coap_context.rs" class="dk hw" rel="noopener nofollow">rust/mynewt/src/encoding/coap_context.rs</a></code>
                </p>
                <p id="49d0" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The JSON encoding code calls the <a
                    href="https://mynewt.apache.org/latest/os/modules/json/json.html"
                    class="dk hw" rel="noopener nofollow">Mynewt JSON API</a> while the CBOR encoding code calls the <a
                    href="https://mynewt.apache.org/latest/os/modules/sensor_framework/sensor_oic.html"
                    class="dk hw" rel="noopener nofollow">Mynewt OIC API</a>.</p>
                <p id="2078" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Read more about <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/safer-simpler-embedded-rust-with-apache-mynewt-on-stm32-blue-pill">Rust
                    Declarative Macros</a></p>
                <p id="d339" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Read more about <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/get-started-with-nb-iot-and-quectel-modules">CoAP
                    Encoding</a></p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="d1a4" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  💎 Advanced Topic: Hosting Rust on Mynewt</h1>
                <p id="f7ab" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  We use a custom <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd"
                    class="dk hw" rel="noopener nofollow">Build Script</a> to build the Rust application and link it
                  into the Mynewt firmware. (View the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/build-application.log"
                    class="dk hw" rel="noopener nofollow">Build Log</a>) The script does the following…</p>
                <ol class="">
                  <li id="d8a9"
                    class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu oc nv nw dh"><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd#L51-L55"
                      class="dk hw" rel="noopener nofollow">Run </a><code
                      class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd#L51-L55" class="dk hw" rel="noopener nofollow">cargo build</a></code>
                    to build the Rust application into a library named <code class="et jb jc jd je b">libapp.rlib</code>
                  </li>
                  <li id="a7ac"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu oc nv nw dh"><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd#L73-L76"
                      class="dk hw" rel="noopener nofollow">Extract the </a><code
                      class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd#L73-L76" class="dk hw" rel="noopener nofollow">*.o</a></code><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd#L73-L76"
                      class="dk hw" rel="noopener nofollow"> object files</a> from <code
                      class="et jb jc jd je b">libapp.rlib</code> (including the <code
                      class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/lib.rs#L46-L74" class="dk hw" rel="noopener nofollow">main</a>()</code>
                    function from Rust) and external crates. <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd#L77-L81"
                      class="dk hw" rel="noopener nofollow">Combine the object files</a> into a new library <code
                      class="et jb jc jd je b">rustlib.a</code></li>
                  <li id="0fad"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu oc nv nw dh"><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd#L82-L93"
                      class="dk hw" rel="noopener nofollow">Copy </a><code
                      class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd#L82-L93" class="dk hw" rel="noopener nofollow">rustlib.a</a></code>
                    into the Mynewt build folder for custom library <code
                      class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/rust-nbiot/libs/rust_app" class="dk hw" rel="noopener nofollow">libs/rust_app</a></code>
                  </li>
                  <li id="c842"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu oc nv nw dh"><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd#L101-L122"
                      class="dk hw" rel="noopener nofollow">Copy the Rust Core Library</a> <code
                      class="et jb jc jd je b">libcore-*.rlib</code> from the Rust Compiler into the Mynewt build folder
                    for custom library <code class="et jb jc jd je b">libs/rust_libcore</code></li>
                  <li id="be59"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu oc nv nw dh"><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd#L128-L133"
                      class="dk hw" rel="noopener nofollow">Run </a><code
                      class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/build-app.cmd#L128-L133" class="dk hw" rel="noopener nofollow">newt build</a></code>
                    to build the Mynewt firmware, which includes <code class="et jb jc jd je b">rust_app</code> and
                    <code
                      class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/rust-nbiot/libs/rust_libcore" class="dk hw" rel="noopener nofollow">rust_libcore</a></code>
                  </li>
                  <li id="f268"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu oc nv nw dh">The
                    Mynewt firmware calls the <code
                      class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/app/src/lib.rs#L46-L74" class="dk hw" rel="noopener nofollow">main</a>()</code>
                    function defined in Rust, so the Rust application runs on startup</li>
                </ol>
                <p id="8e50" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The following files may be useful for reference…</p>
                <ul class="">
                  <li id="45f5"
                    class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu nu nv nw dh"><a
                      href="https://lupyuen.github.io/stm32bluepill-mynewt-sensor/rust/app/"
                      class="dk hw" rel="noopener nofollow">Rust Doc for the applicatio</a>n</li>
                  <li id="c623"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu nu nv nw dh"><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/libapp-demangle.S"
                      class="dk hw" rel="noopener nofollow">Disassembly of the Rust Application build</a></li>
                  <li id="2edd"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu nu nv nw dh"><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/rustlib-demangle.S"
                      class="dk hw" rel="noopener nofollow">Disassembly of the Rust Crates</a></li>
                  <li id="a740"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu nu nv nw dh"><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/my_sensor_app.elf.lst"
                      class="dk hw" rel="noopener nofollow">Disassembly of the entire firmware</a></li>
                  <li id="9b8b"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu nu nv nw dh"><a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/my_sensor_app.elf.map"
                      class="dk hw" rel="noopener nofollow">Memory map of the firmware</a></li>
                </ul>
                <p id="e555" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Read more about <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/hosting-embedded-rust-apps-on-apache-mynewt-with-stm32-blue-pill">hosting
                    Rust applications on Mynewt</a></p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="4e2b" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  💎 Advanced Topic: Safe Wrappers for Mynewt</h1>
                <p id="861c" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  Although Rust can call C functions directly, it’s unpleasant to call the Mynewt API with unsafe code.
                  And we need to be very careful when converting pointers between Mynewt and C. Also all strings need to
                  be null-terminated when passing from Mynewt to Rust. That’s why we create Safe Wrappers for the Mynewt
                  API.</p>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik iw ix iy iz ip">
           
                  <p><script src="https://gist.github.com/lupyuen/97682a2451f105944579e58e69e97d3f.js"></script></p>


                </div>
                <p id="9e91" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Here’s a typical Mynewt API <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/mynewt/src/kernel/os.rs#L1936-L1966" class="dk hw" rel="noopener nofollow">os_task_init()</a></code>
                  that has been imported into Rust with our <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/gen-bindings.sh" class="dk hw" rel="noopener nofollow">gen-bindings.sh</a></code>
                  script, thanks to <code
                    class="et jb jc jd je b"><a href="https://rust-lang.github.io/rust-bindgen/" class="dk hw" rel="noopener nofollow">bindgen</a></code>...
                </p>
                <div class="figure hy hz ia ib ic eg du dv paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/h0.png" /></p>


               
                </div>
                <div class="figure ez eg id ie bi if ig ih ii ij bx ik iw ix iy iz ip">
             
                  <p><script src="https://gist.github.com/lupyuen/f6d1562b6b5230fc8f1f49ccb2002c30.js"></script></p>


                </div>
                <p id="b7ea" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  …And here’s the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/libmynewt-expanded.rs#L2379-L2437"
                    class="dk hw" rel="noopener nofollow">Safe Wrapper for that API</a>. Note the following…</p>
                <ol class="">
                  <li id="8322"
                    class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu oc nv nw dh">
                    Unsafe types like <code class="et jb jc jd je b">* const c_char</code> have been replaced by the
                    safer version <code class="et jb jc jd je b">Strn</code></li>
                  <li id="c63b"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu oc nv nw dh">We
                    validate all <code class="et jb jc jd je b">Strn</code> strings to confirm that they are
                    null-terminated before passing to Mynewt: <code class="et jb jc jd je b">arg2.validate()</code></li>
                  <li id="84f7"
                    class="hb hc ff hd b he nx hf hg hh ny hi hj hk nz hl hm hn oa ho hp hq ob hr hs hu oc nv nw dh">We
                    convert the Mynewt result code into the standard <code
                      class="et jb jc jd je b">MynewtResult&lt;()&gt; </code>type</li>
                </ol>
                <p id="8a36" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  How did we create the Safe Wrappers? They were automatically generated with a Rust Procedural Macro
                  named <code class="et jb jc jd je b">safe_wrap</code>. That’s why we see this annotation…</p>
                <pre
                  class="hy hz ia ib ic ll lm ln"><span id="5c1b" class="dh lo jm ff je b de lp lq w lr">#[mynewt_macros::safe_wrap(attr)]</span></pre>
                <p id="1047" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Here is the <a
                    href="https://lupyuen.github.io/stm32bluepill-mynewt-sensor/rust/mynewt/"
                    class="dk hw" rel="noopener nofollow">Rust Doc for the Mynewt API</a></p>
                <p id="ee4f" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Read more about <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/safer-simpler-embedded-rust-with-apache-mynewt-on-stm32-blue-pill">Safe
                    Wrappers</a></p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="82ea" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  💎 Advanced Topic: Auto-Generating Safe Wrappers</h1>
                <p id="69db" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  The Safe Wrappers were generated by our Rust Procedural Macro named <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/macros/src/safe_wrap.rs" class="dk hw" rel="noopener nofollow">safe_wrap</a>()</code>.
                  If you look at the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/macros/src/safe_wrap.rs"
                    class="dk hw" rel="noopener nofollow">source code</a>, you’ll see that it’s actually another Rust
                  program, except that it’s invoked during the Rust build, not during runtime.</p>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik iw ix iy iz ip">
            
                  <p><script src="https://gist.github.com/lupyuen/97682a2451f105944579e58e69e97d3f.js"></script></p>


                </div>
                <p id="0e3e" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  <code class="et jb jc jd je b">safe_wrap()</code> takes an extern declaration like this…</p>
                <div class="figure hy hz ia ib ic eg du dv paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/h0.png" /></p>


                 
                </div>
                <div class="figure ez eg id ie bi if ig ih ii ij bx ik iw ix iy iz ip">
           
                  <p><script src="https://gist.github.com/lupyuen/f6d1562b6b5230fc8f1f49ccb2002c30.js"></script></p>


                </div>
                <p id="c5aa" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  …And generates this Safe Wrapper.</p>
                <p id="7229" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  It calls the <a
                    href="https://docs.rs/syn/0.15.38/syn/index.html"
                    class="dk hw" rel="noopener nofollow">syn crate</a> to parse the <code
                    class="et jb jc jd je b">extern</code> declaration, and calls the <a
                    href="https://docs.rs/quote/0.6.12/quote/" class="dk hw"
                    rel="noopener nofollow">quote crate</a> to generate the Safe Wrapper code.</p>
                <p id="7e13" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Yes, <code class="et jb jc jd je b">safe_wrap()</code> is a Rust program that reads a Rust program and
                  generates another Rust program!</p>
                <p id="e1fc" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  We don’t generate wrappers yet for the entire Mynewt API. The whitelist of Mynewt APIs for generating
                  wrappers is <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/macros/src/safe_wrap.rs#L43-L64"
                    class="dk hw" rel="noopener nofollow">specified here</a>.</p>
                <p id="b9d3" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  We also use <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/macros/src/safe_wrap.rs#L43-L64"
                    class="dk hw" rel="noopener nofollow">fixed rules</a> to determine the namespace for each Mynewt
                  function. Given a Mynewt function like <code class="et jb jc jd je b">os_task_init()</code>, we use
                  the rules to deduce that <code class="et jb jc jd je b">os</code> is the namespace and <code
                    class="et jb jc jd je b">task_init()</code> should be name of the Rust Safe Wrapper.</p>
                <p id="8098" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  To test the macros, I created a <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/test-rust-macros" class="dk hw" rel="noopener nofollow">test-rust-macros</a></code>
                  project.</p>
                <p id="ea03" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Read more about <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/safer-simpler-embedded-rust-with-apache-mynewt-on-stm32-blue-pill">Rust
                    Procedural Macros</a></p>
              </div>
            </div>
          </section>
          <div class="n p gb jf jg ik" role="separator"><span class="jh gm bk ji jj jk"></span><span
              class="jh gm bk ji jj jk"></span><span class="jh gm bk ji jj"></span></div>
          <section class="dc ed ee cx ef">
            <div class="n p">
              <div class="ae af ag ah ai fd ak t">
                <h1 id="e0b9" class="jl jm ff ap jn jo jp hf jq jr js hi jt ju jv jw jx jy jz ka kb kc kd ke kf kg dh">
                  💎 Advanced Topic: Generating Rust Bindings for Mynewt</h1>
                <p id="2451" class="hb hc ff hd b he kh hf hg hh ki hi hj hk kj hl hm hn kk ho hp hq kl hr hs hu dc dh">
                  The Mynewt API was imported into Rust using the <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/gen-bindings.sh" class="dk hw" rel="noopener nofollow">gen-bindings.sh</a></code>
                  script. <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/gen-bindings.log"
                    class="dk hw" rel="noopener nofollow">Here is the log</a>.</p>
                <div class="figure hy hz ia ib ic eg id ie bi if ig ih ii ij bx ik iw ix iy iz ip">
             
                  <p><script src="https://gist.github.com/lupyuen/2dbcecf3062522ef3c5e182b36a31713.js"></script></p>


                </div>
                <p id="019d" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  This script takes the preprocessed C header files from Mynewt and generates <code
                    class="et jb jc jd je b">extern</code> function declarations in Rust. The script calls <code
                    class="et jb jc jd je b"><a href="https://rust-lang.github.io/rust-bindgen/" class="dk hw" rel="noopener nofollow">bindgen</a></code>
                  to <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/gen-bindings.sh#L54-L65"
                    class="dk hw" rel="noopener nofollow">create the declarations</a>.</p>
                <p id="1eff" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Given this C declaration…</p>
                <div class="figure hy hz ia ib ic eg du dv paragraph-image">
                
                  <p><img src="https://lupyuen.github.io/images/legacy2/h0.png" /></p>


                  
                </div>
                <div class="figure ez eg id ie bi if ig ih ii ij bx ik iw ix iy iz ip">
               
                  <p><script src="https://gist.github.com/lupyuen/97682a2451f105944579e58e69e97d3f.js"></script></p>


                </div>
                <p id="88eb" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  …The script generates this Rust <code class="et jb jc jd je b">extern</code> function declaration.</p>
                <p id="3041" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Only a <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/gen-bindings.sh#L319-L327"
                    class="dk hw" rel="noopener nofollow">subset of the Mynewt API</a> is processed. Although <code
                    class="et jb jc jd je b">bindgen</code> can process <code class="et jb jc jd je b">*.h</code> header
                  files in selected <code class="et jb jc jd je b">include</code> directories, it doesn’t work for
                  Mynewt because of its complicated <code class="et jb jc jd je b">include</code> structure.</p>
                <p id="165c" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  I have chosen to let <code
                    class="et jb jc jd je b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/gen-bindings.sh#L30-L53" class="dk hw" rel="noopener nofollow">gcc</a></code><a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/gen-bindings.sh#L30-L53"
                    class="dk hw" rel="noopener nofollow"> create preprocessed versions</a> of each header file. The
                  <code class="et jb jc jd je b">gcc</code> options <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/gen-bindings.txt"
                    class="dk hw" rel="noopener nofollow">look like this</a>. The preprocessed header file <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/logs/libs/sensor_coap-expanded.h"
                    class="dk hw" rel="noopener nofollow">looks like this</a>. The generated Rust declarations <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/rust/mynewt/src/libs/sensor_coap.rs"
                    class="dk hw" rel="noopener nofollow">is here</a>.</p>
                <p id="aa6a" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  The script passes <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/gen-bindings.sh#L247-L248"
                    class="dk hw" rel="noopener nofollow">blacklists</a> and <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/rust-nbiot/scripts/gen-bindings.sh#L249-L255"
                    class="dk hw" rel="noopener nofollow">whitelists</a> to <code
                    class="et jb jc jd je b">bindgen</code> to ensure that there are no duplicate declarations.</p>
                <p id="cbd1" class="hb hc ff hd b he ir hf hg hh is hi hj hk it hl hm hn iu ho hp hq iv hr hs hu dc dh">
                  Read more about <a class="dk hw" rel="noopener"
                    href="https://lupyuen.github.io/articles/safer-simpler-embedded-rust-with-apache-mynewt-on-stm32-blue-pill">generating
                    Rust bindings</a></p>
              </div>
            </div>
          </section>
        </div>
      </article>
    </div>
  </div>

  <ul>
    <li>
    <p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io">Check out my articles</a></p>
    </li>
    <li>
    <p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
    </li>
  </ul>
    
</body>

</html>
<!--
     FILE ARCHIVED ON 03:23:03 Oct 25, 2020 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 01:36:55 Feb 23, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  exclusion.robots: 0.382
  captures_list: 72.888
  esindex: 0.013
  CDXLines.iter: 22.873 (3)
  PetaboxLoader3.resolve: 1119.699
  LoadShardBlock: 45.488 (3)
  load_resource: 1162.518
  exclusion.robots.policy: 0.366
  PetaboxLoader3.datanode: 46.311 (4)
  RedisCDXSource: 0.681
-->