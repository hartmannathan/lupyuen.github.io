# Daily Automated Testing for Milk-V Duo S RISC-V SBC (IKEA TRETAKT / Apache NuttX RTOS)

üìù _29 Jun 2024_

![TODO](https://lupyuen.github.io/images/sg2000a-title.jpg)

Last week we upstreamed Milk-V Duo S SBC to Apache NuttX RTOS.

(Based on Sophgo SG2000 RISC-V SoC)

But NuttX Mainline [__changes every day__](https://github.com/apache/nuttx/commits/master/).

Can we be sure that Milk-V Duo S won't suffer __"Software Bit Rot"__? And fail to boot NuttX someday?

Let's do __Daily Automated Testing__ for NuttX on a Milk-V Duo S. Yep on the Actual Physical SBC!

TODO: Pic of SBC

# TODO

The Toughest Thing about our Daily Exercise: __Automatically Powering Up__ our SBC.

# Automated Testing of Apache NuttX RTOS on Sophgo SG2000 SoC / Milk-V Duo S SBC

TODO

We are now running Daily Automated Testing of [Apache NuttX RTOS](https://github.com/lupyuen/nuttx-sg2000) on a Real Milk-V Duo S SBC (Sophgo SG2000 SoC)...

1.  Download the [Automated Daily Build](https://github.com/lupyuen/nuttx-sg2000#nuttx-automated-daily-build-for-sg2000) to TFTP Server

1.  Power on our SBC with an [IKEA Smart Power Plug via Home Assistant](https://github.com/lupyuen2/autotest-nuttx-sg2000#control-our-sbc-with-an-ikea-smart-power-plug-and-home-assistant)

1.  Our SBC boots the Daily Build over TFTP

1.  Capture the Automated Testing Log and write to the Release Notes

Like this...

```bash
## Run the Daily Automated Testing
script /tmp/release.log scripts/test.sh

## Upload the Test Log to GitHub Release Notes
scripts/upload.sh

## OR: Do this to run the Automated Test automatically whenever there's a Daily Build
scripts/task.sh
```

[(See the Automated Test Logs)](https://github.com/lupyuen/nuttx-sg2000/releases)

Here are the Automated Testing Scripts...

- Automated Task: [task.sh](scripts/task.sh)
- Test NuttX on SBC: [test.sh](scripts/test.sh)
- Upload Test Log: [upload.sh](scripts/upload.sh)
- Expect Script: [nuttx.exp](scripts/nuttx.exp)

# Control our SBC with an IKEA Smart Power Plug and Home Assistant

TODO

_How did we power on and off our SG2000 SBC? Automagically?_

We used an [IKEA TRETAKT Smart Power Plug](https://www.ikea.com/gb/en/p/tretakt-plug-with-remote-control-smart-30569726/) with an [IKEA DIRIGERA Zigbee Hub](https://www.ikea.com/gb/en/p/dirigera-hub-for-smart-products-white-smart-50503409/).

We added the Smart Power Plug to the IKEA Home Smart App like this...

![IKEA Smart Power Plug in IKEA Home Smart App](https://lupyuen.github.io/images/sg2000a-ikea.jpg)

_But IKEA doesn't provide a Public API for their gadgets!_

Yeah sigh. That's why we...

1.  Add IKEA Smart Power Plug to [Google Assistant](https://www.ikea.com/nl/en/customer-service/knowledge/articles/c916g4b0-c602-4g65-9c4e-b40f801g43dc.html)

1.  And control the IKEA Smart Power Plug via the [Google Assistant SDK](https://gist.github.com/lupyuen/01cff0d4ca225984ca8fd0d999d7c76d)

1.  By running Home Assistant with [Google Assistant SDK](https://gist.github.com/lupyuen/01cff0d4ca225984ca8fd0d999d7c76d)

1.  For macOS: We run [Home Assistant in a Docker Container (Rancher Desktop)](https://gist.github.com/lupyuen/03a7cc8702085c70893e157d8c3ca3f8)

_How will Home Assistant control Google Assistant to control our Smart Power Plug?_

Assume we have added the Smart Power Plug to Google Assistant, and named the Smart Power Plug as "SG2000 Power". We create an Automation in Home Assistant...

![Create an Automation in Home Assistant](https://lupyuen.github.io/images/sg2000a-ha1.jpg)

Inside our Automation: Add an Action...

![Create an Automation in Home Assistant](https://lupyuen.github.io/images/sg2000a-ha2.jpg)

Select the Google Assistant SDK. Enter the command: "SG2000 Power On"...

![Create an Automation in Home Assistant](https://lupyuen.github.io/images/sg2000a-ha3.jpg)

Save it as an Automation named "SG2000 Power On"...

![Create an Automation in Home Assistant](https://lupyuen.github.io/images/sg2000a-ha4.png)

_But how do we Power On our SBC from our Automated Test Script?_

We call the [Home Assistant REST API](https://developers.home-assistant.io/docs/api/rest/) with a Home Assistant Long-Lived Token: [test.sh](https://github.com/lupyuen2/autotest-nuttx-sg2000/blob/main/scripts/test.sh#L54-L80)

```bash
## Get the Home Assistant Token, copied from http://localhost:8123/profile/security
## token=xxxx
. $HOME/home-assistant-token.sh

echo "----- Power Off the SBC"
curl \
  -X POST \
  -H "Authorization: Bearer $token" \
  -H "Content-Type: application/json" \
  -d '{"entity_id": "automation.sg2000_power_off"}' \
  http://localhost:8123/api/services/automation/trigger

echo "----- Power On the SBC"
curl \
  -X POST \
  -H "Authorization: Bearer $token" \
  -H "Content-Type: application/json" \
  -d '{"entity_id": "automation.sg2000_power_on"}' \
  http://localhost:8123/api/services/automation/trigger
```

_Doesn't the USB UART Adapter supply a tiny bit of power to our SBC?_

Yeah enough power to light up the SBC, but not enough to power up the SBC totally.

Thus our SBC will glow at night, even though the power is off. (I drape a hand towel so it won't bother my sleep)

![Power On our SBC from our Automated Test Script](https://lupyuen.github.io/images/sg2000a-title.jpg)

# What's Next

TODO

Many Thanks to my [__GitHub Sponsors__](https://github.com/sponsors/lupyuen) (and the awesome NuttX Community) for supporting my work! This article wouldn't have been possible without your support.

-   [__Sponsor me a coffee__](https://github.com/sponsors/lupyuen)

-   [__My Current Project: "Apache NuttX RTOS for Ox64 BL808"__](https://github.com/lupyuen/nuttx-ox64)

-   [__My Other Project: "NuttX for Star64 JH7110"__](https://github.com/lupyuen/nuttx-star64)

-   [__Older Project: "NuttX for PinePhone"__](https://github.com/lupyuen/pinephone-nuttx)

-   [__Check out my articles__](https://lupyuen.github.io)

-   [__RSS Feed__](https://lupyuen.github.io/rss.xml)

_Got a question, comment or suggestion? Create an Issue or submit a Pull Request here..._

[__lupyuen.github.io/src/sg2000a.md__](https://github.com/lupyuen/lupyuen.github.io/blob/master/src/sg2000a.md)
